<!-- Saved from local source at 2023-09-20T13:56:17Z using monolith v2.7.0 -->
<!DOCTYPE html><html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="data:text/css;base64,Ym9keSB7CiAgYmFja2dyb3VuZDogcmdiKDIwMSwgMjExLCAxOTgpOwogIGZvbnQtc2l6ZTogMzBweDsKCWxldHRlci1zcGFjaW5nOiAycHg7Cn0KLmNlbnRlciB7CiAgdGV4dC1hbGlnbjogY2VudGVyOwp9CgouYmlnX25hbWUgewogIGZvbnQtc2l6ZTogMTgwcHg7Cn0KCnNwYW4sCmxhYmVsLCBwLmlucHV0IHsKCXdpZHRoOiBmaXQtY29udGVudDsKICBib3JkZXItcmFkaXVzOiA0cHg7CiAgbWFyZ2luOiAwcHggMzBweCAzMHB4Owp9Cgp0YWJsZSB7CiAgbWFyZ2luOiAzMHB4IDMwcHg7Cn0KCnRyIHsKICBwYWRkaW5nOiAwcHggMHB4IDE1cHg7CiAgLyrkuIrjgIDlt6blj7PjgIDkuIsqLwogIGJvcmRlci1yYWRpdXM6IDNweDsKfQoKdGQua2V5cyB7CiAgcGFkZGluZzogNXB4IDEwcHggNXB4OwogIC8q5LiK44CA5bem5Y+z44CA5LiLKi8KICBib3JkZXItcmFkaXVzOiAzcHg7CiAgdGV4dC1hbGlnbjogcmlnaHQ7Cn0KCi50ZXh0X2p1c3RpZnkgewogIHRleHQtYWxpZ24tbGFzdDoganVzdGlmeTsKfQoKdGQuY2VsbCB7CiAgbWFyZ2luLWxlZnQ6IDVweDsKICBtYXJnaW4tcmlnaHQ6IDVweDsKICBwYWRkaW5nOiA1cHggMTBweCA1cHg7CiAgYm9yZGVyLXJhZGl1czogM3B4OwogIGxldHRlci1zcGFjaW5nOiAycHg7CiAgZm9udC13ZWlnaHQ6IGJvbGRlcjsKfQoKdWwubGluZV91cCB7CiAgbGlzdC1zdHlsZS10eXBlOiBub25lOyAvKuODquOCueODiOOBruWFiOmgreODnuODvOOCr+OCkumdnuihqOekuuOBq+OBmeOCiyovCiAgZGlzcGxheTogZmxleDsKICBmbGV4LXdyYXA6IG5vd3JhcDsKfQoKbGkgewogIHBhZGRpbmc6IDEwcHg7Cn0KCi5ib3JkZXJfbGluZSB7CiAgYm9yZGVyOiAxcHggc29saWQgcmdiKDEzMywgMTcyLCAxMjQpOwp9CgppbnB1dFt0eXBlPSJ0ZXh0Il0gewogIGZvbnQtc2l6ZTogMTEwJTsKICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogIGNvbG9yOiAjMmUzMTJlOwogIG1hcmdpbi1ib3R0b206IDdweDsKICBib3JkZXI6IG5vbmU7CiAgYmFja2dyb3VuZDogcmdiKDIxOCwgMjMwLCAyMTUpOwogIGJvcmRlci1yYWRpdXM6IDNweDsKICAvKmJvcmRlci1ib3R0b206IDJweCBzb2xpZCByZ2IoMTU4LCAxOTIsIDE1MSk7Ki8KICAvKmJhY2tncm91bmQ6IHRyYW5zcGFyZW50OyovCiAgLyp0cmFuc2l0aW9uOiAwLjVzOyovCn0KCmlucHV0W3R5cGU9InRleHQiXS5oYW56ZW4gewoJbWFyZ2luOiAwcHggMzBweCAzMHB4OwoJbGV0dGVyLXNwYWNpbmc6IDFweDsKICBmb250LXNpemU6IDExNSU7CiAgYm94LXNpemluZzpjb250ZW50LWJveDsKICBjb2xvcjogIzJlMzEyZTsKICBib3JkZXI6IG5vbmU7CglwYWRkaW5nOjNweCAxNXB4IDNweDsKICBiYWNrZ3JvdW5kOiByZ2IoMjE4LCAyMzAsIDIxNSk7CiAgYm9yZGVyLXJhZGl1czogNHB4OwoJb3V0bGluZTogMDsKCWNhcmV0LWNvbG9yOiByZ2IoMCwgMCwgMCk7CiAgLypib3JkZXItYm90dG9tOiAycHggc29saWQgcmdiKDE1OCwgMTkyLCAxNTEpOyovCiAgLypiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsqLwogIC8qdHJhbnNpdGlvbjogMC41czsqLwp9CgppbnB1dDpob3ZlciwKaW5wdXB0Omhhbnplbi5ob3ZlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogcmdiKDE3MCwgMjAyLCAxNjIpOwp9CgoubWVudV9saW5lOmhvdmVyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDI1NSwgMTI5LCA3OSwgMC4zOSk7Cn0KCi5zdGF0aWNfdGFibGVfbGluZTpob3ZlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogcmdiKDE3NywgMTg5LCAxNzMpOwp9CgouY29weV90YXJnZXQ6aG92ZXIgewogIGN1cnNvcjogY29weTsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2IoMTc1LCAyMTQsIDE2Myk7Cn0KCi5jb3B5X3RhcmdldDphY3RpdmUgewogIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMjU1LCAyNTMsIDEzMCwgMC44NzcpOwogIC8qKgoJYmFja2dyb3VuZC1jb2xvcjogcmdiYSgyNTUsIDE2NSwgMTMwLCAwLjU3NSk7CgkqLwp9CgouZWYgaW5wdXRbdHlwZT0idGV4dCJdOmZvY3VzIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDE5OSwgOTMsIDY3LCAwLjQ0NSk7CiAgb3V0bGluZTogbm9uZTsKICAvKmNvbG9yOnJnYigyNTUsIDI1NSwgMjU1KTsqLwogIC8qYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHJnYigxOTksIDkzLCA2Nyk7Ki8KfQoKLyoKaW5wdXQud2l0aF9tZW51W3R5cGU9J3RleHQnXXsKCXdpZHRoOiA3MCU7Cn0KKi8KCmlucHV0LmhlYWRfbGVzc1t0eXBlPSJ0ZXh0Il0gewogIHdpZHRoOiA2MC4wMDAwMDQlOwp9Cgp0ZXh0YXJlYS5jcHkgewogIHdpZHRoOiAyMDBweDsKICBoZWlnaHQ6IDEwMHB4OwoKICBjb2xvcjogIzJlMzEyZTsKICBiYWNrZ3JvdW5kOiByZ2IoMjE4LCAyMzAsIDIxNSk7CiAgYm9yZGVyLXJhZGl1czogM3B4OwogIGJvcmRlcjogMXB4IHNvbGlkIHJnYigxNTQsIDE3MywgMTQ5KTsKfQoKdGV4dGFyZWE6Zm9jdXMgewogIGJvcmRlci1jb2xvcjogcmdiKDk0LCAxMjgsIDg2KTsKICBvdXRsaW5lOiBub25lOwp9CgoucmlnaHQgewogIHRleHQtYWxpZ246IHJpZ2h0Owp9CgouZmFkZV9pbiB7CiAgYW5pbWF0aW9uOiBmYWRlSW5SaWdodCAxLjJzIGVhc2UgMHMgMSBub3JtYWw7Cn0KCi8qIGZhZGVJblJpZ2h0ICovCkBrZXlmcmFtZXMgZmFkZUluUmlnaHQgewogIDAlIHsKICAgIG9wYWNpdHk6IDA7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMzBweCk7CiAgfQogIDEwMCUgewogICAgb3BhY2l0eTogMTsKICB9Cn0KCi5kb25lX3dpcnRlX21lc3NhZ2UgewogIGNvbG9yOiByZ2IoNzksIDEyMSwgNjkpOwp9CmJ1dHRvbi5zaXplIHsKICBmb250LXNpemU6IDE4cHg7Cn0KYnV0dG9uLnJlbW92ZV9jb2x1bW4gewogIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDI1NSwgMjI4LCAyMTcsIDAuNzgxKTsKICB3aWR0aDogMjNweDsKICBoZWlnaHQ6IDIzcHg7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIGJvcmRlci1yYWRpdXM6IDUwJTsKICBib3JkZXI6IG5vbmU7CiAgZm9udC1zaXplOiBzbWFsbDsKICBmb250LXdlaWdodDogYm9sZDsKfQoKLmVycm9yX21lc3NhZ2UgewogIGZvbnQtc2l6ZTogMThweDsKICBjb2xvcjogcmdiKDIzNCwgMCwgMjU1KTsKfQoKLmJvdHRvbV9oZWlnaHQgewogIGhlaWdodDogMTUwcHg7Cn0KCgovKi0tLS0tLS0tLS0tLS0tLSovCi5mYWRlX2luX2JvdHRvbSB7CglvcGFjaXR5OiAwOwoJYW5pbWF0aW9uLW5hbWU6IGZhZGVpbi1ib3R0b207CglhbmltYXRpb24tZHVyYXRpb246IDFzOwoJYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogZWFzZS1vdXQ7CglhbmltYXRpb24tZmlsbC1tb2RlOiBmb3J3YXJkczsKfQoKQGtleWZyYW1lcyBmYWRlaW4tYm90dG9tIHsKCTAlIHsKCQlvcGFjaXR5OiAwOwoJCXRyYW5zZm9ybTogdHJhbnNsYXRlWCgxNTBweCk7Cgl9CgkxMDAlIHsKCQlvcGFjaXR5OiAxOwoJCXRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTsKCX0KfQ==">
    <link rel="stylesheet" href="data:text/css;base64,77u/dGV4dGFyZWEua3Ygew0KICB3aWR0aDogMzQwcHg7DQogIGhlaWdodDogMTUwcHg7DQogIGZvbnQtc2l6ZTogMzBweDsNCiAgY29sb3I6ICMyZTMxMmU7DQogIGJhY2tncm91bmQ6IHJnYigyMTgsIDIzMCwgMjE1KTsNCiAgYm9yZGVyLXJhZGl1czogM3B4Ow0KICBib3JkZXI6IDFweCBzb2xpZCByZ2IoMTU0LCAxNzMsIDE0OSk7DQp9DQoNCnRhYmxlLnRhew0KICB3aWR0aDogOTAlDQp9">
    <script src="data:application/javascript;base64,dmFyIFZ1ZSA9IChmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogTWFrZSBhIG1hcCBhbmQgcmV0dXJuIGEgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGEga2V5CiAgICogaXMgaW4gdGhhdCBtYXAuCiAgICogSU1QT1JUQU5UOiBhbGwgY2FsbHMgb2YgdGhpcyBmdW5jdGlvbiBtdXN0IGJlIHByZWZpeGVkIHdpdGgKICAgKiBcL1wqI1xfXF9QVVJFXF9cX1wqXC8KICAgKiBTbyB0aGF0IHJvbGx1cCBjYW4gdHJlZS1zaGFrZSB0aGVtIGlmIG5lY2Vzc2FyeS4KICAgKi8KICBmdW5jdGlvbiBtYWtlTWFwKHN0ciwgZXhwZWN0c0xvd2VyQ2FzZSkgewogICAgICBjb25zdCBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBjb25zdCBsaXN0ID0gc3RyLnNwbGl0KCcsJyk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgbWFwW2xpc3RbaV1dID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZXhwZWN0c0xvd2VyQ2FzZSA/IHZhbCA9PiAhIW1hcFt2YWwudG9Mb3dlckNhc2UoKV0gOiB2YWwgPT4gISFtYXBbdmFsXTsKICB9CgogIC8qKgogICAqIGRldiBvbmx5IGZsYWcgLT4gbmFtZSBtYXBwaW5nCiAgICovCiAgY29uc3QgUGF0Y2hGbGFnTmFtZXMgPSB7CiAgICAgIFsxIC8qIFRFWFQgKi9dOiBgVEVYVGAsCiAgICAgIFsyIC8qIENMQVNTICovXTogYENMQVNTYCwKICAgICAgWzQgLyogU1RZTEUgKi9dOiBgU1RZTEVgLAogICAgICBbOCAvKiBQUk9QUyAqL106IGBQUk9QU2AsCiAgICAgIFsxNiAvKiBGVUxMX1BST1BTICovXTogYEZVTExfUFJPUFNgLAogICAgICBbMzIgLyogSFlEUkFURV9FVkVOVFMgKi9dOiBgSFlEUkFURV9FVkVOVFNgLAogICAgICBbNjQgLyogU1RBQkxFX0ZSQUdNRU5UICovXTogYFNUQUJMRV9GUkFHTUVOVGAsCiAgICAgIFsxMjggLyogS0VZRURfRlJBR01FTlQgKi9dOiBgS0VZRURfRlJBR01FTlRgLAogICAgICBbMjU2IC8qIFVOS0VZRURfRlJBR01FTlQgKi9dOiBgVU5LRVlFRF9GUkFHTUVOVGAsCiAgICAgIFs1MTIgLyogTkVFRF9QQVRDSCAqL106IGBORUVEX1BBVENIYCwKICAgICAgWzEwMjQgLyogRFlOQU1JQ19TTE9UUyAqL106IGBEWU5BTUlDX1NMT1RTYCwKICAgICAgWzIwNDggLyogREVWX1JPT1RfRlJBR01FTlQgKi9dOiBgREVWX1JPT1RfRlJBR01FTlRgLAogICAgICBbLTEgLyogSE9JU1RFRCAqL106IGBIT0lTVEVEYCwKICAgICAgWy0yIC8qIEJBSUwgKi9dOiBgQkFJTGAKICB9OwoKICAvKioKICAgKiBEZXYgb25seQogICAqLwogIGNvbnN0IHNsb3RGbGFnc1RleHQgPSB7CiAgICAgIFsxIC8qIFNUQUJMRSAqL106ICdTVEFCTEUnLAogICAgICBbMiAvKiBEWU5BTUlDICovXTogJ0RZTkFNSUMnLAogICAgICBbMyAvKiBGT1JXQVJERUQgKi9dOiAnRk9SV0FSREVEJwogIH07CgogIGNvbnN0IEdMT0JBTFNfV0hJVEVfTElTVEVEID0gJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4scGFyc2VGbG9hdCxwYXJzZUludCxkZWNvZGVVUkksJyArCiAgICAgICdkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCxNYXRoLE51bWJlcixEYXRlLEFycmF5LCcgKwogICAgICAnT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCxCaWdJbnQnOwogIGNvbnN0IGlzR2xvYmFsbHlXaGl0ZWxpc3RlZCA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChHTE9CQUxTX1dISVRFX0xJU1RFRCk7CgogIGNvbnN0IHJhbmdlID0gMjsKICBmdW5jdGlvbiBnZW5lcmF0ZUNvZGVGcmFtZShzb3VyY2UsIHN0YXJ0ID0gMCwgZW5kID0gc291cmNlLmxlbmd0aCkgewogICAgICAvLyBTcGxpdCB0aGUgY29udGVudCBpbnRvIGluZGl2aWR1YWwgbGluZXMgYnV0IGNhcHR1cmUgdGhlIG5ld2xpbmUgc2VxdWVuY2UKICAgICAgLy8gdGhhdCBzZXBhcmF0ZWQgZWFjaCBsaW5lLiBUaGlzIGlzIGltcG9ydGFudCBiZWNhdXNlIHRoZSBhY3R1YWwgc2VxdWVuY2UgaXMKICAgICAgLy8gbmVlZGVkIHRvIHByb3Blcmx5IHRha2UgaW50byBhY2NvdW50IHRoZSBmdWxsIGxpbmUgbGVuZ3RoIGZvciBvZmZzZXQKICAgICAgLy8gY29tcGFyaXNvbgogICAgICBsZXQgbGluZXMgPSBzb3VyY2Uuc3BsaXQoLyhccj9cbikvKTsKICAgICAgLy8gU2VwYXJhdGUgdGhlIGxpbmVzIGFuZCBuZXdsaW5lIHNlcXVlbmNlcyBpbnRvIHNlcGFyYXRlIGFycmF5cyBmb3IgZWFzaWVyIHJlZmVyZW5jaW5nCiAgICAgIGNvbnN0IG5ld2xpbmVTZXF1ZW5jZXMgPSBsaW5lcy5maWx0ZXIoKF8sIGlkeCkgPT4gaWR4ICUgMiA9PT0gMSk7CiAgICAgIGxpbmVzID0gbGluZXMuZmlsdGVyKChfLCBpZHgpID0+IGlkeCAlIDIgPT09IDApOwogICAgICBsZXQgY291bnQgPSAwOwogICAgICBjb25zdCByZXMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY291bnQgKz0KICAgICAgICAgICAgICBsaW5lc1tpXS5sZW5ndGggKwogICAgICAgICAgICAgICAgICAoKG5ld2xpbmVTZXF1ZW5jZXNbaV0gJiYgbmV3bGluZVNlcXVlbmNlc1tpXS5sZW5ndGgpIHx8IDApOwogICAgICAgICAgaWYgKGNvdW50ID49IHN0YXJ0KSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IGkgLSByYW5nZTsgaiA8PSBpICsgcmFuZ2UgfHwgZW5kID4gY291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICBpZiAoaiA8IDAgfHwgaiA+PSBsaW5lcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgY29uc3QgbGluZSA9IGogKyAxOwogICAgICAgICAgICAgICAgICByZXMucHVzaChgJHtsaW5lfSR7JyAnLnJlcGVhdChNYXRoLm1heCgzIC0gU3RyaW5nKGxpbmUpLmxlbmd0aCwgMCkpfXwgICR7bGluZXNbal19YCk7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmVMZW5ndGggPSBsaW5lc1tqXS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0xpbmVTZXFMZW5ndGggPSAobmV3bGluZVNlcXVlbmNlc1tqXSAmJiBuZXdsaW5lU2VxdWVuY2VzW2pdLmxlbmd0aCkgfHwgMDsKICAgICAgICAgICAgICAgICAgaWYgKGogPT09IGkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHB1c2ggdW5kZXJsaW5lCiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYWQgPSBzdGFydCAtIChjb3VudCAtIChsaW5lTGVuZ3RoICsgbmV3TGluZVNlcUxlbmd0aCkpOwogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoMSwgZW5kID4gY291bnQgPyBsaW5lTGVuZ3RoIC0gcGFkIDogZW5kIC0gc3RhcnQpOwogICAgICAgICAgICAgICAgICAgICAgcmVzLnB1c2goYCAgIHwgIGAgKyAnICcucmVwZWF0KHBhZCkgKyAnXicucmVwZWF0KGxlbmd0aCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGogPiBpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kID4gY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBNYXRoLm1heChNYXRoLm1pbihlbmQgLSBjb3VudCwgbGluZUxlbmd0aCksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKGAgICB8ICBgICsgJ14nLnJlcGVhdChsZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNvdW50ICs9IGxpbmVMZW5ndGggKyBuZXdMaW5lU2VxTGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXMuam9pbignXG4nKTsKICB9CgogIC8qKgogICAqIE9uIHRoZSBjbGllbnQgd2Ugb25seSBuZWVkIHRvIG9mZmVyIHNwZWNpYWwgY2FzZXMgZm9yIGJvb2xlYW4gYXR0cmlidXRlcyB0aGF0CiAgICogaGF2ZSBkaWZmZXJlbnQgbmFtZXMgZnJvbSB0aGVpciBjb3JyZXNwb25kaW5nIGRvbSBwcm9wZXJ0aWVzOgogICAqIC0gaXRlbXNjb3BlIC0+IE4vQQogICAqIC0gYWxsb3dmdWxsc2NyZWVuIC0+IGFsbG93RnVsbHNjcmVlbgogICAqIC0gZm9ybW5vdmFsaWRhdGUgLT4gZm9ybU5vVmFsaWRhdGUKICAgKiAtIGlzbWFwIC0+IGlzTWFwCiAgICogLSBub21vZHVsZSAtPiBub01vZHVsZQogICAqIC0gbm92YWxpZGF0ZSAtPiBub1ZhbGlkYXRlCiAgICogLSByZWFkb25seSAtPiByZWFkT25seQogICAqLwogIGNvbnN0IHNwZWNpYWxCb29sZWFuQXR0cnMgPSBgaXRlbXNjb3BlLGFsbG93ZnVsbHNjcmVlbixmb3Jtbm92YWxpZGF0ZSxpc21hcCxub21vZHVsZSxub3ZhbGlkYXRlLHJlYWRvbmx5YDsKICBjb25zdCBpc1NwZWNpYWxCb29sZWFuQXR0ciA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChzcGVjaWFsQm9vbGVhbkF0dHJzKTsKICAvKioKICAgKiBCb29sZWFuIGF0dHJpYnV0ZXMgc2hvdWxkIGJlIGluY2x1ZGVkIGlmIHRoZSB2YWx1ZSBpcyB0cnV0aHkgb3IgJycuCiAgICogZS5nLiBgPHNlbGVjdCBtdWx0aXBsZT5gIGNvbXBpbGVzIHRvIGB7IG11bHRpcGxlOiAnJyB9YAogICAqLwogIGZ1bmN0aW9uIGluY2x1ZGVCb29sZWFuQXR0cih2YWx1ZSkgewogICAgICByZXR1cm4gISF2YWx1ZSB8fCB2YWx1ZSA9PT0gJyc7CiAgfQoKICBmdW5jdGlvbiBub3JtYWxpemVTdHlsZSh2YWx1ZSkgewogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIGNvbnN0IHJlcyA9IHt9OwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB2YWx1ZVtpXTsKICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkID0gaXNTdHJpbmcoaXRlbSkKICAgICAgICAgICAgICAgICAgPyBwYXJzZVN0cmluZ1N0eWxlKGl0ZW0pCiAgICAgICAgICAgICAgICAgIDogbm9ybWFsaXplU3R5bGUoaXRlbSk7CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWQpIHsKICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbm9ybWFsaXplZCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzW2tleV0gPSBub3JtYWxpemVkW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgfQogIGNvbnN0IGxpc3REZWxpbWl0ZXJSRSA9IC87KD8hW14oXSpcKSkvZzsKICBjb25zdCBwcm9wZXJ0eURlbGltaXRlclJFID0gLzooLispLzsKICBmdW5jdGlvbiBwYXJzZVN0cmluZ1N0eWxlKGNzc1RleHQpIHsKICAgICAgY29uc3QgcmV0ID0ge307CiAgICAgIGNzc1RleHQuc3BsaXQobGlzdERlbGltaXRlclJFKS5mb3JFYWNoKGl0ZW0gPT4gewogICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICBjb25zdCB0bXAgPSBpdGVtLnNwbGl0KHByb3BlcnR5RGVsaW1pdGVyUkUpOwogICAgICAgICAgICAgIHRtcC5sZW5ndGggPiAxICYmIChyZXRbdG1wWzBdLnRyaW0oKV0gPSB0bXBbMV0udHJpbSgpKTsKICAgICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXQ7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNsYXNzKHZhbHVlKSB7CiAgICAgIGxldCByZXMgPSAnJzsKICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgcmVzID0gdmFsdWU7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplQ2xhc3ModmFsdWVbaV0pOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemVkKSB7CiAgICAgICAgICAgICAgICAgIHJlcyArPSBub3JtYWxpemVkICsgJyAnOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZVtuYW1lXSkgewogICAgICAgICAgICAgICAgICByZXMgKz0gbmFtZSArICcgJzsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlcy50cmltKCk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzKHByb3BzKSB7CiAgICAgIGlmICghcHJvcHMpCiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgbGV0IHsgY2xhc3M6IGtsYXNzLCBzdHlsZSB9ID0gcHJvcHM7CiAgICAgIGlmIChrbGFzcyAmJiAhaXNTdHJpbmcoa2xhc3MpKSB7CiAgICAgICAgICBwcm9wcy5jbGFzcyA9IG5vcm1hbGl6ZUNsYXNzKGtsYXNzKTsKICAgICAgfQogICAgICBpZiAoc3R5bGUpIHsKICAgICAgICAgIHByb3BzLnN0eWxlID0gbm9ybWFsaXplU3R5bGUoc3R5bGUpOwogICAgICB9CiAgICAgIHJldHVybiBwcm9wczsKICB9CgogIC8vIFRoZXNlIHRhZyBjb25maWdzIGFyZSBzaGFyZWQgYmV0d2VlbiBjb21waWxlci1kb20gYW5kIHJ1bnRpbWUtZG9tLCBzbyB0aGV5CiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSFRNTC9FbGVtZW50CiAgY29uc3QgSFRNTF9UQUdTID0gJ2h0bWwsYm9keSxiYXNlLGhlYWQsbGluayxtZXRhLHN0eWxlLHRpdGxlLGFkZHJlc3MsYXJ0aWNsZSxhc2lkZSxmb290ZXIsJyArCiAgICAgICdoZWFkZXIsaDEsaDIsaDMsaDQsaDUsaDYsbmF2LHNlY3Rpb24sZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sJyArCiAgICAgICdmaWd1cmUscGljdHVyZSxocixpbWcsbGksbWFpbixvbCxwLHByZSx1bCxhLGIsYWJicixiZGksYmRvLGJyLGNpdGUsY29kZSwnICsKICAgICAgJ2RhdGEsZGZuLGVtLGksa2JkLG1hcmsscSxycCxydCxydWJ5LHMsc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLCcgKwogICAgICAndGltZSx1LHZhcix3YnIsYXJlYSxhdWRpbyxtYXAsdHJhY2ssdmlkZW8sZW1iZWQsb2JqZWN0LHBhcmFtLHNvdXJjZSwnICsKICAgICAgJ2NhbnZhcyxzY3JpcHQsbm9zY3JpcHQsZGVsLGlucyxjYXB0aW9uLGNvbCxjb2xncm91cCx0YWJsZSx0aGVhZCx0Ym9keSx0ZCwnICsKICAgICAgJ3RoLHRyLGJ1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCwnICsKICAgICAgJ29wdGlvbixvdXRwdXQscHJvZ3Jlc3Msc2VsZWN0LHRleHRhcmVhLGRldGFpbHMsZGlhbG9nLG1lbnUsJyArCiAgICAgICdzdW1tYXJ5LHRlbXBsYXRlLGJsb2NrcXVvdGUsaWZyYW1lLHRmb290JzsKICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9TVkcvRWxlbWVudAogIGNvbnN0IFNWR19UQUdTID0gJ3N2ZyxhbmltYXRlLGFuaW1hdGVNb3Rpb24sYW5pbWF0ZVRyYW5zZm9ybSxjaXJjbGUsY2xpcFBhdGgsY29sb3ItcHJvZmlsZSwnICsKICAgICAgJ2RlZnMsZGVzYyxkaXNjYXJkLGVsbGlwc2UsZmVCbGVuZCxmZUNvbG9yTWF0cml4LGZlQ29tcG9uZW50VHJhbnNmZXIsJyArCiAgICAgICdmZUNvbXBvc2l0ZSxmZUNvbnZvbHZlTWF0cml4LGZlRGlmZnVzZUxpZ2h0aW5nLGZlRGlzcGxhY2VtZW50TWFwLCcgKwogICAgICAnZmVEaXN0YW5jZUxpZ2h0LGZlRHJvcFNoYWRvdyxmZUZsb29kLGZlRnVuY0EsZmVGdW5jQixmZUZ1bmNHLGZlRnVuY1IsJyArCiAgICAgICdmZUdhdXNzaWFuQmx1cixmZUltYWdlLGZlTWVyZ2UsZmVNZXJnZU5vZGUsZmVNb3JwaG9sb2d5LGZlT2Zmc2V0LCcgKwogICAgICAnZmVQb2ludExpZ2h0LGZlU3BlY3VsYXJMaWdodGluZyxmZVNwb3RMaWdodCxmZVRpbGUsZmVUdXJidWxlbmNlLGZpbHRlciwnICsKICAgICAgJ2ZvcmVpZ25PYmplY3QsZyxoYXRjaCxoYXRjaHBhdGgsaW1hZ2UsbGluZSxsaW5lYXJHcmFkaWVudCxtYXJrZXIsbWFzaywnICsKICAgICAgJ21lc2gsbWVzaGdyYWRpZW50LG1lc2hwYXRjaCxtZXNocm93LG1ldGFkYXRhLG1wYXRoLHBhdGgscGF0dGVybiwnICsKICAgICAgJ3BvbHlnb24scG9seWxpbmUscmFkaWFsR3JhZGllbnQscmVjdCxzZXQsc29saWRjb2xvcixzdG9wLHN3aXRjaCxzeW1ib2wsJyArCiAgICAgICd0ZXh0LHRleHRQYXRoLHRpdGxlLHRzcGFuLHVua25vd24sdXNlLHZpZXcnOwogIGNvbnN0IFZPSURfVEFHUyA9ICdhcmVhLGJhc2UsYnIsY29sLGVtYmVkLGhyLGltZyxpbnB1dCxsaW5rLG1ldGEscGFyYW0sc291cmNlLHRyYWNrLHdicic7CiAgLyoqCiAgICogQ29tcGlsZXIgb25seS4KICAgKiBEbyBOT1QgdXNlIGluIHJ1bnRpbWUgY29kZSBwYXRocyB1bmxlc3MgYmVoaW5kIGB0cnVlYCBmbGFnLgogICAqLwogIGNvbnN0IGlzSFRNTFRhZyA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChIVE1MX1RBR1MpOwogIC8qKgogICAqIENvbXBpbGVyIG9ubHkuCiAgICogRG8gTk9UIHVzZSBpbiBydW50aW1lIGNvZGUgcGF0aHMgdW5sZXNzIGJlaGluZCBgdHJ1ZWAgZmxhZy4KICAgKi8KICBjb25zdCBpc1NWR1RhZyA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChTVkdfVEFHUyk7CiAgLyoqCiAgICogQ29tcGlsZXIgb25seS4KICAgKiBEbyBOT1QgdXNlIGluIHJ1bnRpbWUgY29kZSBwYXRocyB1bmxlc3MgYmVoaW5kIGB0cnVlYCBmbGFnLgogICAqLwogIGNvbnN0IGlzVm9pZFRhZyA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChWT0lEX1RBR1MpOwoKICBmdW5jdGlvbiBsb29zZUNvbXBhcmVBcnJheXMoYSwgYikgewogICAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICBsZXQgZXF1YWwgPSB0cnVlOwogICAgICBmb3IgKGxldCBpID0gMDsgZXF1YWwgJiYgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGVxdWFsID0gbG9vc2VFcXVhbChhW2ldLCBiW2ldKTsKICAgICAgfQogICAgICByZXR1cm4gZXF1YWw7CiAgfQogIGZ1bmN0aW9uIGxvb3NlRXF1YWwoYSwgYikgewogICAgICBpZiAoYSA9PT0gYikKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICBsZXQgYVZhbGlkVHlwZSA9IGlzRGF0ZShhKTsKICAgICAgbGV0IGJWYWxpZFR5cGUgPSBpc0RhdGUoYik7CiAgICAgIGlmIChhVmFsaWRUeXBlIHx8IGJWYWxpZFR5cGUpIHsKICAgICAgICAgIHJldHVybiBhVmFsaWRUeXBlICYmIGJWYWxpZFR5cGUgPyBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCkgOiBmYWxzZTsKICAgICAgfQogICAgICBhVmFsaWRUeXBlID0gaXNTeW1ib2woYSk7CiAgICAgIGJWYWxpZFR5cGUgPSBpc1N5bWJvbChiKTsKICAgICAgaWYgKGFWYWxpZFR5cGUgfHwgYlZhbGlkVHlwZSkgewogICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgIH0KICAgICAgYVZhbGlkVHlwZSA9IGlzQXJyYXkoYSk7CiAgICAgIGJWYWxpZFR5cGUgPSBpc0FycmF5KGIpOwogICAgICBpZiAoYVZhbGlkVHlwZSB8fCBiVmFsaWRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gYVZhbGlkVHlwZSAmJiBiVmFsaWRUeXBlID8gbG9vc2VDb21wYXJlQXJyYXlzKGEsIGIpIDogZmFsc2U7CiAgICAgIH0KICAgICAgYVZhbGlkVHlwZSA9IGlzT2JqZWN0KGEpOwogICAgICBiVmFsaWRUeXBlID0gaXNPYmplY3QoYik7CiAgICAgIGlmIChhVmFsaWRUeXBlIHx8IGJWYWxpZFR5cGUpIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZjogdGhpcyBpZiB3aWxsIHByb2JhYmx5IG5ldmVyIGJlIGNhbGxlZCAqLwogICAgICAgICAgaWYgKCFhVmFsaWRUeXBlIHx8ICFiVmFsaWRUeXBlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYUtleXNDb3VudCA9IE9iamVjdC5rZXlzKGEpLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IGJLZXlzQ291bnQgPSBPYmplY3Qua2V5cyhiKS5sZW5ndGg7CiAgICAgICAgICBpZiAoYUtleXNDb3VudCAhPT0gYktleXNDb3VudCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGEpIHsKICAgICAgICAgICAgICBjb25zdCBhSGFzS2V5ID0gYS5oYXNPd25Qcm9wZXJ0eShrZXkpOwogICAgICAgICAgICAgIGNvbnN0IGJIYXNLZXkgPSBiLmhhc093blByb3BlcnR5KGtleSk7CiAgICAgICAgICAgICAgaWYgKChhSGFzS2V5ICYmICFiSGFzS2V5KSB8fAogICAgICAgICAgICAgICAgICAoIWFIYXNLZXkgJiYgYkhhc0tleSkgfHwKICAgICAgICAgICAgICAgICAgIWxvb3NlRXF1YWwoYVtrZXldLCBiW2tleV0pKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIFN0cmluZyhhKSA9PT0gU3RyaW5nKGIpOwogIH0KICBmdW5jdGlvbiBsb29zZUluZGV4T2YoYXJyLCB2YWwpIHsKICAgICAgcmV0dXJuIGFyci5maW5kSW5kZXgoaXRlbSA9PiBsb29zZUVxdWFsKGl0ZW0sIHZhbCkpOwogIH0KCiAgLyoqCiAgICogRm9yIGNvbnZlcnRpbmcge3sgaW50ZXJwb2xhdGlvbiB9fSB2YWx1ZXMgdG8gZGlzcGxheWVkIHN0cmluZ3MuCiAgICogQHByaXZhdGUKICAgKi8KICBjb25zdCB0b0Rpc3BsYXlTdHJpbmcgPSAodmFsKSA9PiB7CiAgICAgIHJldHVybiBpc1N0cmluZyh2YWwpCiAgICAgICAgICA/IHZhbAogICAgICAgICAgOiB2YWwgPT0gbnVsbAogICAgICAgICAgICAgID8gJycKICAgICAgICAgICAgICA6IGlzQXJyYXkodmFsKSB8fAogICAgICAgICAgICAgICAgICAoaXNPYmplY3QodmFsKSAmJgogICAgICAgICAgICAgICAgICAgICAgKHZhbC50b1N0cmluZyA9PT0gb2JqZWN0VG9TdHJpbmcgfHwgIWlzRnVuY3Rpb24odmFsLnRvU3RyaW5nKSkpCiAgICAgICAgICAgICAgICAgID8gSlNPTi5zdHJpbmdpZnkodmFsLCByZXBsYWNlciwgMikKICAgICAgICAgICAgICAgICAgOiBTdHJpbmcodmFsKTsKICB9OwogIGNvbnN0IHJlcGxhY2VyID0gKF9rZXksIHZhbCkgPT4gewogICAgICAvLyBjYW4ndCB1c2UgaXNSZWYgaGVyZSBzaW5jZSBAdnVlL3NoYXJlZCBoYXMgbm8gZGVwcwogICAgICBpZiAodmFsICYmIHZhbC5fX3ZfaXNSZWYpIHsKICAgICAgICAgIHJldHVybiByZXBsYWNlcihfa2V5LCB2YWwudmFsdWUpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzTWFwKHZhbCkpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgW2BNYXAoJHt2YWwuc2l6ZX0pYF06IFsuLi52YWwuZW50cmllcygpXS5yZWR1Y2UoKGVudHJpZXMsIFtrZXksIHZhbF0pID0+IHsKICAgICAgICAgICAgICAgICAgZW50cmllc1tgJHtrZXl9ID0+YF0gPSB2YWw7CiAgICAgICAgICAgICAgICAgIHJldHVybiBlbnRyaWVzOwogICAgICAgICAgICAgIH0sIHt9KQogICAgICAgICAgfTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc1NldCh2YWwpKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIFtgU2V0KCR7dmFsLnNpemV9KWBdOiBbLi4udmFsLnZhbHVlcygpXQogICAgICAgICAgfTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc09iamVjdCh2YWwpICYmICFpc0FycmF5KHZhbCkgJiYgIWlzUGxhaW5PYmplY3QodmFsKSkgewogICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWwpOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgfTsKCiAgY29uc3QgRU1QVFlfT0JKID0gT2JqZWN0LmZyZWV6ZSh7fSkKICAgICAgOwogIGNvbnN0IEVNUFRZX0FSUiA9IE9iamVjdC5mcmVlemUoW10pIDsKICBjb25zdCBOT09QID0gKCkgPT4geyB9OwogIC8qKgogICAqIEFsd2F5cyByZXR1cm4gZmFsc2UuCiAgICovCiAgY29uc3QgTk8gPSAoKSA9PiBmYWxzZTsKICBjb25zdCBvblJFID0gL15vblteYS16XS87CiAgY29uc3QgaXNPbiA9IChrZXkpID0+IG9uUkUudGVzdChrZXkpOwogIGNvbnN0IGlzTW9kZWxMaXN0ZW5lciA9IChrZXkpID0+IGtleS5zdGFydHNXaXRoKCdvblVwZGF0ZTonKTsKICBjb25zdCBleHRlbmQgPSBPYmplY3QuYXNzaWduOwogIGNvbnN0IHJlbW92ZSA9IChhcnIsIGVsKSA9PiB7CiAgICAgIGNvbnN0IGkgPSBhcnIuaW5kZXhPZihlbCk7CiAgICAgIGlmIChpID4gLTEpIHsKICAgICAgICAgIGFyci5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICB9OwogIGNvbnN0IGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICBjb25zdCBoYXNPd24gPSAodmFsLCBrZXkpID0+IGhhc093blByb3BlcnR5LmNhbGwodmFsLCBrZXkpOwogIGNvbnN0IGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwogIGNvbnN0IGlzTWFwID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICdbb2JqZWN0IE1hcF0nOwogIGNvbnN0IGlzU2V0ID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICdbb2JqZWN0IFNldF0nOwogIGNvbnN0IGlzRGF0ZSA9ICh2YWwpID0+IHRvVHlwZVN0cmluZyh2YWwpID09PSAnW29iamVjdCBEYXRlXSc7CiAgY29uc3QgaXNGdW5jdGlvbiA9ICh2YWwpID0+IHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbic7CiAgY29uc3QgaXNTdHJpbmcgPSAodmFsKSA9PiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJzsKICBjb25zdCBpc1N5bWJvbCA9ICh2YWwpID0+IHR5cGVvZiB2YWwgPT09ICdzeW1ib2wnOwogIGNvbnN0IGlzT2JqZWN0ID0gKHZhbCkgPT4gdmFsICE9PSBudWxsICYmIHR5cGVvZiB2YWwgPT09ICdvYmplY3QnOwogIGNvbnN0IGlzUHJvbWlzZSA9ICh2YWwpID0+IHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KHZhbCkgJiYgaXNGdW5jdGlvbih2YWwudGhlbikgJiYgaXNGdW5jdGlvbih2YWwuY2F0Y2gpOwogIH07CiAgY29uc3Qgb2JqZWN0VG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIGNvbnN0IHRvVHlwZVN0cmluZyA9ICh2YWx1ZSkgPT4gb2JqZWN0VG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgY29uc3QgdG9SYXdUeXBlID0gKHZhbHVlKSA9PiB7CiAgICAgIC8vIGV4dHJhY3QgIlJhd1R5cGUiIGZyb20gc3RyaW5ncyBsaWtlICJbb2JqZWN0IFJhd1R5cGVdIgogICAgICByZXR1cm4gdG9UeXBlU3RyaW5nKHZhbHVlKS5zbGljZSg4LCAtMSk7CiAgfTsKICBjb25zdCBpc1BsYWluT2JqZWN0ID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICdbb2JqZWN0IE9iamVjdF0nOwogIGNvbnN0IGlzSW50ZWdlcktleSA9IChrZXkpID0+IGlzU3RyaW5nKGtleSkgJiYKICAgICAga2V5ICE9PSAnTmFOJyAmJgogICAgICBrZXlbMF0gIT09ICctJyAmJgogICAgICAnJyArIHBhcnNlSW50KGtleSwgMTApID09PSBrZXk7CiAgY29uc3QgaXNSZXNlcnZlZFByb3AgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoCiAgLy8gdGhlIGxlYWRpbmcgY29tbWEgaXMgaW50ZW50aW9uYWwgc28gZW1wdHkgc3RyaW5nICIiIGlzIGFsc28gaW5jbHVkZWQKICAnLGtleSxyZWYscmVmX2ZvcixyZWZfa2V5LCcgKwogICAgICAnb25Wbm9kZUJlZm9yZU1vdW50LG9uVm5vZGVNb3VudGVkLCcgKwogICAgICAnb25Wbm9kZUJlZm9yZVVwZGF0ZSxvblZub2RlVXBkYXRlZCwnICsKICAgICAgJ29uVm5vZGVCZWZvcmVVbm1vdW50LG9uVm5vZGVVbm1vdW50ZWQnKTsKICBjb25zdCBpc0J1aWx0SW5EaXJlY3RpdmUgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoJ2JpbmQsY2xvYWssZWxzZS1pZixlbHNlLGZvcixodG1sLGlmLG1vZGVsLG9uLG9uY2UscHJlLHNob3csc2xvdCx0ZXh0LG1lbW8nKTsKICBjb25zdCBjYWNoZVN0cmluZ0Z1bmN0aW9uID0gKGZuKSA9PiB7CiAgICAgIGNvbnN0IGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgcmV0dXJuICgoc3RyKSA9PiB7CiAgICAgICAgICBjb25zdCBoaXQgPSBjYWNoZVtzdHJdOwogICAgICAgICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpOwogICAgICB9KTsKICB9OwogIGNvbnN0IGNhbWVsaXplUkUgPSAvLShcdykvZzsKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGNvbnN0IGNhbWVsaXplID0gY2FjaGVTdHJpbmdGdW5jdGlvbigoc3RyKSA9PiB7CiAgICAgIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCAoXywgYykgPT4gKGMgPyBjLnRvVXBwZXJDYXNlKCkgOiAnJykpOwogIH0pOwogIGNvbnN0IGh5cGhlbmF0ZVJFID0gL1xCKFtBLVpdKS9nOwogIC8qKgogICAqIEBwcml2YXRlCiAgICovCiAgY29uc3QgaHlwaGVuYXRlID0gY2FjaGVTdHJpbmdGdW5jdGlvbigoc3RyKSA9PiBzdHIucmVwbGFjZShoeXBoZW5hdGVSRSwgJy0kMScpLnRvTG93ZXJDYXNlKCkpOwogIC8qKgogICAqIEBwcml2YXRlCiAgICovCiAgY29uc3QgY2FwaXRhbGl6ZSA9IGNhY2hlU3RyaW5nRnVuY3Rpb24oKHN0cikgPT4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpKTsKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGNvbnN0IHRvSGFuZGxlcktleSA9IGNhY2hlU3RyaW5nRnVuY3Rpb24oKHN0cikgPT4gc3RyID8gYG9uJHtjYXBpdGFsaXplKHN0cil9YCA6IGBgKTsKICAvLyBjb21wYXJlIHdoZXRoZXIgYSB2YWx1ZSBoYXMgY2hhbmdlZCwgYWNjb3VudGluZyBmb3IgTmFOLgogIGNvbnN0IGhhc0NoYW5nZWQgPSAodmFsdWUsIG9sZFZhbHVlKSA9PiAhT2JqZWN0LmlzKHZhbHVlLCBvbGRWYWx1ZSk7CiAgY29uc3QgaW52b2tlQXJyYXlGbnMgPSAoZm5zLCBhcmcpID0+IHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZuc1tpXShhcmcpOwogICAgICB9CiAgfTsKICBjb25zdCBkZWYgPSAob2JqLCBrZXksIHZhbHVlKSA9PiB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICB2YWx1ZQogICAgICB9KTsKICB9OwogIGNvbnN0IHRvTnVtYmVyID0gKHZhbCkgPT4gewogICAgICBjb25zdCBuID0gcGFyc2VGbG9hdCh2YWwpOwogICAgICByZXR1cm4gaXNOYU4obikgPyB2YWwgOiBuOwogIH07CiAgbGV0IF9nbG9iYWxUaGlzOwogIGNvbnN0IGdldEdsb2JhbFRoaXMgPSAoKSA9PiB7CiAgICAgIHJldHVybiAoX2dsb2JhbFRoaXMgfHwKICAgICAgICAgIChfZ2xvYmFsVGhpcyA9CiAgICAgICAgICAgICAgdHlwZW9mIGdsb2JhbFRoaXMgIT09ICd1bmRlZmluZWQnCiAgICAgICAgICAgICAgICAgID8gZ2xvYmFsVGhpcwogICAgICAgICAgICAgICAgICA6IHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJwogICAgICAgICAgICAgICAgICAgICAgPyBzZWxmCiAgICAgICAgICAgICAgICAgICAgICA6IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyB3aW5kb3cKICAgICAgICAgICAgICAgICAgICAgICAgICA6IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZ2xvYmFsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDoge30pKTsKICB9OwoKICBmdW5jdGlvbiB3YXJuKG1zZywgLi4uYXJncykgewogICAgICBjb25zb2xlLndhcm4oYFtWdWUgd2Fybl0gJHttc2d9YCwgLi4uYXJncyk7CiAgfQoKICBsZXQgYWN0aXZlRWZmZWN0U2NvcGU7CiAgY2xhc3MgRWZmZWN0U2NvcGUgewogICAgICBjb25zdHJ1Y3RvcihkZXRhY2hlZCA9IGZhbHNlKSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICB0aGlzLmVmZmVjdHMgPSBbXTsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIHRoaXMuY2xlYW51cHMgPSBbXTsKICAgICAgICAgIGlmICghZGV0YWNoZWQgJiYgYWN0aXZlRWZmZWN0U2NvcGUpIHsKICAgICAgICAgICAgICB0aGlzLnBhcmVudCA9IGFjdGl2ZUVmZmVjdFNjb3BlOwogICAgICAgICAgICAgIHRoaXMuaW5kZXggPQogICAgICAgICAgICAgICAgICAoYWN0aXZlRWZmZWN0U2NvcGUuc2NvcGVzIHx8IChhY3RpdmVFZmZlY3RTY29wZS5zY29wZXMgPSBbXSkpLnB1c2godGhpcykgLSAxOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJ1bihmbikgewogICAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgY29uc3QgY3VycmVudEVmZmVjdFNjb3BlID0gYWN0aXZlRWZmZWN0U2NvcGU7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzOwogICAgICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gY3VycmVudEVmZmVjdFNjb3BlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm4oYGNhbm5vdCBydW4gYW4gaW5hY3RpdmUgZWZmZWN0IHNjb3BlLmApOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzCiAgICAgICAqIEBpbnRlcm5hbAogICAgICAgKi8KICAgICAgb24oKSB7CiAgICAgICAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXM7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIG5vbi1kZXRhY2hlZCBzY29wZXMKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICBvZmYoKSB7CiAgICAgICAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXMucGFyZW50OwogICAgICB9CiAgICAgIHN0b3AoZnJvbVBhcmVudCkgewogICAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgbGV0IGksIGw7CiAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuZWZmZWN0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdGhpcy5lZmZlY3RzW2ldLnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuY2xlYW51cHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYW51cHNbaV0oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMuc2NvcGVzKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLnNjb3Blcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2NvcGVzW2ldLnN0b3AodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gbmVzdGVkIHNjb3BlLCBkZXJlZmVyZW5jZSBmcm9tIHBhcmVudCB0byBhdm9pZCBtZW1vcnkgbGVha3MKICAgICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQgJiYgIWZyb21QYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgLy8gb3B0aW1pemVkIE8oMSkgcmVtb3ZhbAogICAgICAgICAgICAgICAgICBjb25zdCBsYXN0ID0gdGhpcy5wYXJlbnQuc2NvcGVzLnBvcCgpOwogICAgICAgICAgICAgICAgICBpZiAobGFzdCAmJiBsYXN0ICE9PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC5zY29wZXNbdGhpcy5pbmRleF0gPSBsYXN0OwogICAgICAgICAgICAgICAgICAgICAgbGFzdC5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiBlZmZlY3RTY29wZShkZXRhY2hlZCkgewogICAgICByZXR1cm4gbmV3IEVmZmVjdFNjb3BlKGRldGFjaGVkKTsKICB9CiAgZnVuY3Rpb24gcmVjb3JkRWZmZWN0U2NvcGUoZWZmZWN0LCBzY29wZSA9IGFjdGl2ZUVmZmVjdFNjb3BlKSB7CiAgICAgIGlmIChzY29wZSAmJiBzY29wZS5hY3RpdmUpIHsKICAgICAgICAgIHNjb3BlLmVmZmVjdHMucHVzaChlZmZlY3QpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEN1cnJlbnRTY29wZSgpIHsKICAgICAgcmV0dXJuIGFjdGl2ZUVmZmVjdFNjb3BlOwogIH0KICBmdW5jdGlvbiBvblNjb3BlRGlzcG9zZShmbikgewogICAgICBpZiAoYWN0aXZlRWZmZWN0U2NvcGUpIHsKICAgICAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlLmNsZWFudXBzLnB1c2goZm4pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgd2Fybihgb25TY29wZURpc3Bvc2UoKSBpcyBjYWxsZWQgd2hlbiB0aGVyZSBpcyBubyBhY3RpdmUgZWZmZWN0IHNjb3BlYCArCiAgICAgICAgICAgICAgYCB0byBiZSBhc3NvY2lhdGVkIHdpdGguYCk7CiAgICAgIH0KICB9CgogIGNvbnN0IGNyZWF0ZURlcCA9IChlZmZlY3RzKSA9PiB7CiAgICAgIGNvbnN0IGRlcCA9IG5ldyBTZXQoZWZmZWN0cyk7CiAgICAgIGRlcC53ID0gMDsKICAgICAgZGVwLm4gPSAwOwogICAgICByZXR1cm4gZGVwOwogIH07CiAgY29uc3Qgd2FzVHJhY2tlZCA9IChkZXApID0+IChkZXAudyAmIHRyYWNrT3BCaXQpID4gMDsKICBjb25zdCBuZXdUcmFja2VkID0gKGRlcCkgPT4gKGRlcC5uICYgdHJhY2tPcEJpdCkgPiAwOwogIGNvbnN0IGluaXREZXBNYXJrZXJzID0gKHsgZGVwcyB9KSA9PiB7CiAgICAgIGlmIChkZXBzLmxlbmd0aCkgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZGVwc1tpXS53IHw9IHRyYWNrT3BCaXQ7IC8vIHNldCB3YXMgdHJhY2tlZAogICAgICAgICAgfQogICAgICB9CiAgfTsKICBjb25zdCBmaW5hbGl6ZURlcE1hcmtlcnMgPSAoZWZmZWN0KSA9PiB7CiAgICAgIGNvbnN0IHsgZGVwcyB9ID0gZWZmZWN0OwogICAgICBpZiAoZGVwcy5sZW5ndGgpIHsKICAgICAgICAgIGxldCBwdHIgPSAwOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgZGVwID0gZGVwc1tpXTsKICAgICAgICAgICAgICBpZiAod2FzVHJhY2tlZChkZXApICYmICFuZXdUcmFja2VkKGRlcCkpIHsKICAgICAgICAgICAgICAgICAgZGVwLmRlbGV0ZShlZmZlY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVwc1twdHIrK10gPSBkZXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGNsZWFyIGJpdHMKICAgICAgICAgICAgICBkZXAudyAmPSB+dHJhY2tPcEJpdDsKICAgICAgICAgICAgICBkZXAubiAmPSB+dHJhY2tPcEJpdDsKICAgICAgICAgIH0KICAgICAgICAgIGRlcHMubGVuZ3RoID0gcHRyOwogICAgICB9CiAgfTsKCiAgY29uc3QgdGFyZ2V0TWFwID0gbmV3IFdlYWtNYXAoKTsKICAvLyBUaGUgbnVtYmVyIG9mIGVmZmVjdHMgY3VycmVudGx5IGJlaW5nIHRyYWNrZWQgcmVjdXJzaXZlbHkuCiAgbGV0IGVmZmVjdFRyYWNrRGVwdGggPSAwOwogIGxldCB0cmFja09wQml0ID0gMTsKICAvKioKICAgKiBUaGUgYml0d2lzZSB0cmFjayBtYXJrZXJzIHN1cHBvcnQgYXQgbW9zdCAzMCBsZXZlbHMgb2YgcmVjdXJzaW9uLgogICAqIFRoaXMgdmFsdWUgaXMgY2hvc2VuIHRvIGVuYWJsZSBtb2Rlcm4gSlMgZW5naW5lcyB0byB1c2UgYSBTTUkgb24gYWxsIHBsYXRmb3Jtcy4KICAgKiBXaGVuIHJlY3Vyc2lvbiBkZXB0aCBpcyBncmVhdGVyLCBmYWxsIGJhY2sgdG8gdXNpbmcgYSBmdWxsIGNsZWFudXAuCiAgICovCiAgY29uc3QgbWF4TWFya2VyQml0cyA9IDMwOwogIGxldCBhY3RpdmVFZmZlY3Q7CiAgY29uc3QgSVRFUkFURV9LRVkgPSBTeW1ib2woJ2l0ZXJhdGUnICk7CiAgY29uc3QgTUFQX0tFWV9JVEVSQVRFX0tFWSA9IFN5bWJvbCgnTWFwIGtleSBpdGVyYXRlJyApOwogIGNsYXNzIFJlYWN0aXZlRWZmZWN0IHsKICAgICAgY29uc3RydWN0b3IoZm4sIHNjaGVkdWxlciA9IG51bGwsIHNjb3BlKSB7CiAgICAgICAgICB0aGlzLmZuID0gZm47CiAgICAgICAgICB0aGlzLnNjaGVkdWxlciA9IHNjaGVkdWxlcjsKICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuZGVwcyA9IFtdOwogICAgICAgICAgdGhpcy5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICByZWNvcmRFZmZlY3RTY29wZSh0aGlzLCBzY29wZSk7CiAgICAgIH0KICAgICAgcnVuKCkgewogICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmZuKCk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgcGFyZW50ID0gYWN0aXZlRWZmZWN0OwogICAgICAgICAgbGV0IGxhc3RTaG91bGRUcmFjayA9IHNob3VsZFRyYWNrOwogICAgICAgICAgd2hpbGUgKHBhcmVudCkgewogICAgICAgICAgICAgIGlmIChwYXJlbnQgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0aGlzLnBhcmVudCA9IGFjdGl2ZUVmZmVjdDsKICAgICAgICAgICAgICBhY3RpdmVFZmZlY3QgPSB0aGlzOwogICAgICAgICAgICAgIHNob3VsZFRyYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICB0cmFja09wQml0ID0gMSA8PCArK2VmZmVjdFRyYWNrRGVwdGg7CiAgICAgICAgICAgICAgaWYgKGVmZmVjdFRyYWNrRGVwdGggPD0gbWF4TWFya2VyQml0cykgewogICAgICAgICAgICAgICAgICBpbml0RGVwTWFya2Vycyh0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNsZWFudXBFZmZlY3QodGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGlzLmZuKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoZWZmZWN0VHJhY2tEZXB0aCA8PSBtYXhNYXJrZXJCaXRzKSB7CiAgICAgICAgICAgICAgICAgIGZpbmFsaXplRGVwTWFya2Vycyh0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhY2tPcEJpdCA9IDEgPDwgLS1lZmZlY3RUcmFja0RlcHRoOwogICAgICAgICAgICAgIGFjdGl2ZUVmZmVjdCA9IHRoaXMucGFyZW50OwogICAgICAgICAgICAgIHNob3VsZFRyYWNrID0gbGFzdFNob3VsZFRyYWNrOwogICAgICAgICAgICAgIHRoaXMucGFyZW50ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgIGlmICh0aGlzLmRlZmVyU3RvcCkgewogICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgc3RvcCgpIHsKICAgICAgICAgIC8vIHN0b3BwZWQgd2hpbGUgcnVubmluZyBpdHNlbGYgLSBkZWZlciB0aGUgY2xlYW51cAogICAgICAgICAgaWYgKGFjdGl2ZUVmZmVjdCA9PT0gdGhpcykgewogICAgICAgICAgICAgIHRoaXMuZGVmZXJTdG9wID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgY2xlYW51cEVmZmVjdCh0aGlzKTsKICAgICAgICAgICAgICBpZiAodGhpcy5vblN0b3ApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5vblN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiBjbGVhbnVwRWZmZWN0KGVmZmVjdCkgewogICAgICBjb25zdCB7IGRlcHMgfSA9IGVmZmVjdDsKICAgICAgaWYgKGRlcHMubGVuZ3RoKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBkZXBzW2ldLmRlbGV0ZShlZmZlY3QpOwogICAgICAgICAgfQogICAgICAgICAgZGVwcy5sZW5ndGggPSAwOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGVmZmVjdChmbiwgb3B0aW9ucykgewogICAgICBpZiAoZm4uZWZmZWN0KSB7CiAgICAgICAgICBmbiA9IGZuLmVmZmVjdC5mbjsKICAgICAgfQogICAgICBjb25zdCBfZWZmZWN0ID0gbmV3IFJlYWN0aXZlRWZmZWN0KGZuKTsKICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgIGV4dGVuZChfZWZmZWN0LCBvcHRpb25zKTsKICAgICAgICAgIGlmIChvcHRpb25zLnNjb3BlKQogICAgICAgICAgICAgIHJlY29yZEVmZmVjdFNjb3BlKF9lZmZlY3QsIG9wdGlvbnMuc2NvcGUpOwogICAgICB9CiAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5sYXp5KSB7CiAgICAgICAgICBfZWZmZWN0LnJ1bigpOwogICAgICB9CiAgICAgIGNvbnN0IHJ1bm5lciA9IF9lZmZlY3QucnVuLmJpbmQoX2VmZmVjdCk7CiAgICAgIHJ1bm5lci5lZmZlY3QgPSBfZWZmZWN0OwogICAgICByZXR1cm4gcnVubmVyOwogIH0KICBmdW5jdGlvbiBzdG9wKHJ1bm5lcikgewogICAgICBydW5uZXIuZWZmZWN0LnN0b3AoKTsKICB9CiAgbGV0IHNob3VsZFRyYWNrID0gdHJ1ZTsKICBjb25zdCB0cmFja1N0YWNrID0gW107CiAgZnVuY3Rpb24gcGF1c2VUcmFja2luZygpIHsKICAgICAgdHJhY2tTdGFjay5wdXNoKHNob3VsZFRyYWNrKTsKICAgICAgc2hvdWxkVHJhY2sgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gcmVzZXRUcmFja2luZygpIHsKICAgICAgY29uc3QgbGFzdCA9IHRyYWNrU3RhY2sucG9wKCk7CiAgICAgIHNob3VsZFRyYWNrID0gbGFzdCA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGxhc3Q7CiAgfQogIGZ1bmN0aW9uIHRyYWNrKHRhcmdldCwgdHlwZSwga2V5KSB7CiAgICAgIGlmIChzaG91bGRUcmFjayAmJiBhY3RpdmVFZmZlY3QpIHsKICAgICAgICAgIGxldCBkZXBzTWFwID0gdGFyZ2V0TWFwLmdldCh0YXJnZXQpOwogICAgICAgICAgaWYgKCFkZXBzTWFwKSB7CiAgICAgICAgICAgICAgdGFyZ2V0TWFwLnNldCh0YXJnZXQsIChkZXBzTWFwID0gbmV3IE1hcCgpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgZGVwID0gZGVwc01hcC5nZXQoa2V5KTsKICAgICAgICAgIGlmICghZGVwKSB7CiAgICAgICAgICAgICAgZGVwc01hcC5zZXQoa2V5LCAoZGVwID0gY3JlYXRlRGVwKCkpKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGV2ZW50SW5mbyA9IHsgZWZmZWN0OiBhY3RpdmVFZmZlY3QsIHRhcmdldCwgdHlwZSwga2V5IH0KICAgICAgICAgICAgICA7CiAgICAgICAgICB0cmFja0VmZmVjdHMoZGVwLCBldmVudEluZm8pOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYWNrRWZmZWN0cyhkZXAsIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pIHsKICAgICAgbGV0IHNob3VsZFRyYWNrID0gZmFsc2U7CiAgICAgIGlmIChlZmZlY3RUcmFja0RlcHRoIDw9IG1heE1hcmtlckJpdHMpIHsKICAgICAgICAgIGlmICghbmV3VHJhY2tlZChkZXApKSB7CiAgICAgICAgICAgICAgZGVwLm4gfD0gdHJhY2tPcEJpdDsgLy8gc2V0IG5ld2x5IHRyYWNrZWQKICAgICAgICAgICAgICBzaG91bGRUcmFjayA9ICF3YXNUcmFja2VkKGRlcCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBGdWxsIGNsZWFudXAgbW9kZS4KICAgICAgICAgIHNob3VsZFRyYWNrID0gIWRlcC5oYXMoYWN0aXZlRWZmZWN0KTsKICAgICAgfQogICAgICBpZiAoc2hvdWxkVHJhY2spIHsKICAgICAgICAgIGRlcC5hZGQoYWN0aXZlRWZmZWN0KTsKICAgICAgICAgIGFjdGl2ZUVmZmVjdC5kZXBzLnB1c2goZGVwKTsKICAgICAgICAgIGlmIChhY3RpdmVFZmZlY3Qub25UcmFjaykgewogICAgICAgICAgICAgIGFjdGl2ZUVmZmVjdC5vblRyYWNrKE9iamVjdC5hc3NpZ24oeyBlZmZlY3Q6IGFjdGl2ZUVmZmVjdCB9LCBkZWJ1Z2dlckV2ZW50RXh0cmFJbmZvKSk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gdHJpZ2dlcih0YXJnZXQsIHR5cGUsIGtleSwgbmV3VmFsdWUsIG9sZFZhbHVlLCBvbGRUYXJnZXQpIHsKICAgICAgY29uc3QgZGVwc01hcCA9IHRhcmdldE1hcC5nZXQodGFyZ2V0KTsKICAgICAgaWYgKCFkZXBzTWFwKSB7CiAgICAgICAgICAvLyBuZXZlciBiZWVuIHRyYWNrZWQKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsZXQgZGVwcyA9IFtdOwogICAgICBpZiAodHlwZSA9PT0gImNsZWFyIiAvKiBDTEVBUiAqLykgewogICAgICAgICAgLy8gY29sbGVjdGlvbiBiZWluZyBjbGVhcmVkCiAgICAgICAgICAvLyB0cmlnZ2VyIGFsbCBlZmZlY3RzIGZvciB0YXJnZXQKICAgICAgICAgIGRlcHMgPSBbLi4uZGVwc01hcC52YWx1ZXMoKV07CiAgICAgIH0KICAgICAgZWxzZSBpZiAoa2V5ID09PSAnbGVuZ3RoJyAmJiBpc0FycmF5KHRhcmdldCkpIHsKICAgICAgICAgIGRlcHNNYXAuZm9yRWFjaCgoZGVwLCBrZXkpID0+IHsKICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnbGVuZ3RoJyB8fCBrZXkgPj0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgZGVwcy5wdXNoKGRlcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBzY2hlZHVsZSBydW5zIGZvciBTRVQgfCBBREQgfCBERUxFVEUKICAgICAgICAgIGlmIChrZXkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldChrZXkpKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGFsc28gcnVuIGZvciBpdGVyYXRpb24ga2V5IG9uIEFERCB8IERFTEVURSB8IE1hcC5TRVQKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgImFkZCIgLyogQUREICovOgogICAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgZGVwcy5wdXNoKGRlcHNNYXAuZ2V0KElURVJBVEVfS0VZKSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXAodGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldChNQVBfS0VZX0lURVJBVEVfS0VZKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNJbnRlZ2VyS2V5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBpbmRleCBhZGRlZCB0byBhcnJheSAtPiBsZW5ndGggY2hhbmdlcwogICAgICAgICAgICAgICAgICAgICAgZGVwcy5wdXNoKGRlcHNNYXAuZ2V0KCdsZW5ndGgnKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZGVsZXRlIiAvKiBERUxFVEUgKi86CiAgICAgICAgICAgICAgICAgIGlmICghaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZXBzLnB1c2goZGVwc01hcC5nZXQoSVRFUkFURV9LRVkpKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc01hcCh0YXJnZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwcy5wdXNoKGRlcHNNYXAuZ2V0KE1BUF9LRVlfSVRFUkFURV9LRVkpKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzZXQiIC8qIFNFVCAqLzoKICAgICAgICAgICAgICAgICAgaWYgKGlzTWFwKHRhcmdldCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldChJVEVSQVRFX0tFWSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGV2ZW50SW5mbyA9IHsgdGFyZ2V0LCB0eXBlLCBrZXksIG5ld1ZhbHVlLCBvbGRWYWx1ZSwgb2xkVGFyZ2V0IH0KICAgICAgICAgIDsKICAgICAgaWYgKGRlcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBpZiAoZGVwc1swXSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdHJpZ2dlckVmZmVjdHMoZGVwc1swXSwgZXZlbnRJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBjb25zdCBlZmZlY3RzID0gW107CiAgICAgICAgICBmb3IgKGNvbnN0IGRlcCBvZiBkZXBzKSB7CiAgICAgICAgICAgICAgaWYgKGRlcCkgewogICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goLi4uZGVwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgICAgdHJpZ2dlckVmZmVjdHMoY3JlYXRlRGVwKGVmZmVjdHMpLCBldmVudEluZm8pOwogICAgICAgICAgfQogICAgICB9CiAgfQogIGZ1bmN0aW9uIHRyaWdnZXJFZmZlY3RzKGRlcCwgZGVidWdnZXJFdmVudEV4dHJhSW5mbykgewogICAgICAvLyBzcHJlYWQgaW50byBhcnJheSBmb3Igc3RhYmlsaXphdGlvbgogICAgICBjb25zdCBlZmZlY3RzID0gaXNBcnJheShkZXApID8gZGVwIDogWy4uLmRlcF07CiAgICAgIGZvciAoY29uc3QgZWZmZWN0IG9mIGVmZmVjdHMpIHsKICAgICAgICAgIGlmIChlZmZlY3QuY29tcHV0ZWQpIHsKICAgICAgICAgICAgICB0cmlnZ2VyRWZmZWN0KGVmZmVjdCwgZGVidWdnZXJFdmVudEV4dHJhSW5mbyk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBlZmZlY3Qgb2YgZWZmZWN0cykgewogICAgICAgICAgaWYgKCFlZmZlY3QuY29tcHV0ZWQpIHsKICAgICAgICAgICAgICB0cmlnZ2VyRWZmZWN0KGVmZmVjdCwgZGVidWdnZXJFdmVudEV4dHJhSW5mbyk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gdHJpZ2dlckVmZmVjdChlZmZlY3QsIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pIHsKICAgICAgaWYgKGVmZmVjdCAhPT0gYWN0aXZlRWZmZWN0IHx8IGVmZmVjdC5hbGxvd1JlY3Vyc2UpIHsKICAgICAgICAgIGlmIChlZmZlY3Qub25UcmlnZ2VyKSB7CiAgICAgICAgICAgICAgZWZmZWN0Lm9uVHJpZ2dlcihleHRlbmQoeyBlZmZlY3QgfSwgZGVidWdnZXJFdmVudEV4dHJhSW5mbykpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVmZmVjdC5zY2hlZHVsZXIpIHsKICAgICAgICAgICAgICBlZmZlY3Quc2NoZWR1bGVyKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBlZmZlY3QucnVuKCk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CgogIGNvbnN0IGlzTm9uVHJhY2thYmxlS2V5cyA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcChgX19wcm90b19fLF9fdl9pc1JlZixfX2lzVnVlYCk7CiAgY29uc3QgYnVpbHRJblN5bWJvbHMgPSBuZXcgU2V0KAogIC8qI19fUFVSRV9fKi8KICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhTeW1ib2wpCiAgICAgIC8vIGlvczEwLnggT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoU3ltYm9sKSBjYW4gZW51bWVyYXRlICdhcmd1bWVudHMnIGFuZCAnY2FsbGVyJwogICAgICAvLyBidXQgYWNjZXNzaW5nIHRoZW0gb24gU3ltYm9sIGxlYWRzIHRvIFR5cGVFcnJvciBiZWNhdXNlIFN5bWJvbCBpcyBhIHN0cmljdCBtb2RlCiAgICAgIC8vIGZ1bmN0aW9uCiAgICAgIC5maWx0ZXIoa2V5ID0+IGtleSAhPT0gJ2FyZ3VtZW50cycgJiYga2V5ICE9PSAnY2FsbGVyJykKICAgICAgLm1hcChrZXkgPT4gU3ltYm9sW2tleV0pCiAgICAgIC5maWx0ZXIoaXNTeW1ib2wpKTsKICBjb25zdCBnZXQgPSAvKiNfX1BVUkVfXyovIGNyZWF0ZUdldHRlcigpOwogIGNvbnN0IHNoYWxsb3dHZXQgPSAvKiNfX1BVUkVfXyovIGNyZWF0ZUdldHRlcihmYWxzZSwgdHJ1ZSk7CiAgY29uc3QgcmVhZG9ubHlHZXQgPSAvKiNfX1BVUkVfXyovIGNyZWF0ZUdldHRlcih0cnVlKTsKICBjb25zdCBzaGFsbG93UmVhZG9ubHlHZXQgPSAvKiNfX1BVUkVfXyovIGNyZWF0ZUdldHRlcih0cnVlLCB0cnVlKTsKICBjb25zdCBhcnJheUluc3RydW1lbnRhdGlvbnMgPSAvKiNfX1BVUkVfXyovIGNyZWF0ZUFycmF5SW5zdHJ1bWVudGF0aW9ucygpOwogIGZ1bmN0aW9uIGNyZWF0ZUFycmF5SW5zdHJ1bWVudGF0aW9ucygpIHsKICAgICAgY29uc3QgaW5zdHJ1bWVudGF0aW9ucyA9IHt9OwogICAgICBbJ2luY2x1ZGVzJywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnXS5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICBpbnN0cnVtZW50YXRpb25zW2tleV0gPSBmdW5jdGlvbiAoLi4uYXJncykgewogICAgICAgICAgICAgIGNvbnN0IGFyciA9IHRvUmF3KHRoaXMpOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdHJhY2soYXJyLCAiZ2V0IiAvKiBHRVQgKi8sIGkgKyAnJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHdlIHJ1biB0aGUgbWV0aG9kIHVzaW5nIHRoZSBvcmlnaW5hbCBhcmdzIGZpcnN0ICh3aGljaCBtYXkgYmUgcmVhY3RpdmUpCiAgICAgICAgICAgICAgY29uc3QgcmVzID0gYXJyW2tleV0oLi4uYXJncyk7CiAgICAgICAgICAgICAgaWYgKHJlcyA9PT0gLTEgfHwgcmVzID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAvLyBpZiB0aGF0IGRpZG4ndCB3b3JrLCBydW4gaXQgYWdhaW4gdXNpbmcgcmF3IHZhbHVlcy4KICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycltrZXldKC4uLmFyZ3MubWFwKHRvUmF3KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgIH0pOwogICAgICBbJ3B1c2gnLCAncG9wJywgJ3NoaWZ0JywgJ3Vuc2hpZnQnLCAnc3BsaWNlJ10uZm9yRWFjaChrZXkgPT4gewogICAgICAgICAgaW5zdHJ1bWVudGF0aW9uc1trZXldID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHsKICAgICAgICAgICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgICAgICAgICAgY29uc3QgcmVzID0gdG9SYXcodGhpcylba2V5XS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICAgIH07CiAgICAgIH0pOwogICAgICByZXR1cm4gaW5zdHJ1bWVudGF0aW9uczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlR2V0dGVyKGlzUmVhZG9ubHkgPSBmYWxzZSwgc2hhbGxvdyA9IGZhbHNlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBnZXQodGFyZ2V0LCBrZXksIHJlY2VpdmVyKSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAiX192X2lzUmVhY3RpdmUiIC8qIElTX1JFQUNUSVZFICovKSB7CiAgICAgICAgICAgICAgcmV0dXJuICFpc1JlYWRvbmx5OwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAiX192X2lzUmVhZG9ubHkiIC8qIElTX1JFQURPTkxZICovKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGlzUmVhZG9ubHk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICJfX3ZfaXNTaGFsbG93IiAvKiBJU19TSEFMTE9XICovKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNoYWxsb3c7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICJfX3ZfcmF3IiAvKiBSQVcgKi8gJiYKICAgICAgICAgICAgICByZWNlaXZlciA9PT0KICAgICAgICAgICAgICAgICAgKGlzUmVhZG9ubHkKICAgICAgICAgICAgICAgICAgICAgID8gc2hhbGxvdwogICAgICAgICAgICAgICAgICAgICAgICAgID8gc2hhbGxvd1JlYWRvbmx5TWFwCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiByZWFkb25seU1hcAogICAgICAgICAgICAgICAgICAgICAgOiBzaGFsbG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBzaGFsbG93UmVhY3RpdmVNYXAKICAgICAgICAgICAgICAgICAgICAgICAgICA6IHJlYWN0aXZlTWFwKS5nZXQodGFyZ2V0KSkgewogICAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0YXJnZXRJc0FycmF5ID0gaXNBcnJheSh0YXJnZXQpOwogICAgICAgICAgaWYgKCFpc1JlYWRvbmx5ICYmIHRhcmdldElzQXJyYXkgJiYgaGFzT3duKGFycmF5SW5zdHJ1bWVudGF0aW9ucywga2V5KSkgewogICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldChhcnJheUluc3RydW1lbnRhdGlvbnMsIGtleSwgcmVjZWl2ZXIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBrZXksIHJlY2VpdmVyKTsKICAgICAgICAgIGlmIChpc1N5bWJvbChrZXkpID8gYnVpbHRJblN5bWJvbHMuaGFzKGtleSkgOiBpc05vblRyYWNrYWJsZUtleXMoa2V5KSkgewogICAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzUmVhZG9ubHkpIHsKICAgICAgICAgICAgICB0cmFjayh0YXJnZXQsICJnZXQiIC8qIEdFVCAqLywga2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaGFsbG93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1JlZihyZXMpKSB7CiAgICAgICAgICAgICAgLy8gcmVmIHVud3JhcHBpbmcgLSBza2lwIHVud3JhcCBmb3IgQXJyYXkgKyBpbnRlZ2VyIGtleS4KICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0SXNBcnJheSAmJiBpc0ludGVnZXJLZXkoa2V5KSA/IHJlcyA6IHJlcy52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc09iamVjdChyZXMpKSB7CiAgICAgICAgICAgICAgLy8gQ29udmVydCByZXR1cm5lZCB2YWx1ZSBpbnRvIGEgcHJveHkgYXMgd2VsbC4gd2UgZG8gdGhlIGlzT2JqZWN0IGNoZWNrCiAgICAgICAgICAgICAgLy8gaGVyZSB0byBhdm9pZCBpbnZhbGlkIHZhbHVlIHdhcm5pbmcuIEFsc28gbmVlZCB0byBsYXp5IGFjY2VzcyByZWFkb25seQogICAgICAgICAgICAgIC8vIGFuZCByZWFjdGl2ZSBoZXJlIHRvIGF2b2lkIGNpcmN1bGFyIGRlcGVuZGVuY3kuCiAgICAgICAgICAgICAgcmV0dXJuIGlzUmVhZG9ubHkgPyByZWFkb25seShyZXMpIDogcmVhY3RpdmUocmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXM7CiAgICAgIH07CiAgfQogIGNvbnN0IHNldCA9IC8qI19fUFVSRV9fKi8gY3JlYXRlU2V0dGVyKCk7CiAgY29uc3Qgc2hhbGxvd1NldCA9IC8qI19fUFVSRV9fKi8gY3JlYXRlU2V0dGVyKHRydWUpOwogIGZ1bmN0aW9uIGNyZWF0ZVNldHRlcihzaGFsbG93ID0gZmFsc2UpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNldCh0YXJnZXQsIGtleSwgdmFsdWUsIHJlY2VpdmVyKSB7CiAgICAgICAgICBsZXQgb2xkVmFsdWUgPSB0YXJnZXRba2V5XTsKICAgICAgICAgIGlmIChpc1JlYWRvbmx5KG9sZFZhbHVlKSAmJiBpc1JlZihvbGRWYWx1ZSkgJiYgIWlzUmVmKHZhbHVlKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghc2hhbGxvdyAmJiAhaXNSZWFkb25seSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBpZiAoIWlzU2hhbGxvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSB0b1Jhdyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gdG9SYXcob2xkVmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodGFyZ2V0KSAmJiBpc1JlZihvbGRWYWx1ZSkgJiYgIWlzUmVmKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBoYWRLZXkgPSBpc0FycmF5KHRhcmdldCkgJiYgaXNJbnRlZ2VyS2V5KGtleSkKICAgICAgICAgICAgICA/IE51bWJlcihrZXkpIDwgdGFyZ2V0Lmxlbmd0aAogICAgICAgICAgICAgIDogaGFzT3duKHRhcmdldCwga2V5KTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3Quc2V0KHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpOwogICAgICAgICAgLy8gZG9uJ3QgdHJpZ2dlciBpZiB0YXJnZXQgaXMgc29tZXRoaW5nIHVwIGluIHRoZSBwcm90b3R5cGUgY2hhaW4gb2Ygb3JpZ2luYWwKICAgICAgICAgIGlmICh0YXJnZXQgPT09IHRvUmF3KHJlY2VpdmVyKSkgewogICAgICAgICAgICAgIGlmICghaGFkS2V5KSB7CiAgICAgICAgICAgICAgICAgIHRyaWdnZXIodGFyZ2V0LCAiYWRkIiAvKiBBREQgKi8sIGtleSwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChoYXNDaGFuZ2VkKHZhbHVlLCBvbGRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJzZXQiIC8qIFNFVCAqLywga2V5LCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwga2V5KSB7CiAgICAgIGNvbnN0IGhhZEtleSA9IGhhc093bih0YXJnZXQsIGtleSk7CiAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGFyZ2V0W2tleV07CiAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3QuZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBrZXkpOwogICAgICBpZiAocmVzdWx0ICYmIGhhZEtleSkgewogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJkZWxldGUiIC8qIERFTEVURSAqLywga2V5LCB1bmRlZmluZWQsIG9sZFZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBoYXModGFyZ2V0LCBrZXkpIHsKICAgICAgY29uc3QgcmVzdWx0ID0gUmVmbGVjdC5oYXModGFyZ2V0LCBrZXkpOwogICAgICBpZiAoIWlzU3ltYm9sKGtleSkgfHwgIWJ1aWx0SW5TeW1ib2xzLmhhcyhrZXkpKSB7CiAgICAgICAgICB0cmFjayh0YXJnZXQsICJoYXMiIC8qIEhBUyAqLywga2V5KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBvd25LZXlzKHRhcmdldCkgewogICAgICB0cmFjayh0YXJnZXQsICJpdGVyYXRlIiAvKiBJVEVSQVRFICovLCBpc0FycmF5KHRhcmdldCkgPyAnbGVuZ3RoJyA6IElURVJBVEVfS0VZKTsKICAgICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpOwogIH0KICBjb25zdCBtdXRhYmxlSGFuZGxlcnMgPSB7CiAgICAgIGdldCwKICAgICAgc2V0LAogICAgICBkZWxldGVQcm9wZXJ0eSwKICAgICAgaGFzLAogICAgICBvd25LZXlzCiAgfTsKICBjb25zdCByZWFkb25seUhhbmRsZXJzID0gewogICAgICBnZXQ6IHJlYWRvbmx5R2V0LAogICAgICBzZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuKGBTZXQgb3BlcmF0aW9uIG9uIGtleSAiJHtTdHJpbmcoa2V5KX0iIGZhaWxlZDogdGFyZ2V0IGlzIHJlYWRvbmx5LmAsIHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuKGBEZWxldGUgb3BlcmF0aW9uIG9uIGtleSAiJHtTdHJpbmcoa2V5KX0iIGZhaWxlZDogdGFyZ2V0IGlzIHJlYWRvbmx5LmAsIHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogIH07CiAgY29uc3Qgc2hhbGxvd1JlYWN0aXZlSGFuZGxlcnMgPSAvKiNfX1BVUkVfXyovIGV4dGVuZCh7fSwgbXV0YWJsZUhhbmRsZXJzLCB7CiAgICAgIGdldDogc2hhbGxvd0dldCwKICAgICAgc2V0OiBzaGFsbG93U2V0CiAgfSk7CiAgLy8gUHJvcHMgaGFuZGxlcnMgYXJlIHNwZWNpYWwgaW4gdGhlIHNlbnNlIHRoYXQgaXQgc2hvdWxkIG5vdCB1bndyYXAgdG9wLWxldmVsCiAgLy8gcmVmcyAoaW4gb3JkZXIgdG8gYWxsb3cgcmVmcyB0byBiZSBleHBsaWNpdGx5IHBhc3NlZCBkb3duKSwgYnV0IHNob3VsZAogIC8vIHJldGFpbiB0aGUgcmVhY3Rpdml0eSBvZiB0aGUgbm9ybWFsIHJlYWRvbmx5IG9iamVjdC4KICBjb25zdCBzaGFsbG93UmVhZG9ubHlIYW5kbGVycyA9IC8qI19fUFVSRV9fKi8gZXh0ZW5kKHt9LCByZWFkb25seUhhbmRsZXJzLCB7CiAgICAgIGdldDogc2hhbGxvd1JlYWRvbmx5R2V0CiAgfSk7CgogIGNvbnN0IHRvU2hhbGxvdyA9ICh2YWx1ZSkgPT4gdmFsdWU7CiAgY29uc3QgZ2V0UHJvdG8gPSAodikgPT4gUmVmbGVjdC5nZXRQcm90b3R5cGVPZih2KTsKICBmdW5jdGlvbiBnZXQkMSh0YXJnZXQsIGtleSwgaXNSZWFkb25seSA9IGZhbHNlLCBpc1NoYWxsb3cgPSBmYWxzZSkgewogICAgICAvLyAjMTc3MjogcmVhZG9ubHkocmVhY3RpdmUoTWFwKSkgc2hvdWxkIHJldHVybiByZWFkb25seSArIHJlYWN0aXZlIHZlcnNpb24KICAgICAgLy8gb2YgdGhlIHZhbHVlCiAgICAgIHRhcmdldCA9IHRhcmdldFsiX192X3JhdyIgLyogUkFXICovXTsKICAgICAgY29uc3QgcmF3VGFyZ2V0ID0gdG9SYXcodGFyZ2V0KTsKICAgICAgY29uc3QgcmF3S2V5ID0gdG9SYXcoa2V5KTsKICAgICAgaWYgKCFpc1JlYWRvbmx5KSB7CiAgICAgICAgICBpZiAoa2V5ICE9PSByYXdLZXkpIHsKICAgICAgICAgICAgICB0cmFjayhyYXdUYXJnZXQsICJnZXQiIC8qIEdFVCAqLywga2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIHRyYWNrKHJhd1RhcmdldCwgImdldCIgLyogR0VUICovLCByYXdLZXkpOwogICAgICB9CiAgICAgIGNvbnN0IHsgaGFzIH0gPSBnZXRQcm90byhyYXdUYXJnZXQpOwogICAgICBjb25zdCB3cmFwID0gaXNTaGFsbG93ID8gdG9TaGFsbG93IDogaXNSZWFkb25seSA/IHRvUmVhZG9ubHkgOiB0b1JlYWN0aXZlOwogICAgICBpZiAoaGFzLmNhbGwocmF3VGFyZ2V0LCBrZXkpKSB7CiAgICAgICAgICByZXR1cm4gd3JhcCh0YXJnZXQuZ2V0KGtleSkpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGhhcy5jYWxsKHJhd1RhcmdldCwgcmF3S2V5KSkgewogICAgICAgICAgcmV0dXJuIHdyYXAodGFyZ2V0LmdldChyYXdLZXkpKTsKICAgICAgfQogICAgICBlbHNlIGlmICh0YXJnZXQgIT09IHJhd1RhcmdldCkgewogICAgICAgICAgLy8gIzM2MDIgcmVhZG9ubHkocmVhY3RpdmUoTWFwKSkKICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZSBuZXN0ZWQgcmVhY3RpdmUgYE1hcGAgY2FuIGRvIHRyYWNraW5nIGZvciBpdHNlbGYKICAgICAgICAgIHRhcmdldC5nZXQoa2V5KTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBoYXMkMShrZXksIGlzUmVhZG9ubHkgPSBmYWxzZSkgewogICAgICBjb25zdCB0YXJnZXQgPSB0aGlzWyJfX3ZfcmF3IiAvKiBSQVcgKi9dOwogICAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgICBjb25zdCByYXdLZXkgPSB0b1JhdyhrZXkpOwogICAgICBpZiAoIWlzUmVhZG9ubHkpIHsKICAgICAgICAgIGlmIChrZXkgIT09IHJhd0tleSkgewogICAgICAgICAgICAgIHRyYWNrKHJhd1RhcmdldCwgImhhcyIgLyogSEFTICovLCBrZXkpOwogICAgICAgICAgfQogICAgICAgICAgdHJhY2socmF3VGFyZ2V0LCAiaGFzIiAvKiBIQVMgKi8sIHJhd0tleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGtleSA9PT0gcmF3S2V5CiAgICAgICAgICA/IHRhcmdldC5oYXMoa2V5KQogICAgICAgICAgOiB0YXJnZXQuaGFzKGtleSkgfHwgdGFyZ2V0LmhhcyhyYXdLZXkpOwogIH0KICBmdW5jdGlvbiBzaXplKHRhcmdldCwgaXNSZWFkb25seSA9IGZhbHNlKSB7CiAgICAgIHRhcmdldCA9IHRhcmdldFsiX192X3JhdyIgLyogUkFXICovXTsKICAgICAgIWlzUmVhZG9ubHkgJiYgdHJhY2sodG9SYXcodGFyZ2V0KSwgIml0ZXJhdGUiIC8qIElURVJBVEUgKi8sIElURVJBVEVfS0VZKTsKICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgJ3NpemUnLCB0YXJnZXQpOwogIH0KICBmdW5jdGlvbiBhZGQodmFsdWUpIHsKICAgICAgdmFsdWUgPSB0b1Jhdyh2YWx1ZSk7CiAgICAgIGNvbnN0IHRhcmdldCA9IHRvUmF3KHRoaXMpOwogICAgICBjb25zdCBwcm90byA9IGdldFByb3RvKHRhcmdldCk7CiAgICAgIGNvbnN0IGhhZEtleSA9IHByb3RvLmhhcy5jYWxsKHRhcmdldCwgdmFsdWUpOwogICAgICBpZiAoIWhhZEtleSkgewogICAgICAgICAgdGFyZ2V0LmFkZCh2YWx1ZSk7CiAgICAgICAgICB0cmlnZ2VyKHRhcmdldCwgImFkZCIgLyogQUREICovLCB2YWx1ZSwgdmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogIH0KICBmdW5jdGlvbiBzZXQkMShrZXksIHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdG9SYXcodmFsdWUpOwogICAgICBjb25zdCB0YXJnZXQgPSB0b1Jhdyh0aGlzKTsKICAgICAgY29uc3QgeyBoYXMsIGdldCB9ID0gZ2V0UHJvdG8odGFyZ2V0KTsKICAgICAgbGV0IGhhZEtleSA9IGhhcy5jYWxsKHRhcmdldCwga2V5KTsKICAgICAgaWYgKCFoYWRLZXkpIHsKICAgICAgICAgIGtleSA9IHRvUmF3KGtleSk7CiAgICAgICAgICBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBjaGVja0lkZW50aXR5S2V5cyh0YXJnZXQsIGhhcywga2V5KTsKICAgICAgfQogICAgICBjb25zdCBvbGRWYWx1ZSA9IGdldC5jYWxsKHRhcmdldCwga2V5KTsKICAgICAgdGFyZ2V0LnNldChrZXksIHZhbHVlKTsKICAgICAgaWYgKCFoYWRLZXkpIHsKICAgICAgICAgIHRyaWdnZXIodGFyZ2V0LCAiYWRkIiAvKiBBREQgKi8sIGtleSwgdmFsdWUpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGhhc0NoYW5nZWQodmFsdWUsIG9sZFZhbHVlKSkgewogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJzZXQiIC8qIFNFVCAqLywga2V5LCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogIH0KICBmdW5jdGlvbiBkZWxldGVFbnRyeShrZXkpIHsKICAgICAgY29uc3QgdGFyZ2V0ID0gdG9SYXcodGhpcyk7CiAgICAgIGNvbnN0IHsgaGFzLCBnZXQgfSA9IGdldFByb3RvKHRhcmdldCk7CiAgICAgIGxldCBoYWRLZXkgPSBoYXMuY2FsbCh0YXJnZXQsIGtleSk7CiAgICAgIGlmICghaGFkS2V5KSB7CiAgICAgICAgICBrZXkgPSB0b1JhdyhrZXkpOwogICAgICAgICAgaGFkS2V5ID0gaGFzLmNhbGwodGFyZ2V0LCBrZXkpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY2hlY2tJZGVudGl0eUtleXModGFyZ2V0LCBoYXMsIGtleSk7CiAgICAgIH0KICAgICAgY29uc3Qgb2xkVmFsdWUgPSBnZXQgPyBnZXQuY2FsbCh0YXJnZXQsIGtleSkgOiB1bmRlZmluZWQ7CiAgICAgIC8vIGZvcndhcmQgdGhlIG9wZXJhdGlvbiBiZWZvcmUgcXVldWVpbmcgcmVhY3Rpb25zCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRhcmdldC5kZWxldGUoa2V5KTsKICAgICAgaWYgKGhhZEtleSkgewogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJkZWxldGUiIC8qIERFTEVURSAqLywga2V5LCB1bmRlZmluZWQsIG9sZFZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgY29uc3QgdGFyZ2V0ID0gdG9SYXcodGhpcyk7CiAgICAgIGNvbnN0IGhhZEl0ZW1zID0gdGFyZ2V0LnNpemUgIT09IDA7CiAgICAgIGNvbnN0IG9sZFRhcmdldCA9IGlzTWFwKHRhcmdldCkKICAgICAgICAgICAgICA/IG5ldyBNYXAodGFyZ2V0KQogICAgICAgICAgICAgIDogbmV3IFNldCh0YXJnZXQpCiAgICAgICAgICA7CiAgICAgIC8vIGZvcndhcmQgdGhlIG9wZXJhdGlvbiBiZWZvcmUgcXVldWVpbmcgcmVhY3Rpb25zCiAgICAgIGNvbnN0IHJlc3VsdCA9IHRhcmdldC5jbGVhcigpOwogICAgICBpZiAoaGFkSXRlbXMpIHsKICAgICAgICAgIHRyaWdnZXIodGFyZ2V0LCAiY2xlYXIiIC8qIENMRUFSICovLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgb2xkVGFyZ2V0KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjcmVhdGVGb3JFYWNoKGlzUmVhZG9ubHksIGlzU2hhbGxvdykgewogICAgICByZXR1cm4gZnVuY3Rpb24gZm9yRWFjaChjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgICAgY29uc3Qgb2JzZXJ2ZWQgPSB0aGlzOwogICAgICAgICAgY29uc3QgdGFyZ2V0ID0gb2JzZXJ2ZWRbIl9fdl9yYXciIC8qIFJBVyAqL107CiAgICAgICAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgICAgICAgY29uc3Qgd3JhcCA9IGlzU2hhbGxvdyA/IHRvU2hhbGxvdyA6IGlzUmVhZG9ubHkgPyB0b1JlYWRvbmx5IDogdG9SZWFjdGl2ZTsKICAgICAgICAgICFpc1JlYWRvbmx5ICYmIHRyYWNrKHJhd1RhcmdldCwgIml0ZXJhdGUiIC8qIElURVJBVEUgKi8sIElURVJBVEVfS0VZKTsKICAgICAgICAgIHJldHVybiB0YXJnZXQuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gewogICAgICAgICAgICAgIC8vIGltcG9ydGFudDogbWFrZSBzdXJlIHRoZSBjYWxsYmFjayBpcwogICAgICAgICAgICAgIC8vIDEuIGludm9rZWQgd2l0aCB0aGUgcmVhY3RpdmUgbWFwIGFzIGB0aGlzYCBhbmQgM3JkIGFyZwogICAgICAgICAgICAgIC8vIDIuIHRoZSB2YWx1ZSByZWNlaXZlZCBzaG91bGQgYmUgYSBjb3JyZXNwb25kaW5nIHJlYWN0aXZlL3JlYWRvbmx5LgogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXNBcmcsIHdyYXAodmFsdWUpLCB3cmFwKGtleSksIG9ic2VydmVkKTsKICAgICAgICAgIH0pOwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVJdGVyYWJsZU1ldGhvZChtZXRob2QsIGlzUmVhZG9ubHksIGlzU2hhbGxvdykgewogICAgICByZXR1cm4gZnVuY3Rpb24gKC4uLmFyZ3MpIHsKICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXNbIl9fdl9yYXciIC8qIFJBVyAqL107CiAgICAgICAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgICAgICAgY29uc3QgdGFyZ2V0SXNNYXAgPSBpc01hcChyYXdUYXJnZXQpOwogICAgICAgICAgY29uc3QgaXNQYWlyID0gbWV0aG9kID09PSAnZW50cmllcycgfHwgKG1ldGhvZCA9PT0gU3ltYm9sLml0ZXJhdG9yICYmIHRhcmdldElzTWFwKTsKICAgICAgICAgIGNvbnN0IGlzS2V5T25seSA9IG1ldGhvZCA9PT0gJ2tleXMnICYmIHRhcmdldElzTWFwOwogICAgICAgICAgY29uc3QgaW5uZXJJdGVyYXRvciA9IHRhcmdldFttZXRob2RdKC4uLmFyZ3MpOwogICAgICAgICAgY29uc3Qgd3JhcCA9IGlzU2hhbGxvdyA/IHRvU2hhbGxvdyA6IGlzUmVhZG9ubHkgPyB0b1JlYWRvbmx5IDogdG9SZWFjdGl2ZTsKICAgICAgICAgICFpc1JlYWRvbmx5ICYmCiAgICAgICAgICAgICAgdHJhY2socmF3VGFyZ2V0LCAiaXRlcmF0ZSIgLyogSVRFUkFURSAqLywgaXNLZXlPbmx5ID8gTUFQX0tFWV9JVEVSQVRFX0tFWSA6IElURVJBVEVfS0VZKTsKICAgICAgICAgIC8vIHJldHVybiBhIHdyYXBwZWQgaXRlcmF0b3Igd2hpY2ggcmV0dXJucyBvYnNlcnZlZCB2ZXJzaW9ucyBvZiB0aGUKICAgICAgICAgIC8vIHZhbHVlcyBlbWl0dGVkIGZyb20gdGhlIHJlYWwgaXRlcmF0b3IKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgLy8gaXRlcmF0b3IgcHJvdG9jb2wKICAgICAgICAgICAgICBuZXh0KCkgewogICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlLCBkb25lIH0gPSBpbm5lckl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUKICAgICAgICAgICAgICAgICAgICAgID8geyB2YWx1ZSwgZG9uZSB9CiAgICAgICAgICAgICAgICAgICAgICA6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaXNQYWlyID8gW3dyYXAodmFsdWVbMF0pLCB3cmFwKHZhbHVlWzFdKV0gOiB3cmFwKHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lCiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgLy8gaXRlcmFibGUgcHJvdG9jb2wKICAgICAgICAgICAgICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUmVhZG9ubHlNZXRob2QodHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKC4uLmFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICBjb25zdCBrZXkgPSBhcmdzWzBdID8gYG9uIGtleSAiJHthcmdzWzBdfSIgYCA6IGBgOwogICAgICAgICAgICAgIGNvbnNvbGUud2FybihgJHtjYXBpdGFsaXplKHR5cGUpfSBvcGVyYXRpb24gJHtrZXl9ZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuYCwgdG9SYXcodGhpcykpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHR5cGUgPT09ICJkZWxldGUiIC8qIERFTEVURSAqLyA/IGZhbHNlIDogdGhpczsKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlSW5zdHJ1bWVudGF0aW9ucygpIHsKICAgICAgY29uc3QgbXV0YWJsZUluc3RydW1lbnRhdGlvbnMgPSB7CiAgICAgICAgICBnZXQoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldCQxKHRoaXMsIGtleSk7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0IHNpemUoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNpemUodGhpcyk7CiAgICAgICAgICB9LAogICAgICAgICAgaGFzOiBoYXMkMSwKICAgICAgICAgIGFkZCwKICAgICAgICAgIHNldDogc2V0JDEsCiAgICAgICAgICBkZWxldGU6IGRlbGV0ZUVudHJ5LAogICAgICAgICAgY2xlYXIsCiAgICAgICAgICBmb3JFYWNoOiBjcmVhdGVGb3JFYWNoKGZhbHNlLCBmYWxzZSkKICAgICAgfTsKICAgICAgY29uc3Qgc2hhbGxvd0luc3RydW1lbnRhdGlvbnMgPSB7CiAgICAgICAgICBnZXQoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldCQxKHRoaXMsIGtleSwgZmFsc2UsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldCBzaXplKCkgewogICAgICAgICAgICAgIHJldHVybiBzaXplKHRoaXMpOwogICAgICAgICAgfSwKICAgICAgICAgIGhhczogaGFzJDEsCiAgICAgICAgICBhZGQsCiAgICAgICAgICBzZXQ6IHNldCQxLAogICAgICAgICAgZGVsZXRlOiBkZWxldGVFbnRyeSwKICAgICAgICAgIGNsZWFyLAogICAgICAgICAgZm9yRWFjaDogY3JlYXRlRm9yRWFjaChmYWxzZSwgdHJ1ZSkKICAgICAgfTsKICAgICAgY29uc3QgcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zID0gewogICAgICAgICAgZ2V0KGtleSkgewogICAgICAgICAgICAgIHJldHVybiBnZXQkMSh0aGlzLCBrZXksIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldCBzaXplKCkgewogICAgICAgICAgICAgIHJldHVybiBzaXplKHRoaXMsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGhhcyhrZXkpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFzJDEuY2FsbCh0aGlzLCBrZXksIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIGFkZDogY3JlYXRlUmVhZG9ubHlNZXRob2QoImFkZCIgLyogQUREICovKSwKICAgICAgICAgIHNldDogY3JlYXRlUmVhZG9ubHlNZXRob2QoInNldCIgLyogU0VUICovKSwKICAgICAgICAgIGRlbGV0ZTogY3JlYXRlUmVhZG9ubHlNZXRob2QoImRlbGV0ZSIgLyogREVMRVRFICovKSwKICAgICAgICAgIGNsZWFyOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiY2xlYXIiIC8qIENMRUFSICovKSwKICAgICAgICAgIGZvckVhY2g6IGNyZWF0ZUZvckVhY2godHJ1ZSwgZmFsc2UpCiAgICAgIH07CiAgICAgIGNvbnN0IHNoYWxsb3dSZWFkb25seUluc3RydW1lbnRhdGlvbnMgPSB7CiAgICAgICAgICBnZXQoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldCQxKHRoaXMsIGtleSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0IHNpemUoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNpemUodGhpcywgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgaGFzKGtleSkgewogICAgICAgICAgICAgIHJldHVybiBoYXMkMS5jYWxsKHRoaXMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgYWRkOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiYWRkIiAvKiBBREQgKi8pLAogICAgICAgICAgc2V0OiBjcmVhdGVSZWFkb25seU1ldGhvZCgic2V0IiAvKiBTRVQgKi8pLAogICAgICAgICAgZGVsZXRlOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiZGVsZXRlIiAvKiBERUxFVEUgKi8pLAogICAgICAgICAgY2xlYXI6IGNyZWF0ZVJlYWRvbmx5TWV0aG9kKCJjbGVhciIgLyogQ0xFQVIgKi8pLAogICAgICAgICAgZm9yRWFjaDogY3JlYXRlRm9yRWFjaCh0cnVlLCB0cnVlKQogICAgICB9OwogICAgICBjb25zdCBpdGVyYXRvck1ldGhvZHMgPSBbJ2tleXMnLCAndmFsdWVzJywgJ2VudHJpZXMnLCBTeW1ib2wuaXRlcmF0b3JdOwogICAgICBpdGVyYXRvck1ldGhvZHMuZm9yRWFjaChtZXRob2QgPT4gewogICAgICAgICAgbXV0YWJsZUluc3RydW1lbnRhdGlvbnNbbWV0aG9kXSA9IGNyZWF0ZUl0ZXJhYmxlTWV0aG9kKG1ldGhvZCwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgIHJlYWRvbmx5SW5zdHJ1bWVudGF0aW9uc1ttZXRob2RdID0gY3JlYXRlSXRlcmFibGVNZXRob2QobWV0aG9kLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICBzaGFsbG93SW5zdHJ1bWVudGF0aW9uc1ttZXRob2RdID0gY3JlYXRlSXRlcmFibGVNZXRob2QobWV0aG9kLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICBzaGFsbG93UmVhZG9ubHlJbnN0cnVtZW50YXRpb25zW21ldGhvZF0gPSBjcmVhdGVJdGVyYWJsZU1ldGhvZChtZXRob2QsIHRydWUsIHRydWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIFsKICAgICAgICAgIG11dGFibGVJbnN0cnVtZW50YXRpb25zLAogICAgICAgICAgcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zLAogICAgICAgICAgc2hhbGxvd0luc3RydW1lbnRhdGlvbnMsCiAgICAgICAgICBzaGFsbG93UmVhZG9ubHlJbnN0cnVtZW50YXRpb25zCiAgICAgIF07CiAgfQogIGNvbnN0IFttdXRhYmxlSW5zdHJ1bWVudGF0aW9ucywgcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zLCBzaGFsbG93SW5zdHJ1bWVudGF0aW9ucywgc2hhbGxvd1JlYWRvbmx5SW5zdHJ1bWVudGF0aW9uc10gPSAvKiAjX19QVVJFX18qLyBjcmVhdGVJbnN0cnVtZW50YXRpb25zKCk7CiAgZnVuY3Rpb24gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKGlzUmVhZG9ubHksIHNoYWxsb3cpIHsKICAgICAgY29uc3QgaW5zdHJ1bWVudGF0aW9ucyA9IHNoYWxsb3cKICAgICAgICAgID8gaXNSZWFkb25seQogICAgICAgICAgICAgID8gc2hhbGxvd1JlYWRvbmx5SW5zdHJ1bWVudGF0aW9ucwogICAgICAgICAgICAgIDogc2hhbGxvd0luc3RydW1lbnRhdGlvbnMKICAgICAgICAgIDogaXNSZWFkb25seQogICAgICAgICAgICAgID8gcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zCiAgICAgICAgICAgICAgOiBtdXRhYmxlSW5zdHJ1bWVudGF0aW9uczsKICAgICAgcmV0dXJuICh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpID0+IHsKICAgICAgICAgIGlmIChrZXkgPT09ICJfX3ZfaXNSZWFjdGl2ZSIgLyogSVNfUkVBQ1RJVkUgKi8pIHsKICAgICAgICAgICAgICByZXR1cm4gIWlzUmVhZG9ubHk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICJfX3ZfaXNSZWFkb25seSIgLyogSVNfUkVBRE9OTFkgKi8pIHsKICAgICAgICAgICAgICByZXR1cm4gaXNSZWFkb25seTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGtleSA9PT0gIl9fdl9yYXciIC8qIFJBVyAqLykgewogICAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQoaGFzT3duKGluc3RydW1lbnRhdGlvbnMsIGtleSkgJiYga2V5IGluIHRhcmdldAogICAgICAgICAgICAgID8gaW5zdHJ1bWVudGF0aW9ucwogICAgICAgICAgICAgIDogdGFyZ2V0LCBrZXksIHJlY2VpdmVyKTsKICAgICAgfTsKICB9CiAgY29uc3QgbXV0YWJsZUNvbGxlY3Rpb25IYW5kbGVycyA9IHsKICAgICAgZ2V0OiAvKiNfX1BVUkVfXyovIGNyZWF0ZUluc3RydW1lbnRhdGlvbkdldHRlcihmYWxzZSwgZmFsc2UpCiAgfTsKICBjb25zdCBzaGFsbG93Q29sbGVjdGlvbkhhbmRsZXJzID0gewogICAgICBnZXQ6IC8qI19fUFVSRV9fKi8gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKGZhbHNlLCB0cnVlKQogIH07CiAgY29uc3QgcmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7CiAgICAgIGdldDogLyojX19QVVJFX18qLyBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIodHJ1ZSwgZmFsc2UpCiAgfTsKICBjb25zdCBzaGFsbG93UmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7CiAgICAgIGdldDogLyojX19QVVJFX18qLyBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIodHJ1ZSwgdHJ1ZSkKICB9OwogIGZ1bmN0aW9uIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzLCBrZXkpIHsKICAgICAgY29uc3QgcmF3S2V5ID0gdG9SYXcoa2V5KTsKICAgICAgaWYgKHJhd0tleSAhPT0ga2V5ICYmIGhhcy5jYWxsKHRhcmdldCwgcmF3S2V5KSkgewogICAgICAgICAgY29uc3QgdHlwZSA9IHRvUmF3VHlwZSh0YXJnZXQpOwogICAgICAgICAgY29uc29sZS53YXJuKGBSZWFjdGl2ZSAke3R5cGV9IGNvbnRhaW5zIGJvdGggdGhlIHJhdyBhbmQgcmVhY3RpdmUgYCArCiAgICAgICAgICAgICAgYHZlcnNpb25zIG9mIHRoZSBzYW1lIG9iamVjdCR7dHlwZSA9PT0gYE1hcGAgPyBgIGFzIGtleXNgIDogYGB9LCBgICsKICAgICAgICAgICAgICBgd2hpY2ggY2FuIGxlYWQgdG8gaW5jb25zaXN0ZW5jaWVzLiBgICsKICAgICAgICAgICAgICBgQXZvaWQgZGlmZmVyZW50aWF0aW5nIGJldHdlZW4gdGhlIHJhdyBhbmQgcmVhY3RpdmUgdmVyc2lvbnMgYCArCiAgICAgICAgICAgICAgYG9mIGFuIG9iamVjdCBhbmQgb25seSB1c2UgdGhlIHJlYWN0aXZlIHZlcnNpb24gaWYgcG9zc2libGUuYCk7CiAgICAgIH0KICB9CgogIGNvbnN0IHJlYWN0aXZlTWFwID0gbmV3IFdlYWtNYXAoKTsKICBjb25zdCBzaGFsbG93UmVhY3RpdmVNYXAgPSBuZXcgV2Vha01hcCgpOwogIGNvbnN0IHJlYWRvbmx5TWFwID0gbmV3IFdlYWtNYXAoKTsKICBjb25zdCBzaGFsbG93UmVhZG9ubHlNYXAgPSBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIHRhcmdldFR5cGVNYXAocmF3VHlwZSkgewogICAgICBzd2l0Y2ggKHJhd1R5cGUpIHsKICAgICAgICAgIGNhc2UgJ09iamVjdCc6CiAgICAgICAgICBjYXNlICdBcnJheSc6CiAgICAgICAgICAgICAgcmV0dXJuIDEgLyogQ09NTU9OICovOwogICAgICAgICAgY2FzZSAnTWFwJzoKICAgICAgICAgIGNhc2UgJ1NldCc6CiAgICAgICAgICBjYXNlICdXZWFrTWFwJzoKICAgICAgICAgIGNhc2UgJ1dlYWtTZXQnOgogICAgICAgICAgICAgIHJldHVybiAyIC8qIENPTExFQ1RJT04gKi87CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAwIC8qIElOVkFMSUQgKi87CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0VGFyZ2V0VHlwZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWVbIl9fdl9za2lwIiAvKiBTS0lQICovXSB8fCAhT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkKICAgICAgICAgID8gMCAvKiBJTlZBTElEICovCiAgICAgICAgICA6IHRhcmdldFR5cGVNYXAodG9SYXdUeXBlKHZhbHVlKSk7CiAgfQogIGZ1bmN0aW9uIHJlYWN0aXZlKHRhcmdldCkgewogICAgICAvLyBpZiB0cnlpbmcgdG8gb2JzZXJ2ZSBhIHJlYWRvbmx5IHByb3h5LCByZXR1cm4gdGhlIHJlYWRvbmx5IHZlcnNpb24uCiAgICAgIGlmIChpc1JlYWRvbmx5KHRhcmdldCkpIHsKICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZVJlYWN0aXZlT2JqZWN0KHRhcmdldCwgZmFsc2UsIG11dGFibGVIYW5kbGVycywgbXV0YWJsZUNvbGxlY3Rpb25IYW5kbGVycywgcmVhY3RpdmVNYXApOwogIH0KICAvKioKICAgKiBSZXR1cm4gYSBzaGFsbG93bHktcmVhY3RpdmUgY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LCB3aGVyZSBvbmx5IHRoZSByb290CiAgICogbGV2ZWwgcHJvcGVydGllcyBhcmUgcmVhY3RpdmUuIEl0IGFsc28gZG9lcyBub3QgYXV0by11bndyYXAgcmVmcyAoZXZlbiBhdCB0aGUKICAgKiByb290IGxldmVsKS4KICAgKi8KICBmdW5jdGlvbiBzaGFsbG93UmVhY3RpdmUodGFyZ2V0KSB7CiAgICAgIHJldHVybiBjcmVhdGVSZWFjdGl2ZU9iamVjdCh0YXJnZXQsIGZhbHNlLCBzaGFsbG93UmVhY3RpdmVIYW5kbGVycywgc2hhbGxvd0NvbGxlY3Rpb25IYW5kbGVycywgc2hhbGxvd1JlYWN0aXZlTWFwKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlYWRvbmx5IGNvcHkgb2YgdGhlIG9yaWdpbmFsIG9iamVjdC4gTm90ZSB0aGUgcmV0dXJuZWQgY29weSBpcyBub3QKICAgKiBtYWRlIHJlYWN0aXZlLCBidXQgYHJlYWRvbmx5YCBjYW4gYmUgY2FsbGVkIG9uIGFuIGFscmVhZHkgcmVhY3RpdmUgb2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIHJlYWRvbmx5KHRhcmdldCkgewogICAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QodGFyZ2V0LCB0cnVlLCByZWFkb25seUhhbmRsZXJzLCByZWFkb25seUNvbGxlY3Rpb25IYW5kbGVycywgcmVhZG9ubHlNYXApOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgcmVhY3RpdmUtY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LCB3aGVyZSBvbmx5IHRoZSByb290IGxldmVsCiAgICogcHJvcGVydGllcyBhcmUgcmVhZG9ubHksIGFuZCBkb2VzIE5PVCB1bndyYXAgcmVmcyBub3IgcmVjdXJzaXZlbHkgY29udmVydAogICAqIHJldHVybmVkIHByb3BlcnRpZXMuCiAgICogVGhpcyBpcyB1c2VkIGZvciBjcmVhdGluZyB0aGUgcHJvcHMgcHJveHkgb2JqZWN0IGZvciBzdGF0ZWZ1bCBjb21wb25lbnRzLgogICAqLwogIGZ1bmN0aW9uIHNoYWxsb3dSZWFkb25seSh0YXJnZXQpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVJlYWN0aXZlT2JqZWN0KHRhcmdldCwgdHJ1ZSwgc2hhbGxvd1JlYWRvbmx5SGFuZGxlcnMsIHNoYWxsb3dSZWFkb25seUNvbGxlY3Rpb25IYW5kbGVycywgc2hhbGxvd1JlYWRvbmx5TWFwKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUmVhY3RpdmVPYmplY3QodGFyZ2V0LCBpc1JlYWRvbmx5LCBiYXNlSGFuZGxlcnMsIGNvbGxlY3Rpb25IYW5kbGVycywgcHJveHlNYXApIHsKICAgICAgaWYgKCFpc09iamVjdCh0YXJnZXQpKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgICAgY29uc29sZS53YXJuKGB2YWx1ZSBjYW5ub3QgYmUgbWFkZSByZWFjdGl2ZTogJHtTdHJpbmcodGFyZ2V0KX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KICAgICAgLy8gdGFyZ2V0IGlzIGFscmVhZHkgYSBQcm94eSwgcmV0dXJuIGl0LgogICAgICAvLyBleGNlcHRpb246IGNhbGxpbmcgcmVhZG9ubHkoKSBvbiBhIHJlYWN0aXZlIG9iamVjdAogICAgICBpZiAodGFyZ2V0WyJfX3ZfcmF3IiAvKiBSQVcgKi9dICYmCiAgICAgICAgICAhKGlzUmVhZG9ubHkgJiYgdGFyZ2V0WyJfX3ZfaXNSZWFjdGl2ZSIgLyogSVNfUkVBQ1RJVkUgKi9dKSkgewogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfQogICAgICAvLyB0YXJnZXQgYWxyZWFkeSBoYXMgY29ycmVzcG9uZGluZyBQcm94eQogICAgICBjb25zdCBleGlzdGluZ1Byb3h5ID0gcHJveHlNYXAuZ2V0KHRhcmdldCk7CiAgICAgIGlmIChleGlzdGluZ1Byb3h5KSB7CiAgICAgICAgICByZXR1cm4gZXhpc3RpbmdQcm94eTsKICAgICAgfQogICAgICAvLyBvbmx5IHNwZWNpZmljIHZhbHVlIHR5cGVzIGNhbiBiZSBvYnNlcnZlZC4KICAgICAgY29uc3QgdGFyZ2V0VHlwZSA9IGdldFRhcmdldFR5cGUodGFyZ2V0KTsKICAgICAgaWYgKHRhcmdldFR5cGUgPT09IDAgLyogSU5WQUxJRCAqLykgewogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfQogICAgICBjb25zdCBwcm94eSA9IG5ldyBQcm94eSh0YXJnZXQsIHRhcmdldFR5cGUgPT09IDIgLyogQ09MTEVDVElPTiAqLyA/IGNvbGxlY3Rpb25IYW5kbGVycyA6IGJhc2VIYW5kbGVycyk7CiAgICAgIHByb3h5TWFwLnNldCh0YXJnZXQsIHByb3h5KTsKICAgICAgcmV0dXJuIHByb3h5OwogIH0KICBmdW5jdGlvbiBpc1JlYWN0aXZlKHZhbHVlKSB7CiAgICAgIGlmIChpc1JlYWRvbmx5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGlzUmVhY3RpdmUodmFsdWVbIl9fdl9yYXciIC8qIFJBVyAqL10pOwogICAgICB9CiAgICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZVsiX192X2lzUmVhY3RpdmUiIC8qIElTX1JFQUNUSVZFICovXSk7CiAgfQogIGZ1bmN0aW9uIGlzUmVhZG9ubHkodmFsdWUpIHsKICAgICAgcmV0dXJuICEhKHZhbHVlICYmIHZhbHVlWyJfX3ZfaXNSZWFkb25seSIgLyogSVNfUkVBRE9OTFkgKi9dKTsKICB9CiAgZnVuY3Rpb24gaXNTaGFsbG93KHZhbHVlKSB7CiAgICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZVsiX192X2lzU2hhbGxvdyIgLyogSVNfU0hBTExPVyAqL10pOwogIH0KICBmdW5jdGlvbiBpc1Byb3h5KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc1JlYWN0aXZlKHZhbHVlKSB8fCBpc1JlYWRvbmx5KHZhbHVlKTsKICB9CiAgZnVuY3Rpb24gdG9SYXcob2JzZXJ2ZWQpIHsKICAgICAgY29uc3QgcmF3ID0gb2JzZXJ2ZWQgJiYgb2JzZXJ2ZWRbIl9fdl9yYXciIC8qIFJBVyAqL107CiAgICAgIHJldHVybiByYXcgPyB0b1JhdyhyYXcpIDogb2JzZXJ2ZWQ7CiAgfQogIGZ1bmN0aW9uIG1hcmtSYXcodmFsdWUpIHsKICAgICAgZGVmKHZhbHVlLCAiX192X3NraXAiIC8qIFNLSVAgKi8sIHRydWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgfQogIGNvbnN0IHRvUmVhY3RpdmUgPSAodmFsdWUpID0+IGlzT2JqZWN0KHZhbHVlKSA/IHJlYWN0aXZlKHZhbHVlKSA6IHZhbHVlOwogIGNvbnN0IHRvUmVhZG9ubHkgPSAodmFsdWUpID0+IGlzT2JqZWN0KHZhbHVlKSA/IHJlYWRvbmx5KHZhbHVlKSA6IHZhbHVlOwoKICBmdW5jdGlvbiB0cmFja1JlZlZhbHVlKHJlZikgewogICAgICBpZiAoc2hvdWxkVHJhY2sgJiYgYWN0aXZlRWZmZWN0KSB7CiAgICAgICAgICByZWYgPSB0b1JhdyhyZWYpOwogICAgICAgICAgewogICAgICAgICAgICAgIHRyYWNrRWZmZWN0cyhyZWYuZGVwIHx8IChyZWYuZGVwID0gY3JlYXRlRGVwKCkpLCB7CiAgICAgICAgICAgICAgICAgIHRhcmdldDogcmVmLAogICAgICAgICAgICAgICAgICB0eXBlOiAiZ2V0IiAvKiBHRVQgKi8sCiAgICAgICAgICAgICAgICAgIGtleTogJ3ZhbHVlJwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICB9CiAgfQogIGZ1bmN0aW9uIHRyaWdnZXJSZWZWYWx1ZShyZWYsIG5ld1ZhbCkgewogICAgICByZWYgPSB0b1JhdyhyZWYpOwogICAgICBpZiAocmVmLmRlcCkgewogICAgICAgICAgewogICAgICAgICAgICAgIHRyaWdnZXJFZmZlY3RzKHJlZi5kZXAsIHsKICAgICAgICAgICAgICAgICAgdGFyZ2V0OiByZWYsCiAgICAgICAgICAgICAgICAgIHR5cGU6ICJzZXQiIC8qIFNFVCAqLywKICAgICAgICAgICAgICAgICAga2V5OiAndmFsdWUnLAogICAgICAgICAgICAgICAgICBuZXdWYWx1ZTogbmV3VmFsCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gaXNSZWYocikgewogICAgICByZXR1cm4gISEociAmJiByLl9fdl9pc1JlZiA9PT0gdHJ1ZSk7CiAgfQogIGZ1bmN0aW9uIHJlZih2YWx1ZSkgewogICAgICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCBmYWxzZSk7CiAgfQogIGZ1bmN0aW9uIHNoYWxsb3dSZWYodmFsdWUpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVJlZih2YWx1ZSwgdHJ1ZSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVJlZihyYXdWYWx1ZSwgc2hhbGxvdykgewogICAgICBpZiAoaXNSZWYocmF3VmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gcmF3VmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBSZWZJbXBsKHJhd1ZhbHVlLCBzaGFsbG93KTsKICB9CiAgY2xhc3MgUmVmSW1wbCB7CiAgICAgIGNvbnN0cnVjdG9yKHZhbHVlLCBfX3ZfaXNTaGFsbG93KSB7CiAgICAgICAgICB0aGlzLl9fdl9pc1NoYWxsb3cgPSBfX3ZfaXNTaGFsbG93OwogICAgICAgICAgdGhpcy5kZXAgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLl9fdl9pc1JlZiA9IHRydWU7CiAgICAgICAgICB0aGlzLl9yYXdWYWx1ZSA9IF9fdl9pc1NoYWxsb3cgPyB2YWx1ZSA6IHRvUmF3KHZhbHVlKTsKICAgICAgICAgIHRoaXMuX3ZhbHVlID0gX192X2lzU2hhbGxvdyA/IHZhbHVlIDogdG9SZWFjdGl2ZSh2YWx1ZSk7CiAgICAgIH0KICAgICAgZ2V0IHZhbHVlKCkgewogICAgICAgICAgdHJhY2tSZWZWYWx1ZSh0aGlzKTsKICAgICAgICAgIHJldHVybiB0aGlzLl92YWx1ZTsKICAgICAgfQogICAgICBzZXQgdmFsdWUobmV3VmFsKSB7CiAgICAgICAgICBuZXdWYWwgPSB0aGlzLl9fdl9pc1NoYWxsb3cgPyBuZXdWYWwgOiB0b1JhdyhuZXdWYWwpOwogICAgICAgICAgaWYgKGhhc0NoYW5nZWQobmV3VmFsLCB0aGlzLl9yYXdWYWx1ZSkpIHsKICAgICAgICAgICAgICB0aGlzLl9yYXdWYWx1ZSA9IG5ld1ZhbDsKICAgICAgICAgICAgICB0aGlzLl92YWx1ZSA9IHRoaXMuX192X2lzU2hhbGxvdyA/IG5ld1ZhbCA6IHRvUmVhY3RpdmUobmV3VmFsKTsKICAgICAgICAgICAgICB0cmlnZ2VyUmVmVmFsdWUodGhpcywgbmV3VmFsKTsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiB0cmlnZ2VyUmVmKHJlZikgewogICAgICB0cmlnZ2VyUmVmVmFsdWUocmVmLCByZWYudmFsdWUgKTsKICB9CiAgZnVuY3Rpb24gdW5yZWYocmVmKSB7CiAgICAgIHJldHVybiBpc1JlZihyZWYpID8gcmVmLnZhbHVlIDogcmVmOwogIH0KICBjb25zdCBzaGFsbG93VW53cmFwSGFuZGxlcnMgPSB7CiAgICAgIGdldDogKHRhcmdldCwga2V5LCByZWNlaXZlcikgPT4gdW5yZWYoUmVmbGVjdC5nZXQodGFyZ2V0LCBrZXksIHJlY2VpdmVyKSksCiAgICAgIHNldDogKHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpID0+IHsKICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGFyZ2V0W2tleV07CiAgICAgICAgICBpZiAoaXNSZWYob2xkVmFsdWUpICYmICFpc1JlZih2YWx1ZSkpIHsKICAgICAgICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3Quc2V0KHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpOwogICAgICAgICAgfQogICAgICB9CiAgfTsKICBmdW5jdGlvbiBwcm94eVJlZnMob2JqZWN0V2l0aFJlZnMpIHsKICAgICAgcmV0dXJuIGlzUmVhY3RpdmUob2JqZWN0V2l0aFJlZnMpCiAgICAgICAgICA/IG9iamVjdFdpdGhSZWZzCiAgICAgICAgICA6IG5ldyBQcm94eShvYmplY3RXaXRoUmVmcywgc2hhbGxvd1Vud3JhcEhhbmRsZXJzKTsKICB9CiAgY2xhc3MgQ3VzdG9tUmVmSW1wbCB7CiAgICAgIGNvbnN0cnVjdG9yKGZhY3RvcnkpIHsKICAgICAgICAgIHRoaXMuZGVwID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy5fX3ZfaXNSZWYgPSB0cnVlOwogICAgICAgICAgY29uc3QgeyBnZXQsIHNldCB9ID0gZmFjdG9yeSgoKSA9PiB0cmFja1JlZlZhbHVlKHRoaXMpLCAoKSA9PiB0cmlnZ2VyUmVmVmFsdWUodGhpcykpOwogICAgICAgICAgdGhpcy5fZ2V0ID0gZ2V0OwogICAgICAgICAgdGhpcy5fc2V0ID0gc2V0OwogICAgICB9CiAgICAgIGdldCB2YWx1ZSgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9nZXQoKTsKICAgICAgfQogICAgICBzZXQgdmFsdWUobmV3VmFsKSB7CiAgICAgICAgICB0aGlzLl9zZXQobmV3VmFsKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBjdXN0b21SZWYoZmFjdG9yeSkgewogICAgICByZXR1cm4gbmV3IEN1c3RvbVJlZkltcGwoZmFjdG9yeSk7CiAgfQogIGZ1bmN0aW9uIHRvUmVmcyhvYmplY3QpIHsKICAgICAgaWYgKCFpc1Byb3h5KG9iamVjdCkpIHsKICAgICAgICAgIGNvbnNvbGUud2FybihgdG9SZWZzKCkgZXhwZWN0cyBhIHJlYWN0aXZlIG9iamVjdCBidXQgcmVjZWl2ZWQgYSBwbGFpbiBvbmUuYCk7CiAgICAgIH0KICAgICAgY29uc3QgcmV0ID0gaXNBcnJheShvYmplY3QpID8gbmV3IEFycmF5KG9iamVjdC5sZW5ndGgpIDoge307CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG9iamVjdCkgewogICAgICAgICAgcmV0W2tleV0gPSB0b1JlZihvYmplY3QsIGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICB9CiAgY2xhc3MgT2JqZWN0UmVmSW1wbCB7CiAgICAgIGNvbnN0cnVjdG9yKF9vYmplY3QsIF9rZXksIF9kZWZhdWx0VmFsdWUpIHsKICAgICAgICAgIHRoaXMuX29iamVjdCA9IF9vYmplY3Q7CiAgICAgICAgICB0aGlzLl9rZXkgPSBfa2V5OwogICAgICAgICAgdGhpcy5fZGVmYXVsdFZhbHVlID0gX2RlZmF1bHRWYWx1ZTsKICAgICAgICAgIHRoaXMuX192X2lzUmVmID0gdHJ1ZTsKICAgICAgfQogICAgICBnZXQgdmFsdWUoKSB7CiAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLl9vYmplY3RbdGhpcy5fa2V5XTsKICAgICAgICAgIHJldHVybiB2YWwgPT09IHVuZGVmaW5lZCA/IHRoaXMuX2RlZmF1bHRWYWx1ZSA6IHZhbDsKICAgICAgfQogICAgICBzZXQgdmFsdWUobmV3VmFsKSB7CiAgICAgICAgICB0aGlzLl9vYmplY3RbdGhpcy5fa2V5XSA9IG5ld1ZhbDsKICAgICAgfQogIH0KICBmdW5jdGlvbiB0b1JlZihvYmplY3QsIGtleSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGNvbnN0IHZhbCA9IG9iamVjdFtrZXldOwogICAgICByZXR1cm4gaXNSZWYodmFsKQogICAgICAgICAgPyB2YWwKICAgICAgICAgIDogbmV3IE9iamVjdFJlZkltcGwob2JqZWN0LCBrZXksIGRlZmF1bHRWYWx1ZSk7CiAgfQoKICBjbGFzcyBDb21wdXRlZFJlZkltcGwgewogICAgICBjb25zdHJ1Y3RvcihnZXR0ZXIsIF9zZXR0ZXIsIGlzUmVhZG9ubHksIGlzU1NSKSB7CiAgICAgICAgICB0aGlzLl9zZXR0ZXIgPSBfc2V0dGVyOwogICAgICAgICAgdGhpcy5kZXAgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLl9fdl9pc1JlZiA9IHRydWU7CiAgICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgICB0aGlzLmVmZmVjdCA9IG5ldyBSZWFjdGl2ZUVmZmVjdChnZXR0ZXIsICgpID0+IHsKICAgICAgICAgICAgICBpZiAoIXRoaXMuX2RpcnR5KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdHJpZ2dlclJlZlZhbHVlKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5lZmZlY3QuY29tcHV0ZWQgPSB0aGlzOwogICAgICAgICAgdGhpcy5lZmZlY3QuYWN0aXZlID0gdGhpcy5fY2FjaGVhYmxlID0gIWlzU1NSOwogICAgICAgICAgdGhpc1siX192X2lzUmVhZG9ubHkiIC8qIElTX1JFQURPTkxZICovXSA9IGlzUmVhZG9ubHk7CiAgICAgIH0KICAgICAgZ2V0IHZhbHVlKCkgewogICAgICAgICAgLy8gdGhlIGNvbXB1dGVkIHJlZiBtYXkgZ2V0IHdyYXBwZWQgYnkgb3RoZXIgcHJveGllcyBlLmcuIHJlYWRvbmx5KCkgIzMzNzYKICAgICAgICAgIGNvbnN0IHNlbGYgPSB0b1Jhdyh0aGlzKTsKICAgICAgICAgIHRyYWNrUmVmVmFsdWUoc2VsZik7CiAgICAgICAgICBpZiAoc2VsZi5fZGlydHkgfHwgIXNlbGYuX2NhY2hlYWJsZSkgewogICAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgc2VsZi5fdmFsdWUgPSBzZWxmLmVmZmVjdC5ydW4oKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxmLl92YWx1ZTsKICAgICAgfQogICAgICBzZXQgdmFsdWUobmV3VmFsdWUpIHsKICAgICAgICAgIHRoaXMuX3NldHRlcihuZXdWYWx1ZSk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gY29tcHV0ZWQoZ2V0dGVyT3JPcHRpb25zLCBkZWJ1Z09wdGlvbnMsIGlzU1NSID0gZmFsc2UpIHsKICAgICAgbGV0IGdldHRlcjsKICAgICAgbGV0IHNldHRlcjsKICAgICAgY29uc3Qgb25seUdldHRlciA9IGlzRnVuY3Rpb24oZ2V0dGVyT3JPcHRpb25zKTsKICAgICAgaWYgKG9ubHlHZXR0ZXIpIHsKICAgICAgICAgIGdldHRlciA9IGdldHRlck9yT3B0aW9uczsKICAgICAgICAgIHNldHRlciA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdXcml0ZSBvcGVyYXRpb24gZmFpbGVkOiBjb21wdXRlZCB2YWx1ZSBpcyByZWFkb25seScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICA7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBnZXR0ZXIgPSBnZXR0ZXJPck9wdGlvbnMuZ2V0OwogICAgICAgICAgc2V0dGVyID0gZ2V0dGVyT3JPcHRpb25zLnNldDsKICAgICAgfQogICAgICBjb25zdCBjUmVmID0gbmV3IENvbXB1dGVkUmVmSW1wbChnZXR0ZXIsIHNldHRlciwgb25seUdldHRlciB8fCAhc2V0dGVyLCBpc1NTUik7CiAgICAgIGlmIChkZWJ1Z09wdGlvbnMgJiYgIWlzU1NSKSB7CiAgICAgICAgICBjUmVmLmVmZmVjdC5vblRyYWNrID0gZGVidWdPcHRpb25zLm9uVHJhY2s7CiAgICAgICAgICBjUmVmLmVmZmVjdC5vblRyaWdnZXIgPSBkZWJ1Z09wdGlvbnMub25UcmlnZ2VyOwogICAgICB9CiAgICAgIHJldHVybiBjUmVmOwogIH0KCiAgY29uc3Qgc3RhY2sgPSBbXTsKICBmdW5jdGlvbiBwdXNoV2FybmluZ0NvbnRleHQodm5vZGUpIHsKICAgICAgc3RhY2sucHVzaCh2bm9kZSk7CiAgfQogIGZ1bmN0aW9uIHBvcFdhcm5pbmdDb250ZXh0KCkgewogICAgICBzdGFjay5wb3AoKTsKICB9CiAgZnVuY3Rpb24gd2FybiQxKG1zZywgLi4uYXJncykgewogICAgICAvLyBhdm9pZCBwcm9wcyBmb3JtYXR0aW5nIG9yIHdhcm4gaGFuZGxlciB0cmFja2luZyBkZXBzIHRoYXQgbWlnaHQgYmUgbXV0YXRlZAogICAgICAvLyBkdXJpbmcgcGF0Y2gsIGxlYWRpbmcgdG8gaW5maW5pdGUgcmVjdXJzaW9uLgogICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgIGNvbnN0IGluc3RhbmNlID0gc3RhY2subGVuZ3RoID8gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV0uY29tcG9uZW50IDogbnVsbDsKICAgICAgY29uc3QgYXBwV2FybkhhbmRsZXIgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZy53YXJuSGFuZGxlcjsKICAgICAgY29uc3QgdHJhY2UgPSBnZXRDb21wb25lbnRUcmFjZSgpOwogICAgICBpZiAoYXBwV2FybkhhbmRsZXIpIHsKICAgICAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhhcHBXYXJuSGFuZGxlciwgaW5zdGFuY2UsIDExIC8qIEFQUF9XQVJOX0hBTkRMRVIgKi8sIFsKICAgICAgICAgICAgICBtc2cgKyBhcmdzLmpvaW4oJycpLAogICAgICAgICAgICAgIGluc3RhbmNlICYmIGluc3RhbmNlLnByb3h5LAogICAgICAgICAgICAgIHRyYWNlCiAgICAgICAgICAgICAgICAgIC5tYXAoKHsgdm5vZGUgfSkgPT4gYGF0IDwke2Zvcm1hdENvbXBvbmVudE5hbWUoaW5zdGFuY2UsIHZub2RlLnR5cGUpfT5gKQogICAgICAgICAgICAgICAgICAuam9pbignXG4nKSwKICAgICAgICAgICAgICB0cmFjZQogICAgICAgICAgXSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBjb25zdCB3YXJuQXJncyA9IFtgW1Z1ZSB3YXJuXTogJHttc2d9YCwgLi4uYXJnc107CiAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgIGlmICh0cmFjZS5sZW5ndGggJiYKICAgICAgICAgICAgICAvLyBhdm9pZCBzcGFtbWluZyBjb25zb2xlIGR1cmluZyB0ZXN0cwogICAgICAgICAgICAgICFmYWxzZSkgewogICAgICAgICAgICAgIHdhcm5BcmdzLnB1c2goYFxuYCwgLi4uZm9ybWF0VHJhY2UodHJhY2UpKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnNvbGUud2FybiguLi53YXJuQXJncyk7CiAgICAgIH0KICAgICAgcmVzZXRUcmFja2luZygpOwogIH0KICBmdW5jdGlvbiBnZXRDb21wb25lbnRUcmFjZSgpIHsKICAgICAgbGV0IGN1cnJlbnRWTm9kZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICBpZiAoIWN1cnJlbnRWTm9kZSkgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIC8vIHdlIGNhbid0IGp1c3QgdXNlIHRoZSBzdGFjayBiZWNhdXNlIGl0IHdpbGwgYmUgaW5jb21wbGV0ZSBkdXJpbmcgdXBkYXRlcwogICAgICAvLyB0aGF0IGRpZCBub3Qgc3RhcnQgZnJvbSB0aGUgcm9vdC4gUmUtY29uc3RydWN0IHRoZSBwYXJlbnQgY2hhaW4gdXNpbmcKICAgICAgLy8gaW5zdGFuY2UgcGFyZW50IHBvaW50ZXJzLgogICAgICBjb25zdCBub3JtYWxpemVkU3RhY2sgPSBbXTsKICAgICAgd2hpbGUgKGN1cnJlbnRWTm9kZSkgewogICAgICAgICAgY29uc3QgbGFzdCA9IG5vcm1hbGl6ZWRTdGFja1swXTsKICAgICAgICAgIGlmIChsYXN0ICYmIGxhc3Qudm5vZGUgPT09IGN1cnJlbnRWTm9kZSkgewogICAgICAgICAgICAgIGxhc3QucmVjdXJzZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBub3JtYWxpemVkU3RhY2sucHVzaCh7CiAgICAgICAgICAgICAgICAgIHZub2RlOiBjdXJyZW50Vk5vZGUsCiAgICAgICAgICAgICAgICAgIHJlY3Vyc2VDb3VudDogMAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGFyZW50SW5zdGFuY2UgPSBjdXJyZW50Vk5vZGUuY29tcG9uZW50ICYmIGN1cnJlbnRWTm9kZS5jb21wb25lbnQucGFyZW50OwogICAgICAgICAgY3VycmVudFZOb2RlID0gcGFyZW50SW5zdGFuY2UgJiYgcGFyZW50SW5zdGFuY2Uudm5vZGU7CiAgICAgIH0KICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRTdGFjazsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBmdW5jdGlvbiBmb3JtYXRUcmFjZSh0cmFjZSkgewogICAgICBjb25zdCBsb2dzID0gW107CiAgICAgIHRyYWNlLmZvckVhY2goKGVudHJ5LCBpKSA9PiB7CiAgICAgICAgICBsb2dzLnB1c2goLi4uKGkgPT09IDAgPyBbXSA6IFtgXG5gXSksIC4uLmZvcm1hdFRyYWNlRW50cnkoZW50cnkpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBsb2dzOwogIH0KICBmdW5jdGlvbiBmb3JtYXRUcmFjZUVudHJ5KHsgdm5vZGUsIHJlY3Vyc2VDb3VudCB9KSB7CiAgICAgIGNvbnN0IHBvc3RmaXggPSByZWN1cnNlQ291bnQgPiAwID8gYC4uLiAoJHtyZWN1cnNlQ291bnR9IHJlY3Vyc2l2ZSBjYWxscylgIDogYGA7CiAgICAgIGNvbnN0IGlzUm9vdCA9IHZub2RlLmNvbXBvbmVudCA/IHZub2RlLmNvbXBvbmVudC5wYXJlbnQgPT0gbnVsbCA6IGZhbHNlOwogICAgICBjb25zdCBvcGVuID0gYCBhdCA8JHtmb3JtYXRDb21wb25lbnROYW1lKHZub2RlLmNvbXBvbmVudCwgdm5vZGUudHlwZSwgaXNSb290KX1gOwogICAgICBjb25zdCBjbG9zZSA9IGA+YCArIHBvc3RmaXg7CiAgICAgIHJldHVybiB2bm9kZS5wcm9wcwogICAgICAgICAgPyBbb3BlbiwgLi4uZm9ybWF0UHJvcHModm5vZGUucHJvcHMpLCBjbG9zZV0KICAgICAgICAgIDogW29wZW4gKyBjbG9zZV07CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gZm9ybWF0UHJvcHMocHJvcHMpIHsKICAgICAgY29uc3QgcmVzID0gW107CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcyk7CiAgICAgIGtleXMuc2xpY2UoMCwgMykuZm9yRWFjaChrZXkgPT4gewogICAgICAgICAgcmVzLnB1c2goLi4uZm9ybWF0UHJvcChrZXksIHByb3BzW2tleV0pKTsKICAgICAgfSk7CiAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDMpIHsKICAgICAgICAgIHJlcy5wdXNoKGAgLi4uYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBmdW5jdGlvbiBmb3JtYXRQcm9wKGtleSwgdmFsdWUsIHJhdykgewogICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICAgIHJldHVybiByYXcgPyB2YWx1ZSA6IFtgJHtrZXl9PSR7dmFsdWV9YF07CiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fAogICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgIHZhbHVlID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiByYXcgPyB2YWx1ZSA6IFtgJHtrZXl9PSR7dmFsdWV9YF07CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNSZWYodmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IGZvcm1hdFByb3Aoa2V5LCB0b1Jhdyh2YWx1ZS52YWx1ZSksIHRydWUpOwogICAgICAgICAgcmV0dXJuIHJhdyA/IHZhbHVlIDogW2Ake2tleX09UmVmPGAsIHZhbHVlLCBgPmBdOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gW2Ake2tleX09Zm4ke3ZhbHVlLm5hbWUgPyBgPCR7dmFsdWUubmFtZX0+YCA6IGBgfWBdOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgdmFsdWUgPSB0b1Jhdyh2YWx1ZSk7CiAgICAgICAgICByZXR1cm4gcmF3ID8gdmFsdWUgOiBbYCR7a2V5fT1gLCB2YWx1ZV07CiAgICAgIH0KICB9CgogIGNvbnN0IEVycm9yVHlwZVN0cmluZ3MgPSB7CiAgICAgIFsic3AiIC8qIFNFUlZFUl9QUkVGRVRDSCAqL106ICdzZXJ2ZXJQcmVmZXRjaCBob29rJywKICAgICAgWyJiYyIgLyogQkVGT1JFX0NSRUFURSAqL106ICdiZWZvcmVDcmVhdGUgaG9vaycsCiAgICAgIFsiYyIgLyogQ1JFQVRFRCAqL106ICdjcmVhdGVkIGhvb2snLAogICAgICBbImJtIiAvKiBCRUZPUkVfTU9VTlQgKi9dOiAnYmVmb3JlTW91bnQgaG9vaycsCiAgICAgIFsibSIgLyogTU9VTlRFRCAqL106ICdtb3VudGVkIGhvb2snLAogICAgICBbImJ1IiAvKiBCRUZPUkVfVVBEQVRFICovXTogJ2JlZm9yZVVwZGF0ZSBob29rJywKICAgICAgWyJ1IiAvKiBVUERBVEVEICovXTogJ3VwZGF0ZWQnLAogICAgICBbImJ1bSIgLyogQkVGT1JFX1VOTU9VTlQgKi9dOiAnYmVmb3JlVW5tb3VudCBob29rJywKICAgICAgWyJ1bSIgLyogVU5NT1VOVEVEICovXTogJ3VubW91bnRlZCBob29rJywKICAgICAgWyJhIiAvKiBBQ1RJVkFURUQgKi9dOiAnYWN0aXZhdGVkIGhvb2snLAogICAgICBbImRhIiAvKiBERUFDVElWQVRFRCAqL106ICdkZWFjdGl2YXRlZCBob29rJywKICAgICAgWyJlYyIgLyogRVJST1JfQ0FQVFVSRUQgKi9dOiAnZXJyb3JDYXB0dXJlZCBob29rJywKICAgICAgWyJydGMiIC8qIFJFTkRFUl9UUkFDS0VEICovXTogJ3JlbmRlclRyYWNrZWQgaG9vaycsCiAgICAgIFsicnRnIiAvKiBSRU5ERVJfVFJJR0dFUkVEICovXTogJ3JlbmRlclRyaWdnZXJlZCBob29rJywKICAgICAgWzAgLyogU0VUVVBfRlVOQ1RJT04gKi9dOiAnc2V0dXAgZnVuY3Rpb24nLAogICAgICBbMSAvKiBSRU5ERVJfRlVOQ1RJT04gKi9dOiAncmVuZGVyIGZ1bmN0aW9uJywKICAgICAgWzIgLyogV0FUQ0hfR0VUVEVSICovXTogJ3dhdGNoZXIgZ2V0dGVyJywKICAgICAgWzMgLyogV0FUQ0hfQ0FMTEJBQ0sgKi9dOiAnd2F0Y2hlciBjYWxsYmFjaycsCiAgICAgIFs0IC8qIFdBVENIX0NMRUFOVVAgKi9dOiAnd2F0Y2hlciBjbGVhbnVwIGZ1bmN0aW9uJywKICAgICAgWzUgLyogTkFUSVZFX0VWRU5UX0hBTkRMRVIgKi9dOiAnbmF0aXZlIGV2ZW50IGhhbmRsZXInLAogICAgICBbNiAvKiBDT01QT05FTlRfRVZFTlRfSEFORExFUiAqL106ICdjb21wb25lbnQgZXZlbnQgaGFuZGxlcicsCiAgICAgIFs3IC8qIFZOT0RFX0hPT0sgKi9dOiAndm5vZGUgaG9vaycsCiAgICAgIFs4IC8qIERJUkVDVElWRV9IT09LICovXTogJ2RpcmVjdGl2ZSBob29rJywKICAgICAgWzkgLyogVFJBTlNJVElPTl9IT09LICovXTogJ3RyYW5zaXRpb24gaG9vaycsCiAgICAgIFsxMCAvKiBBUFBfRVJST1JfSEFORExFUiAqL106ICdhcHAgZXJyb3JIYW5kbGVyJywKICAgICAgWzExIC8qIEFQUF9XQVJOX0hBTkRMRVIgKi9dOiAnYXBwIHdhcm5IYW5kbGVyJywKICAgICAgWzEyIC8qIEZVTkNUSU9OX1JFRiAqL106ICdyZWYgZnVuY3Rpb24nLAogICAgICBbMTMgLyogQVNZTkNfQ09NUE9ORU5UX0xPQURFUiAqL106ICdhc3luYyBjb21wb25lbnQgbG9hZGVyJywKICAgICAgWzE0IC8qIFNDSEVEVUxFUiAqL106ICdzY2hlZHVsZXIgZmx1c2guIFRoaXMgaXMgbGlrZWx5IGEgVnVlIGludGVybmFscyBidWcuICcgKwogICAgICAgICAgJ1BsZWFzZSBvcGVuIGFuIGlzc3VlIGF0IGh0dHBzOi8vbmV3LWlzc3VlLnZ1ZWpzLm9yZy8/cmVwbz12dWVqcy9jb3JlJwogIH07CiAgZnVuY3Rpb24gY2FsbFdpdGhFcnJvckhhbmRsaW5nKGZuLCBpbnN0YW5jZSwgdHlwZSwgYXJncykgewogICAgICBsZXQgcmVzOwogICAgICB0cnkgewogICAgICAgICAgcmVzID0gYXJncyA/IGZuKC4uLmFyZ3MpIDogZm4oKTsKICAgICAgfQogICAgICBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCB0eXBlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzOwogIH0KICBmdW5jdGlvbiBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhmbiwgaW5zdGFuY2UsIHR5cGUsIGFyZ3MpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pKSB7CiAgICAgICAgICBjb25zdCByZXMgPSBjYWxsV2l0aEVycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCB0eXBlLCBhcmdzKTsKICAgICAgICAgIGlmIChyZXMgJiYgaXNQcm9taXNlKHJlcykpIHsKICAgICAgICAgICAgICByZXMuY2F0Y2goZXJyID0+IHsKICAgICAgICAgICAgICAgICAgaGFuZGxlRXJyb3IoZXJyLCBpbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YWx1ZXMucHVzaChjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhmbltpXSwgaW5zdGFuY2UsIHR5cGUsIGFyZ3MpKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVzOwogIH0KICBmdW5jdGlvbiBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCB0eXBlLCB0aHJvd0luRGV2ID0gdHJ1ZSkgewogICAgICBjb25zdCBjb250ZXh0Vk5vZGUgPSBpbnN0YW5jZSA/IGluc3RhbmNlLnZub2RlIDogbnVsbDsKICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICBsZXQgY3VyID0gaW5zdGFuY2UucGFyZW50OwogICAgICAgICAgLy8gdGhlIGV4cG9zZWQgaW5zdGFuY2UgaXMgdGhlIHJlbmRlciBwcm94eSB0byBrZWVwIGl0IGNvbnNpc3RlbnQgd2l0aCAyLngKICAgICAgICAgIGNvbnN0IGV4cG9zZWRJbnN0YW5jZSA9IGluc3RhbmNlLnByb3h5OwogICAgICAgICAgLy8gaW4gcHJvZHVjdGlvbiB0aGUgaG9vayByZWNlaXZlcyBvbmx5IHRoZSBlcnJvciBjb2RlCiAgICAgICAgICBjb25zdCBlcnJvckluZm8gPSBFcnJvclR5cGVTdHJpbmdzW3R5cGVdIDsKICAgICAgICAgIHdoaWxlIChjdXIpIHsKICAgICAgICAgICAgICBjb25zdCBlcnJvckNhcHR1cmVkSG9va3MgPSBjdXIuZWM7CiAgICAgICAgICAgICAgaWYgKGVycm9yQ2FwdHVyZWRIb29rcykgewogICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVycm9yQ2FwdHVyZWRIb29rcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yQ2FwdHVyZWRIb29rc1tpXShlcnIsIGV4cG9zZWRJbnN0YW5jZSwgZXJyb3JJbmZvKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VyID0gY3VyLnBhcmVudDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGFwcC1sZXZlbCBoYW5kbGluZwogICAgICAgICAgY29uc3QgYXBwRXJyb3JIYW5kbGVyID0gaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcuZXJyb3JIYW5kbGVyOwogICAgICAgICAgaWYgKGFwcEVycm9ySGFuZGxlcikgewogICAgICAgICAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhhcHBFcnJvckhhbmRsZXIsIG51bGwsIDEwIC8qIEFQUF9FUlJPUl9IQU5ETEVSICovLCBbZXJyLCBleHBvc2VkSW5zdGFuY2UsIGVycm9ySW5mb10pOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogICAgICBsb2dFcnJvcihlcnIsIHR5cGUsIGNvbnRleHRWTm9kZSwgdGhyb3dJbkRldik7CiAgfQogIGZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdHlwZSwgY29udGV4dFZOb2RlLCB0aHJvd0luRGV2ID0gdHJ1ZSkgewogICAgICB7CiAgICAgICAgICBjb25zdCBpbmZvID0gRXJyb3JUeXBlU3RyaW5nc1t0eXBlXTsKICAgICAgICAgIGlmIChjb250ZXh0Vk5vZGUpIHsKICAgICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQoY29udGV4dFZOb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm4kMShgVW5oYW5kbGVkIGVycm9yJHtpbmZvID8gYCBkdXJpbmcgZXhlY3V0aW9uIG9mICR7aW5mb31gIDogYGB9YCk7CiAgICAgICAgICBpZiAoY29udGV4dFZOb2RlKSB7CiAgICAgICAgICAgICAgcG9wV2FybmluZ0NvbnRleHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGNyYXNoIGluIGRldiBieSBkZWZhdWx0IHNvIGl0J3MgbW9yZSBub3RpY2VhYmxlCiAgICAgICAgICBpZiAodGhyb3dJbkRldikgewogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsKICAgICAgICAgIH0KICAgICAgfQogIH0KCiAgbGV0IGlzRmx1c2hpbmcgPSBmYWxzZTsKICBsZXQgaXNGbHVzaFBlbmRpbmcgPSBmYWxzZTsKICBjb25zdCBxdWV1ZSA9IFtdOwogIGxldCBmbHVzaEluZGV4ID0gMDsKICBjb25zdCBwZW5kaW5nUHJlRmx1c2hDYnMgPSBbXTsKICBsZXQgYWN0aXZlUHJlRmx1c2hDYnMgPSBudWxsOwogIGxldCBwcmVGbHVzaEluZGV4ID0gMDsKICBjb25zdCBwZW5kaW5nUG9zdEZsdXNoQ2JzID0gW107CiAgbGV0IGFjdGl2ZVBvc3RGbHVzaENicyA9IG51bGw7CiAgbGV0IHBvc3RGbHVzaEluZGV4ID0gMDsKICBjb25zdCByZXNvbHZlZFByb21pc2UgPSAvKiNfX1BVUkVfXyovIFByb21pc2UucmVzb2x2ZSgpOwogIGxldCBjdXJyZW50Rmx1c2hQcm9taXNlID0gbnVsbDsKICBsZXQgY3VycmVudFByZUZsdXNoUGFyZW50Sm9iID0gbnVsbDsKICBjb25zdCBSRUNVUlNJT05fTElNSVQgPSAxMDA7CiAgZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgY29uc3QgcCA9IGN1cnJlbnRGbHVzaFByb21pc2UgfHwgcmVzb2x2ZWRQcm9taXNlOwogICAgICByZXR1cm4gZm4gPyBwLnRoZW4odGhpcyA/IGZuLmJpbmQodGhpcykgOiBmbikgOiBwOwogIH0KICAvLyAjMjc2OAogIC8vIFVzZSBiaW5hcnktc2VhcmNoIHRvIGZpbmQgYSBzdWl0YWJsZSBwb3NpdGlvbiBpbiB0aGUgcXVldWUsCiAgLy8gc28gdGhhdCB0aGUgcXVldWUgbWFpbnRhaW5zIHRoZSBpbmNyZWFzaW5nIG9yZGVyIG9mIGpvYidzIGlkLAogIC8vIHdoaWNoIGNhbiBwcmV2ZW50IHRoZSBqb2IgZnJvbSBiZWluZyBza2lwcGVkIGFuZCBhbHNvIGNhbiBhdm9pZCByZXBlYXRlZCBwYXRjaGluZy4KICBmdW5jdGlvbiBmaW5kSW5zZXJ0aW9uSW5kZXgoaWQpIHsKICAgICAgLy8gdGhlIHN0YXJ0IGluZGV4IHNob3VsZCBiZSBgZmx1c2hJbmRleCArIDFgCiAgICAgIGxldCBzdGFydCA9IGZsdXNoSW5kZXggKyAxOwogICAgICBsZXQgZW5kID0gcXVldWUubGVuZ3RoOwogICAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgICAgIGNvbnN0IG1pZGRsZSA9IChzdGFydCArIGVuZCkgPj4+IDE7CiAgICAgICAgICBjb25zdCBtaWRkbGVKb2JJZCA9IGdldElkKHF1ZXVlW21pZGRsZV0pOwogICAgICAgICAgbWlkZGxlSm9iSWQgPCBpZCA/IChzdGFydCA9IG1pZGRsZSArIDEpIDogKGVuZCA9IG1pZGRsZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0YXJ0OwogIH0KICBmdW5jdGlvbiBxdWV1ZUpvYihqb2IpIHsKICAgICAgLy8gdGhlIGRlZHVwZSBzZWFyY2ggdXNlcyB0aGUgc3RhcnRJbmRleCBhcmd1bWVudCBvZiBBcnJheS5pbmNsdWRlcygpCiAgICAgIC8vIGJ5IGRlZmF1bHQgdGhlIHNlYXJjaCBpbmRleCBpbmNsdWRlcyB0aGUgY3VycmVudCBqb2IgdGhhdCBpcyBiZWluZyBydW4KICAgICAgLy8gc28gaXQgY2Fubm90IHJlY3Vyc2l2ZWx5IHRyaWdnZXIgaXRzZWxmIGFnYWluLgogICAgICAvLyBpZiB0aGUgam9iIGlzIGEgd2F0Y2goKSBjYWxsYmFjaywgdGhlIHNlYXJjaCB3aWxsIHN0YXJ0IHdpdGggYSArMSBpbmRleCB0bwogICAgICAvLyBhbGxvdyBpdCByZWN1cnNpdmVseSB0cmlnZ2VyIGl0c2VsZiAtIGl0IGlzIHRoZSB1c2VyJ3MgcmVzcG9uc2liaWxpdHkgdG8KICAgICAgLy8gZW5zdXJlIGl0IGRvZXNuJ3QgZW5kIHVwIGluIGFuIGluZmluaXRlIGxvb3AuCiAgICAgIGlmICgoIXF1ZXVlLmxlbmd0aCB8fAogICAgICAgICAgIXF1ZXVlLmluY2x1ZGVzKGpvYiwgaXNGbHVzaGluZyAmJiBqb2IuYWxsb3dSZWN1cnNlID8gZmx1c2hJbmRleCArIDEgOiBmbHVzaEluZGV4KSkgJiYKICAgICAgICAgIGpvYiAhPT0gY3VycmVudFByZUZsdXNoUGFyZW50Sm9iKSB7CiAgICAgICAgICBpZiAoam9iLmlkID09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZS5wdXNoKGpvYik7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBxdWV1ZS5zcGxpY2UoZmluZEluc2VydGlvbkluZGV4KGpvYi5pZCksIDAsIGpvYik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZUZsdXNoKCk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gcXVldWVGbHVzaCgpIHsKICAgICAgaWYgKCFpc0ZsdXNoaW5nICYmICFpc0ZsdXNoUGVuZGluZykgewogICAgICAgICAgaXNGbHVzaFBlbmRpbmcgPSB0cnVlOwogICAgICAgICAgY3VycmVudEZsdXNoUHJvbWlzZSA9IHJlc29sdmVkUHJvbWlzZS50aGVuKGZsdXNoSm9icyk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gaW52YWxpZGF0ZUpvYihqb2IpIHsKICAgICAgY29uc3QgaSA9IHF1ZXVlLmluZGV4T2Yoam9iKTsKICAgICAgaWYgKGkgPiBmbHVzaEluZGV4KSB7CiAgICAgICAgICBxdWV1ZS5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gcXVldWVDYihjYiwgYWN0aXZlUXVldWUsIHBlbmRpbmdRdWV1ZSwgaW5kZXgpIHsKICAgICAgaWYgKCFpc0FycmF5KGNiKSkgewogICAgICAgICAgaWYgKCFhY3RpdmVRdWV1ZSB8fAogICAgICAgICAgICAgICFhY3RpdmVRdWV1ZS5pbmNsdWRlcyhjYiwgY2IuYWxsb3dSZWN1cnNlID8gaW5kZXggKyAxIDogaW5kZXgpKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlLnB1c2goY2IpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgLy8gaWYgY2IgaXMgYW4gYXJyYXksIGl0IGlzIGEgY29tcG9uZW50IGxpZmVjeWNsZSBob29rIHdoaWNoIGNhbiBvbmx5IGJlCiAgICAgICAgICAvLyB0cmlnZ2VyZWQgYnkgYSBqb2IsIHdoaWNoIGlzIGFscmVhZHkgZGVkdXBlZCBpbiB0aGUgbWFpbiBxdWV1ZSwgc28KICAgICAgICAgIC8vIHdlIGNhbiBza2lwIGR1cGxpY2F0ZSBjaGVjayBoZXJlIHRvIGltcHJvdmUgcGVyZgogICAgICAgICAgcGVuZGluZ1F1ZXVlLnB1c2goLi4uY2IpOwogICAgICB9CiAgICAgIHF1ZXVlRmx1c2goKTsKICB9CiAgZnVuY3Rpb24gcXVldWVQcmVGbHVzaENiKGNiKSB7CiAgICAgIHF1ZXVlQ2IoY2IsIGFjdGl2ZVByZUZsdXNoQ2JzLCBwZW5kaW5nUHJlRmx1c2hDYnMsIHByZUZsdXNoSW5kZXgpOwogIH0KICBmdW5jdGlvbiBxdWV1ZVBvc3RGbHVzaENiKGNiKSB7CiAgICAgIHF1ZXVlQ2IoY2IsIGFjdGl2ZVBvc3RGbHVzaENicywgcGVuZGluZ1Bvc3RGbHVzaENicywgcG9zdEZsdXNoSW5kZXgpOwogIH0KICBmdW5jdGlvbiBmbHVzaFByZUZsdXNoQ2JzKHNlZW4sIHBhcmVudEpvYiA9IG51bGwpIHsKICAgICAgaWYgKHBlbmRpbmdQcmVGbHVzaENicy5sZW5ndGgpIHsKICAgICAgICAgIGN1cnJlbnRQcmVGbHVzaFBhcmVudEpvYiA9IHBhcmVudEpvYjsKICAgICAgICAgIGFjdGl2ZVByZUZsdXNoQ2JzID0gWy4uLm5ldyBTZXQocGVuZGluZ1ByZUZsdXNoQ2JzKV07CiAgICAgICAgICBwZW5kaW5nUHJlRmx1c2hDYnMubGVuZ3RoID0gMDsKICAgICAgICAgIHsKICAgICAgICAgICAgICBzZWVuID0gc2VlbiB8fCBuZXcgTWFwKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHByZUZsdXNoSW5kZXggPSAwOyBwcmVGbHVzaEluZGV4IDwgYWN0aXZlUHJlRmx1c2hDYnMubGVuZ3RoOyBwcmVGbHVzaEluZGV4KyspIHsKICAgICAgICAgICAgICBpZiAoY2hlY2tSZWN1cnNpdmVVcGRhdGVzKHNlZW4sIGFjdGl2ZVByZUZsdXNoQ2JzW3ByZUZsdXNoSW5kZXhdKSkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWN0aXZlUHJlRmx1c2hDYnNbcHJlRmx1c2hJbmRleF0oKTsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZVByZUZsdXNoQ2JzID0gbnVsbDsKICAgICAgICAgIHByZUZsdXNoSW5kZXggPSAwOwogICAgICAgICAgY3VycmVudFByZUZsdXNoUGFyZW50Sm9iID0gbnVsbDsKICAgICAgICAgIC8vIHJlY3Vyc2l2ZWx5IGZsdXNoIHVudGlsIGl0IGRyYWlucwogICAgICAgICAgZmx1c2hQcmVGbHVzaENicyhzZWVuLCBwYXJlbnRKb2IpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGZsdXNoUG9zdEZsdXNoQ2JzKHNlZW4pIHsKICAgICAgLy8gZmx1c2ggYW55IHByZSBjYnMgcXVldWVkIGR1cmluZyB0aGUgZmx1c2ggKGUuZy4gcHJlIHdhdGNoZXJzKQogICAgICBmbHVzaFByZUZsdXNoQ2JzKCk7CiAgICAgIGlmIChwZW5kaW5nUG9zdEZsdXNoQ2JzLmxlbmd0aCkgewogICAgICAgICAgY29uc3QgZGVkdXBlZCA9IFsuLi5uZXcgU2V0KHBlbmRpbmdQb3N0Rmx1c2hDYnMpXTsKICAgICAgICAgIHBlbmRpbmdQb3N0Rmx1c2hDYnMubGVuZ3RoID0gMDsKICAgICAgICAgIC8vICMxOTQ3IGFscmVhZHkgaGFzIGFjdGl2ZSBxdWV1ZSwgbmVzdGVkIGZsdXNoUG9zdEZsdXNoQ2JzIGNhbGwKICAgICAgICAgIGlmIChhY3RpdmVQb3N0Rmx1c2hDYnMpIHsKICAgICAgICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnMucHVzaCguLi5kZWR1cGVkKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnMgPSBkZWR1cGVkOwogICAgICAgICAgewogICAgICAgICAgICAgIHNlZW4gPSBzZWVuIHx8IG5ldyBNYXAoKTsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZVBvc3RGbHVzaENicy5zb3J0KChhLCBiKSA9PiBnZXRJZChhKSAtIGdldElkKGIpKTsKICAgICAgICAgIGZvciAocG9zdEZsdXNoSW5kZXggPSAwOyBwb3N0Rmx1c2hJbmRleCA8IGFjdGl2ZVBvc3RGbHVzaENicy5sZW5ndGg7IHBvc3RGbHVzaEluZGV4KyspIHsKICAgICAgICAgICAgICBpZiAoY2hlY2tSZWN1cnNpdmVVcGRhdGVzKHNlZW4sIGFjdGl2ZVBvc3RGbHVzaENic1twb3N0Rmx1c2hJbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnNbcG9zdEZsdXNoSW5kZXhdKCk7CiAgICAgICAgICB9CiAgICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnMgPSBudWxsOwogICAgICAgICAgcG9zdEZsdXNoSW5kZXggPSAwOwogICAgICB9CiAgfQogIGNvbnN0IGdldElkID0gKGpvYikgPT4gam9iLmlkID09IG51bGwgPyBJbmZpbml0eSA6IGpvYi5pZDsKICBmdW5jdGlvbiBmbHVzaEpvYnMoc2VlbikgewogICAgICBpc0ZsdXNoUGVuZGluZyA9IGZhbHNlOwogICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgewogICAgICAgICAgc2VlbiA9IHNlZW4gfHwgbmV3IE1hcCgpOwogICAgICB9CiAgICAgIGZsdXNoUHJlRmx1c2hDYnMoc2Vlbik7CiAgICAgIC8vIFNvcnQgcXVldWUgYmVmb3JlIGZsdXNoLgogICAgICAvLyBUaGlzIGVuc3VyZXMgdGhhdDoKICAgICAgLy8gMS4gQ29tcG9uZW50cyBhcmUgdXBkYXRlZCBmcm9tIHBhcmVudCB0byBjaGlsZC4gKGJlY2F1c2UgcGFyZW50IGlzIGFsd2F5cwogICAgICAvLyAgICBjcmVhdGVkIGJlZm9yZSB0aGUgY2hpbGQgc28gaXRzIHJlbmRlciBlZmZlY3Qgd2lsbCBoYXZlIHNtYWxsZXIKICAgICAgLy8gICAgcHJpb3JpdHkgbnVtYmVyKQogICAgICAvLyAyLiBJZiBhIGNvbXBvbmVudCBpcyB1bm1vdW50ZWQgZHVyaW5nIGEgcGFyZW50IGNvbXBvbmVudCdzIHVwZGF0ZSwKICAgICAgLy8gICAgaXRzIHVwZGF0ZSBjYW4gYmUgc2tpcHBlZC4KICAgICAgcXVldWUuc29ydCgoYSwgYikgPT4gZ2V0SWQoYSkgLSBnZXRJZChiKSk7CiAgICAgIC8vIGNvbmRpdGlvbmFsIHVzYWdlIG9mIGNoZWNrUmVjdXJzaXZlVXBkYXRlIG11c3QgYmUgZGV0ZXJtaW5lZCBvdXQgb2YKICAgICAgLy8gdHJ5IC4uLiBjYXRjaCBibG9jayBzaW5jZSBSb2xsdXAgYnkgZGVmYXVsdCBkZS1vcHRpbWl6ZXMgdHJlZXNoYWtpbmcKICAgICAgLy8gaW5zaWRlIHRyeS1jYXRjaC4gVGhpcyBjYW4gbGVhdmUgYWxsIHdhcm5pbmcgY29kZSB1bnNoYWtlZC4gQWx0aG91Z2gKICAgICAgLy8gdGhleSB3b3VsZCBnZXQgZXZlbnR1YWxseSBzaGFrZW4gYnkgYSBtaW5pZmllciBsaWtlIHRlcnNlciwgc29tZSBtaW5pZmllcnMKICAgICAgLy8gd291bGQgZmFpbCB0byBkbyB0aGF0IChlLmcuIGh0dHBzOi8vZ2l0aHViLmNvbS9ldmFudy9lc2J1aWxkL2lzc3Vlcy8xNjEwKQogICAgICBjb25zdCBjaGVjayA9IChqb2IpID0+IGNoZWNrUmVjdXJzaXZlVXBkYXRlcyhzZWVuLCBqb2IpCiAgICAgICAgICA7CiAgICAgIHRyeSB7CiAgICAgICAgICBmb3IgKGZsdXNoSW5kZXggPSAwOyBmbHVzaEluZGV4IDwgcXVldWUubGVuZ3RoOyBmbHVzaEluZGV4KyspIHsKICAgICAgICAgICAgICBjb25zdCBqb2IgPSBxdWV1ZVtmbHVzaEluZGV4XTsKICAgICAgICAgICAgICBpZiAoam9iICYmIGpvYi5hY3RpdmUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0cnVlICYmIGNoZWNrKGpvYikpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBydW5uaW5nOmAsIGpvYi5pZCkKICAgICAgICAgICAgICAgICAgY2FsbFdpdGhFcnJvckhhbmRsaW5nKGpvYiwgbnVsbCwgMTQgLyogU0NIRURVTEVSICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZmluYWxseSB7CiAgICAgICAgICBmbHVzaEluZGV4ID0gMDsKICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICBmbHVzaFBvc3RGbHVzaENicyhzZWVuKTsKICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgIGN1cnJlbnRGbHVzaFByb21pc2UgPSBudWxsOwogICAgICAgICAgLy8gc29tZSBwb3N0Rmx1c2hDYiBxdWV1ZWQgam9icyEKICAgICAgICAgIC8vIGtlZXAgZmx1c2hpbmcgdW50aWwgaXQgZHJhaW5zLgogICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCB8fAogICAgICAgICAgICAgIHBlbmRpbmdQcmVGbHVzaENicy5sZW5ndGggfHwKICAgICAgICAgICAgICBwZW5kaW5nUG9zdEZsdXNoQ2JzLmxlbmd0aCkgewogICAgICAgICAgICAgIGZsdXNoSm9icyhzZWVuKTsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiBjaGVja1JlY3Vyc2l2ZVVwZGF0ZXMoc2VlbiwgZm4pIHsKICAgICAgaWYgKCFzZWVuLmhhcyhmbikpIHsKICAgICAgICAgIHNlZW4uc2V0KGZuLCAxKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gc2Vlbi5nZXQoZm4pOwogICAgICAgICAgaWYgKGNvdW50ID4gUkVDVVJTSU9OX0xJTUlUKSB7CiAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBmbi5vd25lckluc3RhbmNlOwogICAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBpbnN0YW5jZSAmJiBnZXRDb21wb25lbnROYW1lKGluc3RhbmNlLnR5cGUpOwogICAgICAgICAgICAgIHdhcm4kMShgTWF4aW11bSByZWN1cnNpdmUgdXBkYXRlcyBleGNlZWRlZCR7Y29tcG9uZW50TmFtZSA/IGAgaW4gY29tcG9uZW50IDwke2NvbXBvbmVudE5hbWV9PmAgOiBgYH0uIGAgKwogICAgICAgICAgICAgICAgICBgVGhpcyBtZWFucyB5b3UgaGF2ZSBhIHJlYWN0aXZlIGVmZmVjdCB0aGF0IGlzIG11dGF0aW5nIGl0cyBvd24gYCArCiAgICAgICAgICAgICAgICAgIGBkZXBlbmRlbmNpZXMgYW5kIHRodXMgcmVjdXJzaXZlbHkgdHJpZ2dlcmluZyBpdHNlbGYuIFBvc3NpYmxlIHNvdXJjZXMgYCArCiAgICAgICAgICAgICAgICAgIGBpbmNsdWRlIGNvbXBvbmVudCB0ZW1wbGF0ZSwgcmVuZGVyIGZ1bmN0aW9uLCB1cGRhdGVkIGhvb2sgb3IgYCArCiAgICAgICAgICAgICAgICAgIGB3YXRjaGVyIHNvdXJjZSBmdW5jdGlvbi5gKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHNlZW4uc2V0KGZuLCBjb3VudCArIDEpOwogICAgICAgICAgfQogICAgICB9CiAgfQoKICAvKiBlc2xpbnQtZGlzYWJsZSBuby1yZXN0cmljdGVkLWdsb2JhbHMgKi8KICBsZXQgaXNIbXJVcGRhdGluZyA9IGZhbHNlOwogIGNvbnN0IGhtckRpcnR5Q29tcG9uZW50cyA9IG5ldyBTZXQoKTsKICAvLyBFeHBvc2UgdGhlIEhNUiBydW50aW1lIG9uIHRoZSBnbG9iYWwgb2JqZWN0CiAgLy8gVGhpcyBtYWtlcyBpdCBlbnRpcmVseSB0cmVlLXNoYWthYmxlIHdpdGhvdXQgcG9sbHV0aW5nIHRoZSBleHBvcnRzIGFuZCBtYWtlcwogIC8vIGl0IGVhc2llciB0byBiZSB1c2VkIGluIHRvb2xpbmdzIGxpa2UgdnVlLWxvYWRlcgogIC8vIE5vdGU6IGZvciBhIGNvbXBvbmVudCB0byBiZSBlbGlnaWJsZSBmb3IgSE1SIGl0IGFsc28gbmVlZHMgdGhlIF9faG1ySWQgb3B0aW9uCiAgLy8gdG8gYmUgc2V0IHNvIHRoYXQgaXRzIGluc3RhbmNlcyBjYW4gYmUgcmVnaXN0ZXJlZCAvIHJlbW92ZWQuCiAgewogICAgICBnZXRHbG9iYWxUaGlzKCkuX19WVUVfSE1SX1JVTlRJTUVfXyA9IHsKICAgICAgICAgIGNyZWF0ZVJlY29yZDogdHJ5V3JhcChjcmVhdGVSZWNvcmQpLAogICAgICAgICAgcmVyZW5kZXI6IHRyeVdyYXAocmVyZW5kZXIpLAogICAgICAgICAgcmVsb2FkOiB0cnlXcmFwKHJlbG9hZCkKICAgICAgfTsKICB9CiAgY29uc3QgbWFwID0gbmV3IE1hcCgpOwogIGZ1bmN0aW9uIHJlZ2lzdGVySE1SKGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IGlkID0gaW5zdGFuY2UudHlwZS5fX2htcklkOwogICAgICBsZXQgcmVjb3JkID0gbWFwLmdldChpZCk7CiAgICAgIGlmICghcmVjb3JkKSB7CiAgICAgICAgICBjcmVhdGVSZWNvcmQoaWQsIGluc3RhbmNlLnR5cGUpOwogICAgICAgICAgcmVjb3JkID0gbWFwLmdldChpZCk7CiAgICAgIH0KICAgICAgcmVjb3JkLmluc3RhbmNlcy5hZGQoaW5zdGFuY2UpOwogIH0KICBmdW5jdGlvbiB1bnJlZ2lzdGVySE1SKGluc3RhbmNlKSB7CiAgICAgIG1hcC5nZXQoaW5zdGFuY2UudHlwZS5fX2htcklkKS5pbnN0YW5jZXMuZGVsZXRlKGluc3RhbmNlKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUmVjb3JkKGlkLCBpbml0aWFsRGVmKSB7CiAgICAgIGlmIChtYXAuaGFzKGlkKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIG1hcC5zZXQoaWQsIHsKICAgICAgICAgIGluaXRpYWxEZWY6IG5vcm1hbGl6ZUNsYXNzQ29tcG9uZW50KGluaXRpYWxEZWYpLAogICAgICAgICAgaW5zdGFuY2VzOiBuZXcgU2V0KCkKICAgICAgfSk7CiAgICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVDbGFzc0NvbXBvbmVudChjb21wb25lbnQpIHsKICAgICAgcmV0dXJuIGlzQ2xhc3NDb21wb25lbnQoY29tcG9uZW50KSA/IGNvbXBvbmVudC5fX3ZjY09wdHMgOiBjb21wb25lbnQ7CiAgfQogIGZ1bmN0aW9uIHJlcmVuZGVyKGlkLCBuZXdSZW5kZXIpIHsKICAgICAgY29uc3QgcmVjb3JkID0gbWFwLmdldChpZCk7CiAgICAgIGlmICghcmVjb3JkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gdXBkYXRlIGluaXRpYWwgcmVjb3JkIChmb3Igbm90LXlldC1yZW5kZXJlZCBjb21wb25lbnQpCiAgICAgIHJlY29yZC5pbml0aWFsRGVmLnJlbmRlciA9IG5ld1JlbmRlcjsKICAgICAgWy4uLnJlY29yZC5pbnN0YW5jZXNdLmZvckVhY2goaW5zdGFuY2UgPT4gewogICAgICAgICAgaWYgKG5ld1JlbmRlcikgewogICAgICAgICAgICAgIGluc3RhbmNlLnJlbmRlciA9IG5ld1JlbmRlcjsKICAgICAgICAgICAgICBub3JtYWxpemVDbGFzc0NvbXBvbmVudChpbnN0YW5jZS50eXBlKS5yZW5kZXIgPSBuZXdSZW5kZXI7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXJDYWNoZSA9IFtdOwogICAgICAgICAgLy8gdGhpcyBmbGFnIGZvcmNlcyBjaGlsZCBjb21wb25lbnRzIHdpdGggc2xvdCBjb250ZW50IHRvIHVwZGF0ZQogICAgICAgICAgaXNIbXJVcGRhdGluZyA9IHRydWU7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGUoKTsKICAgICAgICAgIGlzSG1yVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgfSk7CiAgfQogIGZ1bmN0aW9uIHJlbG9hZChpZCwgbmV3Q29tcCkgewogICAgICBjb25zdCByZWNvcmQgPSBtYXAuZ2V0KGlkKTsKICAgICAgaWYgKCFyZWNvcmQpCiAgICAgICAgICByZXR1cm47CiAgICAgIG5ld0NvbXAgPSBub3JtYWxpemVDbGFzc0NvbXBvbmVudChuZXdDb21wKTsKICAgICAgLy8gdXBkYXRlIGluaXRpYWwgZGVmIChmb3Igbm90LXlldC1yZW5kZXJlZCBjb21wb25lbnRzKQogICAgICB1cGRhdGVDb21wb25lbnREZWYocmVjb3JkLmluaXRpYWxEZWYsIG5ld0NvbXApOwogICAgICAvLyBjcmVhdGUgYSBzbmFwc2hvdCB3aGljaCBhdm9pZHMgdGhlIHNldCBiZWluZyBtdXRhdGVkIGR1cmluZyB1cGRhdGVzCiAgICAgIGNvbnN0IGluc3RhbmNlcyA9IFsuLi5yZWNvcmQuaW5zdGFuY2VzXTsKICAgICAgZm9yIChjb25zdCBpbnN0YW5jZSBvZiBpbnN0YW5jZXMpIHsKICAgICAgICAgIGNvbnN0IG9sZENvbXAgPSBub3JtYWxpemVDbGFzc0NvbXBvbmVudChpbnN0YW5jZS50eXBlKTsKICAgICAgICAgIGlmICghaG1yRGlydHlDb21wb25lbnRzLmhhcyhvbGRDb21wKSkgewogICAgICAgICAgICAgIC8vIDEuIFVwZGF0ZSBleGlzdGluZyBjb21wIGRlZmluaXRpb24gdG8gbWF0Y2ggbmV3IG9uZQogICAgICAgICAgICAgIGlmIChvbGRDb21wICE9PSByZWNvcmQuaW5pdGlhbERlZikgewogICAgICAgICAgICAgICAgICB1cGRhdGVDb21wb25lbnREZWYob2xkQ29tcCwgbmV3Q29tcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIDIuIG1hcmsgZGVmaW5pdGlvbiBkaXJ0eS4gVGhpcyBmb3JjZXMgdGhlIHJlbmRlcmVyIHRvIHJlcGxhY2UgdGhlCiAgICAgICAgICAgICAgLy8gY29tcG9uZW50IG9uIHBhdGNoLgogICAgICAgICAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5hZGQob2xkQ29tcCk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyAzLiBpbnZhbGlkYXRlIG9wdGlvbnMgcmVzb2x1dGlvbiBjYWNoZQogICAgICAgICAgaW5zdGFuY2UuYXBwQ29udGV4dC5vcHRpb25zQ2FjaGUuZGVsZXRlKGluc3RhbmNlLnR5cGUpOwogICAgICAgICAgLy8gNC4gYWN0dWFsbHkgdXBkYXRlCiAgICAgICAgICBpZiAoaW5zdGFuY2UuY2VSZWxvYWQpIHsKICAgICAgICAgICAgICAvLyBjdXN0b20gZWxlbWVudAogICAgICAgICAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5hZGQob2xkQ29tcCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY2VSZWxvYWQobmV3Q29tcC5zdHlsZXMpOwogICAgICAgICAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5kZWxldGUob2xkQ29tcCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpbnN0YW5jZS5wYXJlbnQpIHsKICAgICAgICAgICAgICAvLyA0LiBGb3JjZSB0aGUgcGFyZW50IGluc3RhbmNlIHRvIHJlLXJlbmRlci4gVGhpcyB3aWxsIGNhdXNlIGFsbCB1cGRhdGVkCiAgICAgICAgICAgICAgLy8gY29tcG9uZW50cyB0byBiZSB1bm1vdW50ZWQgYW5kIHJlLW1vdW50ZWQuIFF1ZXVlIHRoZSB1cGRhdGUgc28gdGhhdCB3ZQogICAgICAgICAgICAgIC8vIGRvbid0IGVuZCB1cCBmb3JjaW5nIHRoZSBzYW1lIHBhcmVudCB0byByZS1yZW5kZXIgbXVsdGlwbGUgdGltZXMuCiAgICAgICAgICAgICAgcXVldWVKb2IoaW5zdGFuY2UucGFyZW50LnVwZGF0ZSk7CiAgICAgICAgICAgICAgLy8gaW5zdGFuY2UgaXMgdGhlIGlubmVyIGNvbXBvbmVudCBvZiBhbiBhc3luYyBjdXN0b20gZWxlbWVudAogICAgICAgICAgICAgIC8vIGludm9rZSB0byByZXNldCBzdHlsZXMKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucGFyZW50LnR5cGUuX19hc3luY0xvYWRlciAmJgogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5wYXJlbnQuY2VSZWxvYWQpIHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucGFyZW50LmNlUmVsb2FkKG5ld0NvbXAuc3R5bGVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpbnN0YW5jZS5hcHBDb250ZXh0LnJlbG9hZCkgewogICAgICAgICAgICAgIC8vIHJvb3QgaW5zdGFuY2UgbW91bnRlZCB2aWEgY3JlYXRlQXBwKCkgaGFzIGEgcmVsb2FkIG1ldGhvZAogICAgICAgICAgICAgIGluc3RhbmNlLmFwcENvbnRleHQucmVsb2FkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgIC8vIHJvb3QgaW5zdGFuY2UgaW5zaWRlIHRyZWUgY3JlYXRlZCB2aWEgcmF3IHJlbmRlcigpLiBGb3JjZSByZWxvYWQuCiAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbSE1SXSBSb290IG9yIG1hbnVhbGx5IG1vdW50ZWQgaW5zdGFuY2UgbW9kaWZpZWQuIEZ1bGwgcmVsb2FkIHJlcXVpcmVkLicpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIDUuIG1ha2Ugc3VyZSB0byBjbGVhbnVwIGRpcnR5IGhtciBjb21wb25lbnRzIGFmdGVyIHVwZGF0ZQogICAgICBxdWV1ZVBvc3RGbHVzaENiKCgpID0+IHsKICAgICAgICAgIGZvciAoY29uc3QgaW5zdGFuY2Ugb2YgaW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgaG1yRGlydHlDb21wb25lbnRzLmRlbGV0ZShub3JtYWxpemVDbGFzc0NvbXBvbmVudChpbnN0YW5jZS50eXBlKSk7CiAgICAgICAgICB9CiAgICAgIH0pOwogIH0KICBmdW5jdGlvbiB1cGRhdGVDb21wb25lbnREZWYob2xkQ29tcCwgbmV3Q29tcCkgewogICAgICBleHRlbmQob2xkQ29tcCwgbmV3Q29tcCk7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG9sZENvbXApIHsKICAgICAgICAgIGlmIChrZXkgIT09ICdfX2ZpbGUnICYmICEoa2V5IGluIG5ld0NvbXApKSB7CiAgICAgICAgICAgICAgZGVsZXRlIG9sZENvbXBba2V5XTsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiB0cnlXcmFwKGZuKSB7CiAgICAgIHJldHVybiAoaWQsIGFyZykgPT4gewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gZm4oaWQsIGFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBbSE1SXSBTb21ldGhpbmcgd2VudCB3cm9uZyBkdXJpbmcgVnVlIGNvbXBvbmVudCBob3QtcmVsb2FkLiBgICsKICAgICAgICAgICAgICAgICAgYEZ1bGwgcmVsb2FkIHJlcXVpcmVkLmApOwogICAgICAgICAgfQogICAgICB9OwogIH0KCiAgbGV0IGJ1ZmZlciA9IFtdOwogIGxldCBkZXZ0b29sc05vdEluc3RhbGxlZCA9IGZhbHNlOwogIGZ1bmN0aW9uIGVtaXQoZXZlbnQsIC4uLmFyZ3MpIHsKICAgICAgaWYgKGV4cG9ydHMuZGV2dG9vbHMpIHsKICAgICAgICAgIGV4cG9ydHMuZGV2dG9vbHMuZW1pdChldmVudCwgLi4uYXJncyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIWRldnRvb2xzTm90SW5zdGFsbGVkKSB7CiAgICAgICAgICBidWZmZXIucHVzaCh7IGV2ZW50LCBhcmdzIH0pOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIHNldERldnRvb2xzSG9vayhob29rLCB0YXJnZXQpIHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgZXhwb3J0cy5kZXZ0b29scyA9IGhvb2s7CiAgICAgIGlmIChleHBvcnRzLmRldnRvb2xzKSB7CiAgICAgICAgICBleHBvcnRzLmRldnRvb2xzLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgYnVmZmVyLmZvckVhY2goKHsgZXZlbnQsIGFyZ3MgfSkgPT4gZXhwb3J0cy5kZXZ0b29scy5lbWl0KGV2ZW50LCAuLi5hcmdzKSk7CiAgICAgICAgICBidWZmZXIgPSBbXTsKICAgICAgfQogICAgICBlbHNlIGlmICgKICAgICAgLy8gaGFuZGxlIGxhdGUgZGV2dG9vbHMgaW5qZWN0aW9uIC0gb25seSBkbyB0aGlzIGlmIHdlIGFyZSBpbiBhbiBhY3R1YWwKICAgICAgLy8gYnJvd3NlciBlbnZpcm9ubWVudCB0byBhdm9pZCB0aGUgdGltZXIgaGFuZGxlIHN0YWxsaW5nIHRlc3QgcnVubmVyIGV4aXQKICAgICAgLy8gKCM0ODE1KQogICAgICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJgogICAgICAgICAgLy8gc29tZSBlbnZzIG1vY2sgd2luZG93IGJ1dCBub3QgZnVsbHkKICAgICAgICAgIHdpbmRvdy5IVE1MRWxlbWVudCAmJgogICAgICAgICAgLy8gYWxzbyBleGNsdWRlIGpzZG9tCiAgICAgICAgICAhKChfYiA9IChfYSA9IHdpbmRvdy5uYXZpZ2F0b3IpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS51c2VyQWdlbnQpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pbmNsdWRlcygnanNkb20nKSkpIHsKICAgICAgICAgIGNvbnN0IHJlcGxheSA9ICh0YXJnZXQuX19WVUVfREVWVE9PTFNfSE9PS19SRVBMQVlfXyA9CiAgICAgICAgICAgICAgdGFyZ2V0Ll9fVlVFX0RFVlRPT0xTX0hPT0tfUkVQTEFZX18gfHwgW10pOwogICAgICAgICAgcmVwbGF5LnB1c2goKG5ld0hvb2spID0+IHsKICAgICAgICAgICAgICBzZXREZXZ0b29sc0hvb2sobmV3SG9vaywgdGFyZ2V0KTsKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gY2xlYXIgYnVmZmVyIGFmdGVyIDNzIC0gdGhlIHVzZXIgcHJvYmFibHkgZG9lc24ndCBoYXZlIGRldnRvb2xzIGluc3RhbGxlZAogICAgICAgICAgLy8gYXQgYWxsLCBhbmQga2VlcGluZyB0aGUgYnVmZmVyIHdpbGwgY2F1c2UgbWVtb3J5IGxlYWtzICgjNDczOCkKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgIGlmICghZXhwb3J0cy5kZXZ0b29scykgewogICAgICAgICAgICAgICAgICB0YXJnZXQuX19WVUVfREVWVE9PTFNfSE9PS19SRVBMQVlfXyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGRldnRvb2xzTm90SW5zdGFsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSwgMzAwMCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBub24tYnJvd3NlciBlbnYsIGFzc3VtZSBub3QgaW5zdGFsbGVkCiAgICAgICAgICBkZXZ0b29sc05vdEluc3RhbGxlZCA9IHRydWU7CiAgICAgICAgICBidWZmZXIgPSBbXTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBkZXZ0b29sc0luaXRBcHAoYXBwLCB2ZXJzaW9uKSB7CiAgICAgIGVtaXQoImFwcDppbml0IiAvKiBBUFBfSU5JVCAqLywgYXBwLCB2ZXJzaW9uLCB7CiAgICAgICAgICBGcmFnbWVudCwKICAgICAgICAgIFRleHQsCiAgICAgICAgICBDb21tZW50LAogICAgICAgICAgU3RhdGljCiAgICAgIH0pOwogIH0KICBmdW5jdGlvbiBkZXZ0b29sc1VubW91bnRBcHAoYXBwKSB7CiAgICAgIGVtaXQoImFwcDp1bm1vdW50IiAvKiBBUFBfVU5NT1VOVCAqLywgYXBwKTsKICB9CiAgY29uc3QgZGV2dG9vbHNDb21wb25lbnRBZGRlZCA9IC8qI19fUFVSRV9fKi8gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKCJjb21wb25lbnQ6YWRkZWQiIC8qIENPTVBPTkVOVF9BRERFRCAqLyk7CiAgY29uc3QgZGV2dG9vbHNDb21wb25lbnRVcGRhdGVkID0gCiAgLyojX19QVVJFX18qLyBjcmVhdGVEZXZ0b29sc0NvbXBvbmVudEhvb2soImNvbXBvbmVudDp1cGRhdGVkIiAvKiBDT01QT05FTlRfVVBEQVRFRCAqLyk7CiAgY29uc3QgZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkID0gCiAgLyojX19QVVJFX18qLyBjcmVhdGVEZXZ0b29sc0NvbXBvbmVudEhvb2soImNvbXBvbmVudDpyZW1vdmVkIiAvKiBDT01QT05FTlRfUkVNT1ZFRCAqLyk7CiAgZnVuY3Rpb24gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKGhvb2spIHsKICAgICAgcmV0dXJuIChjb21wb25lbnQpID0+IHsKICAgICAgICAgIGVtaXQoaG9vaywgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLCBjb21wb25lbnQudWlkLCBjb21wb25lbnQucGFyZW50ID8gY29tcG9uZW50LnBhcmVudC51aWQgOiB1bmRlZmluZWQsIGNvbXBvbmVudCk7CiAgICAgIH07CiAgfQogIGNvbnN0IGRldnRvb2xzUGVyZlN0YXJ0ID0gLyojX19QVVJFX18qLyBjcmVhdGVEZXZ0b29sc1BlcmZvcm1hbmNlSG9vaygicGVyZjpzdGFydCIgLyogUEVSRk9STUFOQ0VfU1RBUlQgKi8pOwogIGNvbnN0IGRldnRvb2xzUGVyZkVuZCA9IC8qI19fUFVSRV9fKi8gY3JlYXRlRGV2dG9vbHNQZXJmb3JtYW5jZUhvb2soInBlcmY6ZW5kIiAvKiBQRVJGT1JNQU5DRV9FTkQgKi8pOwogIGZ1bmN0aW9uIGNyZWF0ZURldnRvb2xzUGVyZm9ybWFuY2VIb29rKGhvb2spIHsKICAgICAgcmV0dXJuIChjb21wb25lbnQsIHR5cGUsIHRpbWUpID0+IHsKICAgICAgICAgIGVtaXQoaG9vaywgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLCBjb21wb25lbnQudWlkLCBjb21wb25lbnQsIHR5cGUsIHRpbWUpOwogICAgICB9OwogIH0KICBmdW5jdGlvbiBkZXZ0b29sc0NvbXBvbmVudEVtaXQoY29tcG9uZW50LCBldmVudCwgcGFyYW1zKSB7CiAgICAgIGVtaXQoImNvbXBvbmVudDplbWl0IiAvKiBDT01QT05FTlRfRU1JVCAqLywgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLCBjb21wb25lbnQsIGV2ZW50LCBwYXJhbXMpOwogIH0KCiAgZnVuY3Rpb24gZW1pdCQxKGluc3RhbmNlLCBldmVudCwgLi4ucmF3QXJncykgewogICAgICBpZiAoaW5zdGFuY2UuaXNVbm1vdW50ZWQpCiAgICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IHByb3BzID0gaW5zdGFuY2Uudm5vZGUucHJvcHMgfHwgRU1QVFlfT0JKOwogICAgICB7CiAgICAgICAgICBjb25zdCB7IGVtaXRzT3B0aW9ucywgcHJvcHNPcHRpb25zOiBbcHJvcHNPcHRpb25zXSB9ID0gaW5zdGFuY2U7CiAgICAgICAgICBpZiAoZW1pdHNPcHRpb25zKSB7CiAgICAgICAgICAgICAgaWYgKCEoZXZlbnQgaW4gZW1pdHNPcHRpb25zKSAmJgogICAgICAgICAgICAgICAgICAhKGZhbHNlICkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFwcm9wc09wdGlvbnMgfHwgISh0b0hhbmRsZXJLZXkoZXZlbnQpIGluIHByb3BzT3B0aW9ucykpIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgQ29tcG9uZW50IGVtaXR0ZWQgZXZlbnQgIiR7ZXZlbnR9IiBidXQgaXQgaXMgbmVpdGhlciBkZWNsYXJlZCBpbiBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgdGhlIGVtaXRzIG9wdGlvbiBub3IgYXMgYW4gIiR7dG9IYW5kbGVyS2V5KGV2ZW50KX0iIHByb3AuYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IGVtaXRzT3B0aW9uc1tldmVudF07CiAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbGlkYXRvcikpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0b3IoLi4ucmF3QXJncyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEludmFsaWQgZXZlbnQgYXJndW1lbnRzOiBldmVudCB2YWxpZGF0aW9uIGZhaWxlZCBmb3IgZXZlbnQgIiR7ZXZlbnR9Ii5gKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBsZXQgYXJncyA9IHJhd0FyZ3M7CiAgICAgIGNvbnN0IGlzTW9kZWxMaXN0ZW5lciA9IGV2ZW50LnN0YXJ0c1dpdGgoJ3VwZGF0ZTonKTsKICAgICAgLy8gZm9yIHYtbW9kZWwgdXBkYXRlOnh4eCBldmVudHMsIGFwcGx5IG1vZGlmaWVycyBvbiBhcmdzCiAgICAgIGNvbnN0IG1vZGVsQXJnID0gaXNNb2RlbExpc3RlbmVyICYmIGV2ZW50LnNsaWNlKDcpOwogICAgICBpZiAobW9kZWxBcmcgJiYgbW9kZWxBcmcgaW4gcHJvcHMpIHsKICAgICAgICAgIGNvbnN0IG1vZGlmaWVyc0tleSA9IGAke21vZGVsQXJnID09PSAnbW9kZWxWYWx1ZScgPyAnbW9kZWwnIDogbW9kZWxBcmd9TW9kaWZpZXJzYDsKICAgICAgICAgIGNvbnN0IHsgbnVtYmVyLCB0cmltIH0gPSBwcm9wc1ttb2RpZmllcnNLZXldIHx8IEVNUFRZX09CSjsKICAgICAgICAgIGlmICh0cmltKSB7CiAgICAgICAgICAgICAgYXJncyA9IHJhd0FyZ3MubWFwKGEgPT4gYS50cmltKCkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG51bWJlcikgewogICAgICAgICAgICAgIGFyZ3MgPSByYXdBcmdzLm1hcCh0b051bWJlcik7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgewogICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRFbWl0KGluc3RhbmNlLCBldmVudCwgYXJncyk7CiAgICAgIH0KICAgICAgewogICAgICAgICAgY29uc3QgbG93ZXJDYXNlRXZlbnQgPSBldmVudC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKGxvd2VyQ2FzZUV2ZW50ICE9PSBldmVudCAmJiBwcm9wc1t0b0hhbmRsZXJLZXkobG93ZXJDYXNlRXZlbnQpXSkgewogICAgICAgICAgICAgIHdhcm4kMShgRXZlbnQgIiR7bG93ZXJDYXNlRXZlbnR9IiBpcyBlbWl0dGVkIGluIGNvbXBvbmVudCBgICsKICAgICAgICAgICAgICAgICAgYCR7Zm9ybWF0Q29tcG9uZW50TmFtZShpbnN0YW5jZSwgaW5zdGFuY2UudHlwZSl9IGJ1dCB0aGUgaGFuZGxlciBpcyByZWdpc3RlcmVkIGZvciAiJHtldmVudH0iLiBgICsKICAgICAgICAgICAgICAgICAgYE5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIHlvdSBjYW5ub3QgdXNlIGAgKwogICAgICAgICAgICAgICAgICBgdi1vbiB0byBsaXN0ZW4gdG8gY2FtZWxDYXNlIGV2ZW50cyB3aGVuIHVzaW5nIGluLURPTSB0ZW1wbGF0ZXMuIGAgKwogICAgICAgICAgICAgICAgICBgWW91IHNob3VsZCBwcm9iYWJseSB1c2UgIiR7aHlwaGVuYXRlKGV2ZW50KX0iIGluc3RlYWQgb2YgIiR7ZXZlbnR9Ii5gKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBsZXQgaGFuZGxlck5hbWU7CiAgICAgIGxldCBoYW5kbGVyID0gcHJvcHNbKGhhbmRsZXJOYW1lID0gdG9IYW5kbGVyS2V5KGV2ZW50KSldIHx8CiAgICAgICAgICAvLyBhbHNvIHRyeSBjYW1lbENhc2UgZXZlbnQgaGFuZGxlciAoIzIyNDkpCiAgICAgICAgICBwcm9wc1soaGFuZGxlck5hbWUgPSB0b0hhbmRsZXJLZXkoY2FtZWxpemUoZXZlbnQpKSldOwogICAgICAvLyBmb3Igdi1tb2RlbCB1cGRhdGU6eHh4IGV2ZW50cywgYWxzbyB0cmlnZ2VyIGtlYmFiLWNhc2UgZXF1aXZhbGVudAogICAgICAvLyBmb3IgcHJvcHMgcGFzc2VkIHZpYSBrZWJhYi1jYXNlCiAgICAgIGlmICghaGFuZGxlciAmJiBpc01vZGVsTGlzdGVuZXIpIHsKICAgICAgICAgIGhhbmRsZXIgPSBwcm9wc1soaGFuZGxlck5hbWUgPSB0b0hhbmRsZXJLZXkoaHlwaGVuYXRlKGV2ZW50KSkpXTsKICAgICAgfQogICAgICBpZiAoaGFuZGxlcikgewogICAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoaGFuZGxlciwgaW5zdGFuY2UsIDYgLyogQ09NUE9ORU5UX0VWRU5UX0hBTkRMRVIgKi8sIGFyZ3MpOwogICAgICB9CiAgICAgIGNvbnN0IG9uY2VIYW5kbGVyID0gcHJvcHNbaGFuZGxlck5hbWUgKyBgT25jZWBdOwogICAgICBpZiAob25jZUhhbmRsZXIpIHsKICAgICAgICAgIGlmICghaW5zdGFuY2UuZW1pdHRlZCkgewogICAgICAgICAgICAgIGluc3RhbmNlLmVtaXR0ZWQgPSB7fTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGluc3RhbmNlLmVtaXR0ZWRbaGFuZGxlck5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UuZW1pdHRlZFtoYW5kbGVyTmFtZV0gPSB0cnVlOwogICAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcob25jZUhhbmRsZXIsIGluc3RhbmNlLCA2IC8qIENPTVBPTkVOVF9FVkVOVF9IQU5ETEVSICovLCBhcmdzKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBub3JtYWxpemVFbWl0c09wdGlvbnMoY29tcCwgYXBwQ29udGV4dCwgYXNNaXhpbiA9IGZhbHNlKSB7CiAgICAgIGNvbnN0IGNhY2hlID0gYXBwQ29udGV4dC5lbWl0c0NhY2hlOwogICAgICBjb25zdCBjYWNoZWQgPSBjYWNoZS5nZXQoY29tcCk7CiAgICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgfQogICAgICBjb25zdCByYXcgPSBjb21wLmVtaXRzOwogICAgICBsZXQgbm9ybWFsaXplZCA9IHt9OwogICAgICAvLyBhcHBseSBtaXhpbi9leHRlbmRzIHByb3BzCiAgICAgIGxldCBoYXNFeHRlbmRzID0gZmFsc2U7CiAgICAgIGlmICghaXNGdW5jdGlvbihjb21wKSkgewogICAgICAgICAgY29uc3QgZXh0ZW5kRW1pdHMgPSAocmF3KSA9PiB7CiAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZEZyb21FeHRlbmQgPSBub3JtYWxpemVFbWl0c09wdGlvbnMocmF3LCBhcHBDb250ZXh0LCB0cnVlKTsKICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZEZyb21FeHRlbmQpIHsKICAgICAgICAgICAgICAgICAgaGFzRXh0ZW5kcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGV4dGVuZChub3JtYWxpemVkLCBub3JtYWxpemVkRnJvbUV4dGVuZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGlmICghYXNNaXhpbiAmJiBhcHBDb250ZXh0Lm1peGlucy5sZW5ndGgpIHsKICAgICAgICAgICAgICBhcHBDb250ZXh0Lm1peGlucy5mb3JFYWNoKGV4dGVuZEVtaXRzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21wLmV4dGVuZHMpIHsKICAgICAgICAgICAgICBleHRlbmRFbWl0cyhjb21wLmV4dGVuZHMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXAubWl4aW5zKSB7CiAgICAgICAgICAgICAgY29tcC5taXhpbnMuZm9yRWFjaChleHRlbmRFbWl0cyk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFyYXcgJiYgIWhhc0V4dGVuZHMpIHsKICAgICAgICAgIGNhY2hlLnNldChjb21wLCBudWxsKTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5KHJhdykpIHsKICAgICAgICAgIHJhdy5mb3JFYWNoKGtleSA9PiAobm9ybWFsaXplZFtrZXldID0gbnVsbCkpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgZXh0ZW5kKG5vcm1hbGl6ZWQsIHJhdyk7CiAgICAgIH0KICAgICAgY2FjaGUuc2V0KGNvbXAsIG5vcm1hbGl6ZWQpOwogICAgICByZXR1cm4gbm9ybWFsaXplZDsKICB9CiAgLy8gQ2hlY2sgaWYgYW4gaW5jb21pbmcgcHJvcCBrZXkgaXMgYSBkZWNsYXJlZCBlbWl0IGV2ZW50IGxpc3RlbmVyLgogIC8vIGUuZy4gV2l0aCBgZW1pdHM6IHsgY2xpY2s6IG51bGwgfWAsIHByb3BzIG5hbWVkIGBvbkNsaWNrYCBhbmQgYG9uY2xpY2tgIGFyZQogIC8vIGJvdGggY29uc2lkZXJlZCBtYXRjaGVkIGxpc3RlbmVycy4KICBmdW5jdGlvbiBpc0VtaXRMaXN0ZW5lcihvcHRpb25zLCBrZXkpIHsKICAgICAgaWYgKCFvcHRpb25zIHx8ICFpc09uKGtleSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBrZXkgPSBrZXkuc2xpY2UoMikucmVwbGFjZSgvT25jZSQvLCAnJyk7CiAgICAgIHJldHVybiAoaGFzT3duKG9wdGlvbnMsIGtleVswXS50b0xvd2VyQ2FzZSgpICsga2V5LnNsaWNlKDEpKSB8fAogICAgICAgICAgaGFzT3duKG9wdGlvbnMsIGh5cGhlbmF0ZShrZXkpKSB8fAogICAgICAgICAgaGFzT3duKG9wdGlvbnMsIGtleSkpOwogIH0KCiAgLyoqCiAgICogbWFyayB0aGUgY3VycmVudCByZW5kZXJpbmcgaW5zdGFuY2UgZm9yIGFzc2V0IHJlc29sdXRpb24gKGUuZy4KICAgKiByZXNvbHZlQ29tcG9uZW50LCByZXNvbHZlRGlyZWN0aXZlKSBkdXJpbmcgcmVuZGVyCiAgICovCiAgbGV0IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CiAgbGV0IGN1cnJlbnRTY29wZUlkID0gbnVsbDsKICAvKioKICAgKiBOb3RlOiByZW5kZXJpbmcgY2FsbHMgbWF5YmUgbmVzdGVkLiBUaGUgZnVuY3Rpb24gcmV0dXJucyB0aGUgcGFyZW50IHJlbmRlcmluZwogICAqIGluc3RhbmNlIGlmIHByZXNlbnQsIHdoaWNoIHNob3VsZCBiZSByZXN0b3JlZCBhZnRlciB0aGUgcmVuZGVyIGlzIGRvbmU6CiAgICoKICAgKiBgYGBqcwogICAqIGNvbnN0IHByZXYgPSBzZXRDdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UoaSkKICAgKiAvLyAuLi5yZW5kZXIKICAgKiBzZXRDdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UocHJldikKICAgKiBgYGAKICAgKi8KICBmdW5jdGlvbiBzZXRDdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgY29uc3QgcHJldiA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICAgICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgIGN1cnJlbnRTY29wZUlkID0gKGluc3RhbmNlICYmIGluc3RhbmNlLnR5cGUuX19zY29wZUlkKSB8fCBudWxsOwogICAgICByZXR1cm4gcHJldjsKICB9CiAgLyoqCiAgICogU2V0IHNjb3BlIGlkIHdoZW4gY3JlYXRpbmcgaG9pc3RlZCB2bm9kZXMuCiAgICogQHByaXZhdGUgY29tcGlsZXIgaGVscGVyCiAgICovCiAgZnVuY3Rpb24gcHVzaFNjb3BlSWQoaWQpIHsKICAgICAgY3VycmVudFNjb3BlSWQgPSBpZDsKICB9CiAgLyoqCiAgICogVGVjaG5pY2FsbHkgd2Ugbm8gbG9uZ2VyIG5lZWQgdGhpcyBhZnRlciAzLjAuOCBidXQgd2UgbmVlZCB0byBrZWVwIHRoZSBzYW1lCiAgICogQVBJIGZvciBiYWNrd2FyZHMgY29tcGF0IHcvIGNvZGUgZ2VuZXJhdGVkIGJ5IGNvbXBpbGVycy4KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHBvcFNjb3BlSWQoKSB7CiAgICAgIGN1cnJlbnRTY29wZUlkID0gbnVsbDsKICB9CiAgLyoqCiAgICogT25seSBmb3IgYmFja3dhcmRzIGNvbXBhdAogICAqIEBwcml2YXRlCiAgICovCiAgY29uc3Qgd2l0aFNjb3BlSWQgPSAoX2lkKSA9PiB3aXRoQ3R4OwogIC8qKgogICAqIFdyYXAgYSBzbG90IGZ1bmN0aW9uIHRvIG1lbW9pemUgY3VycmVudCByZW5kZXJpbmcgaW5zdGFuY2UKICAgKiBAcHJpdmF0ZSBjb21waWxlciBoZWxwZXIKICAgKi8KICBmdW5jdGlvbiB3aXRoQ3R4KGZuLCBjdHggPSBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UsIGlzTm9uU2NvcGVkU2xvdCAvLyBmYWxzZSBvbmx5CiAgKSB7CiAgICAgIGlmICghY3R4KQogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAvLyBhbHJlYWR5IG5vcm1hbGl6ZWQKICAgICAgaWYgKGZuLl9uKSB7CiAgICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KICAgICAgY29uc3QgcmVuZGVyRm5XaXRoQ29udGV4dCA9ICguLi5hcmdzKSA9PiB7CiAgICAgICAgICAvLyBJZiBhIHVzZXIgY2FsbHMgYSBjb21waWxlZCBzbG90IGluc2lkZSBhIHRlbXBsYXRlIGV4cHJlc3Npb24gKCMxNzQ1KSwgaXQKICAgICAgICAgIC8vIGNhbiBtZXNzIHVwIGJsb2NrIHRyYWNraW5nLCBzbyBieSBkZWZhdWx0IHdlIGRpc2FibGUgYmxvY2sgdHJhY2tpbmcgYW5kCiAgICAgICAgICAvLyBmb3JjZSBiYWlsIG91dCB3aGVuIGludm9raW5nIGEgY29tcGlsZWQgc2xvdCAoaW5kaWNhdGVkIGJ5IHRoZSAuX2QgZmxhZykuCiAgICAgICAgICAvLyBUaGlzIGlzbid0IG5lY2Vzc2FyeSBpZiByZW5kZXJpbmcgYSBjb21waWxlZCBgPHNsb3Q+YCwgc28gd2UgZmxpcCB0aGUKICAgICAgICAgIC8vIC5fZCBmbGFnIG9mZiB3aGVuIGludm9raW5nIHRoZSB3cmFwcGVkIGZuIGluc2lkZSBgcmVuZGVyU2xvdGAuCiAgICAgICAgICBpZiAocmVuZGVyRm5XaXRoQ29udGV4dC5fZCkgewogICAgICAgICAgICAgIHNldEJsb2NrVHJhY2tpbmcoLTEpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcHJldkluc3RhbmNlID0gc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKGN0eCk7CiAgICAgICAgICBjb25zdCByZXMgPSBmbiguLi5hcmdzKTsKICAgICAgICAgIHNldEN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZShwcmV2SW5zdGFuY2UpOwogICAgICAgICAgaWYgKHJlbmRlckZuV2l0aENvbnRleHQuX2QpIHsKICAgICAgICAgICAgICBzZXRCbG9ja1RyYWNraW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50VXBkYXRlZChjdHgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgfTsKICAgICAgLy8gbWFyayBub3JtYWxpemVkIHRvIGF2b2lkIGR1cGxpY2F0ZWQgd3JhcHBpbmcKICAgICAgcmVuZGVyRm5XaXRoQ29udGV4dC5fbiA9IHRydWU7CiAgICAgIC8vIG1hcmsgdGhpcyBhcyBjb21waWxlZCBieSBkZWZhdWx0CiAgICAgIC8vIHRoaXMgaXMgdXNlZCBpbiB2bm9kZS50cyAtPiBub3JtYWxpemVDaGlsZHJlbigpIHRvIHNldCB0aGUgc2xvdAogICAgICAvLyByZW5kZXJpbmcgZmxhZy4KICAgICAgcmVuZGVyRm5XaXRoQ29udGV4dC5fYyA9IHRydWU7CiAgICAgIC8vIGRpc2FibGUgYmxvY2sgdHJhY2tpbmcgYnkgZGVmYXVsdAogICAgICByZW5kZXJGbldpdGhDb250ZXh0Ll9kID0gdHJ1ZTsKICAgICAgcmV0dXJuIHJlbmRlckZuV2l0aENvbnRleHQ7CiAgfQoKICAvKioKICAgKiBkZXYgb25seSBmbGFnIHRvIHRyYWNrIHdoZXRoZXIgJGF0dHJzIHdhcyB1c2VkIGR1cmluZyByZW5kZXIuCiAgICogSWYgJGF0dHJzIHdhcyB1c2VkIGR1cmluZyByZW5kZXIgdGhlbiB0aGUgd2FybmluZyBmb3IgZmFpbGVkIGF0dHJzCiAgICogZmFsbHRocm91Z2ggY2FuIGJlIHN1cHByZXNzZWQuCiAgICovCiAgbGV0IGFjY2Vzc2VkQXR0cnMgPSBmYWxzZTsKICBmdW5jdGlvbiBtYXJrQXR0cnNBY2Nlc3NlZCgpIHsKICAgICAgYWNjZXNzZWRBdHRycyA9IHRydWU7CiAgfQogIGZ1bmN0aW9uIHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpIHsKICAgICAgY29uc3QgeyB0eXBlOiBDb21wb25lbnQsIHZub2RlLCBwcm94eSwgd2l0aFByb3h5LCBwcm9wcywgcHJvcHNPcHRpb25zOiBbcHJvcHNPcHRpb25zXSwgc2xvdHMsIGF0dHJzLCBlbWl0LCByZW5kZXIsIHJlbmRlckNhY2hlLCBkYXRhLCBzZXR1cFN0YXRlLCBjdHgsIGluaGVyaXRBdHRycyB9ID0gaW5zdGFuY2U7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIGxldCBmYWxsdGhyb3VnaEF0dHJzOwogICAgICBjb25zdCBwcmV2ID0gc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgewogICAgICAgICAgYWNjZXNzZWRBdHRycyA9IGZhbHNlOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgNCAvKiBTVEFURUZVTF9DT01QT05FTlQgKi8pIHsKICAgICAgICAgICAgICAvLyB3aXRoUHJveHkgaXMgYSBwcm94eSB3aXRoIGEgZGlmZmVyZW50IGBoYXNgIHRyYXAgb25seSBmb3IKICAgICAgICAgICAgICAvLyBydW50aW1lLWNvbXBpbGVkIHJlbmRlciBmdW5jdGlvbnMgdXNpbmcgYHdpdGhgIGJsb2NrLgogICAgICAgICAgICAgIGNvbnN0IHByb3h5VG9Vc2UgPSB3aXRoUHJveHkgfHwgcHJveHk7CiAgICAgICAgICAgICAgcmVzdWx0ID0gbm9ybWFsaXplVk5vZGUocmVuZGVyLmNhbGwocHJveHlUb1VzZSwgcHJveHlUb1VzZSwgcmVuZGVyQ2FjaGUsIHByb3BzLCBzZXR1cFN0YXRlLCBkYXRhLCBjdHgpKTsKICAgICAgICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gYXR0cnM7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyBmdW5jdGlvbmFsCiAgICAgICAgICAgICAgY29uc3QgcmVuZGVyID0gQ29tcG9uZW50OwogICAgICAgICAgICAgIC8vIGluIGRldiwgbWFyayBhdHRycyBhY2Nlc3NlZCBpZiBvcHRpb25hbCBwcm9wcyAoYXR0cnMgPT09IHByb3BzKQogICAgICAgICAgICAgIGlmICh0cnVlICYmIGF0dHJzID09PSBwcm9wcykgewogICAgICAgICAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHQgPSBub3JtYWxpemVWTm9kZShyZW5kZXIubGVuZ3RoID4gMQogICAgICAgICAgICAgICAgICA/IHJlbmRlcihwcm9wcywgdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0IGF0dHJzKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICBzbG90cywKICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICA6IHsgYXR0cnMsIHNsb3RzLCBlbWl0IH0pCiAgICAgICAgICAgICAgICAgIDogcmVuZGVyKHByb3BzLCBudWxsIC8qIHdlIGtub3cgaXQgZG9lc24ndCBuZWVkIGl0ICovKSk7CiAgICAgICAgICAgICAgZmFsbHRocm91Z2hBdHRycyA9IENvbXBvbmVudC5wcm9wcwogICAgICAgICAgICAgICAgICA/IGF0dHJzCiAgICAgICAgICAgICAgICAgIDogZ2V0RnVuY3Rpb25hbEZhbGx0aHJvdWdoKGF0dHJzKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBibG9ja1N0YWNrLmxlbmd0aCA9IDA7CiAgICAgICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCAxIC8qIFJFTkRFUl9GVU5DVElPTiAqLyk7CiAgICAgICAgICByZXN1bHQgPSBjcmVhdGVWTm9kZShDb21tZW50KTsKICAgICAgfQogICAgICAvLyBhdHRyIG1lcmdpbmcKICAgICAgLy8gaW4gZGV2IG1vZGUsIGNvbW1lbnRzIGFyZSBwcmVzZXJ2ZWQsIGFuZCBpdCdzIHBvc3NpYmxlIGZvciBhIHRlbXBsYXRlCiAgICAgIC8vIHRvIGhhdmUgY29tbWVudHMgYWxvbmcgc2lkZSB0aGUgcm9vdCBlbGVtZW50IHdoaWNoIG1ha2VzIGl0IGEgZnJhZ21lbnQKICAgICAgbGV0IHJvb3QgPSByZXN1bHQ7CiAgICAgIGxldCBzZXRSb290ID0gdW5kZWZpbmVkOwogICAgICBpZiAocmVzdWx0LnBhdGNoRmxhZyA+IDAgJiYKICAgICAgICAgIHJlc3VsdC5wYXRjaEZsYWcgJiAyMDQ4IC8qIERFVl9ST09UX0ZSQUdNRU5UICovKSB7CiAgICAgICAgICBbcm9vdCwgc2V0Um9vdF0gPSBnZXRDaGlsZFJvb3QocmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoZmFsbHRocm91Z2hBdHRycyAmJiBpbmhlcml0QXR0cnMgIT09IGZhbHNlKSB7CiAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZmFsbHRocm91Z2hBdHRycyk7CiAgICAgICAgICBjb25zdCB7IHNoYXBlRmxhZyB9ID0gcm9vdDsKICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAoMSAvKiBFTEVNRU5UICovIHwgNiAvKiBDT01QT05FTlQgKi8pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcm9wc09wdGlvbnMgJiYga2V5cy5zb21lKGlzTW9kZWxMaXN0ZW5lcikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGEgdi1tb2RlbCBsaXN0ZW5lciAob25VcGRhdGU6eHh4KSBoYXMgYSBjb3JyZXNwb25kaW5nIGRlY2xhcmVkCiAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9wLCBpdCBpbmRpY2F0ZXMgdGhpcyBjb21wb25lbnQgZXhwZWN0cyB0byBoYW5kbGUgdi1tb2RlbCBhbmQKICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHNob3VsZCBub3QgZmFsbHRocm91Z2guCiAgICAgICAgICAgICAgICAgICAgICAvLyByZWxhdGVkOiAjMTU0MywgIzE2NDMsICMxOTg5CiAgICAgICAgICAgICAgICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gZmlsdGVyTW9kZWxMaXN0ZW5lcnMoZmFsbHRocm91Z2hBdHRycywgcHJvcHNPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByb290ID0gY2xvbmVWTm9kZShyb290LCBmYWxsdGhyb3VnaEF0dHJzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoIWFjY2Vzc2VkQXR0cnMgJiYgcm9vdC50eXBlICE9PSBDb21tZW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFsbEF0dHJzID0gT2JqZWN0LmtleXMoYXR0cnMpOwogICAgICAgICAgICAgICAgICBjb25zdCBldmVudEF0dHJzID0gW107CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV4dHJhQXR0cnMgPSBbXTsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhbGxBdHRycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGFsbEF0dHJzW2ldOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT24oa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSB2LW1vZGVsIGhhbmRsZXJzIHdoZW4gdGhleSBmYWlsIHRvIGZhbGx0aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc01vZGVsTGlzdGVuZXIoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYG9uYCwgbG93ZXJjYXNlIGZpcnN0IGxldHRlciB0byByZWZsZWN0IGV2ZW50IGNhc2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhY2N1cmF0ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50QXR0cnMucHVzaChrZXlbMl0udG9Mb3dlckNhc2UoKSArIGtleS5zbGljZSgzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRycy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGV4dHJhQXR0cnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEV4dHJhbmVvdXMgbm9uLXByb3BzIGF0dHJpYnV0ZXMgKGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGAke2V4dHJhQXR0cnMuam9pbignLCAnKX0pIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGB3ZXJlIHBhc3NlZCB0byBjb21wb25lbnQgYnV0IGNvdWxkIG5vdCBiZSBhdXRvbWF0aWNhbGx5IGluaGVyaXRlZCBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgYmVjYXVzZSBjb21wb25lbnQgcmVuZGVycyBmcmFnbWVudCBvciB0ZXh0IHJvb3Qgbm9kZXMuYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50QXR0cnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEV4dHJhbmVvdXMgbm9uLWVtaXRzIGV2ZW50IGxpc3RlbmVycyAoYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7ZXZlbnRBdHRycy5qb2luKCcsICcpfSkgYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYHdlcmUgcGFzc2VkIHRvIGNvbXBvbmVudCBidXQgY291bGQgbm90IGJlIGF1dG9tYXRpY2FsbHkgaW5oZXJpdGVkIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGBiZWNhdXNlIGNvbXBvbmVudCByZW5kZXJzIGZyYWdtZW50IG9yIHRleHQgcm9vdCBub2Rlcy4gYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYElmIHRoZSBsaXN0ZW5lciBpcyBpbnRlbmRlZCB0byBiZSBhIGNvbXBvbmVudCBjdXN0b20gZXZlbnQgbGlzdGVuZXIgb25seSwgYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYGRlY2xhcmUgaXQgdXNpbmcgdGhlICJlbWl0cyIgb3B0aW9uLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGluaGVyaXQgZGlyZWN0aXZlcwogICAgICBpZiAodm5vZGUuZGlycykgewogICAgICAgICAgaWYgKCFpc0VsZW1lbnRSb290KHJvb3QpKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBSdW50aW1lIGRpcmVjdGl2ZSB1c2VkIG9uIGNvbXBvbmVudCB3aXRoIG5vbi1lbGVtZW50IHJvb3Qgbm9kZS4gYCArCiAgICAgICAgICAgICAgICAgIGBUaGUgZGlyZWN0aXZlcyB3aWxsIG5vdCBmdW5jdGlvbiBhcyBpbnRlbmRlZC5gKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGNsb25lIGJlZm9yZSBtdXRhdGluZyBzaW5jZSB0aGUgcm9vdCBtYXkgYmUgYSBob2lzdGVkIHZub2RlCiAgICAgICAgICByb290ID0gY2xvbmVWTm9kZShyb290KTsKICAgICAgICAgIHJvb3QuZGlycyA9IHJvb3QuZGlycyA/IHJvb3QuZGlycy5jb25jYXQodm5vZGUuZGlycykgOiB2bm9kZS5kaXJzOwogICAgICB9CiAgICAgIC8vIGluaGVyaXQgdHJhbnNpdGlvbiBkYXRhCiAgICAgIGlmICh2bm9kZS50cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAoIWlzRWxlbWVudFJvb3Qocm9vdCkpIHsKICAgICAgICAgICAgICB3YXJuJDEoYENvbXBvbmVudCBpbnNpZGUgPFRyYW5zaXRpb24+IHJlbmRlcnMgbm9uLWVsZW1lbnQgcm9vdCBub2RlIGAgKwogICAgICAgICAgICAgICAgICBgdGhhdCBjYW5ub3QgYmUgYW5pbWF0ZWQuYCk7CiAgICAgICAgICB9CiAgICAgICAgICByb290LnRyYW5zaXRpb24gPSB2bm9kZS50cmFuc2l0aW9uOwogICAgICB9CiAgICAgIGlmIChzZXRSb290KSB7CiAgICAgICAgICBzZXRSb290KHJvb3QpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgcmVzdWx0ID0gcm9vdDsKICAgICAgfQogICAgICBzZXRDdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UocHJldik7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgfQogIC8qKgogICAqIGRldiBvbmx5CiAgICogSW4gZGV2IG1vZGUsIHRlbXBsYXRlIHJvb3QgbGV2ZWwgY29tbWVudHMgYXJlIHJlbmRlcmVkLCB3aGljaCB0dXJucyB0aGUKICAgKiB0ZW1wbGF0ZSBpbnRvIGEgZnJhZ21lbnQgcm9vdCwgYnV0IHdlIG5lZWQgdG8gbG9jYXRlIHRoZSBzaW5nbGUgZWxlbWVudAogICAqIHJvb3QgZm9yIGF0dHJzIGFuZCBzY29wZSBpZCBwcm9jZXNzaW5nLgogICAqLwogIGNvbnN0IGdldENoaWxkUm9vdCA9ICh2bm9kZSkgPT4gewogICAgICBjb25zdCByYXdDaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgICBjb25zdCBkeW5hbWljQ2hpbGRyZW4gPSB2bm9kZS5keW5hbWljQ2hpbGRyZW47CiAgICAgIGNvbnN0IGNoaWxkUm9vdCA9IGZpbHRlclNpbmdsZVJvb3QocmF3Q2hpbGRyZW4pOwogICAgICBpZiAoIWNoaWxkUm9vdCkgewogICAgICAgICAgcmV0dXJuIFt2bm9kZSwgdW5kZWZpbmVkXTsKICAgICAgfQogICAgICBjb25zdCBpbmRleCA9IHJhd0NoaWxkcmVuLmluZGV4T2YoY2hpbGRSb290KTsKICAgICAgY29uc3QgZHluYW1pY0luZGV4ID0gZHluYW1pY0NoaWxkcmVuID8gZHluYW1pY0NoaWxkcmVuLmluZGV4T2YoY2hpbGRSb290KSA6IC0xOwogICAgICBjb25zdCBzZXRSb290ID0gKHVwZGF0ZWRSb290KSA9PiB7CiAgICAgICAgICByYXdDaGlsZHJlbltpbmRleF0gPSB1cGRhdGVkUm9vdDsKICAgICAgICAgIGlmIChkeW5hbWljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICBpZiAoZHluYW1pY0luZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgICAgZHluYW1pY0NoaWxkcmVuW2R5bmFtaWNJbmRleF0gPSB1cGRhdGVkUm9vdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAodXBkYXRlZFJvb3QucGF0Y2hGbGFnID4gMCkgewogICAgICAgICAgICAgICAgICB2bm9kZS5keW5hbWljQ2hpbGRyZW4gPSBbLi4uZHluYW1pY0NoaWxkcmVuLCB1cGRhdGVkUm9vdF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gW25vcm1hbGl6ZVZOb2RlKGNoaWxkUm9vdCksIHNldFJvb3RdOwogIH07CiAgZnVuY3Rpb24gZmlsdGVyU2luZ2xlUm9vdChjaGlsZHJlbikgewogICAgICBsZXQgc2luZ2xlUm9vdDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgIGlmIChpc1ZOb2RlKGNoaWxkKSkgewogICAgICAgICAgICAgIC8vIGlnbm9yZSB1c2VyIGNvbW1lbnQKICAgICAgICAgICAgICBpZiAoY2hpbGQudHlwZSAhPT0gQ29tbWVudCB8fCBjaGlsZC5jaGlsZHJlbiA9PT0gJ3YtaWYnKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzaW5nbGVSb290KSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBoYXMgbW9yZSB0aGFuIDEgbm9uLWNvbW1lbnQgY2hpbGQsIHJldHVybiBub3cKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHNpbmdsZVJvb3QgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2luZ2xlUm9vdDsKICB9CiAgY29uc3QgZ2V0RnVuY3Rpb25hbEZhbGx0aHJvdWdoID0gKGF0dHJzKSA9PiB7CiAgICAgIGxldCByZXM7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAnY2xhc3MnIHx8IGtleSA9PT0gJ3N0eWxlJyB8fCBpc09uKGtleSkpIHsKICAgICAgICAgICAgICAocmVzIHx8IChyZXMgPSB7fSkpW2tleV0gPSBhdHRyc1trZXldOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXM7CiAgfTsKICBjb25zdCBmaWx0ZXJNb2RlbExpc3RlbmVycyA9IChhdHRycywgcHJvcHMpID0+IHsKICAgICAgY29uc3QgcmVzID0ge307CiAgICAgIGZvciAoY29uc3Qga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoIWlzTW9kZWxMaXN0ZW5lcihrZXkpIHx8ICEoa2V5LnNsaWNlKDkpIGluIHByb3BzKSkgewogICAgICAgICAgICAgIHJlc1trZXldID0gYXR0cnNba2V5XTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzOwogIH07CiAgY29uc3QgaXNFbGVtZW50Um9vdCA9ICh2bm9kZSkgPT4gewogICAgICByZXR1cm4gKHZub2RlLnNoYXBlRmxhZyAmICg2IC8qIENPTVBPTkVOVCAqLyB8IDEgLyogRUxFTUVOVCAqLykgfHwKICAgICAgICAgIHZub2RlLnR5cGUgPT09IENvbW1lbnQgLy8gcG90ZW50aWFsIHYtaWYgYnJhbmNoIHN3aXRjaAogICAgICApOwogIH07CiAgZnVuY3Rpb24gc2hvdWxkVXBkYXRlQ29tcG9uZW50KHByZXZWTm9kZSwgbmV4dFZOb2RlLCBvcHRpbWl6ZWQpIHsKICAgICAgY29uc3QgeyBwcm9wczogcHJldlByb3BzLCBjaGlsZHJlbjogcHJldkNoaWxkcmVuLCBjb21wb25lbnQgfSA9IHByZXZWTm9kZTsKICAgICAgY29uc3QgeyBwcm9wczogbmV4dFByb3BzLCBjaGlsZHJlbjogbmV4dENoaWxkcmVuLCBwYXRjaEZsYWcgfSA9IG5leHRWTm9kZTsKICAgICAgY29uc3QgZW1pdHMgPSBjb21wb25lbnQuZW1pdHNPcHRpb25zOwogICAgICAvLyBQYXJlbnQgY29tcG9uZW50J3MgcmVuZGVyIGZ1bmN0aW9uIHdhcyBob3QtdXBkYXRlZC4gU2luY2UgdGhpcyBtYXkgaGF2ZQogICAgICAvLyBjYXVzZWQgdGhlIGNoaWxkIGNvbXBvbmVudCdzIHNsb3RzIGNvbnRlbnQgdG8gaGF2ZSBjaGFuZ2VkLCB3ZSBuZWVkIHRvCiAgICAgIC8vIGZvcmNlIHRoZSBjaGlsZCB0byB1cGRhdGUgYXMgd2VsbC4KICAgICAgaWYgKChwcmV2Q2hpbGRyZW4gfHwgbmV4dENoaWxkcmVuKSAmJiBpc0htclVwZGF0aW5nKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICAvLyBmb3JjZSBjaGlsZCB1cGRhdGUgZm9yIHJ1bnRpbWUgZGlyZWN0aXZlIG9yIHRyYW5zaXRpb24gb24gY29tcG9uZW50IHZub2RlLgogICAgICBpZiAobmV4dFZOb2RlLmRpcnMgfHwgbmV4dFZOb2RlLnRyYW5zaXRpb24pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChvcHRpbWl6ZWQgJiYgcGF0Y2hGbGFnID49IDApIHsKICAgICAgICAgIGlmIChwYXRjaEZsYWcgJiAxMDI0IC8qIERZTkFNSUNfU0xPVFMgKi8pIHsKICAgICAgICAgICAgICAvLyBzbG90IGNvbnRlbnQgdGhhdCByZWZlcmVuY2VzIHZhbHVlcyB0aGF0IG1pZ2h0IGhhdmUgY2hhbmdlZCwKICAgICAgICAgICAgICAvLyBlLmcuIGluIGEgdi1mb3IKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXRjaEZsYWcgJiAxNiAvKiBGVUxMX1BST1BTICovKSB7CiAgICAgICAgICAgICAgaWYgKCFwcmV2UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuICEhbmV4dFByb3BzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBwcmVzZW5jZSBvZiB0aGlzIGZsYWcgaW5kaWNhdGVzIHByb3BzIGFyZSBhbHdheXMgbm9uLW51bGwKICAgICAgICAgICAgICByZXR1cm4gaGFzUHJvcHNDaGFuZ2VkKHByZXZQcm9wcywgbmV4dFByb3BzLCBlbWl0cyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChwYXRjaEZsYWcgJiA4IC8qIFBST1BTICovKSB7CiAgICAgICAgICAgICAgY29uc3QgZHluYW1pY1Byb3BzID0gbmV4dFZOb2RlLmR5bmFtaWNQcm9wczsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR5bmFtaWNQcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBkeW5hbWljUHJvcHNbaV07CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcHNba2V5XSAhPT0gcHJldlByb3BzW2tleV0gJiYKICAgICAgICAgICAgICAgICAgICAgICFpc0VtaXRMaXN0ZW5lcihlbWl0cywga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyB0aGlzIHBhdGggaXMgb25seSB0YWtlbiBieSBtYW51YWxseSB3cml0dGVuIHJlbmRlciBmdW5jdGlvbnMKICAgICAgICAgIC8vIHNvIHByZXNlbmNlIG9mIGFueSBjaGlsZHJlbiBsZWFkcyB0byBhIGZvcmNlZCB1cGRhdGUKICAgICAgICAgIGlmIChwcmV2Q2hpbGRyZW4gfHwgbmV4dENoaWxkcmVuKSB7CiAgICAgICAgICAgICAgaWYgKCFuZXh0Q2hpbGRyZW4gfHwgIW5leHRDaGlsZHJlbi4kc3RhYmxlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcHJldlByb3BzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICEhbmV4dFByb3BzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoYXNQcm9wc0NoYW5nZWQocHJldlByb3BzLCBuZXh0UHJvcHMsIGVtaXRzKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGhhc1Byb3BzQ2hhbmdlZChwcmV2UHJvcHMsIG5leHRQcm9wcywgZW1pdHNPcHRpb25zKSB7CiAgICAgIGNvbnN0IG5leHRLZXlzID0gT2JqZWN0LmtleXMobmV4dFByb3BzKTsKICAgICAgaWYgKG5leHRLZXlzLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMocHJldlByb3BzKS5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmV4dEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IG5leHRLZXlzW2ldOwogICAgICAgICAgaWYgKG5leHRQcm9wc1trZXldICE9PSBwcmV2UHJvcHNba2V5XSAmJgogICAgICAgICAgICAgICFpc0VtaXRMaXN0ZW5lcihlbWl0c09wdGlvbnMsIGtleSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZUhPQ0hvc3RFbCh7IHZub2RlLCBwYXJlbnQgfSwgZWwgLy8gSG9zdE5vZGUKICApIHsKICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQuc3ViVHJlZSA9PT0gdm5vZGUpIHsKICAgICAgICAgICh2bm9kZSA9IHBhcmVudC52bm9kZSkuZWwgPSBlbDsKICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgIH0KICB9CgogIGNvbnN0IGlzU3VzcGVuc2UgPSAodHlwZSkgPT4gdHlwZS5fX2lzU3VzcGVuc2U7CiAgLy8gU3VzcGVuc2UgZXhwb3NlcyBhIGNvbXBvbmVudC1saWtlIEFQSSwgYW5kIGlzIHRyZWF0ZWQgbGlrZSBhIGNvbXBvbmVudAogIC8vIGluIHRoZSBjb21waWxlciwgYnV0IGludGVybmFsbHkgaXQncyBhIHNwZWNpYWwgYnVpbHQtaW4gdHlwZSB0aGF0IGhvb2tzCiAgLy8gZGlyZWN0bHkgaW50byB0aGUgcmVuZGVyZXIuCiAgY29uc3QgU3VzcGVuc2VJbXBsID0gewogICAgICBuYW1lOiAnU3VzcGVuc2UnLAogICAgICAvLyBJbiBvcmRlciB0byBtYWtlIFN1c3BlbnNlIHRyZWUtc2hha2FibGUsIHdlIG5lZWQgdG8gYXZvaWQgaW1wb3J0aW5nIGl0CiAgICAgIC8vIGRpcmVjdGx5IGluIHRoZSByZW5kZXJlci4gVGhlIHJlbmRlcmVyIGNoZWNrcyBmb3IgdGhlIF9faXNTdXNwZW5zZSBmbGFnCiAgICAgIC8vIG9uIGEgdm5vZGUncyB0eXBlIGFuZCBjYWxscyB0aGUgYHByb2Nlc3NgIG1ldGhvZCwgcGFzc2luZyBpbiByZW5kZXJlcgogICAgICAvLyBpbnRlcm5hbHMuCiAgICAgIF9faXNTdXNwZW5zZTogdHJ1ZSwKICAgICAgcHJvY2VzcyhuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIAogICAgICAvLyBwbGF0Zm9ybS1zcGVjaWZpYyBpbXBsIHBhc3NlZCBmcm9tIHJlbmRlcmVyCiAgICAgIHJlbmRlcmVySW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgICAgICAgIG1vdW50U3VzcGVuc2UobjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHJlbmRlcmVySW50ZXJuYWxzKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHBhdGNoU3VzcGVuc2UobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHJlbmRlcmVySW50ZXJuYWxzKTsKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgaHlkcmF0ZTogaHlkcmF0ZVN1c3BlbnNlLAogICAgICBjcmVhdGU6IGNyZWF0ZVN1c3BlbnNlQm91bmRhcnksCiAgICAgIG5vcm1hbGl6ZTogbm9ybWFsaXplU3VzcGVuc2VDaGlsZHJlbgogIH07CiAgLy8gRm9yY2UtY2FzdGVkIHB1YmxpYyB0eXBpbmcgZm9yIGggYW5kIFRTWCBwcm9wcyBpbmZlcmVuY2UKICBjb25zdCBTdXNwZW5zZSA9IChTdXNwZW5zZUltcGwgKTsKICBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQodm5vZGUsIG5hbWUpIHsKICAgICAgY29uc3QgZXZlbnRMaXN0ZW5lciA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzW25hbWVdOwogICAgICBpZiAoaXNGdW5jdGlvbihldmVudExpc3RlbmVyKSkgewogICAgICAgICAgZXZlbnRMaXN0ZW5lcigpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2Uodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHJlbmRlcmVySW50ZXJuYWxzKSB7CiAgICAgIGNvbnN0IHsgcDogcGF0Y2gsIG86IHsgY3JlYXRlRWxlbWVudCB9IH0gPSByZW5kZXJlckludGVybmFsczsKICAgICAgY29uc3QgaGlkZGVuQ29udGFpbmVyID0gY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGNvbnN0IHN1c3BlbnNlID0gKHZub2RlLnN1c3BlbnNlID0gY3JlYXRlU3VzcGVuc2VCb3VuZGFyeSh2bm9kZSwgcGFyZW50U3VzcGVuc2UsIHBhcmVudENvbXBvbmVudCwgY29udGFpbmVyLCBoaWRkZW5Db250YWluZXIsIGFuY2hvciwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscykpOwogICAgICAvLyBzdGFydCBtb3VudGluZyB0aGUgY29udGVudCBzdWJ0cmVlIGluIGFuIG9mZi1kb20gY29udGFpbmVyCiAgICAgIHBhdGNoKG51bGwsIChzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gdm5vZGUuc3NDb250ZW50KSwgaGlkZGVuQ29udGFpbmVyLCBudWxsLCBwYXJlbnRDb21wb25lbnQsIHN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzKTsKICAgICAgLy8gbm93IGNoZWNrIGlmIHdlIGhhdmUgZW5jb3VudGVyZWQgYW55IGFzeW5jIGRlcHMKICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPiAwKSB7CiAgICAgICAgICAvLyBoYXMgYXN5bmMKICAgICAgICAgIC8vIGludm9rZSBAZmFsbGJhY2sgZXZlbnQKICAgICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZSwgJ29uUGVuZGluZycpOwogICAgICAgICAgdHJpZ2dlckV2ZW50KHZub2RlLCAnb25GYWxsYmFjaycpOwogICAgICAgICAgLy8gbW91bnQgdGhlIGZhbGxiYWNrIHRyZWUKICAgICAgICAgIHBhdGNoKG51bGwsIHZub2RlLnNzRmFsbGJhY2ssIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIG51bGwsIC8vIGZhbGxiYWNrIHRyZWUgd2lsbCBub3QgaGF2ZSBzdXNwZW5zZSBjb250ZXh0CiAgICAgICAgICBpc1NWRywgc2xvdFNjb3BlSWRzKTsKICAgICAgICAgIHNldEFjdGl2ZUJyYW5jaChzdXNwZW5zZSwgdm5vZGUuc3NGYWxsYmFjayk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBTdXNwZW5zZSBoYXMgbm8gYXN5bmMgZGVwcy4gSnVzdCByZXNvbHZlLgogICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIHBhdGNoU3VzcGVuc2UobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHsgcDogcGF0Y2gsIHVtOiB1bm1vdW50LCBvOiB7IGNyZWF0ZUVsZW1lbnQgfSB9KSB7CiAgICAgIGNvbnN0IHN1c3BlbnNlID0gKG4yLnN1c3BlbnNlID0gbjEuc3VzcGVuc2UpOwogICAgICBzdXNwZW5zZS52bm9kZSA9IG4yOwogICAgICBuMi5lbCA9IG4xLmVsOwogICAgICBjb25zdCBuZXdCcmFuY2ggPSBuMi5zc0NvbnRlbnQ7CiAgICAgIGNvbnN0IG5ld0ZhbGxiYWNrID0gbjIuc3NGYWxsYmFjazsKICAgICAgY29uc3QgeyBhY3RpdmVCcmFuY2gsIHBlbmRpbmdCcmFuY2gsIGlzSW5GYWxsYmFjaywgaXNIeWRyYXRpbmcgfSA9IHN1c3BlbnNlOwogICAgICBpZiAocGVuZGluZ0JyYW5jaCkgewogICAgICAgICAgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCA9IG5ld0JyYW5jaDsKICAgICAgICAgIGlmIChpc1NhbWVWTm9kZVR5cGUobmV3QnJhbmNoLCBwZW5kaW5nQnJhbmNoKSkgewogICAgICAgICAgICAgIC8vIHNhbWUgcm9vdCB0eXBlIGJ1dCBjb250ZW50IG1heSBoYXZlIGNoYW5nZWQuCiAgICAgICAgICAgICAgcGF0Y2gocGVuZGluZ0JyYW5jaCwgbmV3QnJhbmNoLCBzdXNwZW5zZS5oaWRkZW5Db250YWluZXIsIG51bGwsIHBhcmVudENvbXBvbmVudCwgc3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPD0gMCkgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGlzSW5GYWxsYmFjaykgewogICAgICAgICAgICAgICAgICBwYXRjaChhY3RpdmVCcmFuY2gsIG5ld0ZhbGxiYWNrLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBudWxsLCAvLyBmYWxsYmFjayB0cmVlIHdpbGwgbm90IGhhdmUgc3VzcGVuc2UgY29udGV4dAogICAgICAgICAgICAgICAgICBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0ZhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyB0b2dnbGVkIGJlZm9yZSBwZW5kaW5nIHRyZWUgaXMgcmVzb2x2ZWQKICAgICAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nSWQrKzsKICAgICAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICAgICAgLy8gaWYgdG9nZ2xlZCBiZWZvcmUgaHlkcmF0aW9uIGlzIGZpbmlzaGVkLCB0aGUgY3VycmVudCBET00gdHJlZSBpcwogICAgICAgICAgICAgICAgICAvLyBubyBsb25nZXIgdmFsaWQuIHNldCBpdCBhcyB0aGUgYWN0aXZlIGJyYW5jaCBzbyBpdCB3aWxsIGJlIHVubW91bnRlZAogICAgICAgICAgICAgICAgICAvLyB3aGVuIHJlc29sdmVkCiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLmlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLmFjdGl2ZUJyYW5jaCA9IHBlbmRpbmdCcmFuY2g7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB1bm1vdW50KHBlbmRpbmdCcmFuY2gsIHBhcmVudENvbXBvbmVudCwgc3VzcGVuc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBpbmNyZW1lbnQgcGVuZGluZyBJRC4gdGhpcyBpcyB1c2VkIHRvIGludmFsaWRhdGUgYXN5bmMgY2FsbGJhY2tzCiAgICAgICAgICAgICAgLy8gcmVzZXQgc3VzcGVuc2Ugc3RhdGUKICAgICAgICAgICAgICBzdXNwZW5zZS5kZXBzID0gMDsKICAgICAgICAgICAgICAvLyBkaXNjYXJkIGVmZmVjdHMgZnJvbSBwZW5kaW5nIGJyYW5jaAogICAgICAgICAgICAgIHN1c3BlbnNlLmVmZmVjdHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAvLyBkaXNjYXJkIHByZXZpb3VzIGNvbnRhaW5lcgogICAgICAgICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgIGlmIChpc0luRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgLy8gYWxyZWFkeSBpbiBmYWxsYmFjayBzdGF0ZQogICAgICAgICAgICAgICAgICBwYXRjaChudWxsLCBuZXdCcmFuY2gsIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCBzdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcGF0Y2goYWN0aXZlQnJhbmNoLCBuZXdGYWxsYmFjaywgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgbnVsbCwgLy8gZmFsbGJhY2sgdHJlZSB3aWxsIG5vdCBoYXZlIHN1c3BlbnNlIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0ZhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChhY3RpdmVCcmFuY2ggJiYgaXNTYW1lVk5vZGVUeXBlKG5ld0JyYW5jaCwgYWN0aXZlQnJhbmNoKSkgewogICAgICAgICAgICAgICAgICAvLyB0b2dnbGVkICJiYWNrIiB0byBjdXJyZW50IGFjdGl2ZSBicmFuY2gKICAgICAgICAgICAgICAgICAgcGF0Y2goYWN0aXZlQnJhbmNoLCBuZXdCcmFuY2gsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICAvLyBmb3JjZSByZXNvbHZlCiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUodHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBzd2l0Y2hlZCB0byBhIDNyZCBicmFuY2gKICAgICAgICAgICAgICAgICAgcGF0Y2gobnVsbCwgbmV3QnJhbmNoLCBzdXNwZW5zZS5oaWRkZW5Db250YWluZXIsIG51bGwsIHBhcmVudENvbXBvbmVudCwgc3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGlmIChhY3RpdmVCcmFuY2ggJiYgaXNTYW1lVk5vZGVUeXBlKG5ld0JyYW5jaCwgYWN0aXZlQnJhbmNoKSkgewogICAgICAgICAgICAgIC8vIHJvb3QgZGlkIG5vdCBjaGFuZ2UsIGp1c3Qgbm9ybWFsIHBhdGNoCiAgICAgICAgICAgICAgcGF0Y2goYWN0aXZlQnJhbmNoLCBuZXdCcmFuY2gsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIHNldEFjdGl2ZUJyYW5jaChzdXNwZW5zZSwgbmV3QnJhbmNoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIHJvb3Qgbm9kZSB0b2dnbGVkCiAgICAgICAgICAgICAgLy8gaW52b2tlIEBwZW5kaW5nIGV2ZW50CiAgICAgICAgICAgICAgdHJpZ2dlckV2ZW50KG4yLCAnb25QZW5kaW5nJyk7CiAgICAgICAgICAgICAgLy8gbW91bnQgcGVuZGluZyBicmFuY2ggaW4gb2ZmLWRvbSBjb250YWluZXIKICAgICAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gbmV3QnJhbmNoOwogICAgICAgICAgICAgIHN1c3BlbnNlLnBlbmRpbmdJZCsrOwogICAgICAgICAgICAgIHBhdGNoKG51bGwsIG5ld0JyYW5jaCwgc3VzcGVuc2UuaGlkZGVuQ29udGFpbmVyLCBudWxsLCBwYXJlbnRDb21wb25lbnQsIHN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsKICAgICAgICAgICAgICAgICAgLy8gaW5jb21pbmcgYnJhbmNoIGhhcyBubyBhc3luYyBkZXBzLCByZXNvbHZlIG5vdy4KICAgICAgICAgICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29uc3QgeyB0aW1lb3V0LCBwZW5kaW5nSWQgfSA9IHN1c3BlbnNlOwogICAgICAgICAgICAgICAgICBpZiAodGltZW91dCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZS5wZW5kaW5nSWQgPT09IHBlbmRpbmdJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdXNwZW5zZS5mYWxsYmFjayhuZXdGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwgdGltZW91dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGltZW91dCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgc3VzcGVuc2UuZmFsbGJhY2sobmV3RmFsbGJhY2spOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgfQogIGxldCBoYXNXYXJuZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBjcmVhdGVTdXNwZW5zZUJvdW5kYXJ5KHZub2RlLCBwYXJlbnQsIHBhcmVudENvbXBvbmVudCwgY29udGFpbmVyLCBoaWRkZW5Db250YWluZXIsIGFuY2hvciwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgaXNIeWRyYXRpbmcgPSBmYWxzZSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFoYXNXYXJuZWQpIHsKICAgICAgICAgIGhhc1dhcm5lZCA9IHRydWU7CiAgICAgICAgICAvLyBAdHMtaWdub3JlIGBjb25zb2xlLmluZm9gIGNhbm5vdCBiZSBudWxsIGVycm9yCiAgICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXShgPFN1c3BlbnNlPiBpcyBhbiBleHBlcmltZW50YWwgZmVhdHVyZSBhbmQgaXRzIEFQSSB3aWxsIGxpa2VseSBjaGFuZ2UuYCk7CiAgICAgIH0KICAgICAgY29uc3QgeyBwOiBwYXRjaCwgbTogbW92ZSwgdW06IHVubW91bnQsIG46IG5leHQsIG86IHsgcGFyZW50Tm9kZSwgcmVtb3ZlIH0gfSA9IHJlbmRlcmVySW50ZXJuYWxzOwogICAgICBjb25zdCB0aW1lb3V0ID0gdG9OdW1iZXIodm5vZGUucHJvcHMgJiYgdm5vZGUucHJvcHMudGltZW91dCk7CiAgICAgIGNvbnN0IHN1c3BlbnNlID0gewogICAgICAgICAgdm5vZGUsCiAgICAgICAgICBwYXJlbnQsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBpc1NWRywKICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgIGhpZGRlbkNvbnRhaW5lciwKICAgICAgICAgIGFuY2hvciwKICAgICAgICAgIGRlcHM6IDAsCiAgICAgICAgICBwZW5kaW5nSWQ6IDAsCiAgICAgICAgICB0aW1lb3V0OiB0eXBlb2YgdGltZW91dCA9PT0gJ251bWJlcicgPyB0aW1lb3V0IDogLTEsCiAgICAgICAgICBhY3RpdmVCcmFuY2g6IG51bGwsCiAgICAgICAgICBwZW5kaW5nQnJhbmNoOiBudWxsLAogICAgICAgICAgaXNJbkZhbGxiYWNrOiB0cnVlLAogICAgICAgICAgaXNIeWRyYXRpbmcsCiAgICAgICAgICBpc1VubW91bnRlZDogZmFsc2UsCiAgICAgICAgICBlZmZlY3RzOiBbXSwKICAgICAgICAgIHJlc29sdmUocmVzdW1lID0gZmFsc2UpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghcmVzdW1lICYmICFzdXNwZW5zZS5wZW5kaW5nQnJhbmNoKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHN1c3BlbnNlLnJlc29sdmUoKSBpcyBjYWxsZWQgd2l0aG91dCBhIHBlbmRpbmcgYnJhbmNoLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZS5pc1VubW91bnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBzdXNwZW5zZS5yZXNvbHZlKCkgaXMgY2FsbGVkIG9uIGFuIGFscmVhZHkgdW5tb3VudGVkIHN1c3BlbnNlIGJvdW5kYXJ5LmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IHsgdm5vZGUsIGFjdGl2ZUJyYW5jaCwgcGVuZGluZ0JyYW5jaCwgcGVuZGluZ0lkLCBlZmZlY3RzLCBwYXJlbnRDb21wb25lbnQsIGNvbnRhaW5lciB9ID0gc3VzcGVuc2U7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlLmlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLmlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCFyZXN1bWUpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgZGVsYXlFbnRlciA9IGFjdGl2ZUJyYW5jaCAmJgogICAgICAgICAgICAgICAgICAgICAgcGVuZGluZ0JyYW5jaC50cmFuc2l0aW9uICYmCiAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nQnJhbmNoLnRyYW5zaXRpb24ubW9kZSA9PT0gJ291dC1pbic7CiAgICAgICAgICAgICAgICAgIGlmIChkZWxheUVudGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVCcmFuY2gudHJhbnNpdGlvbi5hZnRlckxlYXZlID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nSWQgPT09IHN1c3BlbnNlLnBlbmRpbmdJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlKHBlbmRpbmdCcmFuY2gsIGNvbnRhaW5lciwgYW5jaG9yLCAwIC8qIEVOVEVSICovKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgaW5pdGlhbCBhbmNob3Igb24gbW91bnQKICAgICAgICAgICAgICAgICAgbGV0IHsgYW5jaG9yIH0gPSBzdXNwZW5zZTsKICAgICAgICAgICAgICAgICAgLy8gdW5tb3VudCBjdXJyZW50IGFjdGl2ZSB0cmVlCiAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVCcmFuY2gpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBmYWxsYmFjayB0cmVlIHdhcyBtb3VudGVkLCBpdCBtYXkgaGF2ZSBiZWVuIG1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAvLyBhcyBwYXJ0IG9mIGEgcGFyZW50IHN1c3BlbnNlLiBnZXQgdGhlIGxhdGVzdCBhbmNob3IgZm9yIGluc2VydGlvbgogICAgICAgICAgICAgICAgICAgICAgYW5jaG9yID0gbmV4dChhY3RpdmVCcmFuY2gpOwogICAgICAgICAgICAgICAgICAgICAgdW5tb3VudChhY3RpdmVCcmFuY2gsIHBhcmVudENvbXBvbmVudCwgc3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGVsYXlFbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSBjb250ZW50IGZyb20gb2ZmLWRvbSBjb250YWluZXIgdG8gYWN0dWFsIGNvbnRhaW5lcgogICAgICAgICAgICAgICAgICAgICAgbW92ZShwZW5kaW5nQnJhbmNoLCBjb250YWluZXIsIGFuY2hvciwgMCAvKiBFTlRFUiAqLyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0QWN0aXZlQnJhbmNoKHN1c3BlbnNlLCBwZW5kaW5nQnJhbmNoKTsKICAgICAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gbnVsbDsKICAgICAgICAgICAgICBzdXNwZW5zZS5pc0luRmFsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAvLyBmbHVzaCBidWZmZXJlZCBlZmZlY3RzCiAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYSBwZW5kaW5nIHBhcmVudCBzdXNwZW5zZQogICAgICAgICAgICAgIGxldCBwYXJlbnQgPSBzdXNwZW5zZS5wYXJlbnQ7CiAgICAgICAgICAgICAgbGV0IGhhc1VucmVzb2x2ZWRBbmNlc3RvciA9IGZhbHNlOwogICAgICAgICAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5wZW5kaW5nQnJhbmNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBmb3VuZCBhIHBlbmRpbmcgcGFyZW50IHN1c3BlbnNlLCBtZXJnZSBidWZmZXJlZCBwb3N0IGpvYnMKICAgICAgICAgICAgICAgICAgICAgIC8vIGludG8gdGhhdCBwYXJlbnQKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5lZmZlY3RzLnB1c2goLi4uZWZmZWN0cyk7CiAgICAgICAgICAgICAgICAgICAgICBoYXNVbnJlc29sdmVkQW5jZXN0b3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gbm8gcGVuZGluZyBwYXJlbnQgc3VzcGVuc2UsIGZsdXNoIGFsbCBqb2JzCiAgICAgICAgICAgICAgaWYgKCFoYXNVbnJlc29sdmVkQW5jZXN0b3IpIHsKICAgICAgICAgICAgICAgICAgcXVldWVQb3N0Rmx1c2hDYihlZmZlY3RzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3VzcGVuc2UuZWZmZWN0cyA9IFtdOwogICAgICAgICAgICAgIC8vIGludm9rZSBAcmVzb2x2ZSBldmVudAogICAgICAgICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZSwgJ29uUmVzb2x2ZScpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhbGxiYWNrKGZhbGxiYWNrVk5vZGUpIHsKICAgICAgICAgICAgICBpZiAoIXN1c3BlbnNlLnBlbmRpbmdCcmFuY2gpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCB7IHZub2RlLCBhY3RpdmVCcmFuY2gsIHBhcmVudENvbXBvbmVudCwgY29udGFpbmVyLCBpc1NWRyB9ID0gc3VzcGVuc2U7CiAgICAgICAgICAgICAgLy8gaW52b2tlIEBmYWxsYmFjayBldmVudAogICAgICAgICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZSwgJ29uRmFsbGJhY2snKTsKICAgICAgICAgICAgICBjb25zdCBhbmNob3IgPSBuZXh0KGFjdGl2ZUJyYW5jaCk7CiAgICAgICAgICAgICAgY29uc3QgbW91bnRGYWxsYmFjayA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKCFzdXNwZW5zZS5pc0luRmFsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBtb3VudCB0aGUgZmFsbGJhY2sgdHJlZQogICAgICAgICAgICAgICAgICBwYXRjaChudWxsLCBmYWxsYmFja1ZOb2RlLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBudWxsLCAvLyBmYWxsYmFjayB0cmVlIHdpbGwgbm90IGhhdmUgc3VzcGVuc2UgY29udGV4dAogICAgICAgICAgICAgICAgICBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIGZhbGxiYWNrVk5vZGUpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY29uc3QgZGVsYXlFbnRlciA9IGZhbGxiYWNrVk5vZGUudHJhbnNpdGlvbiAmJiBmYWxsYmFja1ZOb2RlLnRyYW5zaXRpb24ubW9kZSA9PT0gJ291dC1pbic7CiAgICAgICAgICAgICAgaWYgKGRlbGF5RW50ZXIpIHsKICAgICAgICAgICAgICAgICAgYWN0aXZlQnJhbmNoLnRyYW5zaXRpb24uYWZ0ZXJMZWF2ZSA9IG1vdW50RmFsbGJhY2s7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN1c3BlbnNlLmlzSW5GYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgLy8gdW5tb3VudCBjdXJyZW50IGFjdGl2ZSBicmFuY2gKICAgICAgICAgICAgICB1bm1vdW50KGFjdGl2ZUJyYW5jaCwgcGFyZW50Q29tcG9uZW50LCBudWxsLCAvLyBubyBzdXNwZW5zZSBzbyB1bm1vdW50IGhvb2tzIGZpcmUgbm93CiAgICAgICAgICAgICAgdHJ1ZSAvLyBzaG91bGRSZW1vdmUKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghZGVsYXlFbnRlcikgewogICAgICAgICAgICAgICAgICBtb3VudEZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIG1vdmUoY29udGFpbmVyLCBhbmNob3IsIHR5cGUpIHsKICAgICAgICAgICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggJiYKICAgICAgICAgICAgICAgICAgbW92ZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIGNvbnRhaW5lciwgYW5jaG9yLCB0eXBlKTsKICAgICAgICAgICAgICBzdXNwZW5zZS5jb250YWluZXIgPSBjb250YWluZXI7CiAgICAgICAgICB9LAogICAgICAgICAgbmV4dCgpIHsKICAgICAgICAgICAgICByZXR1cm4gc3VzcGVuc2UuYWN0aXZlQnJhbmNoICYmIG5leHQoc3VzcGVuc2UuYWN0aXZlQnJhbmNoKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZWdpc3RlckRlcChpbnN0YW5jZSwgc2V0dXBSZW5kZXJFZmZlY3QpIHsKICAgICAgICAgICAgICBjb25zdCBpc0luUGVuZGluZ1N1c3BlbnNlID0gISFzdXNwZW5zZS5wZW5kaW5nQnJhbmNoOwogICAgICAgICAgICAgIGlmIChpc0luUGVuZGluZ1N1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLmRlcHMrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgaHlkcmF0ZWRFbCA9IGluc3RhbmNlLnZub2RlLmVsOwogICAgICAgICAgICAgIGluc3RhbmNlCiAgICAgICAgICAgICAgICAgIC5hc3luY0RlcC5jYXRjaChlcnIgPT4gewogICAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCAwIC8qIFNFVFVQX0ZVTkNUSU9OICovKTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAudGhlbihhc3luY1NldHVwUmVzdWx0ID0+IHsKICAgICAgICAgICAgICAgICAgLy8gcmV0cnkgd2hlbiB0aGUgc2V0dXAoKSBwcm9taXNlIHJlc29sdmVzLgogICAgICAgICAgICAgICAgICAvLyBjb21wb25lbnQgbWF5IGhhdmUgYmVlbiB1bm1vdW50ZWQgYmVmb3JlIHJlc29sdmUuCiAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5pc1VubW91bnRlZCB8fAogICAgICAgICAgICAgICAgICAgICAgc3VzcGVuc2UuaXNVbm1vdW50ZWQgfHwKICAgICAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLnBlbmRpbmdJZCAhPT0gaW5zdGFuY2Uuc3VzcGVuc2VJZCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIHJldHJ5IGZyb20gdGhpcyBjb21wb25lbnQKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuYXN5bmNSZXNvbHZlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHsgdm5vZGUgfSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQodm5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCBhc3luY1NldHVwUmVzdWx0LCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIGlmIChoeWRyYXRlZEVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyB2bm9kZSBtYXkgaGF2ZSBiZWVuIHJlcGxhY2VkIGlmIGFuIHVwZGF0ZSBoYXBwZW5lZCBiZWZvcmUgdGhlCiAgICAgICAgICAgICAgICAgICAgICAvLyBhc3luYyBkZXAgaXMgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICAgICAgICB2bm9kZS5lbCA9IGh5ZHJhdGVkRWw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXIgPSAhaHlkcmF0ZWRFbCAmJiBpbnN0YW5jZS5zdWJUcmVlLmVsOwogICAgICAgICAgICAgICAgICBzZXR1cFJlbmRlckVmZmVjdChpbnN0YW5jZSwgdm5vZGUsIAogICAgICAgICAgICAgICAgICAvLyBjb21wb25lbnQgbWF5IGhhdmUgYmVlbiBtb3ZlZCBiZWZvcmUgcmVzb2x2ZS4KICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyBub3QgYSBoeWRyYXRpb24sIGluc3RhbmNlLnN1YlRyZWUgd2lsbCBiZSB0aGUgY29tbWVudAogICAgICAgICAgICAgICAgICAvLyBwbGFjZWhvbGRlci4KICAgICAgICAgICAgICAgICAgcGFyZW50Tm9kZShoeWRyYXRlZEVsIHx8IGluc3RhbmNlLnN1YlRyZWUuZWwpLCAKICAgICAgICAgICAgICAgICAgLy8gYW5jaG9yIHdpbGwgbm90IGJlIHVzZWQgaWYgdGhpcyBpcyBoeWRyYXRpb24sIHNvIG9ubHkgbmVlZCB0bwogICAgICAgICAgICAgICAgICAvLyBjb25zaWRlciB0aGUgY29tbWVudCBwbGFjZWhvbGRlciBjYXNlLgogICAgICAgICAgICAgICAgICBoeWRyYXRlZEVsID8gbnVsbCA6IG5leHQoaW5zdGFuY2Uuc3ViVHJlZSksIHN1c3BlbnNlLCBpc1NWRywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW1vdmUocGxhY2Vob2xkZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUhPQ0hvc3RFbChpbnN0YW5jZSwgdm5vZGUuZWwpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwb3BXYXJuaW5nQ29udGV4dCgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIG9ubHkgZGVjcmVhc2UgZGVwcyBjb3VudCBpZiBzdXNwZW5zZSBpcyBub3QgYWxyZWFkeSByZXNvbHZlZAogICAgICAgICAgICAgICAgICBpZiAoaXNJblBlbmRpbmdTdXNwZW5zZSAmJiAtLXN1c3BlbnNlLmRlcHMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHVubW91bnQocGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2UuaXNVbm1vdW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZS5hY3RpdmVCcmFuY2gpIHsKICAgICAgICAgICAgICAgICAgdW5tb3VudChzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlLnBlbmRpbmdCcmFuY2gpIHsKICAgICAgICAgICAgICAgICAgdW5tb3VudChzdXNwZW5zZS5wZW5kaW5nQnJhbmNoLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gc3VzcGVuc2U7CiAgfQogIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZShub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgaHlkcmF0ZU5vZGUpIHsKICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzICovCiAgICAgIGNvbnN0IHN1c3BlbnNlID0gKHZub2RlLnN1c3BlbnNlID0gY3JlYXRlU3VzcGVuc2VCb3VuZGFyeSh2bm9kZSwgcGFyZW50U3VzcGVuc2UsIHBhcmVudENvbXBvbmVudCwgbm9kZS5wYXJlbnROb2RlLCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgbnVsbCwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgdHJ1ZSAvKiBoeWRyYXRpbmcgKi8pKTsKICAgICAgLy8gdGhlcmUgYXJlIHR3byBwb3NzaWJsZSBzY2VuYXJpb3MgZm9yIHNlcnZlci1yZW5kZXJlZCBzdXNwZW5zZToKICAgICAgLy8gLSBzdWNjZXNzOiBzc3IgY29udGVudCBzaG91bGQgYmUgZnVsbHkgcmVzb2x2ZWQKICAgICAgLy8gLSBmYWlsdXJlOiBzc3IgY29udGVudCBzaG91bGQgYmUgdGhlIGZhbGxiYWNrIGJyYW5jaC4KICAgICAgLy8gaG93ZXZlciwgb24gdGhlIGNsaWVudCB3ZSBkb24ndCByZWFsbHkga25vdyBpZiBpdCBoYXMgZmFpbGVkIG9yIG5vdAogICAgICAvLyBhdHRlbXB0IHRvIGh5ZHJhdGUgdGhlIERPTSBhc3N1bWluZyBpdCBoYXMgc3VjY2VlZGVkLCBidXQgd2Ugc3RpbGwKICAgICAgLy8gbmVlZCB0byBjb25zdHJ1Y3QgYSBzdXNwZW5zZSBib3VuZGFyeSBmaXJzdAogICAgICBjb25zdCByZXN1bHQgPSBoeWRyYXRlTm9kZShub2RlLCAoc3VzcGVuc2UucGVuZGluZ0JyYW5jaCA9IHZub2RlLnNzQ29udGVudCksIHBhcmVudENvbXBvbmVudCwgc3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPT09IDApIHsKICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUoKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXJlc3RyaWN0ZWQtZ2xvYmFscyAqLwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVTdXNwZW5zZUNoaWxkcmVuKHZub2RlKSB7CiAgICAgIGNvbnN0IHsgc2hhcGVGbGFnLCBjaGlsZHJlbiB9ID0gdm5vZGU7CiAgICAgIGNvbnN0IGlzU2xvdENoaWxkcmVuID0gc2hhcGVGbGFnICYgMzIgLyogU0xPVFNfQ0hJTERSRU4gKi87CiAgICAgIHZub2RlLnNzQ29udGVudCA9IG5vcm1hbGl6ZVN1c3BlbnNlU2xvdChpc1Nsb3RDaGlsZHJlbiA/IGNoaWxkcmVuLmRlZmF1bHQgOiBjaGlsZHJlbik7CiAgICAgIHZub2RlLnNzRmFsbGJhY2sgPSBpc1Nsb3RDaGlsZHJlbgogICAgICAgICAgPyBub3JtYWxpemVTdXNwZW5zZVNsb3QoY2hpbGRyZW4uZmFsbGJhY2spCiAgICAgICAgICA6IGNyZWF0ZVZOb2RlKENvbW1lbnQpOwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVTdXNwZW5zZVNsb3QocykgewogICAgICBsZXQgYmxvY2s7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHMpKSB7CiAgICAgICAgICBjb25zdCB0cmFja0Jsb2NrID0gaXNCbG9ja1RyZWVFbmFibGVkICYmIHMuX2M7CiAgICAgICAgICBpZiAodHJhY2tCbG9jaykgewogICAgICAgICAgICAgIC8vIGRpc2FibGVUcmFja2luZzogZmFsc2UKICAgICAgICAgICAgICAvLyBhbGxvdyBibG9jayB0cmFja2luZyBmb3IgY29tcGlsZWQgc2xvdHMKICAgICAgICAgICAgICAvLyAoc2VlIC4vY29tcG9uZW50UmVuZGVyQ29udGV4dC50cykKICAgICAgICAgICAgICBzLl9kID0gZmFsc2U7CiAgICAgICAgICAgICAgb3BlbkJsb2NrKCk7CiAgICAgICAgICB9CiAgICAgICAgICBzID0gcygpOwogICAgICAgICAgaWYgKHRyYWNrQmxvY2spIHsKICAgICAgICAgICAgICBzLl9kID0gdHJ1ZTsKICAgICAgICAgICAgICBibG9jayA9IGN1cnJlbnRCbG9jazsKICAgICAgICAgICAgICBjbG9zZUJsb2NrKCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzQXJyYXkocykpIHsKICAgICAgICAgIGNvbnN0IHNpbmdsZUNoaWxkID0gZmlsdGVyU2luZ2xlUm9vdChzKTsKICAgICAgICAgIGlmICghc2luZ2xlQ2hpbGQpIHsKICAgICAgICAgICAgICB3YXJuJDEoYDxTdXNwZW5zZT4gc2xvdHMgZXhwZWN0IGEgc2luZ2xlIHJvb3Qgbm9kZS5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHMgPSBzaW5nbGVDaGlsZDsKICAgICAgfQogICAgICBzID0gbm9ybWFsaXplVk5vZGUocyk7CiAgICAgIGlmIChibG9jayAmJiAhcy5keW5hbWljQ2hpbGRyZW4pIHsKICAgICAgICAgIHMuZHluYW1pY0NoaWxkcmVuID0gYmxvY2suZmlsdGVyKGMgPT4gYyAhPT0gcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHM7CiAgfQogIGZ1bmN0aW9uIHF1ZXVlRWZmZWN0V2l0aFN1c3BlbnNlKGZuLCBzdXNwZW5zZSkgewogICAgICBpZiAoc3VzcGVuc2UgJiYgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgewogICAgICAgICAgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2UuZWZmZWN0cy5wdXNoKC4uLmZuKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHN1c3BlbnNlLmVmZmVjdHMucHVzaChmbik7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBxdWV1ZVBvc3RGbHVzaENiKGZuKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIGJyYW5jaCkgewogICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggPSBicmFuY2g7CiAgICAgIGNvbnN0IHsgdm5vZGUsIHBhcmVudENvbXBvbmVudCB9ID0gc3VzcGVuc2U7CiAgICAgIGNvbnN0IGVsID0gKHZub2RlLmVsID0gYnJhbmNoLmVsKTsKICAgICAgLy8gaW4gY2FzZSBzdXNwZW5zZSBpcyB0aGUgcm9vdCBub2RlIG9mIGEgY29tcG9uZW50LAogICAgICAvLyByZWN1cnNpdmVseSB1cGRhdGUgdGhlIEhPQyBlbAogICAgICBpZiAocGFyZW50Q29tcG9uZW50ICYmIHBhcmVudENvbXBvbmVudC5zdWJUcmVlID09PSB2bm9kZSkgewogICAgICAgICAgcGFyZW50Q29tcG9uZW50LnZub2RlLmVsID0gZWw7CiAgICAgICAgICB1cGRhdGVIT0NIb3N0RWwocGFyZW50Q29tcG9uZW50LCBlbCk7CiAgICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb3ZpZGUoa2V5LCB2YWx1ZSkgewogICAgICBpZiAoIWN1cnJlbnRJbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICAgIHdhcm4kMShgcHJvdmlkZSgpIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHNldHVwKCkuYCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBsZXQgcHJvdmlkZXMgPSBjdXJyZW50SW5zdGFuY2UucHJvdmlkZXM7CiAgICAgICAgICAvLyBieSBkZWZhdWx0IGFuIGluc3RhbmNlIGluaGVyaXRzIGl0cyBwYXJlbnQncyBwcm92aWRlcyBvYmplY3QKICAgICAgICAgIC8vIGJ1dCB3aGVuIGl0IG5lZWRzIHRvIHByb3ZpZGUgdmFsdWVzIG9mIGl0cyBvd24sIGl0IGNyZWF0ZXMgaXRzCiAgICAgICAgICAvLyBvd24gcHJvdmlkZXMgb2JqZWN0IHVzaW5nIHBhcmVudCBwcm92aWRlcyBvYmplY3QgYXMgcHJvdG90eXBlLgogICAgICAgICAgLy8gdGhpcyB3YXkgaW4gYGluamVjdGAgd2UgY2FuIHNpbXBseSBsb29rIHVwIGluamVjdGlvbnMgZnJvbSBkaXJlY3QKICAgICAgICAgIC8vIHBhcmVudCBhbmQgbGV0IHRoZSBwcm90b3R5cGUgY2hhaW4gZG8gdGhlIHdvcmsuCiAgICAgICAgICBjb25zdCBwYXJlbnRQcm92aWRlcyA9IGN1cnJlbnRJbnN0YW5jZS5wYXJlbnQgJiYgY3VycmVudEluc3RhbmNlLnBhcmVudC5wcm92aWRlczsKICAgICAgICAgIGlmIChwYXJlbnRQcm92aWRlcyA9PT0gcHJvdmlkZXMpIHsKICAgICAgICAgICAgICBwcm92aWRlcyA9IGN1cnJlbnRJbnN0YW5jZS5wcm92aWRlcyA9IE9iamVjdC5jcmVhdGUocGFyZW50UHJvdmlkZXMpOwogICAgICAgICAgfQogICAgICAgICAgLy8gVFMgZG9lc24ndCBhbGxvdyBzeW1ib2wgYXMgaW5kZXggdHlwZQogICAgICAgICAgcHJvdmlkZXNba2V5XSA9IHZhbHVlOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGluamVjdChrZXksIGRlZmF1bHRWYWx1ZSwgdHJlYXREZWZhdWx0QXNGYWN0b3J5ID0gZmFsc2UpIHsKICAgICAgLy8gZmFsbGJhY2sgdG8gYGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZWAgc28gdGhhdCB0aGlzIGNhbiBiZSBjYWxsZWQgaW4KICAgICAgLy8gYSBmdW5jdGlvbmFsIGNvbXBvbmVudAogICAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZSB8fCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2U7CiAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgLy8gIzI0MDAKICAgICAgICAgIC8vIHRvIHN1cHBvcnQgYGFwcC51c2VgIHBsdWdpbnMsCiAgICAgICAgICAvLyBmYWxsYmFjayB0byBhcHBDb250ZXh0J3MgYHByb3ZpZGVzYCBpZiB0aGUgaW5zdGFuY2UgaXMgYXQgcm9vdAogICAgICAgICAgY29uc3QgcHJvdmlkZXMgPSBpbnN0YW5jZS5wYXJlbnQgPT0gbnVsbAogICAgICAgICAgICAgID8gaW5zdGFuY2Uudm5vZGUuYXBwQ29udGV4dCAmJiBpbnN0YW5jZS52bm9kZS5hcHBDb250ZXh0LnByb3ZpZGVzCiAgICAgICAgICAgICAgOiBpbnN0YW5jZS5wYXJlbnQucHJvdmlkZXM7CiAgICAgICAgICBpZiAocHJvdmlkZXMgJiYga2V5IGluIHByb3ZpZGVzKSB7CiAgICAgICAgICAgICAgLy8gVFMgZG9lc24ndCBhbGxvdyBzeW1ib2wgYXMgaW5kZXggdHlwZQogICAgICAgICAgICAgIHJldHVybiBwcm92aWRlc1trZXldOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJlYXREZWZhdWx0QXNGYWN0b3J5ICYmIGlzRnVuY3Rpb24oZGVmYXVsdFZhbHVlKQogICAgICAgICAgICAgICAgICA/IGRlZmF1bHRWYWx1ZS5jYWxsKGluc3RhbmNlLnByb3h5KQogICAgICAgICAgICAgICAgICA6IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm4kMShgaW5qZWN0aW9uICIke1N0cmluZyhrZXkpfSIgbm90IGZvdW5kLmApOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgd2FybiQxKGBpbmplY3QoKSBjYW4gb25seSBiZSB1c2VkIGluc2lkZSBzZXR1cCgpIG9yIGZ1bmN0aW9uYWwgY29tcG9uZW50cy5gKTsKICAgICAgfQogIH0KCiAgLy8gU2ltcGxlIGVmZmVjdC4KICBmdW5jdGlvbiB3YXRjaEVmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGRvV2F0Y2goZWZmZWN0LCBudWxsLCBvcHRpb25zKTsKICB9CiAgZnVuY3Rpb24gd2F0Y2hQb3N0RWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogICAgICByZXR1cm4gZG9XYXRjaChlZmZlY3QsIG51bGwsIChPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IGZsdXNoOiAncG9zdCcgfSkgKSk7CiAgfQogIGZ1bmN0aW9uIHdhdGNoU3luY0VmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGRvV2F0Y2goZWZmZWN0LCBudWxsLCAoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKSwgeyBmbHVzaDogJ3N5bmMnIH0pICkpOwogIH0KICAvLyBpbml0aWFsIHZhbHVlIGZvciB3YXRjaGVycyB0byB0cmlnZ2VyIG9uIHVuZGVmaW5lZCBpbml0aWFsIHZhbHVlcwogIGNvbnN0IElOSVRJQUxfV0FUQ0hFUl9WQUxVRSA9IHt9OwogIC8vIGltcGxlbWVudGF0aW9uCiAgZnVuY3Rpb24gd2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucykgewogICAgICBpZiAoIWlzRnVuY3Rpb24oY2IpKSB7CiAgICAgICAgICB3YXJuJDEoYFxgd2F0Y2goZm4sIG9wdGlvbnM/KVxgIHNpZ25hdHVyZSBoYXMgYmVlbiBtb3ZlZCB0byBhIHNlcGFyYXRlIEFQSS4gYCArCiAgICAgICAgICAgICAgYFVzZSBcYHdhdGNoRWZmZWN0KGZuLCBvcHRpb25zPylcYCBpbnN0ZWFkLiBcYHdhdGNoXGAgbm93IG9ubHkgYCArCiAgICAgICAgICAgICAgYHN1cHBvcnRzIFxgd2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucz8pIHNpZ25hdHVyZS5gKTsKICAgICAgfQogICAgICByZXR1cm4gZG9XYXRjaChzb3VyY2UsIGNiLCBvcHRpb25zKTsKICB9CiAgZnVuY3Rpb24gZG9XYXRjaChzb3VyY2UsIGNiLCB7IGltbWVkaWF0ZSwgZGVlcCwgZmx1c2gsIG9uVHJhY2ssIG9uVHJpZ2dlciB9ID0gRU1QVFlfT0JKKSB7CiAgICAgIGlmICghY2IpIHsKICAgICAgICAgIGlmIChpbW1lZGlhdGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHdhcm4kMShgd2F0Y2goKSAiaW1tZWRpYXRlIiBvcHRpb24gaXMgb25seSByZXNwZWN0ZWQgd2hlbiB1c2luZyB0aGUgYCArCiAgICAgICAgICAgICAgICAgIGB3YXRjaChzb3VyY2UsIGNhbGxiYWNrLCBvcHRpb25zPykgc2lnbmF0dXJlLmApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHdhcm4kMShgd2F0Y2goKSAiZGVlcCIgb3B0aW9uIGlzIG9ubHkgcmVzcGVjdGVkIHdoZW4gdXNpbmcgdGhlIGAgKwogICAgICAgICAgICAgICAgICBgd2F0Y2goc291cmNlLCBjYWxsYmFjaywgb3B0aW9ucz8pIHNpZ25hdHVyZS5gKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB3YXJuSW52YWxpZFNvdXJjZSA9IChzKSA9PiB7CiAgICAgICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggc291cmNlOiBgLCBzLCBgQSB3YXRjaCBzb3VyY2UgY2FuIG9ubHkgYmUgYSBnZXR0ZXIvZWZmZWN0IGZ1bmN0aW9uLCBhIHJlZiwgYCArCiAgICAgICAgICAgICAgYGEgcmVhY3RpdmUgb2JqZWN0LCBvciBhbiBhcnJheSBvZiB0aGVzZSB0eXBlcy5gKTsKICAgICAgfTsKICAgICAgY29uc3QgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2U7CiAgICAgIGxldCBnZXR0ZXI7CiAgICAgIGxldCBmb3JjZVRyaWdnZXIgPSBmYWxzZTsKICAgICAgbGV0IGlzTXVsdGlTb3VyY2UgPSBmYWxzZTsKICAgICAgaWYgKGlzUmVmKHNvdXJjZSkpIHsKICAgICAgICAgIGdldHRlciA9ICgpID0+IHNvdXJjZS52YWx1ZTsKICAgICAgICAgIGZvcmNlVHJpZ2dlciA9IGlzU2hhbGxvdyhzb3VyY2UpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzUmVhY3RpdmUoc291cmNlKSkgewogICAgICAgICAgZ2V0dGVyID0gKCkgPT4gc291cmNlOwogICAgICAgICAgZGVlcCA9IHRydWU7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICBpc011bHRpU291cmNlID0gdHJ1ZTsKICAgICAgICAgIGZvcmNlVHJpZ2dlciA9IHNvdXJjZS5zb21lKHMgPT4gaXNSZWFjdGl2ZShzKSB8fCBpc1NoYWxsb3cocykpOwogICAgICAgICAgZ2V0dGVyID0gKCkgPT4gc291cmNlLm1hcChzID0+IHsKICAgICAgICAgICAgICBpZiAoaXNSZWYocykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHMudmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGlzUmVhY3RpdmUocykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYXZlcnNlKHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChpc0Z1bmN0aW9uKHMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsV2l0aEVycm9ySGFuZGxpbmcocywgaW5zdGFuY2UsIDIgLyogV0FUQ0hfR0VUVEVSICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHdhcm5JbnZhbGlkU291cmNlKHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgICAgICAgaWYgKGNiKSB7CiAgICAgICAgICAgICAgLy8gZ2V0dGVyIHdpdGggY2IKICAgICAgICAgICAgICBnZXR0ZXIgPSAoKSA9PiBjYWxsV2l0aEVycm9ySGFuZGxpbmcoc291cmNlLCBpbnN0YW5jZSwgMiAvKiBXQVRDSF9HRVRURVIgKi8pOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gbm8gY2IgLT4gc2ltcGxlIGVmZmVjdAogICAgICAgICAgICAgIGdldHRlciA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLmlzVW5tb3VudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNsZWFudXApIHsKICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoc291cmNlLCBpbnN0YW5jZSwgMyAvKiBXQVRDSF9DQUxMQkFDSyAqLywgW29uQ2xlYW51cF0pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBnZXR0ZXIgPSBOT09QOwogICAgICAgICAgd2FybkludmFsaWRTb3VyY2Uoc291cmNlKTsKICAgICAgfQogICAgICBpZiAoY2IgJiYgZGVlcCkgewogICAgICAgICAgY29uc3QgYmFzZUdldHRlciA9IGdldHRlcjsKICAgICAgICAgIGdldHRlciA9ICgpID0+IHRyYXZlcnNlKGJhc2VHZXR0ZXIoKSk7CiAgICAgIH0KICAgICAgbGV0IGNsZWFudXA7CiAgICAgIGxldCBvbkNsZWFudXAgPSAoZm4pID0+IHsKICAgICAgICAgIGNsZWFudXAgPSBlZmZlY3Qub25TdG9wID0gKCkgPT4gewogICAgICAgICAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhmbiwgaW5zdGFuY2UsIDQgLyogV0FUQ0hfQ0xFQU5VUCAqLyk7CiAgICAgICAgICB9OwogICAgICB9OwogICAgICBsZXQgb2xkVmFsdWUgPSBpc011bHRpU291cmNlID8gW10gOiBJTklUSUFMX1dBVENIRVJfVkFMVUU7CiAgICAgIGNvbnN0IGpvYiA9ICgpID0+IHsKICAgICAgICAgIGlmICghZWZmZWN0LmFjdGl2ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYikgewogICAgICAgICAgICAgIC8vIHdhdGNoKHNvdXJjZSwgY2IpCiAgICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBlZmZlY3QucnVuKCk7CiAgICAgICAgICAgICAgaWYgKGRlZXAgfHwKICAgICAgICAgICAgICAgICAgZm9yY2VUcmlnZ2VyIHx8CiAgICAgICAgICAgICAgICAgIChpc011bHRpU291cmNlCiAgICAgICAgICAgICAgICAgICAgICA/IG5ld1ZhbHVlLnNvbWUoKHYsIGkpID0+IGhhc0NoYW5nZWQodiwgb2xkVmFsdWVbaV0pKQogICAgICAgICAgICAgICAgICAgICAgOiBoYXNDaGFuZ2VkKG5ld1ZhbHVlLCBvbGRWYWx1ZSkpIHx8CiAgICAgICAgICAgICAgICAgIChmYWxzZSAgKSkgewogICAgICAgICAgICAgICAgICAvLyBjbGVhbnVwIGJlZm9yZSBydW5uaW5nIGNiIGFnYWluCiAgICAgICAgICAgICAgICAgIGlmIChjbGVhbnVwKSB7CiAgICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoY2IsIGluc3RhbmNlLCAzIC8qIFdBVENIX0NBTExCQUNLICovLCBbCiAgICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgIC8vIHBhc3MgdW5kZWZpbmVkIGFzIHRoZSBvbGQgdmFsdWUgd2hlbiBpdCdzIGNoYW5nZWQgZm9yIHRoZSBmaXJzdCB0aW1lCiAgICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZSA9PT0gSU5JVElBTF9XQVRDSEVSX1ZBTFVFID8gdW5kZWZpbmVkIDogb2xkVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICBvbkNsZWFudXAKICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gd2F0Y2hFZmZlY3QKICAgICAgICAgICAgICBlZmZlY3QucnVuKCk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIC8vIGltcG9ydGFudDogbWFyayB0aGUgam9iIGFzIGEgd2F0Y2hlciBjYWxsYmFjayBzbyB0aGF0IHNjaGVkdWxlciBrbm93cwogICAgICAvLyBpdCBpcyBhbGxvd2VkIHRvIHNlbGYtdHJpZ2dlciAoIzE3MjcpCiAgICAgIGpvYi5hbGxvd1JlY3Vyc2UgPSAhIWNiOwogICAgICBsZXQgc2NoZWR1bGVyOwogICAgICBpZiAoZmx1c2ggPT09ICdzeW5jJykgewogICAgICAgICAgc2NoZWR1bGVyID0gam9iOyAvLyB0aGUgc2NoZWR1bGVyIGZ1bmN0aW9uIGdldHMgY2FsbGVkIGRpcmVjdGx5CiAgICAgIH0KICAgICAgZWxzZSBpZiAoZmx1c2ggPT09ICdwb3N0JykgewogICAgICAgICAgc2NoZWR1bGVyID0gKCkgPT4gcXVldWVQb3N0UmVuZGVyRWZmZWN0KGpvYiwgaW5zdGFuY2UgJiYgaW5zdGFuY2Uuc3VzcGVuc2UpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgLy8gZGVmYXVsdDogJ3ByZScKICAgICAgICAgIHNjaGVkdWxlciA9ICgpID0+IHF1ZXVlUHJlRmx1c2hDYihqb2IpOwogICAgICB9CiAgICAgIGNvbnN0IGVmZmVjdCA9IG5ldyBSZWFjdGl2ZUVmZmVjdChnZXR0ZXIsIHNjaGVkdWxlcik7CiAgICAgIHsKICAgICAgICAgIGVmZmVjdC5vblRyYWNrID0gb25UcmFjazsKICAgICAgICAgIGVmZmVjdC5vblRyaWdnZXIgPSBvblRyaWdnZXI7CiAgICAgIH0KICAgICAgLy8gaW5pdGlhbCBydW4KICAgICAgaWYgKGNiKSB7CiAgICAgICAgICBpZiAoaW1tZWRpYXRlKSB7CiAgICAgICAgICAgICAgam9iKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGVmZmVjdC5ydW4oKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChmbHVzaCA9PT0gJ3Bvc3QnKSB7CiAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoZWZmZWN0LnJ1bi5iaW5kKGVmZmVjdCksIGluc3RhbmNlICYmIGluc3RhbmNlLnN1c3BlbnNlKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGVmZmVjdC5ydW4oKTsKICAgICAgfQogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgZWZmZWN0LnN0b3AoKTsKICAgICAgICAgIGlmIChpbnN0YW5jZSAmJiBpbnN0YW5jZS5zY29wZSkgewogICAgICAgICAgICAgIHJlbW92ZShpbnN0YW5jZS5zY29wZS5lZmZlY3RzLCBlZmZlY3QpOwogICAgICAgICAgfQogICAgICB9OwogIH0KICAvLyB0aGlzLiR3YXRjaAogIGZ1bmN0aW9uIGluc3RhbmNlV2F0Y2goc291cmNlLCB2YWx1ZSwgb3B0aW9ucykgewogICAgICBjb25zdCBwdWJsaWNUaGlzID0gdGhpcy5wcm94eTsKICAgICAgY29uc3QgZ2V0dGVyID0gaXNTdHJpbmcoc291cmNlKQogICAgICAgICAgPyBzb3VyY2UuaW5jbHVkZXMoJy4nKQogICAgICAgICAgICAgID8gY3JlYXRlUGF0aEdldHRlcihwdWJsaWNUaGlzLCBzb3VyY2UpCiAgICAgICAgICAgICAgOiAoKSA9PiBwdWJsaWNUaGlzW3NvdXJjZV0KICAgICAgICAgIDogc291cmNlLmJpbmQocHVibGljVGhpcywgcHVibGljVGhpcyk7CiAgICAgIGxldCBjYjsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICBjYiA9IHZhbHVlOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY2IgPSB2YWx1ZS5oYW5kbGVyOwogICAgICAgICAgb3B0aW9ucyA9IHZhbHVlOwogICAgICB9CiAgICAgIGNvbnN0IGN1ciA9IGN1cnJlbnRJbnN0YW5jZTsKICAgICAgc2V0Q3VycmVudEluc3RhbmNlKHRoaXMpOwogICAgICBjb25zdCByZXMgPSBkb1dhdGNoKGdldHRlciwgY2IuYmluZChwdWJsaWNUaGlzKSwgb3B0aW9ucyk7CiAgICAgIGlmIChjdXIpIHsKICAgICAgICAgIHNldEN1cnJlbnRJbnN0YW5jZShjdXIpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgdW5zZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQYXRoR2V0dGVyKGN0eCwgcGF0aCkgewogICAgICBjb25zdCBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgIGxldCBjdXIgPSBjdHg7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlZ21lbnRzLmxlbmd0aCAmJiBjdXI7IGkrKykgewogICAgICAgICAgICAgIGN1ciA9IGN1cltzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3VyOwogICAgICB9OwogIH0KICBmdW5jdGlvbiB0cmF2ZXJzZSh2YWx1ZSwgc2VlbikgewogICAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSB8fCB2YWx1ZVsiX192X3NraXAiIC8qIFNLSVAgKi9dKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgc2VlbiA9IHNlZW4gfHwgbmV3IFNldCgpOwogICAgICBpZiAoc2Vlbi5oYXModmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgc2Vlbi5hZGQodmFsdWUpOwogICAgICBpZiAoaXNSZWYodmFsdWUpKSB7CiAgICAgICAgICB0cmF2ZXJzZSh2YWx1ZS52YWx1ZSwgc2Vlbik7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0cmF2ZXJzZSh2YWx1ZVtpXSwgc2Vlbik7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNTZXQodmFsdWUpIHx8IGlzTWFwKHZhbHVlKSkgewogICAgICAgICAgdmFsdWUuZm9yRWFjaCgodikgPT4gewogICAgICAgICAgICAgIHRyYXZlcnNlKHYsIHNlZW4pOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgdHJhdmVyc2UodmFsdWVba2V5XSwgc2Vlbik7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgZnVuY3Rpb24gdXNlVHJhbnNpdGlvblN0YXRlKCkgewogICAgICBjb25zdCBzdGF0ZSA9IHsKICAgICAgICAgIGlzTW91bnRlZDogZmFsc2UsCiAgICAgICAgICBpc0xlYXZpbmc6IGZhbHNlLAogICAgICAgICAgaXNVbm1vdW50aW5nOiBmYWxzZSwKICAgICAgICAgIGxlYXZpbmdWTm9kZXM6IG5ldyBNYXAoKQogICAgICB9OwogICAgICBvbk1vdW50ZWQoKCkgPT4gewogICAgICAgICAgc3RhdGUuaXNNb3VudGVkID0gdHJ1ZTsKICAgICAgfSk7CiAgICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7CiAgICAgICAgICBzdGF0ZS5pc1VubW91bnRpbmcgPSB0cnVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIHN0YXRlOwogIH0KICBjb25zdCBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciA9IFtGdW5jdGlvbiwgQXJyYXldOwogIGNvbnN0IEJhc2VUcmFuc2l0aW9uSW1wbCA9IHsKICAgICAgbmFtZTogYEJhc2VUcmFuc2l0aW9uYCwKICAgICAgcHJvcHM6IHsKICAgICAgICAgIG1vZGU6IFN0cmluZywKICAgICAgICAgIGFwcGVhcjogQm9vbGVhbiwKICAgICAgICAgIHBlcnNpc3RlZDogQm9vbGVhbiwKICAgICAgICAgIC8vIGVudGVyCiAgICAgICAgICBvbkJlZm9yZUVudGVyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgICAgICAgIG9uRW50ZXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgICAgICAgb25BZnRlckVudGVyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgICAgICAgIG9uRW50ZXJDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgICAgICAgLy8gbGVhdmUKICAgICAgICAgIG9uQmVmb3JlTGVhdmU6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgICAgICAgb25MZWF2ZTogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsCiAgICAgICAgICBvbkFmdGVyTGVhdmU6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgICAgICAgb25MZWF2ZUNhbmNlbGxlZDogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsCiAgICAgICAgICAvLyBhcHBlYXIKICAgICAgICAgIG9uQmVmb3JlQXBwZWFyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgICAgICAgIG9uQXBwZWFyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgICAgICAgIG9uQWZ0ZXJBcHBlYXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgICAgICAgb25BcHBlYXJDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yCiAgICAgIH0sCiAgICAgIHNldHVwKHByb3BzLCB7IHNsb3RzIH0pIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICAgICAgICBjb25zdCBzdGF0ZSA9IHVzZVRyYW5zaXRpb25TdGF0ZSgpOwogICAgICAgICAgbGV0IHByZXZUcmFuc2l0aW9uS2V5OwogICAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgICBjb25zdCBjaGlsZHJlbiA9IHNsb3RzLmRlZmF1bHQgJiYgZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKHNsb3RzLmRlZmF1bHQoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKCFjaGlsZHJlbiB8fCAhY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGV0IGNoaWxkID0gY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgbGV0IGhhc0ZvdW5kID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSBmaXJzdCBub24tY29tbWVudCBjaGlsZAogICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGMgb2YgY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjLnR5cGUgIT09IENvbW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2FybiBtb3JlIHRoYW4gb25lIG5vbi1jb21tZW50IGNoaWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMSgnPHRyYW5zaXRpb24+IGNhbiBvbmx5IGJlIHVzZWQgb24gYSBzaW5nbGUgZWxlbWVudCBvciBjb21wb25lbnQuICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1VzZSA8dHJhbnNpdGlvbi1ncm91cD4gZm9yIGxpc3RzLicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjOwogICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyB0aGVyZSdzIG5vIG5lZWQgdG8gdHJhY2sgcmVhY3Rpdml0eSBmb3IgdGhlc2UgcHJvcHMgc28gdXNlIHRoZSByYXcKICAgICAgICAgICAgICAvLyBwcm9wcyBmb3IgYSBiaXQgYmV0dGVyIHBlcmYKICAgICAgICAgICAgICBjb25zdCByYXdQcm9wcyA9IHRvUmF3KHByb3BzKTsKICAgICAgICAgICAgICBjb25zdCB7IG1vZGUgfSA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIC8vIGNoZWNrIG1vZGUKICAgICAgICAgICAgICBpZiAobW9kZSAmJgogICAgICAgICAgICAgICAgICBtb2RlICE9PSAnaW4tb3V0JyAmJgogICAgICAgICAgICAgICAgICBtb2RlICE9PSAnb3V0LWluJyAmJgogICAgICAgICAgICAgICAgICBtb2RlICE9PSAnZGVmYXVsdCcpIHsKICAgICAgICAgICAgICAgICAgd2FybiQxKGBpbnZhbGlkIDx0cmFuc2l0aW9uPiBtb2RlOiAke21vZGV9YCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzdGF0ZS5pc0xlYXZpbmcpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5UGxhY2Vob2xkZXIoY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSBvZiA8dHJhbnNpdGlvbj48a2VlcC1hbGl2ZS8+PC90cmFuc2l0aW9uPiwgd2UgbmVlZCB0bwogICAgICAgICAgICAgIC8vIGNvbXBhcmUgdGhlIHR5cGUgb2YgdGhlIGtlcHQtYWxpdmUgY2hpbGRyZW4uCiAgICAgICAgICAgICAgY29uc3QgaW5uZXJDaGlsZCA9IGdldEtlZXBBbGl2ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICBpZiAoIWlubmVyQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5UGxhY2Vob2xkZXIoY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBlbnRlckhvb2tzID0gcmVzb2x2ZVRyYW5zaXRpb25Ib29rcyhpbm5lckNoaWxkLCByYXdQcm9wcywgc3RhdGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uSG9va3MoaW5uZXJDaGlsZCwgZW50ZXJIb29rcyk7CiAgICAgICAgICAgICAgY29uc3Qgb2xkQ2hpbGQgPSBpbnN0YW5jZS5zdWJUcmVlOwogICAgICAgICAgICAgIGNvbnN0IG9sZElubmVyQ2hpbGQgPSBvbGRDaGlsZCAmJiBnZXRLZWVwQWxpdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgICAgICAgICAgbGV0IHRyYW5zaXRpb25LZXlDaGFuZ2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3QgeyBnZXRUcmFuc2l0aW9uS2V5IH0gPSBpbm5lckNoaWxkLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGdldFRyYW5zaXRpb25LZXkpIHsKICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gZ2V0VHJhbnNpdGlvbktleSgpOwogICAgICAgICAgICAgICAgICBpZiAocHJldlRyYW5zaXRpb25LZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldlRyYW5zaXRpb25LZXkgPSBrZXk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5ICE9PSBwcmV2VHJhbnNpdGlvbktleSkgewogICAgICAgICAgICAgICAgICAgICAgcHJldlRyYW5zaXRpb25LZXkgPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uS2V5Q2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gaGFuZGxlIG1vZGUKICAgICAgICAgICAgICBpZiAob2xkSW5uZXJDaGlsZCAmJgogICAgICAgICAgICAgICAgICBvbGRJbm5lckNoaWxkLnR5cGUgIT09IENvbW1lbnQgJiYKICAgICAgICAgICAgICAgICAgKCFpc1NhbWVWTm9kZVR5cGUoaW5uZXJDaGlsZCwgb2xkSW5uZXJDaGlsZCkgfHwgdHJhbnNpdGlvbktleUNoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYXZpbmdIb29rcyA9IHJlc29sdmVUcmFuc2l0aW9uSG9va3Mob2xkSW5uZXJDaGlsZCwgcmF3UHJvcHMsIHN0YXRlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSBvbGQgdHJlZSdzIGhvb2tzIGluIGNhc2Ugb2YgZHluYW1pYyB0cmFuc2l0aW9uCiAgICAgICAgICAgICAgICAgIHNldFRyYW5zaXRpb25Ib29rcyhvbGRJbm5lckNoaWxkLCBsZWF2aW5nSG9va3MpOwogICAgICAgICAgICAgICAgICAvLyBzd2l0Y2hpbmcgYmV0d2VlbiBkaWZmZXJlbnQgdmlld3MKICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdvdXQtaW4nKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5pc0xlYXZpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHBsYWNlaG9sZGVyIG5vZGUgYW5kIHF1ZXVlIHVwZGF0ZSB3aGVuIGxlYXZlIGZpbmlzaGVzCiAgICAgICAgICAgICAgICAgICAgICBsZWF2aW5nSG9va3MuYWZ0ZXJMZWF2ZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5pc0xlYXZpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS51cGRhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHlQbGFjZWhvbGRlcihjaGlsZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobW9kZSA9PT0gJ2luLW91dCcgJiYgaW5uZXJDaGlsZC50eXBlICE9PSBDb21tZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBsZWF2aW5nSG9va3MuZGVsYXlMZWF2ZSA9IChlbCwgZWFybHlSZW1vdmUsIGRlbGF5ZWRMZWF2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYXZpbmdWTm9kZXNDYWNoZSA9IGdldExlYXZpbmdOb2Rlc0ZvclR5cGUoc3RhdGUsIG9sZElubmVyQ2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGxlYXZpbmdWTm9kZXNDYWNoZVtTdHJpbmcob2xkSW5uZXJDaGlsZC5rZXkpXSA9IG9sZElubmVyQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZWFybHkgcmVtb3ZhbCBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgICAgICAgIGVsLl9sZWF2ZUNiID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXJseVJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5fbGVhdmVDYiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGVudGVySG9va3MuZGVsYXllZExlYXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW50ZXJIb29rcy5kZWxheWVkTGVhdmUgPSBkZWxheWVkTGVhdmU7CiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH07CiAgICAgIH0KICB9OwogIC8vIGV4cG9ydCB0aGUgcHVibGljIHR5cGUgZm9yIGgvdHN4IGluZmVyZW5jZQogIC8vIGFsc28gdG8gYXZvaWQgaW5saW5lIGltcG9ydCgpIGluIGdlbmVyYXRlZCBkLnRzIGZpbGVzCiAgY29uc3QgQmFzZVRyYW5zaXRpb24gPSBCYXNlVHJhbnNpdGlvbkltcGw7CiAgZnVuY3Rpb24gZ2V0TGVhdmluZ05vZGVzRm9yVHlwZShzdGF0ZSwgdm5vZGUpIHsKICAgICAgY29uc3QgeyBsZWF2aW5nVk5vZGVzIH0gPSBzdGF0ZTsKICAgICAgbGV0IGxlYXZpbmdWTm9kZXNDYWNoZSA9IGxlYXZpbmdWTm9kZXMuZ2V0KHZub2RlLnR5cGUpOwogICAgICBpZiAoIWxlYXZpbmdWTm9kZXNDYWNoZSkgewogICAgICAgICAgbGVhdmluZ1ZOb2Rlc0NhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgIGxlYXZpbmdWTm9kZXMuc2V0KHZub2RlLnR5cGUsIGxlYXZpbmdWTm9kZXNDYWNoZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlYXZpbmdWTm9kZXNDYWNoZTsKICB9CiAgLy8gVGhlIHRyYW5zaXRpb24gaG9va3MgYXJlIGF0dGFjaGVkIHRvIHRoZSB2bm9kZSBhcyB2bm9kZS50cmFuc2l0aW9uCiAgLy8gYW5kIHdpbGwgYmUgY2FsbGVkIGF0IGFwcHJvcHJpYXRlIHRpbWluZyBpbiB0aGUgcmVuZGVyZXIuCiAgZnVuY3Rpb24gcmVzb2x2ZVRyYW5zaXRpb25Ib29rcyh2bm9kZSwgcHJvcHMsIHN0YXRlLCBpbnN0YW5jZSkgewogICAgICBjb25zdCB7IGFwcGVhciwgbW9kZSwgcGVyc2lzdGVkID0gZmFsc2UsIG9uQmVmb3JlRW50ZXIsIG9uRW50ZXIsIG9uQWZ0ZXJFbnRlciwgb25FbnRlckNhbmNlbGxlZCwgb25CZWZvcmVMZWF2ZSwgb25MZWF2ZSwgb25BZnRlckxlYXZlLCBvbkxlYXZlQ2FuY2VsbGVkLCBvbkJlZm9yZUFwcGVhciwgb25BcHBlYXIsIG9uQWZ0ZXJBcHBlYXIsIG9uQXBwZWFyQ2FuY2VsbGVkIH0gPSBwcm9wczsKICAgICAgY29uc3Qga2V5ID0gU3RyaW5nKHZub2RlLmtleSk7CiAgICAgIGNvbnN0IGxlYXZpbmdWTm9kZXNDYWNoZSA9IGdldExlYXZpbmdOb2Rlc0ZvclR5cGUoc3RhdGUsIHZub2RlKTsKICAgICAgY29uc3QgY2FsbEhvb2sgPSAoaG9vaywgYXJncykgPT4gewogICAgICAgICAgaG9vayAmJgogICAgICAgICAgICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIGluc3RhbmNlLCA5IC8qIFRSQU5TSVRJT05fSE9PSyAqLywgYXJncyk7CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbGxBc3luY0hvb2sgPSAoaG9vaywgYXJncykgPT4gewogICAgICAgICAgY29uc3QgZG9uZSA9IGFyZ3NbMV07CiAgICAgICAgICBjYWxsSG9vayhob29rLCBhcmdzKTsKICAgICAgICAgIGlmIChpc0FycmF5KGhvb2spKSB7CiAgICAgICAgICAgICAgaWYgKGhvb2suZXZlcnkoaG9vayA9PiBob29rLmxlbmd0aCA8PSAxKSkKICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaG9vay5sZW5ndGggPD0gMSkgewogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgaG9va3MgPSB7CiAgICAgICAgICBtb2RlLAogICAgICAgICAgcGVyc2lzdGVkLAogICAgICAgICAgYmVmb3JlRW50ZXIoZWwpIHsKICAgICAgICAgICAgICBsZXQgaG9vayA9IG9uQmVmb3JlRW50ZXI7CiAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5pc01vdW50ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGFwcGVhcikgewogICAgICAgICAgICAgICAgICAgICAgaG9vayA9IG9uQmVmb3JlQXBwZWFyIHx8IG9uQmVmb3JlRW50ZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gZm9yIHNhbWUgZWxlbWVudCAodi1zaG93KQogICAgICAgICAgICAgIGlmIChlbC5fbGVhdmVDYikgewogICAgICAgICAgICAgICAgICBlbC5fbGVhdmVDYih0cnVlIC8qIGNhbmNlbGxlZCAqLyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGZvciB0b2dnbGVkIGVsZW1lbnQgd2l0aCBzYW1lIGtleSAodi1pZikKICAgICAgICAgICAgICBjb25zdCBsZWF2aW5nVk5vZGUgPSBsZWF2aW5nVk5vZGVzQ2FjaGVba2V5XTsKICAgICAgICAgICAgICBpZiAobGVhdmluZ1ZOb2RlICYmCiAgICAgICAgICAgICAgICAgIGlzU2FtZVZOb2RlVHlwZSh2bm9kZSwgbGVhdmluZ1ZOb2RlKSAmJgogICAgICAgICAgICAgICAgICBsZWF2aW5nVk5vZGUuZWwuX2xlYXZlQ2IpIHsKICAgICAgICAgICAgICAgICAgLy8gZm9yY2UgZWFybHkgcmVtb3ZhbCAobm90IGNhbmNlbGxlZCkKICAgICAgICAgICAgICAgICAgbGVhdmluZ1ZOb2RlLmVsLl9sZWF2ZUNiKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhbGxIb29rKGhvb2ssIFtlbF0pOwogICAgICAgICAgfSwKICAgICAgICAgIGVudGVyKGVsKSB7CiAgICAgICAgICAgICAgbGV0IGhvb2sgPSBvbkVudGVyOwogICAgICAgICAgICAgIGxldCBhZnRlckhvb2sgPSBvbkFmdGVyRW50ZXI7CiAgICAgICAgICAgICAgbGV0IGNhbmNlbEhvb2sgPSBvbkVudGVyQ2FuY2VsbGVkOwogICAgICAgICAgICAgIGlmICghc3RhdGUuaXNNb3VudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChhcHBlYXIpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2sgPSBvbkFwcGVhciB8fCBvbkVudGVyOwogICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJIb29rID0gb25BZnRlckFwcGVhciB8fCBvbkFmdGVyRW50ZXI7CiAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxIb29rID0gb25BcHBlYXJDYW5jZWxsZWQgfHwgb25FbnRlckNhbmNlbGxlZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsZXQgY2FsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3QgZG9uZSA9IChlbC5fZW50ZXJDYiA9IChjYW5jZWxsZWQpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKGNhbGxlZCkKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGNhbmNlbGxlZCkgewogICAgICAgICAgICAgICAgICAgICAgY2FsbEhvb2soY2FuY2VsSG9vaywgW2VsXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjYWxsSG9vayhhZnRlckhvb2ssIFtlbF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChob29rcy5kZWxheWVkTGVhdmUpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tzLmRlbGF5ZWRMZWF2ZSgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsLl9lbnRlckNiID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChob29rKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxBc3luY0hvb2soaG9vaywgW2VsLCBkb25lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGxlYXZlKGVsLCByZW1vdmUpIHsKICAgICAgICAgICAgICBjb25zdCBrZXkgPSBTdHJpbmcodm5vZGUua2V5KTsKICAgICAgICAgICAgICBpZiAoZWwuX2VudGVyQ2IpIHsKICAgICAgICAgICAgICAgICAgZWwuX2VudGVyQ2IodHJ1ZSAvKiBjYW5jZWxsZWQgKi8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc3RhdGUuaXNVbm1vdW50aW5nKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZW1vdmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FsbEhvb2sob25CZWZvcmVMZWF2ZSwgW2VsXSk7CiAgICAgICAgICAgICAgbGV0IGNhbGxlZCA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnN0IGRvbmUgPSAoZWwuX2xlYXZlQ2IgPSAoY2FuY2VsbGVkKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChjYWxsZWQpCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHJlbW92ZSgpOwogICAgICAgICAgICAgICAgICBpZiAoY2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYWxsSG9vayhvbkxlYXZlQ2FuY2VsbGVkLCBbZWxdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGNhbGxIb29rKG9uQWZ0ZXJMZWF2ZSwgW2VsXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWwuX2xlYXZlQ2IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIGlmIChsZWF2aW5nVk5vZGVzQ2FjaGVba2V5XSA9PT0gdm5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBsZWF2aW5nVk5vZGVzQ2FjaGVba2V5XTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGxlYXZpbmdWTm9kZXNDYWNoZVtrZXldID0gdm5vZGU7CiAgICAgICAgICAgICAgaWYgKG9uTGVhdmUpIHsKICAgICAgICAgICAgICAgICAgY2FsbEFzeW5jSG9vayhvbkxlYXZlLCBbZWwsIGRvbmVdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgY2xvbmUodm5vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZVRyYW5zaXRpb25Ib29rcyh2bm9kZSwgcHJvcHMsIHN0YXRlLCBpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBob29rczsKICB9CiAgLy8gdGhlIHBsYWNlaG9sZGVyIHJlYWxseSBvbmx5IGhhbmRsZXMgb25lIHNwZWNpYWwgY2FzZTogS2VlcEFsaXZlCiAgLy8gaW4gdGhlIGNhc2Ugb2YgYSBLZWVwQWxpdmUgaW4gYSBsZWF2ZSBwaGFzZSB3ZSBuZWVkIHRvIHJldHVybiBhIEtlZXBBbGl2ZQogIC8vIHBsYWNlaG9sZGVyIHdpdGggZW1wdHkgY29udGVudCB0byBhdm9pZCB0aGUgS2VlcEFsaXZlIGluc3RhbmNlIGZyb20gYmVpbmcKICAvLyB1bm1vdW50ZWQuCiAgZnVuY3Rpb24gZW1wdHlQbGFjZWhvbGRlcih2bm9kZSkgewogICAgICBpZiAoaXNLZWVwQWxpdmUodm5vZGUpKSB7CiAgICAgICAgICB2bm9kZSA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgICAgICAgdm5vZGUuY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgcmV0dXJuIHZub2RlOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEtlZXBBbGl2ZUNoaWxkKHZub2RlKSB7CiAgICAgIHJldHVybiBpc0tlZXBBbGl2ZSh2bm9kZSkKICAgICAgICAgID8gdm5vZGUuY2hpbGRyZW4KICAgICAgICAgICAgICA/IHZub2RlLmNoaWxkcmVuWzBdCiAgICAgICAgICAgICAgOiB1bmRlZmluZWQKICAgICAgICAgIDogdm5vZGU7CiAgfQogIGZ1bmN0aW9uIHNldFRyYW5zaXRpb25Ib29rcyh2bm9kZSwgaG9va3MpIHsKICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDYgLyogQ09NUE9ORU5UICovICYmIHZub2RlLmNvbXBvbmVudCkgewogICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKHZub2RlLmNvbXBvbmVudC5zdWJUcmVlLCBob29rcyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAodm5vZGUuc2hhcGVGbGFnICYgMTI4IC8qIFNVU1BFTlNFICovKSB7CiAgICAgICAgICB2bm9kZS5zc0NvbnRlbnQudHJhbnNpdGlvbiA9IGhvb2tzLmNsb25lKHZub2RlLnNzQ29udGVudCk7CiAgICAgICAgICB2bm9kZS5zc0ZhbGxiYWNrLnRyYW5zaXRpb24gPSBob29rcy5jbG9uZSh2bm9kZS5zc0ZhbGxiYWNrKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHZub2RlLnRyYW5zaXRpb24gPSBob29rczsKICAgICAgfQogIH0KICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4oY2hpbGRyZW4sIGtlZXBDb21tZW50ID0gZmFsc2UsIHBhcmVudEtleSkgewogICAgICBsZXQgcmV0ID0gW107CiAgICAgIGxldCBrZXllZEZyYWdtZW50Q291bnQgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBsZXQgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgIC8vICM1MzYwIGluaGVyaXQgcGFyZW50IGtleSBpbiBjYXNlIG9mIDx0ZW1wbGF0ZSB2LWZvcj4KICAgICAgICAgIGNvbnN0IGtleSA9IHBhcmVudEtleSA9PSBudWxsCiAgICAgICAgICAgICAgPyBjaGlsZC5rZXkKICAgICAgICAgICAgICA6IFN0cmluZyhwYXJlbnRLZXkpICsgU3RyaW5nKGNoaWxkLmtleSAhPSBudWxsID8gY2hpbGQua2V5IDogaSk7CiAgICAgICAgICAvLyBoYW5kbGUgZnJhZ21lbnQgY2hpbGRyZW4gY2FzZSwgZS5nLiB2LWZvcgogICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLnBhdGNoRmxhZyAmIDEyOCAvKiBLRVlFRF9GUkFHTUVOVCAqLykKICAgICAgICAgICAgICAgICAga2V5ZWRGcmFnbWVudENvdW50Kys7CiAgICAgICAgICAgICAgcmV0ID0gcmV0LmNvbmNhdChnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4oY2hpbGQuY2hpbGRyZW4sIGtlZXBDb21tZW50LCBrZXkpKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGNvbW1lbnQgcGxhY2Vob2xkZXJzIHNob3VsZCBiZSBza2lwcGVkLCBlLmcuIHYtaWYKICAgICAgICAgIGVsc2UgaWYgKGtlZXBDb21tZW50IHx8IGNoaWxkLnR5cGUgIT09IENvbW1lbnQpIHsKICAgICAgICAgICAgICByZXQucHVzaChrZXkgIT0gbnVsbCA/IGNsb25lVk5vZGUoY2hpbGQsIHsga2V5IH0pIDogY2hpbGQpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vICMxMTI2IGlmIGEgdHJhbnNpdGlvbiBjaGlsZHJlbiBsaXN0IGNvbnRhaW5zIG11bHRpcGxlIHN1YiBmcmFnbWVudHMsIHRoZXNlCiAgICAgIC8vIGZyYWdtZW50cyB3aWxsIGJlIG1lcmdlZCBpbnRvIGEgZmxhdCBjaGlsZHJlbiBhcnJheS4gU2luY2UgZWFjaCB2LWZvcgogICAgICAvLyBmcmFnbWVudCBtYXkgY29udGFpbiBkaWZmZXJlbnQgc3RhdGljIGJpbmRpbmdzIGluc2lkZSwgd2UgbmVlZCB0byBkZS1vcAogICAgICAvLyB0aGVzZSBjaGlsZHJlbiB0byBmb3JjZSBmdWxsIGRpZmZzIHRvIGVuc3VyZSBjb3JyZWN0IGJlaGF2aW9yLgogICAgICBpZiAoa2V5ZWRGcmFnbWVudENvdW50ID4gMSkgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICByZXRbaV0ucGF0Y2hGbGFnID0gLTIgLyogQkFJTCAqLzsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0OwogIH0KCiAgLy8gaW1wbGVtZW50YXRpb24sIGNsb3NlIHRvIG5vLW9wCiAgZnVuY3Rpb24gZGVmaW5lQ29tcG9uZW50KG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGlzRnVuY3Rpb24ob3B0aW9ucykgPyB7IHNldHVwOiBvcHRpb25zLCBuYW1lOiBvcHRpb25zLm5hbWUgfSA6IG9wdGlvbnM7CiAgfQoKICBjb25zdCBpc0FzeW5jV3JhcHBlciA9IChpKSA9PiAhIWkudHlwZS5fX2FzeW5jTG9hZGVyOwogIGZ1bmN0aW9uIGRlZmluZUFzeW5jQ29tcG9uZW50KHNvdXJjZSkgewogICAgICBpZiAoaXNGdW5jdGlvbihzb3VyY2UpKSB7CiAgICAgICAgICBzb3VyY2UgPSB7IGxvYWRlcjogc291cmNlIH07CiAgICAgIH0KICAgICAgY29uc3QgeyBsb2FkZXIsIGxvYWRpbmdDb21wb25lbnQsIGVycm9yQ29tcG9uZW50LCBkZWxheSA9IDIwMCwgdGltZW91dCwgLy8gdW5kZWZpbmVkID0gbmV2ZXIgdGltZXMgb3V0CiAgICAgIHN1c3BlbnNpYmxlID0gdHJ1ZSwgb25FcnJvcjogdXNlck9uRXJyb3IgfSA9IHNvdXJjZTsKICAgICAgbGV0IHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICAgICAgbGV0IHJlc29sdmVkQ29tcDsKICAgICAgbGV0IHJldHJpZXMgPSAwOwogICAgICBjb25zdCByZXRyeSA9ICgpID0+IHsKICAgICAgICAgIHJldHJpZXMrKzsKICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICAgICAgICAgIHJldHVybiBsb2FkKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IGxvYWQgPSAoKSA9PiB7CiAgICAgICAgICBsZXQgdGhpc1JlcXVlc3Q7CiAgICAgICAgICByZXR1cm4gKHBlbmRpbmdSZXF1ZXN0IHx8CiAgICAgICAgICAgICAgKHRoaXNSZXF1ZXN0ID0gcGVuZGluZ1JlcXVlc3QgPQogICAgICAgICAgICAgICAgICBsb2FkZXIoKQogICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBlcnIgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyKSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlck9uRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyUmV0cnkgPSAoKSA9PiByZXNvbHZlKHJldHJ5KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyRmFpbCA9ICgpID0+IHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyT25FcnJvcihlcnIsIHVzZXJSZXRyeSwgdXNlckZhaWwsIHJldHJpZXMgKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChjb21wKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1JlcXVlc3QgIT09IHBlbmRpbmdSZXF1ZXN0ICYmIHBlbmRpbmdSZXF1ZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBlbmRpbmdSZXF1ZXN0OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBBc3luYyBjb21wb25lbnQgbG9hZGVyIHJlc29sdmVkIHRvIHVuZGVmaW5lZC4gYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBJZiB5b3UgYXJlIHVzaW5nIHJldHJ5KCksIG1ha2Ugc3VyZSB0byByZXR1cm4gaXRzIHJldHVybiB2YWx1ZS5gKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIC8vIGludGVyb3AgbW9kdWxlIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvbXAuX19lc01vZHVsZSB8fCBjb21wW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICdNb2R1bGUnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXAgPSBjb21wLmRlZmF1bHQ7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcCAmJiAhaXNPYmplY3QoY29tcCkgJiYgIWlzRnVuY3Rpb24oY29tcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXN5bmMgY29tcG9uZW50IGxvYWQgcmVzdWx0OiAke2NvbXB9YCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZENvbXAgPSBjb21wOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXA7CiAgICAgICAgICAgICAgICAgIH0pKSk7CiAgICAgIH07CiAgICAgIHJldHVybiBkZWZpbmVDb21wb25lbnQoewogICAgICAgICAgbmFtZTogJ0FzeW5jQ29tcG9uZW50V3JhcHBlcicsCiAgICAgICAgICBfX2FzeW5jTG9hZGVyOiBsb2FkLAogICAgICAgICAgZ2V0IF9fYXN5bmNSZXNvbHZlZCgpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRDb21wOwogICAgICAgICAgfSwKICAgICAgICAgIHNldHVwKCkgewogICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gY3VycmVudEluc3RhbmNlOwogICAgICAgICAgICAgIC8vIGFscmVhZHkgcmVzb2x2ZWQKICAgICAgICAgICAgICBpZiAocmVzb2x2ZWRDb21wKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiAoKSA9PiBjcmVhdGVJbm5lckNvbXAocmVzb2x2ZWRDb21wLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG9uRXJyb3IgPSAoZXJyKSA9PiB7CiAgICAgICAgICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgaGFuZGxlRXJyb3IoZXJyLCBpbnN0YW5jZSwgMTMgLyogQVNZTkNfQ09NUE9ORU5UX0xPQURFUiAqLywgIWVycm9yQ29tcG9uZW50IC8qIGRvIG5vdCB0aHJvdyBpbiBkZXYgaWYgdXNlciBwcm92aWRlZCBlcnJvciBjb21wb25lbnQgKi8pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgLy8gc3VzcGVuc2UtY29udHJvbGxlZCBvciBTU1IuCiAgICAgICAgICAgICAgaWYgKChzdXNwZW5zaWJsZSAmJiBpbnN0YW5jZS5zdXNwZW5zZSkgfHwKICAgICAgICAgICAgICAgICAgKGZhbHNlICkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvYWQoKQogICAgICAgICAgICAgICAgICAgICAgLnRoZW4oY29tcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCkgPT4gY3JlYXRlSW5uZXJDb21wKGNvbXAsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gewogICAgICAgICAgICAgICAgICAgICAgb25FcnJvcihlcnIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgpID0+IGVycm9yQ29tcG9uZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjcmVhdGVWTm9kZShlcnJvckNvbXBvbmVudCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBsb2FkZWQgPSByZWYoZmFsc2UpOwogICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gcmVmKCk7CiAgICAgICAgICAgICAgY29uc3QgZGVsYXllZCA9IHJlZighIWRlbGF5KTsKICAgICAgICAgICAgICBpZiAoZGVsYXkpIHsKICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBkZWxheWVkLnZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0sIGRlbGF5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRpbWVvdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghbG9hZGVkLnZhbHVlICYmICFlcnJvci52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihgQXN5bmMgY29tcG9uZW50IHRpbWVkIG91dCBhZnRlciAke3RpbWVvdXR9bXMuYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb25FcnJvcihlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnZhbHVlID0gZXJyOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9hZCgpCiAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHsKICAgICAgICAgICAgICAgICAgbG9hZGVkLnZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnBhcmVudCAmJiBpc0tlZXBBbGl2ZShpbnN0YW5jZS5wYXJlbnQudm5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBwYXJlbnQgaXMga2VlcC1hbGl2ZSwgZm9yY2UgdXBkYXRlIHNvIHRoZSBsb2FkZWQgY29tcG9uZW50J3MKICAgICAgICAgICAgICAgICAgICAgIC8vIG5hbWUgaXMgdGFrZW4gaW50byBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICBxdWV1ZUpvYihpbnN0YW5jZS5wYXJlbnQudXBkYXRlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4gewogICAgICAgICAgICAgICAgICBvbkVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgIGVycm9yLnZhbHVlID0gZXJyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChsb2FkZWQudmFsdWUgJiYgcmVzb2x2ZWRDb21wKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlSW5uZXJDb21wKHJlc29sdmVkQ29tcCwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVycm9yLnZhbHVlICYmIGVycm9yQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUoZXJyb3JDb21wb25lbnQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudmFsdWUKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGxvYWRpbmdDb21wb25lbnQgJiYgIWRlbGF5ZWQudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZShsb2FkaW5nQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgIH0pOwogIH0KICBmdW5jdGlvbiBjcmVhdGVJbm5lckNvbXAoY29tcCwgeyB2bm9kZTogeyByZWYsIHByb3BzLCBjaGlsZHJlbiwgc2hhcGVGbGFnIH0sIHBhcmVudCB9KSB7CiAgICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUoY29tcCwgcHJvcHMsIGNoaWxkcmVuKTsKICAgICAgLy8gZW5zdXJlIGlubmVyIGNvbXBvbmVudCBpbmhlcml0cyB0aGUgYXN5bmMgd3JhcHBlcidzIHJlZiBvd25lcgogICAgICB2bm9kZS5yZWYgPSByZWY7CiAgICAgIHJldHVybiB2bm9kZTsKICB9CgogIGNvbnN0IGlzS2VlcEFsaXZlID0gKHZub2RlKSA9PiB2bm9kZS50eXBlLl9faXNLZWVwQWxpdmU7CiAgY29uc3QgS2VlcEFsaXZlSW1wbCA9IHsKICAgICAgbmFtZTogYEtlZXBBbGl2ZWAsCiAgICAgIC8vIE1hcmtlciBmb3Igc3BlY2lhbCBoYW5kbGluZyBpbnNpZGUgdGhlIHJlbmRlcmVyLiBXZSBhcmUgbm90IHVzaW5nIGEgPT09CiAgICAgIC8vIGNoZWNrIGRpcmVjdGx5IG9uIEtlZXBBbGl2ZSBpbiB0aGUgcmVuZGVyZXIsIGJlY2F1c2UgaW1wb3J0aW5nIGl0IGRpcmVjdGx5CiAgICAgIC8vIHdvdWxkIHByZXZlbnQgaXQgZnJvbSBiZWluZyB0cmVlLXNoYWtlbi4KICAgICAgX19pc0tlZXBBbGl2ZTogdHJ1ZSwKICAgICAgcHJvcHM6IHsKICAgICAgICAgIGluY2x1ZGU6IFtTdHJpbmcsIFJlZ0V4cCwgQXJyYXldLAogICAgICAgICAgZXhjbHVkZTogW1N0cmluZywgUmVnRXhwLCBBcnJheV0sCiAgICAgICAgICBtYXg6IFtTdHJpbmcsIE51bWJlcl0KICAgICAgfSwKICAgICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgewogICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgICAgICAgIC8vIEtlZXBBbGl2ZSBjb21tdW5pY2F0ZXMgd2l0aCB0aGUgaW5zdGFudGlhdGVkIHJlbmRlcmVyIHZpYSB0aGUKICAgICAgICAgIC8vIGN0eCB3aGVyZSB0aGUgcmVuZGVyZXIgcGFzc2VzIGluIGl0cyBpbnRlcm5hbHMsCiAgICAgICAgICAvLyBhbmQgdGhlIEtlZXBBbGl2ZSBpbnN0YW5jZSBleHBvc2VzIGFjdGl2YXRlL2RlYWN0aXZhdGUgaW1wbGVtZW50YXRpb25zLgogICAgICAgICAgLy8gVGhlIHdob2xlIHBvaW50IG9mIHRoaXMgaXMgdG8gYXZvaWQgaW1wb3J0aW5nIEtlZXBBbGl2ZSBkaXJlY3RseSBpbiB0aGUKICAgICAgICAgIC8vIHJlbmRlcmVyIHRvIGZhY2lsaXRhdGUgdHJlZS1zaGFraW5nLgogICAgICAgICAgY29uc3Qgc2hhcmVkQ29udGV4dCA9IGluc3RhbmNlLmN0eDsKICAgICAgICAgIGNvbnN0IGNhY2hlID0gbmV3IE1hcCgpOwogICAgICAgICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoKTsKICAgICAgICAgIGxldCBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3ZfY2FjaGUgPSBjYWNoZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBhcmVudFN1c3BlbnNlID0gaW5zdGFuY2Uuc3VzcGVuc2U7CiAgICAgICAgICBjb25zdCB7IHJlbmRlcmVyOiB7IHA6IHBhdGNoLCBtOiBtb3ZlLCB1bTogX3VubW91bnQsIG86IHsgY3JlYXRlRWxlbWVudCB9IH0gfSA9IHNoYXJlZENvbnRleHQ7CiAgICAgICAgICBjb25zdCBzdG9yYWdlQ29udGFpbmVyID0gY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICBzaGFyZWRDb250ZXh0LmFjdGl2YXRlID0gKHZub2RlLCBjb250YWluZXIsIGFuY2hvciwgaXNTVkcsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gdm5vZGUuY29tcG9uZW50OwogICAgICAgICAgICAgIG1vdmUodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCAwIC8qIEVOVEVSICovLCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICAgICAgLy8gaW4gY2FzZSBwcm9wcyBoYXZlIGNoYW5nZWQKICAgICAgICAgICAgICBwYXRjaChpbnN0YW5jZS52bm9kZSwgdm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBpbnN0YW5jZSwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCB2bm9kZS5zbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuaXNEZWFjdGl2YXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuYSkgewogICAgICAgICAgICAgICAgICAgICAgaW52b2tlQXJyYXlGbnMoaW5zdGFuY2UuYSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3Qgdm5vZGVIb29rID0gdm5vZGUucHJvcHMgJiYgdm5vZGUucHJvcHMub25Wbm9kZU1vdW50ZWQ7CiAgICAgICAgICAgICAgICAgIGlmICh2bm9kZUhvb2spIHsKICAgICAgICAgICAgICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIGluc3RhbmNlLnBhcmVudCwgdm5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGNvbXBvbmVudHMgdHJlZQogICAgICAgICAgICAgICAgICBkZXZ0b29sc0NvbXBvbmVudEFkZGVkKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2hhcmVkQ29udGV4dC5kZWFjdGl2YXRlID0gKHZub2RlKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnQ7CiAgICAgICAgICAgICAgbW92ZSh2bm9kZSwgc3RvcmFnZUNvbnRhaW5lciwgbnVsbCwgMSAvKiBMRUFWRSAqLywgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5kYSkgewogICAgICAgICAgICAgICAgICAgICAgaW52b2tlQXJyYXlGbnMoaW5zdGFuY2UuZGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnN0IHZub2RlSG9vayA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLm9uVm5vZGVVbm1vdW50ZWQ7CiAgICAgICAgICAgICAgICAgIGlmICh2bm9kZUhvb2spIHsKICAgICAgICAgICAgICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIGluc3RhbmNlLnBhcmVudCwgdm5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmlzRGVhY3RpdmF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjb21wb25lbnRzIHRyZWUKICAgICAgICAgICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRBZGRlZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIHVubW91bnQodm5vZGUpIHsKICAgICAgICAgICAgICAvLyByZXNldCB0aGUgc2hhcGVGbGFnIHNvIGl0IGNhbiBiZSBwcm9wZXJseSB1bm1vdW50ZWQKICAgICAgICAgICAgICByZXNldFNoYXBlRmxhZyh2bm9kZSk7CiAgICAgICAgICAgICAgX3VubW91bnQodm5vZGUsIGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcnVuZUNhY2hlKGZpbHRlcikgewogICAgICAgICAgICAgIGNhY2hlLmZvckVhY2goKHZub2RlLCBrZXkpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IGdldENvbXBvbmVudE5hbWUodm5vZGUudHlwZSk7CiAgICAgICAgICAgICAgICAgIGlmIChuYW1lICYmICghZmlsdGVyIHx8ICFmaWx0ZXIobmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoa2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcHJ1bmVDYWNoZUVudHJ5KGtleSkgewogICAgICAgICAgICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChrZXkpOwogICAgICAgICAgICAgIGlmICghY3VycmVudCB8fCBjYWNoZWQudHlwZSAhPT0gY3VycmVudC50eXBlKSB7CiAgICAgICAgICAgICAgICAgIHVubW91bnQoY2FjaGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoY3VycmVudCkgewogICAgICAgICAgICAgICAgICAvLyBjdXJyZW50IGFjdGl2ZSBpbnN0YW5jZSBzaG91bGQgbm8gbG9uZ2VyIGJlIGtlcHQtYWxpdmUuCiAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVubW91bnQgaXQgbm93IGJ1dCBpdCBtaWdodCBiZSBsYXRlciwgc28gcmVzZXQgaXRzIGZsYWcgbm93LgogICAgICAgICAgICAgICAgICByZXNldFNoYXBlRmxhZyhjdXJyZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FjaGUuZGVsZXRlKGtleSk7CiAgICAgICAgICAgICAga2V5cy5kZWxldGUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHBydW5lIGNhY2hlIG9uIGluY2x1ZGUvZXhjbHVkZSBwcm9wIGNoYW5nZQogICAgICAgICAgd2F0Y2goKCkgPT4gW3Byb3BzLmluY2x1ZGUsIHByb3BzLmV4Y2x1ZGVdLCAoW2luY2x1ZGUsIGV4Y2x1ZGVdKSA9PiB7CiAgICAgICAgICAgICAgaW5jbHVkZSAmJiBwcnVuZUNhY2hlKG5hbWUgPT4gbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSk7CiAgICAgICAgICAgICAgZXhjbHVkZSAmJiBwcnVuZUNhY2hlKG5hbWUgPT4gIW1hdGNoZXMoZXhjbHVkZSwgbmFtZSkpOwogICAgICAgICAgfSwgCiAgICAgICAgICAvLyBwcnVuZSBwb3N0LXJlbmRlciBhZnRlciBgY3VycmVudGAgaGFzIGJlZW4gdXBkYXRlZAogICAgICAgICAgeyBmbHVzaDogJ3Bvc3QnLCBkZWVwOiB0cnVlIH0pOwogICAgICAgICAgLy8gY2FjaGUgc3ViIHRyZWUgYWZ0ZXIgcmVuZGVyCiAgICAgICAgICBsZXQgcGVuZGluZ0NhY2hlS2V5ID0gbnVsbDsKICAgICAgICAgIGNvbnN0IGNhY2hlU3VidHJlZSA9ICgpID0+IHsKICAgICAgICAgICAgICAvLyBmaXggIzE2MjEsIHRoZSBwZW5kaW5nQ2FjaGVLZXkgY291bGQgYmUgMAogICAgICAgICAgICAgIGlmIChwZW5kaW5nQ2FjaGVLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjYWNoZS5zZXQocGVuZGluZ0NhY2hlS2V5LCBnZXRJbm5lckNoaWxkKGluc3RhbmNlLnN1YlRyZWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb25Nb3VudGVkKGNhY2hlU3VidHJlZSk7CiAgICAgICAgICBvblVwZGF0ZWQoY2FjaGVTdWJ0cmVlKTsKICAgICAgICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7CiAgICAgICAgICAgICAgY2FjaGUuZm9yRWFjaChjYWNoZWQgPT4gewogICAgICAgICAgICAgICAgICBjb25zdCB7IHN1YlRyZWUsIHN1c3BlbnNlIH0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgY29uc3Qgdm5vZGUgPSBnZXRJbm5lckNoaWxkKHN1YlRyZWUpOwogICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkLnR5cGUgPT09IHZub2RlLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnQgaW5zdGFuY2Ugd2lsbCBiZSB1bm1vdW50ZWQgYXMgcGFydCBvZiBrZWVwLWFsaXZlJ3MgdW5tb3VudAogICAgICAgICAgICAgICAgICAgICAgcmVzZXRTaGFwZUZsYWcodm5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGludm9rZSBpdHMgZGVhY3RpdmF0ZWQgaG9vayBoZXJlCiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYSA9IHZub2RlLmNvbXBvbmVudC5kYTsKICAgICAgICAgICAgICAgICAgICAgIGRhICYmIHF1ZXVlUG9zdFJlbmRlckVmZmVjdChkYSwgc3VzcGVuc2UpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVubW91bnQoY2FjaGVkKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgICBwZW5kaW5nQ2FjaGVLZXkgPSBudWxsOwogICAgICAgICAgICAgIGlmICghc2xvdHMuZGVmYXVsdCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBzbG90cy5kZWZhdWx0KCk7CiAgICAgICAgICAgICAgY29uc3QgcmF3Vk5vZGUgPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEtlZXBBbGl2ZSBzaG91bGQgY29udGFpbiBleGFjdGx5IG9uZSBjb21wb25lbnQgY2hpbGQuYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoIWlzVk5vZGUocmF3Vk5vZGUpIHx8CiAgICAgICAgICAgICAgICAgICghKHJhd1ZOb2RlLnNoYXBlRmxhZyAmIDQgLyogU1RBVEVGVUxfQ09NUE9ORU5UICovKSAmJgogICAgICAgICAgICAgICAgICAgICAgIShyYXdWTm9kZS5zaGFwZUZsYWcgJiAxMjggLyogU1VTUEVOU0UgKi8pKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJhd1ZOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsZXQgdm5vZGUgPSBnZXRJbm5lckNoaWxkKHJhd1ZOb2RlKTsKICAgICAgICAgICAgICBjb25zdCBjb21wID0gdm5vZGUudHlwZTsKICAgICAgICAgICAgICAvLyBmb3IgYXN5bmMgY29tcG9uZW50cywgbmFtZSBjaGVjayBzaG91bGQgYmUgYmFzZWQgaW4gaXRzIGxvYWRlZAogICAgICAgICAgICAgIC8vIGlubmVyIGNvbXBvbmVudCBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICBjb25zdCBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShpc0FzeW5jV3JhcHBlcih2bm9kZSkKICAgICAgICAgICAgICAgICAgPyB2bm9kZS50eXBlLl9fYXN5bmNSZXNvbHZlZCB8fCB7fQogICAgICAgICAgICAgICAgICA6IGNvbXApOwogICAgICAgICAgICAgIGNvbnN0IHsgaW5jbHVkZSwgZXhjbHVkZSwgbWF4IH0gPSBwcm9wczsKICAgICAgICAgICAgICBpZiAoKGluY2x1ZGUgJiYgKCFuYW1lIHx8ICFtYXRjaGVzKGluY2x1ZGUsIG5hbWUpKSkgfHwKICAgICAgICAgICAgICAgICAgKGV4Y2x1ZGUgJiYgbmFtZSAmJiBtYXRjaGVzKGV4Y2x1ZGUsIG5hbWUpKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdm5vZGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiByYXdWTm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gdm5vZGUua2V5ID09IG51bGwgPyBjb21wIDogdm5vZGUua2V5OwogICAgICAgICAgICAgIGNvbnN0IGNhY2hlZFZOb2RlID0gY2FjaGUuZ2V0KGtleSk7CiAgICAgICAgICAgICAgLy8gY2xvbmUgdm5vZGUgaWYgaXQncyByZXVzZWQgYmVjYXVzZSB3ZSBhcmUgZ29pbmcgdG8gbXV0YXRlIGl0CiAgICAgICAgICAgICAgaWYgKHZub2RlLmVsKSB7CiAgICAgICAgICAgICAgICAgIHZub2RlID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdWTm9kZS5zaGFwZUZsYWcgJiAxMjggLyogU1VTUEVOU0UgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIHJhd1ZOb2RlLnNzQ29udGVudCA9IHZub2RlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vICMxNTEzIGl0J3MgcG9zc2libGUgZm9yIHRoZSByZXR1cm5lZCB2bm9kZSB0byBiZSBjbG9uZWQgZHVlIHRvIGF0dHIKICAgICAgICAgICAgICAvLyBmYWxsdGhyb3VnaCBvciBzY29wZUlkLCBzbyB0aGUgdm5vZGUgaGVyZSBtYXkgbm90IGJlIHRoZSBmaW5hbCB2bm9kZQogICAgICAgICAgICAgIC8vIHRoYXQgaXMgbW91bnRlZC4gSW5zdGVhZCBvZiBjYWNoaW5nIGl0IGRpcmVjdGx5LCB3ZSBzdG9yZSB0aGUgcGVuZGluZwogICAgICAgICAgICAgIC8vIGtleSBhbmQgY2FjaGUgYGluc3RhbmNlLnN1YlRyZWVgICh0aGUgbm9ybWFsaXplZCB2bm9kZSkgaW4KICAgICAgICAgICAgICAvLyBiZWZvcmVNb3VudC9iZWZvcmVVcGRhdGUgaG9va3MuCiAgICAgICAgICAgICAgcGVuZGluZ0NhY2hlS2V5ID0ga2V5OwogICAgICAgICAgICAgIGlmIChjYWNoZWRWTm9kZSkgewogICAgICAgICAgICAgICAgICAvLyBjb3B5IG92ZXIgbW91bnRlZCBzdGF0ZQogICAgICAgICAgICAgICAgICB2bm9kZS5lbCA9IGNhY2hlZFZOb2RlLmVsOwogICAgICAgICAgICAgICAgICB2bm9kZS5jb21wb25lbnQgPSBjYWNoZWRWTm9kZS5jb21wb25lbnQ7CiAgICAgICAgICAgICAgICAgIGlmICh2bm9kZS50cmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyByZWN1cnNpdmVseSB1cGRhdGUgdHJhbnNpdGlvbiBob29rcyBvbiBzdWJUcmVlCiAgICAgICAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uSG9va3Modm5vZGUsIHZub2RlLnRyYW5zaXRpb24pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIGF2b2lkIHZub2RlIGJlaW5nIG1vdW50ZWQgYXMgZnJlc2gKICAgICAgICAgICAgICAgICAgdm5vZGUuc2hhcGVGbGFnIHw9IDUxMiAvKiBDT01QT05FTlRfS0VQVF9BTElWRSAqLzsKICAgICAgICAgICAgICAgICAgLy8gbWFrZSB0aGlzIGtleSB0aGUgZnJlc2hlc3QKICAgICAgICAgICAgICAgICAga2V5cy5kZWxldGUoa2V5KTsKICAgICAgICAgICAgICAgICAga2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGtleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgIC8vIHBydW5lIG9sZGVzdCBlbnRyeQogICAgICAgICAgICAgICAgICBpZiAobWF4ICYmIGtleXMuc2l6ZSA+IHBhcnNlSW50KG1heCwgMTApKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoa2V5cy52YWx1ZXMoKS5uZXh0KCkudmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGF2b2lkIHZub2RlIGJlaW5nIHVubW91bnRlZAogICAgICAgICAgICAgIHZub2RlLnNoYXBlRmxhZyB8PSAyNTYgLyogQ09NUE9ORU5UX1NIT1VMRF9LRUVQX0FMSVZFICovOwogICAgICAgICAgICAgIGN1cnJlbnQgPSB2bm9kZTsKICAgICAgICAgICAgICByZXR1cm4gaXNTdXNwZW5zZShyYXdWTm9kZS50eXBlKSA/IHJhd1ZOb2RlIDogdm5vZGU7CiAgICAgICAgICB9OwogICAgICB9CiAgfTsKICAvLyBleHBvcnQgdGhlIHB1YmxpYyB0eXBlIGZvciBoL3RzeCBpbmZlcmVuY2UKICAvLyBhbHNvIHRvIGF2b2lkIGlubGluZSBpbXBvcnQoKSBpbiBnZW5lcmF0ZWQgZC50cyBmaWxlcwogIGNvbnN0IEtlZXBBbGl2ZSA9IEtlZXBBbGl2ZUltcGw7CiAgZnVuY3Rpb24gbWF0Y2hlcyhwYXR0ZXJuLCBuYW1lKSB7CiAgICAgIGlmIChpc0FycmF5KHBhdHRlcm4pKSB7CiAgICAgICAgICByZXR1cm4gcGF0dGVybi5zb21lKChwKSA9PiBtYXRjaGVzKHAsIG5hbWUpKTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc1N0cmluZyhwYXR0ZXJuKSkgewogICAgICAgICAgcmV0dXJuIHBhdHRlcm4uc3BsaXQoJywnKS5pbmNsdWRlcyhuYW1lKTsKICAgICAgfQogICAgICBlbHNlIGlmIChwYXR0ZXJuLnRlc3QpIHsKICAgICAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QobmFtZSk7CiAgICAgIH0KICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiBvbkFjdGl2YXRlZChob29rLCB0YXJnZXQpIHsKICAgICAgcmVnaXN0ZXJLZWVwQWxpdmVIb29rKGhvb2ssICJhIiAvKiBBQ1RJVkFURUQgKi8sIHRhcmdldCk7CiAgfQogIGZ1bmN0aW9uIG9uRGVhY3RpdmF0ZWQoaG9vaywgdGFyZ2V0KSB7CiAgICAgIHJlZ2lzdGVyS2VlcEFsaXZlSG9vayhob29rLCAiZGEiIC8qIERFQUNUSVZBVEVEICovLCB0YXJnZXQpOwogIH0KICBmdW5jdGlvbiByZWdpc3RlcktlZXBBbGl2ZUhvb2soaG9vaywgdHlwZSwgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlKSB7CiAgICAgIC8vIGNhY2hlIHRoZSBkZWFjdGl2YXRlIGJyYW5jaCBjaGVjayB3cmFwcGVyIGZvciBpbmplY3RlZCBob29rcyBzbyB0aGUgc2FtZQogICAgICAvLyBob29rIGNhbiBiZSBwcm9wZXJseSBkZWR1cGVkIGJ5IHRoZSBzY2hlZHVsZXIuICJfX3dkYyIgc3RhbmRzIGZvciAid2l0aAogICAgICAvLyBkZWFjdGl2YXRpb24gY2hlY2siLgogICAgICBjb25zdCB3cmFwcGVkSG9vayA9IGhvb2suX193ZGMgfHwKICAgICAgICAgIChob29rLl9fd2RjID0gKCkgPT4gewogICAgICAgICAgICAgIC8vIG9ubHkgZmlyZSB0aGUgaG9vayBpZiB0aGUgdGFyZ2V0IGluc3RhbmNlIGlzIE5PVCBpbiBhIGRlYWN0aXZhdGVkIGJyYW5jaC4KICAgICAgICAgICAgICBsZXQgY3VycmVudCA9IHRhcmdldDsKICAgICAgICAgICAgICB3aGlsZSAoY3VycmVudCkgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5pc0RlYWN0aXZhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gaG9vaygpOwogICAgICAgICAgfSk7CiAgICAgIGluamVjdEhvb2sodHlwZSwgd3JhcHBlZEhvb2ssIHRhcmdldCk7CiAgICAgIC8vIEluIGFkZGl0aW9uIHRvIHJlZ2lzdGVyaW5nIGl0IG9uIHRoZSB0YXJnZXQgaW5zdGFuY2UsIHdlIHdhbGsgdXAgdGhlIHBhcmVudAogICAgICAvLyBjaGFpbiBhbmQgcmVnaXN0ZXIgaXQgb24gYWxsIGFuY2VzdG9yIGluc3RhbmNlcyB0aGF0IGFyZSBrZWVwLWFsaXZlIHJvb3RzLgogICAgICAvLyBUaGlzIGF2b2lkcyB0aGUgbmVlZCB0byB3YWxrIHRoZSBlbnRpcmUgY29tcG9uZW50IHRyZWUgd2hlbiBpbnZva2luZyB0aGVzZQogICAgICAvLyBob29rcywgYW5kIG1vcmUgaW1wb3J0YW50bHksIGF2b2lkcyB0aGUgbmVlZCB0byB0cmFjayBjaGlsZCBjb21wb25lbnRzIGluCiAgICAgIC8vIGFycmF5cy4KICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgbGV0IGN1cnJlbnQgPSB0YXJnZXQucGFyZW50OwogICAgICAgICAgd2hpbGUgKGN1cnJlbnQgJiYgY3VycmVudC5wYXJlbnQpIHsKICAgICAgICAgICAgICBpZiAoaXNLZWVwQWxpdmUoY3VycmVudC5wYXJlbnQudm5vZGUpKSB7CiAgICAgICAgICAgICAgICAgIGluamVjdFRvS2VlcEFsaXZlUm9vdCh3cmFwcGVkSG9vaywgdHlwZSwgdGFyZ2V0LCBjdXJyZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50OwogICAgICAgICAgfQogICAgICB9CiAgfQogIGZ1bmN0aW9uIGluamVjdFRvS2VlcEFsaXZlUm9vdChob29rLCB0eXBlLCB0YXJnZXQsIGtlZXBBbGl2ZVJvb3QpIHsKICAgICAgLy8gaW5qZWN0SG9vayB3cmFwcyB0aGUgb3JpZ2luYWwgZm9yIGVycm9yIGhhbmRsaW5nLCBzbyBtYWtlIHN1cmUgdG8gcmVtb3ZlCiAgICAgIC8vIHRoZSB3cmFwcGVkIHZlcnNpb24uCiAgICAgIGNvbnN0IGluamVjdGVkID0gaW5qZWN0SG9vayh0eXBlLCBob29rLCBrZWVwQWxpdmVSb290LCB0cnVlIC8qIHByZXBlbmQgKi8pOwogICAgICBvblVubW91bnRlZCgoKSA9PiB7CiAgICAgICAgICByZW1vdmUoa2VlcEFsaXZlUm9vdFt0eXBlXSwgaW5qZWN0ZWQpOwogICAgICB9LCB0YXJnZXQpOwogIH0KICBmdW5jdGlvbiByZXNldFNoYXBlRmxhZyh2bm9kZSkgewogICAgICBsZXQgc2hhcGVGbGFnID0gdm5vZGUuc2hhcGVGbGFnOwogICAgICBpZiAoc2hhcGVGbGFnICYgMjU2IC8qIENPTVBPTkVOVF9TSE9VTERfS0VFUF9BTElWRSAqLykgewogICAgICAgICAgc2hhcGVGbGFnIC09IDI1NiAvKiBDT01QT05FTlRfU0hPVUxEX0tFRVBfQUxJVkUgKi87CiAgICAgIH0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDUxMiAvKiBDT01QT05FTlRfS0VQVF9BTElWRSAqLykgewogICAgICAgICAgc2hhcGVGbGFnIC09IDUxMiAvKiBDT01QT05FTlRfS0VQVF9BTElWRSAqLzsKICAgICAgfQogICAgICB2bm9kZS5zaGFwZUZsYWcgPSBzaGFwZUZsYWc7CiAgfQogIGZ1bmN0aW9uIGdldElubmVyQ2hpbGQodm5vZGUpIHsKICAgICAgcmV0dXJuIHZub2RlLnNoYXBlRmxhZyAmIDEyOCAvKiBTVVNQRU5TRSAqLyA/IHZub2RlLnNzQ29udGVudCA6IHZub2RlOwogIH0KCiAgZnVuY3Rpb24gaW5qZWN0SG9vayh0eXBlLCBob29rLCB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2UsIHByZXBlbmQgPSBmYWxzZSkgewogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICBjb25zdCBob29rcyA9IHRhcmdldFt0eXBlXSB8fCAodGFyZ2V0W3R5cGVdID0gW10pOwogICAgICAgICAgLy8gY2FjaGUgdGhlIGVycm9yIGhhbmRsaW5nIHdyYXBwZXIgZm9yIGluamVjdGVkIGhvb2tzIHNvIHRoZSBzYW1lIGhvb2sKICAgICAgICAgIC8vIGNhbiBiZSBwcm9wZXJseSBkZWR1cGVkIGJ5IHRoZSBzY2hlZHVsZXIuICJfX3dlaCIgc3RhbmRzIGZvciAid2l0aCBlcnJvcgogICAgICAgICAgLy8gaGFuZGxpbmciLgogICAgICAgICAgY29uc3Qgd3JhcHBlZEhvb2sgPSBob29rLl9fd2VoIHx8CiAgICAgICAgICAgICAgKGhvb2suX193ZWggPSAoLi4uYXJncykgPT4gewogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LmlzVW5tb3VudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gZGlzYWJsZSB0cmFja2luZyBpbnNpZGUgYWxsIGxpZmVjeWNsZSBob29rcwogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB0aGV5IGNhbiBwb3RlbnRpYWxseSBiZSBjYWxsZWQgaW5zaWRlIGVmZmVjdHMuCiAgICAgICAgICAgICAgICAgIHBhdXNlVHJhY2tpbmcoKTsKICAgICAgICAgICAgICAgICAgLy8gU2V0IGN1cnJlbnRJbnN0YW5jZSBkdXJpbmcgaG9vayBpbnZvY2F0aW9uLgogICAgICAgICAgICAgICAgICAvLyBUaGlzIGFzc3VtZXMgdGhlIGhvb2sgZG9lcyBub3Qgc3luY2hyb25vdXNseSB0cmlnZ2VyIG90aGVyIGhvb2tzLCB3aGljaAogICAgICAgICAgICAgICAgICAvLyBjYW4gb25seSBiZSBmYWxzZSB3aGVuIHRoZSB1c2VyIGRvZXMgc29tZXRoaW5nIHJlYWxseSBmdW5reS4KICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEluc3RhbmNlKHRhcmdldCk7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIHRhcmdldCwgdHlwZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgIHVuc2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHJlc2V0VHJhY2tpbmcoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChwcmVwZW5kKSB7CiAgICAgICAgICAgICAgaG9va3MudW5zaGlmdCh3cmFwcGVkSG9vayk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBob29rcy5wdXNoKHdyYXBwZWRIb29rKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3cmFwcGVkSG9vazsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IGFwaU5hbWUgPSB0b0hhbmRsZXJLZXkoRXJyb3JUeXBlU3RyaW5nc1t0eXBlXS5yZXBsYWNlKC8gaG9vayQvLCAnJykpOwogICAgICAgICAgd2FybiQxKGAke2FwaU5hbWV9IGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UgdG8gYmUgYCArCiAgICAgICAgICAgICAgYGFzc29jaWF0ZWQgd2l0aC4gYCArCiAgICAgICAgICAgICAgYExpZmVjeWNsZSBpbmplY3Rpb24gQVBJcyBjYW4gb25seSBiZSB1c2VkIGR1cmluZyBleGVjdXRpb24gb2Ygc2V0dXAoKS5gICsKICAgICAgICAgICAgICAoYCBJZiB5b3UgYXJlIHVzaW5nIGFzeW5jIHNldHVwKCksIG1ha2Ugc3VyZSB0byByZWdpc3RlciBsaWZlY3ljbGUgYCArCiAgICAgICAgICAgICAgICAgICAgICBgaG9va3MgYmVmb3JlIHRoZSBmaXJzdCBhd2FpdCBzdGF0ZW1lbnQuYAogICAgICAgICAgICAgICAgICApKTsKICAgICAgfQogIH0KICBjb25zdCBjcmVhdGVIb29rID0gKGxpZmVjeWNsZSkgPT4gKGhvb2ssIHRhcmdldCA9IGN1cnJlbnRJbnN0YW5jZSkgPT4gCiAgLy8gcG9zdC1jcmVhdGUgbGlmZWN5Y2xlIHJlZ2lzdHJhdGlvbnMgYXJlIG5vb3BzIGR1cmluZyBTU1IgKGV4Y2VwdCBmb3Igc2VydmVyUHJlZmV0Y2gpCiAgKCFpc0luU1NSQ29tcG9uZW50U2V0dXAgfHwgbGlmZWN5Y2xlID09PSAic3AiIC8qIFNFUlZFUl9QUkVGRVRDSCAqLykgJiYKICAgICAgaW5qZWN0SG9vayhsaWZlY3ljbGUsIGhvb2ssIHRhcmdldCk7CiAgY29uc3Qgb25CZWZvcmVNb3VudCA9IGNyZWF0ZUhvb2soImJtIiAvKiBCRUZPUkVfTU9VTlQgKi8pOwogIGNvbnN0IG9uTW91bnRlZCA9IGNyZWF0ZUhvb2soIm0iIC8qIE1PVU5URUQgKi8pOwogIGNvbnN0IG9uQmVmb3JlVXBkYXRlID0gY3JlYXRlSG9vaygiYnUiIC8qIEJFRk9SRV9VUERBVEUgKi8pOwogIGNvbnN0IG9uVXBkYXRlZCA9IGNyZWF0ZUhvb2soInUiIC8qIFVQREFURUQgKi8pOwogIGNvbnN0IG9uQmVmb3JlVW5tb3VudCA9IGNyZWF0ZUhvb2soImJ1bSIgLyogQkVGT1JFX1VOTU9VTlQgKi8pOwogIGNvbnN0IG9uVW5tb3VudGVkID0gY3JlYXRlSG9vaygidW0iIC8qIFVOTU9VTlRFRCAqLyk7CiAgY29uc3Qgb25TZXJ2ZXJQcmVmZXRjaCA9IGNyZWF0ZUhvb2soInNwIiAvKiBTRVJWRVJfUFJFRkVUQ0ggKi8pOwogIGNvbnN0IG9uUmVuZGVyVHJpZ2dlcmVkID0gY3JlYXRlSG9vaygicnRnIiAvKiBSRU5ERVJfVFJJR0dFUkVEICovKTsKICBjb25zdCBvblJlbmRlclRyYWNrZWQgPSBjcmVhdGVIb29rKCJydGMiIC8qIFJFTkRFUl9UUkFDS0VEICovKTsKICBmdW5jdGlvbiBvbkVycm9yQ2FwdHVyZWQoaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlKSB7CiAgICAgIGluamVjdEhvb2soImVjIiAvKiBFUlJPUl9DQVBUVVJFRCAqLywgaG9vaywgdGFyZ2V0KTsKICB9CgogIC8qKgogIFJ1bnRpbWUgaGVscGVyIGZvciBhcHBseWluZyBkaXJlY3RpdmVzIHRvIGEgdm5vZGUuIEV4YW1wbGUgdXNhZ2U6CgogIGNvbnN0IGNvbXAgPSByZXNvbHZlQ29tcG9uZW50KCdjb21wJykKICBjb25zdCBmb28gPSByZXNvbHZlRGlyZWN0aXZlKCdmb28nKQogIGNvbnN0IGJhciA9IHJlc29sdmVEaXJlY3RpdmUoJ2JhcicpCgogIHJldHVybiB3aXRoRGlyZWN0aXZlcyhoKGNvbXApLCBbCiAgICBbZm9vLCB0aGlzLnhdLAogICAgW2JhciwgdGhpcy55XQogIF0pCiAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZURpcmVjdGl2ZU5hbWUobmFtZSkgewogICAgICBpZiAoaXNCdWlsdEluRGlyZWN0aXZlKG5hbWUpKSB7CiAgICAgICAgICB3YXJuJDEoJ0RvIG5vdCB1c2UgYnVpbHQtaW4gZGlyZWN0aXZlIGlkcyBhcyBjdXN0b20gZGlyZWN0aXZlIGlkOiAnICsgbmFtZSk7CiAgICAgIH0KICB9CiAgLyoqCiAgICogQWRkcyBkaXJlY3RpdmVzIHRvIGEgVk5vZGUuCiAgICovCiAgZnVuY3Rpb24gd2l0aERpcmVjdGl2ZXModm5vZGUsIGRpcmVjdGl2ZXMpIHsKICAgICAgY29uc3QgaW50ZXJuYWxJbnN0YW5jZSA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICAgICAgaWYgKGludGVybmFsSW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgIHdhcm4kMShgd2l0aERpcmVjdGl2ZXMgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgcmVuZGVyIGZ1bmN0aW9ucy5gKTsKICAgICAgICAgIHJldHVybiB2bm9kZTsKICAgICAgfQogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEV4cG9zZVByb3h5KGludGVybmFsSW5zdGFuY2UpIHx8CiAgICAgICAgICBpbnRlcm5hbEluc3RhbmNlLnByb3h5OwogICAgICBjb25zdCBiaW5kaW5ncyA9IHZub2RlLmRpcnMgfHwgKHZub2RlLmRpcnMgPSBbXSk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlyZWN0aXZlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgbGV0IFtkaXIsIHZhbHVlLCBhcmcsIG1vZGlmaWVycyA9IEVNUFRZX09CSl0gPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyKSkgewogICAgICAgICAgICAgIGRpciA9IHsKICAgICAgICAgICAgICAgICAgbW91bnRlZDogZGlyLAogICAgICAgICAgICAgICAgICB1cGRhdGVkOiBkaXIKICAgICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRpci5kZWVwKSB7CiAgICAgICAgICAgICAgdHJhdmVyc2UodmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgYmluZGluZ3MucHVzaCh7CiAgICAgICAgICAgICAgZGlyLAogICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgIG9sZFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgICAgYXJnLAogICAgICAgICAgICAgIG1vZGlmaWVycwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZub2RlOwogIH0KICBmdW5jdGlvbiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBwcmV2Vk5vZGUsIGluc3RhbmNlLCBuYW1lKSB7CiAgICAgIGNvbnN0IGJpbmRpbmdzID0gdm5vZGUuZGlyczsKICAgICAgY29uc3Qgb2xkQmluZGluZ3MgPSBwcmV2Vk5vZGUgJiYgcHJldlZOb2RlLmRpcnM7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGJpbmRpbmcgPSBiaW5kaW5nc1tpXTsKICAgICAgICAgIGlmIChvbGRCaW5kaW5ncykgewogICAgICAgICAgICAgIGJpbmRpbmcub2xkVmFsdWUgPSBvbGRCaW5kaW5nc1tpXS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBob29rID0gYmluZGluZy5kaXJbbmFtZV07CiAgICAgICAgICBpZiAoaG9vaykgewogICAgICAgICAgICAgIC8vIGRpc2FibGUgdHJhY2tpbmcgaW5zaWRlIGFsbCBsaWZlY3ljbGUgaG9va3MKICAgICAgICAgICAgICAvLyBzaW5jZSB0aGV5IGNhbiBwb3RlbnRpYWxseSBiZSBjYWxsZWQgaW5zaWRlIGVmZmVjdHMuCiAgICAgICAgICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICAgICAgICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIGluc3RhbmNlLCA4IC8qIERJUkVDVElWRV9IT09LICovLCBbCiAgICAgICAgICAgICAgICAgIHZub2RlLmVsLAogICAgICAgICAgICAgICAgICBiaW5kaW5nLAogICAgICAgICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgICAgICAgcHJldlZOb2RlCiAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgcmVzZXRUcmFja2luZygpOwogICAgICAgICAgfQogICAgICB9CiAgfQoKICBjb25zdCBDT01QT05FTlRTID0gJ2NvbXBvbmVudHMnOwogIGNvbnN0IERJUkVDVElWRVMgPSAnZGlyZWN0aXZlcyc7CiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZXNvbHZlQ29tcG9uZW50KG5hbWUsIG1heWJlU2VsZlJlZmVyZW5jZSkgewogICAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KENPTVBPTkVOVFMsIG5hbWUsIHRydWUsIG1heWJlU2VsZlJlZmVyZW5jZSkgfHwgbmFtZTsKICB9CiAgY29uc3QgTlVMTF9EWU5BTUlDX0NPTVBPTkVOVCA9IFN5bWJvbCgpOwogIC8qKgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNDb21wb25lbnQoY29tcG9uZW50KSB7CiAgICAgIGlmIChpc1N0cmluZyhjb21wb25lbnQpKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KENPTVBPTkVOVFMsIGNvbXBvbmVudCwgZmFsc2UpIHx8IGNvbXBvbmVudDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIGludmFsaWQgdHlwZXMgd2lsbCBmYWxsdGhyb3VnaCB0byBjcmVhdGVWTm9kZSBhbmQgcmFpc2Ugd2FybmluZwogICAgICAgICAgcmV0dXJuIChjb21wb25lbnQgfHwgTlVMTF9EWU5BTUlDX0NPTVBPTkVOVCk7CiAgICAgIH0KICB9CiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZXNvbHZlRGlyZWN0aXZlKG5hbWUpIHsKICAgICAgcmV0dXJuIHJlc29sdmVBc3NldChESVJFQ1RJVkVTLCBuYW1lKTsKICB9CiAgLy8gaW1wbGVtZW50YXRpb24KICBmdW5jdGlvbiByZXNvbHZlQXNzZXQodHlwZSwgbmFtZSwgd2Fybk1pc3NpbmcgPSB0cnVlLCBtYXliZVNlbGZSZWZlcmVuY2UgPSBmYWxzZSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSB8fCBjdXJyZW50SW5zdGFuY2U7CiAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgY29uc3QgQ29tcG9uZW50ID0gaW5zdGFuY2UudHlwZTsKICAgICAgICAgIC8vIGV4cGxpY2l0IHNlbGYgbmFtZSBoYXMgaGlnaGVzdCBwcmlvcml0eQogICAgICAgICAgaWYgKHR5cGUgPT09IENPTVBPTkVOVFMpIHsKICAgICAgICAgICAgICBjb25zdCBzZWxmTmFtZSA9IGdldENvbXBvbmVudE5hbWUoQ29tcG9uZW50KTsKICAgICAgICAgICAgICBpZiAoc2VsZk5hbWUgJiYKICAgICAgICAgICAgICAgICAgKHNlbGZOYW1lID09PSBuYW1lIHx8CiAgICAgICAgICAgICAgICAgICAgICBzZWxmTmFtZSA9PT0gY2FtZWxpemUobmFtZSkgfHwKICAgICAgICAgICAgICAgICAgICAgIHNlbGZOYW1lID09PSBjYXBpdGFsaXplKGNhbWVsaXplKG5hbWUpKSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIENvbXBvbmVudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXMgPSAKICAgICAgICAgIC8vIGxvY2FsIHJlZ2lzdHJhdGlvbgogICAgICAgICAgLy8gY2hlY2sgaW5zdGFuY2VbdHlwZV0gZmlyc3Qgd2hpY2ggaXMgcmVzb2x2ZWQgZm9yIG9wdGlvbnMgQVBJCiAgICAgICAgICByZXNvbHZlKGluc3RhbmNlW3R5cGVdIHx8IENvbXBvbmVudFt0eXBlXSwgbmFtZSkgfHwKICAgICAgICAgICAgICAvLyBnbG9iYWwgcmVnaXN0cmF0aW9uCiAgICAgICAgICAgICAgcmVzb2x2ZShpbnN0YW5jZS5hcHBDb250ZXh0W3R5cGVdLCBuYW1lKTsKICAgICAgICAgIGlmICghcmVzICYmIG1heWJlU2VsZlJlZmVyZW5jZSkgewogICAgICAgICAgICAgIC8vIGZhbGxiYWNrIHRvIGltcGxpY2l0IHNlbGYtcmVmZXJlbmNlCiAgICAgICAgICAgICAgcmV0dXJuIENvbXBvbmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3YXJuTWlzc2luZyAmJiAhcmVzKSB7CiAgICAgICAgICAgICAgY29uc3QgZXh0cmEgPSB0eXBlID09PSBDT01QT05FTlRTCiAgICAgICAgICAgICAgICAgID8gYFxuSWYgdGhpcyBpcyBhIG5hdGl2ZSBjdXN0b20gZWxlbWVudCwgbWFrZSBzdXJlIHRvIGV4Y2x1ZGUgaXQgZnJvbSBgICsKICAgICAgICAgICAgICAgICAgICAgIGBjb21wb25lbnQgcmVzb2x1dGlvbiB2aWEgY29tcGlsZXJPcHRpb25zLmlzQ3VzdG9tRWxlbWVudC5gCiAgICAgICAgICAgICAgICAgIDogYGA7CiAgICAgICAgICAgICAgd2FybiQxKGBGYWlsZWQgdG8gcmVzb2x2ZSAke3R5cGUuc2xpY2UoMCwgLTEpfTogJHtuYW1lfSR7ZXh0cmF9YCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgd2FybiQxKGByZXNvbHZlJHtjYXBpdGFsaXplKHR5cGUuc2xpY2UoMCwgLTEpKX0gYCArCiAgICAgICAgICAgICAgYGNhbiBvbmx5IGJlIHVzZWQgaW4gcmVuZGVyKCkgb3Igc2V0dXAoKS5gKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiByZXNvbHZlKHJlZ2lzdHJ5LCBuYW1lKSB7CiAgICAgIHJldHVybiAocmVnaXN0cnkgJiYKICAgICAgICAgIChyZWdpc3RyeVtuYW1lXSB8fAogICAgICAgICAgICAgIHJlZ2lzdHJ5W2NhbWVsaXplKG5hbWUpXSB8fAogICAgICAgICAgICAgIHJlZ2lzdHJ5W2NhcGl0YWxpemUoY2FtZWxpemUobmFtZSkpXSkpOwogIH0KCiAgLyoqCiAgICogQWN0dWFsIGltcGxlbWVudGF0aW9uCiAgICovCiAgZnVuY3Rpb24gcmVuZGVyTGlzdChzb3VyY2UsIHJlbmRlckl0ZW0sIGNhY2hlLCBpbmRleCkgewogICAgICBsZXQgcmV0OwogICAgICBjb25zdCBjYWNoZWQgPSAoY2FjaGUgJiYgY2FjaGVbaW5kZXhdKTsKICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSB8fCBpc1N0cmluZyhzb3VyY2UpKSB7CiAgICAgICAgICByZXQgPSBuZXcgQXJyYXkoc291cmNlLmxlbmd0aCk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHNvdXJjZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICByZXRbaV0gPSByZW5kZXJJdGVtKHNvdXJjZVtpXSwgaSwgdW5kZWZpbmVkLCBjYWNoZWQgJiYgY2FjaGVkW2ldKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmICh0eXBlb2Ygc291cmNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKHNvdXJjZSkpIHsKICAgICAgICAgICAgICB3YXJuJDEoYFRoZSB2LWZvciByYW5nZSBleHBlY3QgYW4gaW50ZWdlciB2YWx1ZSBidXQgZ290ICR7c291cmNlfS5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldCA9IG5ldyBBcnJheShzb3VyY2UpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2U7IGkrKykgewogICAgICAgICAgICAgIHJldFtpXSA9IHJlbmRlckl0ZW0oaSArIDEsIGksIHVuZGVmaW5lZCwgY2FjaGVkICYmIGNhY2hlZFtpXSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgaWYgKHNvdXJjZVtTeW1ib2wuaXRlcmF0b3JdKSB7CiAgICAgICAgICAgICAgcmV0ID0gQXJyYXkuZnJvbShzb3VyY2UsIChpdGVtLCBpKSA9PiByZW5kZXJJdGVtKGl0ZW0sIGksIHVuZGVmaW5lZCwgY2FjaGVkICYmIGNhY2hlZFtpXSkpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CiAgICAgICAgICAgICAgcmV0ID0gbmV3IEFycmF5KGtleXMubGVuZ3RoKTsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgICAgIHJldFtpXSA9IHJlbmRlckl0ZW0oc291cmNlW2tleV0sIGtleSwgaSwgY2FjaGVkICYmIGNhY2hlZFtpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgcmV0ID0gW107CiAgICAgIH0KICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICBjYWNoZVtpbmRleF0gPSByZXQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICB9CgogIC8qKgogICAqIENvbXBpbGVyIHJ1bnRpbWUgaGVscGVyIGZvciBjcmVhdGluZyBkeW5hbWljIHNsb3RzIG9iamVjdAogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlU2xvdHMoc2xvdHMsIGR5bmFtaWNTbG90cykgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR5bmFtaWNTbG90cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qgc2xvdCA9IGR5bmFtaWNTbG90c1tpXTsKICAgICAgICAgIC8vIGFycmF5IG9mIGR5bmFtaWMgc2xvdCBnZW5lcmF0ZWQgYnkgPHRlbXBsYXRlIHYtZm9yPSIuLi4iICNbLi4uXT4KICAgICAgICAgIGlmIChpc0FycmF5KHNsb3QpKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzbG90Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgIHNsb3RzW3Nsb3Rbal0ubmFtZV0gPSBzbG90W2pdLmZuOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHNsb3QpIHsKICAgICAgICAgICAgICAvLyBjb25kaXRpb25hbCBzaW5nbGUgc2xvdCBnZW5lcmF0ZWQgYnkgPHRlbXBsYXRlIHYtaWY9Ii4uLiIgI2Zvbz4KICAgICAgICAgICAgICBzbG90c1tzbG90Lm5hbWVdID0gc2xvdC5mbjsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2xvdHM7CiAgfQoKICAvKioKICAgKiBDb21waWxlciBydW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIGA8c2xvdC8+YAogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVuZGVyU2xvdChzbG90cywgbmFtZSwgcHJvcHMgPSB7fSwgCiAgLy8gdGhpcyBpcyBub3QgYSB1c2VyLWZhY2luZyBmdW5jdGlvbiwgc28gdGhlIGZhbGxiYWNrIGlzIGFsd2F5cyBnZW5lcmF0ZWQgYnkKICAvLyB0aGUgY29tcGlsZXIgYW5kIGd1YXJhbnRlZWQgdG8gYmUgYSBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkKICBmYWxsYmFjaywgbm9TbG90dGVkKSB7CiAgICAgIGlmIChjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UuaXNDRSB8fAogICAgICAgICAgKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5wYXJlbnQgJiYKICAgICAgICAgICAgICBpc0FzeW5jV3JhcHBlcihjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UucGFyZW50KSAmJgogICAgICAgICAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5wYXJlbnQuaXNDRSkpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZSgnc2xvdCcsIG5hbWUgPT09ICdkZWZhdWx0JyA/IG51bGwgOiB7IG5hbWUgfSwgZmFsbGJhY2sgJiYgZmFsbGJhY2soKSk7CiAgICAgIH0KICAgICAgbGV0IHNsb3QgPSBzbG90c1tuYW1lXTsKICAgICAgaWYgKHNsb3QgJiYgc2xvdC5sZW5ndGggPiAxKSB7CiAgICAgICAgICB3YXJuJDEoYFNTUi1vcHRpbWl6ZWQgc2xvdCBmdW5jdGlvbiBkZXRlY3RlZCBpbiBhIG5vbi1TU1Itb3B0aW1pemVkIHJlbmRlciBgICsKICAgICAgICAgICAgICBgZnVuY3Rpb24uIFlvdSBuZWVkIHRvIG1hcmsgdGhpcyBjb21wb25lbnQgd2l0aCAkZHluYW1pYy1zbG90cyBpbiB0aGUgYCArCiAgICAgICAgICAgICAgYHBhcmVudCB0ZW1wbGF0ZS5gKTsKICAgICAgICAgIHNsb3QgPSAoKSA9PiBbXTsKICAgICAgfQogICAgICAvLyBhIGNvbXBpbGVkIHNsb3QgZGlzYWJsZXMgYmxvY2sgdHJhY2tpbmcgYnkgZGVmYXVsdCB0byBhdm9pZCBtYW51YWwKICAgICAgLy8gaW52b2NhdGlvbiBpbnRlcmZlcmluZyB3aXRoIHRlbXBsYXRlLWJhc2VkIGJsb2NrIHRyYWNraW5nLCBidXQgaW4KICAgICAgLy8gYHJlbmRlclNsb3RgIHdlIGNhbiBiZSBzdXJlIHRoYXQgaXQncyB0ZW1wbGF0ZS1iYXNlZCBzbyB3ZSBjYW4gZm9yY2UKICAgICAgLy8gZW5hYmxlIGl0LgogICAgICBpZiAoc2xvdCAmJiBzbG90Ll9jKSB7CiAgICAgICAgICBzbG90Ll9kID0gZmFsc2U7CiAgICAgIH0KICAgICAgb3BlbkJsb2NrKCk7CiAgICAgIGNvbnN0IHZhbGlkU2xvdENvbnRlbnQgPSBzbG90ICYmIGVuc3VyZVZhbGlkVk5vZGUoc2xvdChwcm9wcykpOwogICAgICBjb25zdCByZW5kZXJlZCA9IGNyZWF0ZUJsb2NrKEZyYWdtZW50LCB7IGtleTogcHJvcHMua2V5IHx8IGBfJHtuYW1lfWAgfSwgdmFsaWRTbG90Q29udGVudCB8fCAoZmFsbGJhY2sgPyBmYWxsYmFjaygpIDogW10pLCB2YWxpZFNsb3RDb250ZW50ICYmIHNsb3RzLl8gPT09IDEgLyogU1RBQkxFICovCiAgICAgICAgICA/IDY0IC8qIFNUQUJMRV9GUkFHTUVOVCAqLwogICAgICAgICAgOiAtMiAvKiBCQUlMICovKTsKICAgICAgaWYgKCFub1Nsb3R0ZWQgJiYgcmVuZGVyZWQuc2NvcGVJZCkgewogICAgICAgICAgcmVuZGVyZWQuc2xvdFNjb3BlSWRzID0gW3JlbmRlcmVkLnNjb3BlSWQgKyAnLXMnXTsKICAgICAgfQogICAgICBpZiAoc2xvdCAmJiBzbG90Ll9jKSB7CiAgICAgICAgICBzbG90Ll9kID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gcmVuZGVyZWQ7CiAgfQogIGZ1bmN0aW9uIGVuc3VyZVZhbGlkVk5vZGUodm5vZGVzKSB7CiAgICAgIHJldHVybiB2bm9kZXMuc29tZShjaGlsZCA9PiB7CiAgICAgICAgICBpZiAoIWlzVk5vZGUoY2hpbGQpKQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IENvbW1lbnQpCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IEZyYWdtZW50ICYmCiAgICAgICAgICAgICAgIWVuc3VyZVZhbGlkVk5vZGUoY2hpbGQuY2hpbGRyZW4pKQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KQogICAgICAgICAgPyB2bm9kZXMKICAgICAgICAgIDogbnVsbDsKICB9CgogIC8qKgogICAqIEZvciBwcmVmaXhpbmcga2V5cyBpbiB2LW9uPSJvYmoiIHdpdGggIm9uIgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdG9IYW5kbGVycyhvYmopIHsKICAgICAgY29uc3QgcmV0ID0ge307CiAgICAgIGlmICghaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgd2FybiQxKGB2LW9uIHdpdGggbm8gYXJndW1lbnQgZXhwZWN0cyBhbiBvYmplY3QgdmFsdWUuYCk7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICAgICAgcmV0W3RvSGFuZGxlcktleShrZXkpXSA9IG9ialtrZXldOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgfQoKICAvKioKICAgKiAjMjQzNyBJbiBWdWUgMywgZnVuY3Rpb25hbCBjb21wb25lbnRzIGRvIG5vdCBoYXZlIGEgcHVibGljIGluc3RhbmNlIHByb3h5IGJ1dAogICAqIHRoZXkgZXhpc3QgaW4gdGhlIGludGVybmFsIHBhcmVudCBjaGFpbi4gRm9yIGNvZGUgdGhhdCByZWxpZXMgb24gdHJhdmVyc2luZwogICAqIHB1YmxpYyAkcGFyZW50IGNoYWlucywgc2tpcCBmdW5jdGlvbmFsIG9uZXMgYW5kIGdvIHRvIHRoZSBwYXJlbnQgaW5zdGVhZC4KICAgKi8KICBjb25zdCBnZXRQdWJsaWNJbnN0YW5jZSA9IChpKSA9PiB7CiAgICAgIGlmICghaSkKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICBpZiAoaXNTdGF0ZWZ1bENvbXBvbmVudChpKSkKICAgICAgICAgIHJldHVybiBnZXRFeHBvc2VQcm94eShpKSB8fCBpLnByb3h5OwogICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoaS5wYXJlbnQpOwogIH07CiAgY29uc3QgcHVibGljUHJvcGVydGllc01hcCA9IAogIC8vIE1vdmUgUFVSRSBtYXJrZXIgdG8gbmV3IGxpbmUgdG8gd29ya2Fyb3VuZCBjb21waWxlciBkaXNjYXJkaW5nIGl0CiAgLy8gZHVlIHRvIHR5cGUgYW5ub3RhdGlvbgogIC8qI19fUFVSRV9fKi8gZXh0ZW5kKE9iamVjdC5jcmVhdGUobnVsbCksIHsKICAgICAgJDogaSA9PiBpLAogICAgICAkZWw6IGkgPT4gaS52bm9kZS5lbCwKICAgICAgJGRhdGE6IGkgPT4gaS5kYXRhLAogICAgICAkcHJvcHM6IGkgPT4gKHNoYWxsb3dSZWFkb25seShpLnByb3BzKSApLAogICAgICAkYXR0cnM6IGkgPT4gKHNoYWxsb3dSZWFkb25seShpLmF0dHJzKSApLAogICAgICAkc2xvdHM6IGkgPT4gKHNoYWxsb3dSZWFkb25seShpLnNsb3RzKSApLAogICAgICAkcmVmczogaSA9PiAoc2hhbGxvd1JlYWRvbmx5KGkucmVmcykgKSwKICAgICAgJHBhcmVudDogaSA9PiBnZXRQdWJsaWNJbnN0YW5jZShpLnBhcmVudCksCiAgICAgICRyb290OiBpID0+IGdldFB1YmxpY0luc3RhbmNlKGkucm9vdCksCiAgICAgICRlbWl0OiBpID0+IGkuZW1pdCwKICAgICAgJG9wdGlvbnM6IGkgPT4gKHJlc29sdmVNZXJnZWRPcHRpb25zKGkpICksCiAgICAgICRmb3JjZVVwZGF0ZTogaSA9PiBpLmYgfHwgKGkuZiA9ICgpID0+IHF1ZXVlSm9iKGkudXBkYXRlKSksCiAgICAgICRuZXh0VGljazogaSA9PiBpLm4gfHwgKGkubiA9IG5leHRUaWNrLmJpbmQoaS5wcm94eSkpLAogICAgICAkd2F0Y2g6IGkgPT4gKGluc3RhbmNlV2F0Y2guYmluZChpKSApCiAgfSk7CiAgY29uc3QgaXNSZXNlcnZlZFByZWZpeCA9IChrZXkpID0+IGtleSA9PT0gJ18nIHx8IGtleSA9PT0gJyQnOwogIGNvbnN0IFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycyA9IHsKICAgICAgZ2V0KHsgXzogaW5zdGFuY2UgfSwga2V5KSB7CiAgICAgICAgICBjb25zdCB7IGN0eCwgc2V0dXBTdGF0ZSwgZGF0YSwgcHJvcHMsIGFjY2Vzc0NhY2hlLCB0eXBlLCBhcHBDb250ZXh0IH0gPSBpbnN0YW5jZTsKICAgICAgICAgIC8vIGZvciBpbnRlcm5hbCBmb3JtYXR0ZXJzIHRvIGtub3cgdGhhdCB0aGlzIGlzIGEgVnVlIGluc3RhbmNlCiAgICAgICAgICBpZiAoa2V5ID09PSAnX19pc1Z1ZScpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHByaW9yaXRpemUgPHNjcmlwdCBzZXR1cD4gYmluZGluZ3MgZHVyaW5nIGRldi4KICAgICAgICAgIC8vIHRoaXMgYWxsb3dzIGV2ZW4gcHJvcGVydGllcyB0aGF0IHN0YXJ0IHdpdGggXyBvciAkIHRvIGJlIHVzZWQgLSBzbyB0aGF0CiAgICAgICAgICAvLyBpdCBhbGlnbnMgd2l0aCB0aGUgcHJvZHVjdGlvbiBiZWhhdmlvciB3aGVyZSB0aGUgcmVuZGVyIGZuIGlzIGlubGluZWQgYW5kCiAgICAgICAgICAvLyBpbmRlZWQgaGFzIGFjY2VzcyB0byBhbGwgZGVjbGFyZWQgdmFyaWFibGVzLgogICAgICAgICAgaWYgKHNldHVwU3RhdGUgIT09IEVNUFRZX09CSiAmJgogICAgICAgICAgICAgIHNldHVwU3RhdGUuX19pc1NjcmlwdFNldHVwICYmCiAgICAgICAgICAgICAgaGFzT3duKHNldHVwU3RhdGUsIGtleSkpIHsKICAgICAgICAgICAgICByZXR1cm4gc2V0dXBTdGF0ZVtrZXldOwogICAgICAgICAgfQogICAgICAgICAgLy8gZGF0YSAvIHByb3BzIC8gY3R4CiAgICAgICAgICAvLyBUaGlzIGdldHRlciBnZXRzIGNhbGxlZCBmb3IgZXZlcnkgcHJvcGVydHkgYWNjZXNzIG9uIHRoZSByZW5kZXIgY29udGV4dAogICAgICAgICAgLy8gZHVyaW5nIHJlbmRlciBhbmQgaXMgYSBtYWpvciBob3RzcG90LiBUaGUgbW9zdCBleHBlbnNpdmUgcGFydCBvZiB0aGlzCiAgICAgICAgICAvLyBpcyB0aGUgbXVsdGlwbGUgaGFzT3duKCkgY2FsbHMuIEl0J3MgbXVjaCBmYXN0ZXIgdG8gZG8gYSBzaW1wbGUgcHJvcGVydHkKICAgICAgICAgIC8vIGFjY2VzcyBvbiBhIHBsYWluIG9iamVjdCwgc28gd2UgdXNlIGFuIGFjY2Vzc0NhY2hlIG9iamVjdCAod2l0aCBudWxsCiAgICAgICAgICAvLyBwcm90b3R5cGUpIHRvIG1lbW9pemUgd2hhdCBhY2Nlc3MgdHlwZSBhIGtleSBjb3JyZXNwb25kcyB0by4KICAgICAgICAgIGxldCBub3JtYWxpemVkUHJvcHM7CiAgICAgICAgICBpZiAoa2V5WzBdICE9PSAnJCcpIHsKICAgICAgICAgICAgICBjb25zdCBuID0gYWNjZXNzQ2FjaGVba2V5XTsKICAgICAgICAgICAgICBpZiAobiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAobikgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSAxIC8qIFNFVFVQICovOgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR1cFN0YXRlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIgLyogREFUQSAqLzoKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSA0IC8qIENPTlRFWFQgKi86CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN0eFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAzIC8qIFBST1BTICovOgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgLy8gZGVmYXVsdDoganVzdCBmYWxsdGhyb3VnaAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKHNldHVwU3RhdGUgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oc2V0dXBTdGF0ZSwga2V5KSkgewogICAgICAgICAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMSAvKiBTRVRVUCAqLzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldHVwU3RhdGVba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoZGF0YSAhPT0gRU1QVFlfT0JKICYmIGhhc093bihkYXRhLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSAyIC8qIERBVEEgKi87CiAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKAogICAgICAgICAgICAgIC8vIG9ubHkgY2FjaGUgb3RoZXIgcHJvcGVydGllcyB3aGVuIGluc3RhbmNlIGhhcyBkZWNsYXJlZCAodGh1cyBzdGFibGUpCiAgICAgICAgICAgICAgLy8gcHJvcHMKICAgICAgICAgICAgICAobm9ybWFsaXplZFByb3BzID0gaW5zdGFuY2UucHJvcHNPcHRpb25zWzBdKSAmJgogICAgICAgICAgICAgICAgICBoYXNPd24obm9ybWFsaXplZFByb3BzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSAzIC8qIFBST1BTICovOwogICAgICAgICAgICAgICAgICByZXR1cm4gcHJvcHNba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoY3R4ICE9PSBFTVBUWV9PQkogJiYgaGFzT3duKGN0eCwga2V5KSkgewogICAgICAgICAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gNCAvKiBDT05URVhUICovOwogICAgICAgICAgICAgICAgICByZXR1cm4gY3R4W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKHNob3VsZENhY2hlQWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSAwIC8qIE9USEVSICovOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHB1YmxpY0dldHRlciA9IHB1YmxpY1Byb3BlcnRpZXNNYXBba2V5XTsKICAgICAgICAgIGxldCBjc3NNb2R1bGUsIGdsb2JhbFByb3BlcnRpZXM7CiAgICAgICAgICAvLyBwdWJsaWMgJHh4eCBwcm9wZXJ0aWVzCiAgICAgICAgICBpZiAocHVibGljR2V0dGVyKSB7CiAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJyRhdHRycycpIHsKICAgICAgICAgICAgICAgICAgdHJhY2soaW5zdGFuY2UsICJnZXQiIC8qIEdFVCAqLywga2V5KTsKICAgICAgICAgICAgICAgICAgbWFya0F0dHJzQWNjZXNzZWQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHB1YmxpY0dldHRlcihpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICgKICAgICAgICAgIC8vIGNzcyBtb2R1bGUgKGluamVjdGVkIGJ5IHZ1ZS1sb2FkZXIpCiAgICAgICAgICAoY3NzTW9kdWxlID0gdHlwZS5fX2Nzc01vZHVsZXMpICYmCiAgICAgICAgICAgICAgKGNzc01vZHVsZSA9IGNzc01vZHVsZVtrZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBjc3NNb2R1bGU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChjdHggIT09IEVNUFRZX09CSiAmJiBoYXNPd24oY3R4LCBrZXkpKSB7CiAgICAgICAgICAgICAgLy8gdXNlciBtYXkgc2V0IGN1c3RvbSBwcm9wZXJ0aWVzIHRvIGB0aGlzYCB0aGF0IHN0YXJ0IHdpdGggYCRgCiAgICAgICAgICAgICAgYWNjZXNzQ2FjaGVba2V5XSA9IDQgLyogQ09OVEVYVCAqLzsKICAgICAgICAgICAgICByZXR1cm4gY3R4W2tleV07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICgKICAgICAgICAgIC8vIGdsb2JhbCBwcm9wZXJ0aWVzCiAgICAgICAgICAoKGdsb2JhbFByb3BlcnRpZXMgPSBhcHBDb250ZXh0LmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzKSwKICAgICAgICAgICAgICBoYXNPd24oZ2xvYmFsUHJvcGVydGllcywga2V5KSkpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnbG9iYWxQcm9wZXJ0aWVzW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlICYmCiAgICAgICAgICAgICAgKCFpc1N0cmluZyhrZXkpIHx8CiAgICAgICAgICAgICAgICAgIC8vICMxMDkxIGF2b2lkIGludGVybmFsIGlzUmVmL2lzVk5vZGUgY2hlY2tzIG9uIGNvbXBvbmVudCBpbnN0YW5jZSBsZWFkaW5nCiAgICAgICAgICAgICAgICAgIC8vIHRvIGluZmluaXRlIHdhcm5pbmcgbG9vcAogICAgICAgICAgICAgICAgICBrZXkuaW5kZXhPZignX192JykgIT09IDApKSB7CiAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IEVNUFRZX09CSiAmJiBpc1Jlc2VydmVkUHJlZml4KGtleVswXSkgJiYgaGFzT3duKGRhdGEsIGtleSkpIHsKICAgICAgICAgICAgICAgICAgd2FybiQxKGBQcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KGtleSl9IG11c3QgYmUgYWNjZXNzZWQgdmlhICRkYXRhIGJlY2F1c2UgaXQgc3RhcnRzIHdpdGggYSByZXNlcnZlZCBgICsKICAgICAgICAgICAgICAgICAgICAgIGBjaGFyYWN0ZXIgKCIkIiBvciAiXyIpIGFuZCBpcyBub3QgcHJveGllZCBvbiB0aGUgcmVuZGVyIGNvbnRleHQuYCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGluc3RhbmNlID09PSBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgd2FybiQxKGBQcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KGtleSl9IHdhcyBhY2Nlc3NlZCBkdXJpbmcgcmVuZGVyIGAgKwogICAgICAgICAgICAgICAgICAgICAgYGJ1dCBpcyBub3QgZGVmaW5lZCBvbiBpbnN0YW5jZS5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldCh7IF86IGluc3RhbmNlIH0sIGtleSwgdmFsdWUpIHsKICAgICAgICAgIGNvbnN0IHsgZGF0YSwgc2V0dXBTdGF0ZSwgY3R4IH0gPSBpbnN0YW5jZTsKICAgICAgICAgIGlmIChzZXR1cFN0YXRlICE9PSBFTVBUWV9PQkogJiYgaGFzT3duKHNldHVwU3RhdGUsIGtleSkpIHsKICAgICAgICAgICAgICBzZXR1cFN0YXRlW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGRhdGEgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oZGF0YSwga2V5KSkgewogICAgICAgICAgICAgIGRhdGFba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaGFzT3duKGluc3RhbmNlLnByb3BzLCBrZXkpKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBBdHRlbXB0aW5nIHRvIG11dGF0ZSBwcm9wICIke2tleX0iLiBQcm9wcyBhcmUgcmVhZG9ubHkuYCwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChrZXlbMF0gPT09ICckJyAmJiBrZXkuc2xpY2UoMSkgaW4gaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB3YXJuJDEoYEF0dGVtcHRpbmcgdG8gbXV0YXRlIHB1YmxpYyBwcm9wZXJ0eSAiJHtrZXl9Ii4gYCArCiAgICAgICAgICAgICAgICAgICAgICBgUHJvcGVydGllcyBzdGFydGluZyB3aXRoICQgYXJlIHJlc2VydmVkIGFuZCByZWFkb25seS5gLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGtleSBpbiBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3R4W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgaGFzKHsgXzogeyBkYXRhLCBzZXR1cFN0YXRlLCBhY2Nlc3NDYWNoZSwgY3R4LCBhcHBDb250ZXh0LCBwcm9wc09wdGlvbnMgfSB9LCBrZXkpIHsKICAgICAgICAgIGxldCBub3JtYWxpemVkUHJvcHM7CiAgICAgICAgICByZXR1cm4gKCEhYWNjZXNzQ2FjaGVba2V5XSB8fAogICAgICAgICAgICAgIChkYXRhICE9PSBFTVBUWV9PQkogJiYgaGFzT3duKGRhdGEsIGtleSkpIHx8CiAgICAgICAgICAgICAgKHNldHVwU3RhdGUgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oc2V0dXBTdGF0ZSwga2V5KSkgfHwKICAgICAgICAgICAgICAoKG5vcm1hbGl6ZWRQcm9wcyA9IHByb3BzT3B0aW9uc1swXSkgJiYgaGFzT3duKG5vcm1hbGl6ZWRQcm9wcywga2V5KSkgfHwKICAgICAgICAgICAgICBoYXNPd24oY3R4LCBrZXkpIHx8CiAgICAgICAgICAgICAgaGFzT3duKHB1YmxpY1Byb3BlcnRpZXNNYXAsIGtleSkgfHwKICAgICAgICAgICAgICBoYXNPd24oYXBwQ29udGV4dC5jb25maWcuZ2xvYmFsUHJvcGVydGllcywga2V5KSk7CiAgICAgIH0sCiAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBkZXNjcmlwdG9yKSB7CiAgICAgICAgICBpZiAoZGVzY3JpcHRvci5nZXQgIT0gbnVsbCkgewogICAgICAgICAgICAgIC8vIGludmFsaWRhdGUga2V5IGNhY2hlIG9mIGEgZ2V0dGVyIGJhc2VkIHByb3BlcnR5ICM1NDE3CiAgICAgICAgICAgICAgdGFyZ2V0Ll8uYWNjZXNzQ2FjaGVba2V5XSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChoYXNPd24oZGVzY3JpcHRvciwgJ3ZhbHVlJykpIHsKICAgICAgICAgICAgICB0aGlzLnNldCh0YXJnZXQsIGtleSwgZGVzY3JpcHRvci52YWx1ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVmbGVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgZGVzY3JpcHRvcik7CiAgICAgIH0KICB9OwogIHsKICAgICAgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLm93bktleXMgPSAodGFyZ2V0KSA9PiB7CiAgICAgICAgICB3YXJuJDEoYEF2b2lkIGFwcCBsb2dpYyB0aGF0IHJlbGllcyBvbiBlbnVtZXJhdGluZyBrZXlzIG9uIGEgY29tcG9uZW50IGluc3RhbmNlLiBgICsKICAgICAgICAgICAgICBgVGhlIGtleXMgd2lsbCBiZSBlbXB0eSBpbiBwcm9kdWN0aW9uIG1vZGUgdG8gYXZvaWQgcGVyZm9ybWFuY2Ugb3ZlcmhlYWQuYCk7CiAgICAgICAgICByZXR1cm4gUmVmbGVjdC5vd25LZXlzKHRhcmdldCk7CiAgICAgIH07CiAgfQogIGNvbnN0IFJ1bnRpbWVDb21waWxlZFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycyA9IC8qI19fUFVSRV9fKi8gZXh0ZW5kKHt9LCBQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMsIHsKICAgICAgZ2V0KHRhcmdldCwga2V5KSB7CiAgICAgICAgICAvLyBmYXN0IHBhdGggZm9yIHVuc2NvcGFibGVzIHdoZW4gdXNpbmcgYHdpdGhgIGJsb2NrCiAgICAgICAgICBpZiAoa2V5ID09PSBTeW1ib2wudW5zY29wYWJsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLmdldCh0YXJnZXQsIGtleSwgdGFyZ2V0KTsKICAgICAgfSwKICAgICAgaGFzKF8sIGtleSkgewogICAgICAgICAgY29uc3QgaGFzID0ga2V5WzBdICE9PSAnXycgJiYgIWlzR2xvYmFsbHlXaGl0ZWxpc3RlZChrZXkpOwogICAgICAgICAgaWYgKCFoYXMgJiYgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLmhhcyhfLCBrZXkpKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBQcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KGtleSl9IHNob3VsZCBub3Qgc3RhcnQgd2l0aCBfIHdoaWNoIGlzIGEgcmVzZXJ2ZWQgcHJlZml4IGZvciBWdWUgaW50ZXJuYWxzLmApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhczsKICAgICAgfQogIH0pOwogIC8vIGRldiBvbmx5CiAgLy8gSW4gZGV2IG1vZGUsIHRoZSBwcm94eSB0YXJnZXQgZXhwb3NlcyB0aGUgc2FtZSBwcm9wZXJ0aWVzIGFzIHNlZW4gb24gYHRoaXNgCiAgLy8gZm9yIGVhc2llciBjb25zb2xlIGluc3BlY3Rpb24uIEluIHByb2QgbW9kZSBpdCB3aWxsIGJlIGFuIGVtcHR5IG9iamVjdCBzbwogIC8vIHRoZXNlIHByb3BlcnRpZXMgZGVmaW5pdGlvbnMgY2FuIGJlIHNraXBwZWQuCiAgZnVuY3Rpb24gY3JlYXRlRGV2UmVuZGVyQ29udGV4dChpbnN0YW5jZSkgewogICAgICBjb25zdCB0YXJnZXQgPSB7fTsKICAgICAgLy8gZXhwb3NlIGludGVybmFsIGluc3RhbmNlIGZvciBwcm94eSBoYW5kbGVycwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBgX2AsIHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgZ2V0OiAoKSA9PiBpbnN0YW5jZQogICAgICB9KTsKICAgICAgLy8gZXhwb3NlIHB1YmxpYyBwcm9wZXJ0aWVzCiAgICAgIE9iamVjdC5rZXlzKHB1YmxpY1Byb3BlcnRpZXNNYXApLmZvckVhY2goa2V5ID0+IHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBnZXQ6ICgpID0+IHB1YmxpY1Byb3BlcnRpZXNNYXBba2V5XShpbnN0YW5jZSksCiAgICAgICAgICAgICAgLy8gaW50ZXJjZXB0ZWQgYnkgdGhlIHByb3h5IHNvIG5vIG5lZWQgZm9yIGltcGxlbWVudGF0aW9uLAogICAgICAgICAgICAgIC8vIGJ1dCBuZWVkZWQgdG8gcHJldmVudCBzZXQgZXJyb3JzCiAgICAgICAgICAgICAgc2V0OiBOT09QCiAgICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIC8vIGRldiBvbmx5CiAgZnVuY3Rpb24gZXhwb3NlUHJvcHNPblJlbmRlckNvbnRleHQoaW5zdGFuY2UpIHsKICAgICAgY29uc3QgeyBjdHgsIHByb3BzT3B0aW9uczogW3Byb3BzT3B0aW9uc10gfSA9IGluc3RhbmNlOwogICAgICBpZiAocHJvcHNPcHRpb25zKSB7CiAgICAgICAgICBPYmplY3Qua2V5cyhwcm9wc09wdGlvbnMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsKICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBnZXQ6ICgpID0+IGluc3RhbmNlLnByb3BzW2tleV0sCiAgICAgICAgICAgICAgICAgIHNldDogTk9PUAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgIH0KICB9CiAgLy8gZGV2IG9ubHkKICBmdW5jdGlvbiBleHBvc2VTZXR1cFN0YXRlT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IHsgY3R4LCBzZXR1cFN0YXRlIH0gPSBpbnN0YW5jZTsKICAgICAgT2JqZWN0LmtleXModG9SYXcoc2V0dXBTdGF0ZSkpLmZvckVhY2goa2V5ID0+IHsKICAgICAgICAgIGlmICghc2V0dXBTdGF0ZS5fX2lzU2NyaXB0U2V0dXApIHsKICAgICAgICAgICAgICBpZiAoaXNSZXNlcnZlZFByZWZpeChrZXlbMF0pKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgc2V0dXAoKSByZXR1cm4gcHJvcGVydHkgJHtKU09OLnN0cmluZ2lmeShrZXkpfSBzaG91bGQgbm90IHN0YXJ0IHdpdGggIiQiIG9yICJfIiBgICsKICAgICAgICAgICAgICAgICAgICAgIGB3aGljaCBhcmUgcmVzZXJ2ZWQgcHJlZml4ZXMgZm9yIFZ1ZSBpbnRlcm5hbHMuYCk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eCwga2V5LCB7CiAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgZ2V0OiAoKSA9PiBzZXR1cFN0YXRlW2tleV0sCiAgICAgICAgICAgICAgICAgIHNldDogTk9PUAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUR1cGxpY2F0ZUNoZWNrZXIoKSB7CiAgICAgIGNvbnN0IGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgcmV0dXJuICh0eXBlLCBrZXkpID0+IHsKICAgICAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgICAgICAgd2FybiQxKGAke3R5cGV9IHByb3BlcnR5ICIke2tleX0iIGlzIGFscmVhZHkgZGVmaW5lZCBpbiAke2NhY2hlW2tleV19LmApOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVba2V5XSA9IHR5cGU7CiAgICAgICAgICB9CiAgICAgIH07CiAgfQogIGxldCBzaG91bGRDYWNoZUFjY2VzcyA9IHRydWU7CiAgZnVuY3Rpb24gYXBwbHlPcHRpb25zKGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IG9wdGlvbnMgPSByZXNvbHZlTWVyZ2VkT3B0aW9ucyhpbnN0YW5jZSk7CiAgICAgIGNvbnN0IHB1YmxpY1RoaXMgPSBpbnN0YW5jZS5wcm94eTsKICAgICAgY29uc3QgY3R4ID0gaW5zdGFuY2UuY3R4OwogICAgICAvLyBkbyBub3QgY2FjaGUgcHJvcGVydHkgYWNjZXNzIG9uIHB1YmxpYyBwcm94eSBkdXJpbmcgc3RhdGUgaW5pdGlhbGl6YXRpb24KICAgICAgc2hvdWxkQ2FjaGVBY2Nlc3MgPSBmYWxzZTsKICAgICAgLy8gY2FsbCBiZWZvcmVDcmVhdGUgZmlyc3QgYmVmb3JlIGFjY2Vzc2luZyBvdGhlciBvcHRpb25zIHNpbmNlCiAgICAgIC8vIHRoZSBob29rIG1heSBtdXRhdGUgcmVzb2x2ZWQgb3B0aW9ucyAoIzI3OTEpCiAgICAgIGlmIChvcHRpb25zLmJlZm9yZUNyZWF0ZSkgewogICAgICAgICAgY2FsbEhvb2sob3B0aW9ucy5iZWZvcmVDcmVhdGUsIGluc3RhbmNlLCAiYmMiIC8qIEJFRk9SRV9DUkVBVEUgKi8pOwogICAgICB9CiAgICAgIGNvbnN0IHsgCiAgICAgIC8vIHN0YXRlCiAgICAgIGRhdGE6IGRhdGFPcHRpb25zLCBjb21wdXRlZDogY29tcHV0ZWRPcHRpb25zLCBtZXRob2RzLCB3YXRjaDogd2F0Y2hPcHRpb25zLCBwcm92aWRlOiBwcm92aWRlT3B0aW9ucywgaW5qZWN0OiBpbmplY3RPcHRpb25zLCAKICAgICAgLy8gbGlmZWN5Y2xlCiAgICAgIGNyZWF0ZWQsIGJlZm9yZU1vdW50LCBtb3VudGVkLCBiZWZvcmVVcGRhdGUsIHVwZGF0ZWQsIGFjdGl2YXRlZCwgZGVhY3RpdmF0ZWQsIGJlZm9yZURlc3Ryb3ksIGJlZm9yZVVubW91bnQsIGRlc3Ryb3llZCwgdW5tb3VudGVkLCByZW5kZXIsIHJlbmRlclRyYWNrZWQsIHJlbmRlclRyaWdnZXJlZCwgZXJyb3JDYXB0dXJlZCwgc2VydmVyUHJlZmV0Y2gsIAogICAgICAvLyBwdWJsaWMgQVBJCiAgICAgIGV4cG9zZSwgaW5oZXJpdEF0dHJzLCAKICAgICAgLy8gYXNzZXRzCiAgICAgIGNvbXBvbmVudHMsIGRpcmVjdGl2ZXMsIGZpbHRlcnMgfSA9IG9wdGlvbnM7CiAgICAgIGNvbnN0IGNoZWNrRHVwbGljYXRlUHJvcGVydGllcyA9IGNyZWF0ZUR1cGxpY2F0ZUNoZWNrZXIoKSA7CiAgICAgIHsKICAgICAgICAgIGNvbnN0IFtwcm9wc09wdGlvbnNdID0gaW5zdGFuY2UucHJvcHNPcHRpb25zOwogICAgICAgICAgaWYgKHByb3BzT3B0aW9ucykgewogICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzT3B0aW9ucykgewogICAgICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIlByb3BzIiAvKiBQUk9QUyAqLywga2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gb3B0aW9ucyBpbml0aWFsaXphdGlvbiBvcmRlciAodG8gYmUgY29uc2lzdGVudCB3aXRoIFZ1ZSAyKToKICAgICAgLy8gLSBwcm9wcyAoYWxyZWFkeSBkb25lIG91dHNpZGUgb2YgdGhpcyBmdW5jdGlvbikKICAgICAgLy8gLSBpbmplY3QKICAgICAgLy8gLSBtZXRob2RzCiAgICAgIC8vIC0gZGF0YSAoZGVmZXJyZWQgc2luY2UgaXQgcmVsaWVzIG9uIGB0aGlzYCBhY2Nlc3MpCiAgICAgIC8vIC0gY29tcHV0ZWQKICAgICAgLy8gLSB3YXRjaCAoZGVmZXJyZWQgc2luY2UgaXQgcmVsaWVzIG9uIGB0aGlzYCBhY2Nlc3MpCiAgICAgIGlmIChpbmplY3RPcHRpb25zKSB7CiAgICAgICAgICByZXNvbHZlSW5qZWN0aW9ucyhpbmplY3RPcHRpb25zLCBjdHgsIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcywgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcudW53cmFwSW5qZWN0ZWRSZWYpOwogICAgICB9CiAgICAgIGlmIChtZXRob2RzKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBtZXRob2RzKSB7CiAgICAgICAgICAgICAgY29uc3QgbWV0aG9kSGFuZGxlciA9IG1ldGhvZHNba2V5XTsKICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihtZXRob2RIYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICAvLyBJbiBkZXYgbW9kZSwgd2UgdXNlIHRoZSBgY3JlYXRlUmVuZGVyQ29udGV4dGAgZnVuY3Rpb24gdG8gZGVmaW5lCiAgICAgICAgICAgICAgICAgIC8vIG1ldGhvZHMgdG8gdGhlIHByb3h5IHRhcmdldCwgYW5kIHRob3NlIGFyZSByZWFkLW9ubHkgYnV0CiAgICAgICAgICAgICAgICAgIC8vIHJlY29uZmlndXJhYmxlLCBzbyBpdCBuZWVkcyB0byBiZSByZWRlZmluZWQgaGVyZQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbWV0aG9kSGFuZGxlci5iaW5kKHB1YmxpY1RoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIk1ldGhvZHMiIC8qIE1FVEhPRFMgKi8sIGtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgTWV0aG9kICIke2tleX0iIGhhcyB0eXBlICIke3R5cGVvZiBtZXRob2RIYW5kbGVyfSIgaW4gdGhlIGNvbXBvbmVudCBkZWZpbml0aW9uLiBgICsKICAgICAgICAgICAgICAgICAgICAgIGBEaWQgeW91IHJlZmVyZW5jZSB0aGUgZnVuY3Rpb24gY29ycmVjdGx5P2ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGF0YU9wdGlvbnMpIHsKICAgICAgICAgIGlmICghaXNGdW5jdGlvbihkYXRhT3B0aW9ucykpIHsKICAgICAgICAgICAgICB3YXJuJDEoYFRoZSBkYXRhIG9wdGlvbiBtdXN0IGJlIGEgZnVuY3Rpb24uIGAgKwogICAgICAgICAgICAgICAgICBgUGxhaW4gb2JqZWN0IHVzYWdlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuYCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBkYXRhID0gZGF0YU9wdGlvbnMuY2FsbChwdWJsaWNUaGlzLCBwdWJsaWNUaGlzKTsKICAgICAgICAgIGlmIChpc1Byb21pc2UoZGF0YSkpIHsKICAgICAgICAgICAgICB3YXJuJDEoYGRhdGEoKSByZXR1cm5lZCBhIFByb21pc2UgLSBub3RlIGRhdGEoKSBjYW5ub3QgYmUgYXN5bmM7IElmIHlvdSBgICsKICAgICAgICAgICAgICAgICAgYGludGVuZCB0byBwZXJmb3JtIGRhdGEgZmV0Y2hpbmcgYmVmb3JlIGNvbXBvbmVudCByZW5kZXJzLCB1c2UgYCArCiAgICAgICAgICAgICAgICAgIGBhc3luYyBzZXR1cCgpICsgPFN1c3BlbnNlPi5gKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPYmplY3QoZGF0YSkpIHsKICAgICAgICAgICAgICB3YXJuJDEoYGRhdGEoKSBzaG91bGQgcmV0dXJuIGFuIG9iamVjdC5gKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGluc3RhbmNlLmRhdGEgPSByZWFjdGl2ZShkYXRhKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiRGF0YSIgLyogREFUQSAqLywga2V5KTsKICAgICAgICAgICAgICAgICAgICAgIC8vIGV4cG9zZSBkYXRhIG9uIGN0eCBkdXJpbmcgZGV2CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogKCkgPT4gZGF0YVtrZXldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IE5PT1AKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICAvLyBzdGF0ZSBpbml0aWFsaXphdGlvbiBjb21wbGV0ZSBhdCB0aGlzIHBvaW50IC0gc3RhcnQgY2FjaGluZyBhY2Nlc3MKICAgICAgc2hvdWxkQ2FjaGVBY2Nlc3MgPSB0cnVlOwogICAgICBpZiAoY29tcHV0ZWRPcHRpb25zKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBjb21wdXRlZE9wdGlvbnMpIHsKICAgICAgICAgICAgICBjb25zdCBvcHQgPSBjb21wdXRlZE9wdGlvbnNba2V5XTsKICAgICAgICAgICAgICBjb25zdCBnZXQgPSBpc0Z1bmN0aW9uKG9wdCkKICAgICAgICAgICAgICAgICAgPyBvcHQuYmluZChwdWJsaWNUaGlzLCBwdWJsaWNUaGlzKQogICAgICAgICAgICAgICAgICA6IGlzRnVuY3Rpb24ob3B0LmdldCkKICAgICAgICAgICAgICAgICAgICAgID8gb3B0LmdldC5iaW5kKHB1YmxpY1RoaXMsIHB1YmxpY1RoaXMpCiAgICAgICAgICAgICAgICAgICAgICA6IE5PT1A7CiAgICAgICAgICAgICAgaWYgKGdldCA9PT0gTk9PUCkgewogICAgICAgICAgICAgICAgICB3YXJuJDEoYENvbXB1dGVkIHByb3BlcnR5ICIke2tleX0iIGhhcyBubyBnZXR0ZXIuYCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IHNldCA9ICFpc0Z1bmN0aW9uKG9wdCkgJiYgaXNGdW5jdGlvbihvcHQuc2V0KQogICAgICAgICAgICAgICAgICA/IG9wdC5zZXQuYmluZChwdWJsaWNUaGlzKQogICAgICAgICAgICAgICAgICA6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYFdyaXRlIG9wZXJhdGlvbiBmYWlsZWQ6IGNvbXB1dGVkIHByb3BlcnR5ICIke2tleX0iIGlzIHJlYWRvbmx5LmApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgIGNvbnN0IGMgPSBjb21wdXRlZCQxKHsKICAgICAgICAgICAgICAgICAgZ2V0LAogICAgICAgICAgICAgICAgICBzZXQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsKICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBnZXQ6ICgpID0+IGMudmFsdWUsCiAgICAgICAgICAgICAgICAgIHNldDogdiA9PiAoYy52YWx1ZSA9IHYpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIkNvbXB1dGVkIiAvKiBDT01QVVRFRCAqLywga2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHdhdGNoT3B0aW9ucykgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gd2F0Y2hPcHRpb25zKSB7CiAgICAgICAgICAgICAgY3JlYXRlV2F0Y2hlcih3YXRjaE9wdGlvbnNba2V5XSwgY3R4LCBwdWJsaWNUaGlzLCBrZXkpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwcm92aWRlT3B0aW9ucykgewogICAgICAgICAgY29uc3QgcHJvdmlkZXMgPSBpc0Z1bmN0aW9uKHByb3ZpZGVPcHRpb25zKQogICAgICAgICAgICAgID8gcHJvdmlkZU9wdGlvbnMuY2FsbChwdWJsaWNUaGlzKQogICAgICAgICAgICAgIDogcHJvdmlkZU9wdGlvbnM7CiAgICAgICAgICBSZWZsZWN0Lm93bktleXMocHJvdmlkZXMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgICAgICAgICBwcm92aWRlKGtleSwgcHJvdmlkZXNba2V5XSk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoY3JlYXRlZCkgewogICAgICAgICAgY2FsbEhvb2soY3JlYXRlZCwgaW5zdGFuY2UsICJjIiAvKiBDUkVBVEVEICovKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWdpc3RlckxpZmVjeWNsZUhvb2socmVnaXN0ZXIsIGhvb2spIHsKICAgICAgICAgIGlmIChpc0FycmF5KGhvb2spKSB7CiAgICAgICAgICAgICAgaG9vay5mb3JFYWNoKF9ob29rID0+IHJlZ2lzdGVyKF9ob29rLmJpbmQocHVibGljVGhpcykpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGhvb2spIHsKICAgICAgICAgICAgICByZWdpc3Rlcihob29rLmJpbmQocHVibGljVGhpcykpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkJlZm9yZU1vdW50LCBiZWZvcmVNb3VudCk7CiAgICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbk1vdW50ZWQsIG1vdW50ZWQpOwogICAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25CZWZvcmVVcGRhdGUsIGJlZm9yZVVwZGF0ZSk7CiAgICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblVwZGF0ZWQsIHVwZGF0ZWQpOwogICAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25BY3RpdmF0ZWQsIGFjdGl2YXRlZCk7CiAgICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkRlYWN0aXZhdGVkLCBkZWFjdGl2YXRlZCk7CiAgICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkVycm9yQ2FwdHVyZWQsIGVycm9yQ2FwdHVyZWQpOwogICAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25SZW5kZXJUcmFja2VkLCByZW5kZXJUcmFja2VkKTsKICAgICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uUmVuZGVyVHJpZ2dlcmVkLCByZW5kZXJUcmlnZ2VyZWQpOwogICAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25CZWZvcmVVbm1vdW50LCBiZWZvcmVVbm1vdW50KTsKICAgICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uVW5tb3VudGVkLCB1bm1vdW50ZWQpOwogICAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25TZXJ2ZXJQcmVmZXRjaCwgc2VydmVyUHJlZmV0Y2gpOwogICAgICBpZiAoaXNBcnJheShleHBvc2UpKSB7CiAgICAgICAgICBpZiAoZXhwb3NlLmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnN0IGV4cG9zZWQgPSBpbnN0YW5jZS5leHBvc2VkIHx8IChpbnN0YW5jZS5leHBvc2VkID0ge30pOwogICAgICAgICAgICAgIGV4cG9zZS5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvc2VkLCBrZXksIHsKICAgICAgICAgICAgICAgICAgICAgIGdldDogKCkgPT4gcHVibGljVGhpc1trZXldLAogICAgICAgICAgICAgICAgICAgICAgc2V0OiB2YWwgPT4gKHB1YmxpY1RoaXNba2V5XSA9IHZhbCkKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICghaW5zdGFuY2UuZXhwb3NlZCkgewogICAgICAgICAgICAgIGluc3RhbmNlLmV4cG9zZWQgPSB7fTsKICAgICAgICAgIH0KICAgICAgfQogICAgICAvLyBvcHRpb25zIHRoYXQgYXJlIGhhbmRsZWQgd2hlbiBjcmVhdGluZyB0aGUgaW5zdGFuY2UgYnV0IGFsc28gbmVlZCB0byBiZQogICAgICAvLyBhcHBsaWVkIGZyb20gbWl4aW5zCiAgICAgIGlmIChyZW5kZXIgJiYgaW5zdGFuY2UucmVuZGVyID09PSBOT09QKSB7CiAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIgPSByZW5kZXI7CiAgICAgIH0KICAgICAgaWYgKGluaGVyaXRBdHRycyAhPSBudWxsKSB7CiAgICAgICAgICBpbnN0YW5jZS5pbmhlcml0QXR0cnMgPSBpbmhlcml0QXR0cnM7CiAgICAgIH0KICAgICAgLy8gYXNzZXQgb3B0aW9ucy4KICAgICAgaWYgKGNvbXBvbmVudHMpCiAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRzID0gY29tcG9uZW50czsKICAgICAgaWYgKGRpcmVjdGl2ZXMpCiAgICAgICAgICBpbnN0YW5jZS5kaXJlY3RpdmVzID0gZGlyZWN0aXZlczsKICB9CiAgZnVuY3Rpb24gcmVzb2x2ZUluamVjdGlvbnMoaW5qZWN0T3B0aW9ucywgY3R4LCBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMgPSBOT09QLCB1bndyYXBSZWYgPSBmYWxzZSkgewogICAgICBpZiAoaXNBcnJheShpbmplY3RPcHRpb25zKSkgewogICAgICAgICAgaW5qZWN0T3B0aW9ucyA9IG5vcm1hbGl6ZUluamVjdChpbmplY3RPcHRpb25zKTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBpbmplY3RPcHRpb25zKSB7CiAgICAgICAgICBjb25zdCBvcHQgPSBpbmplY3RPcHRpb25zW2tleV07CiAgICAgICAgICBsZXQgaW5qZWN0ZWQ7CiAgICAgICAgICBpZiAoaXNPYmplY3Qob3B0KSkgewogICAgICAgICAgICAgIGlmICgnZGVmYXVsdCcgaW4gb3B0KSB7CiAgICAgICAgICAgICAgICAgIGluamVjdGVkID0gaW5qZWN0KG9wdC5mcm9tIHx8IGtleSwgb3B0LmRlZmF1bHQsIHRydWUgLyogdHJlYXQgZGVmYXVsdCBmdW5jdGlvbiBhcyBmYWN0b3J5ICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGluamVjdGVkID0gaW5qZWN0KG9wdC5mcm9tIHx8IGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWQgPSBpbmplY3Qob3B0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1JlZihpbmplY3RlZCkpIHsKICAgICAgICAgICAgICAvLyBUT0RPIHJlbW92ZSB0aGUgY2hlY2sgaW4gMy4zCiAgICAgICAgICAgICAgaWYgKHVud3JhcFJlZikgewogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsKICAgICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICBnZXQ6ICgpID0+IGluamVjdGVkLnZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgc2V0OiB2ID0+IChpbmplY3RlZC52YWx1ZSA9IHYpCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBpbmplY3RlZCBwcm9wZXJ0eSAiJHtrZXl9IiBpcyBhIHJlZiBhbmQgd2lsbCBiZSBhdXRvLXVud3JhcHBlZCBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIG5vIGxvbmdlciBuZWVkcyBcYC52YWx1ZVxgIGluIHRoZSBuZXh0IG1pbm9yIHJlbGVhc2UuIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGBUbyBvcHQtaW4gdG8gdGhlIG5ldyBiZWhhdmlvciBub3csIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGBzZXQgXGBhcHAuY29uZmlnLnVud3JhcEluamVjdGVkUmVmID0gdHJ1ZVxgICh0aGlzIGNvbmZpZyBpcyBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgdGVtcG9yYXJ5IGFuZCB3aWxsIG5vdCBiZSBuZWVkZWQgaW4gdGhlIGZ1dHVyZS4pYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY3R4W2tleV0gPSBpbmplY3RlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBjdHhba2V5XSA9IGluamVjdGVkOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiSW5qZWN0IiAvKiBJTkpFQ1QgKi8sIGtleSk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gY2FsbEhvb2soaG9vaywgaW5zdGFuY2UsIHR5cGUpIHsKICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoaXNBcnJheShob29rKQogICAgICAgICAgPyBob29rLm1hcChoID0+IGguYmluZChpbnN0YW5jZS5wcm94eSkpCiAgICAgICAgICA6IGhvb2suYmluZChpbnN0YW5jZS5wcm94eSksIGluc3RhbmNlLCB0eXBlKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlV2F0Y2hlcihyYXcsIGN0eCwgcHVibGljVGhpcywga2V5KSB7CiAgICAgIGNvbnN0IGdldHRlciA9IGtleS5pbmNsdWRlcygnLicpCiAgICAgICAgICA/IGNyZWF0ZVBhdGhHZXR0ZXIocHVibGljVGhpcywga2V5KQogICAgICAgICAgOiAoKSA9PiBwdWJsaWNUaGlzW2tleV07CiAgICAgIGlmIChpc1N0cmluZyhyYXcpKSB7CiAgICAgICAgICBjb25zdCBoYW5kbGVyID0gY3R4W3Jhd107CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgICAgICAgICAgIHdhdGNoKGdldHRlciwgaGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggaGFuZGxlciBzcGVjaWZpZWQgYnkga2V5ICIke3Jhd30iYCwgaGFuZGxlcik7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNGdW5jdGlvbihyYXcpKSB7CiAgICAgICAgICB3YXRjaChnZXR0ZXIsIHJhdy5iaW5kKHB1YmxpY1RoaXMpKTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc09iamVjdChyYXcpKSB7CiAgICAgICAgICBpZiAoaXNBcnJheShyYXcpKSB7CiAgICAgICAgICAgICAgcmF3LmZvckVhY2gociA9PiBjcmVhdGVXYXRjaGVyKHIsIGN0eCwgcHVibGljVGhpcywga2V5KSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBjb25zdCBoYW5kbGVyID0gaXNGdW5jdGlvbihyYXcuaGFuZGxlcikKICAgICAgICAgICAgICAgICAgPyByYXcuaGFuZGxlci5iaW5kKHB1YmxpY1RoaXMpCiAgICAgICAgICAgICAgICAgIDogY3R4W3Jhdy5oYW5kbGVyXTsKICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgICAgICAgICAgICAgICB3YXRjaChnZXR0ZXIsIGhhbmRsZXIsIHJhdyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggaGFuZGxlciBzcGVjaWZpZWQgYnkga2V5ICIke3Jhdy5oYW5kbGVyfSJgLCBoYW5kbGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggb3B0aW9uOiAiJHtrZXl9ImAsIHJhdyk7CiAgICAgIH0KICB9CiAgLyoqCiAgICogUmVzb2x2ZSBtZXJnZWQgb3B0aW9ucyBhbmQgY2FjaGUgaXQgb24gdGhlIGNvbXBvbmVudC4KICAgKiBUaGlzIGlzIGRvbmUgb25seSBvbmNlIHBlci1jb21wb25lbnQgc2luY2UgdGhlIG1lcmdpbmcgZG9lcyBub3QgaW52b2x2ZQogICAqIGluc3RhbmNlcy4KICAgKi8KICBmdW5jdGlvbiByZXNvbHZlTWVyZ2VkT3B0aW9ucyhpbnN0YW5jZSkgewogICAgICBjb25zdCBiYXNlID0gaW5zdGFuY2UudHlwZTsKICAgICAgY29uc3QgeyBtaXhpbnMsIGV4dGVuZHM6IGV4dGVuZHNPcHRpb25zIH0gPSBiYXNlOwogICAgICBjb25zdCB7IG1peGluczogZ2xvYmFsTWl4aW5zLCBvcHRpb25zQ2FjaGU6IGNhY2hlLCBjb25maWc6IHsgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzIH0gfSA9IGluc3RhbmNlLmFwcENvbnRleHQ7CiAgICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChiYXNlKTsKICAgICAgbGV0IHJlc29sdmVkOwogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgICByZXNvbHZlZCA9IGNhY2hlZDsKICAgICAgfQogICAgICBlbHNlIGlmICghZ2xvYmFsTWl4aW5zLmxlbmd0aCAmJiAhbWl4aW5zICYmICFleHRlbmRzT3B0aW9ucykgewogICAgICAgICAgewogICAgICAgICAgICAgIHJlc29sdmVkID0gYmFzZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHJlc29sdmVkID0ge307CiAgICAgICAgICBpZiAoZ2xvYmFsTWl4aW5zLmxlbmd0aCkgewogICAgICAgICAgICAgIGdsb2JhbE1peGlucy5mb3JFYWNoKG0gPT4gbWVyZ2VPcHRpb25zKHJlc29sdmVkLCBtLCBvcHRpb25NZXJnZVN0cmF0ZWdpZXMsIHRydWUpKTsKICAgICAgICAgIH0KICAgICAgICAgIG1lcmdlT3B0aW9ucyhyZXNvbHZlZCwgYmFzZSwgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzKTsKICAgICAgfQogICAgICBjYWNoZS5zZXQoYmFzZSwgcmVzb2x2ZWQpOwogICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgfQogIGZ1bmN0aW9uIG1lcmdlT3B0aW9ucyh0bywgZnJvbSwgc3RyYXRzLCBhc01peGluID0gZmFsc2UpIHsKICAgICAgY29uc3QgeyBtaXhpbnMsIGV4dGVuZHM6IGV4dGVuZHNPcHRpb25zIH0gPSBmcm9tOwogICAgICBpZiAoZXh0ZW5kc09wdGlvbnMpIHsKICAgICAgICAgIG1lcmdlT3B0aW9ucyh0bywgZXh0ZW5kc09wdGlvbnMsIHN0cmF0cywgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKG1peGlucykgewogICAgICAgICAgbWl4aW5zLmZvckVhY2goKG0pID0+IG1lcmdlT3B0aW9ucyh0bywgbSwgc3RyYXRzLCB0cnVlKSk7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBrZXkgaW4gZnJvbSkgewogICAgICAgICAgaWYgKGFzTWl4aW4gJiYga2V5ID09PSAnZXhwb3NlJykgewogICAgICAgICAgICAgIHdhcm4kMShgImV4cG9zZSIgb3B0aW9uIGlzIGlnbm9yZWQgd2hlbiBkZWNsYXJlZCBpbiBtaXhpbnMgb3IgZXh0ZW5kcy4gYCArCiAgICAgICAgICAgICAgICAgICAgICBgSXQgc2hvdWxkIG9ubHkgYmUgZGVjbGFyZWQgaW4gdGhlIGJhc2UgY29tcG9uZW50IGl0c2VsZi5gKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGNvbnN0IHN0cmF0ID0gaW50ZXJuYWxPcHRpb25NZXJnZVN0cmF0c1trZXldIHx8IChzdHJhdHMgJiYgc3RyYXRzW2tleV0pOwogICAgICAgICAgICAgIHRvW2tleV0gPSBzdHJhdCA/IHN0cmF0KHRvW2tleV0sIGZyb21ba2V5XSkgOiBmcm9tW2tleV07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRvOwogIH0KICBjb25zdCBpbnRlcm5hbE9wdGlvbk1lcmdlU3RyYXRzID0gewogICAgICBkYXRhOiBtZXJnZURhdGFGbiwKICAgICAgcHJvcHM6IG1lcmdlT2JqZWN0T3B0aW9ucywKICAgICAgZW1pdHM6IG1lcmdlT2JqZWN0T3B0aW9ucywKICAgICAgLy8gb2JqZWN0cwogICAgICBtZXRob2RzOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICAgIGNvbXB1dGVkOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICAgIC8vIGxpZmVjeWNsZQogICAgICBiZWZvcmVDcmVhdGU6IG1lcmdlQXNBcnJheSwKICAgICAgY3JlYXRlZDogbWVyZ2VBc0FycmF5LAogICAgICBiZWZvcmVNb3VudDogbWVyZ2VBc0FycmF5LAogICAgICBtb3VudGVkOiBtZXJnZUFzQXJyYXksCiAgICAgIGJlZm9yZVVwZGF0ZTogbWVyZ2VBc0FycmF5LAogICAgICB1cGRhdGVkOiBtZXJnZUFzQXJyYXksCiAgICAgIGJlZm9yZURlc3Ryb3k6IG1lcmdlQXNBcnJheSwKICAgICAgYmVmb3JlVW5tb3VudDogbWVyZ2VBc0FycmF5LAogICAgICBkZXN0cm95ZWQ6IG1lcmdlQXNBcnJheSwKICAgICAgdW5tb3VudGVkOiBtZXJnZUFzQXJyYXksCiAgICAgIGFjdGl2YXRlZDogbWVyZ2VBc0FycmF5LAogICAgICBkZWFjdGl2YXRlZDogbWVyZ2VBc0FycmF5LAogICAgICBlcnJvckNhcHR1cmVkOiBtZXJnZUFzQXJyYXksCiAgICAgIHNlcnZlclByZWZldGNoOiBtZXJnZUFzQXJyYXksCiAgICAgIC8vIGFzc2V0cwogICAgICBjb21wb25lbnRzOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICAgIGRpcmVjdGl2ZXM6IG1lcmdlT2JqZWN0T3B0aW9ucywKICAgICAgLy8gd2F0Y2gKICAgICAgd2F0Y2g6IG1lcmdlV2F0Y2hPcHRpb25zLAogICAgICAvLyBwcm92aWRlIC8gaW5qZWN0CiAgICAgIHByb3ZpZGU6IG1lcmdlRGF0YUZuLAogICAgICBpbmplY3Q6IG1lcmdlSW5qZWN0CiAgfTsKICBmdW5jdGlvbiBtZXJnZURhdGFGbih0bywgZnJvbSkgewogICAgICBpZiAoIWZyb20pIHsKICAgICAgICAgIHJldHVybiB0bzsKICAgICAgfQogICAgICBpZiAoIXRvKSB7CiAgICAgICAgICByZXR1cm4gZnJvbTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkRGF0YUZuKCkgewogICAgICAgICAgcmV0dXJuIChleHRlbmQpKGlzRnVuY3Rpb24odG8pID8gdG8uY2FsbCh0aGlzLCB0aGlzKSA6IHRvLCBpc0Z1bmN0aW9uKGZyb20pID8gZnJvbS5jYWxsKHRoaXMsIHRoaXMpIDogZnJvbSk7CiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIG1lcmdlSW5qZWN0KHRvLCBmcm9tKSB7CiAgICAgIHJldHVybiBtZXJnZU9iamVjdE9wdGlvbnMobm9ybWFsaXplSW5qZWN0KHRvKSwgbm9ybWFsaXplSW5qZWN0KGZyb20pKTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplSW5qZWN0KHJhdykgewogICAgICBpZiAoaXNBcnJheShyYXcpKSB7CiAgICAgICAgICBjb25zdCByZXMgPSB7fTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgcmVzW3Jhd1tpXV0gPSByYXdbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIHJldHVybiByYXc7CiAgfQogIGZ1bmN0aW9uIG1lcmdlQXNBcnJheSh0bywgZnJvbSkgewogICAgICByZXR1cm4gdG8gPyBbLi4ubmV3IFNldChbXS5jb25jYXQodG8sIGZyb20pKV0gOiBmcm9tOwogIH0KICBmdW5jdGlvbiBtZXJnZU9iamVjdE9wdGlvbnModG8sIGZyb20pIHsKICAgICAgcmV0dXJuIHRvID8gZXh0ZW5kKGV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCB0byksIGZyb20pIDogZnJvbTsKICB9CiAgZnVuY3Rpb24gbWVyZ2VXYXRjaE9wdGlvbnModG8sIGZyb20pIHsKICAgICAgaWYgKCF0bykKICAgICAgICAgIHJldHVybiBmcm9tOwogICAgICBpZiAoIWZyb20pCiAgICAgICAgICByZXR1cm4gdG87CiAgICAgIGNvbnN0IG1lcmdlZCA9IGV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCB0byk7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIGZyb20pIHsKICAgICAgICAgIG1lcmdlZFtrZXldID0gbWVyZ2VBc0FycmF5KHRvW2tleV0sIGZyb21ba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1lcmdlZDsKICB9CgogIGZ1bmN0aW9uIGluaXRQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIGlzU3RhdGVmdWwsIC8vIHJlc3VsdCBvZiBiaXR3aXNlIGZsYWcgY29tcGFyaXNvbgogIGlzU1NSID0gZmFsc2UpIHsKICAgICAgY29uc3QgcHJvcHMgPSB7fTsKICAgICAgY29uc3QgYXR0cnMgPSB7fTsKICAgICAgZGVmKGF0dHJzLCBJbnRlcm5hbE9iamVjdEtleSwgMSk7CiAgICAgIGluc3RhbmNlLnByb3BzRGVmYXVsdHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBzZXRGdWxsUHJvcHMoaW5zdGFuY2UsIHJhd1Byb3BzLCBwcm9wcywgYXR0cnMpOwogICAgICAvLyBlbnN1cmUgYWxsIGRlY2xhcmVkIHByb3Aga2V5cyBhcmUgcHJlc2VudAogICAgICBmb3IgKGNvbnN0IGtleSBpbiBpbnN0YW5jZS5wcm9wc09wdGlvbnNbMF0pIHsKICAgICAgICAgIGlmICghKGtleSBpbiBwcm9wcykpIHsKICAgICAgICAgICAgICBwcm9wc1trZXldID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIHZhbGlkYXRpb24KICAgICAgewogICAgICAgICAgdmFsaWRhdGVQcm9wcyhyYXdQcm9wcyB8fCB7fSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgfQogICAgICBpZiAoaXNTdGF0ZWZ1bCkgewogICAgICAgICAgLy8gc3RhdGVmdWwKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gaXNTU1IgPyBwcm9wcyA6IHNoYWxsb3dSZWFjdGl2ZShwcm9wcyk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBpZiAoIWluc3RhbmNlLnR5cGUucHJvcHMpIHsKICAgICAgICAgICAgICAvLyBmdW5jdGlvbmFsIHcvIG9wdGlvbmFsIHByb3BzLCBwcm9wcyA9PT0gYXR0cnMKICAgICAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IGF0dHJzOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gZnVuY3Rpb25hbCB3LyBkZWNsYXJlZCBwcm9wcwogICAgICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaW5zdGFuY2UuYXR0cnMgPSBhdHRyczsKICB9CiAgZnVuY3Rpb24gdXBkYXRlUHJvcHMoaW5zdGFuY2UsIHJhd1Byb3BzLCByYXdQcmV2UHJvcHMsIG9wdGltaXplZCkgewogICAgICBjb25zdCB7IHByb3BzLCBhdHRycywgdm5vZGU6IHsgcGF0Y2hGbGFnIH0gfSA9IGluc3RhbmNlOwogICAgICBjb25zdCByYXdDdXJyZW50UHJvcHMgPSB0b1Jhdyhwcm9wcyk7CiAgICAgIGNvbnN0IFtvcHRpb25zXSA9IGluc3RhbmNlLnByb3BzT3B0aW9uczsKICAgICAgbGV0IGhhc0F0dHJzQ2hhbmdlZCA9IGZhbHNlOwogICAgICBpZiAoCiAgICAgIC8vIGFsd2F5cyBmb3JjZSBmdWxsIGRpZmYgaW4gZGV2CiAgICAgIC8vIC0gIzE5NDIgaWYgaG1yIGlzIGVuYWJsZWQgd2l0aCBzZmMgY29tcG9uZW50CiAgICAgIC8vIC0gdml0ZSM4NzIgbm9uLXNmYyBjb21wb25lbnQgdXNlZCBieSBzZmMgY29tcG9uZW50CiAgICAgICEoKGluc3RhbmNlLnR5cGUuX19obXJJZCB8fAogICAgICAgICAgICAgIChpbnN0YW5jZS5wYXJlbnQgJiYgaW5zdGFuY2UucGFyZW50LnR5cGUuX19obXJJZCkpKSAmJgogICAgICAgICAgKG9wdGltaXplZCB8fCBwYXRjaEZsYWcgPiAwKSAmJgogICAgICAgICAgIShwYXRjaEZsYWcgJiAxNiAvKiBGVUxMX1BST1BTICovKSkgewogICAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDggLyogUFJPUFMgKi8pIHsKICAgICAgICAgICAgICAvLyBDb21waWxlci1nZW5lcmF0ZWQgcHJvcHMgJiBubyBrZXlzIGNoYW5nZSwganVzdCBzZXQgdGhlIHVwZGF0ZWQKICAgICAgICAgICAgICAvLyB0aGUgcHJvcHMuCiAgICAgICAgICAgICAgY29uc3QgcHJvcHNUb1VwZGF0ZSA9IGluc3RhbmNlLnZub2RlLmR5bmFtaWNQcm9wczsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzVG9VcGRhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgbGV0IGtleSA9IHByb3BzVG9VcGRhdGVbaV07CiAgICAgICAgICAgICAgICAgIC8vIHNraXAgaWYgdGhlIHByb3Aga2V5IGlzIGEgZGVjbGFyZWQgZW1pdCBldmVudCBsaXN0ZW5lcgogICAgICAgICAgICAgICAgICBpZiAoaXNFbWl0TGlzdGVuZXIoaW5zdGFuY2UuZW1pdHNPcHRpb25zLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBQUk9QUyBmbGFnIGd1YXJhbnRlZXMgcmF3UHJvcHMgdG8gYmUgbm9uLW51bGwKICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSByYXdQcm9wc1trZXldOwogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgLy8gYXR0ciAvIHByb3BzIHNlcGFyYXRpb24gd2FzIGRvbmUgb24gaW5pdCBhbmQgd2lsbCBiZSBjb25zaXN0ZW50CiAgICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGlzIGNvZGUgcGF0aCwgc28ganVzdCBjaGVjayBpZiBhdHRycyBoYXZlIGl0LgogICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc093bihhdHRycywga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gYXR0cnNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0F0dHJzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FtZWxpemVkS2V5ID0gY2FtZWxpemUoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wc1tjYW1lbGl6ZWRLZXldID0gcmVzb2x2ZVByb3BWYWx1ZShvcHRpb25zLCByYXdDdXJyZW50UHJvcHMsIGNhbWVsaXplZEtleSwgdmFsdWUsIGluc3RhbmNlLCBmYWxzZSAvKiBpc0Fic2VudCAqLyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IGF0dHJzW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIGZ1bGwgcHJvcHMgdXBkYXRlLgogICAgICAgICAgaWYgKHNldEZ1bGxQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIHByb3BzLCBhdHRycykpIHsKICAgICAgICAgICAgICBoYXNBdHRyc0NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgLy8gaW4gY2FzZSBvZiBkeW5hbWljIHByb3BzLCBjaGVjayBpZiB3ZSBuZWVkIHRvIGRlbGV0ZSBrZXlzIGZyb20KICAgICAgICAgIC8vIHRoZSBwcm9wcyBvYmplY3QKICAgICAgICAgIGxldCBrZWJhYktleTsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHJhd0N1cnJlbnRQcm9wcykgewogICAgICAgICAgICAgIGlmICghcmF3UHJvcHMgfHwKICAgICAgICAgICAgICAgICAgLy8gZm9yIGNhbWVsQ2FzZQogICAgICAgICAgICAgICAgICAoIWhhc093bihyYXdQcm9wcywga2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgLy8gaXQncyBwb3NzaWJsZSB0aGUgb3JpZ2luYWwgcHJvcHMgd2FzIHBhc3NlZCBpbiBhcyBrZWJhYi1jYXNlCiAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgY29udmVydGVkIHRvIGNhbWVsQ2FzZSAoIzk1NSkKICAgICAgICAgICAgICAgICAgICAgICgoa2ViYWJLZXkgPSBoeXBoZW5hdGUoa2V5KSkgPT09IGtleSB8fCAhaGFzT3duKHJhd1Byb3BzLCBrZWJhYktleSkpKSkgewogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHJhd1ByZXZQcm9wcyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBjYW1lbENhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAocmF3UHJldlByb3BzW2tleV0gIT09IHVuZGVmaW5lZCB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3Iga2ViYWItY2FzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXdQcmV2UHJvcHNba2ViYWJLZXldICE9PSB1bmRlZmluZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHNba2V5XSA9IHJlc29sdmVQcm9wVmFsdWUob3B0aW9ucywgcmF3Q3VycmVudFByb3BzLCBrZXksIHVuZGVmaW5lZCwgaW5zdGFuY2UsIHRydWUgLyogaXNBYnNlbnQgKi8pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHByb3BzW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBpbiB0aGUgY2FzZSBvZiBmdW5jdGlvbmFsIGNvbXBvbmVudCB3L28gcHJvcHMgZGVjbGFyYXRpb24sIHByb3BzIGFuZAogICAgICAgICAgLy8gYXR0cnMgcG9pbnQgdG8gdGhlIHNhbWUgb2JqZWN0IHNvIGl0IHNob3VsZCBhbHJlYWR5IGhhdmUgYmVlbiB1cGRhdGVkLgogICAgICAgICAgaWYgKGF0dHJzICE9PSByYXdDdXJyZW50UHJvcHMpIHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBhdHRycykgewogICAgICAgICAgICAgICAgICBpZiAoIXJhd1Byb3BzIHx8CiAgICAgICAgICAgICAgICAgICAgICAoIWhhc093bihyYXdQcm9wcywga2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICghZmFsc2UgKSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBhdHRyc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICAvLyB0cmlnZ2VyIHVwZGF0ZXMgZm9yICRhdHRycyBpbiBjYXNlIGl0J3MgdXNlZCBpbiBjb21wb25lbnQgc2xvdHMKICAgICAgaWYgKGhhc0F0dHJzQ2hhbmdlZCkgewogICAgICAgICAgdHJpZ2dlcihpbnN0YW5jZSwgInNldCIgLyogU0VUICovLCAnJGF0dHJzJyk7CiAgICAgIH0KICAgICAgewogICAgICAgICAgdmFsaWRhdGVQcm9wcyhyYXdQcm9wcyB8fCB7fSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBzZXRGdWxsUHJvcHMoaW5zdGFuY2UsIHJhd1Byb3BzLCBwcm9wcywgYXR0cnMpIHsKICAgICAgY29uc3QgW29wdGlvbnMsIG5lZWRDYXN0S2V5c10gPSBpbnN0YW5jZS5wcm9wc09wdGlvbnM7CiAgICAgIGxldCBoYXNBdHRyc0NoYW5nZWQgPSBmYWxzZTsKICAgICAgbGV0IHJhd0Nhc3RWYWx1ZXM7CiAgICAgIGlmIChyYXdQcm9wcykgewogICAgICAgICAgZm9yIChsZXQga2V5IGluIHJhd1Byb3BzKSB7CiAgICAgICAgICAgICAgLy8ga2V5LCByZWYgYXJlIHJlc2VydmVkIGFuZCBuZXZlciBwYXNzZWQgZG93bgogICAgICAgICAgICAgIGlmIChpc1Jlc2VydmVkUHJvcChrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHJhd1Byb3BzW2tleV07CiAgICAgICAgICAgICAgLy8gcHJvcCBvcHRpb24gbmFtZXMgYXJlIGNhbWVsaXplZCBkdXJpbmcgbm9ybWFsaXphdGlvbiwgc28gdG8gc3VwcG9ydAogICAgICAgICAgICAgIC8vIGtlYmFiIC0+IGNhbWVsIGNvbnZlcnNpb24gaGVyZSB3ZSBuZWVkIHRvIGNhbWVsaXplIHRoZSBrZXkuCiAgICAgICAgICAgICAgbGV0IGNhbWVsS2V5OwogICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIGhhc093bihvcHRpb25zLCAoY2FtZWxLZXkgPSBjYW1lbGl6ZShrZXkpKSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFuZWVkQ2FzdEtleXMgfHwgIW5lZWRDYXN0S2V5cy5pbmNsdWRlcyhjYW1lbEtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHByb3BzW2NhbWVsS2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgKHJhd0Nhc3RWYWx1ZXMgfHwgKHJhd0Nhc3RWYWx1ZXMgPSB7fSkpW2NhbWVsS2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCFpc0VtaXRMaXN0ZW5lcihpbnN0YW5jZS5lbWl0c09wdGlvbnMsIGtleSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCEoa2V5IGluIGF0dHJzKSB8fCB2YWx1ZSAhPT0gYXR0cnNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgYXR0cnNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAobmVlZENhc3RLZXlzKSB7CiAgICAgICAgICBjb25zdCByYXdDdXJyZW50UHJvcHMgPSB0b1Jhdyhwcm9wcyk7CiAgICAgICAgICBjb25zdCBjYXN0VmFsdWVzID0gcmF3Q2FzdFZhbHVlcyB8fCBFTVBUWV9PQko7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5lZWRDYXN0S2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGtleSA9IG5lZWRDYXN0S2V5c1tpXTsKICAgICAgICAgICAgICBwcm9wc1trZXldID0gcmVzb2x2ZVByb3BWYWx1ZShvcHRpb25zLCByYXdDdXJyZW50UHJvcHMsIGtleSwgY2FzdFZhbHVlc1trZXldLCBpbnN0YW5jZSwgIWhhc093bihjYXN0VmFsdWVzLCBrZXkpKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaGFzQXR0cnNDaGFuZ2VkOwogIH0KICBmdW5jdGlvbiByZXNvbHZlUHJvcFZhbHVlKG9wdGlvbnMsIHByb3BzLCBrZXksIHZhbHVlLCBpbnN0YW5jZSwgaXNBYnNlbnQpIHsKICAgICAgY29uc3Qgb3B0ID0gb3B0aW9uc1trZXldOwogICAgICBpZiAob3B0ICE9IG51bGwpIHsKICAgICAgICAgIGNvbnN0IGhhc0RlZmF1bHQgPSBoYXNPd24ob3B0LCAnZGVmYXVsdCcpOwogICAgICAgICAgLy8gZGVmYXVsdCB2YWx1ZXMKICAgICAgICAgIGlmIChoYXNEZWZhdWx0ICYmIHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBvcHQuZGVmYXVsdDsKICAgICAgICAgICAgICBpZiAob3B0LnR5cGUgIT09IEZ1bmN0aW9uICYmIGlzRnVuY3Rpb24oZGVmYXVsdFZhbHVlKSkgewogICAgICAgICAgICAgICAgICBjb25zdCB7IHByb3BzRGVmYXVsdHMgfSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoa2V5IGluIHByb3BzRGVmYXVsdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcHJvcHNEZWZhdWx0c1trZXldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcHJvcHNEZWZhdWx0c1trZXldID0gZGVmYXVsdFZhbHVlLmNhbGwobnVsbCwgcHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgdW5zZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gYm9vbGVhbiBjYXN0aW5nCiAgICAgICAgICBpZiAob3B0WzAgLyogc2hvdWxkQ2FzdCAqL10pIHsKICAgICAgICAgICAgICBpZiAoaXNBYnNlbnQgJiYgIWhhc0RlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAob3B0WzEgLyogc2hvdWxkQ2FzdFRydWUgKi9dICYmCiAgICAgICAgICAgICAgICAgICh2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplUHJvcHNPcHRpb25zKGNvbXAsIGFwcENvbnRleHQsIGFzTWl4aW4gPSBmYWxzZSkgewogICAgICBjb25zdCBjYWNoZSA9IGFwcENvbnRleHQucHJvcHNDYWNoZTsKICAgICAgY29uc3QgY2FjaGVkID0gY2FjaGUuZ2V0KGNvbXApOwogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgICByZXR1cm4gY2FjaGVkOwogICAgICB9CiAgICAgIGNvbnN0IHJhdyA9IGNvbXAucHJvcHM7CiAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSB7fTsKICAgICAgY29uc3QgbmVlZENhc3RLZXlzID0gW107CiAgICAgIC8vIGFwcGx5IG1peGluL2V4dGVuZHMgcHJvcHMKICAgICAgbGV0IGhhc0V4dGVuZHMgPSBmYWxzZTsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGNvbXApKSB7CiAgICAgICAgICBjb25zdCBleHRlbmRQcm9wcyA9IChyYXcpID0+IHsKICAgICAgICAgICAgICBoYXNFeHRlbmRzID0gdHJ1ZTsKICAgICAgICAgICAgICBjb25zdCBbcHJvcHMsIGtleXNdID0gbm9ybWFsaXplUHJvcHNPcHRpb25zKHJhdywgYXBwQ29udGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZXh0ZW5kKG5vcm1hbGl6ZWQsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoa2V5cykKICAgICAgICAgICAgICAgICAgbmVlZENhc3RLZXlzLnB1c2goLi4ua2V5cyk7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKCFhc01peGluICYmIGFwcENvbnRleHQubWl4aW5zLmxlbmd0aCkgewogICAgICAgICAgICAgIGFwcENvbnRleHQubWl4aW5zLmZvckVhY2goZXh0ZW5kUHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbXAuZXh0ZW5kcykgewogICAgICAgICAgICAgIGV4dGVuZFByb3BzKGNvbXAuZXh0ZW5kcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcC5taXhpbnMpIHsKICAgICAgICAgICAgICBjb21wLm1peGlucy5mb3JFYWNoKGV4dGVuZFByb3BzKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXJhdyAmJiAhaGFzRXh0ZW5kcykgewogICAgICAgICAgY2FjaGUuc2V0KGNvbXAsIEVNUFRZX0FSUik7CiAgICAgICAgICByZXR1cm4gRU1QVFlfQVJSOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5KHJhdykpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFpc1N0cmluZyhyYXdbaV0pKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgcHJvcHMgbXVzdCBiZSBzdHJpbmdzIHdoZW4gdXNpbmcgYXJyYXkgc3ludGF4LmAsIHJhd1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRLZXkgPSBjYW1lbGl6ZShyYXdbaV0pOwogICAgICAgICAgICAgIGlmICh2YWxpZGF0ZVByb3BOYW1lKG5vcm1hbGl6ZWRLZXkpKSB7CiAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRbbm9ybWFsaXplZEtleV0gPSBFTVBUWV9PQko7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgaWYgKHJhdykgewogICAgICAgICAgaWYgKCFpc09iamVjdChyYXcpKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBpbnZhbGlkIHByb3BzIG9wdGlvbnNgLCByYXcpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmF3KSB7CiAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZEtleSA9IGNhbWVsaXplKGtleSk7CiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRlUHJvcE5hbWUobm9ybWFsaXplZEtleSkpIHsKICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0ID0gcmF3W2tleV07CiAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3AgPSAobm9ybWFsaXplZFtub3JtYWxpemVkS2V5XSA9CiAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5KG9wdCkgfHwgaXNGdW5jdGlvbihvcHQpID8geyB0eXBlOiBvcHQgfSA6IG9wdCk7CiAgICAgICAgICAgICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBib29sZWFuSW5kZXggPSBnZXRUeXBlSW5kZXgoQm9vbGVhbiwgcHJvcC50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ0luZGV4ID0gZ2V0VHlwZUluZGV4KFN0cmluZywgcHJvcC50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIHByb3BbMCAvKiBzaG91bGRDYXN0ICovXSA9IGJvb2xlYW5JbmRleCA+IC0xOwogICAgICAgICAgICAgICAgICAgICAgcHJvcFsxIC8qIHNob3VsZENhc3RUcnVlICovXSA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nSW5kZXggPCAwIHx8IGJvb2xlYW5JbmRleCA8IHN0cmluZ0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHByb3AgbmVlZHMgYm9vbGVhbiBjYXN0aW5nIG9yIGRlZmF1bHQgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgIGlmIChib29sZWFuSW5kZXggPiAtMSB8fCBoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRDYXN0S2V5cy5wdXNoKG5vcm1hbGl6ZWRLZXkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHJlcyA9IFtub3JtYWxpemVkLCBuZWVkQ2FzdEtleXNdOwogICAgICBjYWNoZS5zZXQoY29tcCwgcmVzKTsKICAgICAgcmV0dXJuIHJlczsKICB9CiAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wTmFtZShrZXkpIHsKICAgICAgaWYgKGtleVswXSAhPT0gJyQnKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHdhcm4kMShgSW52YWxpZCBwcm9wIG5hbWU6ICIke2tleX0iIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHkuYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogIH0KICAvLyB1c2UgZnVuY3Rpb24gc3RyaW5nIG5hbWUgdG8gY2hlY2sgdHlwZSBjb25zdHJ1Y3RvcnMKICAvLyBzbyB0aGF0IGl0IHdvcmtzIGFjcm9zcyB2bXMgLyBpZnJhbWVzLgogIGZ1bmN0aW9uIGdldFR5cGUoY3RvcikgewogICAgICBjb25zdCBtYXRjaCA9IGN0b3IgJiYgY3Rvci50b1N0cmluZygpLm1hdGNoKC9eXHMqZnVuY3Rpb24gKFx3KykvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBjdG9yID09PSBudWxsID8gJ251bGwnIDogJyc7CiAgfQogIGZ1bmN0aW9uIGlzU2FtZVR5cGUoYSwgYikgewogICAgICByZXR1cm4gZ2V0VHlwZShhKSA9PT0gZ2V0VHlwZShiKTsKICB9CiAgZnVuY3Rpb24gZ2V0VHlwZUluZGV4KHR5cGUsIGV4cGVjdGVkVHlwZXMpIHsKICAgICAgaWYgKGlzQXJyYXkoZXhwZWN0ZWRUeXBlcykpIHsKICAgICAgICAgIHJldHVybiBleHBlY3RlZFR5cGVzLmZpbmRJbmRleCh0ID0+IGlzU2FtZVR5cGUodCwgdHlwZSkpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oZXhwZWN0ZWRUeXBlcykpIHsKICAgICAgICAgIHJldHVybiBpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXMsIHR5cGUpID8gMCA6IC0xOwogICAgICB9CiAgICAgIHJldHVybiAtMTsKICB9CiAgLyoqCiAgICogZGV2IG9ubHkKICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BzKHJhd1Byb3BzLCBwcm9wcywgaW5zdGFuY2UpIHsKICAgICAgY29uc3QgcmVzb2x2ZWRWYWx1ZXMgPSB0b1Jhdyhwcm9wcyk7CiAgICAgIGNvbnN0IG9wdGlvbnMgPSBpbnN0YW5jZS5wcm9wc09wdGlvbnNbMF07CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG9wdGlvbnMpIHsKICAgICAgICAgIGxldCBvcHQgPSBvcHRpb25zW2tleV07CiAgICAgICAgICBpZiAob3B0ID09IG51bGwpCiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB2YWxpZGF0ZVByb3Aoa2V5LCByZXNvbHZlZFZhbHVlc1trZXldLCBvcHQsICFoYXNPd24ocmF3UHJvcHMsIGtleSkgJiYgIWhhc093bihyYXdQcm9wcywgaHlwaGVuYXRlKGtleSkpKTsKICAgICAgfQogIH0KICAvKioKICAgKiBkZXYgb25seQogICAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcChuYW1lLCB2YWx1ZSwgcHJvcCwgaXNBYnNlbnQpIHsKICAgICAgY29uc3QgeyB0eXBlLCByZXF1aXJlZCwgdmFsaWRhdG9yIH0gPSBwcm9wOwogICAgICAvLyByZXF1aXJlZCEKICAgICAgaWYgKHJlcXVpcmVkICYmIGlzQWJzZW50KSB7CiAgICAgICAgICB3YXJuJDEoJ01pc3NpbmcgcmVxdWlyZWQgcHJvcDogIicgKyBuYW1lICsgJyInKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBtaXNzaW5nIGJ1dCBvcHRpb25hbAogICAgICBpZiAodmFsdWUgPT0gbnVsbCAmJiAhcHJvcC5yZXF1aXJlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIHR5cGUgY2hlY2sKICAgICAgaWYgKHR5cGUgIT0gbnVsbCAmJiB0eXBlICE9PSB0cnVlKSB7CiAgICAgICAgICBsZXQgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgY29uc3QgdHlwZXMgPSBpc0FycmF5KHR5cGUpID8gdHlwZSA6IFt0eXBlXTsKICAgICAgICAgIGNvbnN0IGV4cGVjdGVkVHlwZXMgPSBbXTsKICAgICAgICAgIC8vIHZhbHVlIGlzIHZhbGlkIGFzIGxvbmcgYXMgb25lIG9mIHRoZSBzcGVjaWZpZWQgdHlwZXMgbWF0Y2gKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoICYmICFpc1ZhbGlkOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCB7IHZhbGlkLCBleHBlY3RlZFR5cGUgfSA9IGFzc2VydFR5cGUodmFsdWUsIHR5cGVzW2ldKTsKICAgICAgICAgICAgICBleHBlY3RlZFR5cGVzLnB1c2goZXhwZWN0ZWRUeXBlIHx8ICcnKTsKICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsaWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICB3YXJuJDEoZ2V0SW52YWxpZFR5cGVNZXNzYWdlKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGN1c3RvbSB2YWxpZGF0b3IKICAgICAgaWYgKHZhbGlkYXRvciAmJiAhdmFsaWRhdG9yKHZhbHVlKSkgewogICAgICAgICAgd2FybiQxKCdJbnZhbGlkIHByb3A6IGN1c3RvbSB2YWxpZGF0b3IgY2hlY2sgZmFpbGVkIGZvciBwcm9wICInICsgbmFtZSArICciLicpOwogICAgICB9CiAgfQogIGNvbnN0IGlzU2ltcGxlVHlwZSA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcCgnU3RyaW5nLE51bWJlcixCb29sZWFuLEZ1bmN0aW9uLFN5bWJvbCxCaWdJbnQnKTsKICAvKioKICAgKiBkZXYgb25seQogICAqLwogIGZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUpIHsKICAgICAgbGV0IHZhbGlkOwogICAgICBjb25zdCBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwogICAgICBpZiAoaXNTaW1wbGVUeXBlKGV4cGVjdGVkVHlwZSkpIHsKICAgICAgICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsdWU7CiAgICAgICAgICB2YWxpZCA9IHQgPT09IGV4cGVjdGVkVHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgLy8gZm9yIHByaW1pdGl2ZSB3cmFwcGVyIG9iamVjdHMKICAgICAgICAgIGlmICghdmFsaWQgJiYgdCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdPYmplY3QnKSB7CiAgICAgICAgICB2YWxpZCA9IGlzT2JqZWN0KHZhbHVlKTsKICAgICAgfQogICAgICBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdBcnJheScpIHsKICAgICAgICAgIHZhbGlkID0gaXNBcnJheSh2YWx1ZSk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnbnVsbCcpIHsKICAgICAgICAgIHZhbGlkID0gdmFsdWUgPT09IG51bGw7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgdmFsaWQsCiAgICAgICAgICBleHBlY3RlZFR5cGUKICAgICAgfTsKICB9CiAgLyoqCiAgICogZGV2IG9ubHkKICAgKi8KICBmdW5jdGlvbiBnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpIHsKICAgICAgbGV0IG1lc3NhZ2UgPSBgSW52YWxpZCBwcm9wOiB0eXBlIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCAiJHtuYW1lfSIuYCArCiAgICAgICAgICBgIEV4cGVjdGVkICR7ZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbignIHwgJyl9YDsKICAgICAgY29uc3QgZXhwZWN0ZWRUeXBlID0gZXhwZWN0ZWRUeXBlc1swXTsKICAgICAgY29uc3QgcmVjZWl2ZWRUeXBlID0gdG9SYXdUeXBlKHZhbHVlKTsKICAgICAgY29uc3QgZXhwZWN0ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgICAgIGNvbnN0IHJlY2VpdmVkVmFsdWUgPSBzdHlsZVZhbHVlKHZhbHVlLCByZWNlaXZlZFR5cGUpOwogICAgICAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgZXhwZWN0ZWQgdmFsdWUKICAgICAgaWYgKGV4cGVjdGVkVHlwZXMubGVuZ3RoID09PSAxICYmCiAgICAgICAgICBpc0V4cGxpY2FibGUoZXhwZWN0ZWRUeXBlKSAmJgogICAgICAgICAgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsKICAgICAgICAgIG1lc3NhZ2UgKz0gYCB3aXRoIHZhbHVlICR7ZXhwZWN0ZWRWYWx1ZX1gOwogICAgICB9CiAgICAgIG1lc3NhZ2UgKz0gYCwgZ290ICR7cmVjZWl2ZWRUeXBlfSBgOwogICAgICAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgcmVjZWl2ZWQgdmFsdWUKICAgICAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICAgICAgICBtZXNzYWdlICs9IGB3aXRoIHZhbHVlICR7cmVjZWl2ZWRWYWx1ZX0uYDsKICAgICAgfQogICAgICByZXR1cm4gbWVzc2FnZTsKICB9CiAgLyoqCiAgICogZGV2IG9ubHkKICAgKi8KICBmdW5jdGlvbiBzdHlsZVZhbHVlKHZhbHVlLCB0eXBlKSB7CiAgICAgIGlmICh0eXBlID09PSAnU3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGAiJHt2YWx1ZX0iYDsKICAgICAgfQogICAgICBlbHNlIGlmICh0eXBlID09PSAnTnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIGAke051bWJlcih2YWx1ZSl9YDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHJldHVybiBgJHt2YWx1ZX1gOwogICAgICB9CiAgfQogIC8qKgogICAqIGRldiBvbmx5CiAgICovCiAgZnVuY3Rpb24gaXNFeHBsaWNhYmxlKHR5cGUpIHsKICAgICAgY29uc3QgZXhwbGljaXRUeXBlcyA9IFsnc3RyaW5nJywgJ251bWJlcicsICdib29sZWFuJ107CiAgICAgIHJldHVybiBleHBsaWNpdFR5cGVzLnNvbWUoZWxlbSA9PiB0eXBlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW0pOwogIH0KICAvKioKICAgKiBkZXYgb25seQogICAqLwogIGZ1bmN0aW9uIGlzQm9vbGVhbiguLi5hcmdzKSB7CiAgICAgIHJldHVybiBhcmdzLnNvbWUoZWxlbSA9PiBlbGVtLnRvTG93ZXJDYXNlKCkgPT09ICdib29sZWFuJyk7CiAgfQoKICBjb25zdCBpc0ludGVybmFsS2V5ID0gKGtleSkgPT4ga2V5WzBdID09PSAnXycgfHwga2V5ID09PSAnJHN0YWJsZSc7CiAgY29uc3Qgbm9ybWFsaXplU2xvdFZhbHVlID0gKHZhbHVlKSA9PiBpc0FycmF5KHZhbHVlKQogICAgICA/IHZhbHVlLm1hcChub3JtYWxpemVWTm9kZSkKICAgICAgOiBbbm9ybWFsaXplVk5vZGUodmFsdWUpXTsKICBjb25zdCBub3JtYWxpemVTbG90ID0gKGtleSwgcmF3U2xvdCwgY3R4KSA9PiB7CiAgICAgIGlmIChyYXdTbG90Ll9uKSB7CiAgICAgICAgICAvLyBhbHJlYWR5IG5vcm1hbGl6ZWQgLSAjNTM1MwogICAgICAgICAgcmV0dXJuIHJhd1Nsb3Q7CiAgICAgIH0KICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IHdpdGhDdHgoKC4uLmFyZ3MpID0+IHsKICAgICAgICAgIGlmIChjdXJyZW50SW5zdGFuY2UpIHsKICAgICAgICAgICAgICB3YXJuJDEoYFNsb3QgIiR7a2V5fSIgaW52b2tlZCBvdXRzaWRlIG9mIHRoZSByZW5kZXIgZnVuY3Rpb246IGAgKwogICAgICAgICAgICAgICAgICBgdGhpcyB3aWxsIG5vdCB0cmFjayBkZXBlbmRlbmNpZXMgdXNlZCBpbiB0aGUgc2xvdC4gYCArCiAgICAgICAgICAgICAgICAgIGBJbnZva2UgdGhlIHNsb3QgZnVuY3Rpb24gaW5zaWRlIHRoZSByZW5kZXIgZnVuY3Rpb24gaW5zdGVhZC5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub3JtYWxpemVTbG90VmFsdWUocmF3U2xvdCguLi5hcmdzKSk7CiAgICAgIH0sIGN0eCk7CiAgICAgIG5vcm1hbGl6ZWQuX2MgPSBmYWxzZTsKICAgICAgcmV0dXJuIG5vcm1hbGl6ZWQ7CiAgfTsKICBjb25zdCBub3JtYWxpemVPYmplY3RTbG90cyA9IChyYXdTbG90cywgc2xvdHMsIGluc3RhbmNlKSA9PiB7CiAgICAgIGNvbnN0IGN0eCA9IHJhd1Nsb3RzLl9jdHg7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIHJhd1Nsb3RzKSB7CiAgICAgICAgICBpZiAoaXNJbnRlcm5hbEtleShrZXkpKQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgY29uc3QgdmFsdWUgPSByYXdTbG90c1trZXldOwogICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgc2xvdHNba2V5XSA9IG5vcm1hbGl6ZVNsb3Qoa2V5LCB2YWx1ZSwgY3R4KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgTm9uLWZ1bmN0aW9uIHZhbHVlIGVuY291bnRlcmVkIGZvciBzbG90ICIke2tleX0iLiBgICsKICAgICAgICAgICAgICAgICAgICAgIGBQcmVmZXIgZnVuY3Rpb24gc2xvdHMgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IG5vcm1hbGl6ZVNsb3RWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgc2xvdHNba2V5XSA9ICgpID0+IG5vcm1hbGl6ZWQ7CiAgICAgICAgICB9CiAgICAgIH0KICB9OwogIGNvbnN0IG5vcm1hbGl6ZVZOb2RlU2xvdHMgPSAoaW5zdGFuY2UsIGNoaWxkcmVuKSA9PiB7CiAgICAgIGlmICghaXNLZWVwQWxpdmUoaW5zdGFuY2Uudm5vZGUpICYmCiAgICAgICAgICAhKGZhbHNlICkpIHsKICAgICAgICAgIHdhcm4kMShgTm9uLWZ1bmN0aW9uIHZhbHVlIGVuY291bnRlcmVkIGZvciBkZWZhdWx0IHNsb3QuIGAgKwogICAgICAgICAgICAgIGBQcmVmZXIgZnVuY3Rpb24gc2xvdHMgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5gKTsKICAgICAgfQogICAgICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplU2xvdFZhbHVlKGNoaWxkcmVuKTsKICAgICAgaW5zdGFuY2Uuc2xvdHMuZGVmYXVsdCA9ICgpID0+IG5vcm1hbGl6ZWQ7CiAgfTsKICBjb25zdCBpbml0U2xvdHMgPSAoaW5zdGFuY2UsIGNoaWxkcmVuKSA9PiB7CiAgICAgIGlmIChpbnN0YW5jZS52bm9kZS5zaGFwZUZsYWcgJiAzMiAvKiBTTE9UU19DSElMRFJFTiAqLykgewogICAgICAgICAgY29uc3QgdHlwZSA9IGNoaWxkcmVuLl87CiAgICAgICAgICBpZiAodHlwZSkgewogICAgICAgICAgICAgIC8vIHVzZXJzIGNhbiBnZXQgdGhlIHNoYWxsb3cgcmVhZG9ubHkgdmVyc2lvbiBvZiB0aGUgc2xvdHMgb2JqZWN0IHRocm91Z2ggYHRoaXMuJHNsb3RzYCwKICAgICAgICAgICAgICAvLyB3ZSBzaG91bGQgYXZvaWQgdGhlIHByb3h5IG9iamVjdCBwb2xsdXRpbmcgdGhlIHNsb3RzIG9mIHRoZSBpbnRlcm5hbCBpbnN0YW5jZQogICAgICAgICAgICAgIGluc3RhbmNlLnNsb3RzID0gdG9SYXcoY2hpbGRyZW4pOwogICAgICAgICAgICAgIC8vIG1ha2UgY29tcGlsZXIgbWFya2VyIG5vbi1lbnVtZXJhYmxlCiAgICAgICAgICAgICAgZGVmKGNoaWxkcmVuLCAnXycsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgbm9ybWFsaXplT2JqZWN0U2xvdHMoY2hpbGRyZW4sIChpbnN0YW5jZS5zbG90cyA9IHt9KSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5zbG90cyA9IHt9OwogICAgICAgICAgaWYgKGNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgbm9ybWFsaXplVk5vZGVTbG90cyhpbnN0YW5jZSwgY2hpbGRyZW4pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGRlZihpbnN0YW5jZS5zbG90cywgSW50ZXJuYWxPYmplY3RLZXksIDEpOwogIH07CiAgY29uc3QgdXBkYXRlU2xvdHMgPSAoaW5zdGFuY2UsIGNoaWxkcmVuLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgY29uc3QgeyB2bm9kZSwgc2xvdHMgfSA9IGluc3RhbmNlOwogICAgICBsZXQgbmVlZERlbGV0aW9uQ2hlY2sgPSB0cnVlOwogICAgICBsZXQgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0gRU1QVFlfT0JKOwogICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMzIgLyogU0xPVFNfQ0hJTERSRU4gKi8pIHsKICAgICAgICAgIGNvbnN0IHR5cGUgPSBjaGlsZHJlbi5fOwogICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgICAvLyBjb21waWxlZCBzbG90cy4KICAgICAgICAgICAgICBpZiAoaXNIbXJVcGRhdGluZykgewogICAgICAgICAgICAgICAgICAvLyBQYXJlbnQgd2FzIEhNUiB1cGRhdGVkIHNvIHNsb3QgY29udGVudCBtYXkgaGF2ZSBjaGFuZ2VkLgogICAgICAgICAgICAgICAgICAvLyBmb3JjZSB1cGRhdGUgc2xvdHMgYW5kIG1hcmsgaW5zdGFuY2UgZm9yIGhtciBhcyB3ZWxsCiAgICAgICAgICAgICAgICAgIGV4dGVuZChzbG90cywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChvcHRpbWl6ZWQgJiYgdHlwZSA9PT0gMSAvKiBTVEFCTEUgKi8pIHsKICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZWQgQU5EIHN0YWJsZS4KICAgICAgICAgICAgICAgICAgLy8gbm8gbmVlZCB0byB1cGRhdGUsIGFuZCBza2lwIHN0YWxlIHNsb3RzIHJlbW92YWwuCiAgICAgICAgICAgICAgICAgIG5lZWREZWxldGlvbkNoZWNrID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBjb21waWxlZCBidXQgZHluYW1pYyAodi1pZi92LWZvciBvbiBzbG90cykgLSB1cGRhdGUgc2xvdHMsIGJ1dCBza2lwCiAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6YXRpb24uCiAgICAgICAgICAgICAgICAgIGV4dGVuZChzbG90cywgY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAvLyAjMjg5MwogICAgICAgICAgICAgICAgICAvLyB3aGVuIHJlbmRlcmluZyB0aGUgb3B0aW1pemVkIHNsb3RzIGJ5IG1hbnVhbGx5IHdyaXR0ZW4gcmVuZGVyIGZ1bmN0aW9uLAogICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGRlbGV0ZSB0aGUgYHNsb3RzLl9gIGZsYWcgaWYgbmVjZXNzYXJ5IHRvIG1ha2Ugc3Vic2VxdWVudCB1cGRhdGVzIHJlbGlhYmxlLAogICAgICAgICAgICAgICAgICAvLyBpLmUuIGxldCB0aGUgYHJlbmRlclNsb3RgIGNyZWF0ZSB0aGUgYmFpbGVkIEZyYWdtZW50CiAgICAgICAgICAgICAgICAgIGlmICghb3B0aW1pemVkICYmIHR5cGUgPT09IDEgLyogU1RBQkxFICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgc2xvdHMuXzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIG5lZWREZWxldGlvbkNoZWNrID0gIWNoaWxkcmVuLiRzdGFibGU7CiAgICAgICAgICAgICAgbm9ybWFsaXplT2JqZWN0U2xvdHMoY2hpbGRyZW4sIHNsb3RzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0aW9uQ29tcGFyaXNvblRhcmdldCA9IGNoaWxkcmVuOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGNoaWxkcmVuKSB7CiAgICAgICAgICAvLyBub24gc2xvdCBvYmplY3QgY2hpbGRyZW4gKGRpcmVjdCB2YWx1ZSkgcGFzc2VkIHRvIGEgY29tcG9uZW50CiAgICAgICAgICBub3JtYWxpemVWTm9kZVNsb3RzKGluc3RhbmNlLCBjaGlsZHJlbik7CiAgICAgICAgICBkZWxldGlvbkNvbXBhcmlzb25UYXJnZXQgPSB7IGRlZmF1bHQ6IDEgfTsKICAgICAgfQogICAgICAvLyBkZWxldGUgc3RhbGUgc2xvdHMKICAgICAgaWYgKG5lZWREZWxldGlvbkNoZWNrKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBzbG90cykgewogICAgICAgICAgICAgIGlmICghaXNJbnRlcm5hbEtleShrZXkpICYmICEoa2V5IGluIGRlbGV0aW9uQ29tcGFyaXNvblRhcmdldCkpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlIHNsb3RzW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgfTsKCiAgZnVuY3Rpb24gY3JlYXRlQXBwQ29udGV4dCgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIGFwcDogbnVsbCwKICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgIGlzTmF0aXZlVGFnOiBOTywKICAgICAgICAgICAgICBwZXJmb3JtYW5jZTogZmFsc2UsCiAgICAgICAgICAgICAgZ2xvYmFsUHJvcGVydGllczoge30sCiAgICAgICAgICAgICAgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzOiB7fSwKICAgICAgICAgICAgICBlcnJvckhhbmRsZXI6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICB3YXJuSGFuZGxlcjogdW5kZWZpbmVkLAogICAgICAgICAgICAgIGNvbXBpbGVyT3B0aW9uczoge30KICAgICAgICAgIH0sCiAgICAgICAgICBtaXhpbnM6IFtdLAogICAgICAgICAgY29tcG9uZW50czoge30sCiAgICAgICAgICBkaXJlY3RpdmVzOiB7fSwKICAgICAgICAgIHByb3ZpZGVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgICAgICAgb3B0aW9uc0NhY2hlOiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgcHJvcHNDYWNoZTogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgIGVtaXRzQ2FjaGU6IG5ldyBXZWFrTWFwKCkKICAgICAgfTsKICB9CiAgbGV0IHVpZCA9IDA7CiAgZnVuY3Rpb24gY3JlYXRlQXBwQVBJKHJlbmRlciwgaHlkcmF0ZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlQXBwKHJvb3RDb21wb25lbnQsIHJvb3RQcm9wcyA9IG51bGwpIHsKICAgICAgICAgIGlmICghaXNGdW5jdGlvbihyb290Q29tcG9uZW50KSkgewogICAgICAgICAgICAgIHJvb3RDb21wb25lbnQgPSBPYmplY3QuYXNzaWduKHt9LCByb290Q29tcG9uZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyb290UHJvcHMgIT0gbnVsbCAmJiAhaXNPYmplY3Qocm9vdFByb3BzKSkgewogICAgICAgICAgICAgIHdhcm4kMShgcm9vdCBwcm9wcyBwYXNzZWQgdG8gYXBwLm1vdW50KCkgbXVzdCBiZSBhbiBvYmplY3QuYCk7CiAgICAgICAgICAgICAgcm9vdFByb3BzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSBjcmVhdGVBcHBDb250ZXh0KCk7CiAgICAgICAgICBjb25zdCBpbnN0YWxsZWRQbHVnaW5zID0gbmV3IFNldCgpOwogICAgICAgICAgbGV0IGlzTW91bnRlZCA9IGZhbHNlOwogICAgICAgICAgY29uc3QgYXBwID0gKGNvbnRleHQuYXBwID0gewogICAgICAgICAgICAgIF91aWQ6IHVpZCsrLAogICAgICAgICAgICAgIF9jb21wb25lbnQ6IHJvb3RDb21wb25lbnQsCiAgICAgICAgICAgICAgX3Byb3BzOiByb290UHJvcHMsCiAgICAgICAgICAgICAgX2NvbnRhaW5lcjogbnVsbCwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dCwKICAgICAgICAgICAgICBfaW5zdGFuY2U6IG51bGwsCiAgICAgICAgICAgICAgdmVyc2lvbiwKICAgICAgICAgICAgICBnZXQgY29uZmlnKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5jb25maWc7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQgY29uZmlnKHYpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBhcHAuY29uZmlnIGNhbm5vdCBiZSByZXBsYWNlZC4gTW9kaWZ5IGluZGl2aWR1YWwgb3B0aW9ucyBpbnN0ZWFkLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1c2UocGx1Z2luLCAuLi5vcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpbnN0YWxsZWRQbHVnaW5zLmhhcyhwbHVnaW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYFBsdWdpbiBoYXMgYWxyZWFkeSBiZWVuIGFwcGxpZWQgdG8gdGFyZ2V0IGFwcC5gKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChwbHVnaW4gJiYgaXNGdW5jdGlvbihwbHVnaW4uaW5zdGFsbCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGluc3RhbGxlZFBsdWdpbnMuYWRkKHBsdWdpbik7CiAgICAgICAgICAgICAgICAgICAgICBwbHVnaW4uaW5zdGFsbChhcHAsIC4uLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24ocGx1Z2luKSkgewogICAgICAgICAgICAgICAgICAgICAgaW5zdGFsbGVkUGx1Z2lucy5hZGQocGx1Z2luKTsKICAgICAgICAgICAgICAgICAgICAgIHBsdWdpbihhcHAsIC4uLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBBIHBsdWdpbiBtdXN0IGVpdGhlciBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdCB3aXRoIGFuICJpbnN0YWxsIiBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1peGluKG1peGluKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghY29udGV4dC5taXhpbnMuaW5jbHVkZXMobWl4aW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5taXhpbnMucHVzaChtaXhpbik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoJ01peGluIGhhcyBhbHJlYWR5IGJlZW4gYXBwbGllZCB0byB0YXJnZXQgYXBwJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtaXhpbi5uYW1lID8gYDogJHttaXhpbi5uYW1lfWAgOiAnJykpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBhcHA7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjb21wb25lbnQobmFtZSwgY29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lLCBjb250ZXh0LmNvbmZpZyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LmNvbXBvbmVudHNbbmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQuY29tcG9uZW50c1tuYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBDb21wb25lbnQgIiR7bmFtZX0iIGhhcyBhbHJlYWR5IGJlZW4gcmVnaXN0ZXJlZCBpbiB0YXJnZXQgYXBwLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuY29tcG9uZW50c1tuYW1lXSA9IGNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpcmVjdGl2ZShuYW1lLCBkaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVEaXJlY3RpdmVOYW1lKG5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXJlY3RpdmVzW25hbWVdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LmRpcmVjdGl2ZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgRGlyZWN0aXZlICIke25hbWV9IiBoYXMgYWxyZWFkeSBiZWVuIHJlZ2lzdGVyZWQgaW4gdGFyZ2V0IGFwcC5gKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb250ZXh0LmRpcmVjdGl2ZXNbbmFtZV0gPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhcHA7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtb3VudChyb290Q29udGFpbmVyLCBpc0h5ZHJhdGUsIGlzU1ZHKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaXNNb3VudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyAjNTU3MQogICAgICAgICAgICAgICAgICAgICAgaWYgKHJvb3RDb250YWluZXIuX192dWVfYXBwX18pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYFRoZXJlIGlzIGFscmVhZHkgYW4gYXBwIGluc3RhbmNlIG1vdW50ZWQgb24gdGhlIGhvc3QgY29udGFpbmVyLlxuYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAgSWYgeW91IHdhbnQgdG8gbW91bnQgYW5vdGhlciBhcHAgb24gdGhlIHNhbWUgaG9zdCBjb250YWluZXIsYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAgeW91IG5lZWQgdG8gdW5tb3VudCB0aGUgcHJldmlvdXMgYXBwIGJ5IGNhbGxpbmcgXGBhcHAudW5tb3VudCgpXGAgZmlyc3QuYCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2bm9kZSA9IGNyZWF0ZVZOb2RlKHJvb3RDb21wb25lbnQsIHJvb3RQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBhcHAgY29udGV4dCBvbiB0aGUgcm9vdCBWTm9kZS4KICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBiZSBzZXQgb24gdGhlIHJvb3QgaW5zdGFuY2Ugb24gaW5pdGlhbCBtb3VudC4KICAgICAgICAgICAgICAgICAgICAgIHZub2RlLmFwcENvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgICAgICAgICAgICAgLy8gSE1SIHJvb3QgcmVsb2FkCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5yZWxvYWQgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcihjbG9uZVZOb2RlKHZub2RlKSwgcm9vdENvbnRhaW5lciwgaXNTVkcpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIeWRyYXRlICYmIGh5ZHJhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBoeWRyYXRlKHZub2RlLCByb290Q29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcih2bm9kZSwgcm9vdENvbnRhaW5lciwgaXNTVkcpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaXNNb3VudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGFwcC5fY29udGFpbmVyID0gcm9vdENvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgICAgIHJvb3RDb250YWluZXIuX192dWVfYXBwX18gPSBhcHA7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLl9pbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZ0b29sc0luaXRBcHAoYXBwLCB2ZXJzaW9uKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFeHBvc2VQcm94eSh2bm9kZS5jb21wb25lbnQpIHx8IHZub2RlLmNvbXBvbmVudC5wcm94eTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgQXBwIGhhcyBhbHJlYWR5IGJlZW4gbW91bnRlZC5cbmAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGBJZiB5b3Ugd2FudCB0byByZW1vdW50IHRoZSBzYW1lIGFwcCwgbW92ZSB5b3VyIGFwcCBjcmVhdGlvbiBsb2dpYyBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgaW50byBhIGZhY3RvcnkgZnVuY3Rpb24gYW5kIGNyZWF0ZSBmcmVzaCBhcHAgaW5zdGFuY2VzIGZvciBlYWNoIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGBtb3VudCAtIGUuZy4gXGBjb25zdCBjcmVhdGVNeUFwcCA9ICgpID0+IGNyZWF0ZUFwcChBcHApXGBgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdW5tb3VudCgpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzTW91bnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyKG51bGwsIGFwcC5fY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZ0b29sc1VubW91bnRBcHAoYXBwKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBhcHAuX2NvbnRhaW5lci5fX3Z1ZV9hcHBfXzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgQ2Fubm90IHVubW91bnQgYW4gYXBwIHRoYXQgaXMgbm90IG1vdW50ZWQuYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3ZpZGUoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICBpZiAoa2V5IGluIGNvbnRleHQucHJvdmlkZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgQXBwIGFscmVhZHkgcHJvdmlkZXMgcHJvcGVydHkgd2l0aCBrZXkgIiR7U3RyaW5nKGtleSl9Ii4gYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYEl0IHdpbGwgYmUgb3ZlcndyaXR0ZW4gd2l0aCB0aGUgbmV3IHZhbHVlLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnRleHQucHJvdmlkZXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gYXBwOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGFwcDsKICAgICAgfTsKICB9CgogIC8qKgogICAqIEZ1bmN0aW9uIGZvciBoYW5kbGluZyBhIHRlbXBsYXRlIHJlZgogICAqLwogIGZ1bmN0aW9uIHNldFJlZihyYXdSZWYsIG9sZFJhd1JlZiwgcGFyZW50U3VzcGVuc2UsIHZub2RlLCBpc1VubW91bnQgPSBmYWxzZSkgewogICAgICBpZiAoaXNBcnJheShyYXdSZWYpKSB7CiAgICAgICAgICByYXdSZWYuZm9yRWFjaCgociwgaSkgPT4gc2V0UmVmKHIsIG9sZFJhd1JlZiAmJiAoaXNBcnJheShvbGRSYXdSZWYpID8gb2xkUmF3UmVmW2ldIDogb2xkUmF3UmVmKSwgcGFyZW50U3VzcGVuc2UsIHZub2RlLCBpc1VubW91bnQpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaXNBc3luY1dyYXBwZXIodm5vZGUpICYmICFpc1VubW91bnQpIHsKICAgICAgICAgIC8vIHdoZW4gbW91bnRpbmcgYXN5bmMgY29tcG9uZW50cywgbm90aGluZyBuZWVkcyB0byBiZSBkb25lLAogICAgICAgICAgLy8gYmVjYXVzZSB0aGUgdGVtcGxhdGUgcmVmIGlzIGZvcndhcmRlZCB0byBpbm5lciBjb21wb25lbnQKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCByZWZWYWx1ZSA9IHZub2RlLnNoYXBlRmxhZyAmIDQgLyogU1RBVEVGVUxfQ09NUE9ORU5UICovCiAgICAgICAgICA/IGdldEV4cG9zZVByb3h5KHZub2RlLmNvbXBvbmVudCkgfHwgdm5vZGUuY29tcG9uZW50LnByb3h5CiAgICAgICAgICA6IHZub2RlLmVsOwogICAgICBjb25zdCB2YWx1ZSA9IGlzVW5tb3VudCA/IG51bGwgOiByZWZWYWx1ZTsKICAgICAgY29uc3QgeyBpOiBvd25lciwgcjogcmVmIH0gPSByYXdSZWY7CiAgICAgIGlmICghb3duZXIpIHsKICAgICAgICAgIHdhcm4kMShgTWlzc2luZyByZWYgb3duZXIgY29udGV4dC4gcmVmIGNhbm5vdCBiZSB1c2VkIG9uIGhvaXN0ZWQgdm5vZGVzLiBgICsKICAgICAgICAgICAgICBgQSB2bm9kZSB3aXRoIHJlZiBtdXN0IGJlIGNyZWF0ZWQgaW5zaWRlIHRoZSByZW5kZXIgZnVuY3Rpb24uYCk7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3Qgb2xkUmVmID0gb2xkUmF3UmVmICYmIG9sZFJhd1JlZi5yOwogICAgICBjb25zdCByZWZzID0gb3duZXIucmVmcyA9PT0gRU1QVFlfT0JKID8gKG93bmVyLnJlZnMgPSB7fSkgOiBvd25lci5yZWZzOwogICAgICBjb25zdCBzZXR1cFN0YXRlID0gb3duZXIuc2V0dXBTdGF0ZTsKICAgICAgLy8gZHluYW1pYyByZWYgY2hhbmdlZC4gdW5zZXQgb2xkIHJlZgogICAgICBpZiAob2xkUmVmICE9IG51bGwgJiYgb2xkUmVmICE9PSByZWYpIHsKICAgICAgICAgIGlmIChpc1N0cmluZyhvbGRSZWYpKSB7CiAgICAgICAgICAgICAgcmVmc1tvbGRSZWZdID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoaGFzT3duKHNldHVwU3RhdGUsIG9sZFJlZikpIHsKICAgICAgICAgICAgICAgICAgc2V0dXBTdGF0ZVtvbGRSZWZdID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc1JlZihvbGRSZWYpKSB7CiAgICAgICAgICAgICAgb2xkUmVmLnZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNGdW5jdGlvbihyZWYpKSB7CiAgICAgICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcocmVmLCBvd25lciwgMTIgLyogRlVOQ1RJT05fUkVGICovLCBbdmFsdWUsIHJlZnNdKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IF9pc1N0cmluZyA9IGlzU3RyaW5nKHJlZik7CiAgICAgICAgICBjb25zdCBfaXNSZWYgPSBpc1JlZihyZWYpOwogICAgICAgICAgaWYgKF9pc1N0cmluZyB8fCBfaXNSZWYpIHsKICAgICAgICAgICAgICBjb25zdCBkb1NldCA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1JlZi5mKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IF9pc1N0cmluZyA/IHJlZnNbcmVmXSA6IHJlZi52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1VubW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5KGV4aXN0aW5nKSAmJiByZW1vdmUoZXhpc3RpbmcsIHJlZlZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShleGlzdGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9pc1N0cmluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmc1tyZWZdID0gW3JlZlZhbHVlXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24oc2V0dXBTdGF0ZSwgcmVmKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHVwU3RhdGVbcmVmXSA9IHJlZnNbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZi52YWx1ZSA9IFtyZWZWYWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmF3UmVmLmspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmc1tyYXdSZWYua10gPSByZWYudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoIWV4aXN0aW5nLmluY2x1ZGVzKHJlZlZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5wdXNoKHJlZlZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoX2lzU3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWZzW3JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd24oc2V0dXBTdGF0ZSwgcmVmKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNldHVwU3RhdGVbcmVmXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzUmVmKHJlZikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlZi52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHJhd1JlZi5rKQogICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnNbcmF3UmVmLmtdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoJ0ludmFsaWQgdGVtcGxhdGUgcmVmIHR5cGU6JywgcmVmLCBgKCR7dHlwZW9mIHJlZn0pYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICBkb1NldC5pZCA9IC0xOwogICAgICAgICAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoZG9TZXQsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRvU2V0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgd2FybiQxKCdJbnZhbGlkIHRlbXBsYXRlIHJlZiB0eXBlOicsIHJlZiwgYCgke3R5cGVvZiByZWZ9KWApOwogICAgICAgICAgfQogICAgICB9CiAgfQoKICBsZXQgaGFzTWlzbWF0Y2ggPSBmYWxzZTsKICBjb25zdCBpc1NWR0NvbnRhaW5lciA9IChjb250YWluZXIpID0+IC9zdmcvLnRlc3QoY29udGFpbmVyLm5hbWVzcGFjZVVSSSkgJiYgY29udGFpbmVyLnRhZ05hbWUgIT09ICdmb3JlaWduT2JqZWN0JzsKICBjb25zdCBpc0NvbW1lbnQgPSAobm9kZSkgPT4gbm9kZS5ub2RlVHlwZSA9PT0gOCAvKiBDT01NRU5UICovOwogIC8vIE5vdGU6IGh5ZHJhdGlvbiBpcyBET00tc3BlY2lmaWMKICAvLyBCdXQgd2UgaGF2ZSB0byBwbGFjZSBpdCBpbiBjb3JlIGR1ZSB0byB0aWdodCBjb3VwbGluZyB3aXRoIGNvcmUgLSBzcGxpdHRpbmcKICAvLyBpdCBvdXQgY3JlYXRlcyBhIHRvbiBvZiB1bm5lY2Vzc2FyeSBjb21wbGV4aXR5LgogIC8vIEh5ZHJhdGlvbiBhbHNvIGRlcGVuZHMgb24gc29tZSByZW5kZXJlciBpbnRlcm5hbCBsb2dpYyB3aGljaCBuZWVkcyB0byBiZQogIC8vIHBhc3NlZCBpbiB2aWEgYXJndW1lbnRzLgogIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvbkZ1bmN0aW9ucyhyZW5kZXJlckludGVybmFscykgewogICAgICBjb25zdCB7IG10OiBtb3VudENvbXBvbmVudCwgcDogcGF0Y2gsIG86IHsgcGF0Y2hQcm9wLCBjcmVhdGVUZXh0LCBuZXh0U2libGluZywgcGFyZW50Tm9kZSwgcmVtb3ZlLCBpbnNlcnQsIGNyZWF0ZUNvbW1lbnQgfSB9ID0gcmVuZGVyZXJJbnRlcm5hbHM7CiAgICAgIGNvbnN0IGh5ZHJhdGUgPSAodm5vZGUsIGNvbnRhaW5lcikgPT4gewogICAgICAgICAgaWYgKCFjb250YWluZXIuaGFzQ2hpbGROb2RlcygpKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBBdHRlbXB0aW5nIHRvIGh5ZHJhdGUgZXhpc3RpbmcgbWFya3VwIGJ1dCBjb250YWluZXIgaXMgZW1wdHkuIGAgKwogICAgICAgICAgICAgICAgICAgICAgYFBlcmZvcm1pbmcgZnVsbCBtb3VudCBpbnN0ZWFkLmApOwogICAgICAgICAgICAgIHBhdGNoKG51bGwsIHZub2RlLCBjb250YWluZXIpOwogICAgICAgICAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaGFzTWlzbWF0Y2ggPSBmYWxzZTsKICAgICAgICAgIGh5ZHJhdGVOb2RlKGNvbnRhaW5lci5maXJzdENoaWxkLCB2bm9kZSwgbnVsbCwgbnVsbCwgbnVsbCk7CiAgICAgICAgICBmbHVzaFBvc3RGbHVzaENicygpOwogICAgICAgICAgaWYgKGhhc01pc21hdGNoICYmICFmYWxzZSkgewogICAgICAgICAgICAgIC8vIHRoaXMgZXJyb3Igc2hvdWxkIHNob3cgdXAgaW4gcHJvZHVjdGlvbgogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEh5ZHJhdGlvbiBjb21wbGV0ZWQgYnV0IGNvbnRhaW5zIG1pc21hdGNoZXMuYCk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IGh5ZHJhdGVOb2RlID0gKG5vZGUsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCA9IGZhbHNlKSA9PiB7CiAgICAgICAgICBjb25zdCBpc0ZyYWdtZW50U3RhcnQgPSBpc0NvbW1lbnQobm9kZSkgJiYgbm9kZS5kYXRhID09PSAnWyc7CiAgICAgICAgICBjb25zdCBvbk1pc21hdGNoID0gKCkgPT4gaGFuZGxlTWlzbWF0Y2gobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgaXNGcmFnbWVudFN0YXJ0KTsKICAgICAgICAgIGNvbnN0IHsgdHlwZSwgcmVmLCBzaGFwZUZsYWcsIHBhdGNoRmxhZyB9ID0gdm5vZGU7CiAgICAgICAgICBjb25zdCBkb21UeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgIHZub2RlLmVsID0gbm9kZTsKICAgICAgICAgIGlmIChwYXRjaEZsYWcgPT09IC0yIC8qIEJBSUwgKi8pIHsKICAgICAgICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2bm9kZS5keW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgbGV0IG5leHROb2RlID0gbnVsbDsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgVGV4dDoKICAgICAgICAgICAgICAgICAgaWYgKGRvbVR5cGUgIT09IDMgLyogVEVYVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgLy8gIzU3MjggZW1wdHkgdGV4dCBub2RlIGluc2lkZSBhIHNsb3QgY2FuIGNhdXNlIGh5ZHJhdGlvbiBmYWlsdXJlCiAgICAgICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgSFRNTCB3b24ndCBjb250YWluIGEgdGV4dCBub2RlCiAgICAgICAgICAgICAgICAgICAgICBpZiAodm5vZGUuY2hpbGRyZW4gPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0KCh2bm9kZS5lbCA9IGNyZWF0ZVRleHQoJycpKSwgcGFyZW50Tm9kZShub2RlKSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5kYXRhICE9PSB2bm9kZS5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEh5ZHJhdGlvbiB0ZXh0IG1pc21hdGNoOmAgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYFxuLSBDbGllbnQ6ICR7SlNPTi5zdHJpbmdpZnkobm9kZS5kYXRhKX1gICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBcbi0gU2VydmVyOiAke0pTT04uc3RyaW5naWZ5KHZub2RlLmNoaWxkcmVuKX1gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSB2bm9kZS5jaGlsZHJlbjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDb21tZW50OgogICAgICAgICAgICAgICAgICBpZiAoZG9tVHlwZSAhPT0gOCAvKiBDT01NRU5UICovIHx8IGlzRnJhZ21lbnRTdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgU3RhdGljOgogICAgICAgICAgICAgICAgICBpZiAoZG9tVHlwZSAhPT0gMSAvKiBFTEVNRU5UICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBhbmNob3IsIGFkb3B0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzdGF0aWMgdm5vZGUgaGFzIGl0cyBjb250ZW50IHN0cmlwcGVkIGR1cmluZyBidWlsZCwKICAgICAgICAgICAgICAgICAgICAgIC8vIGFkb3B0IGl0IGZyb20gdGhlIHNlcnZlci1yZW5kZXJlZCBIVE1MLgogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmVlZFRvQWRvcHRDb250ZW50ID0gIXZub2RlLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdm5vZGUuc3RhdGljQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZWVkVG9BZG9wdENvbnRlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZub2RlLmNoaWxkcmVuICs9IG5leHROb2RlLm91dGVySFRNTDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PT0gdm5vZGUuc3RhdGljQ291bnQgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZub2RlLmFuY2hvciA9IG5leHROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHRTaWJsaW5nKG5leHROb2RlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0Tm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgICAgICBpZiAoIWlzRnJhZ21lbnRTdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IGh5ZHJhdGVGcmFnbWVudChub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAxIC8qIEVMRU1FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21UeXBlICE9PSAxIC8qIEVMRU1FTlQgKi8gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICB2bm9kZS50eXBlLnRvTG93ZXJDYXNlKCkgIT09CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IGh5ZHJhdGVFbGVtZW50KG5vZGUsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGVGbGFnICYgNiAvKiBDT01QT05FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gc2V0dGluZyB1cCB0aGUgcmVuZGVyIGVmZmVjdCwgaWYgdGhlIGluaXRpYWwgdm5vZGUgYWxyZWFkeQogICAgICAgICAgICAgICAgICAgICAgLy8gaGFzIC5lbCBzZXQsIHRoZSBjb21wb25lbnQgd2lsbCBwZXJmb3JtIGh5ZHJhdGlvbiBpbnN0ZWFkIG9mIG1vdW50CiAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBpdHMgc3ViLXRyZWUuCiAgICAgICAgICAgICAgICAgICAgICB2bm9kZS5zbG90U2NvcGVJZHMgPSBzbG90U2NvcGVJZHM7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBwYXJlbnROb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgbW91bnRDb21wb25lbnQodm5vZGUsIGNvbnRhaW5lciwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkdDb250YWluZXIoY29udGFpbmVyKSwgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBvbmVudCBtYXkgYmUgYXN5bmMsIHNvIGluIHRoZSBjYXNlIG9mIGZyYWdtZW50cyB3ZSBjYW5ub3QgcmVseQogICAgICAgICAgICAgICAgICAgICAgLy8gb24gY29tcG9uZW50J3MgcmVuZGVyZWQgb3V0cHV0IHRvIGRldGVybWluZSB0aGUgZW5kIG9mIHRoZSBmcmFnbWVudAogICAgICAgICAgICAgICAgICAgICAgLy8gaW5zdGVhZCwgd2UgZG8gYSBsb29rYWhlYWQgdG8gZmluZCB0aGUgZW5kIGFuY2hvciBub2RlLgogICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBpc0ZyYWdtZW50U3RhcnQKICAgICAgICAgICAgICAgICAgICAgICAgICA/IGxvY2F0ZUNsb3NpbmdBc3luY0FuY2hvcihub2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgIDogbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAvLyAjNDI5MyB0ZWxlcG9ydCBhcyBjb21wb25lbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHROb2RlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgaXNDb21tZW50KG5leHROb2RlKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlLmRhdGEgPT09ICd0ZWxlcG9ydCBlbmQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAvLyAjMzc4NwogICAgICAgICAgICAgICAgICAgICAgLy8gaWYgY29tcG9uZW50IGlzIGFzeW5jLCBpdCBtYXkgZ2V0IG1vdmVkIC8gdW5tb3VudGVkIGJlZm9yZSBpdHMKICAgICAgICAgICAgICAgICAgICAgIC8vIGlubmVyIGNvbXBvbmVudCBpcyBsb2FkZWQsIHNvIHdlIG5lZWQgdG8gZ2l2ZSBpdCBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAvLyB2bm9kZSB0aGF0IG1hdGNoZXMgaXRzIGFkb3B0ZWQgRE9NLgogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXN5bmNXcmFwcGVyKHZub2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdWJUcmVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0ZyYWdtZW50U3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViVHJlZSA9IGNyZWF0ZVZOb2RlKEZyYWdtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViVHJlZS5hbmNob3IgPSBuZXh0Tm9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBuZXh0Tm9kZS5wcmV2aW91c1NpYmxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogY29udGFpbmVyLmxhc3RDaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlRyZWUgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5ub2RlVHlwZSA9PT0gMyA/IGNyZWF0ZVRleHRWTm9kZSgnJykgOiBjcmVhdGVWTm9kZSgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlRyZWUuZWwgPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZub2RlLmNvbXBvbmVudC5zdWJUcmVlID0gc3ViVHJlZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzaGFwZUZsYWcgJiA2NCAvKiBURUxFUE9SVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVR5cGUgIT09IDggLyogQ09NTUVOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gb25NaXNtYXRjaCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSB2bm9kZS50eXBlLmh5ZHJhdGUobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgaHlkcmF0ZUNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzaGFwZUZsYWcgJiAxMjggLyogU1VTUEVOU0UgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gdm5vZGUudHlwZS5oeWRyYXRlKG5vZGUsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWR0NvbnRhaW5lcihwYXJlbnROb2RlKG5vZGUpKSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHJlbmRlcmVySW50ZXJuYWxzLCBoeWRyYXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoJ0ludmFsaWQgSG9zdFZOb2RlIHR5cGU6JywgdHlwZSwgYCgke3R5cGVvZiB0eXBlfSlgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlZiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0UmVmKHJlZiwgbnVsbCwgcGFyZW50U3VzcGVuc2UsIHZub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0Tm9kZTsKICAgICAgfTsKICAgICAgY29uc3QgaHlkcmF0ZUVsZW1lbnQgPSAoZWwsIHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgb3B0aW1pemVkID0gb3B0aW1pemVkIHx8ICEhdm5vZGUuZHluYW1pY0NoaWxkcmVuOwogICAgICAgICAgY29uc3QgeyB0eXBlLCBwcm9wcywgcGF0Y2hGbGFnLCBzaGFwZUZsYWcsIGRpcnMgfSA9IHZub2RlOwogICAgICAgICAgLy8gIzQwMDYgZm9yIGZvcm0gZWxlbWVudHMgd2l0aCBub24tc3RyaW5nIHYtbW9kZWwgdmFsdWUgYmluZGluZ3MKICAgICAgICAgIC8vIGUuZy4gPG9wdGlvbiA6dmFsdWU9Im9iaiI+LCA8aW5wdXQgdHlwZT0iY2hlY2tib3giIDp0cnVlLXZhbHVlPSIxIj4KICAgICAgICAgIGNvbnN0IGZvcmNlUGF0Y2hWYWx1ZSA9ICh0eXBlID09PSAnaW5wdXQnICYmIGRpcnMpIHx8IHR5cGUgPT09ICdvcHRpb24nOwogICAgICAgICAgLy8gc2tpcCBwcm9wcyAmIGNoaWxkcmVuIGlmIHRoaXMgaXMgaG9pc3RlZCBzdGF0aWMgbm9kZXMKICAgICAgICAgIC8vICM1NDA1IGluIGRldiwgYWx3YXlzIGh5ZHJhdGUgY2hpbGRyZW4gZm9yIEhNUgogICAgICAgICAgewogICAgICAgICAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ2NyZWF0ZWQnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gcHJvcHMKICAgICAgICAgICAgICBpZiAocHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZvcmNlUGF0Y2hWYWx1ZSB8fAogICAgICAgICAgICAgICAgICAgICAgIW9wdGltaXplZCB8fAogICAgICAgICAgICAgICAgICAgICAgcGF0Y2hGbGFnICYgKDE2IC8qIEZVTExfUFJPUFMgKi8gfCAzMiAvKiBIWURSQVRFX0VWRU5UUyAqLykpIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChmb3JjZVBhdGNoVmFsdWUgJiYga2V5LmVuZHNXaXRoKCd2YWx1ZScpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaXNPbihrZXkpICYmICFpc1Jlc2VydmVkUHJvcChrZXkpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRjaFByb3AoZWwsIGtleSwgbnVsbCwgcHJvcHNba2V5XSwgZmFsc2UsIHVuZGVmaW5lZCwgcGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcHMub25DbGljaykgewogICAgICAgICAgICAgICAgICAgICAgLy8gRmFzdCBwYXRoIGZvciBjbGljayBsaXN0ZW5lcnMgKHdoaWNoIGlzIG1vc3Qgb2Z0ZW4pIHRvIGF2b2lkCiAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVyYXRpbmcgdGhyb3VnaCBwcm9wcy4KICAgICAgICAgICAgICAgICAgICAgIHBhdGNoUHJvcChlbCwgJ29uQ2xpY2snLCBudWxsLCBwcm9wcy5vbkNsaWNrLCBmYWxzZSwgdW5kZWZpbmVkLCBwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHZub2RlIC8gZGlyZWN0aXZlIGhvb2tzCiAgICAgICAgICAgICAgbGV0IHZub2RlSG9va3M7CiAgICAgICAgICAgICAgaWYgKCh2bm9kZUhvb2tzID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZUJlZm9yZU1vdW50KSkgewogICAgICAgICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rcywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ2JlZm9yZU1vdW50Jyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgodm5vZGVIb29rcyA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVNb3VudGVkKSB8fCBkaXJzKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlRWZmZWN0V2l0aFN1c3BlbnNlKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHZub2RlSG9va3MgJiYgaW52b2tlVk5vZGVIb29rKHZub2RlSG9va3MsIHBhcmVudENvbXBvbmVudCwgdm5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICdtb3VudGVkJyk7CiAgICAgICAgICAgICAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gY2hpbGRyZW4KICAgICAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTYgLyogQVJSQVlfQ0hJTERSRU4gKi8gJiYKICAgICAgICAgICAgICAgICAgLy8gc2tpcCBpZiBlbGVtZW50IGhhcyBpbm5lckhUTUwgLyB0ZXh0Q29udGVudAogICAgICAgICAgICAgICAgICAhKHByb3BzICYmIChwcm9wcy5pbm5lckhUTUwgfHwgcHJvcHMudGV4dENvbnRlbnQpKSkgewogICAgICAgICAgICAgICAgICBsZXQgbmV4dCA9IGh5ZHJhdGVDaGlsZHJlbihlbC5maXJzdENoaWxkLCB2bm9kZSwgZWwsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgbGV0IGhhc1dhcm5lZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB3aGlsZSAobmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgaGFzTWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYEh5ZHJhdGlvbiBjaGlsZHJlbiBtaXNtYXRjaCBpbiA8JHt2bm9kZS50eXBlfT46IGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgc2VydmVyIHJlbmRlcmVkIGVsZW1lbnQgY29udGFpbnMgbW9yZSBjaGlsZCBub2RlcyB0aGFuIGNsaWVudCB2ZG9tLmApOwogICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgU1NSZWQgRE9NIGNvbnRhaW5zIG1vcmUgbm9kZXMgdGhhbiBpdCBzaG91bGQuIFJlbW92ZSB0aGVtLgogICAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VyID0gbmV4dDsKICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlKGN1cik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoc2hhcGVGbGFnICYgOCAvKiBURVhUX0NISUxEUkVOICovKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlbC50ZXh0Q29udGVudCAhPT0gdm5vZGUuY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgSHlkcmF0aW9uIHRleHQgY29udGVudCBtaXNtYXRjaCBpbiA8JHt2bm9kZS50eXBlfT46XG5gICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYC0gQ2xpZW50OiAke2VsLnRleHRDb250ZW50fVxuYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAtIFNlcnZlcjogJHt2bm9kZS5jaGlsZHJlbn1gKTsKICAgICAgICAgICAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gdm5vZGUuY2hpbGRyZW47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWwubmV4dFNpYmxpbmc7CiAgICAgIH07CiAgICAgIGNvbnN0IGh5ZHJhdGVDaGlsZHJlbiA9IChub2RlLCBwYXJlbnRWTm9kZSwgY29udGFpbmVyLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgb3B0aW1pemVkID0gb3B0aW1pemVkIHx8ICEhcGFyZW50Vk5vZGUuZHluYW1pY0NoaWxkcmVuOwogICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBwYXJlbnRWTm9kZS5jaGlsZHJlbjsKICAgICAgICAgIGNvbnN0IGwgPSBjaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgICBsZXQgaGFzV2FybmVkID0gZmFsc2U7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IHZub2RlID0gb3B0aW1pemVkCiAgICAgICAgICAgICAgICAgID8gY2hpbGRyZW5baV0KICAgICAgICAgICAgICAgICAgOiAoY2hpbGRyZW5baV0gPSBub3JtYWxpemVWTm9kZShjaGlsZHJlbltpXSkpOwogICAgICAgICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBoeWRyYXRlTm9kZShub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICh2bm9kZS50eXBlID09PSBUZXh0ICYmICF2bm9kZS5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMShgSHlkcmF0aW9uIGNoaWxkcmVuIG1pc21hdGNoIGluIDwke2NvbnRhaW5lci50YWdOYW1lLnRvTG93ZXJDYXNlKCl9PjogYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYHNlcnZlciByZW5kZXJlZCBlbGVtZW50IGNvbnRhaW5zIGZld2VyIGNoaWxkIG5vZGVzIHRoYW4gY2xpZW50IHZkb20uYCk7CiAgICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIHRoZSBTU1JlZCBET00gZGlkbid0IGNvbnRhaW4gZW5vdWdoIG5vZGVzLiBNb3VudCB0aGUgbWlzc2luZyBvbmVzLgogICAgICAgICAgICAgICAgICBwYXRjaChudWxsLCB2bm9kZSwgY29udGFpbmVyLCBudWxsLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWR0NvbnRhaW5lcihjb250YWluZXIpLCBzbG90U2NvcGVJZHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9OwogICAgICBjb25zdCBoeWRyYXRlRnJhZ21lbnQgPSAobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgICAgICBjb25zdCB7IHNsb3RTY29wZUlkczogZnJhZ21lbnRTbG90U2NvcGVJZHMgfSA9IHZub2RlOwogICAgICAgICAgaWYgKGZyYWdtZW50U2xvdFNjb3BlSWRzKSB7CiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzCiAgICAgICAgICAgICAgICAgID8gc2xvdFNjb3BlSWRzLmNvbmNhdChmcmFnbWVudFNsb3RTY29wZUlkcykKICAgICAgICAgICAgICAgICAgOiBmcmFnbWVudFNsb3RTY29wZUlkczsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHBhcmVudE5vZGUobm9kZSk7CiAgICAgICAgICBjb25zdCBuZXh0ID0gaHlkcmF0ZUNoaWxkcmVuKG5leHRTaWJsaW5nKG5vZGUpLCB2bm9kZSwgY29udGFpbmVyLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICBpZiAobmV4dCAmJiBpc0NvbW1lbnQobmV4dCkgJiYgbmV4dC5kYXRhID09PSAnXScpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV4dFNpYmxpbmcoKHZub2RlLmFuY2hvciA9IG5leHQpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIGZyYWdtZW50IGRpZG4ndCBoeWRyYXRlIHN1Y2Nlc3NmdWxseSwgc2luY2Ugd2UgZGlkbid0IGdldCBhIGVuZCBhbmNob3IKICAgICAgICAgICAgICAvLyBiYWNrLiBUaGlzIHNob3VsZCBoYXZlIGxlZCB0byBub2RlL2NoaWxkcmVuIG1pc21hdGNoIHdhcm5pbmdzLgogICAgICAgICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICAvLyBzaW5jZSB0aGUgYW5jaG9yIGlzIG1pc3NpbmcsIHdlIG5lZWQgdG8gY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IGl0CiAgICAgICAgICAgICAgaW5zZXJ0KCh2bm9kZS5hbmNob3IgPSBjcmVhdGVDb21tZW50KGBdYCkpLCBjb250YWluZXIsIG5leHQpOwogICAgICAgICAgICAgIHJldHVybiBuZXh0OwogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBoYW5kbGVNaXNtYXRjaCA9IChub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBpc0ZyYWdtZW50KSA9PiB7CiAgICAgICAgICBoYXNNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgICB3YXJuJDEoYEh5ZHJhdGlvbiBub2RlIG1pc21hdGNoOlxuLSBDbGllbnQgdm5vZGU6YCwgdm5vZGUudHlwZSwgYFxuLSBTZXJ2ZXIgcmVuZGVyZWQgRE9NOmAsIG5vZGUsIG5vZGUubm9kZVR5cGUgPT09IDMgLyogVEVYVCAqLwogICAgICAgICAgICAgICAgICA/IGAodGV4dClgCiAgICAgICAgICAgICAgICAgIDogaXNDb21tZW50KG5vZGUpICYmIG5vZGUuZGF0YSA9PT0gJ1snCiAgICAgICAgICAgICAgICAgICAgICA/IGAoc3RhcnQgb2YgZnJhZ21lbnQpYAogICAgICAgICAgICAgICAgICAgICAgOiBgYCk7CiAgICAgICAgICB2bm9kZS5lbCA9IG51bGw7CiAgICAgICAgICBpZiAoaXNGcmFnbWVudCkgewogICAgICAgICAgICAgIC8vIHJlbW92ZSBleGNlc3NpdmUgZnJhZ21lbnQgbm9kZXMKICAgICAgICAgICAgICBjb25zdCBlbmQgPSBsb2NhdGVDbG9zaW5nQXN5bmNBbmNob3Iobm9kZSk7CiAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dCA9IG5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBuZXh0ICE9PSBlbmQpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZShuZXh0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgbmV4dCA9IG5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgICAgY29uc3QgY29udGFpbmVyID0gcGFyZW50Tm9kZShub2RlKTsKICAgICAgICAgIHJlbW92ZShub2RlKTsKICAgICAgICAgIHBhdGNoKG51bGwsIHZub2RlLCBjb250YWluZXIsIG5leHQsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHQ29udGFpbmVyKGNvbnRhaW5lciksIHNsb3RTY29wZUlkcyk7CiAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgfTsKICAgICAgY29uc3QgbG9jYXRlQ2xvc2luZ0FzeW5jQW5jaG9yID0gKG5vZGUpID0+IHsKICAgICAgICAgIGxldCBtYXRjaCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgIG5vZGUgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgICAgICBpZiAobm9kZSAmJiBpc0NvbW1lbnQobm9kZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gJ1snKQogICAgICAgICAgICAgICAgICAgICAgbWF0Y2grKzsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gJ10nKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaC0tOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH07CiAgICAgIHJldHVybiBbaHlkcmF0ZSwgaHlkcmF0ZU5vZGVdOwogIH0KCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzICovCiAgbGV0IHN1cHBvcnRlZDsKICBsZXQgcGVyZjsKICBmdW5jdGlvbiBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIHR5cGUpIHsKICAgICAgaWYgKGluc3RhbmNlLmFwcENvbnRleHQuY29uZmlnLnBlcmZvcm1hbmNlICYmIGlzU3VwcG9ydGVkKCkpIHsKICAgICAgICAgIHBlcmYubWFyayhgdnVlLSR7dHlwZX0tJHtpbnN0YW5jZS51aWR9YCk7CiAgICAgIH0KICAgICAgewogICAgICAgICAgZGV2dG9vbHNQZXJmU3RhcnQoaW5zdGFuY2UsIHR5cGUsIGlzU3VwcG9ydGVkKCkgPyBwZXJmLm5vdygpIDogRGF0ZS5ub3coKSk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZW5kTWVhc3VyZShpbnN0YW5jZSwgdHlwZSkgewogICAgICBpZiAoaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcucGVyZm9ybWFuY2UgJiYgaXNTdXBwb3J0ZWQoKSkgewogICAgICAgICAgY29uc3Qgc3RhcnRUYWcgPSBgdnVlLSR7dHlwZX0tJHtpbnN0YW5jZS51aWR9YDsKICAgICAgICAgIGNvbnN0IGVuZFRhZyA9IHN0YXJ0VGFnICsgYDplbmRgOwogICAgICAgICAgcGVyZi5tYXJrKGVuZFRhZyk7CiAgICAgICAgICBwZXJmLm1lYXN1cmUoYDwke2Zvcm1hdENvbXBvbmVudE5hbWUoaW5zdGFuY2UsIGluc3RhbmNlLnR5cGUpfT4gJHt0eXBlfWAsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgICAgICAgcGVyZi5jbGVhck1hcmtzKHN0YXJ0VGFnKTsKICAgICAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOwogICAgICB9CiAgICAgIHsKICAgICAgICAgIGRldnRvb2xzUGVyZkVuZChpbnN0YW5jZSwgdHlwZSwgaXNTdXBwb3J0ZWQoKSA/IHBlcmYubm93KCkgOiBEYXRlLm5vdygpKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBpc1N1cHBvcnRlZCgpIHsKICAgICAgaWYgKHN1cHBvcnRlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydGVkOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cucGVyZm9ybWFuY2UpIHsKICAgICAgICAgIHN1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICBwZXJmID0gd2luZG93LnBlcmZvcm1hbmNlOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgc3VwcG9ydGVkID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHN1cHBvcnRlZDsKICB9CgogIGNvbnN0IHF1ZXVlUG9zdFJlbmRlckVmZmVjdCA9IHF1ZXVlRWZmZWN0V2l0aFN1c3BlbnNlCiAgICAgIDsKICAvKioKICAgKiBUaGUgY3JlYXRlUmVuZGVyZXIgZnVuY3Rpb24gYWNjZXB0cyB0d28gZ2VuZXJpYyBhcmd1bWVudHM6CiAgICogSG9zdE5vZGUgYW5kIEhvc3RFbGVtZW50LCBjb3JyZXNwb25kaW5nIHRvIE5vZGUgYW5kIEVsZW1lbnQgdHlwZXMgaW4gdGhlCiAgICogaG9zdCBlbnZpcm9ubWVudC4gRm9yIGV4YW1wbGUsIGZvciBydW50aW1lLWRvbSwgSG9zdE5vZGUgd291bGQgYmUgdGhlIERPTQogICAqIGBOb2RlYCBpbnRlcmZhY2UgYW5kIEhvc3RFbGVtZW50IHdvdWxkIGJlIHRoZSBET00gYEVsZW1lbnRgIGludGVyZmFjZS4KICAgKgogICAqIEN1c3RvbSByZW5kZXJlcnMgY2FuIHBhc3MgaW4gdGhlIHBsYXRmb3JtIHNwZWNpZmljIHR5cGVzIGxpa2UgdGhpczoKICAgKgogICAqIGBgYCBqcwogICAqIGNvbnN0IHsgcmVuZGVyLCBjcmVhdGVBcHAgfSA9IGNyZWF0ZVJlbmRlcmVyPE5vZGUsIEVsZW1lbnQ+KHsKICAgKiAgIHBhdGNoUHJvcCwKICAgKiAgIC4uLm5vZGVPcHMKICAgKiB9KQogICAqIGBgYAogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZVJlbmRlcmVyKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zKTsKICB9CiAgLy8gU2VwYXJhdGUgQVBJIGZvciBjcmVhdGluZyBoeWRyYXRpb24tZW5hYmxlZCByZW5kZXJlci4KICAvLyBIeWRyYXRpb24gbG9naWMgaXMgb25seSB1c2VkIHdoZW4gY2FsbGluZyB0aGlzIGZ1bmN0aW9uLCBtYWtpbmcgaXQKICAvLyB0cmVlLXNoYWthYmxlLgogIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zLCBjcmVhdGVIeWRyYXRpb25GdW5jdGlvbnMpOwogIH0KICAvLyBpbXBsZW1lbnRhdGlvbgogIGZ1bmN0aW9uIGJhc2VDcmVhdGVSZW5kZXJlcihvcHRpb25zLCBjcmVhdGVIeWRyYXRpb25GbnMpIHsKICAgICAgY29uc3QgdGFyZ2V0ID0gZ2V0R2xvYmFsVGhpcygpOwogICAgICB0YXJnZXQuX19WVUVfXyA9IHRydWU7CiAgICAgIHsKICAgICAgICAgIHNldERldnRvb2xzSG9vayh0YXJnZXQuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXywgdGFyZ2V0KTsKICAgICAgfQogICAgICBjb25zdCB7IGluc2VydDogaG9zdEluc2VydCwgcmVtb3ZlOiBob3N0UmVtb3ZlLCBwYXRjaFByb3A6IGhvc3RQYXRjaFByb3AsIGNyZWF0ZUVsZW1lbnQ6IGhvc3RDcmVhdGVFbGVtZW50LCBjcmVhdGVUZXh0OiBob3N0Q3JlYXRlVGV4dCwgY3JlYXRlQ29tbWVudDogaG9zdENyZWF0ZUNvbW1lbnQsIHNldFRleHQ6IGhvc3RTZXRUZXh0LCBzZXRFbGVtZW50VGV4dDogaG9zdFNldEVsZW1lbnRUZXh0LCBwYXJlbnROb2RlOiBob3N0UGFyZW50Tm9kZSwgbmV4dFNpYmxpbmc6IGhvc3ROZXh0U2libGluZywgc2V0U2NvcGVJZDogaG9zdFNldFNjb3BlSWQgPSBOT09QLCBjbG9uZU5vZGU6IGhvc3RDbG9uZU5vZGUsIGluc2VydFN0YXRpY0NvbnRlbnQ6IGhvc3RJbnNlcnRTdGF0aWNDb250ZW50IH0gPSBvcHRpb25zOwogICAgICAvLyBOb3RlOiBmdW5jdGlvbnMgaW5zaWRlIHRoaXMgY2xvc3VyZSBzaG91bGQgdXNlIGBjb25zdCB4eHggPSAoKSA9PiB7fWAKICAgICAgLy8gc3R5bGUgaW4gb3JkZXIgdG8gcHJldmVudCBiZWluZyBpbmxpbmVkIGJ5IG1pbmlmaWVycy4KICAgICAgY29uc3QgcGF0Y2ggPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciA9IG51bGwsIHBhcmVudENvbXBvbmVudCA9IG51bGwsIHBhcmVudFN1c3BlbnNlID0gbnVsbCwgaXNTVkcgPSBmYWxzZSwgc2xvdFNjb3BlSWRzID0gbnVsbCwgb3B0aW1pemVkID0gaXNIbXJVcGRhdGluZyA/IGZhbHNlIDogISFuMi5keW5hbWljQ2hpbGRyZW4pID0+IHsKICAgICAgICAgIGlmIChuMSA9PT0gbjIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAvLyBwYXRjaGluZyAmIG5vdCBzYW1lIHR5cGUsIHVubW91bnQgb2xkIHRyZWUKICAgICAgICAgIGlmIChuMSAmJiAhaXNTYW1lVk5vZGVUeXBlKG4xLCBuMikpIHsKICAgICAgICAgICAgICBhbmNob3IgPSBnZXROZXh0SG9zdE5vZGUobjEpOwogICAgICAgICAgICAgIHVubW91bnQobjEsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgICAgIG4xID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuMi5wYXRjaEZsYWcgPT09IC0yIC8qIEJBSUwgKi8pIHsKICAgICAgICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBuMi5keW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgeyB0eXBlLCByZWYsIHNoYXBlRmxhZyB9ID0gbjI7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFRleHQ6CiAgICAgICAgICAgICAgICAgIHByb2Nlc3NUZXh0KG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENvbW1lbnQ6CiAgICAgICAgICAgICAgICAgIHByb2Nlc3NDb21tZW50Tm9kZShuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTdGF0aWM6CiAgICAgICAgICAgICAgICAgIGlmIChuMSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBtb3VudFN0YXRpY05vZGUobjIsIGNvbnRhaW5lciwgYW5jaG9yLCBpc1NWRyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXRjaFN0YXRpY05vZGUobjEsIG4yLCBjb250YWluZXIsIGlzU1ZHKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZyYWdtZW50OgogICAgICAgICAgICAgICAgICBwcm9jZXNzRnJhZ21lbnQobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0VsZW1lbnQobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzaGFwZUZsYWcgJiA2IC8qIENPTVBPTkVOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0NvbXBvbmVudChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNoYXBlRmxhZyAmIDY0IC8qIFRFTEVQT1JUICovKSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlLnByb2Nlc3MobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCBpbnRlcm5hbHMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNoYXBlRmxhZyAmIDEyOCAvKiBTVVNQRU5TRSAqLykgewogICAgICAgICAgICAgICAgICAgICAgdHlwZS5wcm9jZXNzKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCwgaW50ZXJuYWxzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHdhcm4kMSgnSW52YWxpZCBWTm9kZSB0eXBlOicsIHR5cGUsIGAoJHt0eXBlb2YgdHlwZX0pYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHNldCByZWYKICAgICAgICAgIGlmIChyZWYgIT0gbnVsbCAmJiBwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzZXRSZWYocmVmLCBuMSAmJiBuMS5yZWYsIHBhcmVudFN1c3BlbnNlLCBuMiB8fCBuMSwgIW4yKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgcHJvY2Vzc1RleHQgPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvcikgPT4gewogICAgICAgICAgaWYgKG4xID09IG51bGwpIHsKICAgICAgICAgICAgICBob3N0SW5zZXJ0KChuMi5lbCA9IGhvc3RDcmVhdGVUZXh0KG4yLmNoaWxkcmVuKSksIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGNvbnN0IGVsID0gKG4yLmVsID0gbjEuZWwpOwogICAgICAgICAgICAgIGlmIChuMi5jaGlsZHJlbiAhPT0gbjEuY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaG9zdFNldFRleHQoZWwsIG4yLmNoaWxkcmVuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHByb2Nlc3NDb21tZW50Tm9kZSA9IChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yKSA9PiB7CiAgICAgICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgICAgICAgIGhvc3RJbnNlcnQoKG4yLmVsID0gaG9zdENyZWF0ZUNvbW1lbnQobjIuY2hpbGRyZW4gfHwgJycpKSwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gdGhlcmUncyBubyBzdXBwb3J0IGZvciBkeW5hbWljIGNvbW1lbnRzCiAgICAgICAgICAgICAgbjIuZWwgPSBuMS5lbDsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgbW91bnRTdGF0aWNOb2RlID0gKG4yLCBjb250YWluZXIsIGFuY2hvciwgaXNTVkcpID0+IHsKICAgICAgICAgIFtuMi5lbCwgbjIuYW5jaG9yXSA9IGhvc3RJbnNlcnRTdGF0aWNDb250ZW50KG4yLmNoaWxkcmVuLCBjb250YWluZXIsIGFuY2hvciwgaXNTVkcsIG4yLmVsLCBuMi5hbmNob3IpOwogICAgICB9OwogICAgICAvKioKICAgICAgICogRGV2IC8gSE1SIG9ubHkKICAgICAgICovCiAgICAgIGNvbnN0IHBhdGNoU3RhdGljTm9kZSA9IChuMSwgbjIsIGNvbnRhaW5lciwgaXNTVkcpID0+IHsKICAgICAgICAgIC8vIHN0YXRpYyBub2RlcyBhcmUgb25seSBwYXRjaGVkIGR1cmluZyBkZXYgZm9yIEhNUgogICAgICAgICAgaWYgKG4yLmNoaWxkcmVuICE9PSBuMS5jaGlsZHJlbikgewogICAgICAgICAgICAgIGNvbnN0IGFuY2hvciA9IGhvc3ROZXh0U2libGluZyhuMS5hbmNob3IpOwogICAgICAgICAgICAgIC8vIHJlbW92ZSBleGlzdGluZwogICAgICAgICAgICAgIHJlbW92ZVN0YXRpY05vZGUobjEpOwogICAgICAgICAgICAgIFtuMi5lbCwgbjIuYW5jaG9yXSA9IGhvc3RJbnNlcnRTdGF0aWNDb250ZW50KG4yLmNoaWxkcmVuLCBjb250YWluZXIsIGFuY2hvciwgaXNTVkcpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgbjIuZWwgPSBuMS5lbDsKICAgICAgICAgICAgICBuMi5hbmNob3IgPSBuMS5hbmNob3I7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG1vdmVTdGF0aWNOb2RlID0gKHsgZWwsIGFuY2hvciB9LCBjb250YWluZXIsIG5leHRTaWJsaW5nKSA9PiB7CiAgICAgICAgICBsZXQgbmV4dDsKICAgICAgICAgIHdoaWxlIChlbCAmJiBlbCAhPT0gYW5jaG9yKSB7CiAgICAgICAgICAgICAgbmV4dCA9IGhvc3ROZXh0U2libGluZyhlbCk7CiAgICAgICAgICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBuZXh0U2libGluZyk7CiAgICAgICAgICAgICAgZWwgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgaG9zdEluc2VydChhbmNob3IsIGNvbnRhaW5lciwgbmV4dFNpYmxpbmcpOwogICAgICB9OwogICAgICBjb25zdCByZW1vdmVTdGF0aWNOb2RlID0gKHsgZWwsIGFuY2hvciB9KSA9PiB7CiAgICAgICAgICBsZXQgbmV4dDsKICAgICAgICAgIHdoaWxlIChlbCAmJiBlbCAhPT0gYW5jaG9yKSB7CiAgICAgICAgICAgICAgbmV4dCA9IGhvc3ROZXh0U2libGluZyhlbCk7CiAgICAgICAgICAgICAgaG9zdFJlbW92ZShlbCk7CiAgICAgICAgICAgICAgZWwgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgaG9zdFJlbW92ZShhbmNob3IpOwogICAgICB9OwogICAgICBjb25zdCBwcm9jZXNzRWxlbWVudCA9IChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICAgIGlzU1ZHID0gaXNTVkcgfHwgbjIudHlwZSA9PT0gJ3N2Zyc7CiAgICAgICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgICAgICAgIG1vdW50RWxlbWVudChuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBwYXRjaEVsZW1lbnQobjEsIG4yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBtb3VudEVsZW1lbnQgPSAodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICAgIGxldCBlbDsKICAgICAgICAgIGxldCB2bm9kZUhvb2s7CiAgICAgICAgICBjb25zdCB7IHR5cGUsIHByb3BzLCBzaGFwZUZsYWcsIHRyYW5zaXRpb24sIHBhdGNoRmxhZywgZGlycyB9ID0gdm5vZGU7CiAgICAgICAgICB7CiAgICAgICAgICAgICAgZWwgPSB2bm9kZS5lbCA9IGhvc3RDcmVhdGVFbGVtZW50KHZub2RlLnR5cGUsIGlzU1ZHLCBwcm9wcyAmJiBwcm9wcy5pcywgcHJvcHMpOwogICAgICAgICAgICAgIC8vIG1vdW50IGNoaWxkcmVuIGZpcnN0LCBzaW5jZSBzb21lIHByb3BzIG1heSByZWx5IG9uIGNoaWxkIGNvbnRlbnQKICAgICAgICAgICAgICAvLyBiZWluZyBhbHJlYWR5IHJlbmRlcmVkLCBlLmcuIGA8c2VsZWN0IHZhbHVlPmAKICAgICAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgOCAvKiBURVhUX0NISUxEUkVOICovKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChlbCwgdm5vZGUuY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChzaGFwZUZsYWcgJiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgICAgICBtb3VudENoaWxkcmVuKHZub2RlLmNoaWxkcmVuLCBlbCwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcgJiYgdHlwZSAhPT0gJ2ZvcmVpZ25PYmplY3QnLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ2NyZWF0ZWQnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gcHJvcHMKICAgICAgICAgICAgICBpZiAocHJvcHMpIHsKICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT09ICd2YWx1ZScgJiYgIWlzUmVzZXJ2ZWRQcm9wKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCBrZXksIG51bGwsIHByb3BzW2tleV0sIGlzU1ZHLCB2bm9kZS5jaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdW5tb3VudENoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICogU3BlY2lhbCBjYXNlIGZvciBzZXR0aW5nIHZhbHVlIG9uIERPTSBlbGVtZW50czoKICAgICAgICAgICAgICAgICAgICogLSBpdCBjYW4gYmUgb3JkZXItc2Vuc2l0aXZlIChlLmcuIHNob3VsZCBiZSBzZXQgKmFmdGVyKiBtaW4vbWF4LCAjMjMyNSwgIzQwMjQpCiAgICAgICAgICAgICAgICAgICAqIC0gaXQgbmVlZHMgdG8gYmUgZm9yY2VkICgjMTQ3MSkKICAgICAgICAgICAgICAgICAgICogIzIzNTMgcHJvcG9zZXMgYWRkaW5nIGFub3RoZXIgcmVuZGVyZXIgb3B0aW9uIHRvIGNvbmZpZ3VyZSB0aGlzLCBidXQKICAgICAgICAgICAgICAgICAgICogdGhlIHByb3BlcnRpZXMgYWZmZWN0cyBhcmUgc28gZmluaXRlIGl0IGlzIHdvcnRoIHNwZWNpYWwgY2FzaW5nIGl0CiAgICAgICAgICAgICAgICAgICAqIGhlcmUgdG8gcmVkdWNlIHRoZSBjb21wbGV4aXR5LiAoU3BlY2lhbCBjYXNpbmcgaXQgYWxzbyBzaG91bGQgbm90CiAgICAgICAgICAgICAgICAgICAqIGFmZmVjdCBub24tRE9NIHJlbmRlcmVycykKICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgIGlmICgndmFsdWUnIGluIHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCAndmFsdWUnLCBudWxsLCBwcm9wcy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCh2bm9kZUhvb2sgPSBwcm9wcy5vblZub2RlQmVmb3JlTW91bnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBzY29wZUlkCiAgICAgICAgICAgICAgc2V0U2NvcGVJZChlbCwgdm5vZGUsIHZub2RlLnNjb3BlSWQsIHNsb3RTY29wZUlkcywgcGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWwsICdfX3Zub2RlJywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogdm5vZGUsCiAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsLCAnX192dWVQYXJlbnRDb21wb25lbnQnLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGlycykgewogICAgICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ2JlZm9yZU1vdW50Jyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyAjMTU4MyBGb3IgaW5zaWRlIHN1c3BlbnNlICsgc3VzcGVuc2Ugbm90IHJlc29sdmVkIGNhc2UsIGVudGVyIGhvb2sgc2hvdWxkIGNhbGwgd2hlbiBzdXNwZW5zZSByZXNvbHZlZAogICAgICAgICAgLy8gIzE2ODkgRm9yIGluc2lkZSBzdXNwZW5zZSArIHN1c3BlbnNlIHJlc29sdmVkIGNhc2UsIGp1c3QgY2FsbCBpdAogICAgICAgICAgY29uc3QgbmVlZENhbGxUcmFuc2l0aW9uSG9va3MgPSAoIXBhcmVudFN1c3BlbnNlIHx8IChwYXJlbnRTdXNwZW5zZSAmJiAhcGFyZW50U3VzcGVuc2UucGVuZGluZ0JyYW5jaCkpICYmCiAgICAgICAgICAgICAgdHJhbnNpdGlvbiAmJgogICAgICAgICAgICAgICF0cmFuc2l0aW9uLnBlcnNpc3RlZDsKICAgICAgICAgIGlmIChuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcykgewogICAgICAgICAgICAgIHRyYW5zaXRpb24uYmVmb3JlRW50ZXIoZWwpOwogICAgICAgICAgfQogICAgICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgaWYgKCh2bm9kZUhvb2sgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlTW91bnRlZCkgfHwKICAgICAgICAgICAgICBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyB8fAogICAgICAgICAgICAgIGRpcnMpIHsKICAgICAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gewogICAgICAgICAgICAgICAgICB2bm9kZUhvb2sgJiYgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7CiAgICAgICAgICAgICAgICAgIG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzICYmIHRyYW5zaXRpb24uZW50ZXIoZWwpOwogICAgICAgICAgICAgICAgICBkaXJzICYmIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ21vdW50ZWQnKTsKICAgICAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHNldFNjb3BlSWQgPSAoZWwsIHZub2RlLCBzY29wZUlkLCBzbG90U2NvcGVJZHMsIHBhcmVudENvbXBvbmVudCkgPT4gewogICAgICAgICAgaWYgKHNjb3BlSWQpIHsKICAgICAgICAgICAgICBob3N0U2V0U2NvcGVJZChlbCwgc2NvcGVJZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2xvdFNjb3BlSWRzKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzbG90U2NvcGVJZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaG9zdFNldFNjb3BlSWQoZWwsIHNsb3RTY29wZUlkc1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICAgIGxldCBzdWJUcmVlID0gcGFyZW50Q29tcG9uZW50LnN1YlRyZWU7CiAgICAgICAgICAgICAgaWYgKHN1YlRyZWUucGF0Y2hGbGFnID4gMCAmJgogICAgICAgICAgICAgICAgICBzdWJUcmVlLnBhdGNoRmxhZyAmIDIwNDggLyogREVWX1JPT1RfRlJBR01FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgc3ViVHJlZSA9CiAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJTaW5nbGVSb290KHN1YlRyZWUuY2hpbGRyZW4pIHx8IHN1YlRyZWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2bm9kZSA9PT0gc3ViVHJlZSkgewogICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRWTm9kZSA9IHBhcmVudENvbXBvbmVudC52bm9kZTsKICAgICAgICAgICAgICAgICAgc2V0U2NvcGVJZChlbCwgcGFyZW50Vk5vZGUsIHBhcmVudFZOb2RlLnNjb3BlSWQsIHBhcmVudFZOb2RlLnNsb3RTY29wZUlkcywgcGFyZW50Q29tcG9uZW50LnBhcmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBtb3VudENoaWxkcmVuID0gKGNoaWxkcmVuLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCBzdGFydCA9IDApID0+IHsKICAgICAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSAoY2hpbGRyZW5baV0gPSBvcHRpbWl6ZWQKICAgICAgICAgICAgICAgICAgPyBjbG9uZUlmTW91bnRlZChjaGlsZHJlbltpXSkKICAgICAgICAgICAgICAgICAgOiBub3JtYWxpemVWTm9kZShjaGlsZHJlbltpXSkpOwogICAgICAgICAgICAgIHBhdGNoKG51bGwsIGNoaWxkLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgcGF0Y2hFbGVtZW50ID0gKG4xLCBuMiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgICAgICBjb25zdCBlbCA9IChuMi5lbCA9IG4xLmVsKTsKICAgICAgICAgIGxldCB7IHBhdGNoRmxhZywgZHluYW1pY0NoaWxkcmVuLCBkaXJzIH0gPSBuMjsKICAgICAgICAgIC8vICMxNDI2IHRha2UgdGhlIG9sZCB2bm9kZSdzIHBhdGNoIGZsYWcgaW50byBhY2NvdW50IHNpbmNlIHVzZXIgbWF5IGNsb25lIGEKICAgICAgICAgIC8vIGNvbXBpbGVyLWdlbmVyYXRlZCB2bm9kZSwgd2hpY2ggZGUtb3B0cyB0byBGVUxMX1BST1BTCiAgICAgICAgICBwYXRjaEZsYWcgfD0gbjEucGF0Y2hGbGFnICYgMTYgLyogRlVMTF9QUk9QUyAqLzsKICAgICAgICAgIGNvbnN0IG9sZFByb3BzID0gbjEucHJvcHMgfHwgRU1QVFlfT0JKOwogICAgICAgICAgY29uc3QgbmV3UHJvcHMgPSBuMi5wcm9wcyB8fCBFTVBUWV9PQko7CiAgICAgICAgICBsZXQgdm5vZGVIb29rOwogICAgICAgICAgLy8gZGlzYWJsZSByZWN1cnNlIGluIGJlZm9yZVVwZGF0ZSBob29rcwogICAgICAgICAgcGFyZW50Q29tcG9uZW50ICYmIHRvZ2dsZVJlY3Vyc2UocGFyZW50Q29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICBpZiAoKHZub2RlSG9vayA9IG5ld1Byb3BzLm9uVm5vZGVCZWZvcmVVcGRhdGUpKSB7CiAgICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCBuMiwgbjEpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRpcnMpIHsKICAgICAgICAgICAgICBpbnZva2VEaXJlY3RpdmVIb29rKG4yLCBuMSwgcGFyZW50Q29tcG9uZW50LCAnYmVmb3JlVXBkYXRlJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJlbnRDb21wb25lbnQgJiYgdG9nZ2xlUmVjdXJzZShwYXJlbnRDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgaWYgKGlzSG1yVXBkYXRpbmcpIHsKICAgICAgICAgICAgICAvLyBITVIgdXBkYXRlZCwgZm9yY2UgZnVsbCBkaWZmCiAgICAgICAgICAgICAgcGF0Y2hGbGFnID0gMDsKICAgICAgICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYXJlQ2hpbGRyZW5TVkcgPSBpc1NWRyAmJiBuMi50eXBlICE9PSAnZm9yZWlnbk9iamVjdCc7CiAgICAgICAgICBpZiAoZHluYW1pY0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgcGF0Y2hCbG9ja0NoaWxkcmVuKG4xLmR5bmFtaWNDaGlsZHJlbiwgZHluYW1pY0NoaWxkcmVuLCBlbCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgYXJlQ2hpbGRyZW5TVkcsIHNsb3RTY29wZUlkcyk7CiAgICAgICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCAmJiBwYXJlbnRDb21wb25lbnQudHlwZS5fX2htcklkKSB7CiAgICAgICAgICAgICAgICAgIHRyYXZlcnNlU3RhdGljQ2hpbGRyZW4objEsIG4yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICghb3B0aW1pemVkKSB7CiAgICAgICAgICAgICAgLy8gZnVsbCBkaWZmCiAgICAgICAgICAgICAgcGF0Y2hDaGlsZHJlbihuMSwgbjIsIGVsLCBudWxsLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBhcmVDaGlsZHJlblNWRywgc2xvdFNjb3BlSWRzLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGF0Y2hGbGFnID4gMCkgewogICAgICAgICAgICAgIC8vIHRoZSBwcmVzZW5jZSBvZiBhIHBhdGNoRmxhZyBtZWFucyB0aGlzIGVsZW1lbnQncyByZW5kZXIgY29kZSB3YXMKICAgICAgICAgICAgICAvLyBnZW5lcmF0ZWQgYnkgdGhlIGNvbXBpbGVyIGFuZCBjYW4gdGFrZSB0aGUgZmFzdCBwYXRoLgogICAgICAgICAgICAgIC8vIGluIHRoaXMgcGF0aCBvbGQgbm9kZSBhbmQgbmV3IG5vZGUgYXJlIGd1YXJhbnRlZWQgdG8gaGF2ZSB0aGUgc2FtZSBzaGFwZQogICAgICAgICAgICAgIC8vIChpLmUuIGF0IHRoZSBleGFjdCBzYW1lIHBvc2l0aW9uIGluIHRoZSBzb3VyY2UgdGVtcGxhdGUpCiAgICAgICAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDE2IC8qIEZVTExfUFJPUFMgKi8pIHsKICAgICAgICAgICAgICAgICAgLy8gZWxlbWVudCBwcm9wcyBjb250YWluIGR5bmFtaWMga2V5cywgZnVsbCBkaWZmIG5lZWRlZAogICAgICAgICAgICAgICAgICBwYXRjaFByb3BzKGVsLCBuMiwgb2xkUHJvcHMsIG5ld1Byb3BzLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBjbGFzcwogICAgICAgICAgICAgICAgICAvLyB0aGlzIGZsYWcgaXMgbWF0Y2hlZCB3aGVuIHRoZSBlbGVtZW50IGhhcyBkeW5hbWljIGNsYXNzIGJpbmRpbmdzLgogICAgICAgICAgICAgICAgICBpZiAocGF0Y2hGbGFnICYgMiAvKiBDTEFTUyAqLykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFByb3BzLmNsYXNzICE9PSBuZXdQcm9wcy5jbGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsICdjbGFzcycsIG51bGwsIG5ld1Byb3BzLmNsYXNzLCBpc1NWRyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gc3R5bGUKICAgICAgICAgICAgICAgICAgLy8gdGhpcyBmbGFnIGlzIG1hdGNoZWQgd2hlbiB0aGUgZWxlbWVudCBoYXMgZHluYW1pYyBzdHlsZSBiaW5kaW5ncwogICAgICAgICAgICAgICAgICBpZiAocGF0Y2hGbGFnICYgNCAvKiBTVFlMRSAqLykgewogICAgICAgICAgICAgICAgICAgICAgaG9zdFBhdGNoUHJvcChlbCwgJ3N0eWxlJywgb2xkUHJvcHMuc3R5bGUsIG5ld1Byb3BzLnN0eWxlLCBpc1NWRyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gcHJvcHMKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBmbGFnIGlzIG1hdGNoZWQgd2hlbiB0aGUgZWxlbWVudCBoYXMgZHluYW1pYyBwcm9wL2F0dHIgYmluZGluZ3MKICAgICAgICAgICAgICAgICAgLy8gb3RoZXIgdGhhbiBjbGFzcyBhbmQgc3R5bGUuIFRoZSBrZXlzIG9mIGR5bmFtaWMgcHJvcC9hdHRycyBhcmUgc2F2ZWQgZm9yCiAgICAgICAgICAgICAgICAgIC8vIGZhc3RlciBpdGVyYXRpb24uCiAgICAgICAgICAgICAgICAgIC8vIE5vdGUgZHluYW1pYyBrZXlzIGxpa2UgOltmb29dPSJiYXIiIHdpbGwgY2F1c2UgdGhpcyBvcHRpbWl6YXRpb24gdG8KICAgICAgICAgICAgICAgICAgLy8gYmFpbCBvdXQgYW5kIGdvIHRocm91Z2ggYSBmdWxsIGRpZmYgYmVjYXVzZSB3ZSBuZWVkIHRvIHVuc2V0IHRoZSBvbGQga2V5CiAgICAgICAgICAgICAgICAgIGlmIChwYXRjaEZsYWcgJiA4IC8qIFBST1BTICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgZmxhZyBpcyBwcmVzZW50IHRoZW4gZHluYW1pY1Byb3BzIG11c3QgYmUgbm9uLW51bGwKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3BzVG9VcGRhdGUgPSBuMi5keW5hbWljUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzVG9VcGRhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBwcm9wc1RvVXBkYXRlW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXYgPSBvbGRQcm9wc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHQgPSBuZXdQcm9wc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vICMxNDcxIGZvcmNlIHBhdGNoIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQgIT09IHByZXYgfHwga2V5ID09PSAndmFsdWUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsIGtleSwgcHJldiwgbmV4dCwgaXNTVkcsIG4xLmNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB1bm1vdW50Q2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyB0ZXh0CiAgICAgICAgICAgICAgLy8gVGhpcyBmbGFnIGlzIG1hdGNoZWQgd2hlbiB0aGUgZWxlbWVudCBoYXMgb25seSBkeW5hbWljIHRleHQgY2hpbGRyZW4uCiAgICAgICAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDEgLyogVEVYVCAqLykgewogICAgICAgICAgICAgICAgICBpZiAobjEuY2hpbGRyZW4gIT09IG4yLmNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBob3N0U2V0RWxlbWVudFRleHQoZWwsIG4yLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKCFvcHRpbWl6ZWQgJiYgZHluYW1pY0NoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgICAgICAvLyB1bm9wdGltaXplZCwgZnVsbCBkaWZmCiAgICAgICAgICAgICAgcGF0Y2hQcm9wcyhlbCwgbjIsIG9sZFByb3BzLCBuZXdQcm9wcywgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCh2bm9kZUhvb2sgPSBuZXdQcm9wcy5vblZub2RlVXBkYXRlZCkgfHwgZGlycykgewogICAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZub2RlSG9vayAmJiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIG4yLCBuMSk7CiAgICAgICAgICAgICAgICAgIGRpcnMgJiYgaW52b2tlRGlyZWN0aXZlSG9vayhuMiwgbjEsIHBhcmVudENvbXBvbmVudCwgJ3VwZGF0ZWQnKTsKICAgICAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIC8vIFRoZSBmYXN0IHBhdGggZm9yIGJsb2Nrcy4KICAgICAgY29uc3QgcGF0Y2hCbG9ja0NoaWxkcmVuID0gKG9sZENoaWxkcmVuLCBuZXdDaGlsZHJlbiwgZmFsbGJhY2tDb250YWluZXIsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMpID0+IHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBvbGRWTm9kZSA9IG9sZENoaWxkcmVuW2ldOwogICAgICAgICAgICAgIGNvbnN0IG5ld1ZOb2RlID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIHRoZSBjb250YWluZXIgKHBhcmVudCBlbGVtZW50KSBmb3IgdGhlIHBhdGNoLgogICAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IAogICAgICAgICAgICAgIC8vIG9sZFZOb2RlIG1heSBiZSBhbiBlcnJvcmVkIGFzeW5jIHNldHVwKCkgY29tcG9uZW50IGluc2lkZSBTdXNwZW5zZQogICAgICAgICAgICAgIC8vIHdoaWNoIHdpbGwgbm90IGhhdmUgYSBtb3VudGVkIGVsZW1lbnQKICAgICAgICAgICAgICBvbGRWTm9kZS5lbCAmJgogICAgICAgICAgICAgICAgICAvLyAtIEluIHRoZSBjYXNlIG9mIGEgRnJhZ21lbnQsIHdlIG5lZWQgdG8gcHJvdmlkZSB0aGUgYWN0dWFsIHBhcmVudAogICAgICAgICAgICAgICAgICAvLyBvZiB0aGUgRnJhZ21lbnQgaXRzZWxmIHNvIGl0IGNhbiBtb3ZlIGl0cyBjaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgKG9sZFZOb2RlLnR5cGUgPT09IEZyYWdtZW50IHx8CiAgICAgICAgICAgICAgICAgICAgICAvLyAtIEluIHRoZSBjYXNlIG9mIGRpZmZlcmVudCBub2RlcywgdGhlcmUgaXMgZ29pbmcgdG8gYmUgYSByZXBsYWNlbWVudAogICAgICAgICAgICAgICAgICAgICAgLy8gd2hpY2ggYWxzbyByZXF1aXJlcyB0aGUgY29ycmVjdCBwYXJlbnQgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgICAgICAhaXNTYW1lVk5vZGVUeXBlKG9sZFZOb2RlLCBuZXdWTm9kZSkgfHwKICAgICAgICAgICAgICAgICAgICAgIC8vIC0gSW4gdGhlIGNhc2Ugb2YgYSBjb21wb25lbnQsIGl0IGNvdWxkIGNvbnRhaW4gYW55dGhpbmcuCiAgICAgICAgICAgICAgICAgICAgICBvbGRWTm9kZS5zaGFwZUZsYWcgJiAoNiAvKiBDT01QT05FTlQgKi8gfCA2NCAvKiBURUxFUE9SVCAqLykpCiAgICAgICAgICAgICAgICAgID8gaG9zdFBhcmVudE5vZGUob2xkVk5vZGUuZWwpCiAgICAgICAgICAgICAgICAgIDogLy8gSW4gb3RoZXIgY2FzZXMsIHRoZSBwYXJlbnQgY29udGFpbmVyIGlzIG5vdCBhY3R1YWxseSB1c2VkIHNvIHdlCiAgICAgICAgICAgICAgICAgICAgICAvLyBqdXN0IHBhc3MgdGhlIGJsb2NrIGVsZW1lbnQgaGVyZSB0byBhdm9pZCBhIERPTSBwYXJlbnROb2RlIGNhbGwuCiAgICAgICAgICAgICAgICAgICAgICBmYWxsYmFja0NvbnRhaW5lcjsKICAgICAgICAgICAgICBwYXRjaChvbGRWTm9kZSwgbmV3Vk5vZGUsIGNvbnRhaW5lciwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHBhdGNoUHJvcHMgPSAoZWwsIHZub2RlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHKSA9PiB7CiAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgLy8gZW1wdHkgc3RyaW5nIGlzIG5vdCB2YWxpZCBwcm9wCiAgICAgICAgICAgICAgICAgIGlmIChpc1Jlc2VydmVkUHJvcChrZXkpKQogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHQgPSBuZXdQcm9wc1trZXldOwogICAgICAgICAgICAgICAgICBjb25zdCBwcmV2ID0gb2xkUHJvcHNba2V5XTsKICAgICAgICAgICAgICAgICAgLy8gZGVmZXIgcGF0Y2hpbmcgdmFsdWUKICAgICAgICAgICAgICAgICAgaWYgKG5leHQgIT09IHByZXYgJiYga2V5ICE9PSAndmFsdWUnKSB7CiAgICAgICAgICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCBrZXksIHByZXYsIG5leHQsIGlzU1ZHLCB2bm9kZS5jaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdW5tb3VudENoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IEVNUFRZX09CSikgewogICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBvbGRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1Jlc2VydmVkUHJvcChrZXkpICYmICEoa2V5IGluIG5ld1Byb3BzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsIGtleSwgb2xkUHJvcHNba2V5XSwgbnVsbCwgaXNTVkcsIHZub2RlLmNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB1bm1vdW50Q2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgndmFsdWUnIGluIG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsICd2YWx1ZScsIG9sZFByb3BzLnZhbHVlLCBuZXdQcm9wcy52YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBwcm9jZXNzRnJhZ21lbnQgPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgICAgICBjb25zdCBmcmFnbWVudFN0YXJ0QW5jaG9yID0gKG4yLmVsID0gbjEgPyBuMS5lbCA6IGhvc3RDcmVhdGVUZXh0KCcnKSk7CiAgICAgICAgICBjb25zdCBmcmFnbWVudEVuZEFuY2hvciA9IChuMi5hbmNob3IgPSBuMSA/IG4xLmFuY2hvciA6IGhvc3RDcmVhdGVUZXh0KCcnKSk7CiAgICAgICAgICBsZXQgeyBwYXRjaEZsYWcsIGR5bmFtaWNDaGlsZHJlbiwgc2xvdFNjb3BlSWRzOiBmcmFnbWVudFNsb3RTY29wZUlkcyB9ID0gbjI7CiAgICAgICAgICBpZiAoLy8gIzU1MjMgZGV2IHJvb3QgZnJhZ21lbnQgbWF5IGluaGVyaXQgZGlyZWN0aXZlcwogICAgICAgICAgICAgIChpc0htclVwZGF0aW5nIHx8IHBhdGNoRmxhZyAmIDIwNDggLyogREVWX1JPT1RfRlJBR01FTlQgKi8pKSB7CiAgICAgICAgICAgICAgLy8gSE1SIHVwZGF0ZWQgLyBEZXYgcm9vdCBmcmFnbWVudCAody8gY29tbWVudHMpLCBmb3JjZSBmdWxsIGRpZmYKICAgICAgICAgICAgICBwYXRjaEZsYWcgPSAwOwogICAgICAgICAgICAgIG9wdGltaXplZCA9IGZhbHNlOwogICAgICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBjaGVjayBpZiB0aGlzIGlzIGEgc2xvdCBmcmFnbWVudCB3aXRoIDpzbG90dGVkIHNjb3BlIGlkcwogICAgICAgICAgaWYgKGZyYWdtZW50U2xvdFNjb3BlSWRzKSB7CiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzCiAgICAgICAgICAgICAgICAgID8gc2xvdFNjb3BlSWRzLmNvbmNhdChmcmFnbWVudFNsb3RTY29wZUlkcykKICAgICAgICAgICAgICAgICAgOiBmcmFnbWVudFNsb3RTY29wZUlkczsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuMSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9zdEluc2VydChmcmFnbWVudFN0YXJ0QW5jaG9yLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgICAgICAgaG9zdEluc2VydChmcmFnbWVudEVuZEFuY2hvciwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgICAgIC8vIGEgZnJhZ21lbnQgY2FuIG9ubHkgaGF2ZSBhcnJheSBjaGlsZHJlbgogICAgICAgICAgICAgIC8vIHNpbmNlIHRoZXkgYXJlIGVpdGhlciBnZW5lcmF0ZWQgYnkgdGhlIGNvbXBpbGVyLCBvciBpbXBsaWNpdGx5IGNyZWF0ZWQKICAgICAgICAgICAgICAvLyBmcm9tIGFycmF5cy4KICAgICAgICAgICAgICBtb3VudENoaWxkcmVuKG4yLmNoaWxkcmVuLCBjb250YWluZXIsIGZyYWdtZW50RW5kQW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHBhdGNoRmxhZyA+IDAgJiYKICAgICAgICAgICAgICAgICAgcGF0Y2hGbGFnICYgNjQgLyogU1RBQkxFX0ZSQUdNRU5UICovICYmCiAgICAgICAgICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbiAmJgogICAgICAgICAgICAgICAgICAvLyAjMjcxNSB0aGUgcHJldmlvdXMgZnJhZ21lbnQgY291bGQndmUgYmVlbiBhIEJBSUxlZCBvbmUgYXMgYSByZXN1bHQKICAgICAgICAgICAgICAgICAgLy8gb2YgcmVuZGVyU2xvdCgpIHdpdGggbm8gdmFsaWQgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgbjEuZHluYW1pY0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgIC8vIGEgc3RhYmxlIGZyYWdtZW50ICh0ZW1wbGF0ZSByb290IG9yIDx0ZW1wbGF0ZSB2LWZvcj4pIGRvZXNuJ3QgbmVlZCB0bwogICAgICAgICAgICAgICAgICAvLyBwYXRjaCBjaGlsZHJlbiBvcmRlciwgYnV0IGl0IG1heSBjb250YWluIGR5bmFtaWNDaGlsZHJlbi4KICAgICAgICAgICAgICAgICAgcGF0Y2hCbG9ja0NoaWxkcmVuKG4xLmR5bmFtaWNDaGlsZHJlbiwgZHluYW1pY0NoaWxkcmVuLCBjb250YWluZXIsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMpOwogICAgICAgICAgICAgICAgICBpZiAocGFyZW50Q29tcG9uZW50ICYmIHBhcmVudENvbXBvbmVudC50eXBlLl9faG1ySWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlU3RhdGljQ2hpbGRyZW4objEsIG4yKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmICgKICAgICAgICAgICAgICAgICAgLy8gIzIwODAgaWYgdGhlIHN0YWJsZSBmcmFnbWVudCBoYXMgYSBrZXksIGl0J3MgYSA8dGVtcGxhdGUgdi1mb3I+IHRoYXQgbWF5CiAgICAgICAgICAgICAgICAgIC8vICBnZXQgbW92ZWQgYXJvdW5kLiBNYWtlIHN1cmUgYWxsIHJvb3QgbGV2ZWwgdm5vZGVzIGluaGVyaXQgZWwuCiAgICAgICAgICAgICAgICAgIC8vICMyMTM0IG9yIGlmIGl0J3MgYSBjb21wb25lbnQgcm9vdCwgaXQgbWF5IGFsc28gZ2V0IG1vdmVkIGFyb3VuZAogICAgICAgICAgICAgICAgICAvLyBhcyB0aGUgY29tcG9uZW50IGlzIGJlaW5nIG1vdmVkLgogICAgICAgICAgICAgICAgICBuMi5rZXkgIT0gbnVsbCB8fAogICAgICAgICAgICAgICAgICAgICAgKHBhcmVudENvbXBvbmVudCAmJiBuMiA9PT0gcGFyZW50Q29tcG9uZW50LnN1YlRyZWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMiwgdHJ1ZSAvKiBzaGFsbG93ICovKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8ga2V5ZWQgLyB1bmtleWVkLCBvciBtYW51YWwgZnJhZ21lbnRzLgogICAgICAgICAgICAgICAgICAvLyBmb3Iga2V5ZWQgJiB1bmtleWVkLCBzaW5jZSB0aGV5IGFyZSBjb21waWxlciBnZW5lcmF0ZWQgZnJvbSB2LWZvciwKICAgICAgICAgICAgICAgICAgLy8gZWFjaCBjaGlsZCBpcyBndWFyYW50ZWVkIHRvIGJlIGEgYmxvY2sgc28gdGhlIGZyYWdtZW50IHdpbGwgbmV2ZXIKICAgICAgICAgICAgICAgICAgLy8gaGF2ZSBkeW5hbWljQ2hpbGRyZW4uCiAgICAgICAgICAgICAgICAgIHBhdGNoQ2hpbGRyZW4objEsIG4yLCBjb250YWluZXIsIGZyYWdtZW50RW5kQW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgcHJvY2Vzc0NvbXBvbmVudCA9IChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICAgIG4yLnNsb3RTY29wZUlkcyA9IHNsb3RTY29wZUlkczsKICAgICAgICAgIGlmIChuMSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG4yLnNoYXBlRmxhZyAmIDUxMiAvKiBDT01QT05FTlRfS0VQVF9BTElWRSAqLykgewogICAgICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQuY3R4LmFjdGl2YXRlKG4yLCBjb250YWluZXIsIGFuY2hvciwgaXNTVkcsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBtb3VudENvbXBvbmVudChuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudChuMSwgbjIsIG9wdGltaXplZCk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG1vdW50Q29tcG9uZW50ID0gKGluaXRpYWxWTm9kZSwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gKGluaXRpYWxWTm9kZS5jb21wb25lbnQgPSBjcmVhdGVDb21wb25lbnRJbnN0YW5jZShpbml0aWFsVk5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UpKTsKICAgICAgICAgIGlmIChpbnN0YW5jZS50eXBlLl9faG1ySWQpIHsKICAgICAgICAgICAgICByZWdpc3RlckhNUihpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgICAgcHVzaFdhcm5pbmdDb250ZXh0KGluaXRpYWxWTm9kZSk7CiAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgbW91bnRgKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGluamVjdCByZW5kZXJlciBpbnRlcm5hbHMgZm9yIGtlZXBBbGl2ZQogICAgICAgICAgaWYgKGlzS2VlcEFsaXZlKGluaXRpYWxWTm9kZSkpIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5jdHgucmVuZGVyZXIgPSBpbnRlcm5hbHM7CiAgICAgICAgICB9CiAgICAgICAgICAvLyByZXNvbHZlIHByb3BzIGFuZCBzbG90cyBmb3Igc2V0dXAgY29udGV4dAogICAgICAgICAgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgaW5pdGApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXR1cENvbXBvbmVudChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgaW5pdGApOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHNldHVwKCkgaXMgYXN5bmMuIFRoaXMgY29tcG9uZW50IHJlbGllcyBvbiBhc3luYyBsb2dpYyB0byBiZSByZXNvbHZlZAogICAgICAgICAgLy8gYmVmb3JlIHByb2NlZWRpbmcKICAgICAgICAgIGlmIChpbnN0YW5jZS5hc3luY0RlcCkgewogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnJlZ2lzdGVyRGVwKGluc3RhbmNlLCBzZXR1cFJlbmRlckVmZmVjdCk7CiAgICAgICAgICAgICAgLy8gR2l2ZSBpdCBhIHBsYWNlaG9sZGVyIGlmIHRoaXMgaXMgbm90IGh5ZHJhdGlvbgogICAgICAgICAgICAgIC8vIFRPRE8gaGFuZGxlIHNlbGYtZGVmaW5lZCBmYWxsYmFjawogICAgICAgICAgICAgIGlmICghaW5pdGlhbFZOb2RlLmVsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gKGluc3RhbmNlLnN1YlRyZWUgPSBjcmVhdGVWTm9kZShDb21tZW50KSk7CiAgICAgICAgICAgICAgICAgIHByb2Nlc3NDb21tZW50Tm9kZShudWxsLCBwbGFjZWhvbGRlciwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzZXR1cFJlbmRlckVmZmVjdChpbnN0YW5jZSwgaW5pdGlhbFZOb2RlLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBvcHRpbWl6ZWQpOwogICAgICAgICAgewogICAgICAgICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7CiAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYG1vdW50YCk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHVwZGF0ZUNvbXBvbmVudCA9IChuMSwgbjIsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSAobjIuY29tcG9uZW50ID0gbjEuY29tcG9uZW50KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGVDb21wb25lbnQobjEsIG4yLCBvcHRpbWl6ZWQpKSB7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmFzeW5jRGVwICYmCiAgICAgICAgICAgICAgICAgICFpbnN0YW5jZS5hc3luY1Jlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgIC8vIGFzeW5jICYgc3RpbGwgcGVuZGluZyAtIGp1c3QgdXBkYXRlIHByb3BzIGFuZCBzbG90cwogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB0aGUgY29tcG9uZW50J3MgcmVhY3RpdmUgZWZmZWN0IGZvciByZW5kZXIgaXNuJ3Qgc2V0LXVwIHlldAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQobjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudFByZVJlbmRlcihpbnN0YW5jZSwgbjIsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gbm9ybWFsIHVwZGF0ZQogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5uZXh0ID0gbjI7CiAgICAgICAgICAgICAgICAgIC8vIGluIGNhc2UgdGhlIGNoaWxkIGNvbXBvbmVudCBpcyBhbHNvIHF1ZXVlZCwgcmVtb3ZlIGl0IHRvIGF2b2lkCiAgICAgICAgICAgICAgICAgIC8vIGRvdWJsZSB1cGRhdGluZyB0aGUgc2FtZSBjaGlsZCBjb21wb25lbnQgaW4gdGhlIHNhbWUgZmx1c2guCiAgICAgICAgICAgICAgICAgIGludmFsaWRhdGVKb2IoaW5zdGFuY2UudXBkYXRlKTsKICAgICAgICAgICAgICAgICAgLy8gaW5zdGFuY2UudXBkYXRlIGlzIHRoZSByZWFjdGl2ZSBlZmZlY3QuCiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIG5vIHVwZGF0ZSBuZWVkZWQuIGp1c3QgY29weSBvdmVyIHByb3BlcnRpZXMKICAgICAgICAgICAgICBuMi5lbCA9IG4xLmVsOwogICAgICAgICAgICAgIGluc3RhbmNlLnZub2RlID0gbjI7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHNldHVwUmVuZGVyRWZmZWN0ID0gKGluc3RhbmNlLCBpbml0aWFsVk5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgY29uc3QgY29tcG9uZW50VXBkYXRlRm4gPSAoKSA9PiB7CiAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5pc01vdW50ZWQpIHsKICAgICAgICAgICAgICAgICAgbGV0IHZub2RlSG9vazsKICAgICAgICAgICAgICAgICAgY29uc3QgeyBlbCwgcHJvcHMgfSA9IGluaXRpYWxWTm9kZTsKICAgICAgICAgICAgICAgICAgY29uc3QgeyBibSwgbSwgcGFyZW50IH0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgY29uc3QgaXNBc3luY1dyYXBwZXJWTm9kZSA9IGlzQXN5bmNXcmFwcGVyKGluaXRpYWxWTm9kZSk7CiAgICAgICAgICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgLy8gYmVmb3JlTW91bnQgaG9vawogICAgICAgICAgICAgICAgICBpZiAoYm0pIHsKICAgICAgICAgICAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGJtKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBvblZub2RlQmVmb3JlTW91bnQKICAgICAgICAgICAgICAgICAgaWYgKCFpc0FzeW5jV3JhcHBlclZOb2RlICYmCiAgICAgICAgICAgICAgICAgICAgICAodm5vZGVIb29rID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZUJlZm9yZU1vdW50KSkgewogICAgICAgICAgICAgICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50LCBpbml0aWFsVk5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIHRydWUpOwogICAgICAgICAgICAgICAgICBpZiAoZWwgJiYgaHlkcmF0ZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHZub2RlIGhhcyBhZG9wdGVkIGhvc3Qgbm9kZSAtIHBlcmZvcm0gaHlkcmF0aW9uIGluc3RlYWQgb2YgbW91bnQuCiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoeWRyYXRlU3ViVHJlZSA9ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5zdWJUcmVlID0gcmVuZGVyQ29tcG9uZW50Um9vdChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgcmVuZGVyYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgaHlkcmF0ZWApOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBoeWRyYXRlTm9kZShlbCwgaW5zdGFuY2Uuc3ViVHJlZSwgaW5zdGFuY2UsIHBhcmVudFN1c3BlbnNlLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGBoeWRyYXRlYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0FzeW5jV3JhcHBlclZOb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFZOb2RlLnR5cGUuX19hc3luY0xvYWRlcigpLnRoZW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90ZTogd2UgYXJlIG1vdmluZyB0aGUgcmVuZGVyIGNhbGwgaW50byBhbiBhc3luYyBjYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGljaCBtZWFucyBpdCB3b24ndCB0cmFjayBkZXBlbmRlbmNpZXMgLSBidXQgaXQncyBvayBiZWNhdXNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYSBzZXJ2ZXItcmVuZGVyZWQgYXN5bmMgd3JhcHBlciBpcyBhbHJlYWR5IGluIHJlc29sdmVkIHN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGl0IHdpbGwgbmV2ZXIgbmVlZCB0byBjaGFuZ2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4gIWluc3RhbmNlLmlzVW5tb3VudGVkICYmIGh5ZHJhdGVTdWJUcmVlKCkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaHlkcmF0ZVN1YlRyZWUoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YlRyZWUgPSAoaW5zdGFuY2Uuc3ViVHJlZSA9IHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpKTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgcmVuZGVyYCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgcGF0Y2hgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhdGNoKG51bGwsIHN1YlRyZWUsIGNvbnRhaW5lciwgYW5jaG9yLCBpbnN0YW5jZSwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHKTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgcGF0Y2hgKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxWTm9kZS5lbCA9IHN1YlRyZWUuZWw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gbW91bnRlZCBob29rCiAgICAgICAgICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgICAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QobSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIG9uVm5vZGVNb3VudGVkCiAgICAgICAgICAgICAgICAgIGlmICghaXNBc3luY1dyYXBwZXJWTm9kZSAmJgogICAgICAgICAgICAgICAgICAgICAgKHZub2RlSG9vayA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVNb3VudGVkKSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2NvcGVkSW5pdGlhbFZOb2RlID0gaW5pdGlhbFZOb2RlOwogICAgICAgICAgICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIHBhcmVudCwgc2NvcGVkSW5pdGlhbFZOb2RlKSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIGFjdGl2YXRlZCBob29rIGZvciBrZWVwLWFsaXZlIHJvb3RzLgogICAgICAgICAgICAgICAgICAvLyAjMTc0MiBhY3RpdmF0ZWQgaG9vayBtdXN0IGJlIGFjY2Vzc2VkIGFmdGVyIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB0aGUgaG9vayBtYXkgYmUgaW5qZWN0ZWQgYnkgYSBjaGlsZCBrZWVwLWFsaXZlCiAgICAgICAgICAgICAgICAgIGlmIChpbml0aWFsVk5vZGUuc2hhcGVGbGFnICYgMjU2IC8qIENPTVBPTkVOVF9TSE9VTERfS0VFUF9BTElWRSAqLyB8fAogICAgICAgICAgICAgICAgICAgICAgKHBhcmVudCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIGlzQXN5bmNXcmFwcGVyKHBhcmVudC52bm9kZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQudm5vZGUuc2hhcGVGbGFnICYgMjU2IC8qIENPTVBPTkVOVF9TSE9VTERfS0VFUF9BTElWRSAqLykpIHsKICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmEgJiYgcXVldWVQb3N0UmVuZGVyRWZmZWN0KGluc3RhbmNlLmEsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5pc01vdW50ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBkZXZ0b29sc0NvbXBvbmVudEFkZGVkKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyAjMjQ1ODogZGVmZXJlbmNlIG1vdW50LW9ubHkgb2JqZWN0IHBhcmFtZXRlcnMgdG8gcHJldmVudCBtZW1sZWFrcwogICAgICAgICAgICAgICAgICBpbml0aWFsVk5vZGUgPSBjb250YWluZXIgPSBhbmNob3IgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlQ29tcG9uZW50CiAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgdHJpZ2dlcmVkIGJ5IG11dGF0aW9uIG9mIGNvbXBvbmVudCdzIG93biBzdGF0ZSAobmV4dDogbnVsbCkKICAgICAgICAgICAgICAgICAgLy8gT1IgcGFyZW50IGNhbGxpbmcgcHJvY2Vzc0NvbXBvbmVudCAobmV4dDogVk5vZGUpCiAgICAgICAgICAgICAgICAgIGxldCB7IG5leHQsIGJ1LCB1LCBwYXJlbnQsIHZub2RlIH0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgbGV0IG9yaWdpbk5leHQgPSBuZXh0OwogICAgICAgICAgICAgICAgICBsZXQgdm5vZGVIb29rOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQobmV4dCB8fCBpbnN0YW5jZS52bm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gRGlzYWxsb3cgY29tcG9uZW50IGVmZmVjdCByZWN1cnNpb24gZHVyaW5nIHByZS1saWZlY3ljbGUgaG9va3MuCiAgICAgICAgICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5leHQuZWwgPSB2bm9kZS5lbDsKICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudFByZVJlbmRlcihpbnN0YW5jZSwgbmV4dCwgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSB2bm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBiZWZvcmVVcGRhdGUgaG9vawogICAgICAgICAgICAgICAgICBpZiAoYnUpIHsKICAgICAgICAgICAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGJ1KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBvblZub2RlQmVmb3JlVXBkYXRlCiAgICAgICAgICAgICAgICAgIGlmICgodm5vZGVIb29rID0gbmV4dC5wcm9wcyAmJiBuZXh0LnByb3BzLm9uVm5vZGVCZWZvcmVVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIG5leHQsIHZub2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0b2dnbGVSZWN1cnNlKGluc3RhbmNlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgLy8gcmVuZGVyCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRUcmVlID0gcmVuZGVyQ29tcG9uZW50Um9vdChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb25zdCBwcmV2VHJlZSA9IGluc3RhbmNlLnN1YlRyZWU7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnN1YlRyZWUgPSBuZXh0VHJlZTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgcGF0Y2hgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwYXRjaChwcmV2VHJlZSwgbmV4dFRyZWUsIAogICAgICAgICAgICAgICAgICAvLyBwYXJlbnQgbWF5IGhhdmUgY2hhbmdlZCBpZiBpdCdzIGluIGEgdGVsZXBvcnQKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudE5vZGUocHJldlRyZWUuZWwpLCAKICAgICAgICAgICAgICAgICAgLy8gYW5jaG9yIG1heSBoYXZlIGNoYW5nZWQgaWYgaXQncyBpbiBhIGZyYWdtZW50CiAgICAgICAgICAgICAgICAgIGdldE5leHRIb3N0Tm9kZShwcmV2VHJlZSksIGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgcGF0Y2hgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBuZXh0LmVsID0gbmV4dFRyZWUuZWw7CiAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5OZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBzZWxmLXRyaWdnZXJlZCB1cGRhdGUuIEluIGNhc2Ugb2YgSE9DLCB1cGRhdGUgcGFyZW50IGNvbXBvbmVudAogICAgICAgICAgICAgICAgICAgICAgLy8gdm5vZGUgZWwuIEhPQyBpcyBpbmRpY2F0ZWQgYnkgcGFyZW50IGluc3RhbmNlJ3Mgc3ViVHJlZSBwb2ludGluZwogICAgICAgICAgICAgICAgICAgICAgLy8gdG8gY2hpbGQgY29tcG9uZW50J3Mgdm5vZGUKICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUhPQ0hvc3RFbChpbnN0YW5jZSwgbmV4dFRyZWUuZWwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZWQgaG9vawogICAgICAgICAgICAgICAgICBpZiAodSkgewogICAgICAgICAgICAgICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KHUsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBvblZub2RlVXBkYXRlZAogICAgICAgICAgICAgICAgICBpZiAoKHZub2RlSG9vayA9IG5leHQucHJvcHMgJiYgbmV4dC5wcm9wcy5vblZub2RlVXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIG5leHQsIHZub2RlKSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50VXBkYXRlZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgcG9wV2FybmluZ0NvbnRleHQoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICAvLyBjcmVhdGUgcmVhY3RpdmUgZWZmZWN0IGZvciByZW5kZXJpbmcKICAgICAgICAgIGNvbnN0IGVmZmVjdCA9IChpbnN0YW5jZS5lZmZlY3QgPSBuZXcgUmVhY3RpdmVFZmZlY3QoY29tcG9uZW50VXBkYXRlRm4sICgpID0+IHF1ZXVlSm9iKHVwZGF0ZSksIGluc3RhbmNlLnNjb3BlIC8vIHRyYWNrIGl0IGluIGNvbXBvbmVudCdzIGVmZmVjdCBzY29wZQogICAgICAgICAgKSk7CiAgICAgICAgICBjb25zdCB1cGRhdGUgPSAoaW5zdGFuY2UudXBkYXRlID0gKCkgPT4gZWZmZWN0LnJ1bigpKTsKICAgICAgICAgIHVwZGF0ZS5pZCA9IGluc3RhbmNlLnVpZDsKICAgICAgICAgIC8vIGFsbG93UmVjdXJzZQogICAgICAgICAgLy8gIzE4MDEsICMyMDQzIGNvbXBvbmVudCByZW5kZXIgZWZmZWN0cyBzaG91bGQgYWxsb3cgcmVjdXJzaXZlIHVwZGF0ZXMKICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIHRydWUpOwogICAgICAgICAgewogICAgICAgICAgICAgIGVmZmVjdC5vblRyYWNrID0gaW5zdGFuY2UucnRjCiAgICAgICAgICAgICAgICAgID8gZSA9PiBpbnZva2VBcnJheUZucyhpbnN0YW5jZS5ydGMsIGUpCiAgICAgICAgICAgICAgICAgIDogdm9pZCAwOwogICAgICAgICAgICAgIGVmZmVjdC5vblRyaWdnZXIgPSBpbnN0YW5jZS5ydGcKICAgICAgICAgICAgICAgICAgPyBlID0+IGludm9rZUFycmF5Rm5zKGluc3RhbmNlLnJ0ZywgZSkKICAgICAgICAgICAgICAgICAgOiB2b2lkIDA7CiAgICAgICAgICAgICAgdXBkYXRlLm93bmVySW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZSgpOwogICAgICB9OwogICAgICBjb25zdCB1cGRhdGVDb21wb25lbnRQcmVSZW5kZXIgPSAoaW5zdGFuY2UsIG5leHRWTm9kZSwgb3B0aW1pemVkKSA9PiB7CiAgICAgICAgICBuZXh0Vk5vZGUuY29tcG9uZW50ID0gaW5zdGFuY2U7CiAgICAgICAgICBjb25zdCBwcmV2UHJvcHMgPSBpbnN0YW5jZS52bm9kZS5wcm9wczsKICAgICAgICAgIGluc3RhbmNlLnZub2RlID0gbmV4dFZOb2RlOwogICAgICAgICAgaW5zdGFuY2UubmV4dCA9IG51bGw7CiAgICAgICAgICB1cGRhdGVQcm9wcyhpbnN0YW5jZSwgbmV4dFZOb2RlLnByb3BzLCBwcmV2UHJvcHMsIG9wdGltaXplZCk7CiAgICAgICAgICB1cGRhdGVTbG90cyhpbnN0YW5jZSwgbmV4dFZOb2RlLmNoaWxkcmVuLCBvcHRpbWl6ZWQpOwogICAgICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICAgICAgLy8gcHJvcHMgdXBkYXRlIG1heSBoYXZlIHRyaWdnZXJlZCBwcmUtZmx1c2ggd2F0Y2hlcnMuCiAgICAgICAgICAvLyBmbHVzaCB0aGVtIGJlZm9yZSB0aGUgcmVuZGVyIHVwZGF0ZS4KICAgICAgICAgIGZsdXNoUHJlRmx1c2hDYnModW5kZWZpbmVkLCBpbnN0YW5jZS51cGRhdGUpOwogICAgICAgICAgcmVzZXRUcmFja2luZygpOwogICAgICB9OwogICAgICBjb25zdCBwYXRjaENoaWxkcmVuID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCA9IGZhbHNlKSA9PiB7CiAgICAgICAgICBjb25zdCBjMSA9IG4xICYmIG4xLmNoaWxkcmVuOwogICAgICAgICAgY29uc3QgcHJldlNoYXBlRmxhZyA9IG4xID8gbjEuc2hhcGVGbGFnIDogMDsKICAgICAgICAgIGNvbnN0IGMyID0gbjIuY2hpbGRyZW47CiAgICAgICAgICBjb25zdCB7IHBhdGNoRmxhZywgc2hhcGVGbGFnIH0gPSBuMjsKICAgICAgICAgIC8vIGZhc3QgcGF0aAogICAgICAgICAgaWYgKHBhdGNoRmxhZyA+IDApIHsKICAgICAgICAgICAgICBpZiAocGF0Y2hGbGFnICYgMTI4IC8qIEtFWUVEX0ZSQUdNRU5UICovKSB7CiAgICAgICAgICAgICAgICAgIC8vIHRoaXMgY291bGQgYmUgZWl0aGVyIGZ1bGx5LWtleWVkIG9yIG1peGVkIChzb21lIGtleWVkIHNvbWUgbm90KQogICAgICAgICAgICAgICAgICAvLyBwcmVzZW5jZSBvZiBwYXRjaEZsYWcgbWVhbnMgY2hpbGRyZW4gYXJlIGd1YXJhbnRlZWQgdG8gYmUgYXJyYXlzCiAgICAgICAgICAgICAgICAgIHBhdGNoS2V5ZWRDaGlsZHJlbihjMSwgYzIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKHBhdGNoRmxhZyAmIDI1NiAvKiBVTktFWUVEX0ZSQUdNRU5UICovKSB7CiAgICAgICAgICAgICAgICAgIC8vIHVua2V5ZWQKICAgICAgICAgICAgICAgICAgcGF0Y2hVbmtleWVkQ2hpbGRyZW4oYzEsIGMyLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIGNoaWxkcmVuIGhhcyAzIHBvc3NpYmlsaXRpZXM6IHRleHQsIGFycmF5IG9yIG5vIGNoaWxkcmVuLgogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDggLyogVEVYVF9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgIC8vIHRleHQgY2hpbGRyZW4gZmFzdCBwYXRoCiAgICAgICAgICAgICAgaWYgKHByZXZTaGFwZUZsYWcgJiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4oYzEsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYzIgIT09IGMxKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChjb250YWluZXIsIGMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBpZiAocHJldlNoYXBlRmxhZyAmIDE2IC8qIEFSUkFZX0NISUxEUkVOICovKSB7CiAgICAgICAgICAgICAgICAgIC8vIHByZXYgY2hpbGRyZW4gd2FzIGFycmF5CiAgICAgICAgICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgICAgICAgICAgLy8gdHdvIGFycmF5cywgY2Fubm90IGFzc3VtZSBhbnl0aGluZywgZG8gZnVsbCBkaWZmCiAgICAgICAgICAgICAgICAgICAgICBwYXRjaEtleWVkQ2hpbGRyZW4oYzEsIGMyLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIG5ldyBjaGlsZHJlbiwganVzdCB1bm1vdW50IG9sZAogICAgICAgICAgICAgICAgICAgICAgdW5tb3VudENoaWxkcmVuKGMxLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gcHJldiBjaGlsZHJlbiB3YXMgdGV4dCBPUiBudWxsCiAgICAgICAgICAgICAgICAgIC8vIG5ldyBjaGlsZHJlbiBpcyBhcnJheSBPUiBudWxsCiAgICAgICAgICAgICAgICAgIGlmIChwcmV2U2hhcGVGbGFnICYgOCAvKiBURVhUX0NISUxEUkVOICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBob3N0U2V0RWxlbWVudFRleHQoY29udGFpbmVyLCAnJyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gbW91bnQgbmV3IGlmIGFycmF5CiAgICAgICAgICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgICAgICAgICAgbW91bnRDaGlsZHJlbihjMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IHBhdGNoVW5rZXllZENoaWxkcmVuID0gKGMxLCBjMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gewogICAgICAgICAgYzEgPSBjMSB8fCBFTVBUWV9BUlI7CiAgICAgICAgICBjMiA9IGMyIHx8IEVNUFRZX0FSUjsKICAgICAgICAgIGNvbnN0IG9sZExlbmd0aCA9IGMxLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG5ld0xlbmd0aCA9IGMyLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IGNvbW1vbkxlbmd0aCA9IE1hdGgubWluKG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbW1vbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgbmV4dENoaWxkID0gKGMyW2ldID0gb3B0aW1pemVkCiAgICAgICAgICAgICAgICAgID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pCiAgICAgICAgICAgICAgICAgIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pKTsKICAgICAgICAgICAgICBwYXRjaChjMVtpXSwgbmV4dENoaWxkLCBjb250YWluZXIsIG51bGwsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkTGVuZ3RoID4gbmV3TGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy8gcmVtb3ZlIG9sZAogICAgICAgICAgICAgIHVubW91bnRDaGlsZHJlbihjMSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdHJ1ZSwgZmFsc2UsIGNvbW1vbkxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyBtb3VudCBuZXcKICAgICAgICAgICAgICBtb3VudENoaWxkcmVuKGMyLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgaXNTVkcsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCBjb21tb25MZW5ndGgpOwogICAgICAgICAgfQogICAgICB9OwogICAgICAvLyBjYW4gYmUgYWxsLWtleWVkIG9yIG1peGVkCiAgICAgIGNvbnN0IHBhdGNoS2V5ZWRDaGlsZHJlbiA9IChjMSwgYzIsIGNvbnRhaW5lciwgcGFyZW50QW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICAgIGxldCBpID0gMDsKICAgICAgICAgIGNvbnN0IGwyID0gYzIubGVuZ3RoOwogICAgICAgICAgbGV0IGUxID0gYzEubGVuZ3RoIC0gMTsgLy8gcHJldiBlbmRpbmcgaW5kZXgKICAgICAgICAgIGxldCBlMiA9IGwyIC0gMTsgLy8gbmV4dCBlbmRpbmcgaW5kZXgKICAgICAgICAgIC8vIDEuIHN5bmMgZnJvbSBzdGFydAogICAgICAgICAgLy8gKGEgYikgYwogICAgICAgICAgLy8gKGEgYikgZCBlCiAgICAgICAgICB3aGlsZSAoaSA8PSBlMSAmJiBpIDw9IGUyKSB7CiAgICAgICAgICAgICAgY29uc3QgbjEgPSBjMVtpXTsKICAgICAgICAgICAgICBjb25zdCBuMiA9IChjMltpXSA9IG9wdGltaXplZAogICAgICAgICAgICAgICAgICA/IGNsb25lSWZNb3VudGVkKGMyW2ldKQogICAgICAgICAgICAgICAgICA6IG5vcm1hbGl6ZVZOb2RlKGMyW2ldKSk7CiAgICAgICAgICAgICAgaWYgKGlzU2FtZVZOb2RlVHlwZShuMSwgbjIpKSB7CiAgICAgICAgICAgICAgICAgIHBhdGNoKG4xLCBuMiwgY29udGFpbmVyLCBudWxsLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGkrKzsKICAgICAgICAgIH0KICAgICAgICAgIC8vIDIuIHN5bmMgZnJvbSBlbmQKICAgICAgICAgIC8vIGEgKGIgYykKICAgICAgICAgIC8vIGQgZSAoYiBjKQogICAgICAgICAgd2hpbGUgKGkgPD0gZTEgJiYgaSA8PSBlMikgewogICAgICAgICAgICAgIGNvbnN0IG4xID0gYzFbZTFdOwogICAgICAgICAgICAgIGNvbnN0IG4yID0gKGMyW2UyXSA9IG9wdGltaXplZAogICAgICAgICAgICAgICAgICA/IGNsb25lSWZNb3VudGVkKGMyW2UyXSkKICAgICAgICAgICAgICAgICAgOiBub3JtYWxpemVWTm9kZShjMltlMl0pKTsKICAgICAgICAgICAgICBpZiAoaXNTYW1lVk5vZGVUeXBlKG4xLCBuMikpIHsKICAgICAgICAgICAgICAgICAgcGF0Y2gobjEsIG4yLCBjb250YWluZXIsIG51bGwsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZTEtLTsKICAgICAgICAgICAgICBlMi0tOwogICAgICAgICAgfQogICAgICAgICAgLy8gMy4gY29tbW9uIHNlcXVlbmNlICsgbW91bnQKICAgICAgICAgIC8vIChhIGIpCiAgICAgICAgICAvLyAoYSBiKSBjCiAgICAgICAgICAvLyBpID0gMiwgZTEgPSAxLCBlMiA9IDIKICAgICAgICAgIC8vIChhIGIpCiAgICAgICAgICAvLyBjIChhIGIpCiAgICAgICAgICAvLyBpID0gMCwgZTEgPSAtMSwgZTIgPSAwCiAgICAgICAgICBpZiAoaSA+IGUxKSB7CiAgICAgICAgICAgICAgaWYgKGkgPD0gZTIpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFBvcyA9IGUyICsgMTsKICAgICAgICAgICAgICAgICAgY29uc3QgYW5jaG9yID0gbmV4dFBvcyA8IGwyID8gYzJbbmV4dFBvc10uZWwgOiBwYXJlbnRBbmNob3I7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChpIDw9IGUyKSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXRjaChudWxsLCAoYzJbaV0gPSBvcHRpbWl6ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNsb25lSWZNb3VudGVkKGMyW2ldKQogICAgICAgICAgICAgICAgICAgICAgICAgIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pKSwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyA0LiBjb21tb24gc2VxdWVuY2UgKyB1bm1vdW50CiAgICAgICAgICAvLyAoYSBiKSBjCiAgICAgICAgICAvLyAoYSBiKQogICAgICAgICAgLy8gaSA9IDIsIGUxID0gMiwgZTIgPSAxCiAgICAgICAgICAvLyBhIChiIGMpCiAgICAgICAgICAvLyAoYiBjKQogICAgICAgICAgLy8gaSA9IDAsIGUxID0gMCwgZTIgPSAtMQogICAgICAgICAgZWxzZSBpZiAoaSA+IGUyKSB7CiAgICAgICAgICAgICAgd2hpbGUgKGkgPD0gZTEpIHsKICAgICAgICAgICAgICAgICAgdW5tb3VudChjMVtpXSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyA1LiB1bmtub3duIHNlcXVlbmNlCiAgICAgICAgICAvLyBbaSAuLi4gZTEgKyAxXTogYSBiIFtjIGQgZV0gZiBnCiAgICAgICAgICAvLyBbaSAuLi4gZTIgKyAxXTogYSBiIFtlIGQgYyBoXSBmIGcKICAgICAgICAgIC8vIGkgPSAyLCBlMSA9IDQsIGUyID0gNQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgY29uc3QgczEgPSBpOyAvLyBwcmV2IHN0YXJ0aW5nIGluZGV4CiAgICAgICAgICAgICAgY29uc3QgczIgPSBpOyAvLyBuZXh0IHN0YXJ0aW5nIGluZGV4CiAgICAgICAgICAgICAgLy8gNS4xIGJ1aWxkIGtleTppbmRleCBtYXAgZm9yIG5ld0NoaWxkcmVuCiAgICAgICAgICAgICAgY29uc3Qga2V5VG9OZXdJbmRleE1hcCA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICBmb3IgKGkgPSBzMjsgaSA8PSBlMjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IChjMltpXSA9IG9wdGltaXplZAogICAgICAgICAgICAgICAgICAgICAgPyBjbG9uZUlmTW91bnRlZChjMltpXSkKICAgICAgICAgICAgICAgICAgICAgIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRDaGlsZC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGtleVRvTmV3SW5kZXhNYXAuaGFzKG5leHRDaGlsZC5rZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGBEdXBsaWNhdGUga2V5cyBmb3VuZCBkdXJpbmcgdXBkYXRlOmAsIEpTT04uc3RyaW5naWZ5KG5leHRDaGlsZC5rZXkpLCBgTWFrZSBzdXJlIGtleXMgYXJlIHVuaXF1ZS5gKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGtleVRvTmV3SW5kZXhNYXAuc2V0KG5leHRDaGlsZC5rZXksIGkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIDUuMiBsb29wIHRocm91Z2ggb2xkIGNoaWxkcmVuIGxlZnQgdG8gYmUgcGF0Y2hlZCBhbmQgdHJ5IHRvIHBhdGNoCiAgICAgICAgICAgICAgLy8gbWF0Y2hpbmcgbm9kZXMgJiByZW1vdmUgbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQKICAgICAgICAgICAgICBsZXQgajsKICAgICAgICAgICAgICBsZXQgcGF0Y2hlZCA9IDA7CiAgICAgICAgICAgICAgY29uc3QgdG9CZVBhdGNoZWQgPSBlMiAtIHMyICsgMTsKICAgICAgICAgICAgICBsZXQgbW92ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAvLyB1c2VkIHRvIHRyYWNrIHdoZXRoZXIgYW55IG5vZGUgaGFzIG1vdmVkCiAgICAgICAgICAgICAgbGV0IG1heE5ld0luZGV4U29GYXIgPSAwOwogICAgICAgICAgICAgIC8vIHdvcmtzIGFzIE1hcDxuZXdJbmRleCwgb2xkSW5kZXg+CiAgICAgICAgICAgICAgLy8gTm90ZSB0aGF0IG9sZEluZGV4IGlzIG9mZnNldCBieSArMQogICAgICAgICAgICAgIC8vIGFuZCBvbGRJbmRleCA9IDAgaXMgYSBzcGVjaWFsIHZhbHVlIGluZGljYXRpbmcgdGhlIG5ldyBub2RlIGhhcwogICAgICAgICAgICAgIC8vIG5vIGNvcnJlc3BvbmRpbmcgb2xkIG5vZGUuCiAgICAgICAgICAgICAgLy8gdXNlZCBmb3IgZGV0ZXJtaW5pbmcgbG9uZ2VzdCBzdGFibGUgc3Vic2VxdWVuY2UKICAgICAgICAgICAgICBjb25zdCBuZXdJbmRleFRvT2xkSW5kZXhNYXAgPSBuZXcgQXJyYXkodG9CZVBhdGNoZWQpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b0JlUGF0Y2hlZDsgaSsrKQogICAgICAgICAgICAgICAgICBuZXdJbmRleFRvT2xkSW5kZXhNYXBbaV0gPSAwOwogICAgICAgICAgICAgIGZvciAoaSA9IHMxOyBpIDw9IGUxOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3QgcHJldkNoaWxkID0gYzFbaV07CiAgICAgICAgICAgICAgICAgIGlmIChwYXRjaGVkID49IHRvQmVQYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBhbGwgbmV3IGNoaWxkcmVuIGhhdmUgYmVlbiBwYXRjaGVkIHNvIHRoaXMgY2FuIG9ubHkgYmUgYSByZW1vdmFsCiAgICAgICAgICAgICAgICAgICAgICB1bm1vdW50KHByZXZDaGlsZCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBsZXQgbmV3SW5kZXg7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2Q2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIG5ld0luZGV4ID0ga2V5VG9OZXdJbmRleE1hcC5nZXQocHJldkNoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBrZXktbGVzcyBub2RlLCB0cnkgdG8gbG9jYXRlIGEga2V5LWxlc3Mgbm9kZSBvZiB0aGUgc2FtZSB0eXBlCiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSBzMjsgaiA8PSBlMjsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0luZGV4VG9PbGRJbmRleE1hcFtqIC0gczJdID09PSAwICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzU2FtZVZOb2RlVHlwZShwcmV2Q2hpbGQsIGMyW2pdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJbmRleCA9IGo7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobmV3SW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgdW5tb3VudChwcmV2Q2hpbGQsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbmV3SW5kZXhUb09sZEluZGV4TWFwW25ld0luZGV4IC0gczJdID0gaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SW5kZXggPj0gbWF4TmV3SW5kZXhTb0ZhcikgewogICAgICAgICAgICAgICAgICAgICAgICAgIG1heE5ld0luZGV4U29GYXIgPSBuZXdJbmRleDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhdGNoKHByZXZDaGlsZCwgYzJbbmV3SW5kZXhdLCBjb250YWluZXIsIG51bGwsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgICAgICBwYXRjaGVkKys7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gNS4zIG1vdmUgYW5kIG1vdW50CiAgICAgICAgICAgICAgLy8gZ2VuZXJhdGUgbG9uZ2VzdCBzdGFibGUgc3Vic2VxdWVuY2Ugb25seSB3aGVuIG5vZGVzIGhhdmUgbW92ZWQKICAgICAgICAgICAgICBjb25zdCBpbmNyZWFzaW5nTmV3SW5kZXhTZXF1ZW5jZSA9IG1vdmVkCiAgICAgICAgICAgICAgICAgID8gZ2V0U2VxdWVuY2UobmV3SW5kZXhUb09sZEluZGV4TWFwKQogICAgICAgICAgICAgICAgICA6IEVNUFRZX0FSUjsKICAgICAgICAgICAgICBqID0gaW5jcmVhc2luZ05ld0luZGV4U2VxdWVuY2UubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAvLyBsb29waW5nIGJhY2t3YXJkcyBzbyB0aGF0IHdlIGNhbiB1c2UgbGFzdCBwYXRjaGVkIG5vZGUgYXMgYW5jaG9yCiAgICAgICAgICAgICAgZm9yIChpID0gdG9CZVBhdGNoZWQgLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICBjb25zdCBuZXh0SW5kZXggPSBzMiArIGk7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW25leHRJbmRleF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFuY2hvciA9IG5leHRJbmRleCArIDEgPCBsMiA/IGMyW25leHRJbmRleCArIDFdLmVsIDogcGFyZW50QW5jaG9yOwogICAgICAgICAgICAgICAgICBpZiAobmV3SW5kZXhUb09sZEluZGV4TWFwW2ldID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBtb3VudCBuZXcKICAgICAgICAgICAgICAgICAgICAgIHBhdGNoKG51bGwsIG5leHRDaGlsZCwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobW92ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIG1vdmUgaWY6CiAgICAgICAgICAgICAgICAgICAgICAvLyBUaGVyZSBpcyBubyBzdGFibGUgc3Vic2VxdWVuY2UgKGUuZy4gYSByZXZlcnNlKQogICAgICAgICAgICAgICAgICAgICAgLy8gT1IgY3VycmVudCBub2RlIGlzIG5vdCBhbW9uZyB0aGUgc3RhYmxlIHNlcXVlbmNlCiAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA8IDAgfHwgaSAhPT0gaW5jcmVhc2luZ05ld0luZGV4U2VxdWVuY2Vbal0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlKG5leHRDaGlsZCwgY29udGFpbmVyLCBhbmNob3IsIDIgLyogUkVPUkRFUiAqLyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBqLS07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG1vdmUgPSAodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBtb3ZlVHlwZSwgcGFyZW50U3VzcGVuc2UgPSBudWxsKSA9PiB7CiAgICAgICAgICBjb25zdCB7IGVsLCB0eXBlLCB0cmFuc2l0aW9uLCBjaGlsZHJlbiwgc2hhcGVGbGFnIH0gPSB2bm9kZTsKICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiA2IC8qIENPTVBPTkVOVCAqLykgewogICAgICAgICAgICAgIG1vdmUodm5vZGUuY29tcG9uZW50LnN1YlRyZWUsIGNvbnRhaW5lciwgYW5jaG9yLCBtb3ZlVHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEyOCAvKiBTVVNQRU5TRSAqLykgewogICAgICAgICAgICAgIHZub2RlLnN1c3BlbnNlLm1vdmUoY29udGFpbmVyLCBhbmNob3IsIG1vdmVUeXBlKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgNjQgLyogVEVMRVBPUlQgKi8pIHsKICAgICAgICAgICAgICB0eXBlLm1vdmUodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBpbnRlcm5hbHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBGcmFnbWVudCkgewogICAgICAgICAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIG1vdmUoY2hpbGRyZW5baV0sIGNvbnRhaW5lciwgYW5jaG9yLCBtb3ZlVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhvc3RJbnNlcnQodm5vZGUuYW5jaG9yLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFN0YXRpYykgewogICAgICAgICAgICAgIG1vdmVTdGF0aWNOb2RlKHZub2RlLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgLy8gc2luZ2xlIG5vZGVzCiAgICAgICAgICBjb25zdCBuZWVkVHJhbnNpdGlvbiA9IG1vdmVUeXBlICE9PSAyIC8qIFJFT1JERVIgKi8gJiYKICAgICAgICAgICAgICBzaGFwZUZsYWcgJiAxIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgICAgICB0cmFuc2l0aW9uOwogICAgICAgICAgaWYgKG5lZWRUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKG1vdmVUeXBlID09PSAwIC8qIEVOVEVSICovKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb24uYmVmb3JlRW50ZXIoZWwpOwogICAgICAgICAgICAgICAgICBob3N0SW5zZXJ0KGVsLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB0cmFuc2l0aW9uLmVudGVyKGVsKSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29uc3QgeyBsZWF2ZSwgZGVsYXlMZWF2ZSwgYWZ0ZXJMZWF2ZSB9ID0gdHJhbnNpdGlvbjsKICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlID0gKCkgPT4gaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgICAgICAgICBjb25zdCBwZXJmb3JtTGVhdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBsZWF2ZShlbCwgKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTGVhdmUgJiYgYWZ0ZXJMZWF2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmIChkZWxheUxlYXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZWxheUxlYXZlKGVsLCByZW1vdmUsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBwZXJmb3JtTGVhdmUoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGhvc3RJbnNlcnQoZWwsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgdW5tb3VudCA9ICh2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUgPSBmYWxzZSwgb3B0aW1pemVkID0gZmFsc2UpID0+IHsKICAgICAgICAgIGNvbnN0IHsgdHlwZSwgcHJvcHMsIHJlZiwgY2hpbGRyZW4sIGR5bmFtaWNDaGlsZHJlbiwgc2hhcGVGbGFnLCBwYXRjaEZsYWcsIGRpcnMgfSA9IHZub2RlOwogICAgICAgICAgLy8gdW5zZXQgcmVmCiAgICAgICAgICBpZiAocmVmICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRSZWYocmVmLCBudWxsLCBwYXJlbnRTdXNwZW5zZSwgdm5vZGUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDI1NiAvKiBDT01QT05FTlRfU0hPVUxEX0tFRVBfQUxJVkUgKi8pIHsKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQuY3R4LmRlYWN0aXZhdGUodm5vZGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHNob3VsZEludm9rZURpcnMgPSBzaGFwZUZsYWcgJiAxIC8qIEVMRU1FTlQgKi8gJiYgZGlyczsKICAgICAgICAgIGNvbnN0IHNob3VsZEludm9rZVZub2RlSG9vayA9ICFpc0FzeW5jV3JhcHBlcih2bm9kZSk7CiAgICAgICAgICBsZXQgdm5vZGVIb29rOwogICAgICAgICAgaWYgKHNob3VsZEludm9rZVZub2RlSG9vayAmJgogICAgICAgICAgICAgICh2bm9kZUhvb2sgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlQmVmb3JlVW5tb3VudCkpIHsKICAgICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiA2IC8qIENPTVBPTkVOVCAqLykgewogICAgICAgICAgICAgIHVubW91bnRDb21wb25lbnQodm5vZGUuY29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEyOCAvKiBTVVNQRU5TRSAqLykgewogICAgICAgICAgICAgICAgICB2bm9kZS5zdXNwZW5zZS51bm1vdW50KHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZEludm9rZURpcnMpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAnYmVmb3JlVW5tb3VudCcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgNjQgLyogVEVMRVBPUlQgKi8pIHsKICAgICAgICAgICAgICAgICAgdm5vZGUudHlwZS5yZW1vdmUodm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG9wdGltaXplZCwgaW50ZXJuYWxzLCBkb1JlbW92ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGR5bmFtaWNDaGlsZHJlbiAmJgogICAgICAgICAgICAgICAgICAvLyAjMTE1MzogZmFzdCBwYXRoIHNob3VsZCBub3QgYmUgdGFrZW4gZm9yIG5vbi1zdGFibGUgKHYtZm9yKSBmcmFnbWVudHMKICAgICAgICAgICAgICAgICAgKHR5cGUgIT09IEZyYWdtZW50IHx8CiAgICAgICAgICAgICAgICAgICAgICAocGF0Y2hGbGFnID4gMCAmJiBwYXRjaEZsYWcgJiA2NCAvKiBTVEFCTEVfRlJBR01FTlQgKi8pKSkgewogICAgICAgICAgICAgICAgICAvLyBmYXN0IHBhdGggZm9yIGJsb2NrIG5vZGVzOiBvbmx5IG5lZWQgdG8gdW5tb3VudCBkeW5hbWljIGNoaWxkcmVuLgogICAgICAgICAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4oZHluYW1pY0NoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCh0eXBlID09PSBGcmFnbWVudCAmJgogICAgICAgICAgICAgICAgICBwYXRjaEZsYWcgJgogICAgICAgICAgICAgICAgICAgICAgKDEyOCAvKiBLRVlFRF9GUkFHTUVOVCAqLyB8IDI1NiAvKiBVTktFWUVEX0ZSQUdNRU5UICovKSkgfHwKICAgICAgICAgICAgICAgICAgKCFvcHRpbWl6ZWQgJiYgc2hhcGVGbGFnICYgMTYgLyogQVJSQVlfQ0hJTERSRU4gKi8pKSB7CiAgICAgICAgICAgICAgICAgIHVubW91bnRDaGlsZHJlbihjaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkb1JlbW92ZSkgewogICAgICAgICAgICAgICAgICByZW1vdmUodm5vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgoc2hvdWxkSW52b2tlVm5vZGVIb29rICYmCiAgICAgICAgICAgICAgKHZub2RlSG9vayA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVVbm1vdW50ZWQpKSB8fAogICAgICAgICAgICAgIHNob3VsZEludm9rZURpcnMpIHsKICAgICAgICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gewogICAgICAgICAgICAgICAgICB2bm9kZUhvb2sgJiYgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7CiAgICAgICAgICAgICAgICAgIHNob3VsZEludm9rZURpcnMgJiYKICAgICAgICAgICAgICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgJ3VubW91bnRlZCcpOwogICAgICAgICAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgcmVtb3ZlID0gdm5vZGUgPT4gewogICAgICAgICAgY29uc3QgeyB0eXBlLCBlbCwgYW5jaG9yLCB0cmFuc2l0aW9uIH0gPSB2bm9kZTsKICAgICAgICAgIGlmICh0eXBlID09PSBGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmICh2bm9kZS5wYXRjaEZsYWcgPiAwICYmCiAgICAgICAgICAgICAgICAgIHZub2RlLnBhdGNoRmxhZyAmIDIwNDggLyogREVWX1JPT1RfRlJBR01FTlQgKi8gJiYKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbiAmJgogICAgICAgICAgICAgICAgICAhdHJhbnNpdGlvbi5wZXJzaXN0ZWQpIHsKICAgICAgICAgICAgICAgICAgdm5vZGUuY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PT0gQ29tbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RSZW1vdmUoY2hpbGQuZWwpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICByZW1vdmVGcmFnbWVudChlbCwgYW5jaG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFN0YXRpYykgewogICAgICAgICAgICAgIHJlbW92ZVN0YXRpY05vZGUodm5vZGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBlcmZvcm1SZW1vdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgaG9zdFJlbW92ZShlbCk7CiAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb24gJiYgIXRyYW5zaXRpb24ucGVyc2lzdGVkICYmIHRyYW5zaXRpb24uYWZ0ZXJMZWF2ZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLmFmdGVyTGVhdmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgICAgIHRyYW5zaXRpb24gJiYKICAgICAgICAgICAgICAhdHJhbnNpdGlvbi5wZXJzaXN0ZWQpIHsKICAgICAgICAgICAgICBjb25zdCB7IGxlYXZlLCBkZWxheUxlYXZlIH0gPSB0cmFuc2l0aW9uOwogICAgICAgICAgICAgIGNvbnN0IHBlcmZvcm1MZWF2ZSA9ICgpID0+IGxlYXZlKGVsLCBwZXJmb3JtUmVtb3ZlKTsKICAgICAgICAgICAgICBpZiAoZGVsYXlMZWF2ZSkgewogICAgICAgICAgICAgICAgICBkZWxheUxlYXZlKHZub2RlLmVsLCBwZXJmb3JtUmVtb3ZlLCBwZXJmb3JtTGVhdmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgcGVyZm9ybUxlYXZlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgcGVyZm9ybVJlbW92ZSgpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCByZW1vdmVGcmFnbWVudCA9IChjdXIsIGVuZCkgPT4gewogICAgICAgICAgLy8gRm9yIGZyYWdtZW50cywgZGlyZWN0bHkgcmVtb3ZlIGFsbCBjb250YWluZWQgRE9NIG5vZGVzLgogICAgICAgICAgLy8gKGZyYWdtZW50IGNoaWxkIG5vZGVzIGNhbm5vdCBoYXZlIHRyYW5zaXRpb24pCiAgICAgICAgICBsZXQgbmV4dDsKICAgICAgICAgIHdoaWxlIChjdXIgIT09IGVuZCkgewogICAgICAgICAgICAgIG5leHQgPSBob3N0TmV4dFNpYmxpbmcoY3VyKTsKICAgICAgICAgICAgICBob3N0UmVtb3ZlKGN1cik7CiAgICAgICAgICAgICAgY3VyID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGhvc3RSZW1vdmUoZW5kKTsKICAgICAgfTsKICAgICAgY29uc3QgdW5tb3VudENvbXBvbmVudCA9IChpbnN0YW5jZSwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlKSA9PiB7CiAgICAgICAgICBpZiAoaW5zdGFuY2UudHlwZS5fX2htcklkKSB7CiAgICAgICAgICAgICAgdW5yZWdpc3RlckhNUihpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB7IGJ1bSwgc2NvcGUsIHVwZGF0ZSwgc3ViVHJlZSwgdW0gfSA9IGluc3RhbmNlOwogICAgICAgICAgLy8gYmVmb3JlVW5tb3VudCBob29rCiAgICAgICAgICBpZiAoYnVtKSB7CiAgICAgICAgICAgICAgaW52b2tlQXJyYXlGbnMoYnVtKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHN0b3AgZWZmZWN0cyBpbiBjb21wb25lbnQgc2NvcGUKICAgICAgICAgIHNjb3BlLnN0b3AoKTsKICAgICAgICAgIC8vIHVwZGF0ZSBtYXkgYmUgbnVsbCBpZiBhIGNvbXBvbmVudCBpcyB1bm1vdW50ZWQgYmVmb3JlIGl0cyBhc3luYwogICAgICAgICAgLy8gc2V0dXAgaGFzIHJlc29sdmVkLgogICAgICAgICAgaWYgKHVwZGF0ZSkgewogICAgICAgICAgICAgIC8vIHNvIHRoYXQgc2NoZWR1bGVyIHdpbGwgbm8gbG9uZ2VyIGludm9rZSBpdAogICAgICAgICAgICAgIHVwZGF0ZS5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICB1bm1vdW50KHN1YlRyZWUsIGluc3RhbmNlLCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gdW5tb3VudGVkIGhvb2sKICAgICAgICAgIGlmICh1bSkgewogICAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCh1bSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICAgICAgICBpbnN0YW5jZS5pc1VubW91bnRlZCA9IHRydWU7CiAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICAvLyBBIGNvbXBvbmVudCB3aXRoIGFzeW5jIGRlcCBpbnNpZGUgYSBwZW5kaW5nIHN1c3BlbnNlIGlzIHVubW91bnRlZCBiZWZvcmUKICAgICAgICAgIC8vIGl0cyBhc3luYyBkZXAgcmVzb2x2ZXMuIFRoaXMgc2hvdWxkIHJlbW92ZSB0aGUgZGVwIGZyb20gdGhlIHN1c3BlbnNlLCBhbmQKICAgICAgICAgIC8vIGNhdXNlIHRoZSBzdXNwZW5zZSB0byByZXNvbHZlIGltbWVkaWF0ZWx5IGlmIHRoYXQgd2FzIHRoZSBsYXN0IGRlcC4KICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSAmJgogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggJiYKICAgICAgICAgICAgICAhcGFyZW50U3VzcGVuc2UuaXNVbm1vdW50ZWQgJiYKICAgICAgICAgICAgICBpbnN0YW5jZS5hc3luY0RlcCAmJgogICAgICAgICAgICAgICFpbnN0YW5jZS5hc3luY1Jlc29sdmVkICYmCiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3VzcGVuc2VJZCA9PT0gcGFyZW50U3VzcGVuc2UucGVuZGluZ0lkKSB7CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UuZGVwcy0tOwogICAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZS5kZXBzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLnJlc29sdmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgdW5tb3VudENoaWxkcmVuID0gKGNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSA9IGZhbHNlLCBvcHRpbWl6ZWQgPSBmYWxzZSwgc3RhcnQgPSAwKSA9PiB7CiAgICAgICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHVubW91bnQoY2hpbGRyZW5baV0sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlLCBvcHRpbWl6ZWQpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBnZXROZXh0SG9zdE5vZGUgPSB2bm9kZSA9PiB7CiAgICAgICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgNiAvKiBDT01QT05FTlQgKi8pIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0TmV4dEhvc3ROb2RlKHZub2RlLmNvbXBvbmVudC5zdWJUcmVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxMjggLyogU1VTUEVOU0UgKi8pIHsKICAgICAgICAgICAgICByZXR1cm4gdm5vZGUuc3VzcGVuc2UubmV4dCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3ROZXh0U2libGluZygodm5vZGUuYW5jaG9yIHx8IHZub2RlLmVsKSk7CiAgICAgIH07CiAgICAgIGNvbnN0IHJlbmRlciA9ICh2bm9kZSwgY29udGFpbmVyLCBpc1NWRykgPT4gewogICAgICAgICAgaWYgKHZub2RlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLl92bm9kZSkgewogICAgICAgICAgICAgICAgICB1bm1vdW50KGNvbnRhaW5lci5fdm5vZGUsIG51bGwsIG51bGwsIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHBhdGNoKGNvbnRhaW5lci5fdm5vZGUgfHwgbnVsbCwgdm5vZGUsIGNvbnRhaW5lciwgbnVsbCwgbnVsbCwgbnVsbCwgaXNTVkcpOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hQb3N0Rmx1c2hDYnMoKTsKICAgICAgICAgIGNvbnRhaW5lci5fdm5vZGUgPSB2bm9kZTsKICAgICAgfTsKICAgICAgY29uc3QgaW50ZXJuYWxzID0gewogICAgICAgICAgcDogcGF0Y2gsCiAgICAgICAgICB1bTogdW5tb3VudCwKICAgICAgICAgIG06IG1vdmUsCiAgICAgICAgICByOiByZW1vdmUsCiAgICAgICAgICBtdDogbW91bnRDb21wb25lbnQsCiAgICAgICAgICBtYzogbW91bnRDaGlsZHJlbiwKICAgICAgICAgIHBjOiBwYXRjaENoaWxkcmVuLAogICAgICAgICAgcGJjOiBwYXRjaEJsb2NrQ2hpbGRyZW4sCiAgICAgICAgICBuOiBnZXROZXh0SG9zdE5vZGUsCiAgICAgICAgICBvOiBvcHRpb25zCiAgICAgIH07CiAgICAgIGxldCBoeWRyYXRlOwogICAgICBsZXQgaHlkcmF0ZU5vZGU7CiAgICAgIGlmIChjcmVhdGVIeWRyYXRpb25GbnMpIHsKICAgICAgICAgIFtoeWRyYXRlLCBoeWRyYXRlTm9kZV0gPSBjcmVhdGVIeWRyYXRpb25GbnMoaW50ZXJuYWxzKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgcmVuZGVyLAogICAgICAgICAgaHlkcmF0ZSwKICAgICAgICAgIGNyZWF0ZUFwcDogY3JlYXRlQXBwQVBJKHJlbmRlciwgaHlkcmF0ZSkKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gdG9nZ2xlUmVjdXJzZSh7IGVmZmVjdCwgdXBkYXRlIH0sIGFsbG93ZWQpIHsKICAgICAgZWZmZWN0LmFsbG93UmVjdXJzZSA9IHVwZGF0ZS5hbGxvd1JlY3Vyc2UgPSBhbGxvd2VkOwogIH0KICAvKioKICAgKiAjMTE1NgogICAqIFdoZW4gYSBjb21wb25lbnQgaXMgSE1SLWVuYWJsZWQsIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYWxsIHN0YXRpYyBub2RlcwogICAqIGluc2lkZSBhIGJsb2NrIGFsc28gaW5oZXJpdCB0aGUgRE9NIGVsZW1lbnQgZnJvbSB0aGUgcHJldmlvdXMgdHJlZSBzbyB0aGF0CiAgICogSE1SIHVwZGF0ZXMgKHdoaWNoIGFyZSBmdWxsIHVwZGF0ZXMpIGNhbiByZXRyaWV2ZSB0aGUgZWxlbWVudCBmb3IgcGF0Y2hpbmcuCiAgICoKICAgKiAjMjA4MAogICAqIEluc2lkZSBrZXllZCBgdGVtcGxhdGVgIGZyYWdtZW50IHN0YXRpYyBjaGlsZHJlbiwgaWYgYSBmcmFnbWVudCBpcyBtb3ZlZCwKICAgKiB0aGUgY2hpbGRyZW4gd2lsbCBhbHdheXMgYmUgbW92ZWQuIFRoZXJlZm9yZSwgaW4gb3JkZXIgdG8gZW5zdXJlIGNvcnJlY3QgbW92ZQogICAqIHBvc2l0aW9uLCBlbCBzaG91bGQgYmUgaW5oZXJpdGVkIGZyb20gcHJldmlvdXMgbm9kZXMuCiAgICovCiAgZnVuY3Rpb24gdHJhdmVyc2VTdGF0aWNDaGlsZHJlbihuMSwgbjIsIHNoYWxsb3cgPSBmYWxzZSkgewogICAgICBjb25zdCBjaDEgPSBuMS5jaGlsZHJlbjsKICAgICAgY29uc3QgY2gyID0gbjIuY2hpbGRyZW47CiAgICAgIGlmIChpc0FycmF5KGNoMSkgJiYgaXNBcnJheShjaDIpKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoMS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIC8vIHRoaXMgaXMgb25seSBjYWxsZWQgaW4gdGhlIG9wdGltaXplZCBwYXRoIHNvIGFycmF5IGNoaWxkcmVuIGFyZQogICAgICAgICAgICAgIC8vIGd1YXJhbnRlZWQgdG8gYmUgdm5vZGVzCiAgICAgICAgICAgICAgY29uc3QgYzEgPSBjaDFbaV07CiAgICAgICAgICAgICAgbGV0IGMyID0gY2gyW2ldOwogICAgICAgICAgICAgIGlmIChjMi5zaGFwZUZsYWcgJiAxIC8qIEVMRU1FTlQgKi8gJiYgIWMyLmR5bmFtaWNDaGlsZHJlbikgewogICAgICAgICAgICAgICAgICBpZiAoYzIucGF0Y2hGbGFnIDw9IDAgfHwgYzIucGF0Y2hGbGFnID09PSAzMiAvKiBIWURSQVRFX0VWRU5UUyAqLykgewogICAgICAgICAgICAgICAgICAgICAgYzIgPSBjaDJbaV0gPSBjbG9uZUlmTW91bnRlZChjaDJbaV0pOwogICAgICAgICAgICAgICAgICAgICAgYzIuZWwgPSBjMS5lbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIXNoYWxsb3cpCiAgICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKGMxLCBjMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGFsc28gaW5oZXJpdCBmb3IgY29tbWVudCBub2RlcywgYnV0IG5vdCBwbGFjZWhvbGRlcnMgKGUuZy4gdi1pZiB3aGljaAogICAgICAgICAgICAgIC8vIHdvdWxkIGhhdmUgcmVjZWl2ZWQgLmVsIGR1cmluZyBibG9jayBwYXRjaCkKICAgICAgICAgICAgICBpZiAoYzIudHlwZSA9PT0gQ29tbWVudCAmJiAhYzIuZWwpIHsKICAgICAgICAgICAgICAgICAgYzIuZWwgPSBjMS5lbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTG9uZ2VzdF9pbmNyZWFzaW5nX3N1YnNlcXVlbmNlCiAgZnVuY3Rpb24gZ2V0U2VxdWVuY2UoYXJyKSB7CiAgICAgIGNvbnN0IHAgPSBhcnIuc2xpY2UoKTsKICAgICAgY29uc3QgcmVzdWx0ID0gWzBdOwogICAgICBsZXQgaSwgaiwgdSwgdiwgYzsKICAgICAgY29uc3QgbGVuID0gYXJyLmxlbmd0aDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBhcnJJID0gYXJyW2ldOwogICAgICAgICAgaWYgKGFyckkgIT09IDApIHsKICAgICAgICAgICAgICBqID0gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICBpZiAoYXJyW2pdIDwgYXJySSkgewogICAgICAgICAgICAgICAgICBwW2ldID0gajsKICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1ID0gMDsKICAgICAgICAgICAgICB2ID0gcmVzdWx0Lmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHUgPCB2KSB7CiAgICAgICAgICAgICAgICAgIGMgPSAodSArIHYpID4+IDE7CiAgICAgICAgICAgICAgICAgIGlmIChhcnJbcmVzdWx0W2NdXSA8IGFyckkpIHsKICAgICAgICAgICAgICAgICAgICAgIHUgPSBjICsgMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHYgPSBjOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChhcnJJIDwgYXJyW3Jlc3VsdFt1XV0pIHsKICAgICAgICAgICAgICAgICAgaWYgKHUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBwW2ldID0gcmVzdWx0W3UgLSAxXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXN1bHRbdV0gPSBpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICB1ID0gcmVzdWx0Lmxlbmd0aDsKICAgICAgdiA9IHJlc3VsdFt1IC0gMV07CiAgICAgIHdoaWxlICh1LS0gPiAwKSB7CiAgICAgICAgICByZXN1bHRbdV0gPSB2OwogICAgICAgICAgdiA9IHBbdl07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIGNvbnN0IGlzVGVsZXBvcnQgPSAodHlwZSkgPT4gdHlwZS5fX2lzVGVsZXBvcnQ7CiAgY29uc3QgaXNUZWxlcG9ydERpc2FibGVkID0gKHByb3BzKSA9PiBwcm9wcyAmJiAocHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuZGlzYWJsZWQgPT09ICcnKTsKICBjb25zdCBpc1RhcmdldFNWRyA9ICh0YXJnZXQpID0+IHR5cGVvZiBTVkdFbGVtZW50ICE9PSAndW5kZWZpbmVkJyAmJiB0YXJnZXQgaW5zdGFuY2VvZiBTVkdFbGVtZW50OwogIGNvbnN0IHJlc29sdmVUYXJnZXQgPSAocHJvcHMsIHNlbGVjdCkgPT4gewogICAgICBjb25zdCB0YXJnZXRTZWxlY3RvciA9IHByb3BzICYmIHByb3BzLnRvOwogICAgICBpZiAoaXNTdHJpbmcodGFyZ2V0U2VsZWN0b3IpKSB7CiAgICAgICAgICBpZiAoIXNlbGVjdCkgewogICAgICAgICAgICAgIHdhcm4kMShgQ3VycmVudCByZW5kZXJlciBkb2VzIG5vdCBzdXBwb3J0IHN0cmluZyB0YXJnZXQgZm9yIFRlbGVwb3J0cy4gYCArCiAgICAgICAgICAgICAgICAgICAgICBgKG1pc3NpbmcgcXVlcnlTZWxlY3RvciByZW5kZXJlciBvcHRpb24pYCk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBzZWxlY3QodGFyZ2V0U2VsZWN0b3IpOwogICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgRmFpbGVkIHRvIGxvY2F0ZSBUZWxlcG9ydCB0YXJnZXQgd2l0aCBzZWxlY3RvciAiJHt0YXJnZXRTZWxlY3Rvcn0iLiBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgTm90ZSB0aGUgdGFyZ2V0IGVsZW1lbnQgbXVzdCBleGlzdCBiZWZvcmUgdGhlIGNvbXBvbmVudCBpcyBtb3VudGVkIC0gYCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgYGkuZS4gdGhlIHRhcmdldCBjYW5ub3QgYmUgcmVuZGVyZWQgYnkgdGhlIGNvbXBvbmVudCBpdHNlbGYsIGFuZCBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgaWRlYWxseSBzaG91bGQgYmUgb3V0c2lkZSBvZiB0aGUgZW50aXJlIFZ1ZSBjb21wb25lbnQgdHJlZS5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGlmICghdGFyZ2V0U2VsZWN0b3IgJiYgIWlzVGVsZXBvcnREaXNhYmxlZChwcm9wcykpIHsKICAgICAgICAgICAgICB3YXJuJDEoYEludmFsaWQgVGVsZXBvcnQgdGFyZ2V0OiAke3RhcmdldFNlbGVjdG9yfWApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldFNlbGVjdG9yOwogICAgICB9CiAgfTsKICBjb25zdCBUZWxlcG9ydEltcGwgPSB7CiAgICAgIF9faXNUZWxlcG9ydDogdHJ1ZSwKICAgICAgcHJvY2VzcyhuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBpc1NWRywgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIGludGVybmFscykgewogICAgICAgICAgY29uc3QgeyBtYzogbW91bnRDaGlsZHJlbiwgcGM6IHBhdGNoQ2hpbGRyZW4sIHBiYzogcGF0Y2hCbG9ja0NoaWxkcmVuLCBvOiB7IGluc2VydCwgcXVlcnlTZWxlY3RvciwgY3JlYXRlVGV4dCwgY3JlYXRlQ29tbWVudCB9IH0gPSBpbnRlcm5hbHM7CiAgICAgICAgICBjb25zdCBkaXNhYmxlZCA9IGlzVGVsZXBvcnREaXNhYmxlZChuMi5wcm9wcyk7CiAgICAgICAgICBsZXQgeyBzaGFwZUZsYWcsIGNoaWxkcmVuLCBkeW5hbWljQ2hpbGRyZW4gfSA9IG4yOwogICAgICAgICAgLy8gIzMzMDIKICAgICAgICAgIC8vIEhNUiB1cGRhdGVkLCBmb3JjZSBmdWxsIGRpZmYKICAgICAgICAgIGlmIChpc0htclVwZGF0aW5nKSB7CiAgICAgICAgICAgICAgb3B0aW1pemVkID0gZmFsc2U7CiAgICAgICAgICAgICAgZHluYW1pY0NoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuMSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgLy8gaW5zZXJ0IGFuY2hvcnMgaW4gdGhlIG1haW4gdmlldwogICAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gKG4yLmVsID0gY3JlYXRlQ29tbWVudCgndGVsZXBvcnQgc3RhcnQnKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IG1haW5BbmNob3IgPSAobjIuYW5jaG9yID0gY3JlYXRlQ29tbWVudCgndGVsZXBvcnQgZW5kJykKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpbnNlcnQocGxhY2Vob2xkZXIsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgICAgICBpbnNlcnQobWFpbkFuY2hvciwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IChuMi50YXJnZXQgPSByZXNvbHZlVGFyZ2V0KG4yLnByb3BzLCBxdWVyeVNlbGVjdG9yKSk7CiAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0QW5jaG9yID0gKG4yLnRhcmdldEFuY2hvciA9IGNyZWF0ZVRleHQoJycpKTsKICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgIGluc2VydCh0YXJnZXRBbmNob3IsIHRhcmdldCk7CiAgICAgICAgICAgICAgICAgIC8vICMyNjUyIHdlIGNvdWxkIGJlIHRlbGVwb3J0aW5nIGZyb20gYSBub24tU1ZHIHRyZWUgaW50byBhbiBTVkcgdHJlZQogICAgICAgICAgICAgICAgICBpc1NWRyA9IGlzU1ZHIHx8IGlzVGFyZ2V0U1ZHKHRhcmdldCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCFkaXNhYmxlZCkgewogICAgICAgICAgICAgICAgICB3YXJuJDEoJ0ludmFsaWQgVGVsZXBvcnQgdGFyZ2V0IG9uIG1vdW50OicsIHRhcmdldCwgYCgke3R5cGVvZiB0YXJnZXR9KWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBtb3VudCA9IChjb250YWluZXIsIGFuY2hvcikgPT4gewogICAgICAgICAgICAgICAgICAvLyBUZWxlcG9ydCAqYWx3YXlzKiBoYXMgQXJyYXkgY2hpbGRyZW4uIFRoaXMgaXMgZW5mb3JjZWQgaW4gYm90aCB0aGUKICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZXIgYW5kIHZub2RlIGNoaWxkcmVuIG5vcm1hbGl6YXRpb24uCiAgICAgICAgICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLykgewogICAgICAgICAgICAgICAgICAgICAgbW91bnRDaGlsZHJlbihjaGlsZHJlbiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChkaXNhYmxlZCkgewogICAgICAgICAgICAgICAgICBtb3VudChjb250YWluZXIsIG1haW5BbmNob3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgbW91bnQodGFyZ2V0LCB0YXJnZXRBbmNob3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIHVwZGF0ZSBjb250ZW50CiAgICAgICAgICAgICAgbjIuZWwgPSBuMS5lbDsKICAgICAgICAgICAgICBjb25zdCBtYWluQW5jaG9yID0gKG4yLmFuY2hvciA9IG4xLmFuY2hvcik7CiAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gKG4yLnRhcmdldCA9IG4xLnRhcmdldCk7CiAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0QW5jaG9yID0gKG4yLnRhcmdldEFuY2hvciA9IG4xLnRhcmdldEFuY2hvcik7CiAgICAgICAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSBpc1RlbGVwb3J0RGlzYWJsZWQobjEucHJvcHMpOwogICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDb250YWluZXIgPSB3YXNEaXNhYmxlZCA/IGNvbnRhaW5lciA6IHRhcmdldDsKICAgICAgICAgICAgICBjb25zdCBjdXJyZW50QW5jaG9yID0gd2FzRGlzYWJsZWQgPyBtYWluQW5jaG9yIDogdGFyZ2V0QW5jaG9yOwogICAgICAgICAgICAgIGlzU1ZHID0gaXNTVkcgfHwgaXNUYXJnZXRTVkcodGFyZ2V0KTsKICAgICAgICAgICAgICBpZiAoZHluYW1pY0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgIC8vIGZhc3QgcGF0aCB3aGVuIHRoZSB0ZWxlcG9ydCBoYXBwZW5zIHRvIGJlIGEgYmxvY2sgcm9vdAogICAgICAgICAgICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4objEuZHluYW1pY0NoaWxkcmVuLCBkeW5hbWljQ2hpbGRyZW4sIGN1cnJlbnRDb250YWluZXIsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMpOwogICAgICAgICAgICAgICAgICAvLyBldmVuIGluIGJsb2NrIHRyZWUgbW9kZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBhbGwgcm9vdC1sZXZlbCBub2RlcwogICAgICAgICAgICAgICAgICAvLyBpbiB0aGUgdGVsZXBvcnQgaW5oZXJpdCBwcmV2aW91cyBET00gcmVmZXJlbmNlcyBzbyB0aGF0IHRoZXkgY2FuCiAgICAgICAgICAgICAgICAgIC8vIGJlIG1vdmVkIGluIGZ1dHVyZSBwYXRjaGVzLgogICAgICAgICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCFvcHRpbWl6ZWQpIHsKICAgICAgICAgICAgICAgICAgcGF0Y2hDaGlsZHJlbihuMSwgbjIsIGN1cnJlbnRDb250YWluZXIsIGN1cnJlbnRBbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGlzU1ZHLCBzbG90U2NvcGVJZHMsIGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRpc2FibGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmICghd2FzRGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGVuYWJsZWQgLT4gZGlzYWJsZWQKICAgICAgICAgICAgICAgICAgICAgIC8vIG1vdmUgaW50byBtYWluIGNvbnRhaW5lcgogICAgICAgICAgICAgICAgICAgICAgbW92ZVRlbGVwb3J0KG4yLCBjb250YWluZXIsIG1haW5BbmNob3IsIGludGVybmFscywgMSAvKiBUT0dHTEUgKi8pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAvLyB0YXJnZXQgY2hhbmdlZAogICAgICAgICAgICAgICAgICBpZiAoKG4yLnByb3BzICYmIG4yLnByb3BzLnRvKSAhPT0gKG4xLnByb3BzICYmIG4xLnByb3BzLnRvKSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFRhcmdldCA9IChuMi50YXJnZXQgPSByZXNvbHZlVGFyZ2V0KG4yLnByb3BzLCBxdWVyeVNlbGVjdG9yKSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVUZWxlcG9ydChuMiwgbmV4dFRhcmdldCwgbnVsbCwgaW50ZXJuYWxzLCAwIC8qIFRBUkdFVF9DSEFOR0UgKi8pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2FybiQxKCdJbnZhbGlkIFRlbGVwb3J0IHRhcmdldCBvbiB1cGRhdGU6JywgdGFyZ2V0LCBgKCR7dHlwZW9mIHRhcmdldH0pYCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAod2FzRGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGVkIC0+IGVuYWJsZWQKICAgICAgICAgICAgICAgICAgICAgIC8vIG1vdmUgaW50byB0ZWxlcG9ydCB0YXJnZXQKICAgICAgICAgICAgICAgICAgICAgIG1vdmVUZWxlcG9ydChuMiwgdGFyZ2V0LCB0YXJnZXRBbmNob3IsIGludGVybmFscywgMSAvKiBUT0dHTEUgKi8pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmUodm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG9wdGltaXplZCwgeyB1bTogdW5tb3VudCwgbzogeyByZW1vdmU6IGhvc3RSZW1vdmUgfSB9LCBkb1JlbW92ZSkgewogICAgICAgICAgY29uc3QgeyBzaGFwZUZsYWcsIGNoaWxkcmVuLCBhbmNob3IsIHRhcmdldEFuY2hvciwgdGFyZ2V0LCBwcm9wcyB9ID0gdm5vZGU7CiAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgaG9zdFJlbW92ZSh0YXJnZXRBbmNob3IpOwogICAgICAgICAgfQogICAgICAgICAgLy8gYW4gdW5tb3VudGVkIHRlbGVwb3J0IHNob3VsZCBhbHdheXMgcmVtb3ZlIGl0cyBjaGlsZHJlbiBpZiBub3QgZGlzYWJsZWQKICAgICAgICAgIGlmIChkb1JlbW92ZSB8fCAhaXNUZWxlcG9ydERpc2FibGVkKHByb3BzKSkgewogICAgICAgICAgICAgIGhvc3RSZW1vdmUoYW5jaG9yKTsKICAgICAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTYgLyogQVJSQVlfQ0hJTERSRU4gKi8pIHsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgICAgIHVubW91bnQoY2hpbGQsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUsICEhY2hpbGQuZHluYW1pY0NoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAgICAgbW92ZTogbW92ZVRlbGVwb3J0LAogICAgICBoeWRyYXRlOiBoeWRyYXRlVGVsZXBvcnQKICB9OwogIGZ1bmN0aW9uIG1vdmVUZWxlcG9ydCh2bm9kZSwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IsIHsgbzogeyBpbnNlcnQgfSwgbTogbW92ZSB9LCBtb3ZlVHlwZSA9IDIgLyogUkVPUkRFUiAqLykgewogICAgICAvLyBtb3ZlIHRhcmdldCBhbmNob3IgaWYgdGhpcyBpcyBhIHRhcmdldCBjaGFuZ2UuCiAgICAgIGlmIChtb3ZlVHlwZSA9PT0gMCAvKiBUQVJHRVRfQ0hBTkdFICovKSB7CiAgICAgICAgICBpbnNlcnQodm5vZGUudGFyZ2V0QW5jaG9yLCBjb250YWluZXIsIHBhcmVudEFuY2hvcik7CiAgICAgIH0KICAgICAgY29uc3QgeyBlbCwgYW5jaG9yLCBzaGFwZUZsYWcsIGNoaWxkcmVuLCBwcm9wcyB9ID0gdm5vZGU7CiAgICAgIGNvbnN0IGlzUmVvcmRlciA9IG1vdmVUeXBlID09PSAyIC8qIFJFT1JERVIgKi87CiAgICAgIC8vIG1vdmUgbWFpbiB2aWV3IGFuY2hvciBpZiB0aGlzIGlzIGEgcmUtb3JkZXIuCiAgICAgIGlmIChpc1Jlb3JkZXIpIHsKICAgICAgICAgIGluc2VydChlbCwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IpOwogICAgICB9CiAgICAgIC8vIGlmIHRoaXMgaXMgYSByZS1vcmRlciBhbmQgdGVsZXBvcnQgaXMgZW5hYmxlZCAoY29udGVudCBpcyBpbiB0YXJnZXQpCiAgICAgIC8vIGRvIG5vdCBtb3ZlIGNoaWxkcmVuLiBTbyB0aGUgb3Bwb3NpdGUgaXM6IG9ubHkgbW92ZSBjaGlsZHJlbiBpZiB0aGlzCiAgICAgIC8vIGlzIG5vdCBhIHJlb3JkZXIsIG9yIHRoZSB0ZWxlcG9ydCBpcyBkaXNhYmxlZAogICAgICBpZiAoIWlzUmVvcmRlciB8fCBpc1RlbGVwb3J0RGlzYWJsZWQocHJvcHMpKSB7CiAgICAgICAgICAvLyBUZWxlcG9ydCBoYXMgZWl0aGVyIEFycmF5IGNoaWxkcmVuIG9yIG5vIGNoaWxkcmVuLgogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDE2IC8qIEFSUkFZX0NISUxEUkVOICovKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBtb3ZlKGNoaWxkcmVuW2ldLCBjb250YWluZXIsIHBhcmVudEFuY2hvciwgMiAvKiBSRU9SREVSICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gbW92ZSBtYWluIHZpZXcgYW5jaG9yIGlmIHRoaXMgaXMgYSByZS1vcmRlci4KICAgICAgaWYgKGlzUmVvcmRlcikgewogICAgICAgICAgaW5zZXJ0KGFuY2hvciwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGh5ZHJhdGVUZWxlcG9ydChub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHsgbzogeyBuZXh0U2libGluZywgcGFyZW50Tm9kZSwgcXVlcnlTZWxlY3RvciB9IH0sIGh5ZHJhdGVDaGlsZHJlbikgewogICAgICBjb25zdCB0YXJnZXQgPSAodm5vZGUudGFyZ2V0ID0gcmVzb2x2ZVRhcmdldCh2bm9kZS5wcm9wcywgcXVlcnlTZWxlY3RvcikpOwogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAvLyBpZiBtdWx0aXBsZSB0ZWxlcG9ydHMgcmVuZGVyZWQgdG8gdGhlIHNhbWUgdGFyZ2V0IGVsZW1lbnQsIHdlIG5lZWQgdG8KICAgICAgICAgIC8vIHBpY2sgdXAgZnJvbSB3aGVyZSB0aGUgbGFzdCB0ZWxlcG9ydCBmaW5pc2hlZCBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBub2RlCiAgICAgICAgICBjb25zdCB0YXJnZXROb2RlID0gdGFyZ2V0Ll9scGEgfHwgdGFyZ2V0LmZpcnN0Q2hpbGQ7CiAgICAgICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMTYgLyogQVJSQVlfQ0hJTERSRU4gKi8pIHsKICAgICAgICAgICAgICBpZiAoaXNUZWxlcG9ydERpc2FibGVkKHZub2RlLnByb3BzKSkgewogICAgICAgICAgICAgICAgICB2bm9kZS5hbmNob3IgPSBoeWRyYXRlQ2hpbGRyZW4obmV4dFNpYmxpbmcobm9kZSksIHZub2RlLCBwYXJlbnROb2RlKG5vZGUpLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCk7CiAgICAgICAgICAgICAgICAgIHZub2RlLnRhcmdldEFuY2hvciA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB2bm9kZS5hbmNob3IgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgICAgLy8gbG9va2FoZWFkIHVudGlsIHdlIGZpbmQgdGhlIHRhcmdldCBhbmNob3IKICAgICAgICAgICAgICAgICAgLy8gd2UgY2Fubm90IHJlbHkgb24gcmV0dXJuIHZhbHVlIG9mIGh5ZHJhdGVDaGlsZHJlbigpIGJlY2F1c2UgdGhlcmUKICAgICAgICAgICAgICAgICAgLy8gY291bGQgYmUgbmVzdGVkIHRlbGVwb3J0cwogICAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0QW5jaG9yID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHRhcmdldEFuY2hvcikgewogICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0QW5jaG9yID0gbmV4dFNpYmxpbmcodGFyZ2V0QW5jaG9yKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRBbmNob3IgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRBbmNob3Iubm9kZVR5cGUgPT09IDggJiYKICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRBbmNob3IuZGF0YSA9PT0gJ3RlbGVwb3J0IGFuY2hvcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgPSB0YXJnZXRBbmNob3I7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9scGEgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgJiYgbmV4dFNpYmxpbmcodm5vZGUudGFyZ2V0QW5jaG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoeWRyYXRlQ2hpbGRyZW4odGFyZ2V0Tm9kZSwgdm5vZGUsIHRhcmdldCwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdm5vZGUuYW5jaG9yICYmIG5leHRTaWJsaW5nKHZub2RlLmFuY2hvcik7CiAgfQogIC8vIEZvcmNlLWNhc3RlZCBwdWJsaWMgdHlwaW5nIGZvciBoIGFuZCBUU1ggcHJvcHMgaW5mZXJlbmNlCiAgY29uc3QgVGVsZXBvcnQgPSBUZWxlcG9ydEltcGw7CgogIGNvbnN0IEZyYWdtZW50ID0gU3ltYm9sKCdGcmFnbWVudCcgKTsKICBjb25zdCBUZXh0ID0gU3ltYm9sKCdUZXh0JyApOwogIGNvbnN0IENvbW1lbnQgPSBTeW1ib2woJ0NvbW1lbnQnICk7CiAgY29uc3QgU3RhdGljID0gU3ltYm9sKCdTdGF0aWMnICk7CiAgLy8gU2luY2Ugdi1pZiBhbmQgdi1mb3IgYXJlIHRoZSB0d28gcG9zc2libGUgd2F5cyBub2RlIHN0cnVjdHVyZSBjYW4gZHluYW1pY2FsbHkKICAvLyBjaGFuZ2UsIG9uY2Ugd2UgY29uc2lkZXIgdi1pZiBicmFuY2hlcyBhbmQgZWFjaCB2LWZvciBmcmFnbWVudCBhIGJsb2NrLCB3ZQogIC8vIGNhbiBkaXZpZGUgYSB0ZW1wbGF0ZSBpbnRvIG5lc3RlZCBibG9ja3MsIGFuZCB3aXRoaW4gZWFjaCBibG9jayB0aGUgbm9kZQogIC8vIHN0cnVjdHVyZSB3b3VsZCBiZSBzdGFibGUuIFRoaXMgYWxsb3dzIHVzIHRvIHNraXAgbW9zdCBjaGlsZHJlbiBkaWZmaW5nCiAgLy8gYW5kIG9ubHkgd29ycnkgYWJvdXQgdGhlIGR5bmFtaWMgbm9kZXMgKGluZGljYXRlZCBieSBwYXRjaCBmbGFncykuCiAgY29uc3QgYmxvY2tTdGFjayA9IFtdOwogIGxldCBjdXJyZW50QmxvY2sgPSBudWxsOwogIC8qKgogICAqIE9wZW4gYSBibG9jay4KICAgKiBUaGlzIG11c3QgYmUgY2FsbGVkIGJlZm9yZSBgY3JlYXRlQmxvY2tgLiBJdCBjYW5ub3QgYmUgcGFydCBvZiBgY3JlYXRlQmxvY2tgCiAgICogYmVjYXVzZSB0aGUgY2hpbGRyZW4gb2YgdGhlIGJsb2NrIGFyZSBldmFsdWF0ZWQgYmVmb3JlIGBjcmVhdGVCbG9ja2AgaXRzZWxmCiAgICogaXMgY2FsbGVkLiBUaGUgZ2VuZXJhdGVkIGNvZGUgdHlwaWNhbGx5IGxvb2tzIGxpa2UgdGhpczoKICAgKgogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gcmVuZGVyKCkgewogICAqICAgcmV0dXJuIChvcGVuQmxvY2soKSxjcmVhdGVCbG9jaygnZGl2JywgbnVsbCwgWy4uLl0pKQogICAqIH0KICAgKiBgYGAKICAgKiBkaXNhYmxlVHJhY2tpbmcgaXMgdHJ1ZSB3aGVuIGNyZWF0aW5nIGEgdi1mb3IgZnJhZ21lbnQgYmxvY2ssIHNpbmNlIGEgdi1mb3IKICAgKiBmcmFnbWVudCBhbHdheXMgZGlmZnMgaXRzIGNoaWxkcmVuLgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBvcGVuQmxvY2soZGlzYWJsZVRyYWNraW5nID0gZmFsc2UpIHsKICAgICAgYmxvY2tTdGFjay5wdXNoKChjdXJyZW50QmxvY2sgPSBkaXNhYmxlVHJhY2tpbmcgPyBudWxsIDogW10pKTsKICB9CiAgZnVuY3Rpb24gY2xvc2VCbG9jaygpIHsKICAgICAgYmxvY2tTdGFjay5wb3AoKTsKICAgICAgY3VycmVudEJsb2NrID0gYmxvY2tTdGFja1tibG9ja1N0YWNrLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgfQogIC8vIFdoZXRoZXIgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGR5bmFtaWMgY2hpbGQgbm9kZXMgaW5zaWRlIGEgYmxvY2suCiAgLy8gT25seSB0cmFja3Mgd2hlbiB0aGlzIHZhbHVlIGlzID4gMAogIC8vIFdlIGFyZSBub3QgdXNpbmcgYSBzaW1wbGUgYm9vbGVhbiBiZWNhdXNlIHRoaXMgdmFsdWUgbWF5IG5lZWQgdG8gYmUKICAvLyBpbmNyZW1lbnRlZC9kZWNyZW1lbnRlZCBieSBuZXN0ZWQgdXNhZ2Ugb2Ygdi1vbmNlIChzZWUgYmVsb3cpCiAgbGV0IGlzQmxvY2tUcmVlRW5hYmxlZCA9IDE7CiAgLyoqCiAgICogQmxvY2sgdHJhY2tpbmcgc29tZXRpbWVzIG5lZWRzIHRvIGJlIGRpc2FibGVkLCBmb3IgZXhhbXBsZSBkdXJpbmcgdGhlCiAgICogY3JlYXRpb24gb2YgYSB0cmVlIHRoYXQgbmVlZHMgdG8gYmUgY2FjaGVkIGJ5IHYtb25jZS4gVGhlIGNvbXBpbGVyIGdlbmVyYXRlcwogICAqIGNvZGUgbGlrZSB0aGlzOgogICAqCiAgICogYGBgIGpzCiAgICogX2NhY2hlWzFdIHx8ICgKICAgKiAgIHNldEJsb2NrVHJhY2tpbmcoLTEpLAogICAqICAgX2NhY2hlWzFdID0gY3JlYXRlVk5vZGUoLi4uKSwKICAgKiAgIHNldEJsb2NrVHJhY2tpbmcoMSksCiAgICogICBfY2FjaGVbMV0KICAgKiApCiAgICogYGBgCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNldEJsb2NrVHJhY2tpbmcodmFsdWUpIHsKICAgICAgaXNCbG9ja1RyZWVFbmFibGVkICs9IHZhbHVlOwogIH0KICBmdW5jdGlvbiBzZXR1cEJsb2NrKHZub2RlKSB7CiAgICAgIC8vIHNhdmUgY3VycmVudCBibG9jayBjaGlsZHJlbiBvbiB0aGUgYmxvY2sgdm5vZGUKICAgICAgdm5vZGUuZHluYW1pY0NoaWxkcmVuID0KICAgICAgICAgIGlzQmxvY2tUcmVlRW5hYmxlZCA+IDAgPyBjdXJyZW50QmxvY2sgfHwgRU1QVFlfQVJSIDogbnVsbDsKICAgICAgLy8gY2xvc2UgYmxvY2sKICAgICAgY2xvc2VCbG9jaygpOwogICAgICAvLyBhIGJsb2NrIGlzIGFsd2F5cyBnb2luZyB0byBiZSBwYXRjaGVkLCBzbyB0cmFjayBpdCBhcyBhIGNoaWxkIG9mIGl0cwogICAgICAvLyBwYXJlbnQgYmxvY2sKICAgICAgaWYgKGlzQmxvY2tUcmVlRW5hYmxlZCA+IDAgJiYgY3VycmVudEJsb2NrKSB7CiAgICAgICAgICBjdXJyZW50QmxvY2sucHVzaCh2bm9kZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZub2RlOwogIH0KICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRCbG9jayh0eXBlLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzLCBzaGFwZUZsYWcpIHsKICAgICAgcmV0dXJuIHNldHVwQmxvY2soY3JlYXRlQmFzZVZOb2RlKHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMsIHNoYXBlRmxhZywgdHJ1ZSAvKiBpc0Jsb2NrICovKSk7CiAgfQogIC8qKgogICAqIENyZWF0ZSBhIGJsb2NrIHJvb3Qgdm5vZGUuIFRha2VzIHRoZSBzYW1lIGV4YWN0IGFyZ3VtZW50cyBhcyBgY3JlYXRlVk5vZGVgLgogICAqIEEgYmxvY2sgcm9vdCBrZWVwcyB0cmFjayBvZiBkeW5hbWljIG5vZGVzIHdpdGhpbiB0aGUgYmxvY2sgaW4gdGhlCiAgICogYGR5bmFtaWNDaGlsZHJlbmAgYXJyYXkuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUJsb2NrKHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMpIHsKICAgICAgcmV0dXJuIHNldHVwQmxvY2soY3JlYXRlVk5vZGUodHlwZSwgcHJvcHMsIGNoaWxkcmVuLCBwYXRjaEZsYWcsIGR5bmFtaWNQcm9wcywgdHJ1ZSAvKiBpc0Jsb2NrOiBwcmV2ZW50IGEgYmxvY2sgZnJvbSB0cmFja2luZyBpdHNlbGYgKi8pKTsKICB9CiAgZnVuY3Rpb24gaXNWTm9kZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPyB2YWx1ZS5fX3ZfaXNWTm9kZSA9PT0gdHJ1ZSA6IGZhbHNlOwogIH0KICBmdW5jdGlvbiBpc1NhbWVWTm9kZVR5cGUobjEsIG4yKSB7CiAgICAgIGlmIChuMi5zaGFwZUZsYWcgJiA2IC8qIENPTVBPTkVOVCAqLyAmJgogICAgICAgICAgaG1yRGlydHlDb21wb25lbnRzLmhhcyhuMi50eXBlKSkgewogICAgICAgICAgLy8gSE1SIG9ubHk6IGlmIHRoZSBjb21wb25lbnQgaGFzIGJlZW4gaG90LXVwZGF0ZWQsIGZvcmNlIGEgcmVsb2FkLgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBuMS50eXBlID09PSBuMi50eXBlICYmIG4xLmtleSA9PT0gbjIua2V5OwogIH0KICBsZXQgdm5vZGVBcmdzVHJhbnNmb3JtZXI7CiAgLyoqCiAgICogSW50ZXJuYWwgQVBJIGZvciByZWdpc3RlcmluZyBhbiBhcmd1bWVudHMgdHJhbnNmb3JtIGZvciBjcmVhdGVWTm9kZQogICAqIHVzZWQgZm9yIGNyZWF0aW5nIHN0dWJzIGluIHRoZSB0ZXN0LXV0aWxzCiAgICogSXQgaXMgKmludGVybmFsKiBidXQgbmVlZHMgdG8gYmUgZXhwb3NlZCBmb3IgdGVzdC11dGlscyB0byBwaWNrIHVwIHByb3BlcgogICAqIHR5cGluZ3MKICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zvcm1WTm9kZUFyZ3ModHJhbnNmb3JtZXIpIHsKICAgICAgdm5vZGVBcmdzVHJhbnNmb3JtZXIgPSB0cmFuc2Zvcm1lcjsKICB9CiAgY29uc3QgY3JlYXRlVk5vZGVXaXRoQXJnc1RyYW5zZm9ybSA9ICguLi5hcmdzKSA9PiB7CiAgICAgIHJldHVybiBfY3JlYXRlVk5vZGUoLi4uKHZub2RlQXJnc1RyYW5zZm9ybWVyCiAgICAgICAgICA/IHZub2RlQXJnc1RyYW5zZm9ybWVyKGFyZ3MsIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSkKICAgICAgICAgIDogYXJncykpOwogIH07CiAgY29uc3QgSW50ZXJuYWxPYmplY3RLZXkgPSBgX192SW50ZXJuYWxgOwogIGNvbnN0IG5vcm1hbGl6ZUtleSA9ICh7IGtleSB9KSA9PiBrZXkgIT0gbnVsbCA/IGtleSA6IG51bGw7CiAgY29uc3Qgbm9ybWFsaXplUmVmID0gKHsgcmVmLCByZWZfa2V5LCByZWZfZm9yIH0pID0+IHsKICAgICAgcmV0dXJuIChyZWYgIT0gbnVsbAogICAgICAgICAgPyBpc1N0cmluZyhyZWYpIHx8IGlzUmVmKHJlZikgfHwgaXNGdW5jdGlvbihyZWYpCiAgICAgICAgICAgICAgPyB7IGk6IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSwgcjogcmVmLCBrOiByZWZfa2V5LCBmOiAhIXJlZl9mb3IgfQogICAgICAgICAgICAgIDogcmVmCiAgICAgICAgICA6IG51bGwpOwogIH07CiAgZnVuY3Rpb24gY3JlYXRlQmFzZVZOb2RlKHR5cGUsIHByb3BzID0gbnVsbCwgY2hpbGRyZW4gPSBudWxsLCBwYXRjaEZsYWcgPSAwLCBkeW5hbWljUHJvcHMgPSBudWxsLCBzaGFwZUZsYWcgPSB0eXBlID09PSBGcmFnbWVudCA/IDAgOiAxIC8qIEVMRU1FTlQgKi8sIGlzQmxvY2tOb2RlID0gZmFsc2UsIG5lZWRGdWxsQ2hpbGRyZW5Ob3JtYWxpemF0aW9uID0gZmFsc2UpIHsKICAgICAgY29uc3Qgdm5vZGUgPSB7CiAgICAgICAgICBfX3ZfaXNWTm9kZTogdHJ1ZSwKICAgICAgICAgIF9fdl9za2lwOiB0cnVlLAogICAgICAgICAgdHlwZSwKICAgICAgICAgIHByb3BzLAogICAgICAgICAga2V5OiBwcm9wcyAmJiBub3JtYWxpemVLZXkocHJvcHMpLAogICAgICAgICAgcmVmOiBwcm9wcyAmJiBub3JtYWxpemVSZWYocHJvcHMpLAogICAgICAgICAgc2NvcGVJZDogY3VycmVudFNjb3BlSWQsCiAgICAgICAgICBzbG90U2NvcGVJZHM6IG51bGwsCiAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgIGNvbXBvbmVudDogbnVsbCwKICAgICAgICAgIHN1c3BlbnNlOiBudWxsLAogICAgICAgICAgc3NDb250ZW50OiBudWxsLAogICAgICAgICAgc3NGYWxsYmFjazogbnVsbCwKICAgICAgICAgIGRpcnM6IG51bGwsCiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsLAogICAgICAgICAgZWw6IG51bGwsCiAgICAgICAgICBhbmNob3I6IG51bGwsCiAgICAgICAgICB0YXJnZXQ6IG51bGwsCiAgICAgICAgICB0YXJnZXRBbmNob3I6IG51bGwsCiAgICAgICAgICBzdGF0aWNDb3VudDogMCwKICAgICAgICAgIHNoYXBlRmxhZywKICAgICAgICAgIHBhdGNoRmxhZywKICAgICAgICAgIGR5bmFtaWNQcm9wcywKICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbjogbnVsbCwKICAgICAgICAgIGFwcENvbnRleHQ6IG51bGwKICAgICAgfTsKICAgICAgaWYgKG5lZWRGdWxsQ2hpbGRyZW5Ob3JtYWxpemF0aW9uKSB7CiAgICAgICAgICBub3JtYWxpemVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4pOwogICAgICAgICAgLy8gbm9ybWFsaXplIHN1c3BlbnNlIGNoaWxkcmVuCiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTI4IC8qIFNVU1BFTlNFICovKSB7CiAgICAgICAgICAgICAgdHlwZS5ub3JtYWxpemUodm5vZGUpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgaWYgKGNoaWxkcmVuKSB7CiAgICAgICAgICAvLyBjb21waWxlZCBlbGVtZW50IHZub2RlIC0gaWYgY2hpbGRyZW4gaXMgcGFzc2VkLCBvbmx5IHBvc3NpYmxlIHR5cGVzIGFyZQogICAgICAgICAgLy8gc3RyaW5nIG9yIEFycmF5LgogICAgICAgICAgdm5vZGUuc2hhcGVGbGFnIHw9IGlzU3RyaW5nKGNoaWxkcmVuKQogICAgICAgICAgICAgID8gOCAvKiBURVhUX0NISUxEUkVOICovCiAgICAgICAgICAgICAgOiAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLzsKICAgICAgfQogICAgICAvLyB2YWxpZGF0ZSBrZXkKICAgICAgaWYgKHZub2RlLmtleSAhPT0gdm5vZGUua2V5KSB7CiAgICAgICAgICB3YXJuJDEoYFZOb2RlIGNyZWF0ZWQgd2l0aCBpbnZhbGlkIGtleSAoTmFOKS4gVk5vZGUgdHlwZTpgLCB2bm9kZS50eXBlKTsKICAgICAgfQogICAgICAvLyB0cmFjayB2bm9kZSBmb3IgYmxvY2sgdHJlZQogICAgICBpZiAoaXNCbG9ja1RyZWVFbmFibGVkID4gMCAmJgogICAgICAgICAgLy8gYXZvaWQgYSBibG9jayBub2RlIGZyb20gdHJhY2tpbmcgaXRzZWxmCiAgICAgICAgICAhaXNCbG9ja05vZGUgJiYKICAgICAgICAgIC8vIGhhcyBjdXJyZW50IHBhcmVudCBibG9jawogICAgICAgICAgY3VycmVudEJsb2NrICYmCiAgICAgICAgICAvLyBwcmVzZW5jZSBvZiBhIHBhdGNoIGZsYWcgaW5kaWNhdGVzIHRoaXMgbm9kZSBuZWVkcyBwYXRjaGluZyBvbiB1cGRhdGVzLgogICAgICAgICAgLy8gY29tcG9uZW50IG5vZGVzIGFsc28gc2hvdWxkIGFsd2F5cyBiZSBwYXRjaGVkLCBiZWNhdXNlIGV2ZW4gaWYgdGhlCiAgICAgICAgICAvLyBjb21wb25lbnQgZG9lc24ndCBuZWVkIHRvIHVwZGF0ZSwgaXQgbmVlZHMgdG8gcGVyc2lzdCB0aGUgaW5zdGFuY2Ugb24gdG8KICAgICAgICAgIC8vIHRoZSBuZXh0IHZub2RlIHNvIHRoYXQgaXQgY2FuIGJlIHByb3Blcmx5IHVubW91bnRlZCBsYXRlci4KICAgICAgICAgICh2bm9kZS5wYXRjaEZsYWcgPiAwIHx8IHNoYXBlRmxhZyAmIDYgLyogQ09NUE9ORU5UICovKSAmJgogICAgICAgICAgLy8gdGhlIEVWRU5UUyBmbGFnIGlzIG9ubHkgZm9yIGh5ZHJhdGlvbiBhbmQgaWYgaXQgaXMgdGhlIG9ubHkgZmxhZywgdGhlCiAgICAgICAgICAvLyB2bm9kZSBzaG91bGQgbm90IGJlIGNvbnNpZGVyZWQgZHluYW1pYyBkdWUgdG8gaGFuZGxlciBjYWNoaW5nLgogICAgICAgICAgdm5vZGUucGF0Y2hGbGFnICE9PSAzMiAvKiBIWURSQVRFX0VWRU5UUyAqLykgewogICAgICAgICAgY3VycmVudEJsb2NrLnB1c2godm5vZGUpOwogICAgICB9CiAgICAgIHJldHVybiB2bm9kZTsKICB9CiAgY29uc3QgY3JlYXRlVk5vZGUgPSAoY3JlYXRlVk5vZGVXaXRoQXJnc1RyYW5zZm9ybSApOwogIGZ1bmN0aW9uIF9jcmVhdGVWTm9kZSh0eXBlLCBwcm9wcyA9IG51bGwsIGNoaWxkcmVuID0gbnVsbCwgcGF0Y2hGbGFnID0gMCwgZHluYW1pY1Byb3BzID0gbnVsbCwgaXNCbG9ja05vZGUgPSBmYWxzZSkgewogICAgICBpZiAoIXR5cGUgfHwgdHlwZSA9PT0gTlVMTF9EWU5BTUlDX0NPTVBPTkVOVCkgewogICAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBJbnZhbGlkIHZub2RlIHR5cGUgd2hlbiBjcmVhdGluZyB2bm9kZTogJHt0eXBlfS5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHR5cGUgPSBDb21tZW50OwogICAgICB9CiAgICAgIGlmIChpc1ZOb2RlKHR5cGUpKSB7CiAgICAgICAgICAvLyBjcmVhdGVWTm9kZSByZWNlaXZpbmcgYW4gZXhpc3Rpbmcgdm5vZGUuIFRoaXMgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgICAgICAvLyA8Y29tcG9uZW50IDppcz0idm5vZGUiLz4KICAgICAgICAgIC8vICMyMDc4IG1ha2Ugc3VyZSB0byBtZXJnZSByZWZzIGR1cmluZyB0aGUgY2xvbmUgaW5zdGVhZCBvZiBvdmVyd3JpdGluZyBpdAogICAgICAgICAgY29uc3QgY2xvbmVkID0gY2xvbmVWTm9kZSh0eXBlLCBwcm9wcywgdHJ1ZSAvKiBtZXJnZVJlZjogdHJ1ZSAqLyk7CiAgICAgICAgICBpZiAoY2hpbGRyZW4pIHsKICAgICAgICAgICAgICBub3JtYWxpemVDaGlsZHJlbihjbG9uZWQsIGNoaWxkcmVuKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmICFpc0Jsb2NrTm9kZSAmJiBjdXJyZW50QmxvY2spIHsKICAgICAgICAgICAgICBpZiAoY2xvbmVkLnNoYXBlRmxhZyAmIDYgLyogQ09NUE9ORU5UICovKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRCbG9ja1tjdXJyZW50QmxvY2suaW5kZXhPZih0eXBlKV0gPSBjbG9uZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50QmxvY2sucHVzaChjbG9uZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNsb25lZC5wYXRjaEZsYWcgfD0gLTIgLyogQkFJTCAqLzsKICAgICAgICAgIHJldHVybiBjbG9uZWQ7CiAgICAgIH0KICAgICAgLy8gY2xhc3MgY29tcG9uZW50IG5vcm1hbGl6YXRpb24uCiAgICAgIGlmIChpc0NsYXNzQ29tcG9uZW50KHR5cGUpKSB7CiAgICAgICAgICB0eXBlID0gdHlwZS5fX3ZjY09wdHM7CiAgICAgIH0KICAgICAgLy8gY2xhc3MgJiBzdHlsZSBub3JtYWxpemF0aW9uLgogICAgICBpZiAocHJvcHMpIHsKICAgICAgICAgIC8vIGZvciByZWFjdGl2ZSBvciBwcm94eSBvYmplY3RzLCB3ZSBuZWVkIHRvIGNsb25lIGl0IHRvIGVuYWJsZSBtdXRhdGlvbi4KICAgICAgICAgIHByb3BzID0gZ3VhcmRSZWFjdGl2ZVByb3BzKHByb3BzKTsKICAgICAgICAgIGxldCB7IGNsYXNzOiBrbGFzcywgc3R5bGUgfSA9IHByb3BzOwogICAgICAgICAgaWYgKGtsYXNzICYmICFpc1N0cmluZyhrbGFzcykpIHsKICAgICAgICAgICAgICBwcm9wcy5jbGFzcyA9IG5vcm1hbGl6ZUNsYXNzKGtsYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc09iamVjdChzdHlsZSkpIHsKICAgICAgICAgICAgICAvLyByZWFjdGl2ZSBzdGF0ZSBvYmplY3RzIG5lZWQgdG8gYmUgY2xvbmVkIHNpbmNlIHRoZXkgYXJlIGxpa2VseSB0byBiZQogICAgICAgICAgICAgIC8vIG11dGF0ZWQKICAgICAgICAgICAgICBpZiAoaXNQcm94eShzdHlsZSkgJiYgIWlzQXJyYXkoc3R5bGUpKSB7CiAgICAgICAgICAgICAgICAgIHN0eWxlID0gZXh0ZW5kKHt9LCBzdHlsZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByb3BzLnN0eWxlID0gbm9ybWFsaXplU3R5bGUoc3R5bGUpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGVuY29kZSB0aGUgdm5vZGUgdHlwZSBpbmZvcm1hdGlvbiBpbnRvIGEgYml0bWFwCiAgICAgIGNvbnN0IHNoYXBlRmxhZyA9IGlzU3RyaW5nKHR5cGUpCiAgICAgICAgICA/IDEgLyogRUxFTUVOVCAqLwogICAgICAgICAgOiBpc1N1c3BlbnNlKHR5cGUpCiAgICAgICAgICAgICAgPyAxMjggLyogU1VTUEVOU0UgKi8KICAgICAgICAgICAgICA6IGlzVGVsZXBvcnQodHlwZSkKICAgICAgICAgICAgICAgICAgPyA2NCAvKiBURUxFUE9SVCAqLwogICAgICAgICAgICAgICAgICA6IGlzT2JqZWN0KHR5cGUpCiAgICAgICAgICAgICAgICAgICAgICA/IDQgLyogU1RBVEVGVUxfQ09NUE9ORU5UICovCiAgICAgICAgICAgICAgICAgICAgICA6IGlzRnVuY3Rpb24odHlwZSkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IDIgLyogRlVOQ1RJT05BTF9DT01QT05FTlQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICA6IDA7CiAgICAgIGlmIChzaGFwZUZsYWcgJiA0IC8qIFNUQVRFRlVMX0NPTVBPTkVOVCAqLyAmJiBpc1Byb3h5KHR5cGUpKSB7CiAgICAgICAgICB0eXBlID0gdG9SYXcodHlwZSk7CiAgICAgICAgICB3YXJuJDEoYFZ1ZSByZWNlaXZlZCBhIENvbXBvbmVudCB3aGljaCB3YXMgbWFkZSBhIHJlYWN0aXZlIG9iamVjdC4gVGhpcyBjYW4gYCArCiAgICAgICAgICAgICAgYGxlYWQgdG8gdW5uZWNlc3NhcnkgcGVyZm9ybWFuY2Ugb3ZlcmhlYWQsIGFuZCBzaG91bGQgYmUgYXZvaWRlZCBieSBgICsKICAgICAgICAgICAgICBgbWFya2luZyB0aGUgY29tcG9uZW50IHdpdGggXGBtYXJrUmF3XGAgb3IgdXNpbmcgXGBzaGFsbG93UmVmXGAgYCArCiAgICAgICAgICAgICAgYGluc3RlYWQgb2YgXGByZWZcYC5gLCBgXG5Db21wb25lbnQgdGhhdCB3YXMgbWFkZSByZWFjdGl2ZTogYCwgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZUJhc2VWTm9kZSh0eXBlLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzLCBzaGFwZUZsYWcsIGlzQmxvY2tOb2RlLCB0cnVlKTsKICB9CiAgZnVuY3Rpb24gZ3VhcmRSZWFjdGl2ZVByb3BzKHByb3BzKSB7CiAgICAgIGlmICghcHJvcHMpCiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIGlzUHJveHkocHJvcHMpIHx8IEludGVybmFsT2JqZWN0S2V5IGluIHByb3BzCiAgICAgICAgICA/IGV4dGVuZCh7fSwgcHJvcHMpCiAgICAgICAgICA6IHByb3BzOwogIH0KICBmdW5jdGlvbiBjbG9uZVZOb2RlKHZub2RlLCBleHRyYVByb3BzLCBtZXJnZVJlZiA9IGZhbHNlKSB7CiAgICAgIC8vIFRoaXMgaXMgaW50ZW50aW9uYWxseSBOT1QgdXNpbmcgc3ByZWFkIG9yIGV4dGVuZCB0byBhdm9pZCB0aGUgcnVudGltZQogICAgICAvLyBrZXkgZW51bWVyYXRpb24gY29zdC4KICAgICAgY29uc3QgeyBwcm9wcywgcmVmLCBwYXRjaEZsYWcsIGNoaWxkcmVuIH0gPSB2bm9kZTsKICAgICAgY29uc3QgbWVyZ2VkUHJvcHMgPSBleHRyYVByb3BzID8gbWVyZ2VQcm9wcyhwcm9wcyB8fCB7fSwgZXh0cmFQcm9wcykgOiBwcm9wczsKICAgICAgY29uc3QgY2xvbmVkID0gewogICAgICAgICAgX192X2lzVk5vZGU6IHRydWUsCiAgICAgICAgICBfX3Zfc2tpcDogdHJ1ZSwKICAgICAgICAgIHR5cGU6IHZub2RlLnR5cGUsCiAgICAgICAgICBwcm9wczogbWVyZ2VkUHJvcHMsCiAgICAgICAgICBrZXk6IG1lcmdlZFByb3BzICYmIG5vcm1hbGl6ZUtleShtZXJnZWRQcm9wcyksCiAgICAgICAgICByZWY6IGV4dHJhUHJvcHMgJiYgZXh0cmFQcm9wcy5yZWYKICAgICAgICAgICAgICA/IC8vICMyMDc4IGluIHRoZSBjYXNlIG9mIDxjb21wb25lbnQgOmlzPSJ2bm9kZSIgcmVmPSJleHRyYSIvPgogICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgdm5vZGUgaXRzZWxmIGFscmVhZHkgaGFzIGEgcmVmLCBjbG9uZVZOb2RlIHdpbGwgbmVlZCB0byBtZXJnZQogICAgICAgICAgICAgICAgICAvLyB0aGUgcmVmcyBzbyB0aGUgc2luZ2xlIHZub2RlIGNhbiBiZSBzZXQgb24gbXVsdGlwbGUgcmVmcwogICAgICAgICAgICAgICAgICBtZXJnZVJlZiAmJiByZWYKICAgICAgICAgICAgICAgICAgICAgID8gaXNBcnJheShyZWYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZWYuY29uY2F0KG5vcm1hbGl6ZVJlZihleHRyYVByb3BzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IFtyZWYsIG5vcm1hbGl6ZVJlZihleHRyYVByb3BzKV0KICAgICAgICAgICAgICAgICAgICAgIDogbm9ybWFsaXplUmVmKGV4dHJhUHJvcHMpCiAgICAgICAgICAgICAgOiByZWYsCiAgICAgICAgICBzY29wZUlkOiB2bm9kZS5zY29wZUlkLAogICAgICAgICAgc2xvdFNjb3BlSWRzOiB2bm9kZS5zbG90U2NvcGVJZHMsCiAgICAgICAgICBjaGlsZHJlbjogcGF0Y2hGbGFnID09PSAtMSAvKiBIT0lTVEVEICovICYmIGlzQXJyYXkoY2hpbGRyZW4pCiAgICAgICAgICAgICAgPyBjaGlsZHJlbi5tYXAoZGVlcENsb25lVk5vZGUpCiAgICAgICAgICAgICAgOiBjaGlsZHJlbiwKICAgICAgICAgIHRhcmdldDogdm5vZGUudGFyZ2V0LAogICAgICAgICAgdGFyZ2V0QW5jaG9yOiB2bm9kZS50YXJnZXRBbmNob3IsCiAgICAgICAgICBzdGF0aWNDb3VudDogdm5vZGUuc3RhdGljQ291bnQsCiAgICAgICAgICBzaGFwZUZsYWc6IHZub2RlLnNoYXBlRmxhZywKICAgICAgICAgIC8vIGlmIHRoZSB2bm9kZSBpcyBjbG9uZWQgd2l0aCBleHRyYSBwcm9wcywgd2UgY2FuIG5vIGxvbmdlciBhc3N1bWUgaXRzCiAgICAgICAgICAvLyBleGlzdGluZyBwYXRjaCBmbGFnIHRvIGJlIHJlbGlhYmxlIGFuZCBuZWVkIHRvIGFkZCB0aGUgRlVMTF9QUk9QUyBmbGFnLgogICAgICAgICAgLy8gbm90ZTogcHJlc2VydmUgZmxhZyBmb3IgZnJhZ21lbnRzIHNpbmNlIHRoZXkgdXNlIHRoZSBmbGFnIGZvciBjaGlsZHJlbgogICAgICAgICAgLy8gZmFzdCBwYXRocyBvbmx5LgogICAgICAgICAgcGF0Y2hGbGFnOiBleHRyYVByb3BzICYmIHZub2RlLnR5cGUgIT09IEZyYWdtZW50CiAgICAgICAgICAgICAgPyBwYXRjaEZsYWcgPT09IC0xIC8vIGhvaXN0ZWQgbm9kZQogICAgICAgICAgICAgICAgICA/IDE2IC8qIEZVTExfUFJPUFMgKi8KICAgICAgICAgICAgICAgICAgOiBwYXRjaEZsYWcgfCAxNiAvKiBGVUxMX1BST1BTICovCiAgICAgICAgICAgICAgOiBwYXRjaEZsYWcsCiAgICAgICAgICBkeW5hbWljUHJvcHM6IHZub2RlLmR5bmFtaWNQcm9wcywKICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbjogdm5vZGUuZHluYW1pY0NoaWxkcmVuLAogICAgICAgICAgYXBwQ29udGV4dDogdm5vZGUuYXBwQ29udGV4dCwKICAgICAgICAgIGRpcnM6IHZub2RlLmRpcnMsCiAgICAgICAgICB0cmFuc2l0aW9uOiB2bm9kZS50cmFuc2l0aW9uLAogICAgICAgICAgLy8gVGhlc2Ugc2hvdWxkIHRlY2huaWNhbGx5IG9ubHkgYmUgbm9uLW51bGwgb24gbW91bnRlZCBWTm9kZXMuIEhvd2V2ZXIsCiAgICAgICAgICAvLyB0aGV5ICpzaG91bGQqIGJlIGNvcGllZCBmb3Iga2VwdC1hbGl2ZSB2bm9kZXMuIFNvIHdlIGp1c3QgYWx3YXlzIGNvcHkKICAgICAgICAgIC8vIHRoZW0gc2luY2UgdGhlbSBiZWluZyBub24tbnVsbCBkdXJpbmcgYSBtb3VudCBkb2Vzbid0IGFmZmVjdCB0aGUgbG9naWMgYXMKICAgICAgICAgIC8vIHRoZXkgd2lsbCBzaW1wbHkgYmUgb3ZlcndyaXR0ZW4uCiAgICAgICAgICBjb21wb25lbnQ6IHZub2RlLmNvbXBvbmVudCwKICAgICAgICAgIHN1c3BlbnNlOiB2bm9kZS5zdXNwZW5zZSwKICAgICAgICAgIHNzQ29udGVudDogdm5vZGUuc3NDb250ZW50ICYmIGNsb25lVk5vZGUodm5vZGUuc3NDb250ZW50KSwKICAgICAgICAgIHNzRmFsbGJhY2s6IHZub2RlLnNzRmFsbGJhY2sgJiYgY2xvbmVWTm9kZSh2bm9kZS5zc0ZhbGxiYWNrKSwKICAgICAgICAgIGVsOiB2bm9kZS5lbCwKICAgICAgICAgIGFuY2hvcjogdm5vZGUuYW5jaG9yCiAgICAgIH07CiAgICAgIHJldHVybiBjbG9uZWQ7CiAgfQogIC8qKgogICAqIERldiBvbmx5LCBmb3IgSE1SIG9mIGhvaXN0ZWQgdm5vZGVzIHJldXNlZCBpbiB2LWZvcgogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS92aXRlanMvdml0ZS9pc3N1ZXMvMjAyMgogICAqLwogIGZ1bmN0aW9uIGRlZXBDbG9uZVZOb2RlKHZub2RlKSB7CiAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgICBpZiAoaXNBcnJheSh2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgICAgIGNsb25lZC5jaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuLm1hcChkZWVwQ2xvbmVWTm9kZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNsb25lZDsKICB9CiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUodGV4dCA9ICcgJywgZmxhZyA9IDApIHsKICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKFRleHQsIG51bGwsIHRleHQsIGZsYWcpOwogIH0KICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZVN0YXRpY1ZOb2RlKGNvbnRlbnQsIG51bWJlck9mTm9kZXMpIHsKICAgICAgLy8gQSBzdGF0aWMgdm5vZGUgY2FuIGNvbnRhaW4gbXVsdGlwbGUgc3RyaW5naWZpZWQgZWxlbWVudHMsIGFuZCB0aGUgbnVtYmVyCiAgICAgIC8vIG9mIGVsZW1lbnRzIGlzIG5lY2Vzc2FyeSBmb3IgaHlkcmF0aW9uLgogICAgICBjb25zdCB2bm9kZSA9IGNyZWF0ZVZOb2RlKFN0YXRpYywgbnVsbCwgY29udGVudCk7CiAgICAgIHZub2RlLnN0YXRpY0NvdW50ID0gbnVtYmVyT2ZOb2RlczsKICAgICAgcmV0dXJuIHZub2RlOwogIH0KICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUNvbW1lbnRWTm9kZSh0ZXh0ID0gJycsIAogIC8vIHdoZW4gdXNlZCBhcyB0aGUgdi1lbHNlIGJyYW5jaCwgdGhlIGNvbW1lbnQgbm9kZSBtdXN0IGJlIGNyZWF0ZWQgYXMgYQogIC8vIGJsb2NrIHRvIGVuc3VyZSBjb3JyZWN0IHVwZGF0ZXMuCiAgYXNCbG9jayA9IGZhbHNlKSB7CiAgICAgIHJldHVybiBhc0Jsb2NrCiAgICAgICAgICA/IChvcGVuQmxvY2soKSwgY3JlYXRlQmxvY2soQ29tbWVudCwgbnVsbCwgdGV4dCkpCiAgICAgICAgICA6IGNyZWF0ZVZOb2RlKENvbW1lbnQsIG51bGwsIHRleHQpOwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVWTm9kZShjaGlsZCkgewogICAgICBpZiAoY2hpbGQgPT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgPT09ICdib29sZWFuJykgewogICAgICAgICAgLy8gZW1wdHkgcGxhY2Vob2xkZXIKICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZShDb21tZW50KTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc0FycmF5KGNoaWxkKSkgewogICAgICAgICAgLy8gZnJhZ21lbnQKICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZShGcmFnbWVudCwgbnVsbCwgCiAgICAgICAgICAvLyAjMzY2NiwgYXZvaWQgcmVmZXJlbmNlIHBvbGx1dGlvbiB3aGVuIHJldXNpbmcgdm5vZGUKICAgICAgICAgIGNoaWxkLnNsaWNlKCkpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBjaGlsZCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIC8vIGFscmVhZHkgdm5vZGUsIHRoaXMgc2hvdWxkIGJlIHRoZSBtb3N0IGNvbW1vbiBzaW5jZSBjb21waWxlZCB0ZW1wbGF0ZXMKICAgICAgICAgIC8vIGFsd2F5cyBwcm9kdWNlIGFsbC12bm9kZSBjaGlsZHJlbiBhcnJheXMKICAgICAgICAgIHJldHVybiBjbG9uZUlmTW91bnRlZChjaGlsZCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICAvLyBzdHJpbmdzIGFuZCBudW1iZXJzCiAgICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUoVGV4dCwgbnVsbCwgU3RyaW5nKGNoaWxkKSk7CiAgICAgIH0KICB9CiAgLy8gb3B0aW1pemVkIG5vcm1hbGl6YXRpb24gZm9yIHRlbXBsYXRlLWNvbXBpbGVkIHJlbmRlciBmbnMKICBmdW5jdGlvbiBjbG9uZUlmTW91bnRlZChjaGlsZCkgewogICAgICByZXR1cm4gY2hpbGQuZWwgPT09IG51bGwgfHwgY2hpbGQubWVtbyA/IGNoaWxkIDogY2xvbmVWTm9kZShjaGlsZCk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbikgewogICAgICBsZXQgdHlwZSA9IDA7CiAgICAgIGNvbnN0IHsgc2hhcGVGbGFnIH0gPSB2bm9kZTsKICAgICAgaWYgKGNoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgfQogICAgICBlbHNlIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgdHlwZSA9IDE2IC8qIEFSUkFZX0NISUxEUkVOICovOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBjaGlsZHJlbiA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiAoMSAvKiBFTEVNRU5UICovIHwgNjQgLyogVEVMRVBPUlQgKi8pKSB7CiAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHNsb3QgdG8gcGxhaW4gY2hpbGRyZW4gZm9yIHBsYWluIGVsZW1lbnQgYW5kIFRlbGVwb3J0CiAgICAgICAgICAgICAgY29uc3Qgc2xvdCA9IGNoaWxkcmVuLmRlZmF1bHQ7CiAgICAgICAgICAgICAgaWYgKHNsb3QpIHsKICAgICAgICAgICAgICAgICAgLy8gX2MgbWFya2VyIGlzIGFkZGVkIGJ5IHdpdGhDdHgoKSBpbmRpY2F0aW5nIHRoaXMgaXMgYSBjb21waWxlZCBzbG90CiAgICAgICAgICAgICAgICAgIHNsb3QuX2MgJiYgKHNsb3QuX2QgPSBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlLCBzbG90KCkpOwogICAgICAgICAgICAgICAgICBzbG90Ll9jICYmIChzbG90Ll9kID0gdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHR5cGUgPSAzMiAvKiBTTE9UU19DSElMRFJFTiAqLzsKICAgICAgICAgICAgICBjb25zdCBzbG90RmxhZyA9IGNoaWxkcmVuLl87CiAgICAgICAgICAgICAgaWYgKCFzbG90RmxhZyAmJiAhKEludGVybmFsT2JqZWN0S2V5IGluIGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICBjaGlsZHJlbi5fY3R4ID0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChzbG90RmxhZyA9PT0gMyAvKiBGT1JXQVJERUQgKi8gJiYgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIC8vIGEgY2hpbGQgY29tcG9uZW50IHJlY2VpdmVzIGZvcndhcmRlZCBzbG90cyBmcm9tIHRoZSBwYXJlbnQuCiAgICAgICAgICAgICAgICAgIC8vIGl0cyBzbG90IHR5cGUgaXMgZGV0ZXJtaW5lZCBieSBpdHMgcGFyZW50J3Mgc2xvdCB0eXBlLgogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLnNsb3RzLl8gPT09IDEgLyogU1RBQkxFICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5fID0gMSAvKiBTVEFCTEUgKi87CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5fID0gMiAvKiBEWU5BTUlDICovOwogICAgICAgICAgICAgICAgICAgICAgdm5vZGUucGF0Y2hGbGFnIHw9IDEwMjQgLyogRFlOQU1JQ19TTE9UUyAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChpc0Z1bmN0aW9uKGNoaWxkcmVuKSkgewogICAgICAgICAgY2hpbGRyZW4gPSB7IGRlZmF1bHQ6IGNoaWxkcmVuLCBfY3R4OiBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgfTsKICAgICAgICAgIHR5cGUgPSAzMiAvKiBTTE9UU19DSElMRFJFTiAqLzsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGNoaWxkcmVuID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgIC8vIGZvcmNlIHRlbGVwb3J0IGNoaWxkcmVuIHRvIGFycmF5IHNvIGl0IGNhbiBiZSBtb3ZlZCBhcm91bmQKICAgICAgICAgIGlmIChzaGFwZUZsYWcgJiA2NCAvKiBURUxFUE9SVCAqLykgewogICAgICAgICAgICAgIHR5cGUgPSAxNiAvKiBBUlJBWV9DSElMRFJFTiAqLzsKICAgICAgICAgICAgICBjaGlsZHJlbiA9IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHR5cGUgPSA4IC8qIFRFWFRfQ0hJTERSRU4gKi87CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgdm5vZGUuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgdm5vZGUuc2hhcGVGbGFnIHw9IHR5cGU7CiAgfQogIGZ1bmN0aW9uIG1lcmdlUHJvcHMoLi4uYXJncykgewogICAgICBjb25zdCByZXQgPSB7fTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCB0b01lcmdlID0gYXJnc1tpXTsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRvTWVyZ2UpIHsKICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyZXQuY2xhc3MgIT09IHRvTWVyZ2UuY2xhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldC5jbGFzcyA9IG5vcm1hbGl6ZUNsYXNzKFtyZXQuY2xhc3MsIHRvTWVyZ2UuY2xhc3NdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgPT09ICdzdHlsZScpIHsKICAgICAgICAgICAgICAgICAgcmV0LnN0eWxlID0gbm9ybWFsaXplU3R5bGUoW3JldC5zdHlsZSwgdG9NZXJnZS5zdHlsZV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChpc09uKGtleSkpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSByZXRba2V5XTsKICAgICAgICAgICAgICAgICAgY29uc3QgaW5jb21pbmcgPSB0b01lcmdlW2tleV07CiAgICAgICAgICAgICAgICAgIGlmIChpbmNvbWluZyAmJgogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcgIT09IGluY29taW5nICYmCiAgICAgICAgICAgICAgICAgICAgICAhKGlzQXJyYXkoZXhpc3RpbmcpICYmIGV4aXN0aW5nLmluY2x1ZGVzKGluY29taW5nKSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldFtrZXldID0gZXhpc3RpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICA/IFtdLmNvbmNhdChleGlzdGluZywgaW5jb21pbmcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBpbmNvbWluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChrZXkgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgIHJldFtrZXldID0gdG9NZXJnZVtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0OwogIH0KICBmdW5jdGlvbiBpbnZva2VWTm9kZUhvb2soaG9vaywgaW5zdGFuY2UsIHZub2RlLCBwcmV2Vk5vZGUgPSBudWxsKSB7CiAgICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIGluc3RhbmNlLCA3IC8qIFZOT0RFX0hPT0sgKi8sIFsKICAgICAgICAgIHZub2RlLAogICAgICAgICAgcHJldlZOb2RlCiAgICAgIF0pOwogIH0KCiAgY29uc3QgZW1wdHlBcHBDb250ZXh0ID0gY3JlYXRlQXBwQ29udGV4dCgpOwogIGxldCB1aWQkMSA9IDA7CiAgZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50SW5zdGFuY2Uodm5vZGUsIHBhcmVudCwgc3VzcGVuc2UpIHsKICAgICAgY29uc3QgdHlwZSA9IHZub2RlLnR5cGU7CiAgICAgIC8vIGluaGVyaXQgcGFyZW50IGFwcCBjb250ZXh0IC0gb3IgLSBpZiByb290LCBhZG9wdCBmcm9tIHJvb3Qgdm5vZGUKICAgICAgY29uc3QgYXBwQ29udGV4dCA9IChwYXJlbnQgPyBwYXJlbnQuYXBwQ29udGV4dCA6IHZub2RlLmFwcENvbnRleHQpIHx8IGVtcHR5QXBwQ29udGV4dDsKICAgICAgY29uc3QgaW5zdGFuY2UgPSB7CiAgICAgICAgICB1aWQ6IHVpZCQxKyssCiAgICAgICAgICB2bm9kZSwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBwYXJlbnQsCiAgICAgICAgICBhcHBDb250ZXh0LAogICAgICAgICAgcm9vdDogbnVsbCwKICAgICAgICAgIG5leHQ6IG51bGwsCiAgICAgICAgICBzdWJUcmVlOiBudWxsLAogICAgICAgICAgZWZmZWN0OiBudWxsLAogICAgICAgICAgdXBkYXRlOiBudWxsLAogICAgICAgICAgc2NvcGU6IG5ldyBFZmZlY3RTY29wZSh0cnVlIC8qIGRldGFjaGVkICovKSwKICAgICAgICAgIHJlbmRlcjogbnVsbCwKICAgICAgICAgIHByb3h5OiBudWxsLAogICAgICAgICAgZXhwb3NlZDogbnVsbCwKICAgICAgICAgIGV4cG9zZVByb3h5OiBudWxsLAogICAgICAgICAgd2l0aFByb3h5OiBudWxsLAogICAgICAgICAgcHJvdmlkZXM6IHBhcmVudCA/IHBhcmVudC5wcm92aWRlcyA6IE9iamVjdC5jcmVhdGUoYXBwQ29udGV4dC5wcm92aWRlcyksCiAgICAgICAgICBhY2Nlc3NDYWNoZTogbnVsbCwKICAgICAgICAgIHJlbmRlckNhY2hlOiBbXSwKICAgICAgICAgIC8vIGxvY2FsIHJlc29sdmVkIGFzc2V0cwogICAgICAgICAgY29tcG9uZW50czogbnVsbCwKICAgICAgICAgIGRpcmVjdGl2ZXM6IG51bGwsCiAgICAgICAgICAvLyByZXNvbHZlZCBwcm9wcyBhbmQgZW1pdHMgb3B0aW9ucwogICAgICAgICAgcHJvcHNPcHRpb25zOiBub3JtYWxpemVQcm9wc09wdGlvbnModHlwZSwgYXBwQ29udGV4dCksCiAgICAgICAgICBlbWl0c09wdGlvbnM6IG5vcm1hbGl6ZUVtaXRzT3B0aW9ucyh0eXBlLCBhcHBDb250ZXh0KSwKICAgICAgICAgIC8vIGVtaXQKICAgICAgICAgIGVtaXQ6IG51bGwsCiAgICAgICAgICBlbWl0dGVkOiBudWxsLAogICAgICAgICAgLy8gcHJvcHMgZGVmYXVsdCB2YWx1ZQogICAgICAgICAgcHJvcHNEZWZhdWx0czogRU1QVFlfT0JKLAogICAgICAgICAgLy8gaW5oZXJpdEF0dHJzCiAgICAgICAgICBpbmhlcml0QXR0cnM6IHR5cGUuaW5oZXJpdEF0dHJzLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgIGN0eDogRU1QVFlfT0JKLAogICAgICAgICAgZGF0YTogRU1QVFlfT0JKLAogICAgICAgICAgcHJvcHM6IEVNUFRZX09CSiwKICAgICAgICAgIGF0dHJzOiBFTVBUWV9PQkosCiAgICAgICAgICBzbG90czogRU1QVFlfT0JKLAogICAgICAgICAgcmVmczogRU1QVFlfT0JKLAogICAgICAgICAgc2V0dXBTdGF0ZTogRU1QVFlfT0JKLAogICAgICAgICAgc2V0dXBDb250ZXh0OiBudWxsLAogICAgICAgICAgLy8gc3VzcGVuc2UgcmVsYXRlZAogICAgICAgICAgc3VzcGVuc2UsCiAgICAgICAgICBzdXNwZW5zZUlkOiBzdXNwZW5zZSA/IHN1c3BlbnNlLnBlbmRpbmdJZCA6IDAsCiAgICAgICAgICBhc3luY0RlcDogbnVsbCwKICAgICAgICAgIGFzeW5jUmVzb2x2ZWQ6IGZhbHNlLAogICAgICAgICAgLy8gbGlmZWN5Y2xlIGhvb2tzCiAgICAgICAgICAvLyBub3QgdXNpbmcgZW51bXMgaGVyZSBiZWNhdXNlIGl0IHJlc3VsdHMgaW4gY29tcHV0ZWQgcHJvcGVydGllcwogICAgICAgICAgaXNNb3VudGVkOiBmYWxzZSwKICAgICAgICAgIGlzVW5tb3VudGVkOiBmYWxzZSwKICAgICAgICAgIGlzRGVhY3RpdmF0ZWQ6IGZhbHNlLAogICAgICAgICAgYmM6IG51bGwsCiAgICAgICAgICBjOiBudWxsLAogICAgICAgICAgYm06IG51bGwsCiAgICAgICAgICBtOiBudWxsLAogICAgICAgICAgYnU6IG51bGwsCiAgICAgICAgICB1OiBudWxsLAogICAgICAgICAgdW06IG51bGwsCiAgICAgICAgICBidW06IG51bGwsCiAgICAgICAgICBkYTogbnVsbCwKICAgICAgICAgIGE6IG51bGwsCiAgICAgICAgICBydGc6IG51bGwsCiAgICAgICAgICBydGM6IG51bGwsCiAgICAgICAgICBlYzogbnVsbCwKICAgICAgICAgIHNwOiBudWxsCiAgICAgIH07CiAgICAgIHsKICAgICAgICAgIGluc3RhbmNlLmN0eCA9IGNyZWF0ZURldlJlbmRlckNvbnRleHQoaW5zdGFuY2UpOwogICAgICB9CiAgICAgIGluc3RhbmNlLnJvb3QgPSBwYXJlbnQgPyBwYXJlbnQucm9vdCA6IGluc3RhbmNlOwogICAgICBpbnN0YW5jZS5lbWl0ID0gZW1pdCQxLmJpbmQobnVsbCwgaW5zdGFuY2UpOwogICAgICAvLyBhcHBseSBjdXN0b20gZWxlbWVudCBzcGVjaWFsIGhhbmRsaW5nCiAgICAgIGlmICh2bm9kZS5jZSkgewogICAgICAgICAgdm5vZGUuY2UoaW5zdGFuY2UpOwogICAgICB9CiAgICAgIHJldHVybiBpbnN0YW5jZTsKICB9CiAgbGV0IGN1cnJlbnRJbnN0YW5jZSA9IG51bGw7CiAgY29uc3QgZ2V0Q3VycmVudEluc3RhbmNlID0gKCkgPT4gY3VycmVudEluc3RhbmNlIHx8IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICBjb25zdCBzZXRDdXJyZW50SW5zdGFuY2UgPSAoaW5zdGFuY2UpID0+IHsKICAgICAgY3VycmVudEluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgIGluc3RhbmNlLnNjb3BlLm9uKCk7CiAgfTsKICBjb25zdCB1bnNldEN1cnJlbnRJbnN0YW5jZSA9ICgpID0+IHsKICAgICAgY3VycmVudEluc3RhbmNlICYmIGN1cnJlbnRJbnN0YW5jZS5zY29wZS5vZmYoKTsKICAgICAgY3VycmVudEluc3RhbmNlID0gbnVsbDsKICB9OwogIGNvbnN0IGlzQnVpbHRJblRhZyA9IC8qI19fUFVSRV9fKi8gbWFrZU1hcCgnc2xvdCxjb21wb25lbnQnKTsKICBmdW5jdGlvbiB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSwgY29uZmlnKSB7CiAgICAgIGNvbnN0IGFwcElzTmF0aXZlVGFnID0gY29uZmlnLmlzTmF0aXZlVGFnIHx8IE5POwogICAgICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGFwcElzTmF0aXZlVGFnKG5hbWUpKSB7CiAgICAgICAgICB3YXJuJDEoJ0RvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgaWQ6ICcgKyBuYW1lKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBpc1N0YXRlZnVsQ29tcG9uZW50KGluc3RhbmNlKSB7CiAgICAgIHJldHVybiBpbnN0YW5jZS52bm9kZS5zaGFwZUZsYWcgJiA0IC8qIFNUQVRFRlVMX0NPTVBPTkVOVCAqLzsKICB9CiAgbGV0IGlzSW5TU1JDb21wb25lbnRTZXR1cCA9IGZhbHNlOwogIGZ1bmN0aW9uIHNldHVwQ29tcG9uZW50KGluc3RhbmNlLCBpc1NTUiA9IGZhbHNlKSB7CiAgICAgIGlzSW5TU1JDb21wb25lbnRTZXR1cCA9IGlzU1NSOwogICAgICBjb25zdCB7IHByb3BzLCBjaGlsZHJlbiB9ID0gaW5zdGFuY2Uudm5vZGU7CiAgICAgIGNvbnN0IGlzU3RhdGVmdWwgPSBpc1N0YXRlZnVsQ29tcG9uZW50KGluc3RhbmNlKTsKICAgICAgaW5pdFByb3BzKGluc3RhbmNlLCBwcm9wcywgaXNTdGF0ZWZ1bCwgaXNTU1IpOwogICAgICBpbml0U2xvdHMoaW5zdGFuY2UsIGNoaWxkcmVuKTsKICAgICAgY29uc3Qgc2V0dXBSZXN1bHQgPSBpc1N0YXRlZnVsCiAgICAgICAgICA/IHNldHVwU3RhdGVmdWxDb21wb25lbnQoaW5zdGFuY2UsIGlzU1NSKQogICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgIGlzSW5TU1JDb21wb25lbnRTZXR1cCA9IGZhbHNlOwogICAgICByZXR1cm4gc2V0dXBSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHNldHVwU3RhdGVmdWxDb21wb25lbnQoaW5zdGFuY2UsIGlzU1NSKSB7CiAgICAgIHZhciBfYTsKICAgICAgY29uc3QgQ29tcG9uZW50ID0gaW5zdGFuY2UudHlwZTsKICAgICAgewogICAgICAgICAgaWYgKENvbXBvbmVudC5uYW1lKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKENvbXBvbmVudC5uYW1lLCBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQ29tcG9uZW50LmNvbXBvbmVudHMpIHsKICAgICAgICAgICAgICBjb25zdCBuYW1lcyA9IE9iamVjdC5rZXlzKENvbXBvbmVudC5jb21wb25lbnRzKTsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lc1tpXSwgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChDb21wb25lbnQuZGlyZWN0aXZlcykgewogICAgICAgICAgICAgIGNvbnN0IG5hbWVzID0gT2JqZWN0LmtleXMoQ29tcG9uZW50LmRpcmVjdGl2ZXMpOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVEaXJlY3RpdmVOYW1lKG5hbWVzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQ29tcG9uZW50LmNvbXBpbGVyT3B0aW9ucyAmJiBpc1J1bnRpbWVPbmx5KCkpIHsKICAgICAgICAgICAgICB3YXJuJDEoYCJjb21waWxlck9wdGlvbnMiIGlzIG9ubHkgc3VwcG9ydGVkIHdoZW4gdXNpbmcgYSBidWlsZCBvZiBWdWUgdGhhdCBgICsKICAgICAgICAgICAgICAgICAgYGluY2x1ZGVzIHRoZSBydW50aW1lIGNvbXBpbGVyLiBTaW5jZSB5b3UgYXJlIHVzaW5nIGEgcnVudGltZS1vbmx5IGAgKwogICAgICAgICAgICAgICAgICBgYnVpbGQsIHRoZSBvcHRpb25zIHNob3VsZCBiZSBwYXNzZWQgdmlhIHlvdXIgYnVpbGQgdG9vbCBjb25maWcgaW5zdGVhZC5gKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICAvLyAwLiBjcmVhdGUgcmVuZGVyIHByb3h5IHByb3BlcnR5IGFjY2VzcyBjYWNoZQogICAgICBpbnN0YW5jZS5hY2Nlc3NDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIC8vIDEuIGNyZWF0ZSBwdWJsaWMgaW5zdGFuY2UgLyByZW5kZXIgcHJveHkKICAgICAgLy8gYWxzbyBtYXJrIGl0IHJhdyBzbyBpdCdzIG5ldmVyIG9ic2VydmVkCiAgICAgIGluc3RhbmNlLnByb3h5ID0gbWFya1JhdyhuZXcgUHJveHkoaW5zdGFuY2UuY3R4LCBQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMpKTsKICAgICAgewogICAgICAgICAgZXhwb3NlUHJvcHNPblJlbmRlckNvbnRleHQoaW5zdGFuY2UpOwogICAgICB9CiAgICAgIC8vIDIuIGNhbGwgc2V0dXAoKQogICAgICBjb25zdCB7IHNldHVwIH0gPSBDb21wb25lbnQ7CiAgICAgIGlmIChzZXR1cCkgewogICAgICAgICAgY29uc3Qgc2V0dXBDb250ZXh0ID0gKGluc3RhbmNlLnNldHVwQ29udGV4dCA9CiAgICAgICAgICAgICAgc2V0dXAubGVuZ3RoID4gMSA/IGNyZWF0ZVNldHVwQ29udGV4dChpbnN0YW5jZSkgOiBudWxsKTsKICAgICAgICAgIHNldEN1cnJlbnRJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgICAgICBjb25zdCBzZXR1cFJlc3VsdCA9IGNhbGxXaXRoRXJyb3JIYW5kbGluZyhzZXR1cCwgaW5zdGFuY2UsIDAgLyogU0VUVVBfRlVOQ1RJT04gKi8sIFtzaGFsbG93UmVhZG9ubHkoaW5zdGFuY2UucHJvcHMpICwgc2V0dXBDb250ZXh0XSk7CiAgICAgICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgICAgICB1bnNldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICAgICAgaWYgKGlzUHJvbWlzZShzZXR1cFJlc3VsdCkpIHsKICAgICAgICAgICAgICBzZXR1cFJlc3VsdC50aGVuKHVuc2V0Q3VycmVudEluc3RhbmNlLCB1bnNldEN1cnJlbnRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgaWYgKGlzU1NSKSB7CiAgICAgICAgICAgICAgICAgIC8vIHJldHVybiB0aGUgcHJvbWlzZSBzbyBzZXJ2ZXItcmVuZGVyZXIgY2FuIHdhaXQgb24gaXQKICAgICAgICAgICAgICAgICAgcmV0dXJuIHNldHVwUmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzb2x2ZWRSZXN1bHQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCByZXNvbHZlZFJlc3VsdCwgaXNTU1IpOwogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgaW5zdGFuY2UsIDAgLyogU0VUVVBfRlVOQ1RJT04gKi8pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIGFzeW5jIHNldHVwIHJldHVybmVkIFByb21pc2UuCiAgICAgICAgICAgICAgICAgIC8vIGJhaWwgaGVyZSBhbmQgd2FpdCBmb3IgcmUtZW50cnkuCiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmFzeW5jRGVwID0gc2V0dXBSZXN1bHQ7CiAgICAgICAgICAgICAgICAgIGlmICghaW5zdGFuY2Uuc3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAoX2EgPSBDb21wb25lbnQubmFtZSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogJ0Fub255bW91cyc7CiAgICAgICAgICAgICAgICAgICAgICB3YXJuJDEoYENvbXBvbmVudCA8JHtuYW1lfT46IHNldHVwIGZ1bmN0aW9uIHJldHVybmVkIGEgcHJvbWlzZSwgYnV0IG5vIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgIGA8U3VzcGVuc2U+IGJvdW5kYXJ5IHdhcyBmb3VuZCBpbiB0aGUgcGFyZW50IGNvbXBvbmVudCB0cmVlLiBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgQSBjb21wb25lbnQgd2l0aCBhc3luYyBzZXR1cCgpIG11c3QgYmUgbmVzdGVkIGluIGEgPFN1c3BlbnNlPiBgICsKICAgICAgICAgICAgICAgICAgICAgICAgICBgaW4gb3JkZXIgdG8gYmUgcmVuZGVyZWQuYCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBoYW5kbGVTZXR1cFJlc3VsdChpbnN0YW5jZSwgc2V0dXBSZXN1bHQsIGlzU1NSKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUik7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gaGFuZGxlU2V0dXBSZXN1bHQoaW5zdGFuY2UsIHNldHVwUmVzdWx0LCBpc1NTUikgewogICAgICBpZiAoaXNGdW5jdGlvbihzZXR1cFJlc3VsdCkpIHsKICAgICAgICAgIC8vIHNldHVwIHJldHVybmVkIGFuIGlubGluZSByZW5kZXIgZnVuY3Rpb24KICAgICAgICAgIHsKICAgICAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIgPSBzZXR1cFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChpc09iamVjdChzZXR1cFJlc3VsdCkpIHsKICAgICAgICAgIGlmIChpc1ZOb2RlKHNldHVwUmVzdWx0KSkgewogICAgICAgICAgICAgIHdhcm4kMShgc2V0dXAoKSBzaG91bGQgbm90IHJldHVybiBWTm9kZXMgZGlyZWN0bHkgLSBgICsKICAgICAgICAgICAgICAgICAgYHJldHVybiBhIHJlbmRlciBmdW5jdGlvbiBpbnN0ZWFkLmApOwogICAgICAgICAgfQogICAgICAgICAgLy8gc2V0dXAgcmV0dXJuZWQgYmluZGluZ3MuCiAgICAgICAgICAvLyBhc3N1bWluZyBhIHJlbmRlciBmdW5jdGlvbiBjb21waWxlZCBmcm9tIHRlbXBsYXRlIGlzIHByZXNlbnQuCiAgICAgICAgICB7CiAgICAgICAgICAgICAgaW5zdGFuY2UuZGV2dG9vbHNSYXdTZXR1cFN0YXRlID0gc2V0dXBSZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5zZXR1cFN0YXRlID0gcHJveHlSZWZzKHNldHVwUmVzdWx0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgICBleHBvc2VTZXR1cFN0YXRlT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChzZXR1cFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB3YXJuJDEoYHNldHVwKCkgc2hvdWxkIHJldHVybiBhbiBvYmplY3QuIFJlY2VpdmVkOiAke3NldHVwUmVzdWx0ID09PSBudWxsID8gJ251bGwnIDogdHlwZW9mIHNldHVwUmVzdWx0fWApOwogICAgICB9CiAgICAgIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUik7CiAgfQogIGxldCBjb21waWxlOwogIGxldCBpbnN0YWxsV2l0aFByb3h5OwogIC8qKgogICAqIEZvciBydW50aW1lLWRvbSB0byByZWdpc3RlciB0aGUgY29tcGlsZXIuCiAgICogTm90ZSB0aGUgZXhwb3J0ZWQgbWV0aG9kIHVzZXMgYW55IHRvIGF2b2lkIGQudHMgcmVseWluZyBvbiB0aGUgY29tcGlsZXIgdHlwZXMuCiAgICovCiAgZnVuY3Rpb24gcmVnaXN0ZXJSdW50aW1lQ29tcGlsZXIoX2NvbXBpbGUpIHsKICAgICAgY29tcGlsZSA9IF9jb21waWxlOwogICAgICBpbnN0YWxsV2l0aFByb3h5ID0gaSA9PiB7CiAgICAgICAgICBpZiAoaS5yZW5kZXIuX3JjKSB7CiAgICAgICAgICAgICAgaS53aXRoUHJveHkgPSBuZXcgUHJveHkoaS5jdHgsIFJ1bnRpbWVDb21waWxlZFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycyk7CiAgICAgICAgICB9CiAgICAgIH07CiAgfQogIC8vIGRldiBvbmx5CiAgY29uc3QgaXNSdW50aW1lT25seSA9ICgpID0+ICFjb21waWxlOwogIGZ1bmN0aW9uIGZpbmlzaENvbXBvbmVudFNldHVwKGluc3RhbmNlLCBpc1NTUiwgc2tpcE9wdGlvbnMpIHsKICAgICAgY29uc3QgQ29tcG9uZW50ID0gaW5zdGFuY2UudHlwZTsKICAgICAgLy8gdGVtcGxhdGUgLyByZW5kZXIgZnVuY3Rpb24gbm9ybWFsaXphdGlvbgogICAgICAvLyBjb3VsZCBiZSBhbHJlYWR5IHNldCB3aGVuIHJldHVybmVkIGZyb20gc2V0dXAoKQogICAgICBpZiAoIWluc3RhbmNlLnJlbmRlcikgewogICAgICAgICAgLy8gb25seSBkbyBvbi10aGUtZmx5IGNvbXBpbGUgaWYgbm90IGluIFNTUiAtIFNTUiBvbi10aGUtZmx5IGNvbXBpbGF0aW9uCiAgICAgICAgICAvLyBpcyBkb25lIGJ5IHNlcnZlci1yZW5kZXJlcgogICAgICAgICAgaWYgKCFpc1NTUiAmJiBjb21waWxlICYmICFDb21wb25lbnQucmVuZGVyKSB7CiAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBDb21wb25lbnQudGVtcGxhdGU7CiAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYGNvbXBpbGVgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb25zdCB7IGlzQ3VzdG9tRWxlbWVudCwgY29tcGlsZXJPcHRpb25zIH0gPSBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZzsKICAgICAgICAgICAgICAgICAgY29uc3QgeyBkZWxpbWl0ZXJzLCBjb21waWxlck9wdGlvbnM6IGNvbXBvbmVudENvbXBpbGVyT3B0aW9ucyB9ID0gQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICBjb25zdCBmaW5hbENvbXBpbGVyT3B0aW9ucyA9IGV4dGVuZChleHRlbmQoewogICAgICAgICAgICAgICAgICAgICAgaXNDdXN0b21FbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgZGVsaW1pdGVycwogICAgICAgICAgICAgICAgICB9LCBjb21waWxlck9wdGlvbnMpLCBjb21wb25lbnRDb21waWxlck9wdGlvbnMpOwogICAgICAgICAgICAgICAgICBDb21wb25lbnQucmVuZGVyID0gY29tcGlsZSh0ZW1wbGF0ZSwgZmluYWxDb21waWxlck9wdGlvbnMpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgY29tcGlsZWApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UucmVuZGVyID0gKENvbXBvbmVudC5yZW5kZXIgfHwgTk9PUCk7CiAgICAgICAgICAvLyBmb3IgcnVudGltZS1jb21waWxlZCByZW5kZXIgZnVuY3Rpb25zIHVzaW5nIGB3aXRoYCBibG9ja3MsIHRoZSByZW5kZXIKICAgICAgICAgIC8vIHByb3h5IHVzZWQgbmVlZHMgYSBkaWZmZXJlbnQgYGhhc2AgaGFuZGxlciB3aGljaCBpcyBtb3JlIHBlcmZvcm1hbnQgYW5kCiAgICAgICAgICAvLyBhbHNvIG9ubHkgYWxsb3dzIGEgd2hpdGVsaXN0IG9mIGdsb2JhbHMgdG8gZmFsbHRocm91Z2guCiAgICAgICAgICBpZiAoaW5zdGFsbFdpdGhQcm94eSkgewogICAgICAgICAgICAgIGluc3RhbGxXaXRoUHJveHkoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIHN1cHBvcnQgZm9yIDIueCBvcHRpb25zCiAgICAgIHsKICAgICAgICAgIHNldEN1cnJlbnRJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgICAgICBhcHBseU9wdGlvbnMoaW5zdGFuY2UpOwogICAgICAgICAgcmVzZXRUcmFja2luZygpOwogICAgICAgICAgdW5zZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgICAgfQogICAgICAvLyB3YXJuIG1pc3NpbmcgdGVtcGxhdGUvcmVuZGVyCiAgICAgIC8vIHRoZSBydW50aW1lIGNvbXBpbGF0aW9uIG9mIHRlbXBsYXRlIGluIFNTUiBpcyBkb25lIGJ5IHNlcnZlci1yZW5kZXIKICAgICAgaWYgKCFDb21wb25lbnQucmVuZGVyICYmIGluc3RhbmNlLnJlbmRlciA9PT0gTk9PUCAmJiAhaXNTU1IpIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgaWYgKCFjb21waWxlICYmIENvbXBvbmVudC50ZW1wbGF0ZSkgewogICAgICAgICAgICAgIHdhcm4kMShgQ29tcG9uZW50IHByb3ZpZGVkIHRlbXBsYXRlIG9wdGlvbiBidXQgYCArCiAgICAgICAgICAgICAgICAgIGBydW50aW1lIGNvbXBpbGF0aW9uIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBidWlsZCBvZiBWdWUuYCArCiAgICAgICAgICAgICAgICAgIChgIFVzZSAidnVlLmdsb2JhbC5qcyIgaW5zdGVhZC5gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgLyogc2hvdWxkIG5vdCBoYXBwZW4gKi8pOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgd2FybiQxKGBDb21wb25lbnQgaXMgbWlzc2luZyB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24uYCk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gY3JlYXRlQXR0cnNQcm94eShpbnN0YW5jZSkgewogICAgICByZXR1cm4gbmV3IFByb3h5KGluc3RhbmNlLmF0dHJzLCB7CiAgICAgICAgICAgICAgZ2V0KHRhcmdldCwga2V5KSB7CiAgICAgICAgICAgICAgICAgIG1hcmtBdHRyc0FjY2Vzc2VkKCk7CiAgICAgICAgICAgICAgICAgIHRyYWNrKGluc3RhbmNlLCAiZ2V0IiAvKiBHRVQgKi8sICckYXR0cnMnKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFtrZXldOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0KCkgewogICAgICAgICAgICAgICAgICB3YXJuJDEoYHNldHVwQ29udGV4dC5hdHRycyBpcyByZWFkb25seS5gKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVsZXRlUHJvcGVydHkoKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgc2V0dXBDb250ZXh0LmF0dHJzIGlzIHJlYWRvbmx5LmApOwogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlU2V0dXBDb250ZXh0KGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IGV4cG9zZSA9IGV4cG9zZWQgPT4gewogICAgICAgICAgaWYgKGluc3RhbmNlLmV4cG9zZWQpIHsKICAgICAgICAgICAgICB3YXJuJDEoYGV4cG9zZSgpIHNob3VsZCBiZSBjYWxsZWQgb25seSBvbmNlIHBlciBzZXR1cCgpLmApOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UuZXhwb3NlZCA9IGV4cG9zZWQgfHwge307CiAgICAgIH07CiAgICAgIGxldCBhdHRyczsKICAgICAgewogICAgICAgICAgLy8gV2UgdXNlIGdldHRlcnMgaW4gZGV2IGluIGNhc2UgbGlicyBsaWtlIHRlc3QtdXRpbHMgb3ZlcndyaXRlIGluc3RhbmNlCiAgICAgICAgICAvLyBwcm9wZXJ0aWVzIChvdmVyd3JpdGVzIHNob3VsZCBub3QgYmUgZG9uZSBpbiBwcm9kKQogICAgICAgICAgcmV0dXJuIE9iamVjdC5mcmVlemUoewogICAgICAgICAgICAgIGdldCBhdHRycygpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0dHJzIHx8IChhdHRycyA9IGNyZWF0ZUF0dHJzUHJveHkoaW5zdGFuY2UpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGdldCBzbG90cygpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHNoYWxsb3dSZWFkb25seShpbnN0YW5jZS5zbG90cyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBnZXQgZW1pdCgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIChldmVudCwgLi4uYXJncykgPT4gaW5zdGFuY2UuZW1pdChldmVudCwgLi4uYXJncyk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBleHBvc2UKICAgICAgICAgIH0pOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEV4cG9zZVByb3h5KGluc3RhbmNlKSB7CiAgICAgIGlmIChpbnN0YW5jZS5leHBvc2VkKSB7CiAgICAgICAgICByZXR1cm4gKGluc3RhbmNlLmV4cG9zZVByb3h5IHx8CiAgICAgICAgICAgICAgKGluc3RhbmNlLmV4cG9zZVByb3h5ID0gbmV3IFByb3h5KHByb3h5UmVmcyhtYXJrUmF3KGluc3RhbmNlLmV4cG9zZWQpKSwgewogICAgICAgICAgICAgICAgICBnZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoa2V5IGluIHB1YmxpY1Byb3BlcnRpZXNNYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHVibGljUHJvcGVydGllc01hcFtrZXldKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pKSk7CiAgICAgIH0KICB9CiAgY29uc3QgY2xhc3NpZnlSRSA9IC8oPzpefFstX10pKFx3KS9nOwogIGNvbnN0IGNsYXNzaWZ5ID0gKHN0cikgPT4gc3RyLnJlcGxhY2UoY2xhc3NpZnlSRSwgYyA9PiBjLnRvVXBwZXJDYXNlKCkpLnJlcGxhY2UoL1stX10vZywgJycpOwogIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWUoQ29tcG9uZW50KSB7CiAgICAgIHJldHVybiBpc0Z1bmN0aW9uKENvbXBvbmVudCkKICAgICAgICAgID8gQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lCiAgICAgICAgICA6IENvbXBvbmVudC5uYW1lOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIGZ1bmN0aW9uIGZvcm1hdENvbXBvbmVudE5hbWUoaW5zdGFuY2UsIENvbXBvbmVudCwgaXNSb290ID0gZmFsc2UpIHsKICAgICAgbGV0IG5hbWUgPSBnZXRDb21wb25lbnROYW1lKENvbXBvbmVudCk7CiAgICAgIGlmICghbmFtZSAmJiBDb21wb25lbnQuX19maWxlKSB7CiAgICAgICAgICBjb25zdCBtYXRjaCA9IENvbXBvbmVudC5fX2ZpbGUubWF0Y2goLyhbXi9cXF0rKVwuXHcrJC8pOwogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgbmFtZSA9IG1hdGNoWzFdOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghbmFtZSAmJiBpbnN0YW5jZSAmJiBpbnN0YW5jZS5wYXJlbnQpIHsKICAgICAgICAgIC8vIHRyeSB0byBpbmZlciB0aGUgbmFtZSBiYXNlZCBvbiByZXZlcnNlIHJlc29sdXRpb24KICAgICAgICAgIGNvbnN0IGluZmVyRnJvbVJlZ2lzdHJ5ID0gKHJlZ2lzdHJ5KSA9PiB7CiAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVnaXN0cnkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJ5W2tleV0gPT09IENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBuYW1lID0KICAgICAgICAgICAgICBpbmZlckZyb21SZWdpc3RyeShpbnN0YW5jZS5jb21wb25lbnRzIHx8CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnBhcmVudC50eXBlLmNvbXBvbmVudHMpIHx8IGluZmVyRnJvbVJlZ2lzdHJ5KGluc3RhbmNlLmFwcENvbnRleHQuY29tcG9uZW50cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5hbWUgPyBjbGFzc2lmeShuYW1lKSA6IGlzUm9vdCA/IGBBcHBgIDogYEFub255bW91c2A7CiAgfQogIGZ1bmN0aW9uIGlzQ2xhc3NDb21wb25lbnQodmFsdWUpIHsKICAgICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpICYmICdfX3ZjY09wdHMnIGluIHZhbHVlOwogIH0KCiAgY29uc3QgY29tcHV0ZWQkMSA9ICgoZ2V0dGVyT3JPcHRpb25zLCBkZWJ1Z09wdGlvbnMpID0+IHsKICAgICAgLy8gQHRzLWlnbm9yZQogICAgICByZXR1cm4gY29tcHV0ZWQoZ2V0dGVyT3JPcHRpb25zLCBkZWJ1Z09wdGlvbnMsIGlzSW5TU1JDb21wb25lbnRTZXR1cCk7CiAgfSk7CgogIC8vIGRldiBvbmx5CiAgY29uc3Qgd2FyblJ1bnRpbWVVc2FnZSA9IChtZXRob2QpID0+IHdhcm4kMShgJHttZXRob2R9KCkgaXMgYSBjb21waWxlci1oaW50IGhlbHBlciB0aGF0IGlzIG9ubHkgdXNhYmxlIGluc2lkZSBgICsKICAgICAgYDxzY3JpcHQgc2V0dXA+IG9mIGEgc2luZ2xlIGZpbGUgY29tcG9uZW50LiBJdHMgYXJndW1lbnRzIHNob3VsZCBiZSBgICsKICAgICAgYGNvbXBpbGVkIGF3YXkgYW5kIHBhc3NpbmcgaXQgYXQgcnVudGltZSBoYXMgbm8gZWZmZWN0LmApOwogIC8vIGltcGxlbWVudGF0aW9uCiAgZnVuY3Rpb24gZGVmaW5lUHJvcHMoKSB7CiAgICAgIHsKICAgICAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZVByb3BzYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgfQogIC8vIGltcGxlbWVudGF0aW9uCiAgZnVuY3Rpb24gZGVmaW5lRW1pdHMoKSB7CiAgICAgIHsKICAgICAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZUVtaXRzYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIFZ1ZSBgPHNjcmlwdCBzZXR1cD5gIGNvbXBpbGVyIG1hY3JvIGZvciBkZWNsYXJpbmcgYSBjb21wb25lbnQncyBleHBvc2VkCiAgICogaW5zdGFuY2UgcHJvcGVydGllcyB3aGVuIGl0IGlzIGFjY2Vzc2VkIGJ5IGEgcGFyZW50IGNvbXBvbmVudCB2aWEgdGVtcGxhdGUKICAgKiByZWZzLgogICAqCiAgICogYDxzY3JpcHQgc2V0dXA+YCBjb21wb25lbnRzIGFyZSBjbG9zZWQgYnkgZGVmYXVsdCAtIGkuZS4gdmFyaWFibGVzIGluc2lkZQogICAqIHRoZSBgPHNjcmlwdCBzZXR1cD5gIHNjb3BlIGlzIG5vdCBleHBvc2VkIHRvIHBhcmVudCB1bmxlc3MgZXhwbGljaXRseSBleHBvc2VkCiAgICogdmlhIGBkZWZpbmVFeHBvc2VgLgogICAqCiAgICogVGhpcyBpcyBvbmx5IHVzYWJsZSBpbnNpZGUgYDxzY3JpcHQgc2V0dXA+YCwgaXMgY29tcGlsZWQgYXdheSBpbiB0aGUKICAgKiBvdXRwdXQgYW5kIHNob3VsZCAqKm5vdCoqIGJlIGFjdHVhbGx5IGNhbGxlZCBhdCBydW50aW1lLgogICAqLwogIGZ1bmN0aW9uIGRlZmluZUV4cG9zZShleHBvc2VkKSB7CiAgICAgIHsKICAgICAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZUV4cG9zZWApOwogICAgICB9CiAgfQogIC8qKgogICAqIFZ1ZSBgPHNjcmlwdCBzZXR1cD5gIGNvbXBpbGVyIG1hY3JvIGZvciBwcm92aWRpbmcgcHJvcHMgZGVmYXVsdCB2YWx1ZXMgd2hlbgogICAqIHVzaW5nIHR5cGUtYmFzZWQgYGRlZmluZVByb3BzYCBkZWNsYXJhdGlvbi4KICAgKgogICAqIEV4YW1wbGUgdXNhZ2U6CiAgICogYGBgdHMKICAgKiB3aXRoRGVmYXVsdHMoZGVmaW5lUHJvcHM8ewogICAqICAgc2l6ZT86IG51bWJlcgogICAqICAgbGFiZWxzPzogc3RyaW5nW10KICAgKiB9PigpLCB7CiAgICogICBzaXplOiAzLAogICAqICAgbGFiZWxzOiAoKSA9PiBbJ2RlZmF1bHQgbGFiZWwnXQogICAqIH0pCiAgICogYGBgCiAgICoKICAgKiBUaGlzIGlzIG9ubHkgdXNhYmxlIGluc2lkZSBgPHNjcmlwdCBzZXR1cD5gLCBpcyBjb21waWxlZCBhd2F5IGluIHRoZSBvdXRwdXQKICAgKiBhbmQgc2hvdWxkICoqbm90KiogYmUgYWN0dWFsbHkgY2FsbGVkIGF0IHJ1bnRpbWUuCiAgICovCiAgZnVuY3Rpb24gd2l0aERlZmF1bHRzKHByb3BzLCBkZWZhdWx0cykgewogICAgICB7CiAgICAgICAgICB3YXJuUnVudGltZVVzYWdlKGB3aXRoRGVmYXVsdHNgKTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gdXNlU2xvdHMoKSB7CiAgICAgIHJldHVybiBnZXRDb250ZXh0KCkuc2xvdHM7CiAgfQogIGZ1bmN0aW9uIHVzZUF0dHJzKCkgewogICAgICByZXR1cm4gZ2V0Q29udGV4dCgpLmF0dHJzOwogIH0KICBmdW5jdGlvbiBnZXRDb250ZXh0KCkgewogICAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICAgIGlmICghaSkgewogICAgICAgICAgd2FybiQxKGB1c2VDb250ZXh0KCkgY2FsbGVkIHdpdGhvdXQgYWN0aXZlIGluc3RhbmNlLmApOwogICAgICB9CiAgICAgIHJldHVybiBpLnNldHVwQ29udGV4dCB8fCAoaS5zZXR1cENvbnRleHQgPSBjcmVhdGVTZXR1cENvbnRleHQoaSkpOwogIH0KICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgbWVyZ2luZyBkZWZhdWx0IGRlY2xhcmF0aW9ucy4gSW1wb3J0ZWQgYnkgY29tcGlsZWQgY29kZQogICAqIG9ubHkuCiAgICogQGludGVybmFsCiAgICovCiAgZnVuY3Rpb24gbWVyZ2VEZWZhdWx0cyhyYXcsIGRlZmF1bHRzKSB7CiAgICAgIGNvbnN0IHByb3BzID0gaXNBcnJheShyYXcpCiAgICAgICAgICA/IHJhdy5yZWR1Y2UoKG5vcm1hbGl6ZWQsIHApID0+ICgobm9ybWFsaXplZFtwXSA9IHt9KSwgbm9ybWFsaXplZCksIHt9KQogICAgICAgICAgOiByYXc7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIGRlZmF1bHRzKSB7CiAgICAgICAgICBjb25zdCBvcHQgPSBwcm9wc1trZXldOwogICAgICAgICAgaWYgKG9wdCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5KG9wdCkgfHwgaXNGdW5jdGlvbihvcHQpKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW2tleV0gPSB7IHR5cGU6IG9wdCwgZGVmYXVsdDogZGVmYXVsdHNba2V5XSB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgb3B0LmRlZmF1bHQgPSBkZWZhdWx0c1trZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKG9wdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHByb3BzW2tleV0gPSB7IGRlZmF1bHQ6IGRlZmF1bHRzW2tleV0gfTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm4kMShgcHJvcHMgZGVmYXVsdCBrZXkgIiR7a2V5fSIgaGFzIG5vIGNvcnJlc3BvbmRpbmcgZGVjbGFyYXRpb24uYCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHByb3BzOwogIH0KICAvKioKICAgKiBVc2VkIHRvIGNyZWF0ZSBhIHByb3h5IGZvciB0aGUgcmVzdCBlbGVtZW50IHdoZW4gZGVzdHJ1Y3R1cmluZyBwcm9wcyB3aXRoCiAgICogZGVmaW5lUHJvcHMoKS4KICAgKiBAaW50ZXJuYWwKICAgKi8KICBmdW5jdGlvbiBjcmVhdGVQcm9wc1Jlc3RQcm94eShwcm9wcywgZXhjbHVkZWRLZXlzKSB7CiAgICAgIGNvbnN0IHJldCA9IHt9OwogICAgICBmb3IgKGNvbnN0IGtleSBpbiBwcm9wcykgewogICAgICAgICAgaWYgKCFleGNsdWRlZEtleXMuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZXQsIGtleSwgewogICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICBnZXQ6ICgpID0+IHByb3BzW2tleV0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0OwogIH0KICAvKioKICAgKiBgPHNjcmlwdCBzZXR1cD5gIGhlbHBlciBmb3IgcGVyc2lzdGluZyB0aGUgY3VycmVudCBpbnN0YW5jZSBjb250ZXh0IG92ZXIKICAgKiBhc3luYy9hd2FpdCBmbG93cy4KICAgKgogICAqIGBAdnVlL2NvbXBpbGVyLXNmY2AgY29udmVydHMgdGhlIGZvbGxvd2luZzoKICAgKgogICAqIGBgYHRzCiAgICogY29uc3QgeCA9IGF3YWl0IGZvbygpCiAgICogYGBgCiAgICoKICAgKiBpbnRvOgogICAqCiAgICogYGBgdHMKICAgKiBsZXQgX190ZW1wLCBfX3Jlc3RvcmUKICAgKiBjb25zdCB4ID0gKChbX190ZW1wLCBfX3Jlc3RvcmVdID0gd2l0aEFzeW5jQ29udGV4dCgoKSA9PiBmb28oKSkpLF9fdGVtcD1hd2FpdCBfX3RlbXAsX19yZXN0b3JlKCksX190ZW1wKQogICAqIGBgYAogICAqIEBpbnRlcm5hbAogICAqLwogIGZ1bmN0aW9uIHdpdGhBc3luY0NvbnRleHQoZ2V0QXdhaXRhYmxlKSB7CiAgICAgIGNvbnN0IGN0eCA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICBpZiAoIWN0eCkgewogICAgICAgICAgd2FybiQxKGB3aXRoQXN5bmNDb250ZXh0IGNhbGxlZCB3aXRob3V0IGFjdGl2ZSBjdXJyZW50IGluc3RhbmNlLiBgICsKICAgICAgICAgICAgICBgVGhpcyBpcyBsaWtlbHkgYSBidWcuYCk7CiAgICAgIH0KICAgICAgbGV0IGF3YWl0YWJsZSA9IGdldEF3YWl0YWJsZSgpOwogICAgICB1bnNldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICBpZiAoaXNQcm9taXNlKGF3YWl0YWJsZSkpIHsKICAgICAgICAgIGF3YWl0YWJsZSA9IGF3YWl0YWJsZS5jYXRjaChlID0+IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50SW5zdGFuY2UoY3R4KTsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIFthd2FpdGFibGUsICgpID0+IHNldEN1cnJlbnRJbnN0YW5jZShjdHgpXTsKICB9CgogIC8vIEFjdHVhbCBpbXBsZW1lbnRhdGlvbgogIGZ1bmN0aW9uIGgodHlwZSwgcHJvcHNPckNoaWxkcmVuLCBjaGlsZHJlbikgewogICAgICBjb25zdCBsID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgaWYgKGwgPT09IDIpIHsKICAgICAgICAgIGlmIChpc09iamVjdChwcm9wc09yQ2hpbGRyZW4pICYmICFpc0FycmF5KHByb3BzT3JDaGlsZHJlbikpIHsKICAgICAgICAgICAgICAvLyBzaW5nbGUgdm5vZGUgd2l0aG91dCBwcm9wcwogICAgICAgICAgICAgIGlmIChpc1ZOb2RlKHByb3BzT3JDaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKHR5cGUsIG51bGwsIFtwcm9wc09yQ2hpbGRyZW5dKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gcHJvcHMgd2l0aG91dCBjaGlsZHJlbgogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZSh0eXBlLCBwcm9wc09yQ2hpbGRyZW4pOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gb21pdCBwcm9wcwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZSh0eXBlLCBudWxsLCBwcm9wc09yQ2hpbGRyZW4pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgaWYgKGwgPiAzKSB7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAobCA9PT0gMyAmJiBpc1ZOb2RlKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgIGNoaWxkcmVuID0gW2NoaWxkcmVuXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZSh0eXBlLCBwcm9wc09yQ2hpbGRyZW4sIGNoaWxkcmVuKTsKICAgICAgfQogIH0KCiAgY29uc3Qgc3NyQ29udGV4dEtleSA9IFN5bWJvbChgc3NyQ29udGV4dGAgKTsKICBjb25zdCB1c2VTU1JDb250ZXh0ID0gKCkgPT4gewogICAgICB7CiAgICAgICAgICB3YXJuJDEoYHVzZVNTUkNvbnRleHQoKSBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBnbG9iYWwgYnVpbGQuYCk7CiAgICAgIH0KICB9OwoKICBmdW5jdGlvbiBpbml0Q3VzdG9tRm9ybWF0dGVyKCkgewogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1yZXN0cmljdGVkLWdsb2JhbHMgKi8KICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgdnVlU3R5bGUgPSB7IHN0eWxlOiAnY29sb3I6IzNiYTc3NicgfTsKICAgICAgY29uc3QgbnVtYmVyU3R5bGUgPSB7IHN0eWxlOiAnY29sb3I6IzBiMWJjOScgfTsKICAgICAgY29uc3Qgc3RyaW5nU3R5bGUgPSB7IHN0eWxlOiAnY29sb3I6I2I2MmUyNCcgfTsKICAgICAgY29uc3Qga2V5d29yZFN0eWxlID0geyBzdHlsZTogJ2NvbG9yOiM5ZDI4OGMnIH07CiAgICAgIC8vIGN1c3RvbSBmb3JtYXR0ZXIgZm9yIENocm9tZQogICAgICAvLyBodHRwczovL3d3dy5tYXR0emV1bmVydC5jb20vMjAxNi8wMi8xOS9jdXN0b20tY2hyb21lLWRldnRvb2xzLW9iamVjdC1mb3JtYXR0ZXJzLmh0bWwKICAgICAgY29uc3QgZm9ybWF0dGVyID0gewogICAgICAgICAgaGVhZGVyKG9iaikgewogICAgICAgICAgICAgIC8vIFRPRE8gYWxzbyBmb3JtYXQgQ29tcG9uZW50UHVibGljSW5zdGFuY2UgJiBjdHguc2xvdHMvYXR0cnMgaW4gc2V0dXAKICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG9iaikpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvYmouX19pc1Z1ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gWydkaXYnLCB2dWVTdHlsZSwgYFZ1ZUluc3RhbmNlYF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGlzUmVmKG9iaikpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICdkaXYnLAogICAgICAgICAgICAgICAgICAgICAge30sCiAgICAgICAgICAgICAgICAgICAgICBbJ3NwYW4nLCB2dWVTdHlsZSwgZ2VuUmVmRmxhZyhvYmopXSwKICAgICAgICAgICAgICAgICAgICAgICc8JywKICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdFZhbHVlKG9iai52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICBgPmAKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoaXNSZWFjdGl2ZShvYmopKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgICAnZGl2JywKICAgICAgICAgICAgICAgICAgICAgIHt9LAogICAgICAgICAgICAgICAgICAgICAgWydzcGFuJywgdnVlU3R5bGUsIGlzU2hhbGxvdyhvYmopID8gJ1NoYWxsb3dSZWFjdGl2ZScgOiAnUmVhY3RpdmUnXSwKICAgICAgICAgICAgICAgICAgICAgICc8JywKICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdFZhbHVlKG9iaiksCiAgICAgICAgICAgICAgICAgICAgICBgPiR7aXNSZWFkb25seShvYmopID8gYCAocmVhZG9ubHkpYCA6IGBgfWAKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAoaXNSZWFkb25seShvYmopKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgICAnZGl2JywKICAgICAgICAgICAgICAgICAgICAgIHt9LAogICAgICAgICAgICAgICAgICAgICAgWydzcGFuJywgdnVlU3R5bGUsIGlzU2hhbGxvdyhvYmopID8gJ1NoYWxsb3dSZWFkb25seScgOiAnUmVhZG9ubHknXSwKICAgICAgICAgICAgICAgICAgICAgICc8JywKICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdFZhbHVlKG9iaiksCiAgICAgICAgICAgICAgICAgICAgICAnPicKICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9LAogICAgICAgICAgaGFzQm9keShvYmopIHsKICAgICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2lzVnVlOwogICAgICAgICAgfSwKICAgICAgICAgIGJvZHkob2JqKSB7CiAgICAgICAgICAgICAgaWYgKG9iaiAmJiBvYmouX19pc1Z1ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgJ2RpdicsCiAgICAgICAgICAgICAgICAgICAgICB7fSwKICAgICAgICAgICAgICAgICAgICAgIC4uLmZvcm1hdEluc3RhbmNlKG9iai4kKQogICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfTsKICAgICAgZnVuY3Rpb24gZm9ybWF0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIGNvbnN0IGJsb2NrcyA9IFtdOwogICAgICAgICAgaWYgKGluc3RhbmNlLnR5cGUucHJvcHMgJiYgaW5zdGFuY2UucHJvcHMpIHsKICAgICAgICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCdwcm9wcycsIHRvUmF3KGluc3RhbmNlLnByb3BzKSkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluc3RhbmNlLnNldHVwU3RhdGUgIT09IEVNUFRZX09CSikgewogICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKGNyZWF0ZUluc3RhbmNlQmxvY2soJ3NldHVwJywgaW5zdGFuY2Uuc2V0dXBTdGF0ZSkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluc3RhbmNlLmRhdGEgIT09IEVNUFRZX09CSikgewogICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKGNyZWF0ZUluc3RhbmNlQmxvY2soJ2RhdGEnLCB0b1JhdyhpbnN0YW5jZS5kYXRhKSkpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY29tcHV0ZWQgPSBleHRyYWN0S2V5cyhpbnN0YW5jZSwgJ2NvbXB1dGVkJyk7CiAgICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCdjb21wdXRlZCcsIGNvbXB1dGVkKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmplY3RlZCA9IGV4dHJhY3RLZXlzKGluc3RhbmNlLCAnaW5qZWN0Jyk7CiAgICAgICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCdpbmplY3RlZCcsIGluamVjdGVkKSk7CiAgICAgICAgICB9CiAgICAgICAgICBibG9ja3MucHVzaChbCiAgICAgICAgICAgICAgJ2RpdicsCiAgICAgICAgICAgICAge30sCiAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAnc3BhbicsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBrZXl3b3JkU3R5bGUuc3R5bGUgKyAnO29wYWNpdHk6MC42NicKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgJyQgKGludGVybmFsKTogJwogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgWydvYmplY3QnLCB7IG9iamVjdDogaW5zdGFuY2UgfV0KICAgICAgICAgIF0pOwogICAgICAgICAgcmV0dXJuIGJsb2NrczsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZUJsb2NrKHR5cGUsIHRhcmdldCkgewogICAgICAgICAgdGFyZ2V0ID0gZXh0ZW5kKHt9LCB0YXJnZXQpOwogICAgICAgICAgaWYgKCFPYmplY3Qua2V5cyh0YXJnZXQpLmxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiBbJ3NwYW4nLCB7fV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICdkaXYnLAogICAgICAgICAgICAgIHsgc3R5bGU6ICdsaW5lLWhlaWdodDoxLjI1ZW07bWFyZ2luLWJvdHRvbTowLjZlbScgfSwKICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICdkaXYnLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogJ2NvbG9yOiM0NzY1ODInCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHR5cGUKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgJ2RpdicsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiAncGFkZGluZy1sZWZ0OjEuMjVlbScKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgLi4uT2JqZWN0LmtleXModGFyZ2V0KS5tYXAoa2V5ID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RpdicsCiAgICAgICAgICAgICAgICAgICAgICAgICAge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgWydzcGFuJywga2V5d29yZFN0eWxlLCBrZXkgKyAnOiAnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRWYWx1ZSh0YXJnZXRba2V5XSwgZmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIF0KICAgICAgICAgIF07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZm9ybWF0VmFsdWUodiwgYXNSYXcgPSB0cnVlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFsnc3BhbicsIG51bWJlclN0eWxlLCB2XTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB2ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIHJldHVybiBbJ3NwYW4nLCBzdHJpbmdTdHlsZSwgSlNPTi5zdHJpbmdpZnkodildOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHYgPT09ICdib29sZWFuJykgewogICAgICAgICAgICAgIHJldHVybiBbJ3NwYW4nLCBrZXl3b3JkU3R5bGUsIHZdOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaXNPYmplY3QodikpIHsKICAgICAgICAgICAgICByZXR1cm4gWydvYmplY3QnLCB7IG9iamVjdDogYXNSYXcgPyB0b1Jhdyh2KSA6IHYgfV07CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gWydzcGFuJywgc3RyaW5nU3R5bGUsIFN0cmluZyh2KV07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZXh0cmFjdEtleXMoaW5zdGFuY2UsIHR5cGUpIHsKICAgICAgICAgIGNvbnN0IENvbXAgPSBpbnN0YW5jZS50eXBlOwogICAgICAgICAgaWYgKGlzRnVuY3Rpb24oQ29tcCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBleHRyYWN0ZWQgPSB7fTsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGluc3RhbmNlLmN0eCkgewogICAgICAgICAgICAgIGlmIChpc0tleU9mVHlwZShDb21wLCBrZXksIHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhY3RlZFtrZXldID0gaW5zdGFuY2UuY3R4W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4dHJhY3RlZDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0tleU9mVHlwZShDb21wLCBrZXksIHR5cGUpIHsKICAgICAgICAgIGNvbnN0IG9wdHMgPSBDb21wW3R5cGVdOwogICAgICAgICAgaWYgKChpc0FycmF5KG9wdHMpICYmIG9wdHMuaW5jbHVkZXMoa2V5KSkgfHwKICAgICAgICAgICAgICAoaXNPYmplY3Qob3B0cykgJiYga2V5IGluIG9wdHMpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoQ29tcC5leHRlbmRzICYmIGlzS2V5T2ZUeXBlKENvbXAuZXh0ZW5kcywga2V5LCB0eXBlKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKENvbXAubWl4aW5zICYmIENvbXAubWl4aW5zLnNvbWUobSA9PiBpc0tleU9mVHlwZShtLCBrZXksIHR5cGUpKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdlblJlZkZsYWcodikgewogICAgICAgICAgaWYgKGlzU2hhbGxvdyh2KSkgewogICAgICAgICAgICAgIHJldHVybiBgU2hhbGxvd1JlZmA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodi5lZmZlY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gYENvbXB1dGVkUmVmYDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBgUmVmYDsKICAgICAgfQogICAgICBpZiAod2luZG93LmRldnRvb2xzRm9ybWF0dGVycykgewogICAgICAgICAgd2luZG93LmRldnRvb2xzRm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICB3aW5kb3cuZGV2dG9vbHNGb3JtYXR0ZXJzID0gW2Zvcm1hdHRlcl07CiAgICAgIH0KICB9CgogIGZ1bmN0aW9uIHdpdGhNZW1vKG1lbW8sIHJlbmRlciwgY2FjaGUsIGluZGV4KSB7CiAgICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlW2luZGV4XTsKICAgICAgaWYgKGNhY2hlZCAmJiBpc01lbW9TYW1lKGNhY2hlZCwgbWVtbykpIHsKICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgIH0KICAgICAgY29uc3QgcmV0ID0gcmVuZGVyKCk7CiAgICAgIC8vIHNoYWxsb3cgY2xvbmUKICAgICAgcmV0Lm1lbW8gPSBtZW1vLnNsaWNlKCk7CiAgICAgIHJldHVybiAoY2FjaGVbaW5kZXhdID0gcmV0KTsKICB9CiAgZnVuY3Rpb24gaXNNZW1vU2FtZShjYWNoZWQsIG1lbW8pIHsKICAgICAgY29uc3QgcHJldiA9IGNhY2hlZC5tZW1vOwogICAgICBpZiAocHJldi5sZW5ndGggIT0gbWVtby5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXYubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChoYXNDaGFuZ2VkKHByZXZbaV0sIG1lbW9baV0pKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIG1ha2Ugc3VyZSB0byBsZXQgcGFyZW50IGJsb2NrIHRyYWNrIGl0IHdoZW4gcmV0dXJuaW5nIGNhY2hlZAogICAgICBpZiAoaXNCbG9ja1RyZWVFbmFibGVkID4gMCAmJiBjdXJyZW50QmxvY2spIHsKICAgICAgICAgIGN1cnJlbnRCbG9jay5wdXNoKGNhY2hlZCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLyBDb3JlIEFQSSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBjb25zdCB2ZXJzaW9uID0gIjMuMi4zNiI7CiAgLyoqCiAgICogU1NSIHV0aWxzIGZvciBcQHZ1ZS9zZXJ2ZXItcmVuZGVyZXIuIE9ubHkgZXhwb3NlZCBpbiBjanMgYnVpbGRzLgogICAqIEBpbnRlcm5hbAogICAqLwogIGNvbnN0IHNzclV0aWxzID0gKG51bGwpOwogIC8qKgogICAqIEBpbnRlcm5hbCBvbmx5IGV4cG9zZWQgaW4gY29tcGF0IGJ1aWxkcwogICAqLwogIGNvbnN0IHJlc29sdmVGaWx0ZXIgPSBudWxsOwogIC8qKgogICAqIEBpbnRlcm5hbCBvbmx5IGV4cG9zZWQgaW4gY29tcGF0IGJ1aWxkcy4KICAgKi8KICBjb25zdCBjb21wYXRVdGlscyA9IChudWxsKTsKCiAgY29uc3Qgc3ZnTlMgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnOwogIGNvbnN0IGRvYyA9ICh0eXBlb2YgZG9jdW1lbnQgIT09ICd1bmRlZmluZWQnID8gZG9jdW1lbnQgOiBudWxsKTsKICBjb25zdCB0ZW1wbGF0ZUNvbnRhaW5lciA9IGRvYyAmJiAvKiNfX1BVUkVfXyovIGRvYy5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpOwogIGNvbnN0IG5vZGVPcHMgPSB7CiAgICAgIGluc2VydDogKGNoaWxkLCBwYXJlbnQsIGFuY2hvcikgPT4gewogICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgYW5jaG9yIHx8IG51bGwpOwogICAgICB9LAogICAgICByZW1vdmU6IGNoaWxkID0+IHsKICAgICAgICAgIGNvbnN0IHBhcmVudCA9IGNoaWxkLnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgY3JlYXRlRWxlbWVudDogKHRhZywgaXNTVkcsIGlzLCBwcm9wcykgPT4gewogICAgICAgICAgY29uc3QgZWwgPSBpc1NWRwogICAgICAgICAgICAgID8gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgdGFnKQogICAgICAgICAgICAgIDogZG9jLmNyZWF0ZUVsZW1lbnQodGFnLCBpcyA/IHsgaXMgfSA6IHVuZGVmaW5lZCk7CiAgICAgICAgICBpZiAodGFnID09PSAnc2VsZWN0JyAmJiBwcm9wcyAmJiBwcm9wcy5tdWx0aXBsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdtdWx0aXBsZScsIHByb3BzLm11bHRpcGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbDsKICAgICAgfSwKICAgICAgY3JlYXRlVGV4dDogdGV4dCA9PiBkb2MuY3JlYXRlVGV4dE5vZGUodGV4dCksCiAgICAgIGNyZWF0ZUNvbW1lbnQ6IHRleHQgPT4gZG9jLmNyZWF0ZUNvbW1lbnQodGV4dCksCiAgICAgIHNldFRleHQ6IChub2RlLCB0ZXh0KSA9PiB7CiAgICAgICAgICBub2RlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgIH0sCiAgICAgIHNldEVsZW1lbnRUZXh0OiAoZWwsIHRleHQpID0+IHsKICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgfSwKICAgICAgcGFyZW50Tm9kZTogbm9kZSA9PiBub2RlLnBhcmVudE5vZGUsCiAgICAgIG5leHRTaWJsaW5nOiBub2RlID0+IG5vZGUubmV4dFNpYmxpbmcsCiAgICAgIHF1ZXJ5U2VsZWN0b3I6IHNlbGVjdG9yID0+IGRvYy5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSwKICAgICAgc2V0U2NvcGVJZChlbCwgaWQpIHsKICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShpZCwgJycpOwogICAgICB9LAogICAgICBjbG9uZU5vZGUoZWwpIHsKICAgICAgICAgIGNvbnN0IGNsb25lZCA9IGVsLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgIC8vICMzMDcyCiAgICAgICAgICAvLyAtIGluIGBwYXRjaERPTVByb3BgLCB3ZSBzdG9yZSB0aGUgYWN0dWFsIHZhbHVlIGluIHRoZSBgZWwuX3ZhbHVlYCBwcm9wZXJ0eS4KICAgICAgICAgIC8vIC0gbm9ybWFsbHksIGVsZW1lbnRzIHVzaW5nIGA6dmFsdWVgIGJpbmRpbmdzIHdpbGwgbm90IGJlIGhvaXN0ZWQsIGJ1dCBpZgogICAgICAgICAgLy8gICB0aGUgYm91bmQgdmFsdWUgaXMgYSBjb25zdGFudCwgZS5nLiBgOnZhbHVlPSJ0cnVlImAgLSB0aGV5IGRvIGdldAogICAgICAgICAgLy8gICBob2lzdGVkLgogICAgICAgICAgLy8gLSBpbiBwcm9kdWN0aW9uLCBob2lzdGVkIG5vZGVzIGFyZSBjbG9uZWQgd2hlbiBzdWJzZXF1ZW50IGluc2VydHMsIGJ1dAogICAgICAgICAgLy8gICBjbG9uZU5vZGUoKSBkb2VzIG5vdCBjb3B5IHRoZSBjdXN0b20gcHJvcGVydHkgd2UgYXR0YWNoZWQuCiAgICAgICAgICAvLyAtIFRoaXMgbWF5IG5lZWQgdG8gYWNjb3VudCBmb3Igb3RoZXIgY3VzdG9tIERPTSBwcm9wZXJ0aWVzIHdlIGF0dGFjaCB0bwogICAgICAgICAgLy8gICBlbGVtZW50cyBpbiBhZGRpdGlvbiB0byBgX3ZhbHVlYCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAgaWYgKGBfdmFsdWVgIGluIGVsKSB7CiAgICAgICAgICAgICAgY2xvbmVkLl92YWx1ZSA9IGVsLl92YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjbG9uZWQ7CiAgICAgIH0sCiAgICAgIC8vIF9fVU5TQUZFX18KICAgICAgLy8gUmVhc29uOiBpbm5lckhUTUwuCiAgICAgIC8vIFN0YXRpYyBjb250ZW50IGhlcmUgY2FuIG9ubHkgY29tZSBmcm9tIGNvbXBpbGVkIHRlbXBsYXRlcy4KICAgICAgLy8gQXMgbG9uZyBhcyB0aGUgdXNlciBvbmx5IHVzZXMgdHJ1c3RlZCB0ZW1wbGF0ZXMsIHRoaXMgaXMgc2FmZS4KICAgICAgaW5zZXJ0U3RhdGljQ29udGVudChjb250ZW50LCBwYXJlbnQsIGFuY2hvciwgaXNTVkcsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgIC8vIDxwYXJlbnQ+IGJlZm9yZSB8IGZpcnN0IC4uLiBsYXN0IHwgYW5jaG9yIDwvcGFyZW50PgogICAgICAgICAgY29uc3QgYmVmb3JlID0gYW5jaG9yID8gYW5jaG9yLnByZXZpb3VzU2libGluZyA6IHBhcmVudC5sYXN0Q2hpbGQ7CiAgICAgICAgICAvLyAjNTMwOCBjYW4gb25seSB0YWtlIGNhY2hlZCBwYXRoIGlmOgogICAgICAgICAgLy8gLSBoYXMgYSBzaW5nbGUgcm9vdCBub2RlCiAgICAgICAgICAvLyAtIG5leHRTaWJsaW5nIGluZm8gaXMgc3RpbGwgYXZhaWxhYmxlCiAgICAgICAgICBpZiAoc3RhcnQgJiYgKHN0YXJ0ID09PSBlbmQgfHwgc3RhcnQubmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgLy8gY2FjaGVkCiAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShzdGFydC5jbG9uZU5vZGUodHJ1ZSksIGFuY2hvcik7CiAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA9PT0gZW5kIHx8ICEoc3RhcnQgPSBzdGFydC5uZXh0U2libGluZykpCiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyBmcmVzaCBpbnNlcnQKICAgICAgICAgICAgICB0ZW1wbGF0ZUNvbnRhaW5lci5pbm5lckhUTUwgPSBpc1NWRyA/IGA8c3ZnPiR7Y29udGVudH08L3N2Zz5gIDogY29udGVudDsKICAgICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ29udGFpbmVyLmNvbnRlbnQ7CiAgICAgICAgICAgICAgaWYgKGlzU1ZHKSB7CiAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBvdXRlciBzdmcgd3JhcHBlcgogICAgICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gdGVtcGxhdGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHdyYXBwZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuYXBwZW5kQ2hpbGQod3JhcHBlci5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5yZW1vdmVDaGlsZCh3cmFwcGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZSh0ZW1wbGF0ZSwgYW5jaG9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgLy8gZmlyc3QKICAgICAgICAgICAgICBiZWZvcmUgPyBiZWZvcmUubmV4dFNpYmxpbmcgOiBwYXJlbnQuZmlyc3RDaGlsZCwKICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgYW5jaG9yID8gYW5jaG9yLnByZXZpb3VzU2libGluZyA6IHBhcmVudC5sYXN0Q2hpbGQKICAgICAgICAgIF07CiAgICAgIH0KICB9OwoKICAvLyBjb21waWxlciBzaG91bGQgbm9ybWFsaXplIGNsYXNzICsgOmNsYXNzIGJpbmRpbmdzIG9uIHRoZSBzYW1lIGVsZW1lbnQKICAvLyBpbnRvIGEgc2luZ2xlIGJpbmRpbmcgWydzdGF0aWNDbGFzcycsIGR5bmFtaWNdCiAgZnVuY3Rpb24gcGF0Y2hDbGFzcyhlbCwgdmFsdWUsIGlzU1ZHKSB7CiAgICAgIC8vIGRpcmVjdGx5IHNldHRpbmcgY2xhc3NOYW1lIHNob3VsZCBiZSBmYXN0ZXIgdGhhbiBzZXRBdHRyaWJ1dGUgaW4gdGhlb3J5CiAgICAgIC8vIGlmIHRoaXMgaXMgYW4gZWxlbWVudCBkdXJpbmcgYSB0cmFuc2l0aW9uLCB0YWtlIHRoZSB0ZW1wb3JhcnkgdHJhbnNpdGlvbgogICAgICAvLyBjbGFzc2VzIGludG8gYWNjb3VudC4KICAgICAgY29uc3QgdHJhbnNpdGlvbkNsYXNzZXMgPSBlbC5fdnRjOwogICAgICBpZiAodHJhbnNpdGlvbkNsYXNzZXMpIHsKICAgICAgICAgIHZhbHVlID0gKHZhbHVlID8gW3ZhbHVlLCAuLi50cmFuc2l0aW9uQ2xhc3Nlc10gOiBbLi4udHJhbnNpdGlvbkNsYXNzZXNdKS5qb2luKCcgJyk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc1NWRykgewogICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIHZhbHVlKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGVsLmNsYXNzTmFtZSA9IHZhbHVlOwogICAgICB9CiAgfQoKICBmdW5jdGlvbiBwYXRjaFN0eWxlKGVsLCBwcmV2LCBuZXh0KSB7CiAgICAgIGNvbnN0IHN0eWxlID0gZWwuc3R5bGU7CiAgICAgIGNvbnN0IGlzQ3NzU3RyaW5nID0gaXNTdHJpbmcobmV4dCk7CiAgICAgIGlmIChuZXh0ICYmICFpc0Nzc1N0cmluZykgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV4dCkgewogICAgICAgICAgICAgIHNldFN0eWxlKHN0eWxlLCBrZXksIG5leHRba2V5XSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJldiAmJiAhaXNTdHJpbmcocHJldikpIHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBwcmV2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0W2tleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgJycpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY29uc3QgY3VycmVudERpc3BsYXkgPSBzdHlsZS5kaXNwbGF5OwogICAgICAgICAgaWYgKGlzQ3NzU3RyaW5nKSB7CiAgICAgICAgICAgICAgaWYgKHByZXYgIT09IG5leHQpIHsKICAgICAgICAgICAgICAgICAgc3R5bGUuY3NzVGV4dCA9IG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAocHJldikgewogICAgICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnc3R5bGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGluZGljYXRlcyB0aGF0IHRoZSBgZGlzcGxheWAgb2YgdGhlIGVsZW1lbnQgaXMgY29udHJvbGxlZCBieSBgdi1zaG93YCwKICAgICAgICAgIC8vIHNvIHdlIGFsd2F5cyBrZWVwIHRoZSBjdXJyZW50IGBkaXNwbGF5YCB2YWx1ZSByZWdhcmRsZXNzIG9mIHRoZSBgc3R5bGVgCiAgICAgICAgICAvLyB2YWx1ZSwgdGh1cyBoYW5kaW5nIG92ZXIgY29udHJvbCB0byBgdi1zaG93YC4KICAgICAgICAgIGlmICgnX3ZvZCcgaW4gZWwpIHsKICAgICAgICAgICAgICBzdHlsZS5kaXNwbGF5ID0gY3VycmVudERpc3BsYXk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgY29uc3QgaW1wb3J0YW50UkUgPSAvXHMqIWltcG9ydGFudCQvOwogIGZ1bmN0aW9uIHNldFN0eWxlKHN0eWxlLCBuYW1lLCB2YWwpIHsKICAgICAgaWYgKGlzQXJyYXkodmFsKSkgewogICAgICAgICAgdmFsLmZvckVhY2godiA9PiBzZXRTdHlsZShzdHlsZSwgbmFtZSwgdikpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgaWYgKHZhbCA9PSBudWxsKQogICAgICAgICAgICAgIHZhbCA9ICcnOwogICAgICAgICAgaWYgKG5hbWUuc3RhcnRzV2l0aCgnLS0nKSkgewogICAgICAgICAgICAgIC8vIGN1c3RvbSBwcm9wZXJ0eSBkZWZpbml0aW9uCiAgICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGNvbnN0IHByZWZpeGVkID0gYXV0b1ByZWZpeChzdHlsZSwgbmFtZSk7CiAgICAgICAgICAgICAgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgICAgICAgICAgICAgICAvLyAhaW1wb3J0YW50CiAgICAgICAgICAgICAgICAgIHN0eWxlLnNldFByb3BlcnR5KGh5cGhlbmF0ZShwcmVmaXhlZCksIHZhbC5yZXBsYWNlKGltcG9ydGFudFJFLCAnJyksICdpbXBvcnRhbnQnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0eWxlW3ByZWZpeGVkXSA9IHZhbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgY29uc3QgcHJlZml4ZXMgPSBbJ1dlYmtpdCcsICdNb3onLCAnbXMnXTsKICBjb25zdCBwcmVmaXhDYWNoZSA9IHt9OwogIGZ1bmN0aW9uIGF1dG9QcmVmaXgoc3R5bGUsIHJhd05hbWUpIHsKICAgICAgY29uc3QgY2FjaGVkID0gcHJlZml4Q2FjaGVbcmF3TmFtZV07CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgIH0KICAgICAgbGV0IG5hbWUgPSBjYW1lbGl6ZShyYXdOYW1lKTsKICAgICAgaWYgKG5hbWUgIT09ICdmaWx0ZXInICYmIG5hbWUgaW4gc3R5bGUpIHsKICAgICAgICAgIHJldHVybiAocHJlZml4Q2FjaGVbcmF3TmFtZV0gPSBuYW1lKTsKICAgICAgfQogICAgICBuYW1lID0gY2FwaXRhbGl6ZShuYW1lKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVmaXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcHJlZml4ZWQgPSBwcmVmaXhlc1tpXSArIG5hbWU7CiAgICAgICAgICBpZiAocHJlZml4ZWQgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gKHByZWZpeENhY2hlW3Jhd05hbWVdID0gcHJlZml4ZWQpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByYXdOYW1lOwogIH0KCiAgY29uc3QgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKICBmdW5jdGlvbiBwYXRjaEF0dHIoZWwsIGtleSwgdmFsdWUsIGlzU1ZHLCBpbnN0YW5jZSkgewogICAgICBpZiAoaXNTVkcgJiYga2V5LnN0YXJ0c1dpdGgoJ3hsaW5rOicpKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGtleS5zbGljZSg2LCBrZXkubGVuZ3RoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGVOUyh4bGlua05TLCBrZXksIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIG5vdGUgd2UgYXJlIG9ubHkgY2hlY2tpbmcgYm9vbGVhbiBhdHRyaWJ1dGVzIHRoYXQgZG9uJ3QgaGF2ZSBhCiAgICAgICAgICAvLyBjb3JyZXNwb25kaW5nIGRvbSBwcm9wIG9mIHRoZSBzYW1lIG5hbWUgaGVyZS4KICAgICAgICAgIGNvbnN0IGlzQm9vbGVhbiA9IGlzU3BlY2lhbEJvb2xlYW5BdHRyKGtleSk7CiAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCAoaXNCb29sZWFuICYmICFpbmNsdWRlQm9vbGVhbkF0dHIodmFsdWUpKSkgewogICAgICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKGtleSwgaXNCb29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CgogIC8vIF9fVU5TQUZFX18KICAvLyBmdW5jdGlvbnMuIFRoZSB1c2VyIGlzIHJlc3BvbnNpYmxlIGZvciB1c2luZyB0aGVtIHdpdGggb25seSB0cnVzdGVkIGNvbnRlbnQuCiAgZnVuY3Rpb24gcGF0Y2hET01Qcm9wKGVsLCBrZXksIHZhbHVlLCAKICAvLyB0aGUgZm9sbG93aW5nIGFyZ3MgYXJlIHBhc3NlZCBvbmx5IGR1ZSB0byBwb3RlbnRpYWwgaW5uZXJIVE1ML3RleHRDb250ZW50CiAgLy8gb3ZlcnJpZGluZyBleGlzdGluZyBWTm9kZXMsIGluIHdoaWNoIGNhc2UgdGhlIG9sZCB0cmVlIG11c3QgYmUgcHJvcGVybHkKICAvLyB1bm1vdW50ZWQuCiAgcHJldkNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB1bm1vdW50Q2hpbGRyZW4pIHsKICAgICAgaWYgKGtleSA9PT0gJ2lubmVySFRNTCcgfHwga2V5ID09PSAndGV4dENvbnRlbnQnKSB7CiAgICAgICAgICBpZiAocHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgdW5tb3VudENoaWxkcmVuKHByZXZDaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbFtrZXldID0gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGtleSA9PT0gJ3ZhbHVlJyAmJgogICAgICAgICAgZWwudGFnTmFtZSAhPT0gJ1BST0dSRVNTJyAmJgogICAgICAgICAgLy8gY3VzdG9tIGVsZW1lbnRzIG1heSB1c2UgX3ZhbHVlIGludGVybmFsbHkKICAgICAgICAgICFlbC50YWdOYW1lLmluY2x1ZGVzKCctJykpIHsKICAgICAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgICAgICAvLyBub24tc3RyaW5nIHZhbHVlcyB3aWxsIGJlIHN0cmluZ2lmaWVkLgogICAgICAgICAgZWwuX3ZhbHVlID0gdmFsdWU7CiAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHZhbHVlID09IG51bGwgPyAnJyA6IHZhbHVlOwogICAgICAgICAgaWYgKGVsLnZhbHVlICE9PSBuZXdWYWx1ZSB8fAogICAgICAgICAgICAgIC8vICM0OTU2OiBhbHdheXMgc2V0IGZvciBPUFRJT04gZWxlbWVudHMgYmVjYXVzZSBpdHMgdmFsdWUgZmFsbHMgYmFjayB0bwogICAgICAgICAgICAgIC8vIHRleHRDb250ZW50IGlmIG5vIHZhbHVlIGF0dHJpYnV0ZSBpcyBwcmVzZW50LiBBbmQgc2V0dGluZyAudmFsdWUgZm9yCiAgICAgICAgICAgICAgLy8gT1BUSU9OIGhhcyBubyBzaWRlIGVmZmVjdAogICAgICAgICAgICAgIGVsLnRhZ05hbWUgPT09ICdPUFRJT04nKSB7CiAgICAgICAgICAgICAgZWwudmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IG5lZWRSZW1vdmUgPSBmYWxzZTsKICAgICAgaWYgKHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCB0eXBlID0gdHlwZW9mIGVsW2tleV07CiAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgICAgLy8gZS5nLiA8c2VsZWN0IG11bHRpcGxlPiBjb21waWxlcyB0byB7IG11bHRpcGxlOiAnJyB9CiAgICAgICAgICAgICAgdmFsdWUgPSBpbmNsdWRlQm9vbGVhbkF0dHIodmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodmFsdWUgPT0gbnVsbCAmJiB0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIC8vIGUuZy4gPGRpdiA6aWQ9Im51bGwiPgogICAgICAgICAgICAgIHZhbHVlID0gJyc7CiAgICAgICAgICAgICAgbmVlZFJlbW92ZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIC8vIGUuZy4gPGltZyA6d2lkdGg9Im51bGwiPgogICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBvZiBzb21lIElETCBhdHRyIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAsIGUuZy4gaW5wdXQuc2l6ZSA9IDAgLT4gZXJyb3IKICAgICAgICAgICAgICB2YWx1ZSA9IDA7CiAgICAgICAgICAgICAgbmVlZFJlbW92ZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gc29tZSBwcm9wZXJ0aWVzIHBlcmZvcm0gdmFsdWUgdmFsaWRhdGlvbiBhbmQgdGhyb3csCiAgICAgIC8vIHNvbWUgcHJvcGVydGllcyBoYXMgZ2V0dGVyLCBubyBzZXR0ZXIsIHdpbGwgZXJyb3IgaW4gJ3VzZSBzdHJpY3QnCiAgICAgIC8vIGVnLiA8c2VsZWN0IDp0eXBlPSJudWxsIj48L3NlbGVjdD4gPHNlbGVjdCA6d2lsbFZhbGlkYXRlPSJudWxsIj48L3NlbGVjdD4KICAgICAgdHJ5IHsKICAgICAgICAgIGVsW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgICBjYXRjaCAoZSkgewogICAgICAgICAgewogICAgICAgICAgICAgIHdhcm4kMShgRmFpbGVkIHNldHRpbmcgcHJvcCAiJHtrZXl9IiBvbiA8JHtlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCl9PjogYCArCiAgICAgICAgICAgICAgICAgIGB2YWx1ZSAke3ZhbHVlfSBpcyBpbnZhbGlkLmAsIGUpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIG5lZWRSZW1vdmUgJiYgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgfQoKICAvLyBBc3luYyBlZGdlIGNhc2UgZml4IHJlcXVpcmVzIHN0b3JpbmcgYW4gZXZlbnQgbGlzdGVuZXIncyBhdHRhY2ggdGltZXN0YW1wLgogIGNvbnN0IFtfZ2V0Tm93LCBza2lwVGltZXN0YW1wQ2hlY2tdID0gLyojX19QVVJFX18qLyAoKCkgPT4gewogICAgICBsZXQgX2dldE5vdyA9IERhdGUubm93OwogICAgICBsZXQgc2tpcFRpbWVzdGFtcENoZWNrID0gZmFsc2U7CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgLy8gRGV0ZXJtaW5lIHdoYXQgZXZlbnQgdGltZXN0YW1wIHRoZSBicm93c2VyIGlzIHVzaW5nLiBBbm5veWluZ2x5LCB0aGUKICAgICAgICAgIC8vIHRpbWVzdGFtcCBjYW4gZWl0aGVyIGJlIGhpLXJlcyAocmVsYXRpdmUgdG8gcGFnZSBsb2FkKSBvciBsb3ctcmVzCiAgICAgICAgICAvLyAocmVsYXRpdmUgdG8gVU5JWCBlcG9jaCksIHNvIGluIG9yZGVyIHRvIGNvbXBhcmUgdGltZSB3ZSBoYXZlIHRvIHVzZSB0aGUKICAgICAgICAgIC8vIHNhbWUgdGltZXN0YW1wIHR5cGUgd2hlbiBzYXZpbmcgdGhlIGZsdXNoIHRpbWVzdGFtcC4KICAgICAgICAgIGlmIChEYXRlLm5vdygpID4gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50JykudGltZVN0YW1wKSB7CiAgICAgICAgICAgICAgLy8gaWYgdGhlIGxvdy1yZXMgdGltZXN0YW1wIHdoaWNoIGlzIGJpZ2dlciB0aGFuIHRoZSBldmVudCB0aW1lc3RhbXAKICAgICAgICAgICAgICAvLyAod2hpY2ggaXMgZXZhbHVhdGVkIEFGVEVSKSBpdCBtZWFucyB0aGUgZXZlbnQgaXMgdXNpbmcgYSBoaS1yZXMgdGltZXN0YW1wLAogICAgICAgICAgICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHVzZSB0aGUgaGktcmVzIHZlcnNpb24gZm9yIGV2ZW50IGxpc3RlbmVycyBhcyB3ZWxsLgogICAgICAgICAgICAgIF9nZXROb3cgPSBwZXJmb3JtYW5jZS5ub3cuYmluZChwZXJmb3JtYW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyAjMzQ4NTogRmlyZWZveCA8PSA1MyBoYXMgaW5jb3JyZWN0IEV2ZW50LnRpbWVTdGFtcCBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgLy8gYW5kIGRvZXMgbm90IGZpcmUgbWljcm90YXNrcyBpbiBiZXR3ZWVuIGV2ZW50IHByb3BhZ2F0aW9uLCBzbyBzYWZlIHRvIGV4Y2x1ZGUuCiAgICAgICAgICBjb25zdCBmZk1hdGNoID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvZmlyZWZveFwvKFxkKykvaSk7CiAgICAgICAgICBza2lwVGltZXN0YW1wQ2hlY2sgPSAhIShmZk1hdGNoICYmIE51bWJlcihmZk1hdGNoWzFdKSA8PSA1Myk7CiAgICAgIH0KICAgICAgcmV0dXJuIFtfZ2V0Tm93LCBza2lwVGltZXN0YW1wQ2hlY2tdOwogIH0pKCk7CiAgLy8gVG8gYXZvaWQgdGhlIG92ZXJoZWFkIG9mIHJlcGVhdGVkbHkgY2FsbGluZyBwZXJmb3JtYW5jZS5ub3coKSwgd2UgY2FjaGUKICAvLyBhbmQgdXNlIHRoZSBzYW1lIHRpbWVzdGFtcCBmb3IgYWxsIGV2ZW50IGxpc3RlbmVycyBhdHRhY2hlZCBpbiB0aGUgc2FtZSB0aWNrLgogIGxldCBjYWNoZWROb3cgPSAwOwogIGNvbnN0IHAgPSAvKiNfX1BVUkVfXyovIFByb21pc2UucmVzb2x2ZSgpOwogIGNvbnN0IHJlc2V0ID0gKCkgPT4gewogICAgICBjYWNoZWROb3cgPSAwOwogIH07CiAgY29uc3QgZ2V0Tm93ID0gKCkgPT4gY2FjaGVkTm93IHx8IChwLnRoZW4ocmVzZXQpLCAoY2FjaGVkTm93ID0gX2dldE5vdygpKSk7CiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpIHsKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgaGFuZGxlciwgb3B0aW9ucyk7CiAgfQogIGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIoZWwsIGV2ZW50LCBoYW5kbGVyLCBvcHRpb25zKSB7CiAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiBwYXRjaEV2ZW50KGVsLCByYXdOYW1lLCBwcmV2VmFsdWUsIG5leHRWYWx1ZSwgaW5zdGFuY2UgPSBudWxsKSB7CiAgICAgIC8vIHZlaSA9IHZ1ZSBldmVudCBpbnZva2VycwogICAgICBjb25zdCBpbnZva2VycyA9IGVsLl92ZWkgfHwgKGVsLl92ZWkgPSB7fSk7CiAgICAgIGNvbnN0IGV4aXN0aW5nSW52b2tlciA9IGludm9rZXJzW3Jhd05hbWVdOwogICAgICBpZiAobmV4dFZhbHVlICYmIGV4aXN0aW5nSW52b2tlcikgewogICAgICAgICAgLy8gcGF0Y2gKICAgICAgICAgIGV4aXN0aW5nSW52b2tlci52YWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IFtuYW1lLCBvcHRpb25zXSA9IHBhcnNlTmFtZShyYXdOYW1lKTsKICAgICAgICAgIGlmIChuZXh0VmFsdWUpIHsKICAgICAgICAgICAgICAvLyBhZGQKICAgICAgICAgICAgICBjb25zdCBpbnZva2VyID0gKGludm9rZXJzW3Jhd05hbWVdID0gY3JlYXRlSW52b2tlcihuZXh0VmFsdWUsIGluc3RhbmNlKSk7CiAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgbmFtZSwgaW52b2tlciwgb3B0aW9ucyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChleGlzdGluZ0ludm9rZXIpIHsKICAgICAgICAgICAgICAvLyByZW1vdmUKICAgICAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyKGVsLCBuYW1lLCBleGlzdGluZ0ludm9rZXIsIG9wdGlvbnMpOwogICAgICAgICAgICAgIGludm9rZXJzW3Jhd05hbWVdID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICB9CiAgfQogIGNvbnN0IG9wdGlvbnNNb2RpZmllclJFID0gLyg/Ok9uY2V8UGFzc2l2ZXxDYXB0dXJlKSQvOwogIGZ1bmN0aW9uIHBhcnNlTmFtZShuYW1lKSB7CiAgICAgIGxldCBvcHRpb25zOwogICAgICBpZiAob3B0aW9uc01vZGlmaWVyUkUudGVzdChuYW1lKSkgewogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgICAgbGV0IG07CiAgICAgICAgICB3aGlsZSAoKG0gPSBuYW1lLm1hdGNoKG9wdGlvbnNNb2RpZmllclJFKSkpIHsKICAgICAgICAgICAgICBuYW1lID0gbmFtZS5zbGljZSgwLCBuYW1lLmxlbmd0aCAtIG1bMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICBvcHRpb25zW21bMF0udG9Mb3dlckNhc2UoKV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBbaHlwaGVuYXRlKG5hbWUuc2xpY2UoMikpLCBvcHRpb25zXTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlSW52b2tlcihpbml0aWFsVmFsdWUsIGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IGludm9rZXIgPSAoZSkgPT4gewogICAgICAgICAgLy8gYXN5bmMgZWRnZSBjYXNlICM2NTY2OiBpbm5lciBjbGljayBldmVudCB0cmlnZ2VycyBwYXRjaCwgZXZlbnQgaGFuZGxlcgogICAgICAgICAgLy8gYXR0YWNoZWQgdG8gb3V0ZXIgZWxlbWVudCBkdXJpbmcgcGF0Y2gsIGFuZCB0cmlnZ2VyZWQgYWdhaW4uIFRoaXMKICAgICAgICAgIC8vIGhhcHBlbnMgYmVjYXVzZSBicm93c2VycyBmaXJlIG1pY3JvdGFzayB0aWNrcyBiZXR3ZWVuIGV2ZW50IHByb3BhZ2F0aW9uLgogICAgICAgICAgLy8gdGhlIHNvbHV0aW9uIGlzIHNpbXBsZTogd2Ugc2F2ZSB0aGUgdGltZXN0YW1wIHdoZW4gYSBoYW5kbGVyIGlzIGF0dGFjaGVkLAogICAgICAgICAgLy8gYW5kIHRoZSBoYW5kbGVyIHdvdWxkIG9ubHkgZmlyZSBpZiB0aGUgZXZlbnQgcGFzc2VkIHRvIGl0IHdhcyBmaXJlZAogICAgICAgICAgLy8gQUZURVIgaXQgd2FzIGF0dGFjaGVkLgogICAgICAgICAgY29uc3QgdGltZVN0YW1wID0gZS50aW1lU3RhbXAgfHwgX2dldE5vdygpOwogICAgICAgICAgaWYgKHNraXBUaW1lc3RhbXBDaGVjayB8fCB0aW1lU3RhbXAgPj0gaW52b2tlci5hdHRhY2hlZCAtIDEpIHsKICAgICAgICAgICAgICBjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhwYXRjaFN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbihlLCBpbnZva2VyLnZhbHVlKSwgaW5zdGFuY2UsIDUgLyogTkFUSVZFX0VWRU5UX0hBTkRMRVIgKi8sIFtlXSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGludm9rZXIudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgIGludm9rZXIuYXR0YWNoZWQgPSBnZXROb3coKTsKICAgICAgcmV0dXJuIGludm9rZXI7CiAgfQogIGZ1bmN0aW9uIHBhdGNoU3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKGUsIHZhbHVlKSB7CiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgY29uc3Qgb3JpZ2luYWxTdG9wID0gZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb247CiAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiA9ICgpID0+IHsKICAgICAgICAgICAgICBvcmlnaW5hbFN0b3AuY2FsbChlKTsKICAgICAgICAgICAgICBlLl9zdG9wcGVkID0gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKGZuID0+IChlKSA9PiAhZS5fc3RvcHBlZCAmJiBmbiAmJiBmbihlKSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICB9CgogIGNvbnN0IG5hdGl2ZU9uUkUgPSAvXm9uW2Etel0vOwogIGNvbnN0IHBhdGNoUHJvcCA9IChlbCwga2V5LCBwcmV2VmFsdWUsIG5leHRWYWx1ZSwgaXNTVkcgPSBmYWxzZSwgcHJldkNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB1bm1vdW50Q2hpbGRyZW4pID0+IHsKICAgICAgaWYgKGtleSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgcGF0Y2hDbGFzcyhlbCwgbmV4dFZhbHVlLCBpc1NWRyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoa2V5ID09PSAnc3R5bGUnKSB7CiAgICAgICAgICBwYXRjaFN0eWxlKGVsLCBwcmV2VmFsdWUsIG5leHRWYWx1ZSk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNPbihrZXkpKSB7CiAgICAgICAgICAvLyBpZ25vcmUgdi1tb2RlbCBsaXN0ZW5lcnMKICAgICAgICAgIGlmICghaXNNb2RlbExpc3RlbmVyKGtleSkpIHsKICAgICAgICAgICAgICBwYXRjaEV2ZW50KGVsLCBrZXksIHByZXZWYWx1ZSwgbmV4dFZhbHVlLCBwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgaWYgKGtleVswXSA9PT0gJy4nCiAgICAgICAgICA/ICgoa2V5ID0ga2V5LnNsaWNlKDEpKSwgdHJ1ZSkKICAgICAgICAgIDoga2V5WzBdID09PSAnXicKICAgICAgICAgICAgICA/ICgoa2V5ID0ga2V5LnNsaWNlKDEpKSwgZmFsc2UpCiAgICAgICAgICAgICAgOiBzaG91bGRTZXRBc1Byb3AoZWwsIGtleSwgbmV4dFZhbHVlLCBpc1NWRykpIHsKICAgICAgICAgIHBhdGNoRE9NUHJvcChlbCwga2V5LCBuZXh0VmFsdWUsIHByZXZDaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgdW5tb3VudENoaWxkcmVuKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgPGlucHV0IHYtbW9kZWwgdHlwZT0iY2hlY2tib3giPiB3aXRoCiAgICAgICAgICAvLyA6dHJ1ZS12YWx1ZSAmIDpmYWxzZS12YWx1ZQogICAgICAgICAgLy8gc3RvcmUgdmFsdWUgYXMgZG9tIHByb3BlcnRpZXMgc2luY2Ugbm9uLXN0cmluZyB2YWx1ZXMgd2lsbCBiZQogICAgICAgICAgLy8gc3RyaW5naWZpZWQuCiAgICAgICAgICBpZiAoa2V5ID09PSAndHJ1ZS12YWx1ZScpIHsKICAgICAgICAgICAgICBlbC5fdHJ1ZVZhbHVlID0gbmV4dFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoa2V5ID09PSAnZmFsc2UtdmFsdWUnKSB7CiAgICAgICAgICAgICAgZWwuX2ZhbHNlVmFsdWUgPSBuZXh0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBwYXRjaEF0dHIoZWwsIGtleSwgbmV4dFZhbHVlLCBpc1NWRyk7CiAgICAgIH0KICB9OwogIGZ1bmN0aW9uIHNob3VsZFNldEFzUHJvcChlbCwga2V5LCB2YWx1ZSwgaXNTVkcpIHsKICAgICAgaWYgKGlzU1ZHKSB7CiAgICAgICAgICAvLyBtb3N0IGtleXMgbXVzdCBiZSBzZXQgYXMgYXR0cmlidXRlIG9uIHN2ZyBlbGVtZW50cyB0byB3b3JrCiAgICAgICAgICAvLyAuLi5leGNlcHQgaW5uZXJIVE1MICYgdGV4dENvbnRlbnQKICAgICAgICAgIGlmIChrZXkgPT09ICdpbm5lckhUTUwnIHx8IGtleSA9PT0gJ3RleHRDb250ZW50JykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgLy8gb3IgbmF0aXZlIG9uY2xpY2sgd2l0aCBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICAgIGlmIChrZXkgaW4gZWwgJiYgbmF0aXZlT25SRS50ZXN0KGtleSkgJiYgaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyB0aGVzZSBhcmUgZW51bWVyYXRlZCBhdHRycywgaG93ZXZlciB0aGVpciBjb3JyZXNwb25kaW5nIERPTSBwcm9wZXJ0aWVzCiAgICAgIC8vIGFyZSBhY3R1YWxseSBib29sZWFucyAtIHRoaXMgbGVhZHMgdG8gc2V0dGluZyBpdCB3aXRoIGEgc3RyaW5nICJmYWxzZSIKICAgICAgLy8gdmFsdWUgbGVhZGluZyBpdCB0byBiZSBjb2VyY2VkIHRvIGB0cnVlYCwgc28gd2UgbmVlZCB0byBhbHdheXMgdHJlYXQKICAgICAgLy8gdGhlbSBhcyBhdHRyaWJ1dGVzLgogICAgICAvLyBOb3RlIHRoYXQgYGNvbnRlbnRFZGl0YWJsZWAgZG9lc24ndCBoYXZlIHRoaXMgcHJvYmxlbTogaXRzIERPTQogICAgICAvLyBwcm9wZXJ0eSBpcyBhbHNvIGVudW1lcmF0ZWQgc3RyaW5nIHZhbHVlcy4KICAgICAgaWYgKGtleSA9PT0gJ3NwZWxsY2hlY2snIHx8IGtleSA9PT0gJ2RyYWdnYWJsZScgfHwga2V5ID09PSAndHJhbnNsYXRlJykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vICMxNzg3LCAjMjg0MCBmb3JtIHByb3BlcnR5IG9uIGZvcm0gZWxlbWVudHMgaXMgcmVhZG9ubHkgYW5kIG11c3QgYmUgc2V0IGFzCiAgICAgIC8vIGF0dHJpYnV0ZS4KICAgICAgaWYgKGtleSA9PT0gJ2Zvcm0nKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gIzE1MjYgPGlucHV0IGxpc3Q+IG11c3QgYmUgc2V0IGFzIGF0dHJpYnV0ZQogICAgICBpZiAoa2V5ID09PSAnbGlzdCcgJiYgZWwudGFnTmFtZSA9PT0gJ0lOUFVUJykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vICMyNzY2IDx0ZXh0YXJlYSB0eXBlPiBtdXN0IGJlIHNldCBhcyBhdHRyaWJ1dGUKICAgICAgaWYgKGtleSA9PT0gJ3R5cGUnICYmIGVsLnRhZ05hbWUgPT09ICdURVhUQVJFQScpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBuYXRpdmUgb25jbGljayB3aXRoIHN0cmluZyB2YWx1ZSwgbXVzdCBiZSBzZXQgYXMgYXR0cmlidXRlCiAgICAgIGlmIChuYXRpdmVPblJFLnRlc3Qoa2V5KSAmJiBpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4ga2V5IGluIGVsOwogIH0KCiAgZnVuY3Rpb24gZGVmaW5lQ3VzdG9tRWxlbWVudChvcHRpb25zLCBoeWRyYXRlKSB7CiAgICAgIGNvbnN0IENvbXAgPSBkZWZpbmVDb21wb25lbnQob3B0aW9ucyk7CiAgICAgIGNsYXNzIFZ1ZUN1c3RvbUVsZW1lbnQgZXh0ZW5kcyBWdWVFbGVtZW50IHsKICAgICAgICAgIGNvbnN0cnVjdG9yKGluaXRpYWxQcm9wcykgewogICAgICAgICAgICAgIHN1cGVyKENvbXAsIGluaXRpYWxQcm9wcywgaHlkcmF0ZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgVnVlQ3VzdG9tRWxlbWVudC5kZWYgPSBDb21wOwogICAgICByZXR1cm4gVnVlQ3VzdG9tRWxlbWVudDsKICB9CiAgY29uc3QgZGVmaW5lU1NSQ3VzdG9tRWxlbWVudCA9ICgob3B0aW9ucykgPT4gewogICAgICAvLyBAdHMtaWdub3JlCiAgICAgIHJldHVybiBkZWZpbmVDdXN0b21FbGVtZW50KG9wdGlvbnMsIGh5ZHJhdGUpOwogIH0pOwogIGNvbnN0IEJhc2VDbGFzcyA9ICh0eXBlb2YgSFRNTEVsZW1lbnQgIT09ICd1bmRlZmluZWQnID8gSFRNTEVsZW1lbnQgOiBjbGFzcyB7CiAgfSk7CiAgY2xhc3MgVnVlRWxlbWVudCBleHRlbmRzIEJhc2VDbGFzcyB7CiAgICAgIGNvbnN0cnVjdG9yKF9kZWYsIF9wcm9wcyA9IHt9LCBoeWRyYXRlKSB7CiAgICAgICAgICBzdXBlcigpOwogICAgICAgICAgdGhpcy5fZGVmID0gX2RlZjsKICAgICAgICAgIHRoaXMuX3Byb3BzID0gX3Byb3BzOwogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7CiAgICAgICAgICB0aGlzLl9yZXNvbHZlZCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5fbnVtYmVyUHJvcHMgPSBudWxsOwogICAgICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCAmJiBoeWRyYXRlKSB7CiAgICAgICAgICAgICAgaHlkcmF0ZSh0aGlzLl9jcmVhdGVWTm9kZSgpLCB0aGlzLnNoYWRvd1Jvb3QpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCkgewogICAgICAgICAgICAgICAgICB3YXJuJDEoYEN1c3RvbSBlbGVtZW50IGhhcyBwcmUtcmVuZGVyZWQgZGVjbGFyYXRpdmUgc2hhZG93IHJvb3QgYnV0IGlzIG5vdCBgICsKICAgICAgICAgICAgICAgICAgICAgIGBkZWZpbmVkIGFzIGh5ZHJhdGFibGUuIFVzZSBcYGRlZmluZVNTUkN1c3RvbUVsZW1lbnRcYC5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5hdHRhY2hTaGFkb3coeyBtb2RlOiAnb3BlbicgfSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgICB0aGlzLl9jb25uZWN0ZWQgPSB0cnVlOwogICAgICAgICAgaWYgKCF0aGlzLl9pbnN0YW5jZSkgewogICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVEZWYoKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICAgIHRoaXMuX2Nvbm5lY3RlZCA9IGZhbHNlOwogICAgICAgICAgbmV4dFRpY2soKCkgPT4gewogICAgICAgICAgICAgIGlmICghdGhpcy5fY29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcihudWxsLCB0aGlzLnNoYWRvd1Jvb3QpOwogICAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIHJlc29sdmUgaW5uZXIgY29tcG9uZW50IGRlZmluaXRpb24gKGhhbmRsZSBwb3NzaWJsZSBhc3luYyBjb21wb25lbnQpCiAgICAgICAqLwogICAgICBfcmVzb2x2ZURlZigpIHsKICAgICAgICAgIGlmICh0aGlzLl9yZXNvbHZlZCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3Jlc29sdmVkID0gdHJ1ZTsKICAgICAgICAgIC8vIHNldCBpbml0aWFsIGF0dHJzCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHRoaXMuX3NldEF0dHIodGhpcy5hdHRyaWJ1dGVzW2ldLm5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gd2F0Y2ggZnV0dXJlIGF0dHIgY2hhbmdlcwogICAgICAgICAgbmV3IE11dGF0aW9uT2JzZXJ2ZXIobXV0YXRpb25zID0+IHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IG0gb2YgbXV0YXRpb25zKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX3NldEF0dHIobS5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9KS5vYnNlcnZlKHRoaXMsIHsgYXR0cmlidXRlczogdHJ1ZSB9KTsKICAgICAgICAgIGNvbnN0IHJlc29sdmUgPSAoZGVmKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgeyBwcm9wcywgc3R5bGVzIH0gPSBkZWY7CiAgICAgICAgICAgICAgY29uc3QgaGFzT3B0aW9ucyA9ICFpc0FycmF5KHByb3BzKTsKICAgICAgICAgICAgICBjb25zdCByYXdLZXlzID0gcHJvcHMgPyAoaGFzT3B0aW9ucyA/IE9iamVjdC5rZXlzKHByb3BzKSA6IHByb3BzKSA6IFtdOwogICAgICAgICAgICAgIC8vIGNhc3QgTnVtYmVyLXR5cGUgcHJvcHMgc2V0IGJlZm9yZSByZXNvbHZlCiAgICAgICAgICAgICAgbGV0IG51bWJlclByb3BzOwogICAgICAgICAgICAgIGlmIChoYXNPcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcHQgPSBwcm9wc1trZXldOwogICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA9PT0gTnVtYmVyIHx8IChvcHQgJiYgb3B0LnR5cGUgPT09IE51bWJlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9wc1trZXldID0gdG9OdW1iZXIodGhpcy5fcHJvcHNba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgKG51bWJlclByb3BzIHx8IChudW1iZXJQcm9wcyA9IE9iamVjdC5jcmVhdGUobnVsbCkpKVtrZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9udW1iZXJQcm9wcyA9IG51bWJlclByb3BzOwogICAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBwcm9wcyBzZXQgcHJlLXVwZ3JhZGUgb3IgY29ubmVjdAogICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChrZXlbMF0gIT09ICdfJykgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0UHJvcChrZXksIHRoaXNba2V5XSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGRlZmluaW5nIGdldHRlci9zZXR0ZXJzIG9uIHByb3RvdHlwZQogICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHJhd0tleXMubWFwKGNhbWVsaXplKSkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywga2V5LCB7CiAgICAgICAgICAgICAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByb3Aoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBzZXQodmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0UHJvcChrZXksIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBhcHBseSBDU1MKICAgICAgICAgICAgICB0aGlzLl9hcHBseVN0eWxlcyhzdHlsZXMpOwogICAgICAgICAgICAgIC8vIGluaXRpYWwgcmVuZGVyCiAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlKCk7CiAgICAgICAgICB9OwogICAgICAgICAgY29uc3QgYXN5bmNEZWYgPSB0aGlzLl9kZWYuX19hc3luY0xvYWRlcjsKICAgICAgICAgIGlmIChhc3luY0RlZikgewogICAgICAgICAgICAgIGFzeW5jRGVmKCkudGhlbihyZXNvbHZlKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUodGhpcy5fZGVmKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBfc2V0QXR0cihrZXkpIHsKICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKGtleSk7CiAgICAgICAgICBpZiAodGhpcy5fbnVtYmVyUHJvcHMgJiYgdGhpcy5fbnVtYmVyUHJvcHNba2V5XSkgewogICAgICAgICAgICAgIHZhbHVlID0gdG9OdW1iZXIodmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fc2V0UHJvcChjYW1lbGl6ZShrZXkpLCB2YWx1ZSwgZmFsc2UpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBAaW50ZXJuYWwKICAgICAgICovCiAgICAgIF9nZXRQcm9wKGtleSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb3BzW2tleV07CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEBpbnRlcm5hbAogICAgICAgKi8KICAgICAgX3NldFByb3Aoa2V5LCB2YWwsIHNob3VsZFJlZmxlY3QgPSB0cnVlLCBzaG91bGRVcGRhdGUgPSB0cnVlKSB7CiAgICAgICAgICBpZiAodmFsICE9PSB0aGlzLl9wcm9wc1trZXldKSB7CiAgICAgICAgICAgICAgdGhpcy5fcHJvcHNba2V5XSA9IHZhbDsKICAgICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIHRoaXMuX2luc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyByZWZsZWN0CiAgICAgICAgICAgICAgaWYgKHNob3VsZFJlZmxlY3QpIHsKICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoaHlwaGVuYXRlKGtleSksICcnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoaHlwaGVuYXRlKGtleSksIHZhbCArICcnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmICghdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShoeXBoZW5hdGUoa2V5KSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgX3VwZGF0ZSgpIHsKICAgICAgICAgIHJlbmRlcih0aGlzLl9jcmVhdGVWTm9kZSgpLCB0aGlzLnNoYWRvd1Jvb3QpOwogICAgICB9CiAgICAgIF9jcmVhdGVWTm9kZSgpIHsKICAgICAgICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUodGhpcy5fZGVmLCBleHRlbmQoe30sIHRoaXMuX3Byb3BzKSk7CiAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7CiAgICAgICAgICAgICAgdm5vZGUuY2UgPSBpbnN0YW5jZSA9PiB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmlzQ0UgPSB0cnVlOwogICAgICAgICAgICAgICAgICAvLyBITVIKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY2VSZWxvYWQgPSBuZXdTdHlsZXMgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsd2F5cyByZXNldCBzdHlsZXMKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fc3R5bGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlcy5mb3JFYWNoKHMgPT4gdGhpcy5zaGFkb3dSb290LnJlbW92ZUNoaWxkKHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGx5U3R5bGVzKG5ld1N0eWxlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBhc3luYyBjb21wb25lbnQsIGNlUmVsb2FkIGlzIGNhbGxlZCBmcm9tIHRoZSBpbm5lcgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBvbmVudCBzbyBubyBuZWVkIHRvIHJlbG9hZCB0aGUgYXN5bmMgd3JhcHBlcgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fZGVmLl9fYXN5bmNMb2FkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVsb2FkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBpbnRlcmNlcHQgZW1pdAogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5lbWl0ID0gKGV2ZW50LCAuLi5hcmdzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KGV2ZW50LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsOiBhcmdzCiAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSBuZWFyZXN0IFZ1ZSBjdXN0b20gZWxlbWVudCBwYXJlbnQgZm9yIHByb3ZpZGUvaW5qZWN0CiAgICAgICAgICAgICAgICAgIGxldCBwYXJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgICB3aGlsZSAoKHBhcmVudCA9CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgJiYgKHBhcmVudC5wYXJlbnROb2RlIHx8IHBhcmVudC5ob3N0KSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBWdWVFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucGFyZW50ID0gcGFyZW50Ll9pbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdm5vZGU7CiAgICAgIH0KICAgICAgX2FwcGx5U3R5bGVzKHN0eWxlcykgewogICAgICAgICAgaWYgKHN0eWxlcykgewogICAgICAgICAgICAgIHN0eWxlcy5mb3JFYWNoKGNzcyA9PiB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgICAgICAgICAgICBzLnRleHRDb250ZW50ID0gY3NzOwogICAgICAgICAgICAgICAgICB0aGlzLnNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQocyk7CiAgICAgICAgICAgICAgICAgIC8vIHJlY29yZCBmb3IgSE1SCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICh0aGlzLl9zdHlsZXMgfHwgKHRoaXMuX3N0eWxlcyA9IFtdKSkucHVzaChzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICB9CiAgfQoKICBmdW5jdGlvbiB1c2VDc3NNb2R1bGUobmFtZSA9ICckc3R5bGUnKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICB3YXJuJDEoYHVzZUNzc01vZHVsZSgpIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGdsb2JhbCBidWlsZC5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBFTVBUWV9PQko7CiAgICAgIH0KICB9CgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciBTRkMncyBDU1MgdmFyaWFibGUgaW5qZWN0aW9uIGZlYXR1cmUuCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiB1c2VDc3NWYXJzKGdldHRlcikgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuJDEoYHVzZUNzc1ZhcnMgaXMgY2FsbGVkIHdpdGhvdXQgY3VycmVudCBhY3RpdmUgY29tcG9uZW50IGluc3RhbmNlLmApOwogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHNldFZhcnMgPSAoKSA9PiBzZXRWYXJzT25WTm9kZShpbnN0YW5jZS5zdWJUcmVlLCBnZXR0ZXIoaW5zdGFuY2UucHJveHkpKTsKICAgICAgd2F0Y2hQb3N0RWZmZWN0KHNldFZhcnMpOwogICAgICBvbk1vdW50ZWQoKCkgPT4gewogICAgICAgICAgY29uc3Qgb2IgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihzZXRWYXJzKTsKICAgICAgICAgIG9iLm9ic2VydmUoaW5zdGFuY2Uuc3ViVHJlZS5lbC5wYXJlbnROb2RlLCB7IGNoaWxkTGlzdDogdHJ1ZSB9KTsKICAgICAgICAgIG9uVW5tb3VudGVkKCgpID0+IG9iLmRpc2Nvbm5lY3QoKSk7CiAgICAgIH0pOwogIH0KICBmdW5jdGlvbiBzZXRWYXJzT25WTm9kZSh2bm9kZSwgdmFycykgewogICAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMTI4IC8qIFNVU1BFTlNFICovKSB7CiAgICAgICAgICBjb25zdCBzdXNwZW5zZSA9IHZub2RlLnN1c3BlbnNlOwogICAgICAgICAgdm5vZGUgPSBzdXNwZW5zZS5hY3RpdmVCcmFuY2g7CiAgICAgICAgICBpZiAoc3VzcGVuc2UucGVuZGluZ0JyYW5jaCAmJiAhc3VzcGVuc2UuaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICBzdXNwZW5zZS5lZmZlY3RzLnB1c2goKCkgPT4gewogICAgICAgICAgICAgICAgICBzZXRWYXJzT25WTm9kZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIHZhcnMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGRyaWxsIGRvd24gSE9DcyB1bnRpbCBpdCdzIGEgbm9uLWNvbXBvbmVudCB2bm9kZQogICAgICB3aGlsZSAodm5vZGUuY29tcG9uZW50KSB7CiAgICAgICAgICB2bm9kZSA9IHZub2RlLmNvbXBvbmVudC5zdWJUcmVlOwogICAgICB9CiAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxIC8qIEVMRU1FTlQgKi8gJiYgdm5vZGUuZWwpIHsKICAgICAgICAgIHNldFZhcnNPbk5vZGUodm5vZGUuZWwsIHZhcnMpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHZub2RlLnR5cGUgPT09IEZyYWdtZW50KSB7CiAgICAgICAgICB2bm9kZS5jaGlsZHJlbi5mb3JFYWNoKGMgPT4gc2V0VmFyc09uVk5vZGUoYywgdmFycykpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHZub2RlLnR5cGUgPT09IFN0YXRpYykgewogICAgICAgICAgbGV0IHsgZWwsIGFuY2hvciB9ID0gdm5vZGU7CiAgICAgICAgICB3aGlsZSAoZWwpIHsKICAgICAgICAgICAgICBzZXRWYXJzT25Ob2RlKGVsLCB2YXJzKTsKICAgICAgICAgICAgICBpZiAoZWwgPT09IGFuY2hvcikKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZWwgPSBlbC5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgfQogIH0KICBmdW5jdGlvbiBzZXRWYXJzT25Ob2RlKGVsLCB2YXJzKSB7CiAgICAgIGlmIChlbC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgY29uc3Qgc3R5bGUgPSBlbC5zdHlsZTsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHZhcnMpIHsKICAgICAgICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eShgLS0ke2tleX1gLCB2YXJzW2tleV0pOwogICAgICAgICAgfQogICAgICB9CiAgfQoKICBjb25zdCBUUkFOU0lUSU9OID0gJ3RyYW5zaXRpb24nOwogIGNvbnN0IEFOSU1BVElPTiA9ICdhbmltYXRpb24nOwogIC8vIERPTSBUcmFuc2l0aW9uIGlzIGEgaGlnaGVyLW9yZGVyLWNvbXBvbmVudCBiYXNlZCBvbiB0aGUgcGxhdGZvcm0tYWdub3N0aWMKICAvLyBiYXNlIFRyYW5zaXRpb24gY29tcG9uZW50LCB3aXRoIERPTS1zcGVjaWZpYyBsb2dpYy4KICBjb25zdCBUcmFuc2l0aW9uID0gKHByb3BzLCB7IHNsb3RzIH0pID0+IGgoQmFzZVRyYW5zaXRpb24sIHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocHJvcHMpLCBzbG90cyk7CiAgVHJhbnNpdGlvbi5kaXNwbGF5TmFtZSA9ICdUcmFuc2l0aW9uJzsKICBjb25zdCBET01UcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gewogICAgICBuYW1lOiBTdHJpbmcsCiAgICAgIHR5cGU6IFN0cmluZywKICAgICAgY3NzOiB7CiAgICAgICAgICB0eXBlOiBCb29sZWFuLAogICAgICAgICAgZGVmYXVsdDogdHJ1ZQogICAgICB9LAogICAgICBkdXJhdGlvbjogW1N0cmluZywgTnVtYmVyLCBPYmplY3RdLAogICAgICBlbnRlckZyb21DbGFzczogU3RyaW5nLAogICAgICBlbnRlckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgICAgIGVudGVyVG9DbGFzczogU3RyaW5nLAogICAgICBhcHBlYXJGcm9tQ2xhc3M6IFN0cmluZywKICAgICAgYXBwZWFyQWN0aXZlQ2xhc3M6IFN0cmluZywKICAgICAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogICAgICBsZWF2ZUZyb21DbGFzczogU3RyaW5nLAogICAgICBsZWF2ZUFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgICAgIGxlYXZlVG9DbGFzczogU3RyaW5nCiAgfTsKICBjb25zdCBUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gKFRyYW5zaXRpb24ucHJvcHMgPQogICAgICAvKiNfX1BVUkVfXyovIGV4dGVuZCh7fSwgQmFzZVRyYW5zaXRpb24ucHJvcHMsIERPTVRyYW5zaXRpb25Qcm9wc1ZhbGlkYXRvcnMpKTsKICAvKioKICAgKiAjMzIyNyBJbmNvbWluZyBob29rcyBtYXkgYmUgbWVyZ2VkIGludG8gYXJyYXlzIHdoZW4gd3JhcHBpbmcgVHJhbnNpdGlvbgogICAqIHdpdGggY3VzdG9tIEhPQ3MuCiAgICovCiAgY29uc3QgY2FsbEhvb2skMSA9IChob29rLCBhcmdzID0gW10pID0+IHsKICAgICAgaWYgKGlzQXJyYXkoaG9vaykpIHsKICAgICAgICAgIGhvb2suZm9yRWFjaChoID0+IGgoLi4uYXJncykpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGhvb2spIHsKICAgICAgICAgIGhvb2soLi4uYXJncyk7CiAgICAgIH0KICB9OwogIC8qKgogICAqIENoZWNrIGlmIGEgaG9vayBleHBlY3RzIGEgY2FsbGJhY2sgKDJuZCBhcmcpLCB3aGljaCBtZWFucyB0aGUgdXNlcgogICAqIGludGVuZHMgdG8gZXhwbGljaXRseSBjb250cm9sIHRoZSBlbmQgb2YgdGhlIHRyYW5zaXRpb24uCiAgICovCiAgY29uc3QgaGFzRXhwbGljaXRDYWxsYmFjayA9IChob29rKSA9PiB7CiAgICAgIHJldHVybiBob29rCiAgICAgICAgICA/IGlzQXJyYXkoaG9vaykKICAgICAgICAgICAgICA/IGhvb2suc29tZShoID0+IGgubGVuZ3RoID4gMSkKICAgICAgICAgICAgICA6IGhvb2subGVuZ3RoID4gMQogICAgICAgICAgOiBmYWxzZTsKICB9OwogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpIHsKICAgICAgY29uc3QgYmFzZVByb3BzID0ge307CiAgICAgIGZvciAoY29uc3Qga2V5IGluIHJhd1Byb3BzKSB7CiAgICAgICAgICBpZiAoIShrZXkgaW4gRE9NVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycykpIHsKICAgICAgICAgICAgICBiYXNlUHJvcHNba2V5XSA9IHJhd1Byb3BzW2tleV07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHJhd1Byb3BzLmNzcyA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBiYXNlUHJvcHM7CiAgICAgIH0KICAgICAgY29uc3QgeyBuYW1lID0gJ3YnLCB0eXBlLCBkdXJhdGlvbiwgZW50ZXJGcm9tQ2xhc3MgPSBgJHtuYW1lfS1lbnRlci1mcm9tYCwgZW50ZXJBY3RpdmVDbGFzcyA9IGAke25hbWV9LWVudGVyLWFjdGl2ZWAsIGVudGVyVG9DbGFzcyA9IGAke25hbWV9LWVudGVyLXRvYCwgYXBwZWFyRnJvbUNsYXNzID0gZW50ZXJGcm9tQ2xhc3MsIGFwcGVhckFjdGl2ZUNsYXNzID0gZW50ZXJBY3RpdmVDbGFzcywgYXBwZWFyVG9DbGFzcyA9IGVudGVyVG9DbGFzcywgbGVhdmVGcm9tQ2xhc3MgPSBgJHtuYW1lfS1sZWF2ZS1mcm9tYCwgbGVhdmVBY3RpdmVDbGFzcyA9IGAke25hbWV9LWxlYXZlLWFjdGl2ZWAsIGxlYXZlVG9DbGFzcyA9IGAke25hbWV9LWxlYXZlLXRvYCB9ID0gcmF3UHJvcHM7CiAgICAgIGNvbnN0IGR1cmF0aW9ucyA9IG5vcm1hbGl6ZUR1cmF0aW9uKGR1cmF0aW9uKTsKICAgICAgY29uc3QgZW50ZXJEdXJhdGlvbiA9IGR1cmF0aW9ucyAmJiBkdXJhdGlvbnNbMF07CiAgICAgIGNvbnN0IGxlYXZlRHVyYXRpb24gPSBkdXJhdGlvbnMgJiYgZHVyYXRpb25zWzFdOwogICAgICBjb25zdCB7IG9uQmVmb3JlRW50ZXIsIG9uRW50ZXIsIG9uRW50ZXJDYW5jZWxsZWQsIG9uTGVhdmUsIG9uTGVhdmVDYW5jZWxsZWQsIG9uQmVmb3JlQXBwZWFyID0gb25CZWZvcmVFbnRlciwgb25BcHBlYXIgPSBvbkVudGVyLCBvbkFwcGVhckNhbmNlbGxlZCA9IG9uRW50ZXJDYW5jZWxsZWQgfSA9IGJhc2VQcm9wczsKICAgICAgY29uc3QgZmluaXNoRW50ZXIgPSAoZWwsIGlzQXBwZWFyLCBkb25lKSA9PiB7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGlzQXBwZWFyID8gYXBwZWFyVG9DbGFzcyA6IGVudGVyVG9DbGFzcyk7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGlzQXBwZWFyID8gYXBwZWFyQWN0aXZlQ2xhc3MgOiBlbnRlckFjdGl2ZUNsYXNzKTsKICAgICAgICAgIGRvbmUgJiYgZG9uZSgpOwogICAgICB9OwogICAgICBjb25zdCBmaW5pc2hMZWF2ZSA9IChlbCwgZG9uZSkgPT4gewogICAgICAgICAgZWwuX2lzTGVhdmluZyA9IGZhbHNlOwogICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgICAgICAgZG9uZSAmJiBkb25lKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IG1ha2VFbnRlckhvb2sgPSAoaXNBcHBlYXIpID0+IHsKICAgICAgICAgIHJldHVybiAoZWwsIGRvbmUpID0+IHsKICAgICAgICAgICAgICBjb25zdCBob29rID0gaXNBcHBlYXIgPyBvbkFwcGVhciA6IG9uRW50ZXI7CiAgICAgICAgICAgICAgY29uc3QgcmVzb2x2ZSA9ICgpID0+IGZpbmlzaEVudGVyKGVsLCBpc0FwcGVhciwgZG9uZSk7CiAgICAgICAgICAgICAgY2FsbEhvb2skMShob29rLCBbZWwsIHJlc29sdmVdKTsKICAgICAgICAgICAgICBuZXh0RnJhbWUoKCkgPT4gewogICAgICAgICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGlzQXBwZWFyID8gYXBwZWFyRnJvbUNsYXNzIDogZW50ZXJGcm9tQ2xhc3MpOwogICAgICAgICAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGlzQXBwZWFyID8gYXBwZWFyVG9DbGFzcyA6IGVudGVyVG9DbGFzcyk7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzRXhwbGljaXRDYWxsYmFjayhob29rKSkgewogICAgICAgICAgICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBlbnRlckR1cmF0aW9uLCByZXNvbHZlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgfTsKICAgICAgcmV0dXJuIGV4dGVuZChiYXNlUHJvcHMsIHsKICAgICAgICAgIG9uQmVmb3JlRW50ZXIoZWwpIHsKICAgICAgICAgICAgICBjYWxsSG9vayQxKG9uQmVmb3JlRW50ZXIsIFtlbF0pOwogICAgICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgZW50ZXJGcm9tQ2xhc3MpOwogICAgICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgZW50ZXJBY3RpdmVDbGFzcyk7CiAgICAgICAgICB9LAogICAgICAgICAgb25CZWZvcmVBcHBlYXIoZWwpIHsKICAgICAgICAgICAgICBjYWxsSG9vayQxKG9uQmVmb3JlQXBwZWFyLCBbZWxdKTsKICAgICAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGFwcGVhckZyb21DbGFzcyk7CiAgICAgICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhcHBlYXJBY3RpdmVDbGFzcyk7CiAgICAgICAgICB9LAogICAgICAgICAgb25FbnRlcjogbWFrZUVudGVySG9vayhmYWxzZSksCiAgICAgICAgICBvbkFwcGVhcjogbWFrZUVudGVySG9vayh0cnVlKSwKICAgICAgICAgIG9uTGVhdmUoZWwsIGRvbmUpIHsKICAgICAgICAgICAgICBlbC5faXNMZWF2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICBjb25zdCByZXNvbHZlID0gKCkgPT4gZmluaXNoTGVhdmUoZWwsIGRvbmUpOwogICAgICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVGcm9tQ2xhc3MpOwogICAgICAgICAgICAgIC8vIGZvcmNlIHJlZmxvdyBzbyAqLWxlYXZlLWZyb20gY2xhc3NlcyBpbW1lZGlhdGVseSB0YWtlIGVmZmVjdCAoIzI1OTMpCiAgICAgICAgICAgICAgZm9yY2VSZWZsb3coKTsKICAgICAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgICAgICAgICAgIG5leHRGcmFtZSgoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICghZWwuX2lzTGVhdmluZykgewogICAgICAgICAgICAgICAgICAgICAgLy8gY2FuY2VsbGVkCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7CiAgICAgICAgICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVUb0NsYXNzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNFeHBsaWNpdENhbGxiYWNrKG9uTGVhdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGxlYXZlRHVyYXRpb24sIHJlc29sdmUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2FsbEhvb2skMShvbkxlYXZlLCBbZWwsIHJlc29sdmVdKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvbkVudGVyQ2FuY2VsbGVkKGVsKSB7CiAgICAgICAgICAgICAgZmluaXNoRW50ZXIoZWwsIGZhbHNlKTsKICAgICAgICAgICAgICBjYWxsSG9vayQxKG9uRW50ZXJDYW5jZWxsZWQsIFtlbF0pOwogICAgICAgICAgfSwKICAgICAgICAgIG9uQXBwZWFyQ2FuY2VsbGVkKGVsKSB7CiAgICAgICAgICAgICAgZmluaXNoRW50ZXIoZWwsIHRydWUpOwogICAgICAgICAgICAgIGNhbGxIb29rJDEob25BcHBlYXJDYW5jZWxsZWQsIFtlbF0pOwogICAgICAgICAgfSwKICAgICAgICAgIG9uTGVhdmVDYW5jZWxsZWQoZWwpIHsKICAgICAgICAgICAgICBmaW5pc2hMZWF2ZShlbCk7CiAgICAgICAgICAgICAgY2FsbEhvb2skMShvbkxlYXZlQ2FuY2VsbGVkLCBbZWxdKTsKICAgICAgICAgIH0KICAgICAgfSk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUR1cmF0aW9uKGR1cmF0aW9uKSB7CiAgICAgIGlmIChkdXJhdGlvbiA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBlbHNlIGlmIChpc09iamVjdChkdXJhdGlvbikpIHsKICAgICAgICAgIHJldHVybiBbTnVtYmVyT2YoZHVyYXRpb24uZW50ZXIpLCBOdW1iZXJPZihkdXJhdGlvbi5sZWF2ZSldOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY29uc3QgbiA9IE51bWJlck9mKGR1cmF0aW9uKTsKICAgICAgICAgIHJldHVybiBbbiwgbl07CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gTnVtYmVyT2YodmFsKSB7CiAgICAgIGNvbnN0IHJlcyA9IHRvTnVtYmVyKHZhbCk7CiAgICAgIHZhbGlkYXRlRHVyYXRpb24ocmVzKTsKICAgICAgcmV0dXJuIHJlczsKICB9CiAgZnVuY3Rpb24gdmFsaWRhdGVEdXJhdGlvbih2YWwpIHsKICAgICAgaWYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInKSB7CiAgICAgICAgICB3YXJuJDEoYDx0cmFuc2l0aW9uPiBleHBsaWNpdCBkdXJhdGlvbiBpcyBub3QgYSB2YWxpZCBudW1iZXIgLSBgICsKICAgICAgICAgICAgICBgZ290ICR7SlNPTi5zdHJpbmdpZnkodmFsKX0uYCk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNOYU4odmFsKSkgewogICAgICAgICAgd2FybiQxKGA8dHJhbnNpdGlvbj4gZXhwbGljaXQgZHVyYXRpb24gaXMgTmFOIC0gYCArCiAgICAgICAgICAgICAgJ3RoZSBkdXJhdGlvbiBleHByZXNzaW9uIG1pZ2h0IGJlIGluY29ycmVjdC4nKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGNscykgewogICAgICBjbHMuc3BsaXQoL1xzKy8pLmZvckVhY2goYyA9PiBjICYmIGVsLmNsYXNzTGlzdC5hZGQoYykpOwogICAgICAoZWwuX3Z0YyB8fAogICAgICAgICAgKGVsLl92dGMgPSBuZXcgU2V0KCkpKS5hZGQoY2xzKTsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsKICAgICAgY2xzLnNwbGl0KC9ccysvKS5mb3JFYWNoKGMgPT4gYyAmJiBlbC5jbGFzc0xpc3QucmVtb3ZlKGMpKTsKICAgICAgY29uc3QgeyBfdnRjIH0gPSBlbDsKICAgICAgaWYgKF92dGMpIHsKICAgICAgICAgIF92dGMuZGVsZXRlKGNscyk7CiAgICAgICAgICBpZiAoIV92dGMuc2l6ZSkgewogICAgICAgICAgICAgIGVsLl92dGMgPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gbmV4dEZyYW1lKGNiKSB7CiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2IpOwogICAgICB9KTsKICB9CiAgbGV0IGVuZElkID0gMDsKICBmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgZXhwbGljaXRUaW1lb3V0LCByZXNvbHZlKSB7CiAgICAgIGNvbnN0IGlkID0gKGVsLl9lbmRJZCA9ICsrZW5kSWQpOwogICAgICBjb25zdCByZXNvbHZlSWZOb3RTdGFsZSA9ICgpID0+IHsKICAgICAgICAgIGlmIChpZCA9PT0gZWwuX2VuZElkKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBpZiAoZXhwbGljaXRUaW1lb3V0KSB7CiAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChyZXNvbHZlSWZOb3RTdGFsZSwgZXhwbGljaXRUaW1lb3V0KTsKICAgICAgfQogICAgICBjb25zdCB7IHR5cGUsIHRpbWVvdXQsIHByb3BDb3VudCB9ID0gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSk7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTsKICAgICAgfQogICAgICBjb25zdCBlbmRFdmVudCA9IHR5cGUgKyAnZW5kJzsKICAgICAgbGV0IGVuZGVkID0gMDsKICAgICAgY29uc3QgZW5kID0gKCkgPT4gewogICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihlbmRFdmVudCwgb25FbmQpOwogICAgICAgICAgcmVzb2x2ZUlmTm90U3RhbGUoKTsKICAgICAgfTsKICAgICAgY29uc3Qgb25FbmQgPSAoZSkgPT4gewogICAgICAgICAgaWYgKGUudGFyZ2V0ID09PSBlbCAmJiArK2VuZGVkID49IHByb3BDb3VudCkgewogICAgICAgICAgICAgIGVuZCgpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGlmIChlbmRlZCA8IHByb3BDb3VudCkgewogICAgICAgICAgICAgIGVuZCgpOwogICAgICAgICAgfQogICAgICB9LCB0aW1lb3V0ICsgMSk7CiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZW5kRXZlbnQsIG9uRW5kKTsKICB9CiAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSkgewogICAgICBjb25zdCBzdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCk7CiAgICAgIC8vIEpTRE9NIG1heSByZXR1cm4gdW5kZWZpbmVkIGZvciB0cmFuc2l0aW9uIHByb3BlcnRpZXMKICAgICAgY29uc3QgZ2V0U3R5bGVQcm9wZXJ0aWVzID0gKGtleSkgPT4gKHN0eWxlc1trZXldIHx8ICcnKS5zcGxpdCgnLCAnKTsKICAgICAgY29uc3QgdHJhbnNpdGlvbkRlbGF5cyA9IGdldFN0eWxlUHJvcGVydGllcyhUUkFOU0lUSU9OICsgJ0RlbGF5Jyk7CiAgICAgIGNvbnN0IHRyYW5zaXRpb25EdXJhdGlvbnMgPSBnZXRTdHlsZVByb3BlcnRpZXMoVFJBTlNJVElPTiArICdEdXJhdGlvbicpOwogICAgICBjb25zdCB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgICAgIGNvbnN0IGFuaW1hdGlvbkRlbGF5cyA9IGdldFN0eWxlUHJvcGVydGllcyhBTklNQVRJT04gKyAnRGVsYXknKTsKICAgICAgY29uc3QgYW5pbWF0aW9uRHVyYXRpb25zID0gZ2V0U3R5bGVQcm9wZXJ0aWVzKEFOSU1BVElPTiArICdEdXJhdGlvbicpOwogICAgICBjb25zdCBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CiAgICAgIGxldCB0eXBlID0gbnVsbDsKICAgICAgbGV0IHRpbWVvdXQgPSAwOwogICAgICBsZXQgcHJvcENvdW50ID0gMDsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmIChleHBlY3RlZFR5cGUgPT09IFRSQU5TSVRJT04pIHsKICAgICAgICAgIGlmICh0cmFuc2l0aW9uVGltZW91dCA+IDApIHsKICAgICAgICAgICAgICB0eXBlID0gVFJBTlNJVElPTjsKICAgICAgICAgICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgICAgICAgICAgcHJvcENvdW50ID0gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgICAgICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICAgICAgICAgIHR5cGUgPSBBTklNQVRJT047CiAgICAgICAgICAgICAgdGltZW91dCA9IGFuaW1hdGlvblRpbWVvdXQ7CiAgICAgICAgICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHRpbWVvdXQgPSBNYXRoLm1heCh0cmFuc2l0aW9uVGltZW91dCwgYW5pbWF0aW9uVGltZW91dCk7CiAgICAgICAgICB0eXBlID0KICAgICAgICAgICAgICB0aW1lb3V0ID4gMAogICAgICAgICAgICAgICAgICA/IHRyYW5zaXRpb25UaW1lb3V0ID4gYW5pbWF0aW9uVGltZW91dAogICAgICAgICAgICAgICAgICAgICAgPyBUUkFOU0lUSU9OCiAgICAgICAgICAgICAgICAgICAgICA6IEFOSU1BVElPTgogICAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgICBwcm9wQ291bnQgPSB0eXBlCiAgICAgICAgICAgICAgPyB0eXBlID09PSBUUkFOU0lUSU9OCiAgICAgICAgICAgICAgICAgID8gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGgKICAgICAgICAgICAgICAgICAgOiBhbmltYXRpb25EdXJhdGlvbnMubGVuZ3RoCiAgICAgICAgICAgICAgOiAwOwogICAgICB9CiAgICAgIGNvbnN0IGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04gJiYKICAgICAgICAgIC9cYih0cmFuc2Zvcm18YWxsKSgsfCQpLy50ZXN0KHN0eWxlc1tUUkFOU0lUSU9OICsgJ1Byb3BlcnR5J10pOwogICAgICByZXR1cm4gewogICAgICAgICAgdHlwZSwKICAgICAgICAgIHRpbWVvdXQsCiAgICAgICAgICBwcm9wQ291bnQsCiAgICAgICAgICBoYXNUcmFuc2Zvcm0KICAgICAgfTsKICB9CiAgZnVuY3Rpb24gZ2V0VGltZW91dChkZWxheXMsIGR1cmF0aW9ucykgewogICAgICB3aGlsZSAoZGVsYXlzLmxlbmd0aCA8IGR1cmF0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgIGRlbGF5cyA9IGRlbGF5cy5jb25jYXQoZGVsYXlzKTsKICAgICAgfQogICAgICByZXR1cm4gTWF0aC5tYXgoLi4uZHVyYXRpb25zLm1hcCgoZCwgaSkgPT4gdG9NcyhkKSArIHRvTXMoZGVsYXlzW2ldKSkpOwogIH0KICAvLyBPbGQgdmVyc2lvbnMgb2YgQ2hyb21pdW0gKGJlbG93IDYxLjAuMzE2My4xMDApIGZvcm1hdHMgZmxvYXRpbmcgcG9pbnRlcgogIC8vIG51bWJlcnMgaW4gYSBsb2NhbGUtZGVwZW5kZW50IHdheSwgdXNpbmcgYSBjb21tYSBpbnN0ZWFkIG9mIGEgZG90LgogIC8vIElmIGNvbW1hIGlzIG5vdCByZXBsYWNlZCB3aXRoIGEgZG90LCB0aGUgaW5wdXQgd2lsbCBiZSByb3VuZGVkIGRvd24KICAvLyAoaS5lLiBhY3RpbmcgYXMgYSBmbG9vciBmdW5jdGlvbikgY2F1c2luZyB1bmV4cGVjdGVkIGJlaGF2aW9ycwogIGZ1bmN0aW9uIHRvTXMocykgewogICAgICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoJywnLCAnLicpKSAqIDEwMDA7CiAgfQogIC8vIHN5bmNocm9ub3VzbHkgZm9yY2UgbGF5b3V0IHRvIHB1dCBlbGVtZW50cyBpbnRvIGEgY2VydGFpbiBzdGF0ZQogIGZ1bmN0aW9uIGZvcmNlUmVmbG93KCkgewogICAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQ7CiAgfQoKICBjb25zdCBwb3NpdGlvbk1hcCA9IG5ldyBXZWFrTWFwKCk7CiAgY29uc3QgbmV3UG9zaXRpb25NYXAgPSBuZXcgV2Vha01hcCgpOwogIGNvbnN0IFRyYW5zaXRpb25Hcm91cEltcGwgPSB7CiAgICAgIG5hbWU6ICdUcmFuc2l0aW9uR3JvdXAnLAogICAgICBwcm9wczogLyojX19QVVJFX18qLyBleHRlbmQoe30sIFRyYW5zaXRpb25Qcm9wc1ZhbGlkYXRvcnMsIHsKICAgICAgICAgIHRhZzogU3RyaW5nLAogICAgICAgICAgbW92ZUNsYXNzOiBTdHJpbmcKICAgICAgfSksCiAgICAgIHNldHVwKHByb3BzLCB7IHNsb3RzIH0pIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICAgICAgICBjb25zdCBzdGF0ZSA9IHVzZVRyYW5zaXRpb25TdGF0ZSgpOwogICAgICAgICAgbGV0IHByZXZDaGlsZHJlbjsKICAgICAgICAgIGxldCBjaGlsZHJlbjsKICAgICAgICAgIG9uVXBkYXRlZCgoKSA9PiB7CiAgICAgICAgICAgICAgLy8gY2hpbGRyZW4gaXMgZ3VhcmFudGVlZCB0byBleGlzdCBhZnRlciBpbml0aWFsIHJlbmRlcgogICAgICAgICAgICAgIGlmICghcHJldkNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG1vdmVDbGFzcyA9IHByb3BzLm1vdmVDbGFzcyB8fCBgJHtwcm9wcy5uYW1lIHx8ICd2J30tbW92ZWA7CiAgICAgICAgICAgICAgaWYgKCFoYXNDU1NUcmFuc2Zvcm0ocHJldkNoaWxkcmVuWzBdLmVsLCBpbnN0YW5jZS52bm9kZS5lbCwgbW92ZUNsYXNzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHdlIGRpdmlkZSB0aGUgd29yayBpbnRvIHRocmVlIGxvb3BzIHRvIGF2b2lkIG1peGluZyBET00gcmVhZHMgYW5kIHdyaXRlcwogICAgICAgICAgICAgIC8vIGluIGVhY2ggaXRlcmF0aW9uIC0gd2hpY2ggaGVscHMgcHJldmVudCBsYXlvdXQgdGhyYXNoaW5nLgogICAgICAgICAgICAgIHByZXZDaGlsZHJlbi5mb3JFYWNoKGNhbGxQZW5kaW5nQ2JzKTsKICAgICAgICAgICAgICBwcmV2Q2hpbGRyZW4uZm9yRWFjaChyZWNvcmRQb3NpdGlvbik7CiAgICAgICAgICAgICAgY29uc3QgbW92ZWRDaGlsZHJlbiA9IHByZXZDaGlsZHJlbi5maWx0ZXIoYXBwbHlUcmFuc2xhdGlvbik7CiAgICAgICAgICAgICAgLy8gZm9yY2UgcmVmbG93IHRvIHB1dCBldmVyeXRoaW5nIGluIHBvc2l0aW9uCiAgICAgICAgICAgICAgZm9yY2VSZWZsb3coKTsKICAgICAgICAgICAgICBtb3ZlZENoaWxkcmVuLmZvckVhY2goYyA9PiB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gYy5lbDsKICAgICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBlbC5zdHlsZTsKICAgICAgICAgICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgICAgICAgICAgICBzdHlsZS50cmFuc2Zvcm0gPSBzdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSAnJzsKICAgICAgICAgICAgICAgICAgY29uc3QgY2IgPSAoZWwuX21vdmVDYiA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLnRhcmdldCAhPT0gZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUgfHwgL3RyYW5zZm9ybSQvLnRlc3QoZS5wcm9wZXJ0eU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIGNiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5fbW92ZUNiID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIG1vdmVDbGFzcyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgY2IpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHJhd1Byb3BzID0gdG9SYXcocHJvcHMpOwogICAgICAgICAgICAgIGNvbnN0IGNzc1RyYW5zaXRpb25Qcm9wcyA9IHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpOwogICAgICAgICAgICAgIGxldCB0YWcgPSByYXdQcm9wcy50YWcgfHwgRnJhZ21lbnQ7CiAgICAgICAgICAgICAgcHJldkNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBzbG90cy5kZWZhdWx0ID8gZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKHNsb3RzLmRlZmF1bHQoKSkgOiBbXTsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKGNoaWxkLCByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKGNoaWxkLCBjc3NUcmFuc2l0aW9uUHJvcHMsIHN0YXRlLCBpbnN0YW5jZSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgd2FybiQxKGA8VHJhbnNpdGlvbkdyb3VwPiBjaGlsZHJlbiBtdXN0IGJlIGtleWVkLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmV2Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gcHJldkNoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKGNoaWxkLCByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKGNoaWxkLCBjc3NUcmFuc2l0aW9uUHJvcHMsIHN0YXRlLCBpbnN0YW5jZSkpOwogICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25NYXAuc2V0KGNoaWxkLCBjaGlsZC5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKHRhZywgbnVsbCwgY2hpbGRyZW4pOwogICAgICAgICAgfTsKICAgICAgfQogIH07CiAgY29uc3QgVHJhbnNpdGlvbkdyb3VwID0gVHJhbnNpdGlvbkdyb3VwSW1wbDsKICBmdW5jdGlvbiBjYWxsUGVuZGluZ0NicyhjKSB7CiAgICAgIGNvbnN0IGVsID0gYy5lbDsKICAgICAgaWYgKGVsLl9tb3ZlQ2IpIHsKICAgICAgICAgIGVsLl9tb3ZlQ2IoKTsKICAgICAgfQogICAgICBpZiAoZWwuX2VudGVyQ2IpIHsKICAgICAgICAgIGVsLl9lbnRlckNiKCk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gcmVjb3JkUG9zaXRpb24oYykgewogICAgICBuZXdQb3NpdGlvbk1hcC5zZXQoYywgYy5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSk7CiAgfQogIGZ1bmN0aW9uIGFwcGx5VHJhbnNsYXRpb24oYykgewogICAgICBjb25zdCBvbGRQb3MgPSBwb3NpdGlvbk1hcC5nZXQoYyk7CiAgICAgIGNvbnN0IG5ld1BvcyA9IG5ld1Bvc2l0aW9uTWFwLmdldChjKTsKICAgICAgY29uc3QgZHggPSBvbGRQb3MubGVmdCAtIG5ld1Bvcy5sZWZ0OwogICAgICBjb25zdCBkeSA9IG9sZFBvcy50b3AgLSBuZXdQb3MudG9wOwogICAgICBpZiAoZHggfHwgZHkpIHsKICAgICAgICAgIGNvbnN0IHMgPSBjLmVsLnN0eWxlOwogICAgICAgICAgcy50cmFuc2Zvcm0gPSBzLndlYmtpdFRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtkeH1weCwke2R5fXB4KWA7CiAgICAgICAgICBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcwcyc7CiAgICAgICAgICByZXR1cm4gYzsKICAgICAgfQogIH0KICBmdW5jdGlvbiBoYXNDU1NUcmFuc2Zvcm0oZWwsIHJvb3QsIG1vdmVDbGFzcykgewogICAgICAvLyBEZXRlY3Qgd2hldGhlciBhbiBlbGVtZW50IHdpdGggdGhlIG1vdmUgY2xhc3MgYXBwbGllZCBoYXMKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zLiBTaW5jZSB0aGUgZWxlbWVudCBtYXkgYmUgaW5zaWRlIGFuIGVudGVyaW5nCiAgICAgIC8vIHRyYW5zaXRpb24gYXQgdGhpcyB2ZXJ5IG1vbWVudCwgd2UgbWFrZSBhIGNsb25lIG9mIGl0IGFuZCByZW1vdmUKICAgICAgLy8gYWxsIG90aGVyIHRyYW5zaXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGVuc3VyZSBvbmx5IHRoZSBtb3ZlIGNsYXNzCiAgICAgIC8vIGlzIGFwcGxpZWQuCiAgICAgIGNvbnN0IGNsb25lID0gZWwuY2xvbmVOb2RlKCk7CiAgICAgIGlmIChlbC5fdnRjKSB7CiAgICAgICAgICBlbC5fdnRjLmZvckVhY2goY2xzID0+IHsKICAgICAgICAgICAgICBjbHMuc3BsaXQoL1xzKy8pLmZvckVhY2goYyA9PiBjICYmIGNsb25lLmNsYXNzTGlzdC5yZW1vdmUoYykpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbW92ZUNsYXNzLnNwbGl0KC9ccysvKS5mb3JFYWNoKGMgPT4gYyAmJiBjbG9uZS5jbGFzc0xpc3QuYWRkKGMpKTsKICAgICAgY2xvbmUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgY29uc3QgY29udGFpbmVyID0gKHJvb3Qubm9kZVR5cGUgPT09IDEgPyByb290IDogcm9vdC5wYXJlbnROb2RlKTsKICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGNsb25lKTsKICAgICAgY29uc3QgeyBoYXNUcmFuc2Zvcm0gfSA9IGdldFRyYW5zaXRpb25JbmZvKGNsb25lKTsKICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKGNsb25lKTsKICAgICAgcmV0dXJuIGhhc1RyYW5zZm9ybTsKICB9CgogIGNvbnN0IGdldE1vZGVsQXNzaWduZXIgPSAodm5vZGUpID0+IHsKICAgICAgY29uc3QgZm4gPSB2bm9kZS5wcm9wc1snb25VcGRhdGU6bW9kZWxWYWx1ZSddIHx8CiAgICAgICAgICAoZmFsc2UgKTsKICAgICAgcmV0dXJuIGlzQXJyYXkoZm4pID8gdmFsdWUgPT4gaW52b2tlQXJyYXlGbnMoZm4sIHZhbHVlKSA6IGZuOwogIH07CiAgZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0KGUpIHsKICAgICAgZS50YXJnZXQuY29tcG9zaW5nID0gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gb25Db21wb3NpdGlvbkVuZChlKSB7CiAgICAgIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0OwogICAgICBpZiAodGFyZ2V0LmNvbXBvc2luZykgewogICAgICAgICAgdGFyZ2V0LmNvbXBvc2luZyA9IGZhbHNlOwogICAgICAgICAgdGFyZ2V0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdpbnB1dCcpKTsKICAgICAgfQogIH0KICAvLyBXZSBhcmUgZXhwb3J0aW5nIHRoZSB2LW1vZGVsIHJ1bnRpbWUgZGlyZWN0bHkgYXMgdm5vZGUgaG9va3Mgc28gdGhhdCBpdCBjYW4KICAvLyBiZSB0cmVlLXNoYWtlbiBpbiBjYXNlIHYtbW9kZWwgaXMgbmV2ZXIgdXNlZC4KICBjb25zdCB2TW9kZWxUZXh0ID0gewogICAgICBjcmVhdGVkKGVsLCB7IG1vZGlmaWVyczogeyBsYXp5LCB0cmltLCBudW1iZXIgfSB9LCB2bm9kZSkgewogICAgICAgICAgZWwuX2Fzc2lnbiA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICAgICAgY29uc3QgY2FzdFRvTnVtYmVyID0gbnVtYmVyIHx8ICh2bm9kZS5wcm9wcyAmJiB2bm9kZS5wcm9wcy50eXBlID09PSAnbnVtYmVyJyk7CiAgICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCBsYXp5ID8gJ2NoYW5nZScgOiAnaW5wdXQnLCBlID0+IHsKICAgICAgICAgICAgICBpZiAoZS50YXJnZXQuY29tcG9zaW5nKQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgbGV0IGRvbVZhbHVlID0gZWwudmFsdWU7CiAgICAgICAgICAgICAgaWYgKHRyaW0pIHsKICAgICAgICAgICAgICAgICAgZG9tVmFsdWUgPSBkb21WYWx1ZS50cmltKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjYXN0VG9OdW1iZXIpIHsKICAgICAgICAgICAgICAgICAgZG9tVmFsdWUgPSB0b051bWJlcihkb21WYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsLl9hc3NpZ24oZG9tVmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAodHJpbSkgewogICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXIoZWwsICdjaGFuZ2UnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGVsLnZhbHVlID0gZWwudmFsdWUudHJpbSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFsYXp5KSB7CiAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgJ2NvbXBvc2l0aW9uc3RhcnQnLCBvbkNvbXBvc2l0aW9uU3RhcnQpOwogICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXIoZWwsICdjb21wb3NpdGlvbmVuZCcsIG9uQ29tcG9zaXRpb25FbmQpOwogICAgICAgICAgICAgIC8vIFNhZmFyaSA8IDEwLjIgJiBVSVdlYlZpZXcgZG9lc24ndCBmaXJlIGNvbXBvc2l0aW9uZW5kIHdoZW4KICAgICAgICAgICAgICAvLyBzd2l0Y2hpbmcgZm9jdXMgYmVmb3JlIGNvbmZpcm1pbmcgY29tcG9zaXRpb24gY2hvaWNlCiAgICAgICAgICAgICAgLy8gdGhpcyBhbHNvIGZpeGVzIHRoZSBpc3N1ZSB3aGVyZSBzb21lIGJyb3dzZXJzIGUuZy4gaU9TIENocm9tZQogICAgICAgICAgICAgIC8vIGZpcmVzICJjaGFuZ2UiIGluc3RlYWQgb2YgImlucHV0IiBvbiBhdXRvY29tcGxldGUuCiAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgJ2NoYW5nZScsIG9uQ29tcG9zaXRpb25FbmQpOwogICAgICAgICAgfQogICAgICB9LAogICAgICAvLyBzZXQgdmFsdWUgb24gbW91bnRlZCBzbyBpdCdzIGFmdGVyIG1pbi9tYXggZm9yIHR5cGU9InJhbmdlIgogICAgICBtb3VudGVkKGVsLCB7IHZhbHVlIH0pIHsKICAgICAgICAgIGVsLnZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgIH0sCiAgICAgIGJlZm9yZVVwZGF0ZShlbCwgeyB2YWx1ZSwgbW9kaWZpZXJzOiB7IGxhenksIHRyaW0sIG51bWJlciB9IH0sIHZub2RlKSB7CiAgICAgICAgICBlbC5fYXNzaWduID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICAgICAgICAvLyBhdm9pZCBjbGVhcmluZyB1bnJlc29sdmVkIHRleHQuICMyMzAyCiAgICAgICAgICBpZiAoZWwuY29tcG9zaW5nKQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBlbCAmJiBlbC50eXBlICE9PSAncmFuZ2UnKSB7CiAgICAgICAgICAgICAgaWYgKGxhenkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHJpbSAmJiBlbC52YWx1ZS50cmltKCkgPT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChudW1iZXIgfHwgZWwudHlwZSA9PT0gJ251bWJlcicpICYmIHRvTnVtYmVyKGVsLnZhbHVlKSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7CiAgICAgICAgICBpZiAoZWwudmFsdWUgIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgZWwudmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgfQogIH07CiAgY29uc3Qgdk1vZGVsQ2hlY2tib3ggPSB7CiAgICAgIC8vICM0MDk2IGFycmF5IGNoZWNrYm94ZXMgbmVlZCB0byBiZSBkZWVwIHRyYXZlcnNlZAogICAgICBkZWVwOiB0cnVlLAogICAgICBjcmVhdGVkKGVsLCBfLCB2bm9kZSkgewogICAgICAgICAgZWwuX2Fzc2lnbiA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgJ2NoYW5nZScsICgpID0+IHsKICAgICAgICAgICAgICBjb25zdCBtb2RlbFZhbHVlID0gZWwuX21vZGVsVmFsdWU7CiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudFZhbHVlID0gZ2V0VmFsdWUoZWwpOwogICAgICAgICAgICAgIGNvbnN0IGNoZWNrZWQgPSBlbC5jaGVja2VkOwogICAgICAgICAgICAgIGNvbnN0IGFzc2lnbiA9IGVsLl9hc3NpZ247CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBsb29zZUluZGV4T2YobW9kZWxWYWx1ZSwgZWxlbWVudFZhbHVlKTsKICAgICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBpbmRleCAhPT0gLTE7CiAgICAgICAgICAgICAgICAgIGlmIChjaGVja2VkICYmICFmb3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgYXNzaWduKG1vZGVsVmFsdWUuY29uY2F0KGVsZW1lbnRWYWx1ZSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFjaGVja2VkICYmIGZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IFsuLi5tb2RlbFZhbHVlXTsKICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAgICAgICBhc3NpZ24oZmlsdGVyZWQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGlzU2V0KG1vZGVsVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lZCA9IG5ldyBTZXQobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgICAgICAgIGlmIChjaGVja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICBjbG9uZWQuYWRkKGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjbG9uZWQuZGVsZXRlKGVsZW1lbnRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYXNzaWduKGNsb25lZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBhc3NpZ24oZ2V0Q2hlY2tib3hWYWx1ZShlbCwgY2hlY2tlZCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9LAogICAgICAvLyBzZXQgaW5pdGlhbCBjaGVja2VkIG9uIG1vdW50IHRvIHdhaXQgZm9yIHRydWUtdmFsdWUvZmFsc2UtdmFsdWUKICAgICAgbW91bnRlZDogc2V0Q2hlY2tlZCwKICAgICAgYmVmb3JlVXBkYXRlKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgICAgICAgZWwuX2Fzc2lnbiA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICAgICAgc2V0Q2hlY2tlZChlbCwgYmluZGluZywgdm5vZGUpOwogICAgICB9CiAgfTsKICBmdW5jdGlvbiBzZXRDaGVja2VkKGVsLCB7IHZhbHVlLCBvbGRWYWx1ZSB9LCB2bm9kZSkgewogICAgICBlbC5fbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIGVsLmNoZWNrZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIHZub2RlLnByb3BzLnZhbHVlKSA+IC0xOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzU2V0KHZhbHVlKSkgewogICAgICAgICAgZWwuY2hlY2tlZCA9IHZhbHVlLmhhcyh2bm9kZS5wcm9wcy52YWx1ZSk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAodmFsdWUgIT09IG9sZFZhbHVlKSB7CiAgICAgICAgICBlbC5jaGVja2VkID0gbG9vc2VFcXVhbCh2YWx1ZSwgZ2V0Q2hlY2tib3hWYWx1ZShlbCwgdHJ1ZSkpOwogICAgICB9CiAgfQogIGNvbnN0IHZNb2RlbFJhZGlvID0gewogICAgICBjcmVhdGVkKGVsLCB7IHZhbHVlIH0sIHZub2RlKSB7CiAgICAgICAgICBlbC5jaGVja2VkID0gbG9vc2VFcXVhbCh2YWx1ZSwgdm5vZGUucHJvcHMudmFsdWUpOwogICAgICAgICAgZWwuX2Fzc2lnbiA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgJ2NoYW5nZScsICgpID0+IHsKICAgICAgICAgICAgICBlbC5fYXNzaWduKGdldFZhbHVlKGVsKSk7CiAgICAgICAgICB9KTsKICAgICAgfSwKICAgICAgYmVmb3JlVXBkYXRlKGVsLCB7IHZhbHVlLCBvbGRWYWx1ZSB9LCB2bm9kZSkgewogICAgICAgICAgZWwuX2Fzc2lnbiA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICAgICAgaWYgKHZhbHVlICE9PSBvbGRWYWx1ZSkgewogICAgICAgICAgICAgIGVsLmNoZWNrZWQgPSBsb29zZUVxdWFsKHZhbHVlLCB2bm9kZS5wcm9wcy52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgIH0KICB9OwogIGNvbnN0IHZNb2RlbFNlbGVjdCA9IHsKICAgICAgLy8gPHNlbGVjdCBtdWx0aXBsZT4gdmFsdWUgbmVlZCB0byBiZSBkZWVwIHRyYXZlcnNlZAogICAgICBkZWVwOiB0cnVlLAogICAgICBjcmVhdGVkKGVsLCB7IHZhbHVlLCBtb2RpZmllcnM6IHsgbnVtYmVyIH0gfSwgdm5vZGUpIHsKICAgICAgICAgIGNvbnN0IGlzU2V0TW9kZWwgPSBpc1NldCh2YWx1ZSk7CiAgICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAnY2hhbmdlJywgKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkVmFsID0gQXJyYXkucHJvdG90eXBlLmZpbHRlcgogICAgICAgICAgICAgICAgICAuY2FsbChlbC5vcHRpb25zLCAobykgPT4gby5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgLm1hcCgobykgPT4gbnVtYmVyID8gdG9OdW1iZXIoZ2V0VmFsdWUobykpIDogZ2V0VmFsdWUobykpOwogICAgICAgICAgICAgIGVsLl9hc3NpZ24oZWwubXVsdGlwbGUKICAgICAgICAgICAgICAgICAgPyBpc1NldE1vZGVsCiAgICAgICAgICAgICAgICAgICAgICA/IG5ldyBTZXQoc2VsZWN0ZWRWYWwpCiAgICAgICAgICAgICAgICAgICAgICA6IHNlbGVjdGVkVmFsCiAgICAgICAgICAgICAgICAgIDogc2VsZWN0ZWRWYWxbMF0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbC5fYXNzaWduID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICAgIH0sCiAgICAgIC8vIHNldCB2YWx1ZSBpbiBtb3VudGVkICYgdXBkYXRlZCBiZWNhdXNlIDxzZWxlY3Q+IHJlbGllcyBvbiBpdHMgY2hpbGRyZW4KICAgICAgLy8gPG9wdGlvbj5zLgogICAgICBtb3VudGVkKGVsLCB7IHZhbHVlIH0pIHsKICAgICAgICAgIHNldFNlbGVjdGVkKGVsLCB2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGJlZm9yZVVwZGF0ZShlbCwgX2JpbmRpbmcsIHZub2RlKSB7CiAgICAgICAgICBlbC5fYXNzaWduID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICAgIH0sCiAgICAgIHVwZGF0ZWQoZWwsIHsgdmFsdWUgfSkgewogICAgICAgICAgc2V0U2VsZWN0ZWQoZWwsIHZhbHVlKTsKICAgICAgfQogIH07CiAgZnVuY3Rpb24gc2V0U2VsZWN0ZWQoZWwsIHZhbHVlKSB7CiAgICAgIGNvbnN0IGlzTXVsdGlwbGUgPSBlbC5tdWx0aXBsZTsKICAgICAgaWYgKGlzTXVsdGlwbGUgJiYgIWlzQXJyYXkodmFsdWUpICYmICFpc1NldCh2YWx1ZSkpIHsKICAgICAgICAgIHdhcm4kMShgPHNlbGVjdCBtdWx0aXBsZSB2LW1vZGVsPiBleHBlY3RzIGFuIEFycmF5IG9yIFNldCB2YWx1ZSBmb3IgaXRzIGJpbmRpbmcsIGAgKwogICAgICAgICAgICAgICAgICBgYnV0IGdvdCAke09iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpfS5gKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGVsLm9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBvcHRpb24gPSBlbC5vcHRpb25zW2ldOwogICAgICAgICAgY29uc3Qgb3B0aW9uVmFsdWUgPSBnZXRWYWx1ZShvcHRpb24pOwogICAgICAgICAgaWYgKGlzTXVsdGlwbGUpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gbG9vc2VJbmRleE9mKHZhbHVlLCBvcHRpb25WYWx1ZSkgPiAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHZhbHVlLmhhcyhvcHRpb25WYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGxvb3NlRXF1YWwoZ2V0VmFsdWUob3B0aW9uKSwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKQogICAgICAgICAgICAgICAgICAgICAgZWwuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFpc011bHRpcGxlICYmIGVsLnNlbGVjdGVkSW5kZXggIT09IC0xKSB7CiAgICAgICAgICBlbC5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgIH0KICB9CiAgLy8gcmV0cmlldmUgcmF3IHZhbHVlIHNldCB2aWEgOnZhbHVlIGJpbmRpbmdzCiAgZnVuY3Rpb24gZ2V0VmFsdWUoZWwpIHsKICAgICAgcmV0dXJuICdfdmFsdWUnIGluIGVsID8gZWwuX3ZhbHVlIDogZWwudmFsdWU7CiAgfQogIC8vIHJldHJpZXZlIHJhdyB2YWx1ZSBmb3IgdHJ1ZS12YWx1ZSBhbmQgZmFsc2UtdmFsdWUgc2V0IHZpYSA6dHJ1ZS12YWx1ZSBvciA6ZmFsc2UtdmFsdWUgYmluZGluZ3MKICBmdW5jdGlvbiBnZXRDaGVja2JveFZhbHVlKGVsLCBjaGVja2VkKSB7CiAgICAgIGNvbnN0IGtleSA9IGNoZWNrZWQgPyAnX3RydWVWYWx1ZScgOiAnX2ZhbHNlVmFsdWUnOwogICAgICByZXR1cm4ga2V5IGluIGVsID8gZWxba2V5XSA6IGNoZWNrZWQ7CiAgfQogIGNvbnN0IHZNb2RlbER5bmFtaWMgPSB7CiAgICAgIGNyZWF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKSB7CiAgICAgICAgICBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgbnVsbCwgJ2NyZWF0ZWQnKTsKICAgICAgfSwKICAgICAgbW91bnRlZChlbCwgYmluZGluZywgdm5vZGUpIHsKICAgICAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBudWxsLCAnbW91bnRlZCcpOwogICAgICB9LAogICAgICBiZWZvcmVVcGRhdGUoZWwsIGJpbmRpbmcsIHZub2RlLCBwcmV2Vk5vZGUpIHsKICAgICAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBwcmV2Vk5vZGUsICdiZWZvcmVVcGRhdGUnKTsKICAgICAgfSwKICAgICAgdXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSkgewogICAgICAgICAgY2FsbE1vZGVsSG9vayhlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSwgJ3VwZGF0ZWQnKTsKICAgICAgfQogIH07CiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNNb2RlbCh0YWdOYW1lLCB0eXBlKSB7CiAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgY2FzZSAnU0VMRUNUJzoKICAgICAgICAgICAgICByZXR1cm4gdk1vZGVsU2VsZWN0OwogICAgICAgICAgY2FzZSAnVEVYVEFSRUEnOgogICAgICAgICAgICAgIHJldHVybiB2TW9kZWxUZXh0OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOgogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZNb2RlbENoZWNrYm94OwogICAgICAgICAgICAgICAgICBjYXNlICdyYWRpbyc6CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdk1vZGVsUmFkaW87CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdk1vZGVsVGV4dDsKICAgICAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gY2FsbE1vZGVsSG9vayhlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSwgaG9vaykgewogICAgICBjb25zdCBtb2RlbFRvVXNlID0gcmVzb2x2ZUR5bmFtaWNNb2RlbChlbC50YWdOYW1lLCB2bm9kZS5wcm9wcyAmJiB2bm9kZS5wcm9wcy50eXBlKTsKICAgICAgY29uc3QgZm4gPSBtb2RlbFRvVXNlW2hvb2tdOwogICAgICBmbiAmJiBmbihlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSk7CiAgfQoKICBjb25zdCBzeXN0ZW1Nb2RpZmllcnMgPSBbJ2N0cmwnLCAnc2hpZnQnLCAnYWx0JywgJ21ldGEnXTsKICBjb25zdCBtb2RpZmllckd1YXJkcyA9IHsKICAgICAgc3RvcDogZSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICBwcmV2ZW50OiBlID0+IGUucHJldmVudERlZmF1bHQoKSwKICAgICAgc2VsZjogZSA9PiBlLnRhcmdldCAhPT0gZS5jdXJyZW50VGFyZ2V0LAogICAgICBjdHJsOiBlID0+ICFlLmN0cmxLZXksCiAgICAgIHNoaWZ0OiBlID0+ICFlLnNoaWZ0S2V5LAogICAgICBhbHQ6IGUgPT4gIWUuYWx0S2V5LAogICAgICBtZXRhOiBlID0+ICFlLm1ldGFLZXksCiAgICAgIGxlZnQ6IGUgPT4gJ2J1dHRvbicgaW4gZSAmJiBlLmJ1dHRvbiAhPT0gMCwKICAgICAgbWlkZGxlOiBlID0+ICdidXR0b24nIGluIGUgJiYgZS5idXR0b24gIT09IDEsCiAgICAgIHJpZ2h0OiBlID0+ICdidXR0b24nIGluIGUgJiYgZS5idXR0b24gIT09IDIsCiAgICAgIGV4YWN0OiAoZSwgbW9kaWZpZXJzKSA9PiBzeXN0ZW1Nb2RpZmllcnMuc29tZShtID0+IGVbYCR7bX1LZXlgXSAmJiAhbW9kaWZpZXJzLmluY2x1ZGVzKG0pKQogIH07CiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBjb25zdCB3aXRoTW9kaWZpZXJzID0gKGZuLCBtb2RpZmllcnMpID0+IHsKICAgICAgcmV0dXJuIChldmVudCwgLi4uYXJncykgPT4gewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RpZmllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBndWFyZCA9IG1vZGlmaWVyR3VhcmRzW21vZGlmaWVyc1tpXV07CiAgICAgICAgICAgICAgaWYgKGd1YXJkICYmIGd1YXJkKGV2ZW50LCBtb2RpZmllcnMpKQogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZm4oZXZlbnQsIC4uLmFyZ3MpOwogICAgICB9OwogIH07CiAgLy8gS2VwdCBmb3IgMi54IGNvbXBhdC4KICAvLyBOb3RlOiBJRTExIGNvbXBhdCBmb3IgYHNwYWNlYmFyYCBhbmQgYGRlbGAgaXMgcmVtb3ZlZCBmb3Igbm93LgogIGNvbnN0IGtleU5hbWVzID0gewogICAgICBlc2M6ICdlc2NhcGUnLAogICAgICBzcGFjZTogJyAnLAogICAgICB1cDogJ2Fycm93LXVwJywKICAgICAgbGVmdDogJ2Fycm93LWxlZnQnLAogICAgICByaWdodDogJ2Fycm93LXJpZ2h0JywKICAgICAgZG93bjogJ2Fycm93LWRvd24nLAogICAgICBkZWxldGU6ICdiYWNrc3BhY2UnCiAgfTsKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGNvbnN0IHdpdGhLZXlzID0gKGZuLCBtb2RpZmllcnMpID0+IHsKICAgICAgcmV0dXJuIChldmVudCkgPT4gewogICAgICAgICAgaWYgKCEoJ2tleScgaW4gZXZlbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZXZlbnRLZXkgPSBoeXBoZW5hdGUoZXZlbnQua2V5KTsKICAgICAgICAgIGlmIChtb2RpZmllcnMuc29tZShrID0+IGsgPT09IGV2ZW50S2V5IHx8IGtleU5hbWVzW2tdID09PSBldmVudEtleSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oZXZlbnQpOwogICAgICAgICAgfQogICAgICB9OwogIH07CgogIGNvbnN0IHZTaG93ID0gewogICAgICBiZWZvcmVNb3VudChlbCwgeyB2YWx1ZSB9LCB7IHRyYW5zaXRpb24gfSkgewogICAgICAgICAgZWwuX3ZvZCA9IGVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICcnIDogZWwuc3R5bGUuZGlzcGxheTsKICAgICAgICAgIGlmICh0cmFuc2l0aW9uICYmIHZhbHVlKSB7CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihlbCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBzZXREaXNwbGF5KGVsLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIG1vdW50ZWQoZWwsIHsgdmFsdWUgfSwgeyB0cmFuc2l0aW9uIH0pIHsKICAgICAgICAgIGlmICh0cmFuc2l0aW9uICYmIHZhbHVlKSB7CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5lbnRlcihlbCk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgICAgIHVwZGF0ZWQoZWwsIHsgdmFsdWUsIG9sZFZhbHVlIH0sIHsgdHJhbnNpdGlvbiB9KSB7CiAgICAgICAgICBpZiAoIXZhbHVlID09PSAhb2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgaWYgKHRyYW5zaXRpb24pIHsKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihlbCk7CiAgICAgICAgICAgICAgICAgIHNldERpc3BsYXkoZWwsIHRydWUpOwogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLmVudGVyKGVsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb24ubGVhdmUoZWwsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHNldERpc3BsYXkoZWwsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgc2V0RGlzcGxheShlbCwgdmFsdWUpOwogICAgICAgICAgfQogICAgICB9LAogICAgICBiZWZvcmVVbm1vdW50KGVsLCB7IHZhbHVlIH0pIHsKICAgICAgICAgIHNldERpc3BsYXkoZWwsIHZhbHVlKTsKICAgICAgfQogIH07CiAgZnVuY3Rpb24gc2V0RGlzcGxheShlbCwgdmFsdWUpIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gZWwuX3ZvZCA6ICdub25lJzsKICB9CgogIGNvbnN0IHJlbmRlcmVyT3B0aW9ucyA9IC8qI19fUFVSRV9fKi8gZXh0ZW5kKHsgcGF0Y2hQcm9wIH0sIG5vZGVPcHMpOwogIC8vIGxhenkgY3JlYXRlIHRoZSByZW5kZXJlciAtIHRoaXMgbWFrZXMgY29yZSByZW5kZXJlciBsb2dpYyB0cmVlLXNoYWthYmxlCiAgLy8gaW4gY2FzZSB0aGUgdXNlciBvbmx5IGltcG9ydHMgcmVhY3Rpdml0eSB1dGlsaXRpZXMgZnJvbSBWdWUuCiAgbGV0IHJlbmRlcmVyOwogIGxldCBlbmFibGVkSHlkcmF0aW9uID0gZmFsc2U7CiAgZnVuY3Rpb24gZW5zdXJlUmVuZGVyZXIoKSB7CiAgICAgIHJldHVybiAocmVuZGVyZXIgfHwKICAgICAgICAgIChyZW5kZXJlciA9IGNyZWF0ZVJlbmRlcmVyKHJlbmRlcmVyT3B0aW9ucykpKTsKICB9CiAgZnVuY3Rpb24gZW5zdXJlSHlkcmF0aW9uUmVuZGVyZXIoKSB7CiAgICAgIHJlbmRlcmVyID0gZW5hYmxlZEh5ZHJhdGlvbgogICAgICAgICAgPyByZW5kZXJlcgogICAgICAgICAgOiBjcmVhdGVIeWRyYXRpb25SZW5kZXJlcihyZW5kZXJlck9wdGlvbnMpOwogICAgICBlbmFibGVkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgcmV0dXJuIHJlbmRlcmVyOwogIH0KICAvLyB1c2UgZXhwbGljaXQgdHlwZSBjYXN0cyBoZXJlIHRvIGF2b2lkIGltcG9ydCgpIGNhbGxzIGluIHJvbGxlZC11cCBkLnRzCiAgY29uc3QgcmVuZGVyID0gKCguLi5hcmdzKSA9PiB7CiAgICAgIGVuc3VyZVJlbmRlcmVyKCkucmVuZGVyKC4uLmFyZ3MpOwogIH0pOwogIGNvbnN0IGh5ZHJhdGUgPSAoKC4uLmFyZ3MpID0+IHsKICAgICAgZW5zdXJlSHlkcmF0aW9uUmVuZGVyZXIoKS5oeWRyYXRlKC4uLmFyZ3MpOwogIH0pOwogIGNvbnN0IGNyZWF0ZUFwcCA9ICgoLi4uYXJncykgPT4gewogICAgICBjb25zdCBhcHAgPSBlbnN1cmVSZW5kZXJlcigpLmNyZWF0ZUFwcCguLi5hcmdzKTsKICAgICAgewogICAgICAgICAgaW5qZWN0TmF0aXZlVGFnQ2hlY2soYXBwKTsKICAgICAgICAgIGluamVjdENvbXBpbGVyT3B0aW9uc0NoZWNrKGFwcCk7CiAgICAgIH0KICAgICAgY29uc3QgeyBtb3VudCB9ID0gYXBwOwogICAgICBhcHAubW91bnQgPSAoY29udGFpbmVyT3JTZWxlY3RvcikgPT4gewogICAgICAgICAgY29uc3QgY29udGFpbmVyID0gbm9ybWFsaXplQ29udGFpbmVyKGNvbnRhaW5lck9yU2VsZWN0b3IpOwogICAgICAgICAgaWYgKCFjb250YWluZXIpCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgY29uc3QgY29tcG9uZW50ID0gYXBwLl9jb21wb25lbnQ7CiAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24oY29tcG9uZW50KSAmJiAhY29tcG9uZW50LnJlbmRlciAmJiAhY29tcG9uZW50LnRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgLy8gX19VTlNBRkVfXwogICAgICAgICAgICAgIC8vIFJlYXNvbjogcG90ZW50aWFsIGV4ZWN1dGlvbiBvZiBKUyBleHByZXNzaW9ucyBpbiBpbi1ET00gdGVtcGxhdGUuCiAgICAgICAgICAgICAgLy8gVGhlIHVzZXIgbXVzdCBtYWtlIHN1cmUgdGhlIGluLURPTSB0ZW1wbGF0ZSBpcyB0cnVzdGVkLiBJZiBpdCdzCiAgICAgICAgICAgICAgLy8gcmVuZGVyZWQgYnkgdGhlIHNlcnZlciwgdGhlIHRlbXBsYXRlIHNob3VsZCBub3QgY29udGFpbiBhbnkgdXNlciBkYXRhLgogICAgICAgICAgICAgIGNvbXBvbmVudC50ZW1wbGF0ZSA9IGNvbnRhaW5lci5pbm5lckhUTUw7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBjbGVhciBjb250ZW50IGJlZm9yZSBtb3VudGluZwogICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgY29uc3QgcHJveHkgPSBtb3VudChjb250YWluZXIsIGZhbHNlLCBjb250YWluZXIgaW5zdGFuY2VvZiBTVkdFbGVtZW50KTsKICAgICAgICAgIGlmIChjb250YWluZXIgaW5zdGFuY2VvZiBFbGVtZW50KSB7CiAgICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZUF0dHJpYnV0ZSgndi1jbG9haycpOwogICAgICAgICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2RhdGEtdi1hcHAnLCAnJyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJveHk7CiAgICAgIH07CiAgICAgIHJldHVybiBhcHA7CiAgfSk7CiAgY29uc3QgY3JlYXRlU1NSQXBwID0gKCguLi5hcmdzKSA9PiB7CiAgICAgIGNvbnN0IGFwcCA9IGVuc3VyZUh5ZHJhdGlvblJlbmRlcmVyKCkuY3JlYXRlQXBwKC4uLmFyZ3MpOwogICAgICB7CiAgICAgICAgICBpbmplY3ROYXRpdmVUYWdDaGVjayhhcHApOwogICAgICAgICAgaW5qZWN0Q29tcGlsZXJPcHRpb25zQ2hlY2soYXBwKTsKICAgICAgfQogICAgICBjb25zdCB7IG1vdW50IH0gPSBhcHA7CiAgICAgIGFwcC5tb3VudCA9IChjb250YWluZXJPclNlbGVjdG9yKSA9PiB7CiAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBub3JtYWxpemVDb250YWluZXIoY29udGFpbmVyT3JTZWxlY3Rvcik7CiAgICAgICAgICBpZiAoY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50KGNvbnRhaW5lciwgdHJ1ZSwgY29udGFpbmVyIGluc3RhbmNlb2YgU1ZHRWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBhcHA7CiAgfSk7CiAgZnVuY3Rpb24gaW5qZWN0TmF0aXZlVGFnQ2hlY2soYXBwKSB7CiAgICAgIC8vIEluamVjdCBgaXNOYXRpdmVUYWdgCiAgICAgIC8vIHRoaXMgaXMgdXNlZCBmb3IgY29tcG9uZW50IG5hbWUgdmFsaWRhdGlvbiAoZGV2IG9ubHkpCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHAuY29uZmlnLCAnaXNOYXRpdmVUYWcnLCB7CiAgICAgICAgICB2YWx1ZTogKHRhZykgPT4gaXNIVE1MVGFnKHRhZykgfHwgaXNTVkdUYWcodGFnKSwKICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZQogICAgICB9KTsKICB9CiAgLy8gZGV2IG9ubHkKICBmdW5jdGlvbiBpbmplY3RDb21waWxlck9wdGlvbnNDaGVjayhhcHApIHsKICAgICAgaWYgKGlzUnVudGltZU9ubHkoKSkgewogICAgICAgICAgY29uc3QgaXNDdXN0b21FbGVtZW50ID0gYXBwLmNvbmZpZy5pc0N1c3RvbUVsZW1lbnQ7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBwLmNvbmZpZywgJ2lzQ3VzdG9tRWxlbWVudCcsIHsKICAgICAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpc0N1c3RvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQoKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShgVGhlIFxgaXNDdXN0b21FbGVtZW50XGAgY29uZmlnIG9wdGlvbiBpcyBkZXByZWNhdGVkLiBVc2UgYCArCiAgICAgICAgICAgICAgICAgICAgICBgXGBjb21waWxlck9wdGlvbnMuaXNDdXN0b21FbGVtZW50XGAgaW5zdGVhZC5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbnN0IGNvbXBpbGVyT3B0aW9ucyA9IGFwcC5jb25maWcuY29tcGlsZXJPcHRpb25zOwogICAgICAgICAgY29uc3QgbXNnID0gYFRoZSBcYGNvbXBpbGVyT3B0aW9uc1xgIGNvbmZpZyBvcHRpb24gaXMgb25seSByZXNwZWN0ZWQgd2hlbiB1c2luZyBgICsKICAgICAgICAgICAgICBgYSBidWlsZCBvZiBWdWUuanMgdGhhdCBpbmNsdWRlcyB0aGUgcnVudGltZSBjb21waWxlciAoYWthICJmdWxsIGJ1aWxkIikuIGAgKwogICAgICAgICAgICAgIGBTaW5jZSB5b3UgYXJlIHVzaW5nIHRoZSBydW50aW1lLW9ubHkgYnVpbGQsIFxgY29tcGlsZXJPcHRpb25zXGAgYCArCiAgICAgICAgICAgICAgYG11c3QgYmUgcGFzc2VkIHRvIFxgQHZ1ZS9jb21waWxlci1kb21cYCBpbiB0aGUgYnVpbGQgc2V0dXAgaW5zdGVhZC5cbmAgKwogICAgICAgICAgICAgIGAtIEZvciB2dWUtbG9hZGVyOiBwYXNzIGl0IHZpYSB2dWUtbG9hZGVyJ3MgXGBjb21waWxlck9wdGlvbnNcYCBsb2FkZXIgb3B0aW9uLlxuYCArCiAgICAgICAgICAgICAgYC0gRm9yIHZ1ZS1jbGk6IHNlZSBodHRwczovL2NsaS52dWVqcy5vcmcvZ3VpZGUvd2VicGFjay5odG1sI21vZGlmeWluZy1vcHRpb25zLW9mLWEtbG9hZGVyXG5gICsKICAgICAgICAgICAgICBgLSBGb3Igdml0ZTogcGFzcyBpdCB2aWEgQHZpdGVqcy9wbHVnaW4tdnVlIG9wdGlvbnMuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdml0ZWpzL3ZpdGUvdHJlZS9tYWluL3BhY2thZ2VzL3BsdWdpbi12dWUjZXhhbXBsZS1mb3ItcGFzc2luZy1vcHRpb25zLXRvLXZ1ZWNvbXBpbGVyLWRvbWA7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBwLmNvbmZpZywgJ2NvbXBpbGVyT3B0aW9ucycsIHsKICAgICAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4kMShtc2cpOwogICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZXJPcHRpb25zOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0KCkgewogICAgICAgICAgICAgICAgICB3YXJuJDEobXNnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBub3JtYWxpemVDb250YWluZXIoY29udGFpbmVyKSB7CiAgICAgIGlmIChpc1N0cmluZyhjb250YWluZXIpKSB7CiAgICAgICAgICBjb25zdCByZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGNvbnRhaW5lcik7CiAgICAgICAgICBpZiAoIXJlcykgewogICAgICAgICAgICAgIHdhcm4kMShgRmFpbGVkIHRvIG1vdW50IGFwcDogbW91bnQgdGFyZ2V0IHNlbGVjdG9yICIke2NvbnRhaW5lcn0iIHJldHVybmVkIG51bGwuYCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJgogICAgICAgICAgY29udGFpbmVyIGluc3RhbmNlb2Ygd2luZG93LlNoYWRvd1Jvb3QgJiYKICAgICAgICAgIGNvbnRhaW5lci5tb2RlID09PSAnY2xvc2VkJykgewogICAgICAgICAgd2FybiQxKGBtb3VudGluZyBvbiBhIFNoYWRvd1Jvb3Qgd2l0aCBcYHttb2RlOiAiY2xvc2VkIn1cYCBtYXkgbGVhZCB0byB1bnByZWRpY3RhYmxlIGJ1Z3NgKTsKICAgICAgfQogICAgICByZXR1cm4gY29udGFpbmVyOwogIH0KICAvKioKICAgKiBAaW50ZXJuYWwKICAgKi8KICBjb25zdCBpbml0RGlyZWN0aXZlc0ZvclNTUiA9IE5PT1A7CgogIGZ1bmN0aW9uIGluaXREZXYoKSB7CiAgICAgIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICBjb25zb2xlLmluZm8oYFlvdSBhcmUgcnVubmluZyBhIGRldmVsb3BtZW50IGJ1aWxkIG9mIFZ1ZS5cbmAgKwogICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIHRvIHVzZSB0aGUgcHJvZHVjdGlvbiBidWlsZCAoKi5wcm9kLmpzKSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5gKTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRDdXN0b21Gb3JtYXR0ZXIoKTsKICAgICAgfQogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdE9uRXJyb3IoZXJyb3IpIHsKICAgICAgdGhyb3cgZXJyb3I7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRPbldhcm4obXNnKSB7CiAgICAgIGNvbnNvbGUud2FybihgW1Z1ZSB3YXJuXSAke21zZy5tZXNzYWdlfWApOwogIH0KICBmdW5jdGlvbiBjcmVhdGVDb21waWxlckVycm9yKGNvZGUsIGxvYywgbWVzc2FnZXMsIGFkZGl0aW9uYWxNZXNzYWdlKSB7CiAgICAgIGNvbnN0IG1zZyA9IChtZXNzYWdlcyB8fCBlcnJvck1lc3NhZ2VzKVtjb2RlXSArIChhZGRpdGlvbmFsTWVzc2FnZSB8fCBgYCkKICAgICAgICAgIDsKICAgICAgY29uc3QgZXJyb3IgPSBuZXcgU3ludGF4RXJyb3IoU3RyaW5nKG1zZykpOwogICAgICBlcnJvci5jb2RlID0gY29kZTsKICAgICAgZXJyb3IubG9jID0gbG9jOwogICAgICByZXR1cm4gZXJyb3I7CiAgfQogIGNvbnN0IGVycm9yTWVzc2FnZXMgPSB7CiAgICAgIC8vIHBhcnNlIGVycm9ycwogICAgICBbMCAvKiBBQlJVUFRfQ0xPU0lOR19PRl9FTVBUWV9DT01NRU5UICovXTogJ0lsbGVnYWwgY29tbWVudC4nLAogICAgICBbMSAvKiBDREFUQV9JTl9IVE1MX0NPTlRFTlQgKi9dOiAnQ0RBVEEgc2VjdGlvbiBpcyBhbGxvd2VkIG9ubHkgaW4gWE1MIGNvbnRleHQuJywKICAgICAgWzIgLyogRFVQTElDQVRFX0FUVFJJQlVURSAqL106ICdEdXBsaWNhdGUgYXR0cmlidXRlLicsCiAgICAgIFszIC8qIEVORF9UQUdfV0lUSF9BVFRSSUJVVEVTICovXTogJ0VuZCB0YWcgY2Fubm90IGhhdmUgYXR0cmlidXRlcy4nLAogICAgICBbNCAvKiBFTkRfVEFHX1dJVEhfVFJBSUxJTkdfU09MSURVUyAqL106ICJJbGxlZ2FsICcvJyBpbiB0YWdzLiIsCiAgICAgIFs1IC8qIEVPRl9CRUZPUkVfVEFHX05BTUUgKi9dOiAnVW5leHBlY3RlZCBFT0YgaW4gdGFnLicsCiAgICAgIFs2IC8qIEVPRl9JTl9DREFUQSAqL106ICdVbmV4cGVjdGVkIEVPRiBpbiBDREFUQSBzZWN0aW9uLicsCiAgICAgIFs3IC8qIEVPRl9JTl9DT01NRU5UICovXTogJ1VuZXhwZWN0ZWQgRU9GIGluIGNvbW1lbnQuJywKICAgICAgWzggLyogRU9GX0lOX1NDUklQVF9IVE1MX0NPTU1FTlRfTElLRV9URVhUICovXTogJ1VuZXhwZWN0ZWQgRU9GIGluIHNjcmlwdC4nLAogICAgICBbOSAvKiBFT0ZfSU5fVEFHICovXTogJ1VuZXhwZWN0ZWQgRU9GIGluIHRhZy4nLAogICAgICBbMTAgLyogSU5DT1JSRUNUTFlfQ0xPU0VEX0NPTU1FTlQgKi9dOiAnSW5jb3JyZWN0bHkgY2xvc2VkIGNvbW1lbnQuJywKICAgICAgWzExIC8qIElOQ09SUkVDVExZX09QRU5FRF9DT01NRU5UICovXTogJ0luY29ycmVjdGx5IG9wZW5lZCBjb21tZW50LicsCiAgICAgIFsxMiAvKiBJTlZBTElEX0ZJUlNUX0NIQVJBQ1RFUl9PRl9UQUdfTkFNRSAqL106ICJJbGxlZ2FsIHRhZyBuYW1lLiBVc2UgJyZsdDsnIHRvIHByaW50ICc8Jy4iLAogICAgICBbMTMgLyogTUlTU0lOR19BVFRSSUJVVEVfVkFMVUUgKi9dOiAnQXR0cmlidXRlIHZhbHVlIHdhcyBleHBlY3RlZC4nLAogICAgICBbMTQgLyogTUlTU0lOR19FTkRfVEFHX05BTUUgKi9dOiAnRW5kIHRhZyBuYW1lIHdhcyBleHBlY3RlZC4nLAogICAgICBbMTUgLyogTUlTU0lOR19XSElURVNQQUNFX0JFVFdFRU5fQVRUUklCVVRFUyAqL106ICdXaGl0ZXNwYWNlIHdhcyBleHBlY3RlZC4nLAogICAgICBbMTYgLyogTkVTVEVEX0NPTU1FTlQgKi9dOiAiVW5leHBlY3RlZCAnPCEtLScgaW4gY29tbWVudC4iLAogICAgICBbMTcgLyogVU5FWFBFQ1RFRF9DSEFSQUNURVJfSU5fQVRUUklCVVRFX05BTUUgKi9dOiAnQXR0cmlidXRlIG5hbWUgY2Fubm90IGNvbnRhaW4gVSswMDIyICgiKSwgVSswMDI3IChcJyksIGFuZCBVKzAwM0MgKDwpLicsCiAgICAgIFsxOCAvKiBVTkVYUEVDVEVEX0NIQVJBQ1RFUl9JTl9VTlFVT1RFRF9BVFRSSUJVVEVfVkFMVUUgKi9dOiAnVW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlIGNhbm5vdCBjb250YWluIFUrMDAyMiAoIiksIFUrMDAyNyAoXCcpLCBVKzAwM0MgKDwpLCBVKzAwM0QgKD0pLCBhbmQgVSswMDYwIChgKS4nLAogICAgICBbMTkgLyogVU5FWFBFQ1RFRF9FUVVBTFNfU0lHTl9CRUZPUkVfQVRUUklCVVRFX05BTUUgKi9dOiAiQXR0cmlidXRlIG5hbWUgY2Fubm90IHN0YXJ0IHdpdGggJz0nLiIsCiAgICAgIFsyMSAvKiBVTkVYUEVDVEVEX1FVRVNUSU9OX01BUktfSU5TVEVBRF9PRl9UQUdfTkFNRSAqL106ICInPD8nIGlzIGFsbG93ZWQgb25seSBpbiBYTUwgY29udGV4dC4iLAogICAgICBbMjAgLyogVU5FWFBFQ1RFRF9OVUxMX0NIQVJBQ1RFUiAqL106IGBVbmV4cGVjdGVkIG51bGwgY2hhcmFjdGVyLmAsCiAgICAgIFsyMiAvKiBVTkVYUEVDVEVEX1NPTElEVVNfSU5fVEFHICovXTogIklsbGVnYWwgJy8nIGluIHRhZ3MuIiwKICAgICAgLy8gVnVlLXNwZWNpZmljIHBhcnNlIGVycm9ycwogICAgICBbMjMgLyogWF9JTlZBTElEX0VORF9UQUcgKi9dOiAnSW52YWxpZCBlbmQgdGFnLicsCiAgICAgIFsyNCAvKiBYX01JU1NJTkdfRU5EX1RBRyAqL106ICdFbGVtZW50IGlzIG1pc3NpbmcgZW5kIHRhZy4nLAogICAgICBbMjUgLyogWF9NSVNTSU5HX0lOVEVSUE9MQVRJT05fRU5EICovXTogJ0ludGVycG9sYXRpb24gZW5kIHNpZ24gd2FzIG5vdCBmb3VuZC4nLAogICAgICBbMjcgLyogWF9NSVNTSU5HX0RZTkFNSUNfRElSRUNUSVZFX0FSR1VNRU5UX0VORCAqL106ICdFbmQgYnJhY2tldCBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgd2FzIG5vdCBmb3VuZC4gJyArCiAgICAgICAgICAnTm90ZSB0aGF0IGR5bmFtaWMgZGlyZWN0aXZlIGFyZ3VtZW50IGNhbm5vdCBjb250YWluIHNwYWNlcy4nLAogICAgICBbMjYgLyogWF9NSVNTSU5HX0RJUkVDVElWRV9OQU1FICovXTogJ0xlZ2FsIGRpcmVjdGl2ZSBuYW1lIHdhcyBleHBlY3RlZC4nLAogICAgICAvLyB0cmFuc2Zvcm0gZXJyb3JzCiAgICAgIFsyOCAvKiBYX1ZfSUZfTk9fRVhQUkVTU0lPTiAqL106IGB2LWlmL3YtZWxzZS1pZiBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgICAgWzI5IC8qIFhfVl9JRl9TQU1FX0tFWSAqL106IGB2LWlmL2Vsc2UgYnJhbmNoZXMgbXVzdCB1c2UgdW5pcXVlIGtleXMuYCwKICAgICAgWzMwIC8qIFhfVl9FTFNFX05PX0FESkFDRU5UX0lGICovXTogYHYtZWxzZS92LWVsc2UtaWYgaGFzIG5vIGFkamFjZW50IHYtaWYgb3Igdi1lbHNlLWlmLmAsCiAgICAgIFszMSAvKiBYX1ZfRk9SX05PX0VYUFJFU1NJT04gKi9dOiBgdi1mb3IgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsCiAgICAgIFszMiAvKiBYX1ZfRk9SX01BTEZPUk1FRF9FWFBSRVNTSU9OICovXTogYHYtZm9yIGhhcyBpbnZhbGlkIGV4cHJlc3Npb24uYCwKICAgICAgWzMzIC8qIFhfVl9GT1JfVEVNUExBVEVfS0VZX1BMQUNFTUVOVCAqL106IGA8dGVtcGxhdGUgdi1mb3I+IGtleSBzaG91bGQgYmUgcGxhY2VkIG9uIHRoZSA8dGVtcGxhdGU+IHRhZy5gLAogICAgICBbMzQgLyogWF9WX0JJTkRfTk9fRVhQUkVTU0lPTiAqL106IGB2LWJpbmQgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsCiAgICAgIFszNSAvKiBYX1ZfT05fTk9fRVhQUkVTU0lPTiAqL106IGB2LW9uIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgICBbMzYgLyogWF9WX1NMT1RfVU5FWFBFQ1RFRF9ESVJFQ1RJVkVfT05fU0xPVF9PVVRMRVQgKi9dOiBgVW5leHBlY3RlZCBjdXN0b20gZGlyZWN0aXZlIG9uIDxzbG90PiBvdXRsZXQuYCwKICAgICAgWzM3IC8qIFhfVl9TTE9UX01JWEVEX1NMT1RfVVNBR0UgKi9dOiBgTWl4ZWQgdi1zbG90IHVzYWdlIG9uIGJvdGggdGhlIGNvbXBvbmVudCBhbmQgbmVzdGVkIDx0ZW1wbGF0ZT4uYCArCiAgICAgICAgICBgV2hlbiB0aGVyZSBhcmUgbXVsdGlwbGUgbmFtZWQgc2xvdHMsIGFsbCBzbG90cyBzaG91bGQgdXNlIDx0ZW1wbGF0ZT4gYCArCiAgICAgICAgICBgc3ludGF4IHRvIGF2b2lkIHNjb3BlIGFtYmlndWl0eS5gLAogICAgICBbMzggLyogWF9WX1NMT1RfRFVQTElDQVRFX1NMT1RfTkFNRVMgKi9dOiBgRHVwbGljYXRlIHNsb3QgbmFtZXMgZm91bmQuIGAsCiAgICAgIFszOSAvKiBYX1ZfU0xPVF9FWFRSQU5FT1VTX0RFRkFVTFRfU0xPVF9DSElMRFJFTiAqL106IGBFeHRyYW5lb3VzIGNoaWxkcmVuIGZvdW5kIHdoZW4gY29tcG9uZW50IGFscmVhZHkgaGFzIGV4cGxpY2l0bHkgbmFtZWQgYCArCiAgICAgICAgICBgZGVmYXVsdCBzbG90LiBUaGVzZSBjaGlsZHJlbiB3aWxsIGJlIGlnbm9yZWQuYCwKICAgICAgWzQwIC8qIFhfVl9TTE9UX01JU1BMQUNFRCAqL106IGB2LXNsb3QgY2FuIG9ubHkgYmUgdXNlZCBvbiBjb21wb25lbnRzIG9yIDx0ZW1wbGF0ZT4gdGFncy5gLAogICAgICBbNDEgLyogWF9WX01PREVMX05PX0VYUFJFU1NJT04gKi9dOiBgdi1tb2RlbCBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgICAgWzQyIC8qIFhfVl9NT0RFTF9NQUxGT1JNRURfRVhQUkVTU0lPTiAqL106IGB2LW1vZGVsIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBKYXZhU2NyaXB0IG1lbWJlciBleHByZXNzaW9uLmAsCiAgICAgIFs0MyAvKiBYX1ZfTU9ERUxfT05fU0NPUEVfVkFSSUFCTEUgKi9dOiBgdi1tb2RlbCBjYW5ub3QgYmUgdXNlZCBvbiB2LWZvciBvciB2LXNsb3Qgc2NvcGUgdmFyaWFibGVzIGJlY2F1c2UgdGhleSBhcmUgbm90IHdyaXRhYmxlLmAsCiAgICAgIFs0NCAvKiBYX0lOVkFMSURfRVhQUkVTU0lPTiAqL106IGBFcnJvciBwYXJzaW5nIEphdmFTY3JpcHQgZXhwcmVzc2lvbjogYCwKICAgICAgWzQ1IC8qIFhfS0VFUF9BTElWRV9JTlZBTElEX0NISUxEUkVOICovXTogYDxLZWVwQWxpdmU+IGV4cGVjdHMgZXhhY3RseSBvbmUgY2hpbGQgY29tcG9uZW50LmAsCiAgICAgIC8vIGdlbmVyaWMgZXJyb3JzCiAgICAgIFs0NiAvKiBYX1BSRUZJWF9JRF9OT1RfU1VQUE9SVEVEICovXTogYCJwcmVmaXhJZGVudGlmaWVycyIgb3B0aW9uIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBidWlsZCBvZiBjb21waWxlci5gLAogICAgICBbNDcgLyogWF9NT0RVTEVfTU9ERV9OT1RfU1VQUE9SVEVEICovXTogYEVTIG1vZHVsZSBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBidWlsZCBvZiBjb21waWxlci5gLAogICAgICBbNDggLyogWF9DQUNIRV9IQU5ETEVSX05PVF9TVVBQT1JURUQgKi9dOiBgImNhY2hlSGFuZGxlcnMiIG9wdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCB3aGVuIHRoZSAicHJlZml4SWRlbnRpZmllcnMiIG9wdGlvbiBpcyBlbmFibGVkLmAsCiAgICAgIFs0OSAvKiBYX1NDT1BFX0lEX05PVF9TVVBQT1JURUQgKi9dOiBgInNjb3BlSWQiIG9wdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCBpbiBtb2R1bGUgbW9kZS5gLAogICAgICAvLyBqdXN0IHRvIGZ1bGZpbGwgdHlwZXMKICAgICAgWzUwIC8qIF9fRVhURU5EX1BPSU5UX18gKi9dOiBgYAogIH07CgogIGNvbnN0IEZSQUdNRU5UID0gU3ltYm9sKGBGcmFnbWVudGAgKTsKICBjb25zdCBURUxFUE9SVCA9IFN5bWJvbChgVGVsZXBvcnRgICk7CiAgY29uc3QgU1VTUEVOU0UgPSBTeW1ib2woYFN1c3BlbnNlYCApOwogIGNvbnN0IEtFRVBfQUxJVkUgPSBTeW1ib2woYEtlZXBBbGl2ZWAgKTsKICBjb25zdCBCQVNFX1RSQU5TSVRJT04gPSBTeW1ib2woYEJhc2VUcmFuc2l0aW9uYCApOwogIGNvbnN0IE9QRU5fQkxPQ0sgPSBTeW1ib2woYG9wZW5CbG9ja2AgKTsKICBjb25zdCBDUkVBVEVfQkxPQ0sgPSBTeW1ib2woYGNyZWF0ZUJsb2NrYCApOwogIGNvbnN0IENSRUFURV9FTEVNRU5UX0JMT0NLID0gU3ltYm9sKGBjcmVhdGVFbGVtZW50QmxvY2tgICk7CiAgY29uc3QgQ1JFQVRFX1ZOT0RFID0gU3ltYm9sKGBjcmVhdGVWTm9kZWAgKTsKICBjb25zdCBDUkVBVEVfRUxFTUVOVF9WTk9ERSA9IFN5bWJvbChgY3JlYXRlRWxlbWVudFZOb2RlYCApOwogIGNvbnN0IENSRUFURV9DT01NRU5UID0gU3ltYm9sKGBjcmVhdGVDb21tZW50Vk5vZGVgICk7CiAgY29uc3QgQ1JFQVRFX1RFWFQgPSBTeW1ib2woYGNyZWF0ZVRleHRWTm9kZWAgKTsKICBjb25zdCBDUkVBVEVfU1RBVElDID0gU3ltYm9sKGBjcmVhdGVTdGF0aWNWTm9kZWAgKTsKICBjb25zdCBSRVNPTFZFX0NPTVBPTkVOVCA9IFN5bWJvbChgcmVzb2x2ZUNvbXBvbmVudGAgKTsKICBjb25zdCBSRVNPTFZFX0RZTkFNSUNfQ09NUE9ORU5UID0gU3ltYm9sKGByZXNvbHZlRHluYW1pY0NvbXBvbmVudGAgKTsKICBjb25zdCBSRVNPTFZFX0RJUkVDVElWRSA9IFN5bWJvbChgcmVzb2x2ZURpcmVjdGl2ZWAgKTsKICBjb25zdCBSRVNPTFZFX0ZJTFRFUiA9IFN5bWJvbChgcmVzb2x2ZUZpbHRlcmAgKTsKICBjb25zdCBXSVRIX0RJUkVDVElWRVMgPSBTeW1ib2woYHdpdGhEaXJlY3RpdmVzYCApOwogIGNvbnN0IFJFTkRFUl9MSVNUID0gU3ltYm9sKGByZW5kZXJMaXN0YCApOwogIGNvbnN0IFJFTkRFUl9TTE9UID0gU3ltYm9sKGByZW5kZXJTbG90YCApOwogIGNvbnN0IENSRUFURV9TTE9UUyA9IFN5bWJvbChgY3JlYXRlU2xvdHNgICk7CiAgY29uc3QgVE9fRElTUExBWV9TVFJJTkcgPSBTeW1ib2woYHRvRGlzcGxheVN0cmluZ2AgKTsKICBjb25zdCBNRVJHRV9QUk9QUyA9IFN5bWJvbChgbWVyZ2VQcm9wc2AgKTsKICBjb25zdCBOT1JNQUxJWkVfQ0xBU1MgPSBTeW1ib2woYG5vcm1hbGl6ZUNsYXNzYCApOwogIGNvbnN0IE5PUk1BTElaRV9TVFlMRSA9IFN5bWJvbChgbm9ybWFsaXplU3R5bGVgICk7CiAgY29uc3QgTk9STUFMSVpFX1BST1BTID0gU3ltYm9sKGBub3JtYWxpemVQcm9wc2AgKTsKICBjb25zdCBHVUFSRF9SRUFDVElWRV9QUk9QUyA9IFN5bWJvbChgZ3VhcmRSZWFjdGl2ZVByb3BzYCApOwogIGNvbnN0IFRPX0hBTkRMRVJTID0gU3ltYm9sKGB0b0hhbmRsZXJzYCApOwogIGNvbnN0IENBTUVMSVpFID0gU3ltYm9sKGBjYW1lbGl6ZWAgKTsKICBjb25zdCBDQVBJVEFMSVpFID0gU3ltYm9sKGBjYXBpdGFsaXplYCApOwogIGNvbnN0IFRPX0hBTkRMRVJfS0VZID0gU3ltYm9sKGB0b0hhbmRsZXJLZXlgICk7CiAgY29uc3QgU0VUX0JMT0NLX1RSQUNLSU5HID0gU3ltYm9sKGBzZXRCbG9ja1RyYWNraW5nYCApOwogIGNvbnN0IFBVU0hfU0NPUEVfSUQgPSBTeW1ib2woYHB1c2hTY29wZUlkYCApOwogIGNvbnN0IFBPUF9TQ09QRV9JRCA9IFN5bWJvbChgcG9wU2NvcGVJZGAgKTsKICBjb25zdCBXSVRIX0NUWCA9IFN5bWJvbChgd2l0aEN0eGAgKTsKICBjb25zdCBVTlJFRiA9IFN5bWJvbChgdW5yZWZgICk7CiAgY29uc3QgSVNfUkVGID0gU3ltYm9sKGBpc1JlZmAgKTsKICBjb25zdCBXSVRIX01FTU8gPSBTeW1ib2woYHdpdGhNZW1vYCApOwogIGNvbnN0IElTX01FTU9fU0FNRSA9IFN5bWJvbChgaXNNZW1vU2FtZWAgKTsKICAvLyBOYW1lIG1hcHBpbmcgZm9yIHJ1bnRpbWUgaGVscGVycyB0aGF0IG5lZWQgdG8gYmUgaW1wb3J0ZWQgZnJvbSAndnVlJyBpbgogIC8vIGdlbmVyYXRlZCBjb2RlLiBNYWtlIHN1cmUgdGhlc2UgYXJlIGNvcnJlY3RseSBleHBvcnRlZCBpbiB0aGUgcnVudGltZSEKICAvLyBVc2luZyBgYW55YCBoZXJlIGJlY2F1c2UgVFMgZG9lc24ndCBhbGxvdyBzeW1ib2xzIGFzIGluZGV4IHR5cGUuCiAgY29uc3QgaGVscGVyTmFtZU1hcCA9IHsKICAgICAgW0ZSQUdNRU5UXTogYEZyYWdtZW50YCwKICAgICAgW1RFTEVQT1JUXTogYFRlbGVwb3J0YCwKICAgICAgW1NVU1BFTlNFXTogYFN1c3BlbnNlYCwKICAgICAgW0tFRVBfQUxJVkVdOiBgS2VlcEFsaXZlYCwKICAgICAgW0JBU0VfVFJBTlNJVElPTl06IGBCYXNlVHJhbnNpdGlvbmAsCiAgICAgIFtPUEVOX0JMT0NLXTogYG9wZW5CbG9ja2AsCiAgICAgIFtDUkVBVEVfQkxPQ0tdOiBgY3JlYXRlQmxvY2tgLAogICAgICBbQ1JFQVRFX0VMRU1FTlRfQkxPQ0tdOiBgY3JlYXRlRWxlbWVudEJsb2NrYCwKICAgICAgW0NSRUFURV9WTk9ERV06IGBjcmVhdGVWTm9kZWAsCiAgICAgIFtDUkVBVEVfRUxFTUVOVF9WTk9ERV06IGBjcmVhdGVFbGVtZW50Vk5vZGVgLAogICAgICBbQ1JFQVRFX0NPTU1FTlRdOiBgY3JlYXRlQ29tbWVudFZOb2RlYCwKICAgICAgW0NSRUFURV9URVhUXTogYGNyZWF0ZVRleHRWTm9kZWAsCiAgICAgIFtDUkVBVEVfU1RBVElDXTogYGNyZWF0ZVN0YXRpY1ZOb2RlYCwKICAgICAgW1JFU09MVkVfQ09NUE9ORU5UXTogYHJlc29sdmVDb21wb25lbnRgLAogICAgICBbUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVF06IGByZXNvbHZlRHluYW1pY0NvbXBvbmVudGAsCiAgICAgIFtSRVNPTFZFX0RJUkVDVElWRV06IGByZXNvbHZlRGlyZWN0aXZlYCwKICAgICAgW1JFU09MVkVfRklMVEVSXTogYHJlc29sdmVGaWx0ZXJgLAogICAgICBbV0lUSF9ESVJFQ1RJVkVTXTogYHdpdGhEaXJlY3RpdmVzYCwKICAgICAgW1JFTkRFUl9MSVNUXTogYHJlbmRlckxpc3RgLAogICAgICBbUkVOREVSX1NMT1RdOiBgcmVuZGVyU2xvdGAsCiAgICAgIFtDUkVBVEVfU0xPVFNdOiBgY3JlYXRlU2xvdHNgLAogICAgICBbVE9fRElTUExBWV9TVFJJTkddOiBgdG9EaXNwbGF5U3RyaW5nYCwKICAgICAgW01FUkdFX1BST1BTXTogYG1lcmdlUHJvcHNgLAogICAgICBbTk9STUFMSVpFX0NMQVNTXTogYG5vcm1hbGl6ZUNsYXNzYCwKICAgICAgW05PUk1BTElaRV9TVFlMRV06IGBub3JtYWxpemVTdHlsZWAsCiAgICAgIFtOT1JNQUxJWkVfUFJPUFNdOiBgbm9ybWFsaXplUHJvcHNgLAogICAgICBbR1VBUkRfUkVBQ1RJVkVfUFJPUFNdOiBgZ3VhcmRSZWFjdGl2ZVByb3BzYCwKICAgICAgW1RPX0hBTkRMRVJTXTogYHRvSGFuZGxlcnNgLAogICAgICBbQ0FNRUxJWkVdOiBgY2FtZWxpemVgLAogICAgICBbQ0FQSVRBTElaRV06IGBjYXBpdGFsaXplYCwKICAgICAgW1RPX0hBTkRMRVJfS0VZXTogYHRvSGFuZGxlcktleWAsCiAgICAgIFtTRVRfQkxPQ0tfVFJBQ0tJTkddOiBgc2V0QmxvY2tUcmFja2luZ2AsCiAgICAgIFtQVVNIX1NDT1BFX0lEXTogYHB1c2hTY29wZUlkYCwKICAgICAgW1BPUF9TQ09QRV9JRF06IGBwb3BTY29wZUlkYCwKICAgICAgW1dJVEhfQ1RYXTogYHdpdGhDdHhgLAogICAgICBbVU5SRUZdOiBgdW5yZWZgLAogICAgICBbSVNfUkVGXTogYGlzUmVmYCwKICAgICAgW1dJVEhfTUVNT106IGB3aXRoTWVtb2AsCiAgICAgIFtJU19NRU1PX1NBTUVdOiBgaXNNZW1vU2FtZWAKICB9OwogIGZ1bmN0aW9uIHJlZ2lzdGVyUnVudGltZUhlbHBlcnMoaGVscGVycykgewogICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGhlbHBlcnMpLmZvckVhY2gocyA9PiB7CiAgICAgICAgICBoZWxwZXJOYW1lTWFwW3NdID0gaGVscGVyc1tzXTsKICAgICAgfSk7CiAgfQoKICAvLyBBU1QgVXRpbGl0aWVzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIFNvbWUgZXhwcmVzc2lvbnMsIGUuZy4gc2VxdWVuY2UgYW5kIGNvbmRpdGlvbmFsIGV4cHJlc3Npb25zLCBhcmUgbmV2ZXIKICAvLyBhc3NvY2lhdGVkIHdpdGggdGVtcGxhdGUgbm9kZXMsIHNvIHRoZWlyIHNvdXJjZSBsb2NhdGlvbnMgYXJlIGp1c3QgYSBzdHViLgogIC8vIENvbnRhaW5lciB0eXBlcyBsaWtlIENvbXBvdW5kRXhwcmVzc2lvbiBhbHNvIGRvbid0IG5lZWQgYSByZWFsIGxvY2F0aW9uLgogIGNvbnN0IGxvY1N0dWIgPSB7CiAgICAgIHNvdXJjZTogJycsCiAgICAgIHN0YXJ0OiB7IGxpbmU6IDEsIGNvbHVtbjogMSwgb2Zmc2V0OiAwIH0sCiAgICAgIGVuZDogeyBsaW5lOiAxLCBjb2x1bW46IDEsIG9mZnNldDogMCB9CiAgfTsKICBmdW5jdGlvbiBjcmVhdGVSb290KGNoaWxkcmVuLCBsb2MgPSBsb2NTdHViKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAwIC8qIFJPT1QgKi8sCiAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgIGhlbHBlcnM6IFtdLAogICAgICAgICAgY29tcG9uZW50czogW10sCiAgICAgICAgICBkaXJlY3RpdmVzOiBbXSwKICAgICAgICAgIGhvaXN0czogW10sCiAgICAgICAgICBpbXBvcnRzOiBbXSwKICAgICAgICAgIGNhY2hlZDogMCwKICAgICAgICAgIHRlbXBzOiAwLAogICAgICAgICAgY29kZWdlbk5vZGU6IHVuZGVmaW5lZCwKICAgICAgICAgIGxvYwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVWTm9kZUNhbGwoY29udGV4dCwgdGFnLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzLCBkaXJlY3RpdmVzLCBpc0Jsb2NrID0gZmFsc2UsIGRpc2FibGVUcmFja2luZyA9IGZhbHNlLCBpc0NvbXBvbmVudCA9IGZhbHNlLCBsb2MgPSBsb2NTdHViKSB7CiAgICAgIGlmIChjb250ZXh0KSB7CiAgICAgICAgICBpZiAoaXNCbG9jaykgewogICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKE9QRU5fQkxPQ0spOwogICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlSGVscGVyKGNvbnRleHQuaW5TU1IsIGlzQ29tcG9uZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGlyZWN0aXZlcykgewogICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKFdJVEhfRElSRUNUSVZFUyk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDEzIC8qIFZOT0RFX0NBTEwgKi8sCiAgICAgICAgICB0YWcsCiAgICAgICAgICBwcm9wcywKICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgcGF0Y2hGbGFnLAogICAgICAgICAgZHluYW1pY1Byb3BzLAogICAgICAgICAgZGlyZWN0aXZlcywKICAgICAgICAgIGlzQmxvY2ssCiAgICAgICAgICBkaXNhYmxlVHJhY2tpbmcsCiAgICAgICAgICBpc0NvbXBvbmVudCwKICAgICAgICAgIGxvYwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVBcnJheUV4cHJlc3Npb24oZWxlbWVudHMsIGxvYyA9IGxvY1N0dWIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDE3IC8qIEpTX0FSUkFZX0VYUFJFU1NJT04gKi8sCiAgICAgICAgICBsb2MsCiAgICAgICAgICBlbGVtZW50cwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVPYmplY3RFeHByZXNzaW9uKHByb3BlcnRpZXMsIGxvYyA9IGxvY1N0dWIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDE1IC8qIEpTX09CSkVDVF9FWFBSRVNTSU9OICovLAogICAgICAgICAgbG9jLAogICAgICAgICAgcHJvcGVydGllcwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVPYmplY3RQcm9wZXJ0eShrZXksIHZhbHVlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAxNiAvKiBKU19QUk9QRVJUWSAqLywKICAgICAgICAgIGxvYzogbG9jU3R1YiwKICAgICAgICAgIGtleTogaXNTdHJpbmcoa2V5KSA/IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oa2V5LCB0cnVlKSA6IGtleSwKICAgICAgICAgIHZhbHVlCiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oY29udGVudCwgaXNTdGF0aWMgPSBmYWxzZSwgbG9jID0gbG9jU3R1YiwgY29uc3RUeXBlID0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8sCiAgICAgICAgICBsb2MsCiAgICAgICAgICBjb250ZW50LAogICAgICAgICAgaXNTdGF0aWMsCiAgICAgICAgICBjb25zdFR5cGU6IGlzU3RhdGljID8gMyAvKiBDQU5fU1RSSU5HSUZZICovIDogY29uc3RUeXBlCiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihjaGlsZHJlbiwgbG9jID0gbG9jU3R1YikgewogICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogOCAvKiBDT01QT1VORF9FWFBSRVNTSU9OICovLAogICAgICAgICAgbG9jLAogICAgICAgICAgY2hpbGRyZW4KICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY2FsbGVlLCBhcmdzID0gW10sIGxvYyA9IGxvY1N0dWIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDE0IC8qIEpTX0NBTExfRVhQUkVTU0lPTiAqLywKICAgICAgICAgIGxvYywKICAgICAgICAgIGNhbGxlZSwKICAgICAgICAgIGFyZ3VtZW50czogYXJncwogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24ocGFyYW1zLCByZXR1cm5zID0gdW5kZWZpbmVkLCBuZXdsaW5lID0gZmFsc2UsIGlzU2xvdCA9IGZhbHNlLCBsb2MgPSBsb2NTdHViKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAxOCAvKiBKU19GVU5DVElPTl9FWFBSRVNTSU9OICovLAogICAgICAgICAgcGFyYW1zLAogICAgICAgICAgcmV0dXJucywKICAgICAgICAgIG5ld2xpbmUsCiAgICAgICAgICBpc1Nsb3QsCiAgICAgICAgICBsb2MKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ29uZGl0aW9uYWxFeHByZXNzaW9uKHRlc3QsIGNvbnNlcXVlbnQsIGFsdGVybmF0ZSwgbmV3bGluZSA9IHRydWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDE5IC8qIEpTX0NPTkRJVElPTkFMX0VYUFJFU1NJT04gKi8sCiAgICAgICAgICB0ZXN0LAogICAgICAgICAgY29uc2VxdWVudCwKICAgICAgICAgIGFsdGVybmF0ZSwKICAgICAgICAgIG5ld2xpbmUsCiAgICAgICAgICBsb2M6IGxvY1N0dWIKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGVFeHByZXNzaW9uKGluZGV4LCB2YWx1ZSwgaXNWTm9kZSA9IGZhbHNlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAyMCAvKiBKU19DQUNIRV9FWFBSRVNTSU9OICovLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIGlzVk5vZGUsCiAgICAgICAgICBsb2M6IGxvY1N0dWIKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQmxvY2tTdGF0ZW1lbnQoYm9keSkgewogICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogMjEgLyogSlNfQkxPQ0tfU1RBVEVNRU5UICovLAogICAgICAgICAgYm9keSwKICAgICAgICAgIGxvYzogbG9jU3R1YgogICAgICB9OwogIH0KCiAgY29uc3QgaXNTdGF0aWNFeHAgPSAocCkgPT4gcC50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmIHAuaXNTdGF0aWM7CiAgY29uc3QgaXNCdWlsdEluVHlwZSA9ICh0YWcsIGV4cGVjdGVkKSA9PiB0YWcgPT09IGV4cGVjdGVkIHx8IHRhZyA9PT0gaHlwaGVuYXRlKGV4cGVjdGVkKTsKICBmdW5jdGlvbiBpc0NvcmVDb21wb25lbnQodGFnKSB7CiAgICAgIGlmIChpc0J1aWx0SW5UeXBlKHRhZywgJ1RlbGVwb3J0JykpIHsKICAgICAgICAgIHJldHVybiBURUxFUE9SVDsKICAgICAgfQogICAgICBlbHNlIGlmIChpc0J1aWx0SW5UeXBlKHRhZywgJ1N1c3BlbnNlJykpIHsKICAgICAgICAgIHJldHVybiBTVVNQRU5TRTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc0J1aWx0SW5UeXBlKHRhZywgJ0tlZXBBbGl2ZScpKSB7CiAgICAgICAgICByZXR1cm4gS0VFUF9BTElWRTsKICAgICAgfQogICAgICBlbHNlIGlmIChpc0J1aWx0SW5UeXBlKHRhZywgJ0Jhc2VUcmFuc2l0aW9uJykpIHsKICAgICAgICAgIHJldHVybiBCQVNFX1RSQU5TSVRJT047CiAgICAgIH0KICB9CiAgY29uc3Qgbm9uSWRlbnRpZmllclJFID0gL15cZHxbXlwkXHddLzsKICBjb25zdCBpc1NpbXBsZUlkZW50aWZpZXIgPSAobmFtZSkgPT4gIW5vbklkZW50aWZpZXJSRS50ZXN0KG5hbWUpOwogIGNvbnN0IHZhbGlkRmlyc3RJZGVudENoYXJSRSA9IC9bQS1aYS16XyRceEEwLVx1RkZGRl0vOwogIGNvbnN0IHZhbGlkSWRlbnRDaGFyUkUgPSAvW1wuXD9cdyRceEEwLVx1RkZGRl0vOwogIGNvbnN0IHdoaXRlc3BhY2VSRSA9IC9ccytbLltdXHMqfFxzKlsuW11ccysvZzsKICAvKioKICAgKiBTaW1wbGUgbGV4ZXIgdG8gY2hlY2sgaWYgYW4gZXhwcmVzc2lvbiBpcyBhIG1lbWJlciBleHByZXNzaW9uLiBUaGlzIGlzCiAgICogbGF4IGFuZCBvbmx5IGNoZWNrcyB2YWxpZGl0eSBhdCB0aGUgcm9vdCBsZXZlbCAoaS5lLiBkb2VzIG5vdCB2YWxpZGF0ZSBleHBzCiAgICogaW5zaWRlIHNxdWFyZSBicmFja2V0cyksIGJ1dCBpdCdzIG9rIHNpbmNlIHRoZXNlIGFyZSBvbmx5IHVzZWQgb24gdGVtcGxhdGUKICAgKiBleHByZXNzaW9ucyBhbmQgZmFsc2UgcG9zaXRpdmVzIGFyZSBpbnZhbGlkIGV4cHJlc3Npb25zIGluIHRoZSBmaXJzdCBwbGFjZS4KICAgKi8KICBjb25zdCBpc01lbWJlckV4cHJlc3Npb25Ccm93c2VyID0gKHBhdGgpID0+IHsKICAgICAgLy8gcmVtb3ZlIHdoaXRlc3BhY2VzIGFyb3VuZCAuIG9yIFsgZmlyc3QKICAgICAgcGF0aCA9IHBhdGgudHJpbSgpLnJlcGxhY2Uod2hpdGVzcGFjZVJFLCBzID0+IHMudHJpbSgpKTsKICAgICAgbGV0IHN0YXRlID0gMCAvKiBpbk1lbWJlckV4cCAqLzsKICAgICAgbGV0IHN0YXRlU3RhY2sgPSBbXTsKICAgICAgbGV0IGN1cnJlbnRPcGVuQnJhY2tldENvdW50ID0gMDsKICAgICAgbGV0IGN1cnJlbnRPcGVuUGFyZW5zQ291bnQgPSAwOwogICAgICBsZXQgY3VycmVudFN0cmluZ1R5cGUgPSBudWxsOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNoYXIgPSBwYXRoLmNoYXJBdChpKTsKICAgICAgICAgIHN3aXRjaCAoc3RhdGUpIHsKICAgICAgICAgICAgICBjYXNlIDAgLyogaW5NZW1iZXJFeHAgKi86CiAgICAgICAgICAgICAgICAgIGlmIChjaGFyID09PSAnWycpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlU3RhY2sucHVzaChzdGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZSA9IDEgLyogaW5CcmFja2V0cyAqLzsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRPcGVuQnJhY2tldENvdW50Kys7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY2hhciA9PT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVN0YWNrLnB1c2goc3RhdGUpOwogICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSAyIC8qIGluUGFyZW5zICovOwogICAgICAgICAgICAgICAgICAgICAgY3VycmVudE9wZW5QYXJlbnNDb3VudCsrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCEoaSA9PT0gMCA/IHZhbGlkRmlyc3RJZGVudENoYXJSRSA6IHZhbGlkSWRlbnRDaGFyUkUpLnRlc3QoY2hhcikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDEgLyogaW5CcmFja2V0cyAqLzoKICAgICAgICAgICAgICAgICAgaWYgKGNoYXIgPT09IGAnYCB8fCBjaGFyID09PSBgImAgfHwgY2hhciA9PT0gJ2AnKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVN0YWNrLnB1c2goc3RhdGUpOwogICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSAzIC8qIGluU3RyaW5nICovOwogICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0cmluZ1R5cGUgPSBjaGFyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNoYXIgPT09IGBbYCkgewogICAgICAgICAgICAgICAgICAgICAgY3VycmVudE9wZW5CcmFja2V0Q291bnQrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFyID09PSBgXWApIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghLS1jdXJyZW50T3BlbkJyYWNrZXRDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gc3RhdGVTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDIgLyogaW5QYXJlbnMgKi86CiAgICAgICAgICAgICAgICAgIGlmIChjaGFyID09PSBgJ2AgfHwgY2hhciA9PT0gYCJgIHx8IGNoYXIgPT09ICdgJykgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGVTdGFjay5wdXNoKHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gMyAvKiBpblN0cmluZyAqLzsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHJpbmdUeXBlID0gY2hhcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFyID09PSBgKGApIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRPcGVuUGFyZW5zQ291bnQrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFyID09PSBgKWApIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBleHAgZW5kcyBhcyBhIGNhbGwgdGhlbiBpdCBzaG91bGQgbm90IGJlIGNvbnNpZGVyZWQgdmFsaWQKICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSBwYXRoLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIS0tY3VycmVudE9wZW5QYXJlbnNDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gc3RhdGVTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDMgLyogaW5TdHJpbmcgKi86CiAgICAgICAgICAgICAgICAgIGlmIChjaGFyID09PSBjdXJyZW50U3RyaW5nVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0cmluZ1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAhY3VycmVudE9wZW5CcmFja2V0Q291bnQgJiYgIWN1cnJlbnRPcGVuUGFyZW5zQ291bnQ7CiAgfTsKICBjb25zdCBpc01lbWJlckV4cHJlc3Npb24gPSBpc01lbWJlckV4cHJlc3Npb25Ccm93c2VyCiAgICAgIDsKICBmdW5jdGlvbiBnZXRJbm5lclJhbmdlKGxvYywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgY29uc3Qgc291cmNlID0gbG9jLnNvdXJjZS5zbGljZShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCk7CiAgICAgIGNvbnN0IG5ld0xvYyA9IHsKICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgIHN0YXJ0OiBhZHZhbmNlUG9zaXRpb25XaXRoQ2xvbmUobG9jLnN0YXJ0LCBsb2Muc291cmNlLCBvZmZzZXQpLAogICAgICAgICAgZW5kOiBsb2MuZW5kCiAgICAgIH07CiAgICAgIGlmIChsZW5ndGggIT0gbnVsbCkgewogICAgICAgICAgbmV3TG9jLmVuZCA9IGFkdmFuY2VQb3NpdGlvbldpdGhDbG9uZShsb2Muc3RhcnQsIGxvYy5zb3VyY2UsIG9mZnNldCArIGxlbmd0aCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ld0xvYzsKICB9CiAgZnVuY3Rpb24gYWR2YW5jZVBvc2l0aW9uV2l0aENsb25lKHBvcywgc291cmNlLCBudW1iZXJPZkNoYXJhY3RlcnMgPSBzb3VyY2UubGVuZ3RoKSB7CiAgICAgIHJldHVybiBhZHZhbmNlUG9zaXRpb25XaXRoTXV0YXRpb24oZXh0ZW5kKHt9LCBwb3MpLCBzb3VyY2UsIG51bWJlck9mQ2hhcmFjdGVycyk7CiAgfQogIC8vIGFkdmFuY2UgYnkgbXV0YXRpb24gd2l0aG91dCBjbG9uaW5nIChmb3IgcGVyZm9ybWFuY2UgcmVhc29ucyksIHNpbmNlIHRoaXMKICAvLyBnZXRzIGNhbGxlZCBhIGxvdCBpbiB0aGUgcGFyc2VyCiAgZnVuY3Rpb24gYWR2YW5jZVBvc2l0aW9uV2l0aE11dGF0aW9uKHBvcywgc291cmNlLCBudW1iZXJPZkNoYXJhY3RlcnMgPSBzb3VyY2UubGVuZ3RoKSB7CiAgICAgIGxldCBsaW5lc0NvdW50ID0gMDsKICAgICAgbGV0IGxhc3ROZXdMaW5lUG9zID0gLTE7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZDaGFyYWN0ZXJzOyBpKyspIHsKICAgICAgICAgIGlmIChzb3VyY2UuY2hhckNvZGVBdChpKSA9PT0gMTAgLyogbmV3bGluZSBjaGFyIGNvZGUgKi8pIHsKICAgICAgICAgICAgICBsaW5lc0NvdW50Kys7CiAgICAgICAgICAgICAgbGFzdE5ld0xpbmVQb3MgPSBpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHBvcy5vZmZzZXQgKz0gbnVtYmVyT2ZDaGFyYWN0ZXJzOwogICAgICBwb3MubGluZSArPSBsaW5lc0NvdW50OwogICAgICBwb3MuY29sdW1uID0KICAgICAgICAgIGxhc3ROZXdMaW5lUG9zID09PSAtMQogICAgICAgICAgICAgID8gcG9zLmNvbHVtbiArIG51bWJlck9mQ2hhcmFjdGVycwogICAgICAgICAgICAgIDogbnVtYmVyT2ZDaGFyYWN0ZXJzIC0gbGFzdE5ld0xpbmVQb3M7CiAgICAgIHJldHVybiBwb3M7CiAgfQogIGZ1bmN0aW9uIGFzc2VydChjb25kaXRpb24sIG1zZykgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFjb25kaXRpb24pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cgfHwgYHVuZXhwZWN0ZWQgY29tcGlsZXIgY29uZGl0aW9uYCk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZERpcihub2RlLCBuYW1lLCBhbGxvd0VtcHR5ID0gZmFsc2UpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICAgIGlmIChwLnR5cGUgPT09IDcgLyogRElSRUNUSVZFICovICYmCiAgICAgICAgICAgICAgKGFsbG93RW1wdHkgfHwgcC5leHApICYmCiAgICAgICAgICAgICAgKGlzU3RyaW5nKG5hbWUpID8gcC5uYW1lID09PSBuYW1lIDogbmFtZS50ZXN0KHAubmFtZSkpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHA7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZFByb3Aobm9kZSwgbmFtZSwgZHluYW1pY09ubHkgPSBmYWxzZSwgYWxsb3dFbXB0eSA9IGZhbHNlKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5wcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IG5vZGUucHJvcHNbaV07CiAgICAgICAgICBpZiAocC50eXBlID09PSA2IC8qIEFUVFJJQlVURSAqLykgewogICAgICAgICAgICAgIGlmIChkeW5hbWljT25seSkKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgaWYgKHAubmFtZSA9PT0gbmFtZSAmJiAocC52YWx1ZSB8fCBhbGxvd0VtcHR5KSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChwLm5hbWUgPT09ICdiaW5kJyAmJgogICAgICAgICAgICAgIChwLmV4cCB8fCBhbGxvd0VtcHR5KSAmJgogICAgICAgICAgICAgIGlzU3RhdGljQXJnT2YocC5hcmcsIG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHA7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gaXNTdGF0aWNBcmdPZihhcmcsIG5hbWUpIHsKICAgICAgcmV0dXJuICEhKGFyZyAmJiBpc1N0YXRpY0V4cChhcmcpICYmIGFyZy5jb250ZW50ID09PSBuYW1lKTsKICB9CiAgZnVuY3Rpb24gaGFzRHluYW1pY0tleVZCaW5kKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUucHJvcHMuc29tZShwID0+IHAudHlwZSA9PT0gNyAvKiBESVJFQ1RJVkUgKi8gJiYKICAgICAgICAgIHAubmFtZSA9PT0gJ2JpbmQnICYmCiAgICAgICAgICAoIXAuYXJnIHx8IC8vIHYtYmluZD0ib2JqIgogICAgICAgICAgICAgIHAuYXJnLnR5cGUgIT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8gfHwgLy8gdi1iaW5kOltfY3R4LmZvb10KICAgICAgICAgICAgICAhcC5hcmcuaXNTdGF0aWMpIC8vIHYtYmluZDpbZm9vXQogICAgICApOwogIH0KICBmdW5jdGlvbiBpc1RleHQobm9kZSkgewogICAgICByZXR1cm4gbm9kZS50eXBlID09PSA1IC8qIElOVEVSUE9MQVRJT04gKi8gfHwgbm9kZS50eXBlID09PSAyIC8qIFRFWFQgKi87CiAgfQogIGZ1bmN0aW9uIGlzVlNsb3QocCkgewogICAgICByZXR1cm4gcC50eXBlID09PSA3IC8qIERJUkVDVElWRSAqLyAmJiBwLm5hbWUgPT09ICdzbG90JzsKICB9CiAgZnVuY3Rpb24gaXNUZW1wbGF0ZU5vZGUobm9kZSkgewogICAgICByZXR1cm4gKG5vZGUudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmIG5vZGUudGFnVHlwZSA9PT0gMyAvKiBURU1QTEFURSAqLyk7CiAgfQogIGZ1bmN0aW9uIGlzU2xvdE91dGxldChub2RlKSB7CiAgICAgIHJldHVybiBub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyAmJiBub2RlLnRhZ1R5cGUgPT09IDIgLyogU0xPVCAqLzsKICB9CiAgZnVuY3Rpb24gZ2V0Vk5vZGVIZWxwZXIoc3NyLCBpc0NvbXBvbmVudCkgewogICAgICByZXR1cm4gc3NyIHx8IGlzQ29tcG9uZW50ID8gQ1JFQVRFX1ZOT0RFIDogQ1JFQVRFX0VMRU1FTlRfVk5PREU7CiAgfQogIGZ1bmN0aW9uIGdldFZOb2RlQmxvY2tIZWxwZXIoc3NyLCBpc0NvbXBvbmVudCkgewogICAgICByZXR1cm4gc3NyIHx8IGlzQ29tcG9uZW50ID8gQ1JFQVRFX0JMT0NLIDogQ1JFQVRFX0VMRU1FTlRfQkxPQ0s7CiAgfQogIGNvbnN0IHByb3BzSGVscGVyU2V0ID0gbmV3IFNldChbTk9STUFMSVpFX1BST1BTLCBHVUFSRF9SRUFDVElWRV9QUk9QU10pOwogIGZ1bmN0aW9uIGdldFVubm9ybWFsaXplZFByb3BzKHByb3BzLCBjYWxsUGF0aCA9IFtdKSB7CiAgICAgIGlmIChwcm9wcyAmJgogICAgICAgICAgIWlzU3RyaW5nKHByb3BzKSAmJgogICAgICAgICAgcHJvcHMudHlwZSA9PT0gMTQgLyogSlNfQ0FMTF9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICBjb25zdCBjYWxsZWUgPSBwcm9wcy5jYWxsZWU7CiAgICAgICAgICBpZiAoIWlzU3RyaW5nKGNhbGxlZSkgJiYgcHJvcHNIZWxwZXJTZXQuaGFzKGNhbGxlZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0VW5ub3JtYWxpemVkUHJvcHMocHJvcHMuYXJndW1lbnRzWzBdLCBjYWxsUGF0aC5jb25jYXQocHJvcHMpKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gW3Byb3BzLCBjYWxsUGF0aF07CiAgfQogIGZ1bmN0aW9uIGluamVjdFByb3Aobm9kZSwgcHJvcCwgY29udGV4dCkgewogICAgICBsZXQgcHJvcHNXaXRoSW5qZWN0aW9uOwogICAgICAvKioKICAgICAgICogMS4gbWVyZ2VQcm9wcyguLi4pCiAgICAgICAqIDIuIHRvSGFuZGxlcnMoLi4uKQogICAgICAgKiAzLiBub3JtYWxpemVQcm9wcyguLi4pCiAgICAgICAqIDQuIG5vcm1hbGl6ZVByb3BzKGd1YXJkUmVhY3RpdmVQcm9wcyguLi4pKQogICAgICAgKgogICAgICAgKiB3ZSBuZWVkIHRvIGdldCB0aGUgcmVhbCBwcm9wcyBiZWZvcmUgbm9ybWFsaXphdGlvbgogICAgICAgKi8KICAgICAgbGV0IHByb3BzID0gbm9kZS50eXBlID09PSAxMyAvKiBWTk9ERV9DQUxMICovID8gbm9kZS5wcm9wcyA6IG5vZGUuYXJndW1lbnRzWzJdOwogICAgICBsZXQgY2FsbFBhdGggPSBbXTsKICAgICAgbGV0IHBhcmVudENhbGw7CiAgICAgIGlmIChwcm9wcyAmJgogICAgICAgICAgIWlzU3RyaW5nKHByb3BzKSAmJgogICAgICAgICAgcHJvcHMudHlwZSA9PT0gMTQgLyogSlNfQ0FMTF9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICBjb25zdCByZXQgPSBnZXRVbm5vcm1hbGl6ZWRQcm9wcyhwcm9wcyk7CiAgICAgICAgICBwcm9wcyA9IHJldFswXTsKICAgICAgICAgIGNhbGxQYXRoID0gcmV0WzFdOwogICAgICAgICAgcGFyZW50Q2FsbCA9IGNhbGxQYXRoW2NhbGxQYXRoLmxlbmd0aCAtIDFdOwogICAgICB9CiAgICAgIGlmIChwcm9wcyA9PSBudWxsIHx8IGlzU3RyaW5nKHByb3BzKSkgewogICAgICAgICAgcHJvcHNXaXRoSW5qZWN0aW9uID0gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHByb3BzLnR5cGUgPT09IDE0IC8qIEpTX0NBTExfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgLy8gbWVyZ2VkIHByb3BzLi4uIGFkZCBvdXJzCiAgICAgICAgICAvLyBvbmx5IGluamVjdCBrZXkgdG8gb2JqZWN0IGxpdGVyYWwgaWYgaXQncyB0aGUgZmlyc3QgYXJndW1lbnQgc28gdGhhdAogICAgICAgICAgLy8gaWYgZG9lc24ndCBvdmVycmlkZSB1c2VyIHByb3ZpZGVkIGtleXMKICAgICAgICAgIGNvbnN0IGZpcnN0ID0gcHJvcHMuYXJndW1lbnRzWzBdOwogICAgICAgICAgaWYgKCFpc1N0cmluZyhmaXJzdCkgJiYgZmlyc3QudHlwZSA9PT0gMTUgLyogSlNfT0JKRUNUX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgICAgICBmaXJzdC5wcm9wZXJ0aWVzLnVuc2hpZnQocHJvcCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBpZiAocHJvcHMuY2FsbGVlID09PSBUT19IQU5ETEVSUykgewogICAgICAgICAgICAgICAgICAvLyAjMjM2NgogICAgICAgICAgICAgICAgICBwcm9wc1dpdGhJbmplY3Rpb24gPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihNRVJHRV9QUk9QUyksIFsKICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oW3Byb3BdKSwKICAgICAgICAgICAgICAgICAgICAgIHByb3BzCiAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvcHMuYXJndW1lbnRzLnVuc2hpZnQoY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAhcHJvcHNXaXRoSW5qZWN0aW9uICYmIChwcm9wc1dpdGhJbmplY3Rpb24gPSBwcm9wcyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAocHJvcHMudHlwZSA9PT0gMTUgLyogSlNfT0JKRUNUX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgIGxldCBhbHJlYWR5RXhpc3RzID0gZmFsc2U7CiAgICAgICAgICAvLyBjaGVjayBleGlzdGluZyBrZXkgdG8gYXZvaWQgb3ZlcnJpZGluZyB1c2VyIHByb3ZpZGVkIGtleXMKICAgICAgICAgIGlmIChwcm9wLmtleS50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICAgICAgY29uc3QgcHJvcEtleU5hbWUgPSBwcm9wLmtleS5jb250ZW50OwogICAgICAgICAgICAgIGFscmVhZHlFeGlzdHMgPSBwcm9wcy5wcm9wZXJ0aWVzLnNvbWUocCA9PiBwLmtleS50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmCiAgICAgICAgICAgICAgICAgIHAua2V5LmNvbnRlbnQgPT09IHByb3BLZXlOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghYWxyZWFkeUV4aXN0cykgewogICAgICAgICAgICAgIHByb3BzLnByb3BlcnRpZXMudW5zaGlmdChwcm9wKTsKICAgICAgICAgIH0KICAgICAgICAgIHByb3BzV2l0aEluamVjdGlvbiA9IHByb3BzOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgLy8gc2luZ2xlIHYtYmluZCB3aXRoIGV4cHJlc3Npb24sIHJldHVybiBhIG1lcmdlZCByZXBsYWNlbWVudAogICAgICAgICAgcHJvcHNXaXRoSW5qZWN0aW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoTUVSR0VfUFJPUFMpLCBbCiAgICAgICAgICAgICAgY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pLAogICAgICAgICAgICAgIHByb3BzCiAgICAgICAgICBdKTsKICAgICAgICAgIC8vIGluIHRoZSBjYXNlIG9mIG5lc3RlZCBoZWxwZXIgY2FsbCwgZS5nLiBgbm9ybWFsaXplUHJvcHMoZ3VhcmRSZWFjdGl2ZVByb3BzKHByb3BzKSlgLAogICAgICAgICAgLy8gaXQgd2lsbCBiZSByZXdyaXR0ZW4gYXMgYG5vcm1hbGl6ZVByb3BzKG1lcmdlUHJvcHMoeyBrZXk6IDAgfSwgcHJvcHMpKWAsCiAgICAgICAgICAvLyB0aGUgYGd1YXJkUmVhY3RpdmVQcm9wc2Agd2lsbCBubyBsb25nZXIgYmUgbmVlZGVkCiAgICAgICAgICBpZiAocGFyZW50Q2FsbCAmJiBwYXJlbnRDYWxsLmNhbGxlZSA9PT0gR1VBUkRfUkVBQ1RJVkVfUFJPUFMpIHsKICAgICAgICAgICAgICBwYXJlbnRDYWxsID0gY2FsbFBhdGhbY2FsbFBhdGgubGVuZ3RoIC0gMl07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG5vZGUudHlwZSA9PT0gMTMgLyogVk5PREVfQ0FMTCAqLykgewogICAgICAgICAgaWYgKHBhcmVudENhbGwpIHsKICAgICAgICAgICAgICBwYXJlbnRDYWxsLmFyZ3VtZW50c1swXSA9IHByb3BzV2l0aEluamVjdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIG5vZGUucHJvcHMgPSBwcm9wc1dpdGhJbmplY3Rpb247CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBpZiAocGFyZW50Q2FsbCkgewogICAgICAgICAgICAgIHBhcmVudENhbGwuYXJndW1lbnRzWzBdID0gcHJvcHNXaXRoSW5qZWN0aW9uOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5hcmd1bWVudHNbMl0gPSBwcm9wc1dpdGhJbmplY3Rpb247CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gdG9WYWxpZEFzc2V0SWQobmFtZSwgdHlwZSkgewogICAgICAvLyBzZWUgaXNzdWUjNDQyMiwgd2UgbmVlZCBhZGRpbmcgaWRlbnRpZmllciBvbiB2YWxpZEFzc2V0SWQgaWYgdmFyaWFibGUgYG5hbWVgIGhhcyBzcGVjaWZpYyBjaGFyYWN0ZXIKICAgICAgcmV0dXJuIGBfJHt0eXBlfV8ke25hbWUucmVwbGFjZSgvW15cd10vZywgKHNlYXJjaFZhbHVlLCByZXBsYWNlVmFsdWUpID0+IHsKICAgICAgICByZXR1cm4gc2VhcmNoVmFsdWUgPT09ICctJyA/ICdfJyA6IG5hbWUuY2hhckNvZGVBdChyZXBsYWNlVmFsdWUpLnRvU3RyaW5nKCk7CiAgICB9KX1gOwogIH0KICBmdW5jdGlvbiBnZXRNZW1vZWRWTm9kZUNhbGwobm9kZSkgewogICAgICBpZiAobm9kZS50eXBlID09PSAxNCAvKiBKU19DQUxMX0VYUFJFU1NJT04gKi8gJiYgbm9kZS5jYWxsZWUgPT09IFdJVEhfTUVNTykgewogICAgICAgICAgcmV0dXJuIG5vZGUuYXJndW1lbnRzWzFdLnJldHVybnM7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBtYWtlQmxvY2sobm9kZSwgeyBoZWxwZXIsIHJlbW92ZUhlbHBlciwgaW5TU1IgfSkgewogICAgICBpZiAoIW5vZGUuaXNCbG9jaykgewogICAgICAgICAgbm9kZS5pc0Jsb2NrID0gdHJ1ZTsKICAgICAgICAgIHJlbW92ZUhlbHBlcihnZXRWTm9kZUhlbHBlcihpblNTUiwgbm9kZS5pc0NvbXBvbmVudCkpOwogICAgICAgICAgaGVscGVyKE9QRU5fQkxPQ0spOwogICAgICAgICAgaGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoaW5TU1IsIG5vZGUuaXNDb21wb25lbnQpKTsKICAgICAgfQogIH0KCiAgY29uc3QgZGVwcmVjYXRpb25EYXRhID0gewogICAgICBbIkNPTVBJTEVSX0lTX09OX0VMRU1FTlQiIC8qIENPTVBJTEVSX0lTX09OX0VMRU1FTlQgKi9dOiB7CiAgICAgICAgICBtZXNzYWdlOiBgUGxhdGZvcm0tbmF0aXZlIGVsZW1lbnRzIHdpdGggImlzIiBwcm9wIHdpbGwgbm8gbG9uZ2VyIGJlIGAgKwogICAgICAgICAgICAgIGB0cmVhdGVkIGFzIGNvbXBvbmVudHMgaW4gVnVlIDMgdW5sZXNzIHRoZSAiaXMiIHZhbHVlIGlzIGV4cGxpY2l0bHkgYCArCiAgICAgICAgICAgICAgYHByZWZpeGVkIHdpdGggInZ1ZToiLmAsCiAgICAgICAgICBsaW5rOiBgaHR0cHM6Ly92My1taWdyYXRpb24udnVlanMub3JnL2JyZWFraW5nLWNoYW5nZXMvY3VzdG9tLWVsZW1lbnRzLWludGVyb3AuaHRtbGAKICAgICAgfSwKICAgICAgWyJDT01QSUxFUl9WX0JJTkRfU1lOQyIgLyogQ09NUElMRVJfVl9CSU5EX1NZTkMgKi9dOiB7CiAgICAgICAgICBtZXNzYWdlOiBrZXkgPT4gYC5zeW5jIG1vZGlmaWVyIGZvciB2LWJpbmQgaGFzIGJlZW4gcmVtb3ZlZC4gVXNlIHYtbW9kZWwgd2l0aCBgICsKICAgICAgICAgICAgICBgYXJndW1lbnQgaW5zdGVhZC4gXGB2LWJpbmQ6JHtrZXl9LnN5bmNcYCBzaG91bGQgYmUgY2hhbmdlZCB0byBgICsKICAgICAgICAgICAgICBgXGB2LW1vZGVsOiR7a2V5fVxgLmAsCiAgICAgICAgICBsaW5rOiBgaHR0cHM6Ly92My1taWdyYXRpb24udnVlanMub3JnL2JyZWFraW5nLWNoYW5nZXMvdi1tb2RlbC5odG1sYAogICAgICB9LAogICAgICBbIkNPTVBJTEVSX1ZfQklORF9QUk9QIiAvKiBDT01QSUxFUl9WX0JJTkRfUFJPUCAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGAucHJvcCBtb2RpZmllciBmb3Igdi1iaW5kIGhhcyBiZWVuIHJlbW92ZWQgYW5kIG5vIGxvbmdlciBuZWNlc3NhcnkuIGAgKwogICAgICAgICAgICAgIGBWdWUgMyB3aWxsIGF1dG9tYXRpY2FsbHkgc2V0IGEgYmluZGluZyBhcyBET00gcHJvcGVydHkgd2hlbiBhcHByb3ByaWF0ZS5gCiAgICAgIH0sCiAgICAgIFsiQ09NUElMRVJfVl9CSU5EX09CSkVDVF9PUkRFUiIgLyogQ09NUElMRVJfVl9CSU5EX09CSkVDVF9PUkRFUiAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGB2LWJpbmQ9Im9iaiIgdXNhZ2UgaXMgbm93IG9yZGVyIHNlbnNpdGl2ZSBhbmQgYmVoYXZlcyBsaWtlIEphdmFTY3JpcHQgYCArCiAgICAgICAgICAgICAgYG9iamVjdCBzcHJlYWQ6IGl0IHdpbGwgbm93IG92ZXJ3cml0ZSBhbiBleGlzdGluZyBub24tbWVyZ2VhYmxlIGF0dHJpYnV0ZSBgICsKICAgICAgICAgICAgICBgdGhhdCBhcHBlYXJzIGJlZm9yZSB2LWJpbmQgaW4gdGhlIGNhc2Ugb2YgY29uZmxpY3QuIGAgKwogICAgICAgICAgICAgIGBUbyByZXRhaW4gMi54IGJlaGF2aW9yLCBtb3ZlIHYtYmluZCB0byBtYWtlIGl0IHRoZSBmaXJzdCBhdHRyaWJ1dGUuIGAgKwogICAgICAgICAgICAgIGBZb3UgY2FuIGFsc28gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGlmIHRoZSB1c2FnZSBpcyBpbnRlbmRlZC5gLAogICAgICAgICAgbGluazogYGh0dHBzOi8vdjMtbWlncmF0aW9uLnZ1ZWpzLm9yZy9icmVha2luZy1jaGFuZ2VzL3YtYmluZC5odG1sYAogICAgICB9LAogICAgICBbIkNPTVBJTEVSX1ZfT05fTkFUSVZFIiAvKiBDT01QSUxFUl9WX09OX05BVElWRSAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGAubmF0aXZlIG1vZGlmaWVyIGZvciB2LW9uIGhhcyBiZWVuIHJlbW92ZWQgYXMgaXMgbm8gbG9uZ2VyIG5lY2Vzc2FyeS5gLAogICAgICAgICAgbGluazogYGh0dHBzOi8vdjMtbWlncmF0aW9uLnZ1ZWpzLm9yZy9icmVha2luZy1jaGFuZ2VzL3Ytb24tbmF0aXZlLW1vZGlmaWVyLXJlbW92ZWQuaHRtbGAKICAgICAgfSwKICAgICAgWyJDT01QSUxFUl9WX0lGX1ZfRk9SX1BSRUNFREVOQ0UiIC8qIENPTVBJTEVSX1ZfSUZfVl9GT1JfUFJFQ0VERU5DRSAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGB2LWlmIC8gdi1mb3IgcHJlY2VkZW5jZSB3aGVuIHVzZWQgb24gdGhlIHNhbWUgZWxlbWVudCBoYXMgY2hhbmdlZCBgICsKICAgICAgICAgICAgICBgaW4gVnVlIDM6IHYtaWYgbm93IHRha2VzIGhpZ2hlciBwcmVjZWRlbmNlIGFuZCB3aWxsIG5vIGxvbmdlciBoYXZlIGAgKwogICAgICAgICAgICAgIGBhY2Nlc3MgdG8gdi1mb3Igc2NvcGUgdmFyaWFibGVzLiBJdCBpcyBiZXN0IHRvIGF2b2lkIHRoZSBhbWJpZ3VpdHkgYCArCiAgICAgICAgICAgICAgYHdpdGggPHRlbXBsYXRlPiB0YWdzIG9yIHVzZSBhIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgZmlsdGVycyB2LWZvciBgICsKICAgICAgICAgICAgICBgZGF0YSBzb3VyY2UuYCwKICAgICAgICAgIGxpbms6IGBodHRwczovL3YzLW1pZ3JhdGlvbi52dWVqcy5vcmcvYnJlYWtpbmctY2hhbmdlcy92LWlmLXYtZm9yLmh0bWxgCiAgICAgIH0sCiAgICAgIFsiQ09NUElMRVJfTkFUSVZFX1RFTVBMQVRFIiAvKiBDT01QSUxFUl9OQVRJVkVfVEVNUExBVEUgKi9dOiB7CiAgICAgICAgICBtZXNzYWdlOiBgPHRlbXBsYXRlPiB3aXRoIG5vIHNwZWNpYWwgZGlyZWN0aXZlcyB3aWxsIHJlbmRlciBhcyBhIG5hdGl2ZSB0ZW1wbGF0ZSBgICsKICAgICAgICAgICAgICBgZWxlbWVudCBpbnN0ZWFkIG9mIGl0cyBpbm5lciBjb250ZW50IGluIFZ1ZSAzLmAKICAgICAgfSwKICAgICAgWyJDT01QSUxFUl9JTkxJTkVfVEVNUExBVEUiIC8qIENPTVBJTEVSX0lOTElORV9URU1QTEFURSAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGAiaW5saW5lLXRlbXBsYXRlIiBoYXMgYmVlbiByZW1vdmVkIGluIFZ1ZSAzLmAsCiAgICAgICAgICBsaW5rOiBgaHR0cHM6Ly92My1taWdyYXRpb24udnVlanMub3JnL2JyZWFraW5nLWNoYW5nZXMvaW5saW5lLXRlbXBsYXRlLWF0dHJpYnV0ZS5odG1sYAogICAgICB9LAogICAgICBbIkNPTVBJTEVSX0ZJTFRFUiIgLyogQ09NUElMRVJfRklMVEVSUyAqL106IHsKICAgICAgICAgIG1lc3NhZ2U6IGBmaWx0ZXJzIGhhdmUgYmVlbiByZW1vdmVkIGluIFZ1ZSAzLiBgICsKICAgICAgICAgICAgICBgVGhlICJ8IiBzeW1ib2wgd2lsbCBiZSB0cmVhdGVkIGFzIG5hdGl2ZSBKYXZhU2NyaXB0IGJpdHdpc2UgT1Igb3BlcmF0b3IuIGAgKwogICAgICAgICAgICAgIGBVc2UgbWV0aG9kIGNhbGxzIG9yIGNvbXB1dGVkIHByb3BlcnRpZXMgaW5zdGVhZC5gLAogICAgICAgICAgbGluazogYGh0dHBzOi8vdjMtbWlncmF0aW9uLnZ1ZWpzLm9yZy9icmVha2luZy1jaGFuZ2VzL2ZpbHRlcnMuaHRtbGAKICAgICAgfQogIH07CiAgZnVuY3Rpb24gZ2V0Q29tcGF0VmFsdWUoa2V5LCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IGNvbmZpZyA9IGNvbnRleHQub3B0aW9ucwogICAgICAgICAgPyBjb250ZXh0Lm9wdGlvbnMuY29tcGF0Q29uZmlnCiAgICAgICAgICA6IGNvbnRleHQuY29tcGF0Q29uZmlnOwogICAgICBjb25zdCB2YWx1ZSA9IGNvbmZpZyAmJiBjb25maWdba2V5XTsKICAgICAgaWYgKGtleSA9PT0gJ01PREUnKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgfHwgMzsgLy8gY29tcGlsZXIgZGVmYXVsdHMgdG8gdjMgYmVoYXZpb3IKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBpc0NvbXBhdEVuYWJsZWQoa2V5LCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IG1vZGUgPSBnZXRDb21wYXRWYWx1ZSgnTU9ERScsIGNvbnRleHQpOwogICAgICBjb25zdCB2YWx1ZSA9IGdldENvbXBhdFZhbHVlKGtleSwgY29udGV4dCk7CiAgICAgIC8vIGluIHYzIG1vZGUsIG9ubHkgZW5hYmxlIGlmIGV4cGxpY2l0bHkgc2V0IHRvIHRydWUKICAgICAgLy8gb3RoZXJ3aXNlIGVuYWJsZSBmb3IgYW55IG5vbi1mYWxzZSB2YWx1ZQogICAgICByZXR1cm4gbW9kZSA9PT0gMyA/IHZhbHVlID09PSB0cnVlIDogdmFsdWUgIT09IGZhbHNlOwogIH0KICBmdW5jdGlvbiBjaGVja0NvbXBhdEVuYWJsZWQoa2V5LCBjb250ZXh0LCBsb2MsIC4uLmFyZ3MpIHsKICAgICAgY29uc3QgZW5hYmxlZCA9IGlzQ29tcGF0RW5hYmxlZChrZXksIGNvbnRleHQpOwogICAgICBpZiAoZW5hYmxlZCkgewogICAgICAgICAgd2FybkRlcHJlY2F0aW9uKGtleSwgY29udGV4dCwgbG9jLCAuLi5hcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gZW5hYmxlZDsKICB9CiAgZnVuY3Rpb24gd2FybkRlcHJlY2F0aW9uKGtleSwgY29udGV4dCwgbG9jLCAuLi5hcmdzKSB7CiAgICAgIGNvbnN0IHZhbCA9IGdldENvbXBhdFZhbHVlKGtleSwgY29udGV4dCk7CiAgICAgIGlmICh2YWwgPT09ICdzdXBwcmVzcy13YXJuaW5nJykgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHsgbWVzc2FnZSwgbGluayB9ID0gZGVwcmVjYXRpb25EYXRhW2tleV07CiAgICAgIGNvbnN0IG1zZyA9IGAoZGVwcmVjYXRpb24gJHtrZXl9KSAke3R5cGVvZiBtZXNzYWdlID09PSAnZnVuY3Rpb24nID8gbWVzc2FnZSguLi5hcmdzKSA6IG1lc3NhZ2V9JHtsaW5rID8gYFxuICBEZXRhaWxzOiAke2xpbmt9YCA6IGBgfWA7CiAgICAgIGNvbnN0IGVyciA9IG5ldyBTeW50YXhFcnJvcihtc2cpOwogICAgICBlcnIuY29kZSA9IGtleTsKICAgICAgaWYgKGxvYykKICAgICAgICAgIGVyci5sb2MgPSBsb2M7CiAgICAgIGNvbnRleHQub25XYXJuKGVycik7CiAgfQoKICAvLyBUaGUgZGVmYXVsdCBkZWNvZGVyIG9ubHkgcHJvdmlkZXMgZXNjYXBlcyBmb3IgY2hhcmFjdGVycyByZXNlcnZlZCBhcyBwYXJ0IG9mCiAgLy8gdGhlIHRlbXBsYXRlIHN5bnRheCwgYW5kIGlzIG9ubHkgdXNlZCBpZiB0aGUgY3VzdG9tIHJlbmRlcmVyIGRpZCBub3QgcHJvdmlkZQogIC8vIGEgcGxhdGZvcm0tc3BlY2lmaWMgZGVjb2Rlci4KICBjb25zdCBkZWNvZGVSRSA9IC8mKGd0fGx0fGFtcHxhcG9zfHF1b3QpOy9nOwogIGNvbnN0IGRlY29kZU1hcCA9IHsKICAgICAgZ3Q6ICc+JywKICAgICAgbHQ6ICc8JywKICAgICAgYW1wOiAnJicsCiAgICAgIGFwb3M6ICInIiwKICAgICAgcXVvdDogJyInCiAgfTsKICBjb25zdCBkZWZhdWx0UGFyc2VyT3B0aW9ucyA9IHsKICAgICAgZGVsaW1pdGVyczogW2B7e2AsIGB9fWBdLAogICAgICBnZXROYW1lc3BhY2U6ICgpID0+IDAgLyogSFRNTCAqLywKICAgICAgZ2V0VGV4dE1vZGU6ICgpID0+IDAgLyogREFUQSAqLywKICAgICAgaXNWb2lkVGFnOiBOTywKICAgICAgaXNQcmVUYWc6IE5PLAogICAgICBpc0N1c3RvbUVsZW1lbnQ6IE5PLAogICAgICBkZWNvZGVFbnRpdGllczogKHJhd1RleHQpID0+IHJhd1RleHQucmVwbGFjZShkZWNvZGVSRSwgKF8sIHAxKSA9PiBkZWNvZGVNYXBbcDFdKSwKICAgICAgb25FcnJvcjogZGVmYXVsdE9uRXJyb3IsCiAgICAgIG9uV2FybjogZGVmYXVsdE9uV2FybiwKICAgICAgY29tbWVudHM6IHRydWUKICB9OwogIGZ1bmN0aW9uIGJhc2VQYXJzZShjb250ZW50LCBvcHRpb25zID0ge30pIHsKICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZVBhcnNlckNvbnRleHQoY29udGVudCwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHN0YXJ0ID0gZ2V0Q3Vyc29yKGNvbnRleHQpOwogICAgICByZXR1cm4gY3JlYXRlUm9vdChwYXJzZUNoaWxkcmVuKGNvbnRleHQsIDAgLyogREFUQSAqLywgW10pLCBnZXRTZWxlY3Rpb24oY29udGV4dCwgc3RhcnQpKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUGFyc2VyQ29udGV4dChjb250ZW50LCByYXdPcHRpb25zKSB7CiAgICAgIGNvbnN0IG9wdGlvbnMgPSBleHRlbmQoe30sIGRlZmF1bHRQYXJzZXJPcHRpb25zKTsKICAgICAgbGV0IGtleTsKICAgICAgZm9yIChrZXkgaW4gcmF3T3B0aW9ucykgewogICAgICAgICAgLy8gQHRzLWlnbm9yZQogICAgICAgICAgb3B0aW9uc1trZXldID0KICAgICAgICAgICAgICByYXdPcHRpb25zW2tleV0gPT09IHVuZGVmaW5lZAogICAgICAgICAgICAgICAgICA/IGRlZmF1bHRQYXJzZXJPcHRpb25zW2tleV0KICAgICAgICAgICAgICAgICAgOiByYXdPcHRpb25zW2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICBjb2x1bW46IDEsCiAgICAgICAgICBsaW5lOiAxLAogICAgICAgICAgb2Zmc2V0OiAwLAogICAgICAgICAgb3JpZ2luYWxTb3VyY2U6IGNvbnRlbnQsCiAgICAgICAgICBzb3VyY2U6IGNvbnRlbnQsCiAgICAgICAgICBpblByZTogZmFsc2UsCiAgICAgICAgICBpblZQcmU6IGZhbHNlLAogICAgICAgICAgb25XYXJuOiBvcHRpb25zLm9uV2FybgogICAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZUNoaWxkcmVuKGNvbnRleHQsIG1vZGUsIGFuY2VzdG9ycykgewogICAgICBjb25zdCBwYXJlbnQgPSBsYXN0KGFuY2VzdG9ycyk7CiAgICAgIGNvbnN0IG5zID0gcGFyZW50ID8gcGFyZW50Lm5zIDogMCAvKiBIVE1MICovOwogICAgICBjb25zdCBub2RlcyA9IFtdOwogICAgICB3aGlsZSAoIWlzRW5kKGNvbnRleHQsIG1vZGUsIGFuY2VzdG9ycykpIHsKICAgICAgICAgIGNvbnN0IHMgPSBjb250ZXh0LnNvdXJjZTsKICAgICAgICAgIGxldCBub2RlID0gdW5kZWZpbmVkOwogICAgICAgICAgaWYgKG1vZGUgPT09IDAgLyogREFUQSAqLyB8fCBtb2RlID09PSAxIC8qIFJDREFUQSAqLykgewogICAgICAgICAgICAgIGlmICghY29udGV4dC5pblZQcmUgJiYgc3RhcnRzV2l0aChzLCBjb250ZXh0Lm9wdGlvbnMuZGVsaW1pdGVyc1swXSkpIHsKICAgICAgICAgICAgICAgICAgLy8gJ3t7JwogICAgICAgICAgICAgICAgICBub2RlID0gcGFyc2VJbnRlcnBvbGF0aW9uKGNvbnRleHQsIG1vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChtb2RlID09PSAwIC8qIERBVEEgKi8gJiYgc1swXSA9PT0gJzwnKSB7CiAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3BhcnNpbmcuaHRtbCN0YWctb3Blbi1zdGF0ZQogICAgICAgICAgICAgICAgICBpZiAocy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCA1IC8qIEVPRl9CRUZPUkVfVEFHX05BTUUgKi8sIDEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNbMV0gPT09ICchJykgewogICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvcGFyc2luZy5odG1sI21hcmt1cC1kZWNsYXJhdGlvbi1vcGVuLXN0YXRlCiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRzV2l0aChzLCAnPCEtLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHBhcnNlQ29tbWVudChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHN0YXJ0c1dpdGgocywgJzwhRE9DVFlQRScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIERPQ1RZUEUgYnkgYSBsaW1pdGF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJzZUJvZ3VzQ29tbWVudChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHN0YXJ0c1dpdGgocywgJzwhW0NEQVRBWycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5zICE9PSAwIC8qIEhUTUwgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHBhcnNlQ0RBVEEoY29udGV4dCwgYW5jZXN0b3JzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAxIC8qIENEQVRBX0lOX0hUTUxfQ09OVEVOVCAqLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJzZUJvZ3VzQ29tbWVudChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMTEgLyogSU5DT1JSRUNUTFlfT1BFTkVEX0NPTU1FTlQgKi8pOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJzZUJvZ3VzQ29tbWVudChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzWzFdID09PSAnLycpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3BhcnNpbmcuaHRtbCNlbmQtdGFnLW9wZW4tc3RhdGUKICAgICAgICAgICAgICAgICAgICAgIGlmIChzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCA1IC8qIEVPRl9CRUZPUkVfVEFHX05BTUUgKi8sIDIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc1syXSA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDE0IC8qIE1JU1NJTkdfRU5EX1RBR19OQU1FICovLCAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgMyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgvW2Etel0vaS50ZXN0KHNbMl0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDIzIC8qIFhfSU5WQUxJRF9FTkRfVEFHICovKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZVRhZyhjb250ZXh0LCAxIC8qIEVuZCAqLywgcGFyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAxMiAvKiBJTlZBTElEX0ZJUlNUX0NIQVJBQ1RFUl9PRl9UQUdfTkFNRSAqLywgMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHBhcnNlQm9ndXNDb21tZW50KGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKC9bYS16XS9pLnRlc3Qoc1sxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJzZUVsZW1lbnQoY29udGV4dCwgYW5jZXN0b3JzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzWzFdID09PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAyMSAvKiBVTkVYUEVDVEVEX1FVRVNUSU9OX01BUktfSU5TVEVBRF9PRl9UQUdfTkFNRSAqLywgMSk7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gcGFyc2VCb2d1c0NvbW1lbnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMTIgLyogSU5WQUxJRF9GSVJTVF9DSEFSQUNURVJfT0ZfVEFHX05BTUUgKi8sIDEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgbm9kZSA9IHBhcnNlVGV4dChjb250ZXh0LCBtb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0FycmF5KG5vZGUpKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hOb2RlKG5vZGVzLCBub2RlW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBwdXNoTm9kZShub2Rlcywgbm9kZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gV2hpdGVzcGFjZSBoYW5kbGluZyBzdHJhdGVneSBsaWtlIHYyCiAgICAgIGxldCByZW1vdmVkV2hpdGVzcGFjZSA9IGZhbHNlOwogICAgICBpZiAobW9kZSAhPT0gMiAvKiBSQVdURVhUICovICYmIG1vZGUgIT09IDEgLyogUkNEQVRBICovKSB7CiAgICAgICAgICBjb25zdCBzaG91bGRDb25kZW5zZSA9IGNvbnRleHQub3B0aW9ucy53aGl0ZXNwYWNlICE9PSAncHJlc2VydmUnOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXTsKICAgICAgICAgICAgICBpZiAoIWNvbnRleHQuaW5QcmUgJiYgbm9kZS50eXBlID09PSAyIC8qIFRFWFQgKi8pIHsKICAgICAgICAgICAgICAgICAgaWYgKCEvW15cdFxyXG5cZiBdLy50ZXN0KG5vZGUuY29udGVudCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXYgPSBub2Rlc1tpIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0ID0gbm9kZXNbaSArIDFdOwogICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGlmOgogICAgICAgICAgICAgICAgICAgICAgLy8gLSB0aGUgd2hpdGVzcGFjZSBpcyB0aGUgZmlyc3Qgb3IgbGFzdCBub2RlLCBvcjoKICAgICAgICAgICAgICAgICAgICAgIC8vIC0gKGNvbmRlbnNlIG1vZGUpIHRoZSB3aGl0ZXNwYWNlIGlzIGFkamFjZW50IHRvIGEgY29tbWVudCwgb3I6CiAgICAgICAgICAgICAgICAgICAgICAvLyAtIChjb25kZW5zZSBtb2RlKSB0aGUgd2hpdGVzcGFjZSBpcyBiZXR3ZWVuIHR3byBlbGVtZW50cyBBTkQgY29udGFpbnMgbmV3bGluZQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmV2IHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgIW5leHQgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAoc2hvdWxkQ29uZGVuc2UgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHByZXYudHlwZSA9PT0gMyAvKiBDT01NRU5UICovIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0LnR5cGUgPT09IDMgLyogQ09NTUVOVCAqLyB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHByZXYudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC50eXBlID09PSAxIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvW1xyXG5dLy50ZXN0KG5vZGUuY29udGVudCkpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkV2hpdGVzcGFjZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNbaV0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCB0aGUgd2hpdGVzcGFjZSBpcyBjb25kZW5zZWQgaW50byBhIHNpbmdsZSBzcGFjZQogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudCA9ICcgJzsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChzaG91bGRDb25kZW5zZSkgewogICAgICAgICAgICAgICAgICAgICAgLy8gaW4gY29uZGVuc2UgbW9kZSwgY29uc2VjdXRpdmUgd2hpdGVzcGFjZXMgaW4gdGV4dCBhcmUgY29uZGVuc2VkCiAgICAgICAgICAgICAgICAgICAgICAvLyBkb3duIHRvIGEgc2luZ2xlIHNwYWNlLgogICAgICAgICAgICAgICAgICAgICAgbm9kZS5jb250ZW50ID0gbm9kZS5jb250ZW50LnJlcGxhY2UoL1tcdFxyXG5cZiBdKy9nLCAnICcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIFJlbW92ZSBjb21tZW50IG5vZGVzIGlmIGRlc2lyZWQgYnkgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLnR5cGUgPT09IDMgLyogQ09NTUVOVCAqLyAmJiAhY29udGV4dC5vcHRpb25zLmNvbW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbW92ZWRXaGl0ZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgbm9kZXNbaV0gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250ZXh0LmluUHJlICYmIHBhcmVudCAmJiBjb250ZXh0Lm9wdGlvbnMuaXNQcmVUYWcocGFyZW50LnRhZykpIHsKICAgICAgICAgICAgICAvLyByZW1vdmUgbGVhZGluZyBuZXdsaW5lIHBlciBodG1sIHNwZWMKICAgICAgICAgICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9ncm91cGluZy1jb250ZW50Lmh0bWwjdGhlLXByZS1lbGVtZW50CiAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSBub2Rlc1swXTsKICAgICAgICAgICAgICBpZiAoZmlyc3QgJiYgZmlyc3QudHlwZSA9PT0gMiAvKiBURVhUICovKSB7CiAgICAgICAgICAgICAgICAgIGZpcnN0LmNvbnRlbnQgPSBmaXJzdC5jb250ZW50LnJlcGxhY2UoL15ccj9cbi8sICcnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlbW92ZWRXaGl0ZXNwYWNlID8gbm9kZXMuZmlsdGVyKEJvb2xlYW4pIDogbm9kZXM7CiAgfQogIGZ1bmN0aW9uIHB1c2hOb2RlKG5vZGVzLCBub2RlKSB7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDIgLyogVEVYVCAqLykgewogICAgICAgICAgY29uc3QgcHJldiA9IGxhc3Qobm9kZXMpOwogICAgICAgICAgLy8gTWVyZ2UgaWYgYm90aCB0aGlzIGFuZCB0aGUgcHJldmlvdXMgbm9kZSBhcmUgdGV4dCBhbmQgdGhvc2UgYXJlCiAgICAgICAgICAvLyBjb25zZWN1dGl2ZS4gVGhpcyBoYXBwZW5zIGZvciBjYXNlcyBsaWtlICJhIDwgYiIuCiAgICAgICAgICBpZiAocHJldiAmJgogICAgICAgICAgICAgIHByZXYudHlwZSA9PT0gMiAvKiBURVhUICovICYmCiAgICAgICAgICAgICAgcHJldi5sb2MuZW5kLm9mZnNldCA9PT0gbm9kZS5sb2Muc3RhcnQub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcHJldi5jb250ZW50ICs9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICBwcmV2LmxvYy5lbmQgPSBub2RlLmxvYy5lbmQ7CiAgICAgICAgICAgICAgcHJldi5sb2Muc291cmNlICs9IG5vZGUubG9jLnNvdXJjZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgbm9kZXMucHVzaChub2RlKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VDREFUQShjb250ZXh0LCBhbmNlc3RvcnMpIHsKICAgICAgYWR2YW5jZUJ5KGNvbnRleHQsIDkpOwogICAgICBjb25zdCBub2RlcyA9IHBhcnNlQ2hpbGRyZW4oY29udGV4dCwgMyAvKiBDREFUQSAqLywgYW5jZXN0b3JzKTsKICAgICAgaWYgKGNvbnRleHQuc291cmNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDYgLyogRU9GX0lOX0NEQVRBICovKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCAzKTsKICAgICAgfQogICAgICByZXR1cm4gbm9kZXM7CiAgfQogIGZ1bmN0aW9uIHBhcnNlQ29tbWVudChjb250ZXh0KSB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gZ2V0Q3Vyc29yKGNvbnRleHQpOwogICAgICBsZXQgY29udGVudDsKICAgICAgLy8gUmVndWxhciBjb21tZW50LgogICAgICBjb25zdCBtYXRjaCA9IC8tLShcISk/Pi8uZXhlYyhjb250ZXh0LnNvdXJjZSk7CiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIGNvbnRlbnQgPSBjb250ZXh0LnNvdXJjZS5zbGljZSg0KTsKICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBjb250ZXh0LnNvdXJjZS5sZW5ndGgpOwogICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDcgLyogRU9GX0lOX0NPTU1FTlQgKi8pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgaWYgKG1hdGNoLmluZGV4IDw9IDMpIHsKICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMCAvKiBBQlJVUFRfQ0xPU0lOR19PRl9FTVBUWV9DT01NRU5UICovKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAxMCAvKiBJTkNPUlJFQ1RMWV9DTE9TRURfQ09NTUVOVCAqLyk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZW50ID0gY29udGV4dC5zb3VyY2Uuc2xpY2UoNCwgbWF0Y2guaW5kZXgpOwogICAgICAgICAgLy8gQWR2YW5jaW5nIHdpdGggcmVwb3J0aW5nIG5lc3RlZCBjb21tZW50cy4KICAgICAgICAgIGNvbnN0IHMgPSBjb250ZXh0LnNvdXJjZS5zbGljZSgwLCBtYXRjaC5pbmRleCk7CiAgICAgICAgICBsZXQgcHJldkluZGV4ID0gMSwgbmVzdGVkSW5kZXggPSAwOwogICAgICAgICAgd2hpbGUgKChuZXN0ZWRJbmRleCA9IHMuaW5kZXhPZignPCEtLScsIHByZXZJbmRleCkpICE9PSAtMSkgewogICAgICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBuZXN0ZWRJbmRleCAtIHByZXZJbmRleCArIDEpOwogICAgICAgICAgICAgIGlmIChuZXN0ZWRJbmRleCArIDQgPCBzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMTYgLyogTkVTVEVEX0NPTU1FTlQgKi8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2SW5kZXggPSBuZXN0ZWRJbmRleCArIDE7CiAgICAgICAgICB9CiAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgbWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGggLSBwcmV2SW5kZXggKyAxKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogMyAvKiBDT01NRU5UICovLAogICAgICAgICAgY29udGVudCwKICAgICAgICAgIGxvYzogZ2V0U2VsZWN0aW9uKGNvbnRleHQsIHN0YXJ0KQogICAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZUJvZ3VzQ29tbWVudChjb250ZXh0KSB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gZ2V0Q3Vyc29yKGNvbnRleHQpOwogICAgICBjb25zdCBjb250ZW50U3RhcnQgPSBjb250ZXh0LnNvdXJjZVsxXSA9PT0gJz8nID8gMSA6IDI7CiAgICAgIGxldCBjb250ZW50OwogICAgICBjb25zdCBjbG9zZUluZGV4ID0gY29udGV4dC5zb3VyY2UuaW5kZXhPZignPicpOwogICAgICBpZiAoY2xvc2VJbmRleCA9PT0gLTEpIHsKICAgICAgICAgIGNvbnRlbnQgPSBjb250ZXh0LnNvdXJjZS5zbGljZShjb250ZW50U3RhcnQpOwogICAgICAgICAgYWR2YW5jZUJ5KGNvbnRleHQsIGNvbnRleHQuc291cmNlLmxlbmd0aCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBjb250ZW50ID0gY29udGV4dC5zb3VyY2Uuc2xpY2UoY29udGVudFN0YXJ0LCBjbG9zZUluZGV4KTsKICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBjbG9zZUluZGV4ICsgMSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6IDMgLyogQ09NTUVOVCAqLywKICAgICAgICAgIGNvbnRlbnQsCiAgICAgICAgICBsb2M6IGdldFNlbGVjdGlvbihjb250ZXh0LCBzdGFydCkKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VFbGVtZW50KGNvbnRleHQsIGFuY2VzdG9ycykgewogICAgICAvLyBTdGFydCB0YWcuCiAgICAgIGNvbnN0IHdhc0luUHJlID0gY29udGV4dC5pblByZTsKICAgICAgY29uc3Qgd2FzSW5WUHJlID0gY29udGV4dC5pblZQcmU7CiAgICAgIGNvbnN0IHBhcmVudCA9IGxhc3QoYW5jZXN0b3JzKTsKICAgICAgY29uc3QgZWxlbWVudCA9IHBhcnNlVGFnKGNvbnRleHQsIDAgLyogU3RhcnQgKi8sIHBhcmVudCk7CiAgICAgIGNvbnN0IGlzUHJlQm91bmRhcnkgPSBjb250ZXh0LmluUHJlICYmICF3YXNJblByZTsKICAgICAgY29uc3QgaXNWUHJlQm91bmRhcnkgPSBjb250ZXh0LmluVlByZSAmJiAhd2FzSW5WUHJlOwogICAgICBpZiAoZWxlbWVudC5pc1NlbGZDbG9zaW5nIHx8IGNvbnRleHQub3B0aW9ucy5pc1ZvaWRUYWcoZWxlbWVudC50YWcpKSB7CiAgICAgICAgICAvLyAjNDAzMCBzZWxmLWNsb3NpbmcgPHByZT4gdGFnCiAgICAgICAgICBpZiAoaXNQcmVCb3VuZGFyeSkgewogICAgICAgICAgICAgIGNvbnRleHQuaW5QcmUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1ZQcmVCb3VuZGFyeSkgewogICAgICAgICAgICAgIGNvbnRleHQuaW5WUHJlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgfQogICAgICAvLyBDaGlsZHJlbi4KICAgICAgYW5jZXN0b3JzLnB1c2goZWxlbWVudCk7CiAgICAgIGNvbnN0IG1vZGUgPSBjb250ZXh0Lm9wdGlvbnMuZ2V0VGV4dE1vZGUoZWxlbWVudCwgcGFyZW50KTsKICAgICAgY29uc3QgY2hpbGRyZW4gPSBwYXJzZUNoaWxkcmVuKGNvbnRleHQsIG1vZGUsIGFuY2VzdG9ycyk7CiAgICAgIGFuY2VzdG9ycy5wb3AoKTsKICAgICAgZWxlbWVudC5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAvLyBFbmQgdGFnLgogICAgICBpZiAoc3RhcnRzV2l0aEVuZFRhZ09wZW4oY29udGV4dC5zb3VyY2UsIGVsZW1lbnQudGFnKSkgewogICAgICAgICAgcGFyc2VUYWcoY29udGV4dCwgMSAvKiBFbmQgKi8sIHBhcmVudCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMjQgLyogWF9NSVNTSU5HX0VORF9UQUcgKi8sIDAsIGVsZW1lbnQubG9jLnN0YXJ0KTsKICAgICAgICAgIGlmIChjb250ZXh0LnNvdXJjZS5sZW5ndGggPT09IDAgJiYgZWxlbWVudC50YWcudG9Mb3dlckNhc2UoKSA9PT0gJ3NjcmlwdCcpIHsKICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IGNoaWxkcmVuWzBdOwogICAgICAgICAgICAgIGlmIChmaXJzdCAmJiBzdGFydHNXaXRoKGZpcnN0LmxvYy5zb3VyY2UsICc8IS0tJykpIHsKICAgICAgICAgICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDggLyogRU9GX0lOX1NDUklQVF9IVE1MX0NPTU1FTlRfTElLRV9URVhUICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZWxlbWVudC5sb2MgPSBnZXRTZWxlY3Rpb24oY29udGV4dCwgZWxlbWVudC5sb2Muc3RhcnQpOwogICAgICBpZiAoaXNQcmVCb3VuZGFyeSkgewogICAgICAgICAgY29udGV4dC5pblByZSA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChpc1ZQcmVCb3VuZGFyeSkgewogICAgICAgICAgY29udGV4dC5pblZQcmUgPSBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gZWxlbWVudDsKICB9CiAgY29uc3QgaXNTcGVjaWFsVGVtcGxhdGVEaXJlY3RpdmUgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoYGlmLGVsc2UsZWxzZS1pZixmb3Isc2xvdGApOwogIGZ1bmN0aW9uIHBhcnNlVGFnKGNvbnRleHQsIHR5cGUsIHBhcmVudCkgewogICAgICAvLyBUYWcgb3Blbi4KICAgICAgY29uc3Qgc3RhcnQgPSBnZXRDdXJzb3IoY29udGV4dCk7CiAgICAgIGNvbnN0IG1hdGNoID0gL148XC8/KFthLXpdW15cdFxyXG5cZiAvPl0qKS9pLmV4ZWMoY29udGV4dC5zb3VyY2UpOwogICAgICBjb25zdCB0YWcgPSBtYXRjaFsxXTsKICAgICAgY29uc3QgbnMgPSBjb250ZXh0Lm9wdGlvbnMuZ2V0TmFtZXNwYWNlKHRhZywgcGFyZW50KTsKICAgICAgYWR2YW5jZUJ5KGNvbnRleHQsIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgIGFkdmFuY2VTcGFjZXMoY29udGV4dCk7CiAgICAgIC8vIHNhdmUgY3VycmVudCBzdGF0ZSBpbiBjYXNlIHdlIG5lZWQgdG8gcmUtcGFyc2UgYXR0cmlidXRlcyB3aXRoIHYtcHJlCiAgICAgIGNvbnN0IGN1cnNvciA9IGdldEN1cnNvcihjb250ZXh0KTsKICAgICAgY29uc3QgY3VycmVudFNvdXJjZSA9IGNvbnRleHQuc291cmNlOwogICAgICAvLyBjaGVjayA8cHJlPiB0YWcKICAgICAgaWYgKGNvbnRleHQub3B0aW9ucy5pc1ByZVRhZyh0YWcpKSB7CiAgICAgICAgICBjb250ZXh0LmluUHJlID0gdHJ1ZTsKICAgICAgfQogICAgICAvLyBBdHRyaWJ1dGVzLgogICAgICBsZXQgcHJvcHMgPSBwYXJzZUF0dHJpYnV0ZXMoY29udGV4dCwgdHlwZSk7CiAgICAgIC8vIGNoZWNrIHYtcHJlCiAgICAgIGlmICh0eXBlID09PSAwIC8qIFN0YXJ0ICovICYmCiAgICAgICAgICAhY29udGV4dC5pblZQcmUgJiYKICAgICAgICAgIHByb3BzLnNvbWUocCA9PiBwLnR5cGUgPT09IDcgLyogRElSRUNUSVZFICovICYmIHAubmFtZSA9PT0gJ3ByZScpKSB7CiAgICAgICAgICBjb250ZXh0LmluVlByZSA9IHRydWU7CiAgICAgICAgICAvLyByZXNldCBjb250ZXh0CiAgICAgICAgICBleHRlbmQoY29udGV4dCwgY3Vyc29yKTsKICAgICAgICAgIGNvbnRleHQuc291cmNlID0gY3VycmVudFNvdXJjZTsKICAgICAgICAgIC8vIHJlLXBhcnNlIGF0dHJzIGFuZCBmaWx0ZXIgb3V0IHYtcHJlIGl0c2VsZgogICAgICAgICAgcHJvcHMgPSBwYXJzZUF0dHJpYnV0ZXMoY29udGV4dCwgdHlwZSkuZmlsdGVyKHAgPT4gcC5uYW1lICE9PSAndi1wcmUnKTsKICAgICAgfQogICAgICAvLyBUYWcgY2xvc2UuCiAgICAgIGxldCBpc1NlbGZDbG9zaW5nID0gZmFsc2U7CiAgICAgIGlmIChjb250ZXh0LnNvdXJjZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCA5IC8qIEVPRl9JTl9UQUcgKi8pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgaXNTZWxmQ2xvc2luZyA9IHN0YXJ0c1dpdGgoY29udGV4dC5zb3VyY2UsICcvPicpOwogICAgICAgICAgaWYgKHR5cGUgPT09IDEgLyogRW5kICovICYmIGlzU2VsZkNsb3NpbmcpIHsKICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgNCAvKiBFTkRfVEFHX1dJVEhfVFJBSUxJTkdfU09MSURVUyAqLyk7CiAgICAgICAgICB9CiAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgaXNTZWxmQ2xvc2luZyA/IDIgOiAxKTsKICAgICAgfQogICAgICBpZiAodHlwZSA9PT0gMSAvKiBFbmQgKi8pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsZXQgdGFnVHlwZSA9IDAgLyogRUxFTUVOVCAqLzsKICAgICAgaWYgKCFjb250ZXh0LmluVlByZSkgewogICAgICAgICAgaWYgKHRhZyA9PT0gJ3Nsb3QnKSB7CiAgICAgICAgICAgICAgdGFnVHlwZSA9IDIgLyogU0xPVCAqLzsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgICAgICAgIGlmIChwcm9wcy5zb21lKHAgPT4gcC50eXBlID09PSA3IC8qIERJUkVDVElWRSAqLyAmJiBpc1NwZWNpYWxUZW1wbGF0ZURpcmVjdGl2ZShwLm5hbWUpKSkgewogICAgICAgICAgICAgICAgICB0YWdUeXBlID0gMyAvKiBURU1QTEFURSAqLzsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc0NvbXBvbmVudCh0YWcsIHByb3BzLCBjb250ZXh0KSkgewogICAgICAgICAgICAgIHRhZ1R5cGUgPSAxIC8qIENPTVBPTkVOVCAqLzsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogMSAvKiBFTEVNRU5UICovLAogICAgICAgICAgbnMsCiAgICAgICAgICB0YWcsCiAgICAgICAgICB0YWdUeXBlLAogICAgICAgICAgcHJvcHMsCiAgICAgICAgICBpc1NlbGZDbG9zaW5nLAogICAgICAgICAgY2hpbGRyZW46IFtdLAogICAgICAgICAgbG9jOiBnZXRTZWxlY3Rpb24oY29udGV4dCwgc3RhcnQpLAogICAgICAgICAgY29kZWdlbk5vZGU6IHVuZGVmaW5lZCAvLyB0byBiZSBjcmVhdGVkIGR1cmluZyB0cmFuc2Zvcm0gcGhhc2UKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gaXNDb21wb25lbnQodGFnLCBwcm9wcywgY29udGV4dCkgewogICAgICBjb25zdCBvcHRpb25zID0gY29udGV4dC5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5pc0N1c3RvbUVsZW1lbnQodGFnKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0YWcgPT09ICdjb21wb25lbnQnIHx8CiAgICAgICAgICAvXltBLVpdLy50ZXN0KHRhZykgfHwKICAgICAgICAgIGlzQ29yZUNvbXBvbmVudCh0YWcpIHx8CiAgICAgICAgICAob3B0aW9ucy5pc0J1aWx0SW5Db21wb25lbnQgJiYgb3B0aW9ucy5pc0J1aWx0SW5Db21wb25lbnQodGFnKSkgfHwKICAgICAgICAgIChvcHRpb25zLmlzTmF0aXZlVGFnICYmICFvcHRpb25zLmlzTmF0aXZlVGFnKHRhZykpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICAvLyBhdCB0aGlzIHBvaW50IHRoZSB0YWcgc2hvdWxkIGJlIGEgbmF0aXZlIHRhZywgYnV0IGNoZWNrIGZvciBwb3RlbnRpYWwgImlzIgogICAgICAvLyBjYXN0aW5nCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBwcm9wc1tpXTsKICAgICAgICAgIGlmIChwLnR5cGUgPT09IDYgLyogQVRUUklCVVRFICovKSB7CiAgICAgICAgICAgICAgaWYgKHAubmFtZSA9PT0gJ2lzJyAmJiBwLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgndnVlOicpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZQogICAgICAgICAgICAgIC8vIHYtaXMgKFRPRE8gRGVwcmVjYXRlKQogICAgICAgICAgICAgIGlmIChwLm5hbWUgPT09ICdpcycpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKAogICAgICAgICAgICAgIC8vIDppcyBvbiBwbGFpbiBlbGVtZW50IC0gb25seSB0cmVhdCBhcyBjb21wb25lbnQgaW4gY29tcGF0IG1vZGUKICAgICAgICAgICAgICBwLm5hbWUgPT09ICdiaW5kJyAmJgogICAgICAgICAgICAgICAgICBpc1N0YXRpY0FyZ09mKHAuYXJnLCAnaXMnKSAmJgogICAgICAgICAgICAgICAgICBmYWxzZSAmJgogICAgICAgICAgICAgICAgICBjaGVja0NvbXBhdEVuYWJsZWQoIkNPTVBJTEVSX0lTX09OX0VMRU1FTlQiIC8qIENPTVBJTEVSX0lTX09OX0VMRU1FTlQgKi8sIGNvbnRleHQsIHAubG9jKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gcGFyc2VBdHRyaWJ1dGVzKGNvbnRleHQsIHR5cGUpIHsKICAgICAgY29uc3QgcHJvcHMgPSBbXTsKICAgICAgY29uc3QgYXR0cmlidXRlTmFtZXMgPSBuZXcgU2V0KCk7CiAgICAgIHdoaWxlIChjb250ZXh0LnNvdXJjZS5sZW5ndGggPiAwICYmCiAgICAgICAgICAhc3RhcnRzV2l0aChjb250ZXh0LnNvdXJjZSwgJz4nKSAmJgogICAgICAgICAgIXN0YXJ0c1dpdGgoY29udGV4dC5zb3VyY2UsICcvPicpKSB7CiAgICAgICAgICBpZiAoc3RhcnRzV2l0aChjb250ZXh0LnNvdXJjZSwgJy8nKSkgewogICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAyMiAvKiBVTkVYUEVDVEVEX1NPTElEVVNfSU5fVEFHICovKTsKICAgICAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgMSk7CiAgICAgICAgICAgICAgYWR2YW5jZVNwYWNlcyhjb250ZXh0KTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSAxIC8qIEVuZCAqLykgewogICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAzIC8qIEVORF9UQUdfV0lUSF9BVFRSSUJVVEVTICovKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGF0dHIgPSBwYXJzZUF0dHJpYnV0ZShjb250ZXh0LCBhdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAvLyBUcmltIHdoaXRlc3BhY2UgYmV0d2VlbiBjbGFzcwogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL2NvcmUvaXNzdWVzLzQyNTEKICAgICAgICAgIGlmIChhdHRyLnR5cGUgPT09IDYgLyogQVRUUklCVVRFICovICYmCiAgICAgICAgICAgICAgYXR0ci52YWx1ZSAmJgogICAgICAgICAgICAgIGF0dHIubmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgICAgIGF0dHIudmFsdWUuY29udGVudCA9IGF0dHIudmFsdWUuY29udGVudC5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gMCAvKiBTdGFydCAqLykgewogICAgICAgICAgICAgIHByb3BzLnB1c2goYXR0cik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoL15bXlx0XHJcblxmIC8+XS8udGVzdChjb250ZXh0LnNvdXJjZSkpIHsKICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMTUgLyogTUlTU0lOR19XSElURVNQQUNFX0JFVFdFRU5fQVRUUklCVVRFUyAqLyk7CiAgICAgICAgICB9CiAgICAgICAgICBhZHZhbmNlU3BhY2VzKGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiBwcm9wczsKICB9CiAgZnVuY3Rpb24gcGFyc2VBdHRyaWJ1dGUoY29udGV4dCwgbmFtZVNldCkgewogICAgICAvLyBOYW1lLgogICAgICBjb25zdCBzdGFydCA9IGdldEN1cnNvcihjb250ZXh0KTsKICAgICAgY29uc3QgbWF0Y2ggPSAvXlteXHRcclxuXGYgLz5dW15cdFxyXG5cZiAvPj1dKi8uZXhlYyhjb250ZXh0LnNvdXJjZSk7CiAgICAgIGNvbnN0IG5hbWUgPSBtYXRjaFswXTsKICAgICAgaWYgKG5hbWVTZXQuaGFzKG5hbWUpKSB7CiAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMiAvKiBEVVBMSUNBVEVfQVRUUklCVVRFICovKTsKICAgICAgfQogICAgICBuYW1lU2V0LmFkZChuYW1lKTsKICAgICAgaWYgKG5hbWVbMF0gPT09ICc9JykgewogICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDE5IC8qIFVORVhQRUNURURfRVFVQUxTX1NJR05fQkVGT1JFX0FUVFJJQlVURV9OQU1FICovKTsKICAgICAgfQogICAgICB7CiAgICAgICAgICBjb25zdCBwYXR0ZXJuID0gL1siJzxdL2c7CiAgICAgICAgICBsZXQgbTsKICAgICAgICAgIHdoaWxlICgobSA9IHBhdHRlcm4uZXhlYyhuYW1lKSkpIHsKICAgICAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMTcgLyogVU5FWFBFQ1RFRF9DSEFSQUNURVJfSU5fQVRUUklCVVRFX05BTUUgKi8sIG0uaW5kZXgpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBuYW1lLmxlbmd0aCk7CiAgICAgIC8vIFZhbHVlCiAgICAgIGxldCB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgaWYgKC9eW1x0XHJcblxmIF0qPS8udGVzdChjb250ZXh0LnNvdXJjZSkpIHsKICAgICAgICAgIGFkdmFuY2VTcGFjZXMoY29udGV4dCk7CiAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgMSk7CiAgICAgICAgICBhZHZhbmNlU3BhY2VzKGNvbnRleHQpOwogICAgICAgICAgdmFsdWUgPSBwYXJzZUF0dHJpYnV0ZVZhbHVlKGNvbnRleHQpOwogICAgICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAxMyAvKiBNSVNTSU5HX0FUVFJJQlVURV9WQUxVRSAqLyk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgbG9jID0gZ2V0U2VsZWN0aW9uKGNvbnRleHQsIHN0YXJ0KTsKICAgICAgaWYgKCFjb250ZXh0LmluVlByZSAmJiAvXih2LVtBLVphLXowLTktXXw6fFwufEB8IykvLnRlc3QobmFtZSkpIHsKICAgICAgICAgIGNvbnN0IG1hdGNoID0gLyg/Ol52LShbYS16MC05LV0rKSk/KD86KD86OnxeXC58XkB8XiMpKFxbW15cXV0rXF18W15cLl0rKSk/KC4rKT8kL2kuZXhlYyhuYW1lKTsKICAgICAgICAgIGxldCBpc1Byb3BTaG9ydGhhbmQgPSBzdGFydHNXaXRoKG5hbWUsICcuJyk7CiAgICAgICAgICBsZXQgZGlyTmFtZSA9IG1hdGNoWzFdIHx8CiAgICAgICAgICAgICAgKGlzUHJvcFNob3J0aGFuZCB8fCBzdGFydHNXaXRoKG5hbWUsICc6JykKICAgICAgICAgICAgICAgICAgPyAnYmluZCcKICAgICAgICAgICAgICAgICAgOiBzdGFydHNXaXRoKG5hbWUsICdAJykKICAgICAgICAgICAgICAgICAgICAgID8gJ29uJwogICAgICAgICAgICAgICAgICAgICAgOiAnc2xvdCcpOwogICAgICAgICAgbGV0IGFyZzsKICAgICAgICAgIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICAgIGNvbnN0IGlzU2xvdCA9IGRpck5hbWUgPT09ICdzbG90JzsKICAgICAgICAgICAgICBjb25zdCBzdGFydE9mZnNldCA9IG5hbWUubGFzdEluZGV4T2YobWF0Y2hbMl0pOwogICAgICAgICAgICAgIGNvbnN0IGxvYyA9IGdldFNlbGVjdGlvbihjb250ZXh0LCBnZXROZXdQb3NpdGlvbihjb250ZXh0LCBzdGFydCwgc3RhcnRPZmZzZXQpLCBnZXROZXdQb3NpdGlvbihjb250ZXh0LCBzdGFydCwgc3RhcnRPZmZzZXQgKyBtYXRjaFsyXS5sZW5ndGggKyAoKGlzU2xvdCAmJiBtYXRjaFszXSkgfHwgJycpLmxlbmd0aCkpOwogICAgICAgICAgICAgIGxldCBjb250ZW50ID0gbWF0Y2hbMl07CiAgICAgICAgICAgICAgbGV0IGlzU3RhdGljID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoY29udGVudC5zdGFydHNXaXRoKCdbJykpIHsKICAgICAgICAgICAgICAgICAgaXNTdGF0aWMgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgaWYgKCFjb250ZW50LmVuZHNXaXRoKCddJykpIHsKICAgICAgICAgICAgICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAyNyAvKiBYX01JU1NJTkdfRFlOQU1JQ19ESVJFQ1RJVkVfQVJHVU1FTlRfRU5EICovKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnNsaWNlKDEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQuc2xpY2UoMSwgY29udGVudC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChpc1Nsb3QpIHsKICAgICAgICAgICAgICAgICAgLy8gIzEyNDEgc3BlY2lhbCBjYXNlIGZvciB2LXNsb3Q6IHZ1ZXRpZnkgcmVsaWVzIGV4dGVuc2l2ZWx5IG9uIHNsb3QKICAgICAgICAgICAgICAgICAgLy8gbmFtZXMgY29udGFpbmluZyBkb3RzLiB2LXNsb3QgZG9lc24ndCBoYXZlIGFueSBtb2RpZmllcnMgYW5kIFZ1ZSAyLngKICAgICAgICAgICAgICAgICAgLy8gc3VwcG9ydHMgc3VjaCB1c2FnZSBzbyB3ZSBhcmUga2VlcGluZyBpdCBjb25zaXN0ZW50IHdpdGggMi54LgogICAgICAgICAgICAgICAgICBjb250ZW50ICs9IG1hdGNoWzNdIHx8ICcnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcmcgPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8sCiAgICAgICAgICAgICAgICAgIGNvbnRlbnQsCiAgICAgICAgICAgICAgICAgIGlzU3RhdGljLAogICAgICAgICAgICAgICAgICBjb25zdFR5cGU6IGlzU3RhdGljCiAgICAgICAgICAgICAgICAgICAgICA/IDMgLyogQ0FOX1NUUklOR0lGWSAqLwogICAgICAgICAgICAgICAgICAgICAgOiAwIC8qIE5PVF9DT05TVEFOVCAqLywKICAgICAgICAgICAgICAgICAgbG9jCiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5pc1F1b3RlZCkgewogICAgICAgICAgICAgIGNvbnN0IHZhbHVlTG9jID0gdmFsdWUubG9jOwogICAgICAgICAgICAgIHZhbHVlTG9jLnN0YXJ0Lm9mZnNldCsrOwogICAgICAgICAgICAgIHZhbHVlTG9jLnN0YXJ0LmNvbHVtbisrOwogICAgICAgICAgICAgIHZhbHVlTG9jLmVuZCA9IGFkdmFuY2VQb3NpdGlvbldpdGhDbG9uZSh2YWx1ZUxvYy5zdGFydCwgdmFsdWUuY29udGVudCk7CiAgICAgICAgICAgICAgdmFsdWVMb2Muc291cmNlID0gdmFsdWVMb2Muc291cmNlLnNsaWNlKDEsIC0xKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG1vZGlmaWVycyA9IG1hdGNoWzNdID8gbWF0Y2hbM10uc2xpY2UoMSkuc3BsaXQoJy4nKSA6IFtdOwogICAgICAgICAgaWYgKGlzUHJvcFNob3J0aGFuZCkKICAgICAgICAgICAgICBtb2RpZmllcnMucHVzaCgncHJvcCcpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiA3IC8qIERJUkVDVElWRSAqLywKICAgICAgICAgICAgICBuYW1lOiBkaXJOYW1lLAogICAgICAgICAgICAgIGV4cDogdmFsdWUgJiYgewogICAgICAgICAgICAgICAgICB0eXBlOiA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovLAogICAgICAgICAgICAgICAgICBjb250ZW50OiB2YWx1ZS5jb250ZW50LAogICAgICAgICAgICAgICAgICBpc1N0YXRpYzogZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIFRyZWF0IGFzIG5vbi1jb25zdGFudCBieSBkZWZhdWx0LiBUaGlzIGNhbiBiZSBwb3RlbnRpYWxseSBzZXQgdG8KICAgICAgICAgICAgICAgICAgLy8gb3RoZXIgdmFsdWVzIGJ5IGB0cmFuc2Zvcm1FeHByZXNzaW9uYCB0byBtYWtlIGl0IGVsaWdpYmxlIGZvciBob2lzdGluZy4KICAgICAgICAgICAgICAgICAgY29uc3RUeXBlOiAwIC8qIE5PVF9DT05TVEFOVCAqLywKICAgICAgICAgICAgICAgICAgbG9jOiB2YWx1ZS5sb2MKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGFyZywKICAgICAgICAgICAgICBtb2RpZmllcnMsCiAgICAgICAgICAgICAgbG9jCiAgICAgICAgICB9OwogICAgICB9CiAgICAgIC8vIG1pc3NpbmcgZGlyZWN0aXZlIG5hbWUgb3IgaWxsZWdhbCBkaXJlY3RpdmUgbmFtZQogICAgICBpZiAoIWNvbnRleHQuaW5WUHJlICYmIHN0YXJ0c1dpdGgobmFtZSwgJ3YtJykpIHsKICAgICAgICAgIGVtaXRFcnJvcihjb250ZXh0LCAyNiAvKiBYX01JU1NJTkdfRElSRUNUSVZFX05BTUUgKi8pOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiA2IC8qIEFUVFJJQlVURSAqLywKICAgICAgICAgIG5hbWUsCiAgICAgICAgICB2YWx1ZTogdmFsdWUgJiYgewogICAgICAgICAgICAgIHR5cGU6IDIgLyogVEVYVCAqLywKICAgICAgICAgICAgICBjb250ZW50OiB2YWx1ZS5jb250ZW50LAogICAgICAgICAgICAgIGxvYzogdmFsdWUubG9jCiAgICAgICAgICB9LAogICAgICAgICAgbG9jCiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlQXR0cmlidXRlVmFsdWUoY29udGV4dCkgewogICAgICBjb25zdCBzdGFydCA9IGdldEN1cnNvcihjb250ZXh0KTsKICAgICAgbGV0IGNvbnRlbnQ7CiAgICAgIGNvbnN0IHF1b3RlID0gY29udGV4dC5zb3VyY2VbMF07CiAgICAgIGNvbnN0IGlzUXVvdGVkID0gcXVvdGUgPT09IGAiYCB8fCBxdW90ZSA9PT0gYCdgOwogICAgICBpZiAoaXNRdW90ZWQpIHsKICAgICAgICAgIC8vIFF1b3RlZCB2YWx1ZS4KICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCAxKTsKICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gY29udGV4dC5zb3VyY2UuaW5kZXhPZihxdW90ZSk7CiAgICAgICAgICBpZiAoZW5kSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgY29udGVudCA9IHBhcnNlVGV4dERhdGEoY29udGV4dCwgY29udGV4dC5zb3VyY2UubGVuZ3RoLCA0IC8qIEFUVFJJQlVURV9WQUxVRSAqLyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBjb250ZW50ID0gcGFyc2VUZXh0RGF0YShjb250ZXh0LCBlbmRJbmRleCwgNCAvKiBBVFRSSUJVVEVfVkFMVUUgKi8pOwogICAgICAgICAgICAgIGFkdmFuY2VCeShjb250ZXh0LCAxKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIFVucXVvdGVkCiAgICAgICAgICBjb25zdCBtYXRjaCA9IC9eW15cdFxyXG5cZiA+XSsvLmV4ZWMoY29udGV4dC5zb3VyY2UpOwogICAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB1bmV4cGVjdGVkQ2hhcnMgPSAvWyInPD1gXS9nOwogICAgICAgICAgbGV0IG07CiAgICAgICAgICB3aGlsZSAoKG0gPSB1bmV4cGVjdGVkQ2hhcnMuZXhlYyhtYXRjaFswXSkpKSB7CiAgICAgICAgICAgICAgZW1pdEVycm9yKGNvbnRleHQsIDE4IC8qIFVORVhQRUNURURfQ0hBUkFDVEVSX0lOX1VOUVVPVEVEX0FUVFJJQlVURV9WQUxVRSAqLywgbS5pbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZW50ID0gcGFyc2VUZXh0RGF0YShjb250ZXh0LCBtYXRjaFswXS5sZW5ndGgsIDQgLyogQVRUUklCVVRFX1ZBTFVFICovKTsKICAgICAgfQogICAgICByZXR1cm4geyBjb250ZW50LCBpc1F1b3RlZCwgbG9jOiBnZXRTZWxlY3Rpb24oY29udGV4dCwgc3RhcnQpIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlSW50ZXJwb2xhdGlvbihjb250ZXh0LCBtb2RlKSB7CiAgICAgIGNvbnN0IFtvcGVuLCBjbG9zZV0gPSBjb250ZXh0Lm9wdGlvbnMuZGVsaW1pdGVyczsKICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGNvbnRleHQuc291cmNlLmluZGV4T2YoY2xvc2UsIG9wZW4ubGVuZ3RoKTsKICAgICAgaWYgKGNsb3NlSW5kZXggPT09IC0xKSB7CiAgICAgICAgICBlbWl0RXJyb3IoY29udGV4dCwgMjUgLyogWF9NSVNTSU5HX0lOVEVSUE9MQVRJT05fRU5EICovKTsKICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgY29uc3Qgc3RhcnQgPSBnZXRDdXJzb3IoY29udGV4dCk7CiAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBvcGVuLmxlbmd0aCk7CiAgICAgIGNvbnN0IGlubmVyU3RhcnQgPSBnZXRDdXJzb3IoY29udGV4dCk7CiAgICAgIGNvbnN0IGlubmVyRW5kID0gZ2V0Q3Vyc29yKGNvbnRleHQpOwogICAgICBjb25zdCByYXdDb250ZW50TGVuZ3RoID0gY2xvc2VJbmRleCAtIG9wZW4ubGVuZ3RoOwogICAgICBjb25zdCByYXdDb250ZW50ID0gY29udGV4dC5zb3VyY2Uuc2xpY2UoMCwgcmF3Q29udGVudExlbmd0aCk7CiAgICAgIGNvbnN0IHByZVRyaW1Db250ZW50ID0gcGFyc2VUZXh0RGF0YShjb250ZXh0LCByYXdDb250ZW50TGVuZ3RoLCBtb2RlKTsKICAgICAgY29uc3QgY29udGVudCA9IHByZVRyaW1Db250ZW50LnRyaW0oKTsKICAgICAgY29uc3Qgc3RhcnRPZmZzZXQgPSBwcmVUcmltQ29udGVudC5pbmRleE9mKGNvbnRlbnQpOwogICAgICBpZiAoc3RhcnRPZmZzZXQgPiAwKSB7CiAgICAgICAgICBhZHZhbmNlUG9zaXRpb25XaXRoTXV0YXRpb24oaW5uZXJTdGFydCwgcmF3Q29udGVudCwgc3RhcnRPZmZzZXQpOwogICAgICB9CiAgICAgIGNvbnN0IGVuZE9mZnNldCA9IHJhd0NvbnRlbnRMZW5ndGggLSAocHJlVHJpbUNvbnRlbnQubGVuZ3RoIC0gY29udGVudC5sZW5ndGggLSBzdGFydE9mZnNldCk7CiAgICAgIGFkdmFuY2VQb3NpdGlvbldpdGhNdXRhdGlvbihpbm5lckVuZCwgcmF3Q29udGVudCwgZW5kT2Zmc2V0KTsKICAgICAgYWR2YW5jZUJ5KGNvbnRleHQsIGNsb3NlLmxlbmd0aCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiA1IC8qIElOVEVSUE9MQVRJT04gKi8sCiAgICAgICAgICBjb250ZW50OiB7CiAgICAgICAgICAgICAgdHlwZTogNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLywKICAgICAgICAgICAgICBpc1N0YXRpYzogZmFsc2UsCiAgICAgICAgICAgICAgLy8gU2V0IGBpc0NvbnN0YW50YCB0byBmYWxzZSBieSBkZWZhdWx0IGFuZCB3aWxsIGRlY2lkZSBpbiB0cmFuc2Zvcm1FeHByZXNzaW9uCiAgICAgICAgICAgICAgY29uc3RUeXBlOiAwIC8qIE5PVF9DT05TVEFOVCAqLywKICAgICAgICAgICAgICBjb250ZW50LAogICAgICAgICAgICAgIGxvYzogZ2V0U2VsZWN0aW9uKGNvbnRleHQsIGlubmVyU3RhcnQsIGlubmVyRW5kKQogICAgICAgICAgfSwKICAgICAgICAgIGxvYzogZ2V0U2VsZWN0aW9uKGNvbnRleHQsIHN0YXJ0KQogICAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVRleHQoY29udGV4dCwgbW9kZSkgewogICAgICBjb25zdCBlbmRUb2tlbnMgPSBtb2RlID09PSAzIC8qIENEQVRBICovID8gWyddXT4nXSA6IFsnPCcsIGNvbnRleHQub3B0aW9ucy5kZWxpbWl0ZXJzWzBdXTsKICAgICAgbGV0IGVuZEluZGV4ID0gY29udGV4dC5zb3VyY2UubGVuZ3RoOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVuZFRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaW5kZXggPSBjb250ZXh0LnNvdXJjZS5pbmRleE9mKGVuZFRva2Vuc1tpXSwgMSk7CiAgICAgICAgICBpZiAoaW5kZXggIT09IC0xICYmIGVuZEluZGV4ID4gaW5kZXgpIHsKICAgICAgICAgICAgICBlbmRJbmRleCA9IGluZGV4OwogICAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHN0YXJ0ID0gZ2V0Q3Vyc29yKGNvbnRleHQpOwogICAgICBjb25zdCBjb250ZW50ID0gcGFyc2VUZXh0RGF0YShjb250ZXh0LCBlbmRJbmRleCwgbW9kZSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAyIC8qIFRFWFQgKi8sCiAgICAgICAgICBjb250ZW50LAogICAgICAgICAgbG9jOiBnZXRTZWxlY3Rpb24oY29udGV4dCwgc3RhcnQpCiAgICAgIH07CiAgfQogIC8qKgogICAqIEdldCB0ZXh0IGRhdGEgd2l0aCBhIGdpdmVuIGxlbmd0aCBmcm9tIHRoZSBjdXJyZW50IGxvY2F0aW9uLgogICAqIFRoaXMgdHJhbnNsYXRlcyBIVE1MIGVudGl0aWVzIGluIHRoZSB0ZXh0IGRhdGEuCiAgICovCiAgZnVuY3Rpb24gcGFyc2VUZXh0RGF0YShjb250ZXh0LCBsZW5ndGgsIG1vZGUpIHsKICAgICAgY29uc3QgcmF3VGV4dCA9IGNvbnRleHQuc291cmNlLnNsaWNlKDAsIGxlbmd0aCk7CiAgICAgIGFkdmFuY2VCeShjb250ZXh0LCBsZW5ndGgpOwogICAgICBpZiAobW9kZSA9PT0gMiAvKiBSQVdURVhUICovIHx8CiAgICAgICAgICBtb2RlID09PSAzIC8qIENEQVRBICovIHx8CiAgICAgICAgICAhcmF3VGV4dC5pbmNsdWRlcygnJicpKSB7CiAgICAgICAgICByZXR1cm4gcmF3VGV4dDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIERBVEEgb3IgUkNEQVRBIGNvbnRhaW5pbmcgIiYiIi4gRW50aXR5IGRlY29kaW5nIHJlcXVpcmVkLgogICAgICAgICAgcmV0dXJuIGNvbnRleHQub3B0aW9ucy5kZWNvZGVFbnRpdGllcyhyYXdUZXh0LCBtb2RlID09PSA0IC8qIEFUVFJJQlVURV9WQUxVRSAqLyk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0Q3Vyc29yKGNvbnRleHQpIHsKICAgICAgY29uc3QgeyBjb2x1bW4sIGxpbmUsIG9mZnNldCB9ID0gY29udGV4dDsKICAgICAgcmV0dXJuIHsgY29sdW1uLCBsaW5lLCBvZmZzZXQgfTsKICB9CiAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGNvbnRleHQsIHN0YXJ0LCBlbmQpIHsKICAgICAgZW5kID0gZW5kIHx8IGdldEN1cnNvcihjb250ZXh0KTsKICAgICAgcmV0dXJuIHsKICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgZW5kLAogICAgICAgICAgc291cmNlOiBjb250ZXh0Lm9yaWdpbmFsU291cmNlLnNsaWNlKHN0YXJ0Lm9mZnNldCwgZW5kLm9mZnNldCkKICAgICAgfTsKICB9CiAgZnVuY3Rpb24gbGFzdCh4cykgewogICAgICByZXR1cm4geHNbeHMubGVuZ3RoIC0gMV07CiAgfQogIGZ1bmN0aW9uIHN0YXJ0c1dpdGgoc291cmNlLCBzZWFyY2hTdHJpbmcpIHsKICAgICAgcmV0dXJuIHNvdXJjZS5zdGFydHNXaXRoKHNlYXJjaFN0cmluZyk7CiAgfQogIGZ1bmN0aW9uIGFkdmFuY2VCeShjb250ZXh0LCBudW1iZXJPZkNoYXJhY3RlcnMpIHsKICAgICAgY29uc3QgeyBzb3VyY2UgfSA9IGNvbnRleHQ7CiAgICAgIGFkdmFuY2VQb3NpdGlvbldpdGhNdXRhdGlvbihjb250ZXh0LCBzb3VyY2UsIG51bWJlck9mQ2hhcmFjdGVycyk7CiAgICAgIGNvbnRleHQuc291cmNlID0gc291cmNlLnNsaWNlKG51bWJlck9mQ2hhcmFjdGVycyk7CiAgfQogIGZ1bmN0aW9uIGFkdmFuY2VTcGFjZXMoY29udGV4dCkgewogICAgICBjb25zdCBtYXRjaCA9IC9eW1x0XHJcblxmIF0rLy5leGVjKGNvbnRleHQuc291cmNlKTsKICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICBhZHZhbmNlQnkoY29udGV4dCwgbWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBnZXROZXdQb3NpdGlvbihjb250ZXh0LCBzdGFydCwgbnVtYmVyT2ZDaGFyYWN0ZXJzKSB7CiAgICAgIHJldHVybiBhZHZhbmNlUG9zaXRpb25XaXRoQ2xvbmUoc3RhcnQsIGNvbnRleHQub3JpZ2luYWxTb3VyY2Uuc2xpY2Uoc3RhcnQub2Zmc2V0LCBudW1iZXJPZkNoYXJhY3RlcnMpLCBudW1iZXJPZkNoYXJhY3RlcnMpOwogIH0KICBmdW5jdGlvbiBlbWl0RXJyb3IoY29udGV4dCwgY29kZSwgb2Zmc2V0LCBsb2MgPSBnZXRDdXJzb3IoY29udGV4dCkpIHsKICAgICAgaWYgKG9mZnNldCkgewogICAgICAgICAgbG9jLm9mZnNldCArPSBvZmZzZXQ7CiAgICAgICAgICBsb2MuY29sdW1uICs9IG9mZnNldDsKICAgICAgfQogICAgICBjb250ZXh0Lm9wdGlvbnMub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKGNvZGUsIHsKICAgICAgICAgIHN0YXJ0OiBsb2MsCiAgICAgICAgICBlbmQ6IGxvYywKICAgICAgICAgIHNvdXJjZTogJycKICAgICAgfSkpOwogIH0KICBmdW5jdGlvbiBpc0VuZChjb250ZXh0LCBtb2RlLCBhbmNlc3RvcnMpIHsKICAgICAgY29uc3QgcyA9IGNvbnRleHQuc291cmNlOwogICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgIGNhc2UgMCAvKiBEQVRBICovOgogICAgICAgICAgICAgIGlmIChzdGFydHNXaXRoKHMsICc8LycpKSB7CiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IHByb2JhYmx5IGJhZCBwZXJmb3JtYW5jZQogICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gYW5jZXN0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRzV2l0aEVuZFRhZ09wZW4ocywgYW5jZXN0b3JzW2ldLnRhZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMSAvKiBSQ0RBVEEgKi86CiAgICAgICAgICBjYXNlIDIgLyogUkFXVEVYVCAqLzogewogICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IGxhc3QoYW5jZXN0b3JzKTsKICAgICAgICAgICAgICBpZiAocGFyZW50ICYmIHN0YXJ0c1dpdGhFbmRUYWdPcGVuKHMsIHBhcmVudC50YWcpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMyAvKiBDREFUQSAqLzoKICAgICAgICAgICAgICBpZiAoc3RhcnRzV2l0aChzLCAnXV0+JykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiAhczsKICB9CiAgZnVuY3Rpb24gc3RhcnRzV2l0aEVuZFRhZ09wZW4oc291cmNlLCB0YWcpIHsKICAgICAgcmV0dXJuIChzdGFydHNXaXRoKHNvdXJjZSwgJzwvJykgJiYKICAgICAgICAgIHNvdXJjZS5zbGljZSgyLCAyICsgdGFnLmxlbmd0aCkudG9Mb3dlckNhc2UoKSA9PT0gdGFnLnRvTG93ZXJDYXNlKCkgJiYKICAgICAgICAgIC9bXHRcclxuXGYgLz5dLy50ZXN0KHNvdXJjZVsyICsgdGFnLmxlbmd0aF0gfHwgJz4nKSk7CiAgfQoKICBmdW5jdGlvbiBob2lzdFN0YXRpYyhyb290LCBjb250ZXh0KSB7CiAgICAgIHdhbGsocm9vdCwgY29udGV4dCwgCiAgICAgIC8vIFJvb3Qgbm9kZSBpcyB1bmZvcnR1bmF0ZWx5IG5vbi1ob2lzdGFibGUgZHVlIHRvIHBvdGVudGlhbCBwYXJlbnQKICAgICAgLy8gZmFsbHRocm91Z2ggYXR0cmlidXRlcy4KICAgICAgaXNTaW5nbGVFbGVtZW50Um9vdChyb290LCByb290LmNoaWxkcmVuWzBdKSk7CiAgfQogIGZ1bmN0aW9uIGlzU2luZ2xlRWxlbWVudFJvb3Qocm9vdCwgY2hpbGQpIHsKICAgICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gcm9vdDsKICAgICAgcmV0dXJuIChjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYKICAgICAgICAgIGNoaWxkLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgIWlzU2xvdE91dGxldChjaGlsZCkpOwogIH0KICBmdW5jdGlvbiB3YWxrKG5vZGUsIGNvbnRleHQsIGRvTm90SG9pc3ROb2RlID0gZmFsc2UpIHsKICAgICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gbm9kZTsKICAgICAgY29uc3Qgb3JpZ2luYWxDb3VudCA9IGNoaWxkcmVuLmxlbmd0aDsKICAgICAgbGV0IGhvaXN0ZWRDb3VudCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAvLyBvbmx5IHBsYWluIGVsZW1lbnRzICYgdGV4dCBjYWxscyBhcmUgZWxpZ2libGUgZm9yIGhvaXN0aW5nLgogICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgICAgIGNoaWxkLnRhZ1R5cGUgPT09IDAgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgIGNvbnN0IGNvbnN0YW50VHlwZSA9IGRvTm90SG9pc3ROb2RlCiAgICAgICAgICAgICAgICAgID8gMCAvKiBOT1RfQ09OU1RBTlQgKi8KICAgICAgICAgICAgICAgICAgOiBnZXRDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpOwogICAgICAgICAgICAgIGlmIChjb25zdGFudFR5cGUgPiAwIC8qIE5PVF9DT05TVEFOVCAqLykgewogICAgICAgICAgICAgICAgICBpZiAoY29uc3RhbnRUeXBlID49IDIgLyogQ0FOX0hPSVNUICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5jb2RlZ2VuTm9kZS5wYXRjaEZsYWcgPQogICAgICAgICAgICAgICAgICAgICAgICAgIC0xIC8qIEhPSVNURUQgKi8gKyAoYCAvKiBIT0lTVEVEICovYCApOwogICAgICAgICAgICAgICAgICAgICAgY2hpbGQuY29kZWdlbk5vZGUgPSBjb250ZXh0LmhvaXN0KGNoaWxkLmNvZGVnZW5Ob2RlKTsKICAgICAgICAgICAgICAgICAgICAgIGhvaXN0ZWRDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIG5vZGUgbWF5IGNvbnRhaW4gZHluYW1pYyBjaGlsZHJlbiwgYnV0IGl0cyBwcm9wcyBtYXkgYmUgZWxpZ2libGUgZm9yCiAgICAgICAgICAgICAgICAgIC8vIGhvaXN0aW5nLgogICAgICAgICAgICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IGNoaWxkLmNvZGVnZW5Ob2RlOwogICAgICAgICAgICAgICAgICBpZiAoY29kZWdlbk5vZGUudHlwZSA9PT0gMTMgLyogVk5PREVfQ0FMTCAqLykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmxhZyA9IGdldFBhdGNoRmxhZyhjb2RlZ2VuTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKCFmbGFnIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhZyA9PT0gNTEyIC8qIE5FRURfUEFUQ0ggKi8gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFnID09PSAxIC8qIFRFWFQgKi8pICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0R2VuZXJhdGVkUHJvcHNDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpID49CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgLyogQ0FOX0hPSVNUICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcHMgPSBnZXROb2RlUHJvcHMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlZ2VuTm9kZS5wcm9wcyA9IGNvbnRleHQuaG9pc3QocHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2RlZ2VuTm9kZS5keW5hbWljUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlZ2VuTm9kZS5keW5hbWljUHJvcHMgPSBjb250ZXh0LmhvaXN0KGNvZGVnZW5Ob2RlLmR5bmFtaWNQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChjaGlsZC50eXBlID09PSAxMiAvKiBURVhUX0NBTEwgKi8gJiYKICAgICAgICAgICAgICBnZXRDb25zdGFudFR5cGUoY2hpbGQuY29udGVudCwgY29udGV4dCkgPj0gMiAvKiBDQU5fSE9JU1QgKi8pIHsKICAgICAgICAgICAgICBjaGlsZC5jb2RlZ2VuTm9kZSA9IGNvbnRleHQuaG9pc3QoY2hpbGQuY29kZWdlbk5vZGUpOwogICAgICAgICAgICAgIGhvaXN0ZWRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgICAgLy8gd2FsayBmdXJ0aGVyCiAgICAgICAgICBpZiAoY2hpbGQudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovKSB7CiAgICAgICAgICAgICAgY29uc3QgaXNDb21wb25lbnQgPSBjaGlsZC50YWdUeXBlID09PSAxIC8qIENPTVBPTkVOVCAqLzsKICAgICAgICAgICAgICBpZiAoaXNDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5zY29wZXMudlNsb3QrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FsayhjaGlsZCwgY29udGV4dCk7CiAgICAgICAgICAgICAgaWYgKGlzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuc2NvcGVzLnZTbG90LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoY2hpbGQudHlwZSA9PT0gMTEgLyogRk9SICovKSB7CiAgICAgICAgICAgICAgLy8gRG8gbm90IGhvaXN0IHYtZm9yIHNpbmdsZSBjaGlsZCBiZWNhdXNlIGl0IGhhcyB0byBiZSBhIGJsb2NrCiAgICAgICAgICAgICAgd2FsayhjaGlsZCwgY29udGV4dCwgY2hpbGQuY2hpbGRyZW4ubGVuZ3RoID09PSAxKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGNoaWxkLnR5cGUgPT09IDkgLyogSUYgKi8pIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkLmJyYW5jaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIC8vIERvIG5vdCBob2lzdCB2LWlmIHNpbmdsZSBjaGlsZCBiZWNhdXNlIGl0IGhhcyB0byBiZSBhIGJsb2NrCiAgICAgICAgICAgICAgICAgIHdhbGsoY2hpbGQuYnJhbmNoZXNbaV0sIGNvbnRleHQsIGNoaWxkLmJyYW5jaGVzW2ldLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChob2lzdGVkQ291bnQgJiYgY29udGV4dC50cmFuc2Zvcm1Ib2lzdCkgewogICAgICAgICAgY29udGV4dC50cmFuc2Zvcm1Ib2lzdChjaGlsZHJlbiwgY29udGV4dCwgbm9kZSk7CiAgICAgIH0KICAgICAgLy8gYWxsIGNoaWxkcmVuIHdlcmUgaG9pc3RlZCAtIHRoZSBlbnRpcmUgY2hpbGRyZW4gYXJyYXkgaXMgaG9pc3RhYmxlLgogICAgICBpZiAoaG9pc3RlZENvdW50ICYmCiAgICAgICAgICBob2lzdGVkQ291bnQgPT09IG9yaWdpbmFsQ291bnQgJiYKICAgICAgICAgIG5vZGUudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmCiAgICAgICAgICBub2RlLnRhZ1R5cGUgPT09IDAgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZSAmJgogICAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZS50eXBlID09PSAxMyAvKiBWTk9ERV9DQUxMICovICYmCiAgICAgICAgICBpc0FycmF5KG5vZGUuY29kZWdlbk5vZGUuY2hpbGRyZW4pKSB7CiAgICAgICAgICBub2RlLmNvZGVnZW5Ob2RlLmNoaWxkcmVuID0gY29udGV4dC5ob2lzdChjcmVhdGVBcnJheUV4cHJlc3Npb24obm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbikpOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdldENvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgY29uc3RhbnRDYWNoZSB9ID0gY29udGV4dDsKICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHsKICAgICAgICAgIGNhc2UgMSAvKiBFTEVNRU5UICovOgogICAgICAgICAgICAgIGlmIChub2RlLnRhZ1R5cGUgIT09IDAgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgICAgICByZXR1cm4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGNhY2hlZCA9IGNvbnN0YW50Q2FjaGUuZ2V0KG5vZGUpOwogICAgICAgICAgICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IG5vZGUuY29kZWdlbk5vZGU7CiAgICAgICAgICAgICAgaWYgKGNvZGVnZW5Ob2RlLnR5cGUgIT09IDEzIC8qIFZOT0RFX0NBTEwgKi8pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIDAgLyogTk9UX0NPTlNUQU5UICovOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY29kZWdlbk5vZGUuaXNCbG9jayAmJgogICAgICAgICAgICAgICAgICBub2RlLnRhZyAhPT0gJ3N2ZycgJiYKICAgICAgICAgICAgICAgICAgbm9kZS50YWcgIT09ICdmb3JlaWduT2JqZWN0JykgewogICAgICAgICAgICAgICAgICByZXR1cm4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGZsYWcgPSBnZXRQYXRjaEZsYWcoY29kZWdlbk5vZGUpOwogICAgICAgICAgICAgIGlmICghZmxhZykgewogICAgICAgICAgICAgICAgICBsZXQgcmV0dXJuVHlwZSA9IDMgLyogQ0FOX1NUUklOR0lGWSAqLzsKICAgICAgICAgICAgICAgICAgLy8gRWxlbWVudCBpdHNlbGYgaGFzIG5vIHBhdGNoIGZsYWcuIEhvd2V2ZXIgd2Ugc3RpbGwgbmVlZCB0byBjaGVjazoKICAgICAgICAgICAgICAgICAgLy8gMS4gRXZlbiBmb3IgYSBub2RlIHdpdGggbm8gcGF0Y2ggZmxhZywgaXQgaXMgcG9zc2libGUgZm9yIGl0IHRvIGNvbnRhaW4KICAgICAgICAgICAgICAgICAgLy8gbm9uLWhvaXN0YWJsZSBleHByZXNzaW9ucyB0aGF0IHJlZmVycyB0byBzY29wZSB2YXJpYWJsZXMsIGUuZy4gY29tcGlsZXIKICAgICAgICAgICAgICAgICAgLy8gaW5qZWN0ZWQga2V5cyBvciBjYWNoZWQgZXZlbnQgaGFuZGxlcnMuIFRoZXJlZm9yZSB3ZSBuZWVkIHRvIGFsd2F5cwogICAgICAgICAgICAgICAgICAvLyBjaGVjayB0aGUgY29kZWdlbk5vZGUncyBwcm9wcyB0byBiZSBzdXJlLgogICAgICAgICAgICAgICAgICBjb25zdCBnZW5lcmF0ZWRQcm9wc1R5cGUgPSBnZXRHZW5lcmF0ZWRQcm9wc0NvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgaWYgKGdlbmVyYXRlZFByb3BzVHlwZSA9PT0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIDAgLyogTk9UX0NPTlNUQU5UICovKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwIC8qIE5PVF9DT05TVEFOVCAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZ2VuZXJhdGVkUHJvcHNUeXBlIDwgcmV0dXJuVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IGdlbmVyYXRlZFByb3BzVHlwZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyAyLiBpdHMgY2hpbGRyZW4uCiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGRUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKG5vZGUuY2hpbGRyZW5baV0sIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkVHlwZSA9PT0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwIC8qIE5PVF9DT05TVEFOVCAqLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAgLyogTk9UX0NPTlNUQU5UICovOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkVHlwZSA8IHJldHVyblR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gY2hpbGRUeXBlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIDMuIGlmIHRoZSB0eXBlIGlzIG5vdCBhbHJlYWR5IENBTl9TS0lQX1BBVENIIHdoaWNoIGlzIHRoZSBsb3dlc3Qgbm9uLTAKICAgICAgICAgICAgICAgICAgLy8gdHlwZSwgY2hlY2sgaWYgYW55IG9mIHRoZSBwcm9wcyBjYW4gY2F1c2UgdGhlIHR5cGUgdG8gYmUgbG93ZXJlZAogICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4gc2tpcCBjYW5fcGF0Y2ggYmVjYXVzZSBpdCdzIGd1YXJhbnRlZWQgYnkgdGhlIGFic2VuY2Ugb2YgYQogICAgICAgICAgICAgICAgICAvLyBwYXRjaEZsYWcuCiAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5UeXBlID4gMSAvKiBDQU5fU0tJUF9QQVRDSCAqLykgewogICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IG5vZGUucHJvcHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PT0gNyAvKiBESVJFQ1RJVkUgKi8gJiYgcC5uYW1lID09PSAnYmluZCcgJiYgcC5leHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwVHlwZSA9IGdldENvbnN0YW50VHlwZShwLmV4cCwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleHBUeXBlID09PSAwIC8qIE5PVF9DT05TVEFOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3RhbnRDYWNoZS5zZXQobm9kZSwgMCAvKiBOT1RfQ09OU1RBTlQgKi8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAgLyogTk9UX0NPTlNUQU5UICovOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleHBUeXBlIDwgcmV0dXJuVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IGV4cFR5cGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gb25seSBzdmcvZm9yZWlnbk9iamVjdCBjb3VsZCBiZSBibG9jayBoZXJlLCBob3dldmVyIGlmIHRoZXkgYXJlCiAgICAgICAgICAgICAgICAgIC8vIHN0YXRpYyB0aGVuIHRoZXkgZG9uJ3QgbmVlZCB0byBiZSBibG9ja3Mgc2luY2UgdGhlcmUgd2lsbCBiZSBubwogICAgICAgICAgICAgICAgICAvLyBuZXN0ZWQgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgaWYgKGNvZGVnZW5Ob2RlLmlzQmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VwdCBzZXQgY3VzdG9tIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUucHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC50eXBlID09PSA3IC8qIERJUkVDVElWRSAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwIC8qIE5PVF9DT05TVEFOVCAqLyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwIC8qIE5PVF9DT05TVEFOVCAqLzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnJlbW92ZUhlbHBlcihPUEVOX0JMT0NLKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlSGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgY29kZWdlbk5vZGUuaXNDb21wb25lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgIGNvZGVnZW5Ob2RlLmlzQmxvY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlSGVscGVyKGNvbnRleHQuaW5TU1IsIGNvZGVnZW5Ob2RlLmlzQ29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3RhbnRDYWNoZS5zZXQobm9kZSwgcmV0dXJuVHlwZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5UeXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29uc3RhbnRDYWNoZS5zZXQobm9kZSwgMCAvKiBOT1RfQ09OU1RBTlQgKi8pOwogICAgICAgICAgICAgICAgICByZXR1cm4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgY2FzZSAyIC8qIFRFWFQgKi86CiAgICAgICAgICBjYXNlIDMgLyogQ09NTUVOVCAqLzoKICAgICAgICAgICAgICByZXR1cm4gMyAvKiBDQU5fU1RSSU5HSUZZICovOwogICAgICAgICAgY2FzZSA5IC8qIElGICovOgogICAgICAgICAgY2FzZSAxMSAvKiBGT1IgKi86CiAgICAgICAgICBjYXNlIDEwIC8qIElGX0JSQU5DSCAqLzoKICAgICAgICAgICAgICByZXR1cm4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgICAgICBjYXNlIDUgLyogSU5URVJQT0xBVElPTiAqLzoKICAgICAgICAgIGNhc2UgMTIgLyogVEVYVF9DQUxMICovOgogICAgICAgICAgICAgIHJldHVybiBnZXRDb25zdGFudFR5cGUobm9kZS5jb250ZW50LCBjb250ZXh0KTsKICAgICAgICAgIGNhc2UgNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLzoKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5jb25zdFR5cGU7CiAgICAgICAgICBjYXNlIDggLyogQ09NUE9VTkRfRVhQUkVTU0lPTiAqLzoKICAgICAgICAgICAgICBsZXQgcmV0dXJuVHlwZSA9IDMgLyogQ0FOX1NUUklOR0lGWSAqLzsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2hpbGQpIHx8IGlzU3ltYm9sKGNoaWxkKSkgewogICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGRUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkVHlwZSA9PT0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwIC8qIE5PVF9DT05TVEFOVCAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGlsZFR5cGUgPCByZXR1cm5UeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gY2hpbGRUeXBlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXR1cm5UeXBlOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgIH0KICB9CiAgY29uc3QgYWxsb3dIb2lzdGVkSGVscGVyU2V0ID0gbmV3IFNldChbCiAgICAgIE5PUk1BTElaRV9DTEFTUywKICAgICAgTk9STUFMSVpFX1NUWUxFLAogICAgICBOT1JNQUxJWkVfUFJPUFMsCiAgICAgIEdVQVJEX1JFQUNUSVZFX1BST1BTCiAgXSk7CiAgZnVuY3Rpb24gZ2V0Q29uc3RhbnRUeXBlT2ZIZWxwZXJDYWxsKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh2YWx1ZS50eXBlID09PSAxNCAvKiBKU19DQUxMX0VYUFJFU1NJT04gKi8gJiYKICAgICAgICAgICFpc1N0cmluZyh2YWx1ZS5jYWxsZWUpICYmCiAgICAgICAgICBhbGxvd0hvaXN0ZWRIZWxwZXJTZXQuaGFzKHZhbHVlLmNhbGxlZSkpIHsKICAgICAgICAgIGNvbnN0IGFyZyA9IHZhbHVlLmFyZ3VtZW50c1swXTsKICAgICAgICAgIGlmIChhcmcudHlwZSA9PT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgIHJldHVybiBnZXRDb25zdGFudFR5cGUoYXJnLCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKGFyZy50eXBlID09PSAxNCAvKiBKU19DQUxMX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSBvZiBuZXN0ZWQgaGVscGVyIGNhbGwsIGUuZy4gYG5vcm1hbGl6ZVByb3BzKGd1YXJkUmVhY3RpdmVQcm9wcyhleHApKWAKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29uc3RhbnRUeXBlT2ZIZWxwZXJDYWxsKGFyZywgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIDAgLyogTk9UX0NPTlNUQU5UICovOwogIH0KICBmdW5jdGlvbiBnZXRHZW5lcmF0ZWRQcm9wc0NvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7CiAgICAgIGxldCByZXR1cm5UeXBlID0gMyAvKiBDQU5fU1RSSU5HSUZZICovOwogICAgICBjb25zdCBwcm9wcyA9IGdldE5vZGVQcm9wcyhub2RlKTsKICAgICAgaWYgKHByb3BzICYmIHByb3BzLnR5cGUgPT09IDE1IC8qIEpTX09CSkVDVF9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICBjb25zdCB7IHByb3BlcnRpZXMgfSA9IHByb3BzOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgeyBrZXksIHZhbHVlIH0gPSBwcm9wZXJ0aWVzW2ldOwogICAgICAgICAgICAgIGNvbnN0IGtleVR5cGUgPSBnZXRDb25zdGFudFR5cGUoa2V5LCBjb250ZXh0KTsKICAgICAgICAgICAgICBpZiAoa2V5VHlwZSA9PT0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleVR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChrZXlUeXBlIDwgcmV0dXJuVHlwZSkgewogICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0ga2V5VHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGV0IHZhbHVlVHlwZTsKICAgICAgICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgICAgICB2YWx1ZVR5cGUgPSBnZXRDb25zdGFudFR5cGUodmFsdWUsIGNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS50eXBlID09PSAxNCAvKiBKU19DQUxMX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgICAgICAgICAgLy8gc29tZSBoZWxwZXIgY2FsbHMgY2FuIGJlIGhvaXN0ZWQsCiAgICAgICAgICAgICAgICAgIC8vIHN1Y2ggYXMgdGhlIGBub3JtYWxpemVQcm9wc2AgZ2VuZXJhdGVkIGJ5IHRoZSBjb21waWxlciBmb3IgcHJlLW5vcm1hbGl6ZSBjbGFzcywKICAgICAgICAgICAgICAgICAgLy8gaW4gdGhpcyBjYXNlIHdlIG5lZWQgdG8gcmVzcGVjdCB0aGUgQ29uc3RhbnRUeXBlIG9mIHRoZSBoZWxwZXIncyBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgdmFsdWVUeXBlID0gZ2V0Q29uc3RhbnRUeXBlT2ZIZWxwZXJDYWxsKHZhbHVlLCBjb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlVHlwZSA9IDAgLyogTk9UX0NPTlNUQU5UICovOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWVUeXBlID09PSAwIC8qIE5PVF9DT05TVEFOVCAqLykgewogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWVUeXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmFsdWVUeXBlIDwgcmV0dXJuVHlwZSkgewogICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gdmFsdWVUeXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0dXJuVHlwZTsKICB9CiAgZnVuY3Rpb24gZ2V0Tm9kZVByb3BzKG5vZGUpIHsKICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBub2RlLmNvZGVnZW5Ob2RlOwogICAgICBpZiAoY29kZWdlbk5vZGUudHlwZSA9PT0gMTMgLyogVk5PREVfQ0FMTCAqLykgewogICAgICAgICAgcmV0dXJuIGNvZGVnZW5Ob2RlLnByb3BzOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFBhdGNoRmxhZyhub2RlKSB7CiAgICAgIGNvbnN0IGZsYWcgPSBub2RlLnBhdGNoRmxhZzsKICAgICAgcmV0dXJuIGZsYWcgPyBwYXJzZUludChmbGFnLCAxMCkgOiB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVUcmFuc2Zvcm1Db250ZXh0KHJvb3QsIHsgZmlsZW5hbWUgPSAnJywgcHJlZml4SWRlbnRpZmllcnMgPSBmYWxzZSwgaG9pc3RTdGF0aWMgPSBmYWxzZSwgY2FjaGVIYW5kbGVycyA9IGZhbHNlLCBub2RlVHJhbnNmb3JtcyA9IFtdLCBkaXJlY3RpdmVUcmFuc2Zvcm1zID0ge30sIHRyYW5zZm9ybUhvaXN0ID0gbnVsbCwgaXNCdWlsdEluQ29tcG9uZW50ID0gTk9PUCwgaXNDdXN0b21FbGVtZW50ID0gTk9PUCwgZXhwcmVzc2lvblBsdWdpbnMgPSBbXSwgc2NvcGVJZCA9IG51bGwsIHNsb3R0ZWQgPSB0cnVlLCBzc3IgPSBmYWxzZSwgaW5TU1IgPSBmYWxzZSwgc3NyQ3NzVmFycyA9IGBgLCBiaW5kaW5nTWV0YWRhdGEgPSBFTVBUWV9PQkosIGlubGluZSA9IGZhbHNlLCBpc1RTID0gZmFsc2UsIG9uRXJyb3IgPSBkZWZhdWx0T25FcnJvciwgb25XYXJuID0gZGVmYXVsdE9uV2FybiwgY29tcGF0Q29uZmlnIH0pIHsKICAgICAgY29uc3QgbmFtZU1hdGNoID0gZmlsZW5hbWUucmVwbGFjZSgvXD8uKiQvLCAnJykubWF0Y2goLyhbXi9cXF0rKVwuXHcrJC8pOwogICAgICBjb25zdCBjb250ZXh0ID0gewogICAgICAgICAgLy8gb3B0aW9ucwogICAgICAgICAgc2VsZk5hbWU6IG5hbWVNYXRjaCAmJiBjYXBpdGFsaXplKGNhbWVsaXplKG5hbWVNYXRjaFsxXSkpLAogICAgICAgICAgcHJlZml4SWRlbnRpZmllcnMsCiAgICAgICAgICBob2lzdFN0YXRpYywKICAgICAgICAgIGNhY2hlSGFuZGxlcnMsCiAgICAgICAgICBub2RlVHJhbnNmb3JtcywKICAgICAgICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXMsCiAgICAgICAgICB0cmFuc2Zvcm1Ib2lzdCwKICAgICAgICAgIGlzQnVpbHRJbkNvbXBvbmVudCwKICAgICAgICAgIGlzQ3VzdG9tRWxlbWVudCwKICAgICAgICAgIGV4cHJlc3Npb25QbHVnaW5zLAogICAgICAgICAgc2NvcGVJZCwKICAgICAgICAgIHNsb3R0ZWQsCiAgICAgICAgICBzc3IsCiAgICAgICAgICBpblNTUiwKICAgICAgICAgIHNzckNzc1ZhcnMsCiAgICAgICAgICBiaW5kaW5nTWV0YWRhdGEsCiAgICAgICAgICBpbmxpbmUsCiAgICAgICAgICBpc1RTLAogICAgICAgICAgb25FcnJvciwKICAgICAgICAgIG9uV2FybiwKICAgICAgICAgIGNvbXBhdENvbmZpZywKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICByb290LAogICAgICAgICAgaGVscGVyczogbmV3IE1hcCgpLAogICAgICAgICAgY29tcG9uZW50czogbmV3IFNldCgpLAogICAgICAgICAgZGlyZWN0aXZlczogbmV3IFNldCgpLAogICAgICAgICAgaG9pc3RzOiBbXSwKICAgICAgICAgIGltcG9ydHM6IFtdLAogICAgICAgICAgY29uc3RhbnRDYWNoZTogbmV3IE1hcCgpLAogICAgICAgICAgdGVtcHM6IDAsCiAgICAgICAgICBjYWNoZWQ6IDAsCiAgICAgICAgICBpZGVudGlmaWVyczogT2JqZWN0LmNyZWF0ZShudWxsKSwKICAgICAgICAgIHNjb3BlczogewogICAgICAgICAgICAgIHZGb3I6IDAsCiAgICAgICAgICAgICAgdlNsb3Q6IDAsCiAgICAgICAgICAgICAgdlByZTogMCwKICAgICAgICAgICAgICB2T25jZTogMAogICAgICAgICAgfSwKICAgICAgICAgIHBhcmVudDogbnVsbCwKICAgICAgICAgIGN1cnJlbnROb2RlOiByb290LAogICAgICAgICAgY2hpbGRJbmRleDogMCwKICAgICAgICAgIGluVk9uY2U6IGZhbHNlLAogICAgICAgICAgLy8gbWV0aG9kcwogICAgICAgICAgaGVscGVyKG5hbWUpIHsKICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IGNvbnRleHQuaGVscGVycy5nZXQobmFtZSkgfHwgMDsKICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcnMuc2V0KG5hbWUsIGNvdW50ICsgMSk7CiAgICAgICAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlSGVscGVyKG5hbWUpIHsKICAgICAgICAgICAgICBjb25zdCBjb3VudCA9IGNvbnRleHQuaGVscGVycy5nZXQobmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDb3VudCA9IGNvdW50IC0gMTsKICAgICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50Q291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuaGVscGVycy5kZWxldGUobmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcnMuc2V0KG5hbWUsIGN1cnJlbnRDb3VudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgaGVscGVyU3RyaW5nKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gYF8ke2hlbHBlck5hbWVNYXBbY29udGV4dC5oZWxwZXIobmFtZSldfWA7CiAgICAgICAgICB9LAogICAgICAgICAgcmVwbGFjZU5vZGUobm9kZSkgewogICAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFjb250ZXh0LmN1cnJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vZGUgYmVpbmcgcmVwbGFjZWQgaXMgYWxyZWFkeSByZW1vdmVkLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghY29udGV4dC5wYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlcGxhY2Ugcm9vdCBub2RlLmApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRleHQucGFyZW50LmNoaWxkcmVuW2NvbnRleHQuY2hpbGRJbmRleF0gPSBjb250ZXh0LmN1cnJlbnROb2RlID0gbm9kZTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVOb2RlKG5vZGUpIHsKICAgICAgICAgICAgICBpZiAoIWNvbnRleHQucGFyZW50KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlbW92ZSByb290IG5vZGUuYCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBjb250ZXh0LnBhcmVudC5jaGlsZHJlbjsKICAgICAgICAgICAgICBjb25zdCByZW1vdmFsSW5kZXggPSBub2RlCiAgICAgICAgICAgICAgICAgID8gbGlzdC5pbmRleE9mKG5vZGUpCiAgICAgICAgICAgICAgICAgIDogY29udGV4dC5jdXJyZW50Tm9kZQogICAgICAgICAgICAgICAgICAgICAgPyBjb250ZXh0LmNoaWxkSW5kZXgKICAgICAgICAgICAgICAgICAgICAgIDogLTE7CiAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgaWYgKHJlbW92YWxJbmRleCA8IDApIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub2RlIGJlaW5nIHJlbW92ZWQgaXMgbm90IGEgY2hpbGQgb2YgY3VycmVudCBwYXJlbnRgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFub2RlIHx8IG5vZGUgPT09IGNvbnRleHQuY3VycmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBub2RlIHJlbW92ZWQKICAgICAgICAgICAgICAgICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQub25Ob2RlUmVtb3ZlZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gc2libGluZyBub2RlIHJlbW92ZWQKICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQuY2hpbGRJbmRleCA+IHJlbW92YWxJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jaGlsZEluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0Lm9uTm9kZVJlbW92ZWQoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250ZXh0LnBhcmVudC5jaGlsZHJlbi5zcGxpY2UocmVtb3ZhbEluZGV4LCAxKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvbk5vZGVSZW1vdmVkOiAoKSA9PiB7IH0sCiAgICAgICAgICBhZGRJZGVudGlmaWVycyhleHApIHsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVJZGVudGlmaWVycyhleHApIHsKICAgICAgICAgIH0sCiAgICAgICAgICBob2lzdChleHApIHsKICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoZXhwKSkKICAgICAgICAgICAgICAgICAgZXhwID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihleHApOwogICAgICAgICAgICAgIGNvbnRleHQuaG9pc3RzLnB1c2goZXhwKTsKICAgICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgX2hvaXN0ZWRfJHtjb250ZXh0LmhvaXN0cy5sZW5ndGh9YCwgZmFsc2UsIGV4cC5sb2MsIDIgLyogQ0FOX0hPSVNUICovKTsKICAgICAgICAgICAgICBpZGVudGlmaWVyLmhvaXN0ZWQgPSBleHA7CiAgICAgICAgICAgICAgcmV0dXJuIGlkZW50aWZpZXI7CiAgICAgICAgICB9LAogICAgICAgICAgY2FjaGUoZXhwLCBpc1ZOb2RlID0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQ2FjaGVFeHByZXNzaW9uKGNvbnRleHQuY2FjaGVkKyssIGV4cCwgaXNWTm9kZSk7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBjb250ZXh0OwogIH0KICBmdW5jdGlvbiB0cmFuc2Zvcm0ocm9vdCwgb3B0aW9ucykgewogICAgICBjb25zdCBjb250ZXh0ID0gY3JlYXRlVHJhbnNmb3JtQ29udGV4dChyb290LCBvcHRpb25zKTsKICAgICAgdHJhdmVyc2VOb2RlKHJvb3QsIGNvbnRleHQpOwogICAgICBpZiAob3B0aW9ucy5ob2lzdFN0YXRpYykgewogICAgICAgICAgaG9pc3RTdGF0aWMocm9vdCwgY29udGV4dCk7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zLnNzcikgewogICAgICAgICAgY3JlYXRlUm9vdENvZGVnZW4ocm9vdCwgY29udGV4dCk7CiAgICAgIH0KICAgICAgLy8gZmluYWxpemUgbWV0YSBpbmZvcm1hdGlvbgogICAgICByb290LmhlbHBlcnMgPSBbLi4uY29udGV4dC5oZWxwZXJzLmtleXMoKV07CiAgICAgIHJvb3QuY29tcG9uZW50cyA9IFsuLi5jb250ZXh0LmNvbXBvbmVudHNdOwogICAgICByb290LmRpcmVjdGl2ZXMgPSBbLi4uY29udGV4dC5kaXJlY3RpdmVzXTsKICAgICAgcm9vdC5pbXBvcnRzID0gY29udGV4dC5pbXBvcnRzOwogICAgICByb290LmhvaXN0cyA9IGNvbnRleHQuaG9pc3RzOwogICAgICByb290LnRlbXBzID0gY29udGV4dC50ZW1wczsKICAgICAgcm9vdC5jYWNoZWQgPSBjb250ZXh0LmNhY2hlZDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUm9vdENvZGVnZW4ocm9vdCwgY29udGV4dCkgewogICAgICBjb25zdCB7IGhlbHBlciB9ID0gY29udGV4dDsKICAgICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gcm9vdDsKICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlblswXTsKICAgICAgICAgIC8vIGlmIHRoZSBzaW5nbGUgY2hpbGQgaXMgYW4gZWxlbWVudCwgdHVybiBpdCBpbnRvIGEgYmxvY2suCiAgICAgICAgICBpZiAoaXNTaW5nbGVFbGVtZW50Um9vdChyb290LCBjaGlsZCkgJiYgY2hpbGQuY29kZWdlbk5vZGUpIHsKICAgICAgICAgICAgICAvLyBzaW5nbGUgZWxlbWVudCByb290IGlzIG5ldmVyIGhvaXN0ZWQgc28gY29kZWdlbk5vZGUgd2lsbCBuZXZlciBiZQogICAgICAgICAgICAgIC8vIFNpbXBsZUV4cHJlc3Npb25Ob2RlCiAgICAgICAgICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBjaGlsZC5jb2RlZ2VuTm9kZTsKICAgICAgICAgICAgICBpZiAoY29kZWdlbk5vZGUudHlwZSA9PT0gMTMgLyogVk5PREVfQ0FMTCAqLykgewogICAgICAgICAgICAgICAgICBtYWtlQmxvY2soY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByb290LmNvZGVnZW5Ob2RlID0gY29kZWdlbk5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyAtIHNpbmdsZSA8c2xvdC8+LCBJZk5vZGUsIEZvck5vZGU6IGFscmVhZHkgYmxvY2tzLgogICAgICAgICAgICAgIC8vIC0gc2luZ2xlIHRleHQgbm9kZTogYWx3YXlzIHBhdGNoZWQuCiAgICAgICAgICAgICAgLy8gcm9vdCBjb2RlZ2VuIGZhbGxzIHRocm91Z2ggdmlhIGdlbk5vZGUoKQogICAgICAgICAgICAgIHJvb3QuY29kZWdlbk5vZGUgPSBjaGlsZDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAvLyByb290IGhhcyBtdWx0aXBsZSBub2RlcyAtIHJldHVybiBhIGZyYWdtZW50IGJsb2NrLgogICAgICAgICAgbGV0IHBhdGNoRmxhZyA9IDY0IC8qIFNUQUJMRV9GUkFHTUVOVCAqLzsKICAgICAgICAgIGxldCBwYXRjaEZsYWdUZXh0ID0gUGF0Y2hGbGFnTmFtZXNbNjQgLyogU1RBQkxFX0ZSQUdNRU5UICovXTsKICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZSBmcmFnbWVudCBhY3R1YWxseSBjb250YWlucyBhIHNpbmdsZSB2YWxpZCBjaGlsZCB3aXRoCiAgICAgICAgICAvLyB0aGUgcmVzdCBiZWluZyBjb21tZW50cwogICAgICAgICAgaWYgKGNoaWxkcmVuLmZpbHRlcihjID0+IGMudHlwZSAhPT0gMyAvKiBDT01NRU5UICovKS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBwYXRjaEZsYWcgfD0gMjA0OCAvKiBERVZfUk9PVF9GUkFHTUVOVCAqLzsKICAgICAgICAgICAgICBwYXRjaEZsYWdUZXh0ICs9IGAsICR7UGF0Y2hGbGFnTmFtZXNbMjA0OCAvKiBERVZfUk9PVF9GUkFHTUVOVCAqL119YDsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QuY29kZWdlbk5vZGUgPSBjcmVhdGVWTm9kZUNhbGwoY29udGV4dCwgaGVscGVyKEZSQUdNRU5UKSwgdW5kZWZpbmVkLCByb290LmNoaWxkcmVuLCBwYXRjaEZsYWcgKyAoYCAvKiAke3BhdGNoRmxhZ1RleHR9ICovYCApLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSwgdW5kZWZpbmVkLCBmYWxzZSAvKiBpc0NvbXBvbmVudCAqLyk7CiAgICAgIH0KICAgICAgZWxzZSA7CiAgfQogIGZ1bmN0aW9uIHRyYXZlcnNlQ2hpbGRyZW4ocGFyZW50LCBjb250ZXh0KSB7CiAgICAgIGxldCBpID0gMDsKICAgICAgY29uc3Qgbm9kZVJlbW92ZWQgPSAoKSA9PiB7CiAgICAgICAgICBpLS07CiAgICAgIH07CiAgICAgIGZvciAoOyBpIDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjaGlsZCA9IHBhcmVudC5jaGlsZHJlbltpXTsKICAgICAgICAgIGlmIChpc1N0cmluZyhjaGlsZCkpCiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICBjb250ZXh0LnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgIGNvbnRleHQuY2hpbGRJbmRleCA9IGk7CiAgICAgICAgICBjb250ZXh0Lm9uTm9kZVJlbW92ZWQgPSBub2RlUmVtb3ZlZDsKICAgICAgICAgIHRyYXZlcnNlTm9kZShjaGlsZCwgY29udGV4dCk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gdHJhdmVyc2VOb2RlKG5vZGUsIGNvbnRleHQpIHsKICAgICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG5vZGU7CiAgICAgIC8vIGFwcGx5IHRyYW5zZm9ybSBwbHVnaW5zCiAgICAgIGNvbnN0IHsgbm9kZVRyYW5zZm9ybXMgfSA9IGNvbnRleHQ7CiAgICAgIGNvbnN0IGV4aXRGbnMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlVHJhbnNmb3Jtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qgb25FeGl0ID0gbm9kZVRyYW5zZm9ybXNbaV0obm9kZSwgY29udGV4dCk7CiAgICAgICAgICBpZiAob25FeGl0KSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkob25FeGl0KSkgewogICAgICAgICAgICAgICAgICBleGl0Rm5zLnB1c2goLi4ub25FeGl0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4aXRGbnMucHVzaChvbkV4aXQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghY29udGV4dC5jdXJyZW50Tm9kZSkgewogICAgICAgICAgICAgIC8vIG5vZGUgd2FzIHJlbW92ZWQKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyBub2RlIG1heSBoYXZlIGJlZW4gcmVwbGFjZWQKICAgICAgICAgICAgICBub2RlID0gY29udGV4dC5jdXJyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICAgICAgY2FzZSAzIC8qIENPTU1FTlQgKi86CiAgICAgICAgICAgICAgaWYgKCFjb250ZXh0LnNzcikgewogICAgICAgICAgICAgICAgICAvLyBpbmplY3QgaW1wb3J0IGZvciB0aGUgQ29tbWVudCBzeW1ib2wsIHdoaWNoIGlzIG5lZWRlZCBmb3IgY3JlYXRpbmcKICAgICAgICAgICAgICAgICAgLy8gY29tbWVudCBub2RlcyB3aXRoIGBjcmVhdGVWTm9kZWAKICAgICAgICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoQ1JFQVRFX0NPTU1FTlQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNSAvKiBJTlRFUlBPTEFUSU9OICovOgogICAgICAgICAgICAgIC8vIG5vIG5lZWQgdG8gdHJhdmVyc2UsIGJ1dCB3ZSBuZWVkIHRvIGluamVjdCB0b1N0cmluZyBoZWxwZXIKICAgICAgICAgICAgICBpZiAoIWNvbnRleHQuc3NyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKFRPX0RJU1BMQVlfU1RSSU5HKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAvLyBmb3IgY29udGFpbmVyIHR5cGVzLCBmdXJ0aGVyIHRyYXZlcnNlIGRvd253YXJkcwogICAgICAgICAgY2FzZSA5IC8qIElGICovOgogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5icmFuY2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZS5icmFuY2hlc1tpXSwgY29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxMCAvKiBJRl9CUkFOQ0ggKi86CiAgICAgICAgICBjYXNlIDExIC8qIEZPUiAqLzoKICAgICAgICAgIGNhc2UgMSAvKiBFTEVNRU5UICovOgogICAgICAgICAgY2FzZSAwIC8qIFJPT1QgKi86CiAgICAgICAgICAgICAgdHJhdmVyc2VDaGlsZHJlbihub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICAvLyBleGl0IHRyYW5zZm9ybXMKICAgICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG5vZGU7CiAgICAgIGxldCBpID0gZXhpdEZucy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGV4aXRGbnNbaV0oKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBjcmVhdGVTdHJ1Y3R1cmFsRGlyZWN0aXZlVHJhbnNmb3JtKG5hbWUsIGZuKSB7CiAgICAgIGNvbnN0IG1hdGNoZXMgPSBpc1N0cmluZyhuYW1lKQogICAgICAgICAgPyAobikgPT4gbiA9PT0gbmFtZQogICAgICAgICAgOiAobikgPT4gbmFtZS50ZXN0KG4pOwogICAgICByZXR1cm4gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgICAgIGlmIChub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IG5vZGU7CiAgICAgICAgICAgICAgLy8gc3RydWN0dXJhbCBkaXJlY3RpdmUgdHJhbnNmb3JtcyBhcmUgbm90IGNvbmNlcm5lZCB3aXRoIHNsb3RzCiAgICAgICAgICAgICAgLy8gYXMgdGhleSBhcmUgaGFuZGxlZCBzZXBhcmF0ZWx5IGluIHZTbG90LnRzCiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnVHlwZSA9PT0gMyAvKiBURU1QTEFURSAqLyAmJiBwcm9wcy5zb21lKGlzVlNsb3QpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgZXhpdEZucyA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcCA9IHByb3BzW2ldOwogICAgICAgICAgICAgICAgICBpZiAocHJvcC50eXBlID09PSA3IC8qIERJUkVDVElWRSAqLyAmJiBtYXRjaGVzKHByb3AubmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cnVjdHVyYWwgZGlyZWN0aXZlcyBhcmUgcmVtb3ZlZCB0byBhdm9pZCBpbmZpbml0ZSByZWN1cnNpb24KICAgICAgICAgICAgICAgICAgICAgIC8vIGFsc28gd2UgcmVtb3ZlIHRoZW0gKmJlZm9yZSogYXBwbHlpbmcgc28gdGhhdCBpdCBjYW4gZnVydGhlcgogICAgICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2UgaXRzZWxmIGluIGNhc2UgaXQgbW92ZXMgdGhlIG5vZGUgYXJvdW5kCiAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbkV4aXQgPSBmbihub2RlLCBwcm9wLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChvbkV4aXQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpdEZucy5wdXNoKG9uRXhpdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGV4aXRGbnM7CiAgICAgICAgICB9CiAgICAgIH07CiAgfQoKICBjb25zdCBQVVJFX0FOTk9UQVRJT04gPSBgLyojX19QVVJFX18qL2A7CiAgY29uc3QgYWxpYXNIZWxwZXIgPSAocykgPT4gYCR7aGVscGVyTmFtZU1hcFtzXX06IF8ke2hlbHBlck5hbWVNYXBbc119YDsKICBmdW5jdGlvbiBjcmVhdGVDb2RlZ2VuQ29udGV4dChhc3QsIHsgbW9kZSA9ICdmdW5jdGlvbicsIHByZWZpeElkZW50aWZpZXJzID0gbW9kZSA9PT0gJ21vZHVsZScsIHNvdXJjZU1hcCA9IGZhbHNlLCBmaWxlbmFtZSA9IGB0ZW1wbGF0ZS52dWUuaHRtbGAsIHNjb3BlSWQgPSBudWxsLCBvcHRpbWl6ZUltcG9ydHMgPSBmYWxzZSwgcnVudGltZUdsb2JhbE5hbWUgPSBgVnVlYCwgcnVudGltZU1vZHVsZU5hbWUgPSBgdnVlYCwgc3NyUnVudGltZU1vZHVsZU5hbWUgPSAndnVlL3NlcnZlci1yZW5kZXJlcicsIHNzciA9IGZhbHNlLCBpc1RTID0gZmFsc2UsIGluU1NSID0gZmFsc2UgfSkgewogICAgICBjb25zdCBjb250ZXh0ID0gewogICAgICAgICAgbW9kZSwKICAgICAgICAgIHByZWZpeElkZW50aWZpZXJzLAogICAgICAgICAgc291cmNlTWFwLAogICAgICAgICAgZmlsZW5hbWUsCiAgICAgICAgICBzY29wZUlkLAogICAgICAgICAgb3B0aW1pemVJbXBvcnRzLAogICAgICAgICAgcnVudGltZUdsb2JhbE5hbWUsCiAgICAgICAgICBydW50aW1lTW9kdWxlTmFtZSwKICAgICAgICAgIHNzclJ1bnRpbWVNb2R1bGVOYW1lLAogICAgICAgICAgc3NyLAogICAgICAgICAgaXNUUywKICAgICAgICAgIGluU1NSLAogICAgICAgICAgc291cmNlOiBhc3QubG9jLnNvdXJjZSwKICAgICAgICAgIGNvZGU6IGBgLAogICAgICAgICAgY29sdW1uOiAxLAogICAgICAgICAgbGluZTogMSwKICAgICAgICAgIG9mZnNldDogMCwKICAgICAgICAgIGluZGVudExldmVsOiAwLAogICAgICAgICAgcHVyZTogZmFsc2UsCiAgICAgICAgICBtYXA6IHVuZGVmaW5lZCwKICAgICAgICAgIGhlbHBlcihrZXkpIHsKICAgICAgICAgICAgICByZXR1cm4gYF8ke2hlbHBlck5hbWVNYXBba2V5XX1gOwogICAgICAgICAgfSwKICAgICAgICAgIHB1c2goY29kZSwgbm9kZSkgewogICAgICAgICAgICAgIGNvbnRleHQuY29kZSArPSBjb2RlOwogICAgICAgICAgfSwKICAgICAgICAgIGluZGVudCgpIHsKICAgICAgICAgICAgICBuZXdsaW5lKCsrY29udGV4dC5pbmRlbnRMZXZlbCk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVpbmRlbnQod2l0aG91dE5ld0xpbmUgPSBmYWxzZSkgewogICAgICAgICAgICAgIGlmICh3aXRob3V0TmV3TGluZSkgewogICAgICAgICAgICAgICAgICAtLWNvbnRleHQuaW5kZW50TGV2ZWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdsaW5lKC0tY29udGV4dC5pbmRlbnRMZXZlbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIG5ld2xpbmUoKSB7CiAgICAgICAgICAgICAgbmV3bGluZShjb250ZXh0LmluZGVudExldmVsKTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgZnVuY3Rpb24gbmV3bGluZShuKSB7CiAgICAgICAgICBjb250ZXh0LnB1c2goJ1xuJyArIGAgIGAucmVwZWF0KG4pKTsKICAgICAgfQogICAgICByZXR1cm4gY29udGV4dDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGUoYXN0LCBvcHRpb25zID0ge30pIHsKICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZUNvZGVnZW5Db250ZXh0KGFzdCwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLm9uQ29udGV4dENyZWF0ZWQpCiAgICAgICAgICBvcHRpb25zLm9uQ29udGV4dENyZWF0ZWQoY29udGV4dCk7CiAgICAgIGNvbnN0IHsgbW9kZSwgcHVzaCwgcHJlZml4SWRlbnRpZmllcnMsIGluZGVudCwgZGVpbmRlbnQsIG5ld2xpbmUsIHNjb3BlSWQsIHNzciB9ID0gY29udGV4dDsKICAgICAgY29uc3QgaGFzSGVscGVycyA9IGFzdC5oZWxwZXJzLmxlbmd0aCA+IDA7CiAgICAgIGNvbnN0IHVzZVdpdGhCbG9jayA9ICFwcmVmaXhJZGVudGlmaWVycyAmJiBtb2RlICE9PSAnbW9kdWxlJzsKICAgICAgLy8gcHJlYW1ibGVzCiAgICAgIC8vIGluIHNldHVwKCkgaW5saW5lIG1vZGUsIHRoZSBwcmVhbWJsZSBpcyBnZW5lcmF0ZWQgaW4gYSBzdWIgY29udGV4dAogICAgICAvLyBhbmQgcmV0dXJuZWQgc2VwYXJhdGVseS4KICAgICAgY29uc3QgcHJlYW1ibGVDb250ZXh0ID0gY29udGV4dDsKICAgICAgewogICAgICAgICAgZ2VuRnVuY3Rpb25QcmVhbWJsZShhc3QsIHByZWFtYmxlQ29udGV4dCk7CiAgICAgIH0KICAgICAgLy8gZW50ZXIgcmVuZGVyIGZ1bmN0aW9uCiAgICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHNzciA/IGBzc3JSZW5kZXJgIDogYHJlbmRlcmA7CiAgICAgIGNvbnN0IGFyZ3MgPSBzc3IgPyBbJ19jdHgnLCAnX3B1c2gnLCAnX3BhcmVudCcsICdfYXR0cnMnXSA6IFsnX2N0eCcsICdfY2FjaGUnXTsKICAgICAgY29uc3Qgc2lnbmF0dXJlID0gYXJncy5qb2luKCcsICcpOwogICAgICB7CiAgICAgICAgICBwdXNoKGBmdW5jdGlvbiAke2Z1bmN0aW9uTmFtZX0oJHtzaWduYXR1cmV9KSB7YCk7CiAgICAgIH0KICAgICAgaW5kZW50KCk7CiAgICAgIGlmICh1c2VXaXRoQmxvY2spIHsKICAgICAgICAgIHB1c2goYHdpdGggKF9jdHgpIHtgKTsKICAgICAgICAgIGluZGVudCgpOwogICAgICAgICAgLy8gZnVuY3Rpb24gbW9kZSBjb25zdCBkZWNsYXJhdGlvbnMgc2hvdWxkIGJlIGluc2lkZSB3aXRoIGJsb2NrCiAgICAgICAgICAvLyBhbHNvIHRoZXkgc2hvdWxkIGJlIHJlbmFtZWQgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggdXNlciBwcm9wZXJ0aWVzCiAgICAgICAgICBpZiAoaGFzSGVscGVycykgewogICAgICAgICAgICAgIHB1c2goYGNvbnN0IHsgJHthc3QuaGVscGVycy5tYXAoYWxpYXNIZWxwZXIpLmpvaW4oJywgJyl9IH0gPSBfVnVlYCk7CiAgICAgICAgICAgICAgcHVzaChgXG5gKTsKICAgICAgICAgICAgICBuZXdsaW5lKCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZ2VuZXJhdGUgYXNzZXQgcmVzb2x1dGlvbiBzdGF0ZW1lbnRzCiAgICAgIGlmIChhc3QuY29tcG9uZW50cy5sZW5ndGgpIHsKICAgICAgICAgIGdlbkFzc2V0cyhhc3QuY29tcG9uZW50cywgJ2NvbXBvbmVudCcsIGNvbnRleHQpOwogICAgICAgICAgaWYgKGFzdC5kaXJlY3RpdmVzLmxlbmd0aCB8fCBhc3QudGVtcHMgPiAwKSB7CiAgICAgICAgICAgICAgbmV3bGluZSgpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChhc3QuZGlyZWN0aXZlcy5sZW5ndGgpIHsKICAgICAgICAgIGdlbkFzc2V0cyhhc3QuZGlyZWN0aXZlcywgJ2RpcmVjdGl2ZScsIGNvbnRleHQpOwogICAgICAgICAgaWYgKGFzdC50ZW1wcyA+IDApIHsKICAgICAgICAgICAgICBuZXdsaW5lKCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGFzdC50ZW1wcyA+IDApIHsKICAgICAgICAgIHB1c2goYGxldCBgKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXN0LnRlbXBzOyBpKyspIHsKICAgICAgICAgICAgICBwdXNoKGAke2kgPiAwID8gYCwgYCA6IGBgfV90ZW1wJHtpfWApOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChhc3QuY29tcG9uZW50cy5sZW5ndGggfHwgYXN0LmRpcmVjdGl2ZXMubGVuZ3RoIHx8IGFzdC50ZW1wcykgewogICAgICAgICAgcHVzaChgXG5gKTsKICAgICAgICAgIG5ld2xpbmUoKTsKICAgICAgfQogICAgICAvLyBnZW5lcmF0ZSB0aGUgVk5vZGUgdHJlZSBleHByZXNzaW9uCiAgICAgIGlmICghc3NyKSB7CiAgICAgICAgICBwdXNoKGByZXR1cm4gYCk7CiAgICAgIH0KICAgICAgaWYgKGFzdC5jb2RlZ2VuTm9kZSkgewogICAgICAgICAgZ2VuTm9kZShhc3QuY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgcHVzaChgbnVsbGApOwogICAgICB9CiAgICAgIGlmICh1c2VXaXRoQmxvY2spIHsKICAgICAgICAgIGRlaW5kZW50KCk7CiAgICAgICAgICBwdXNoKGB9YCk7CiAgICAgIH0KICAgICAgZGVpbmRlbnQoKTsKICAgICAgcHVzaChgfWApOwogICAgICByZXR1cm4gewogICAgICAgICAgYXN0LAogICAgICAgICAgY29kZTogY29udGV4dC5jb2RlLAogICAgICAgICAgcHJlYW1ibGU6IGBgLAogICAgICAgICAgLy8gU291cmNlTWFwR2VuZXJhdG9yIGRvZXMgaGF2ZSB0b0pTT04oKSBtZXRob2QgYnV0IGl0J3Mgbm90IGluIHRoZSB0eXBlcwogICAgICAgICAgbWFwOiBjb250ZXh0Lm1hcCA/IGNvbnRleHQubWFwLnRvSlNPTigpIDogdW5kZWZpbmVkCiAgICAgIH07CiAgfQogIGZ1bmN0aW9uIGdlbkZ1bmN0aW9uUHJlYW1ibGUoYXN0LCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgc3NyLCBwcmVmaXhJZGVudGlmaWVycywgcHVzaCwgbmV3bGluZSwgcnVudGltZU1vZHVsZU5hbWUsIHJ1bnRpbWVHbG9iYWxOYW1lLCBzc3JSdW50aW1lTW9kdWxlTmFtZSB9ID0gY29udGV4dDsKICAgICAgY29uc3QgVnVlQmluZGluZyA9IHJ1bnRpbWVHbG9iYWxOYW1lOwogICAgICAvLyBHZW5lcmF0ZSBjb25zdCBkZWNsYXJhdGlvbiBmb3IgaGVscGVycwogICAgICAvLyBJbiBwcmVmaXggbW9kZSwgd2UgcGxhY2UgdGhlIGNvbnN0IGRlY2xhcmF0aW9uIGF0IHRvcCBzbyBpdCdzIGRvbmUKICAgICAgLy8gb25seSBvbmNlOyBCdXQgaWYgd2Ugbm90IHByZWZpeGluZywgd2UgcGxhY2UgdGhlIGRlY2xhcmF0aW9uIGluc2lkZSB0aGUKICAgICAgLy8gd2l0aCBibG9jayBzbyBpdCBkb2Vzbid0IGluY3VyIHRoZSBgaW5gIGNoZWNrIGNvc3QgZm9yIGV2ZXJ5IGhlbHBlciBhY2Nlc3MuCiAgICAgIGlmIChhc3QuaGVscGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gIndpdGgiIG1vZGUuCiAgICAgICAgICAgICAgLy8gc2F2ZSBWdWUgaW4gYSBzZXBhcmF0ZSB2YXJpYWJsZSB0byBhdm9pZCBjb2xsaXNpb24KICAgICAgICAgICAgICBwdXNoKGBjb25zdCBfVnVlID0gJHtWdWVCaW5kaW5nfVxuYCk7CiAgICAgICAgICAgICAgLy8gaW4gIndpdGgiIG1vZGUsIGhlbHBlcnMgYXJlIGRlY2xhcmVkIGluc2lkZSB0aGUgd2l0aCBibG9jayB0byBhdm9pZAogICAgICAgICAgICAgIC8vIGhhcyBjaGVjayBjb3N0LCBidXQgaG9pc3RzIGFyZSBsaWZ0ZWQgb3V0IG9mIHRoZSBmdW5jdGlvbiAtIHdlIG5lZWQKICAgICAgICAgICAgICAvLyB0byBwcm92aWRlIHRoZSBoZWxwZXIgaGVyZS4KICAgICAgICAgICAgICBpZiAoYXN0LmhvaXN0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdGljSGVscGVycyA9IFsKICAgICAgICAgICAgICAgICAgICAgIENSRUFURV9WTk9ERSwKICAgICAgICAgICAgICAgICAgICAgIENSRUFURV9FTEVNRU5UX1ZOT0RFLAogICAgICAgICAgICAgICAgICAgICAgQ1JFQVRFX0NPTU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICBDUkVBVEVfVEVYVCwKICAgICAgICAgICAgICAgICAgICAgIENSRUFURV9TVEFUSUMKICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihoZWxwZXIgPT4gYXN0LmhlbHBlcnMuaW5jbHVkZXMoaGVscGVyKSkKICAgICAgICAgICAgICAgICAgICAgIC5tYXAoYWxpYXNIZWxwZXIpCiAgICAgICAgICAgICAgICAgICAgICAuam9pbignLCAnKTsKICAgICAgICAgICAgICAgICAgcHVzaChgY29uc3QgeyAke3N0YXRpY0hlbHBlcnN9IH0gPSBfVnVlXG5gKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgZ2VuSG9pc3RzKGFzdC5ob2lzdHMsIGNvbnRleHQpOwogICAgICBuZXdsaW5lKCk7CiAgICAgIHB1c2goYHJldHVybiBgKTsKICB9CiAgZnVuY3Rpb24gZ2VuQXNzZXRzKGFzc2V0cywgdHlwZSwgeyBoZWxwZXIsIHB1c2gsIG5ld2xpbmUsIGlzVFMgfSkgewogICAgICBjb25zdCByZXNvbHZlciA9IGhlbHBlcih0eXBlID09PSAnY29tcG9uZW50JwogICAgICAgICAgICAgID8gUkVTT0xWRV9DT01QT05FTlQKICAgICAgICAgICAgICA6IFJFU09MVkVfRElSRUNUSVZFKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhc3NldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxldCBpZCA9IGFzc2V0c1tpXTsKICAgICAgICAgIC8vIHBvdGVudGlhbCBjb21wb25lbnQgaW1wbGljaXQgc2VsZi1yZWZlcmVuY2UgaW5mZXJyZWQgZnJvbSBTRkMgZmlsZW5hbWUKICAgICAgICAgIGNvbnN0IG1heWJlU2VsZlJlZmVyZW5jZSA9IGlkLmVuZHNXaXRoKCdfX3NlbGYnKTsKICAgICAgICAgIGlmIChtYXliZVNlbGZSZWZlcmVuY2UpIHsKICAgICAgICAgICAgICBpZCA9IGlkLnNsaWNlKDAsIC02KTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goYGNvbnN0ICR7dG9WYWxpZEFzc2V0SWQoaWQsIHR5cGUpfSA9ICR7cmVzb2x2ZXJ9KCR7SlNPTi5zdHJpbmdpZnkoaWQpfSR7bWF5YmVTZWxmUmVmZXJlbmNlID8gYCwgdHJ1ZWAgOiBgYH0pJHtpc1RTID8gYCFgIDogYGB9YCk7CiAgICAgICAgICBpZiAoaSA8IGFzc2V0cy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgbmV3bGluZSgpOwogICAgICAgICAgfQogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbkhvaXN0cyhob2lzdHMsIGNvbnRleHQpIHsKICAgICAgaWYgKCFob2lzdHMubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29udGV4dC5wdXJlID0gdHJ1ZTsKICAgICAgY29uc3QgeyBwdXNoLCBuZXdsaW5lLCBoZWxwZXIsIHNjb3BlSWQsIG1vZGUgfSA9IGNvbnRleHQ7CiAgICAgIG5ld2xpbmUoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBob2lzdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGV4cCA9IGhvaXN0c1tpXTsKICAgICAgICAgIGlmIChleHApIHsKICAgICAgICAgICAgICBwdXNoKGBjb25zdCBfaG9pc3RlZF8ke2kgKyAxfSA9ICR7YGB9YCk7CiAgICAgICAgICAgICAgZ2VuTm9kZShleHAsIGNvbnRleHQpOwogICAgICAgICAgICAgIG5ld2xpbmUoKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBjb250ZXh0LnB1cmUgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gaXNUZXh0JDEobikgewogICAgICByZXR1cm4gKGlzU3RyaW5nKG4pIHx8CiAgICAgICAgICBuLnR5cGUgPT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8gfHwKICAgICAgICAgIG4udHlwZSA9PT0gMiAvKiBURVhUICovIHx8CiAgICAgICAgICBuLnR5cGUgPT09IDUgLyogSU5URVJQT0xBVElPTiAqLyB8fAogICAgICAgICAgbi50eXBlID09PSA4IC8qIENPTVBPVU5EX0VYUFJFU1NJT04gKi8pOwogIH0KICBmdW5jdGlvbiBnZW5Ob2RlTGlzdEFzQXJyYXkobm9kZXMsIGNvbnRleHQpIHsKICAgICAgY29uc3QgbXVsdGlsaW5lcyA9IG5vZGVzLmxlbmd0aCA+IDMgfHwKICAgICAgICAgIChub2Rlcy5zb21lKG4gPT4gaXNBcnJheShuKSB8fCAhaXNUZXh0JDEobikpKTsKICAgICAgY29udGV4dC5wdXNoKGBbYCk7CiAgICAgIG11bHRpbGluZXMgJiYgY29udGV4dC5pbmRlbnQoKTsKICAgICAgZ2VuTm9kZUxpc3Qobm9kZXMsIGNvbnRleHQsIG11bHRpbGluZXMpOwogICAgICBtdWx0aWxpbmVzICYmIGNvbnRleHQuZGVpbmRlbnQoKTsKICAgICAgY29udGV4dC5wdXNoKGBdYCk7CiAgfQogIGZ1bmN0aW9uIGdlbk5vZGVMaXN0KG5vZGVzLCBjb250ZXh0LCBtdWx0aWxpbmVzID0gZmFsc2UsIGNvbW1hID0gdHJ1ZSkgewogICAgICBjb25zdCB7IHB1c2gsIG5ld2xpbmUgfSA9IGNvbnRleHQ7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXTsKICAgICAgICAgIGlmIChpc1N0cmluZyhub2RlKSkgewogICAgICAgICAgICAgIHB1c2gobm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc0FycmF5KG5vZGUpKSB7CiAgICAgICAgICAgICAgZ2VuTm9kZUxpc3RBc0FycmF5KG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgZ2VuTm9kZShub2RlLCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpIDwgbm9kZXMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIGlmIChtdWx0aWxpbmVzKSB7CiAgICAgICAgICAgICAgICAgIGNvbW1hICYmIHB1c2goJywnKTsKICAgICAgICAgICAgICAgICAgbmV3bGluZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29tbWEgJiYgcHVzaCgnLCAnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuTm9kZShub2RlLCBjb250ZXh0KSB7CiAgICAgIGlmIChpc1N0cmluZyhub2RlKSkgewogICAgICAgICAgY29udGV4dC5wdXNoKG5vZGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChpc1N5bWJvbChub2RlKSkgewogICAgICAgICAgY29udGV4dC5wdXNoKGNvbnRleHQuaGVscGVyKG5vZGUpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICAgICAgY2FzZSAxIC8qIEVMRU1FTlQgKi86CiAgICAgICAgICBjYXNlIDkgLyogSUYgKi86CiAgICAgICAgICBjYXNlIDExIC8qIEZPUiAqLzoKICAgICAgICAgICAgICBhc3NlcnQobm9kZS5jb2RlZ2VuTm9kZSAhPSBudWxsLCBgQ29kZWdlbiBub2RlIGlzIG1pc3NpbmcgZm9yIGVsZW1lbnQvaWYvZm9yIG5vZGUuIGAgKwogICAgICAgICAgICAgICAgICAgICAgYEFwcGx5IGFwcHJvcHJpYXRlIHRyYW5zZm9ybXMgZmlyc3QuYCk7CiAgICAgICAgICAgICAgZ2VuTm9kZShub2RlLmNvZGVnZW5Ob2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMiAvKiBURVhUICovOgogICAgICAgICAgICAgIGdlblRleHQobm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi86CiAgICAgICAgICAgICAgZ2VuRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNSAvKiBJTlRFUlBPTEFUSU9OICovOgogICAgICAgICAgICAgIGdlbkludGVycG9sYXRpb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDEyIC8qIFRFWFRfQ0FMTCAqLzoKICAgICAgICAgICAgICBnZW5Ob2RlKG5vZGUuY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA4IC8qIENPTVBPVU5EX0VYUFJFU1NJT04gKi86CiAgICAgICAgICAgICAgZ2VuQ29tcG91bmRFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzIC8qIENPTU1FTlQgKi86CiAgICAgICAgICAgICAgZ2VuQ29tbWVudChub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMTMgLyogVk5PREVfQ0FMTCAqLzoKICAgICAgICAgICAgICBnZW5WTm9kZUNhbGwobm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE0IC8qIEpTX0NBTExfRVhQUkVTU0lPTiAqLzoKICAgICAgICAgICAgICBnZW5DYWxsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMTUgLyogSlNfT0JKRUNUX0VYUFJFU1NJT04gKi86CiAgICAgICAgICAgICAgZ2VuT2JqZWN0RXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMTcgLyogSlNfQVJSQVlfRVhQUkVTU0lPTiAqLzoKICAgICAgICAgICAgICBnZW5BcnJheUV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE4IC8qIEpTX0ZVTkNUSU9OX0VYUFJFU1NJT04gKi86CiAgICAgICAgICAgICAgZ2VuRnVuY3Rpb25FeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxOSAvKiBKU19DT05ESVRJT05BTF9FWFBSRVNTSU9OICovOgogICAgICAgICAgICAgIGdlbkNvbmRpdGlvbmFsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjAgLyogSlNfQ0FDSEVfRVhQUkVTU0lPTiAqLzoKICAgICAgICAgICAgICBnZW5DYWNoZUV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDIxIC8qIEpTX0JMT0NLX1NUQVRFTUVOVCAqLzoKICAgICAgICAgICAgICBnZW5Ob2RlTGlzdChub2RlLmJvZHksIGNvbnRleHQsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIC8vIFNTUiBvbmx5IHR5cGVzCiAgICAgICAgICBjYXNlIDIyIC8qIEpTX1RFTVBMQVRFX0xJVEVSQUwgKi86CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDIzIC8qIEpTX0lGX1NUQVRFTUVOVCAqLzoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjQgLyogSlNfQVNTSUdOTUVOVF9FWFBSRVNTSU9OICovOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyNSAvKiBKU19TRVFVRU5DRV9FWFBSRVNTSU9OICovOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyNiAvKiBKU19SRVRVUk5fU1RBVEVNRU5UICovOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICAgIGNhc2UgMTAgLyogSUZfQlJBTkNIICovOgogICAgICAgICAgICAgIC8vIG5vb3AKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBhc3NlcnQoZmFsc2UsIGB1bmhhbmRsZWQgY29kZWdlbiBub2RlIHR5cGU6ICR7bm9kZS50eXBlfWApOwogICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgZXhoYXVzdCBhbGwgcG9zc2libGUgdHlwZXMKICAgICAgICAgICAgICAgICAgY29uc3QgZXhoYXVzdGl2ZUNoZWNrID0gbm9kZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aGF1c3RpdmVDaGVjazsKICAgICAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuVGV4dChub2RlLCBjb250ZXh0KSB7CiAgICAgIGNvbnRleHQucHVzaChKU09OLnN0cmluZ2lmeShub2RlLmNvbnRlbnQpLCBub2RlKTsKICB9CiAgZnVuY3Rpb24gZ2VuRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgY29udGVudCwgaXNTdGF0aWMgfSA9IG5vZGU7CiAgICAgIGNvbnRleHQucHVzaChpc1N0YXRpYyA/IEpTT04uc3RyaW5naWZ5KGNvbnRlbnQpIDogY29udGVudCwgbm9kZSk7CiAgfQogIGZ1bmN0aW9uIGdlbkludGVycG9sYXRpb24obm9kZSwgY29udGV4dCkgewogICAgICBjb25zdCB7IHB1c2gsIGhlbHBlciwgcHVyZSB9ID0gY29udGV4dDsKICAgICAgaWYgKHB1cmUpCiAgICAgICAgICBwdXNoKFBVUkVfQU5OT1RBVElPTik7CiAgICAgIHB1c2goYCR7aGVscGVyKFRPX0RJU1BMQVlfU1RSSU5HKX0oYCk7CiAgICAgIGdlbk5vZGUobm9kZS5jb250ZW50LCBjb250ZXh0KTsKICAgICAgcHVzaChgKWApOwogIH0KICBmdW5jdGlvbiBnZW5Db21wb3VuZEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsKICAgICAgICAgIGlmIChpc1N0cmluZyhjaGlsZCkpIHsKICAgICAgICAgICAgICBjb250ZXh0LnB1c2goY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgZ2VuTm9kZShjaGlsZCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuRXhwcmVzc2lvbkFzUHJvcGVydHlLZXkobm9kZSwgY29udGV4dCkgewogICAgICBjb25zdCB7IHB1c2ggfSA9IGNvbnRleHQ7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDggLyogQ09NUE9VTkRfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgcHVzaChgW2ApOwogICAgICAgICAgZ2VuQ29tcG91bmRFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgcHVzaChgXWApOwogICAgICB9CiAgICAgIGVsc2UgaWYgKG5vZGUuaXNTdGF0aWMpIHsKICAgICAgICAgIC8vIG9ubHkgcXVvdGUga2V5cyBpZiBuZWNlc3NhcnkKICAgICAgICAgIGNvbnN0IHRleHQgPSBpc1NpbXBsZUlkZW50aWZpZXIobm9kZS5jb250ZW50KQogICAgICAgICAgICAgID8gbm9kZS5jb250ZW50CiAgICAgICAgICAgICAgOiBKU09OLnN0cmluZ2lmeShub2RlLmNvbnRlbnQpOwogICAgICAgICAgcHVzaCh0ZXh0LCBub2RlKTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIHB1c2goYFske25vZGUuY29udGVudH1dYCwgbm9kZSk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuQ29tbWVudChub2RlLCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgcHVzaCwgaGVscGVyLCBwdXJlIH0gPSBjb250ZXh0OwogICAgICBpZiAocHVyZSkgewogICAgICAgICAgcHVzaChQVVJFX0FOTk9UQVRJT04pOwogICAgICB9CiAgICAgIHB1c2goYCR7aGVscGVyKENSRUFURV9DT01NRU5UKX0oJHtKU09OLnN0cmluZ2lmeShub2RlLmNvbnRlbnQpfSlgLCBub2RlKTsKICB9CiAgZnVuY3Rpb24gZ2VuVk5vZGVDYWxsKG5vZGUsIGNvbnRleHQpIHsKICAgICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIHB1cmUgfSA9IGNvbnRleHQ7CiAgICAgIGNvbnN0IHsgdGFnLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzLCBkaXJlY3RpdmVzLCBpc0Jsb2NrLCBkaXNhYmxlVHJhY2tpbmcsIGlzQ29tcG9uZW50IH0gPSBub2RlOwogICAgICBpZiAoZGlyZWN0aXZlcykgewogICAgICAgICAgcHVzaChoZWxwZXIoV0lUSF9ESVJFQ1RJVkVTKSArIGAoYCk7CiAgICAgIH0KICAgICAgaWYgKGlzQmxvY2spIHsKICAgICAgICAgIHB1c2goYCgke2hlbHBlcihPUEVOX0JMT0NLKX0oJHtkaXNhYmxlVHJhY2tpbmcgPyBgdHJ1ZWAgOiBgYH0pLCBgKTsKICAgICAgfQogICAgICBpZiAocHVyZSkgewogICAgICAgICAgcHVzaChQVVJFX0FOTk9UQVRJT04pOwogICAgICB9CiAgICAgIGNvbnN0IGNhbGxIZWxwZXIgPSBpc0Jsb2NrCiAgICAgICAgICA/IGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpCiAgICAgICAgICA6IGdldFZOb2RlSGVscGVyKGNvbnRleHQuaW5TU1IsIGlzQ29tcG9uZW50KTsKICAgICAgcHVzaChoZWxwZXIoY2FsbEhlbHBlcikgKyBgKGAsIG5vZGUpOwogICAgICBnZW5Ob2RlTGlzdChnZW5OdWxsYWJsZUFyZ3MoW3RhZywgcHJvcHMsIGNoaWxkcmVuLCBwYXRjaEZsYWcsIGR5bmFtaWNQcm9wc10pLCBjb250ZXh0KTsKICAgICAgcHVzaChgKWApOwogICAgICBpZiAoaXNCbG9jaykgewogICAgICAgICAgcHVzaChgKWApOwogICAgICB9CiAgICAgIGlmIChkaXJlY3RpdmVzKSB7CiAgICAgICAgICBwdXNoKGAsIGApOwogICAgICAgICAgZ2VuTm9kZShkaXJlY3RpdmVzLCBjb250ZXh0KTsKICAgICAgICAgIHB1c2goYClgKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBnZW5OdWxsYWJsZUFyZ3MoYXJncykgewogICAgICBsZXQgaSA9IGFyZ3MubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBpZiAoYXJnc1tpXSAhPSBudWxsKQogICAgICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzLnNsaWNlKDAsIGkgKyAxKS5tYXAoYXJnID0+IGFyZyB8fCBgbnVsbGApOwogIH0KICAvLyBKYXZhU2NyaXB0CiAgZnVuY3Rpb24gZ2VuQ2FsbEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgICBjb25zdCB7IHB1c2gsIGhlbHBlciwgcHVyZSB9ID0gY29udGV4dDsKICAgICAgY29uc3QgY2FsbGVlID0gaXNTdHJpbmcobm9kZS5jYWxsZWUpID8gbm9kZS5jYWxsZWUgOiBoZWxwZXIobm9kZS5jYWxsZWUpOwogICAgICBpZiAocHVyZSkgewogICAgICAgICAgcHVzaChQVVJFX0FOTk9UQVRJT04pOwogICAgICB9CiAgICAgIHB1c2goY2FsbGVlICsgYChgLCBub2RlKTsKICAgICAgZ2VuTm9kZUxpc3Qobm9kZS5hcmd1bWVudHMsIGNvbnRleHQpOwogICAgICBwdXNoKGApYCk7CiAgfQogIGZ1bmN0aW9uIGdlbk9iamVjdEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgICBjb25zdCB7IHB1c2gsIGluZGVudCwgZGVpbmRlbnQsIG5ld2xpbmUgfSA9IGNvbnRleHQ7CiAgICAgIGNvbnN0IHsgcHJvcGVydGllcyB9ID0gbm9kZTsKICAgICAgaWYgKCFwcm9wZXJ0aWVzLmxlbmd0aCkgewogICAgICAgICAgcHVzaChge31gLCBub2RlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBtdWx0aWxpbmVzID0gcHJvcGVydGllcy5sZW5ndGggPiAxIHx8CiAgICAgICAgICAocHJvcGVydGllcy5zb21lKHAgPT4gcC52YWx1ZS50eXBlICE9PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovKSk7CiAgICAgIHB1c2gobXVsdGlsaW5lcyA/IGB7YCA6IGB7IGApOwogICAgICBtdWx0aWxpbmVzICYmIGluZGVudCgpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHsga2V5LCB2YWx1ZSB9ID0gcHJvcGVydGllc1tpXTsKICAgICAgICAgIC8vIGtleQogICAgICAgICAgZ2VuRXhwcmVzc2lvbkFzUHJvcGVydHlLZXkoa2V5LCBjb250ZXh0KTsKICAgICAgICAgIHB1c2goYDogYCk7CiAgICAgICAgICAvLyB2YWx1ZQogICAgICAgICAgZ2VuTm9kZSh2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgICBpZiAoaSA8IHByb3BlcnRpZXMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIC8vIHdpbGwgb25seSByZWFjaCB0aGlzIGlmIGl0J3MgbXVsdGlsaW5lcwogICAgICAgICAgICAgIHB1c2goYCxgKTsKICAgICAgICAgICAgICBuZXdsaW5lKCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgbXVsdGlsaW5lcyAmJiBkZWluZGVudCgpOwogICAgICBwdXNoKG11bHRpbGluZXMgPyBgfWAgOiBgIH1gKTsKICB9CiAgZnVuY3Rpb24gZ2VuQXJyYXlFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsKICAgICAgZ2VuTm9kZUxpc3RBc0FycmF5KG5vZGUuZWxlbWVudHMsIGNvbnRleHQpOwogIH0KICBmdW5jdGlvbiBnZW5GdW5jdGlvbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgICBjb25zdCB7IHB1c2gsIGluZGVudCwgZGVpbmRlbnQgfSA9IGNvbnRleHQ7CiAgICAgIGNvbnN0IHsgcGFyYW1zLCByZXR1cm5zLCBib2R5LCBuZXdsaW5lLCBpc1Nsb3QgfSA9IG5vZGU7CiAgICAgIGlmIChpc1Nsb3QpIHsKICAgICAgICAgIC8vIHdyYXAgc2xvdCBmdW5jdGlvbnMgd2l0aCBvd25lciBjb250ZXh0CiAgICAgICAgICBwdXNoKGBfJHtoZWxwZXJOYW1lTWFwW1dJVEhfQ1RYXX0oYCk7CiAgICAgIH0KICAgICAgcHVzaChgKGAsIG5vZGUpOwogICAgICBpZiAoaXNBcnJheShwYXJhbXMpKSB7CiAgICAgICAgICBnZW5Ob2RlTGlzdChwYXJhbXMsIGNvbnRleHQpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHBhcmFtcykgewogICAgICAgICAgZ2VuTm9kZShwYXJhbXMsIGNvbnRleHQpOwogICAgICB9CiAgICAgIHB1c2goYCkgPT4gYCk7CiAgICAgIGlmIChuZXdsaW5lIHx8IGJvZHkpIHsKICAgICAgICAgIHB1c2goYHtgKTsKICAgICAgICAgIGluZGVudCgpOwogICAgICB9CiAgICAgIGlmIChyZXR1cm5zKSB7CiAgICAgICAgICBpZiAobmV3bGluZSkgewogICAgICAgICAgICAgIHB1c2goYHJldHVybiBgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0FycmF5KHJldHVybnMpKSB7CiAgICAgICAgICAgICAgZ2VuTm9kZUxpc3RBc0FycmF5KHJldHVybnMsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgZ2VuTm9kZShyZXR1cm5zLCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChib2R5KSB7CiAgICAgICAgICBnZW5Ob2RlKGJvZHksIGNvbnRleHQpOwogICAgICB9CiAgICAgIGlmIChuZXdsaW5lIHx8IGJvZHkpIHsKICAgICAgICAgIGRlaW5kZW50KCk7CiAgICAgICAgICBwdXNoKGB9YCk7CiAgICAgIH0KICAgICAgaWYgKGlzU2xvdCkgewogICAgICAgICAgcHVzaChgKWApOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbkNvbmRpdGlvbmFsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgdGVzdCwgY29uc2VxdWVudCwgYWx0ZXJuYXRlLCBuZXdsaW5lOiBuZWVkTmV3bGluZSB9ID0gbm9kZTsKICAgICAgY29uc3QgeyBwdXNoLCBpbmRlbnQsIGRlaW5kZW50LCBuZXdsaW5lIH0gPSBjb250ZXh0OwogICAgICBpZiAodGVzdC50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICBjb25zdCBuZWVkc1BhcmVucyA9ICFpc1NpbXBsZUlkZW50aWZpZXIodGVzdC5jb250ZW50KTsKICAgICAgICAgIG5lZWRzUGFyZW5zICYmIHB1c2goYChgKTsKICAgICAgICAgIGdlbkV4cHJlc3Npb24odGVzdCwgY29udGV4dCk7CiAgICAgICAgICBuZWVkc1BhcmVucyAmJiBwdXNoKGApYCk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBwdXNoKGAoYCk7CiAgICAgICAgICBnZW5Ob2RlKHRlc3QsIGNvbnRleHQpOwogICAgICAgICAgcHVzaChgKWApOwogICAgICB9CiAgICAgIG5lZWROZXdsaW5lICYmIGluZGVudCgpOwogICAgICBjb250ZXh0LmluZGVudExldmVsKys7CiAgICAgIG5lZWROZXdsaW5lIHx8IHB1c2goYCBgKTsKICAgICAgcHVzaChgPyBgKTsKICAgICAgZ2VuTm9kZShjb25zZXF1ZW50LCBjb250ZXh0KTsKICAgICAgY29udGV4dC5pbmRlbnRMZXZlbC0tOwogICAgICBuZWVkTmV3bGluZSAmJiBuZXdsaW5lKCk7CiAgICAgIG5lZWROZXdsaW5lIHx8IHB1c2goYCBgKTsKICAgICAgcHVzaChgOiBgKTsKICAgICAgY29uc3QgaXNOZXN0ZWQgPSBhbHRlcm5hdGUudHlwZSA9PT0gMTkgLyogSlNfQ09ORElUSU9OQUxfRVhQUkVTU0lPTiAqLzsKICAgICAgaWYgKCFpc05lc3RlZCkgewogICAgICAgICAgY29udGV4dC5pbmRlbnRMZXZlbCsrOwogICAgICB9CiAgICAgIGdlbk5vZGUoYWx0ZXJuYXRlLCBjb250ZXh0KTsKICAgICAgaWYgKCFpc05lc3RlZCkgewogICAgICAgICAgY29udGV4dC5pbmRlbnRMZXZlbC0tOwogICAgICB9CiAgICAgIG5lZWROZXdsaW5lICYmIGRlaW5kZW50KHRydWUgLyogd2l0aG91dCBuZXdsaW5lICovKTsKICB9CiAgZnVuY3Rpb24gZ2VuQ2FjaGVFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsKICAgICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIGluZGVudCwgZGVpbmRlbnQsIG5ld2xpbmUgfSA9IGNvbnRleHQ7CiAgICAgIHB1c2goYF9jYWNoZVske25vZGUuaW5kZXh9XSB8fCAoYCk7CiAgICAgIGlmIChub2RlLmlzVk5vZGUpIHsKICAgICAgICAgIGluZGVudCgpOwogICAgICAgICAgcHVzaChgJHtoZWxwZXIoU0VUX0JMT0NLX1RSQUNLSU5HKX0oLTEpLGApOwogICAgICAgICAgbmV3bGluZSgpOwogICAgICB9CiAgICAgIHB1c2goYF9jYWNoZVske25vZGUuaW5kZXh9XSA9IGApOwogICAgICBnZW5Ob2RlKG5vZGUudmFsdWUsIGNvbnRleHQpOwogICAgICBpZiAobm9kZS5pc1ZOb2RlKSB7CiAgICAgICAgICBwdXNoKGAsYCk7CiAgICAgICAgICBuZXdsaW5lKCk7CiAgICAgICAgICBwdXNoKGAke2hlbHBlcihTRVRfQkxPQ0tfVFJBQ0tJTkcpfSgxKSxgKTsKICAgICAgICAgIG5ld2xpbmUoKTsKICAgICAgICAgIHB1c2goYF9jYWNoZVske25vZGUuaW5kZXh9XWApOwogICAgICAgICAgZGVpbmRlbnQoKTsKICAgICAgfQogICAgICBwdXNoKGApYCk7CiAgfQoKICAvLyB0aGVzZSBrZXl3b3JkcyBzaG91bGQgbm90IGFwcGVhciBpbnNpZGUgZXhwcmVzc2lvbnMsIGJ1dCBvcGVyYXRvcnMgbGlrZQogIC8vIHR5cGVvZiwgaW5zdGFuY2VvZiBhbmQgaW4gYXJlIGFsbG93ZWQKICBjb25zdCBwcm9oaWJpdGVkS2V5d29yZFJFID0gbmV3IFJlZ0V4cCgnXFxiJyArCiAgICAgICgnZG8saWYsZm9yLGxldCxuZXcsdHJ5LHZhcixjYXNlLGVsc2Usd2l0aCxhd2FpdCxicmVhayxjYXRjaCxjbGFzcyxjb25zdCwnICsKICAgICAgICAgICdzdXBlcix0aHJvdyx3aGlsZSx5aWVsZCxkZWxldGUsZXhwb3J0LGltcG9ydCxyZXR1cm4sc3dpdGNoLGRlZmF1bHQsJyArCiAgICAgICAgICAnZXh0ZW5kcyxmaW5hbGx5LGNvbnRpbnVlLGRlYnVnZ2VyLGZ1bmN0aW9uLGFyZ3VtZW50cyx0eXBlb2Ysdm9pZCcpCiAgICAgICAgICAuc3BsaXQoJywnKQogICAgICAgICAgLmpvaW4oJ1xcYnxcXGInKSArCiAgICAgICdcXGInKTsKICAvLyBzdHJpcCBzdHJpbmdzIGluIGV4cHJlc3Npb25zCiAgY29uc3Qgc3RyaXBTdHJpbmdSRSA9IC8nKD86W14nXFxdfFxcLikqJ3wiKD86W14iXFxdfFxcLikqInxgKD86W15gXFxdfFxcLikqXCRce3xcfSg/OlteYFxcXXxcXC4pKmB8YCg/OlteYFxcXXxcXC4pKmAvZzsKICAvKioKICAgKiBWYWxpZGF0ZSBhIG5vbi1wcmVmaXhlZCBleHByZXNzaW9uLgogICAqIFRoaXMgaXMgb25seSBjYWxsZWQgd2hlbiB1c2luZyB0aGUgaW4tYnJvd3NlciBydW50aW1lIGNvbXBpbGVyIHNpbmNlIGl0CiAgICogZG9lc24ndCBwcmVmaXggZXhwcmVzc2lvbnMuCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbihub2RlLCBjb250ZXh0LCBhc1BhcmFtcyA9IGZhbHNlLCBhc1Jhd1N0YXRlbWVudHMgPSBmYWxzZSkgewogICAgICBjb25zdCBleHAgPSBub2RlLmNvbnRlbnQ7CiAgICAgIC8vIGVtcHR5IGV4cHJlc3Npb25zIGFyZSB2YWxpZGF0ZWQgcGVyLWRpcmVjdGl2ZSBzaW5jZSBzb21lIGRpcmVjdGl2ZXMKICAgICAgLy8gZG8gYWxsb3cgZW1wdHkgZXhwcmVzc2lvbnMuCiAgICAgIGlmICghZXhwLnRyaW0oKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICBuZXcgRnVuY3Rpb24oYXNSYXdTdGF0ZW1lbnRzCiAgICAgICAgICAgICAgPyBgICR7ZXhwfSBgCiAgICAgICAgICAgICAgOiBgcmV0dXJuICR7YXNQYXJhbXMgPyBgKCR7ZXhwfSkgPT4ge31gIDogYCgke2V4cH0pYH1gKTsKICAgICAgfQogICAgICBjYXRjaCAoZSkgewogICAgICAgICAgbGV0IG1lc3NhZ2UgPSBlLm1lc3NhZ2U7CiAgICAgICAgICBjb25zdCBrZXl3b3JkTWF0Y2ggPSBleHAKICAgICAgICAgICAgICAucmVwbGFjZShzdHJpcFN0cmluZ1JFLCAnJykKICAgICAgICAgICAgICAubWF0Y2gocHJvaGliaXRlZEtleXdvcmRSRSk7CiAgICAgICAgICBpZiAoa2V5d29yZE1hdGNoKSB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGBhdm9pZCB1c2luZyBKYXZhU2NyaXB0IGtleXdvcmQgYXMgcHJvcGVydHkgbmFtZTogIiR7a2V5d29yZE1hdGNoWzBdfSJgOwogICAgICAgICAgfQogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDQgLyogWF9JTlZBTElEX0VYUFJFU1NJT04gKi8sIG5vZGUubG9jLCB1bmRlZmluZWQsIG1lc3NhZ2UpKTsKICAgICAgfQogIH0KCiAgY29uc3QgdHJhbnNmb3JtRXhwcmVzc2lvbiA9IChub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDUgLyogSU5URVJQT0xBVElPTiAqLykgewogICAgICAgICAgbm9kZS5jb250ZW50ID0gcHJvY2Vzc0V4cHJlc3Npb24obm9kZS5jb250ZW50LCBjb250ZXh0KTsKICAgICAgfQogICAgICBlbHNlIGlmIChub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgLy8gaGFuZGxlIGRpcmVjdGl2ZXMgb24gZWxlbWVudAogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgZGlyID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICAgICAgICAvLyBkbyBub3QgcHJvY2VzcyBmb3Igdi1vbiAmIHYtZm9yIHNpbmNlIHRoZXkgYXJlIHNwZWNpYWwgaGFuZGxlZAogICAgICAgICAgICAgIGlmIChkaXIudHlwZSA9PT0gNyAvKiBESVJFQ1RJVkUgKi8gJiYgZGlyLm5hbWUgIT09ICdmb3InKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV4cCA9IGRpci5leHA7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGFyZyA9IGRpci5hcmc7CiAgICAgICAgICAgICAgICAgIC8vIGRvIG5vdCBwcm9jZXNzIGV4cCBpZiB0aGlzIGlzIHYtb246YXJnIC0gd2UgbmVlZCBzcGVjaWFsIGhhbmRsaW5nCiAgICAgICAgICAgICAgICAgIC8vIGZvciB3cmFwcGluZyBpbmxpbmUgc3RhdGVtZW50cy4KICAgICAgICAgICAgICAgICAgaWYgKGV4cCAmJgogICAgICAgICAgICAgICAgICAgICAgZXhwLnR5cGUgPT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8gJiYKICAgICAgICAgICAgICAgICAgICAgICEoZGlyLm5hbWUgPT09ICdvbicgJiYgYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgZGlyLmV4cCA9IHByb2Nlc3NFeHByZXNzaW9uKGV4cCwgY29udGV4dCwgCiAgICAgICAgICAgICAgICAgICAgICAvLyBzbG90IGFyZ3MgbXVzdCBiZSBwcm9jZXNzZWQgYXMgZnVuY3Rpb24gcGFyYW1zCiAgICAgICAgICAgICAgICAgICAgICBkaXIubmFtZSA9PT0gJ3Nsb3QnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYXJnICYmIGFyZy50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmICFhcmcuaXNTdGF0aWMpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpci5hcmcgPSBwcm9jZXNzRXhwcmVzc2lvbihhcmcsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgfTsKICAvLyBJbXBvcnRhbnQ6IHNpbmNlIHRoaXMgZnVuY3Rpb24gdXNlcyBOb2RlLmpzIG9ubHkgZGVwZW5kZW5jaWVzLCBpdCBzaG91bGQKICAvLyBhbHdheXMgYmUgdXNlZCB3aXRoIGEgbGVhZGluZyAhdHJ1ZSBjaGVjayBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHRyZWUtc2hha2VuIGZyb20gdGhlIGJyb3dzZXIgYnVpbGQuCiAgZnVuY3Rpb24gcHJvY2Vzc0V4cHJlc3Npb24obm9kZSwgY29udGV4dCwgCiAgLy8gc29tZSBleHByZXNzaW9ucyBsaWtlIHYtc2xvdCBwcm9wcyAmIHYtZm9yIGFsaWFzZXMgc2hvdWxkIGJlIHBhcnNlZCBhcwogIC8vIGZ1bmN0aW9uIHBhcmFtcwogIGFzUGFyYW1zID0gZmFsc2UsIAogIC8vIHYtb24gaGFuZGxlciB2YWx1ZXMgbWF5IGNvbnRhaW4gbXVsdGlwbGUgc3RhdGVtZW50cwogIGFzUmF3U3RhdGVtZW50cyA9IGZhbHNlLCBsb2NhbFZhcnMgPSBPYmplY3QuY3JlYXRlKGNvbnRleHQuaWRlbnRpZmllcnMpKSB7CiAgICAgIHsKICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBzaW1wbGUgaW4tYnJvd3NlciB2YWxpZGF0aW9uIChzYW1lIGxvZ2ljIGluIDIueCkKICAgICAgICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQsIGFzUGFyYW1zLCBhc1Jhd1N0YXRlbWVudHMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH0KICB9CgogIGNvbnN0IHRyYW5zZm9ybUlmID0gY3JlYXRlU3RydWN0dXJhbERpcmVjdGl2ZVRyYW5zZm9ybSgvXihpZnxlbHNlfGVsc2UtaWYpJC8sIChub2RlLCBkaXIsIGNvbnRleHQpID0+IHsKICAgICAgcmV0dXJuIHByb2Nlc3NJZihub2RlLCBkaXIsIGNvbnRleHQsIChpZk5vZGUsIGJyYW5jaCwgaXNSb290KSA9PiB7CiAgICAgICAgICAvLyAjMTU4NzogV2UgbmVlZCB0byBkeW5hbWljYWxseSBpbmNyZW1lbnQgdGhlIGtleSBiYXNlZCBvbiB0aGUgY3VycmVudAogICAgICAgICAgLy8gbm9kZSdzIHNpYmxpbmcgbm9kZXMsIHNpbmNlIGNoYWluZWQgdi1pZi9lbHNlIGJyYW5jaGVzIGFyZQogICAgICAgICAgLy8gcmVuZGVyZWQgYXQgdGhlIHNhbWUgZGVwdGgKICAgICAgICAgIGNvbnN0IHNpYmxpbmdzID0gY29udGV4dC5wYXJlbnQuY2hpbGRyZW47CiAgICAgICAgICBsZXQgaSA9IHNpYmxpbmdzLmluZGV4T2YoaWZOb2RlKTsKICAgICAgICAgIGxldCBrZXkgPSAwOwogICAgICAgICAgd2hpbGUgKGktLSA+PSAwKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2libGluZyA9IHNpYmxpbmdzW2ldOwogICAgICAgICAgICAgIGlmIChzaWJsaW5nICYmIHNpYmxpbmcudHlwZSA9PT0gOSAvKiBJRiAqLykgewogICAgICAgICAgICAgICAgICBrZXkgKz0gc2libGluZy5icmFuY2hlcy5sZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gRXhpdCBjYWxsYmFjay4gQ29tcGxldGUgdGhlIGNvZGVnZW5Ob2RlIHdoZW4gYWxsIGNoaWxkcmVuIGhhdmUgYmVlbgogICAgICAgICAgLy8gdHJhbnNmb3JtZWQuCiAgICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICAgIGlmIChpc1Jvb3QpIHsKICAgICAgICAgICAgICAgICAgaWZOb2RlLmNvZGVnZW5Ob2RlID0gY3JlYXRlQ29kZWdlbk5vZGVGb3JCcmFuY2goYnJhbmNoLCBrZXksIGNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gYXR0YWNoIHRoaXMgYnJhbmNoJ3MgY29kZWdlbiBub2RlIHRvIHRoZSB2LWlmIHJvb3QuCiAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudENvbmRpdGlvbiA9IGdldFBhcmVudENvbmRpdGlvbihpZk5vZGUuY29kZWdlbk5vZGUpOwogICAgICAgICAgICAgICAgICBwYXJlbnRDb25kaXRpb24uYWx0ZXJuYXRlID0gY3JlYXRlQ29kZWdlbk5vZGVGb3JCcmFuY2goYnJhbmNoLCBrZXkgKyBpZk5vZGUuYnJhbmNoZXMubGVuZ3RoIC0gMSwgY29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgfSk7CiAgfSk7CiAgLy8gdGFyZ2V0LWFnbm9zdGljIHRyYW5zZm9ybSB1c2VkIGZvciBib3RoIENsaWVudCBhbmQgU1NSCiAgZnVuY3Rpb24gcHJvY2Vzc0lmKG5vZGUsIGRpciwgY29udGV4dCwgcHJvY2Vzc0NvZGVnZW4pIHsKICAgICAgaWYgKGRpci5uYW1lICE9PSAnZWxzZScgJiYKICAgICAgICAgICghZGlyLmV4cCB8fCAhZGlyLmV4cC5jb250ZW50LnRyaW0oKSkpIHsKICAgICAgICAgIGNvbnN0IGxvYyA9IGRpci5leHAgPyBkaXIuZXhwLmxvYyA6IG5vZGUubG9jOwogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMjggLyogWF9WX0lGX05PX0VYUFJFU1NJT04gKi8sIGRpci5sb2MpKTsKICAgICAgICAgIGRpci5leHAgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB0cnVlYCwgZmFsc2UsIGxvYyk7CiAgICAgIH0KICAgICAgaWYgKGRpci5leHApIHsKICAgICAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24oZGlyLmV4cCwgY29udGV4dCk7CiAgICAgIH0KICAgICAgaWYgKGRpci5uYW1lID09PSAnaWYnKSB7CiAgICAgICAgICBjb25zdCBicmFuY2ggPSBjcmVhdGVJZkJyYW5jaChub2RlLCBkaXIpOwogICAgICAgICAgY29uc3QgaWZOb2RlID0gewogICAgICAgICAgICAgIHR5cGU6IDkgLyogSUYgKi8sCiAgICAgICAgICAgICAgbG9jOiBub2RlLmxvYywKICAgICAgICAgICAgICBicmFuY2hlczogW2JyYW5jaF0KICAgICAgICAgIH07CiAgICAgICAgICBjb250ZXh0LnJlcGxhY2VOb2RlKGlmTm9kZSk7CiAgICAgICAgICBpZiAocHJvY2Vzc0NvZGVnZW4pIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NvZGVnZW4oaWZOb2RlLCBicmFuY2gsIHRydWUpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgLy8gbG9jYXRlIHRoZSBhZGphY2VudCB2LWlmCiAgICAgICAgICBjb25zdCBzaWJsaW5ncyA9IGNvbnRleHQucGFyZW50LmNoaWxkcmVuOwogICAgICAgICAgY29uc3QgY29tbWVudHMgPSBbXTsKICAgICAgICAgIGxldCBpID0gc2libGluZ3MuaW5kZXhPZihub2RlKTsKICAgICAgICAgIHdoaWxlIChpLS0gPj0gLTEpIHsKICAgICAgICAgICAgICBjb25zdCBzaWJsaW5nID0gc2libGluZ3NbaV07CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgJiYgc2libGluZy50eXBlID09PSAzIC8qIENPTU1FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5yZW1vdmVOb2RlKHNpYmxpbmcpOwogICAgICAgICAgICAgICAgICBjb21tZW50cy51bnNoaWZ0KHNpYmxpbmcpOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgJiYKICAgICAgICAgICAgICAgICAgc2libGluZy50eXBlID09PSAyIC8qIFRFWFQgKi8gJiYKICAgICAgICAgICAgICAgICAgIXNpYmxpbmcuY29udGVudC50cmltKCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlTm9kZShzaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaWJsaW5nICYmIHNpYmxpbmcudHlwZSA9PT0gOSAvKiBJRiAqLykgewogICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB2LWVsc2Ugd2FzIGZvbGxvd2VkIGJ5IHYtZWxzZS1pZgogICAgICAgICAgICAgICAgICBpZiAoZGlyLm5hbWUgPT09ICdlbHNlLWlmJyAmJgogICAgICAgICAgICAgICAgICAgICAgc2libGluZy5icmFuY2hlc1tzaWJsaW5nLmJyYW5jaGVzLmxlbmd0aCAtIDFdLmNvbmRpdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcigzMCAvKiBYX1ZfRUxTRV9OT19BREpBQ0VOVF9JRiAqLywgbm9kZS5sb2MpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBtb3ZlIHRoZSBub2RlIHRvIHRoZSBpZiBub2RlJ3MgYnJhbmNoZXMKICAgICAgICAgICAgICAgICAgY29udGV4dC5yZW1vdmVOb2RlKCk7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGJyYW5jaCA9IGNyZWF0ZUlmQnJhbmNoKG5vZGUsIGRpcik7CiAgICAgICAgICAgICAgICAgIGlmIChjb21tZW50cy5sZW5ndGggJiYKICAgICAgICAgICAgICAgICAgICAgIC8vICMzNjE5IGlnbm9yZSBjb21tZW50cyBpZiB0aGUgdi1pZiBpcyBkaXJlY3QgY2hpbGQgb2YgPHRyYW5zaXRpb24+CiAgICAgICAgICAgICAgICAgICAgICAhKGNvbnRleHQucGFyZW50ICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5wYXJlbnQudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgaXNCdWlsdEluVHlwZShjb250ZXh0LnBhcmVudC50YWcsICd0cmFuc2l0aW9uJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmFuY2guY2hpbGRyZW4gPSBbLi4uY29tbWVudHMsIC4uLmJyYW5jaC5jaGlsZHJlbl07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdXNlciBpcyBmb3JjaW5nIHNhbWUga2V5IG9uIGRpZmZlcmVudCBicmFuY2hlcwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBicmFuY2gudXNlcktleTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzaWJsaW5nLmJyYW5jaGVzLmZvckVhY2goKHsgdXNlcktleSB9KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1NhbWVLZXkodXNlcktleSwga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMjkgLyogWF9WX0lGX1NBTUVfS0VZICovLCBicmFuY2gudXNlcktleS5sb2MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcuYnJhbmNoZXMucHVzaChicmFuY2gpOwogICAgICAgICAgICAgICAgICBjb25zdCBvbkV4aXQgPSBwcm9jZXNzQ29kZWdlbiAmJiBwcm9jZXNzQ29kZWdlbihzaWJsaW5nLCBicmFuY2gsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgLy8gc2luY2UgdGhlIGJyYW5jaCB3YXMgcmVtb3ZlZCwgaXQgd2lsbCBub3QgYmUgdHJhdmVyc2VkLgogICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgdG8gdHJhdmVyc2UgaGVyZS4KICAgICAgICAgICAgICAgICAgdHJhdmVyc2VOb2RlKGJyYW5jaCwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgIC8vIGNhbGwgb24gZXhpdAogICAgICAgICAgICAgICAgICBpZiAob25FeGl0KQogICAgICAgICAgICAgICAgICAgICAgb25FeGl0KCk7CiAgICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0byByZXNldCBjdXJyZW50Tm9kZSBhZnRlciB0cmF2ZXJzYWwgdG8gaW5kaWNhdGUgdGhpcwogICAgICAgICAgICAgICAgICAvLyBub2RlIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgICAgICAgIGNvbnRleHQuY3VycmVudE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzAgLyogWF9WX0VMU0VfTk9fQURKQUNFTlRfSUYgKi8sIG5vZGUubG9jKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUlmQnJhbmNoKG5vZGUsIGRpcikgewogICAgICBjb25zdCBpc1RlbXBsYXRlSWYgPSBub2RlLnRhZ1R5cGUgPT09IDMgLyogVEVNUExBVEUgKi87CiAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAxMCAvKiBJRl9CUkFOQ0ggKi8sCiAgICAgICAgICBsb2M6IG5vZGUubG9jLAogICAgICAgICAgY29uZGl0aW9uOiBkaXIubmFtZSA9PT0gJ2Vsc2UnID8gdW5kZWZpbmVkIDogZGlyLmV4cCwKICAgICAgICAgIGNoaWxkcmVuOiBpc1RlbXBsYXRlSWYgJiYgIWZpbmREaXIobm9kZSwgJ2ZvcicpID8gbm9kZS5jaGlsZHJlbiA6IFtub2RlXSwKICAgICAgICAgIHVzZXJLZXk6IGZpbmRQcm9wKG5vZGUsIGBrZXlgKSwKICAgICAgICAgIGlzVGVtcGxhdGVJZgogICAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVDb2RlZ2VuTm9kZUZvckJyYW5jaChicmFuY2gsIGtleUluZGV4LCBjb250ZXh0KSB7CiAgICAgIGlmIChicmFuY2guY29uZGl0aW9uKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ29uZGl0aW9uYWxFeHByZXNzaW9uKGJyYW5jaC5jb25kaXRpb24sIGNyZWF0ZUNoaWxkcmVuQ29kZWdlbk5vZGUoYnJhbmNoLCBrZXlJbmRleCwgY29udGV4dCksIAogICAgICAgICAgLy8gbWFrZSBzdXJlIHRvIHBhc3MgaW4gYXNCbG9jazogdHJ1ZSBzbyB0aGF0IHRoZSBjb21tZW50IG5vZGUgY2FsbAogICAgICAgICAgLy8gY2xvc2VzIHRoZSBjdXJyZW50IGJsb2NrLgogICAgICAgICAgY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoQ1JFQVRFX0NPTU1FTlQpLCBbCiAgICAgICAgICAgICAgJyJ2LWlmIicgLAogICAgICAgICAgICAgICd0cnVlJwogICAgICAgICAgXSkpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkcmVuQ29kZWdlbk5vZGUoYnJhbmNoLCBrZXlJbmRleCwgY29udGV4dCk7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2hpbGRyZW5Db2RlZ2VuTm9kZShicmFuY2gsIGtleUluZGV4LCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IHsgaGVscGVyIH0gPSBjb250ZXh0OwogICAgICBjb25zdCBrZXlQcm9wZXJ0eSA9IGNyZWF0ZU9iamVjdFByb3BlcnR5KGBrZXlgLCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGAke2tleUluZGV4fWAsIGZhbHNlLCBsb2NTdHViLCAyIC8qIENBTl9IT0lTVCAqLykpOwogICAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSBicmFuY2g7CiAgICAgIGNvbnN0IGZpcnN0Q2hpbGQgPSBjaGlsZHJlblswXTsKICAgICAgY29uc3QgbmVlZEZyYWdtZW50V3JhcHBlciA9IGNoaWxkcmVuLmxlbmd0aCAhPT0gMSB8fCBmaXJzdENoaWxkLnR5cGUgIT09IDEgLyogRUxFTUVOVCAqLzsKICAgICAgaWYgKG5lZWRGcmFnbWVudFdyYXBwZXIpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYgZmlyc3RDaGlsZC50eXBlID09PSAxMSAvKiBGT1IgKi8pIHsKICAgICAgICAgICAgICAvLyBvcHRpbWl6ZSBhd2F5IG5lc3RlZCBmcmFnbWVudHMgd2hlbiBjaGlsZCBpcyBhIEZvck5vZGUKICAgICAgICAgICAgICBjb25zdCB2bm9kZUNhbGwgPSBmaXJzdENoaWxkLmNvZGVnZW5Ob2RlOwogICAgICAgICAgICAgIGluamVjdFByb3Aodm5vZGVDYWxsLCBrZXlQcm9wZXJ0eSwgY29udGV4dCk7CiAgICAgICAgICAgICAgcmV0dXJuIHZub2RlQ2FsbDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGxldCBwYXRjaEZsYWcgPSA2NCAvKiBTVEFCTEVfRlJBR01FTlQgKi87CiAgICAgICAgICAgICAgbGV0IHBhdGNoRmxhZ1RleHQgPSBQYXRjaEZsYWdOYW1lc1s2NCAvKiBTVEFCTEVfRlJBR01FTlQgKi9dOwogICAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZSBmcmFnbWVudCBhY3R1YWxseSBjb250YWlucyBhIHNpbmdsZSB2YWxpZCBjaGlsZCB3aXRoCiAgICAgICAgICAgICAgLy8gdGhlIHJlc3QgYmVpbmcgY29tbWVudHMKICAgICAgICAgICAgICBpZiAoIWJyYW5jaC5pc1RlbXBsYXRlSWYgJiYKICAgICAgICAgICAgICAgICAgY2hpbGRyZW4uZmlsdGVyKGMgPT4gYy50eXBlICE9PSAzIC8qIENPTU1FTlQgKi8pLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICBwYXRjaEZsYWcgfD0gMjA0OCAvKiBERVZfUk9PVF9GUkFHTUVOVCAqLzsKICAgICAgICAgICAgICAgICAgcGF0Y2hGbGFnVGV4dCArPSBgLCAke1BhdGNoRmxhZ05hbWVzWzIwNDggLyogREVWX1JPT1RfRlJBR01FTlQgKi9dfWA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZUNhbGwoY29udGV4dCwgaGVscGVyKEZSQUdNRU5UKSwgY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihba2V5UHJvcGVydHldKSwgY2hpbGRyZW4sIHBhdGNoRmxhZyArIChgIC8qICR7cGF0Y2hGbGFnVGV4dH0gKi9gICksIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlLCBmYWxzZSwgZmFsc2UgLyogaXNDb21wb25lbnQgKi8sIGJyYW5jaC5sb2MpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY29uc3QgcmV0ID0gZmlyc3RDaGlsZC5jb2RlZ2VuTm9kZTsKICAgICAgICAgIGNvbnN0IHZub2RlQ2FsbCA9IGdldE1lbW9lZFZOb2RlQ2FsbChyZXQpOwogICAgICAgICAgLy8gQ2hhbmdlIGNyZWF0ZVZOb2RlIHRvIGNyZWF0ZUJsb2NrLgogICAgICAgICAgaWYgKHZub2RlQ2FsbC50eXBlID09PSAxMyAvKiBWTk9ERV9DQUxMICovKSB7CiAgICAgICAgICAgICAgbWFrZUJsb2NrKHZub2RlQ2FsbCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBpbmplY3QgYnJhbmNoIGtleQogICAgICAgICAgaW5qZWN0UHJvcCh2bm9kZUNhbGwsIGtleVByb3BlcnR5LCBjb250ZXh0KTsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gaXNTYW1lS2V5KGEsIGIpIHsKICAgICAgaWYgKCFhIHx8IGEudHlwZSAhPT0gYi50eXBlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKGEudHlwZSA9PT0gNiAvKiBBVFRSSUJVVEUgKi8pIHsKICAgICAgICAgIGlmIChhLnZhbHVlLmNvbnRlbnQgIT09IGIudmFsdWUuY29udGVudCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZQogICAgICAgICAgY29uc3QgZXhwID0gYS5leHA7CiAgICAgICAgICBjb25zdCBicmFuY2hFeHAgPSBiLmV4cDsKICAgICAgICAgIGlmIChleHAudHlwZSAhPT0gYnJhbmNoRXhwLnR5cGUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwLnR5cGUgIT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8gfHwKICAgICAgICAgICAgICBleHAuaXNTdGF0aWMgIT09IGJyYW5jaEV4cC5pc1N0YXRpYyB8fAogICAgICAgICAgICAgIGV4cC5jb250ZW50ICE9PSBicmFuY2hFeHAuY29udGVudCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gZ2V0UGFyZW50Q29uZGl0aW9uKG5vZGUpIHsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGlmIChub2RlLnR5cGUgPT09IDE5IC8qIEpTX0NPTkRJVElPTkFMX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgICAgICBpZiAobm9kZS5hbHRlcm5hdGUudHlwZSA9PT0gMTkgLyogSlNfQ09ORElUSU9OQUxfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChub2RlLnR5cGUgPT09IDIwIC8qIEpTX0NBQ0hFX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgICAgICBub2RlID0gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgfQogIH0KCiAgY29uc3QgdHJhbnNmb3JtRm9yID0gY3JlYXRlU3RydWN0dXJhbERpcmVjdGl2ZVRyYW5zZm9ybSgnZm9yJywgKG5vZGUsIGRpciwgY29udGV4dCkgPT4gewogICAgICBjb25zdCB7IGhlbHBlciwgcmVtb3ZlSGVscGVyIH0gPSBjb250ZXh0OwogICAgICByZXR1cm4gcHJvY2Vzc0Zvcihub2RlLCBkaXIsIGNvbnRleHQsIGZvck5vZGUgPT4gewogICAgICAgICAgLy8gY3JlYXRlIHRoZSBsb29wIHJlbmRlciBmdW5jdGlvbiBleHByZXNzaW9uIG5vdywgYW5kIGFkZCB0aGUKICAgICAgICAgIC8vIGl0ZXJhdG9yIG9uIGV4aXQgYWZ0ZXIgYWxsIGNoaWxkcmVuIGhhdmUgYmVlbiB0cmF2ZXJzZWQKICAgICAgICAgIGNvbnN0IHJlbmRlckV4cCA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGhlbHBlcihSRU5ERVJfTElTVCksIFsKICAgICAgICAgICAgICBmb3JOb2RlLnNvdXJjZQogICAgICAgICAgXSk7CiAgICAgICAgICBjb25zdCBpc1RlbXBsYXRlID0gaXNUZW1wbGF0ZU5vZGUobm9kZSk7CiAgICAgICAgICBjb25zdCBtZW1vID0gZmluZERpcihub2RlLCAnbWVtbycpOwogICAgICAgICAgY29uc3Qga2V5UHJvcCA9IGZpbmRQcm9wKG5vZGUsIGBrZXlgKTsKICAgICAgICAgIGNvbnN0IGtleUV4cCA9IGtleVByb3AgJiYKICAgICAgICAgICAgICAoa2V5UHJvcC50eXBlID09PSA2IC8qIEFUVFJJQlVURSAqLwogICAgICAgICAgICAgICAgICA/IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oa2V5UHJvcC52YWx1ZS5jb250ZW50LCB0cnVlKQogICAgICAgICAgICAgICAgICA6IGtleVByb3AuZXhwKTsKICAgICAgICAgIGNvbnN0IGtleVByb3BlcnR5ID0ga2V5UHJvcCA/IGNyZWF0ZU9iamVjdFByb3BlcnR5KGBrZXlgLCBrZXlFeHApIDogbnVsbDsKICAgICAgICAgIGNvbnN0IGlzU3RhYmxlRnJhZ21lbnQgPSBmb3JOb2RlLnNvdXJjZS50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmCiAgICAgICAgICAgICAgZm9yTm9kZS5zb3VyY2UuY29uc3RUeXBlID4gMCAvKiBOT1RfQ09OU1RBTlQgKi87CiAgICAgICAgICBjb25zdCBmcmFnbWVudEZsYWcgPSBpc1N0YWJsZUZyYWdtZW50CiAgICAgICAgICAgICAgPyA2NCAvKiBTVEFCTEVfRlJBR01FTlQgKi8KICAgICAgICAgICAgICA6IGtleVByb3AKICAgICAgICAgICAgICAgICAgPyAxMjggLyogS0VZRURfRlJBR01FTlQgKi8KICAgICAgICAgICAgICAgICAgOiAyNTYgLyogVU5LRVlFRF9GUkFHTUVOVCAqLzsKICAgICAgICAgIGZvck5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVWTm9kZUNhbGwoY29udGV4dCwgaGVscGVyKEZSQUdNRU5UKSwgdW5kZWZpbmVkLCByZW5kZXJFeHAsIGZyYWdtZW50RmxhZyArCiAgICAgICAgICAgICAgKGAgLyogJHtQYXRjaEZsYWdOYW1lc1tmcmFnbWVudEZsYWddfSAqL2AgKSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgLyogaXNCbG9jayAqLywgIWlzU3RhYmxlRnJhZ21lbnQgLyogZGlzYWJsZVRyYWNraW5nICovLCBmYWxzZSAvKiBpc0NvbXBvbmVudCAqLywgbm9kZS5sb2MpOwogICAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgICAvLyBmaW5pc2ggdGhlIGNvZGVnZW4gbm93IHRoYXQgYWxsIGNoaWxkcmVuIGhhdmUgYmVlbiB0cmF2ZXJzZWQKICAgICAgICAgICAgICBsZXQgY2hpbGRCbG9jazsKICAgICAgICAgICAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSBmb3JOb2RlOwogICAgICAgICAgICAgIC8vIGNoZWNrIDx0ZW1wbGF0ZSB2LWZvcj4ga2V5IHBsYWNlbWVudAogICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4uc29tZShjID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGZpbmRQcm9wKGMsICdrZXknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDMzIC8qIFhfVl9GT1JfVEVNUExBVEVfS0VZX1BMQUNFTUVOVCAqLywga2V5LmxvYykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBuZWVkRnJhZ21lbnRXcmFwcGVyID0gY2hpbGRyZW4ubGVuZ3RoICE9PSAxIHx8IGNoaWxkcmVuWzBdLnR5cGUgIT09IDEgLyogRUxFTUVOVCAqLzsKICAgICAgICAgICAgICBjb25zdCBzbG90T3V0bGV0ID0gaXNTbG90T3V0bGV0KG5vZGUpCiAgICAgICAgICAgICAgICAgID8gbm9kZQogICAgICAgICAgICAgICAgICA6IGlzVGVtcGxhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmCiAgICAgICAgICAgICAgICAgICAgICBpc1Nsb3RPdXRsZXQobm9kZS5jaGlsZHJlblswXSkKICAgICAgICAgICAgICAgICAgICAgID8gbm9kZS5jaGlsZHJlblswXSAvLyBhcGktZXh0cmFjdG9yIHNvbWVob3cgZmFpbHMgdG8gaW5mZXIgdGhpcwogICAgICAgICAgICAgICAgICAgICAgOiBudWxsOwogICAgICAgICAgICAgIGlmIChzbG90T3V0bGV0KSB7CiAgICAgICAgICAgICAgICAgIC8vIDxzbG90IHYtZm9yPSIuLi4iPiBvciA8dGVtcGxhdGUgdi1mb3I9Ii4uLiI+PHNsb3QvPjwvdGVtcGxhdGU+CiAgICAgICAgICAgICAgICAgIGNoaWxkQmxvY2sgPSBzbG90T3V0bGV0LmNvZGVnZW5Ob2RlOwogICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZSAmJiBrZXlQcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgICAgICAgLy8gPHRlbXBsYXRlIHYtZm9yPSIuLi4iIDprZXk9Ii4uLiI+PHNsb3QvPjwvdGVtcGxhdGU+CiAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGluamVjdCB0aGUga2V5IHRvIHRoZSByZW5kZXJTbG90KCkgY2FsbC4KICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9wcyBmb3IgcmVuZGVyU2xvdCBpcyBwYXNzZWQgYXMgdGhlIDNyZCBhcmd1bWVudC4KICAgICAgICAgICAgICAgICAgICAgIGluamVjdFByb3AoY2hpbGRCbG9jaywga2V5UHJvcGVydHksIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKG5lZWRGcmFnbWVudFdyYXBwZXIpIHsKICAgICAgICAgICAgICAgICAgLy8gPHRlbXBsYXRlIHYtZm9yPSIuLi4iPiB3aXRoIHRleHQgb3IgbXVsdGktZWxlbWVudHMKICAgICAgICAgICAgICAgICAgLy8gc2hvdWxkIGdlbmVyYXRlIGEgZnJhZ21lbnQgYmxvY2sgZm9yIGVhY2ggbG9vcAogICAgICAgICAgICAgICAgICBjaGlsZEJsb2NrID0gY3JlYXRlVk5vZGVDYWxsKGNvbnRleHQsIGhlbHBlcihGUkFHTUVOVCksIGtleVByb3BlcnR5ID8gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihba2V5UHJvcGVydHldKSA6IHVuZGVmaW5lZCwgbm9kZS5jaGlsZHJlbiwgNjQgLyogU1RBQkxFX0ZSQUdNRU5UICovICsKICAgICAgICAgICAgICAgICAgICAgIChgIC8qICR7UGF0Y2hGbGFnTmFtZXNbNjQgLyogU1RBQkxFX0ZSQUdNRU5UICovXX0gKi9gCiAgICAgICAgICAgICAgICAgICAgICAgICAgKSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUsIHVuZGVmaW5lZCwgZmFsc2UgLyogaXNDb21wb25lbnQgKi8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsIGVsZW1lbnQgdi1mb3IuIERpcmVjdGx5IHVzZSB0aGUgY2hpbGQncyBjb2RlZ2VuTm9kZQogICAgICAgICAgICAgICAgICAvLyBidXQgbWFyayBpdCBhcyBhIGJsb2NrLgogICAgICAgICAgICAgICAgICBjaGlsZEJsb2NrID0gY2hpbGRyZW5bMF0KICAgICAgICAgICAgICAgICAgICAgIC5jb2RlZ2VuTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzVGVtcGxhdGUgJiYga2V5UHJvcGVydHkpIHsKICAgICAgICAgICAgICAgICAgICAgIGluamVjdFByb3AoY2hpbGRCbG9jaywga2V5UHJvcGVydHksIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZEJsb2NrLmlzQmxvY2sgIT09ICFpc1N0YWJsZUZyYWdtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRCbG9jay5pc0Jsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3dpdGNoIGZyb20gYmxvY2sgdG8gdm5vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVIZWxwZXIoT1BFTl9CTE9DSyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlSGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3dpdGNoIGZyb20gdm5vZGUgdG8gYmxvY2sKICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVIZWxwZXIoZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNoaWxkQmxvY2suaXNCbG9jayA9ICFpc1N0YWJsZUZyYWdtZW50OwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGRCbG9jay5pc0Jsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgICBoZWxwZXIoT1BFTl9CTE9DSyk7CiAgICAgICAgICAgICAgICAgICAgICBoZWxwZXIoZ2V0Vk5vZGVCbG9ja0hlbHBlcihjb250ZXh0LmluU1NSLCBjaGlsZEJsb2NrLmlzQ29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBoZWxwZXIoZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChtZW1vKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGxvb3AgPSBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oY3JlYXRlRm9yTG9vcFBhcmFtcyhmb3JOb2RlLnBhcnNlUmVzdWx0LCBbCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfY2FjaGVkYCkKICAgICAgICAgICAgICAgICAgXSkpOwogICAgICAgICAgICAgICAgICBsb29wLmJvZHkgPSBjcmVhdGVCbG9ja1N0YXRlbWVudChbCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2Bjb25zdCBfbWVtbyA9IChgLCBtZW1vLmV4cCwgYClgXSksCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWwogICAgICAgICAgICAgICAgICAgICAgICAgIGBpZiAoX2NhY2hlZGAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uKGtleUV4cCA/IFtgICYmIF9jYWNoZWQua2V5ID09PSBgLCBrZXlFeHBdIDogW10pLAogICAgICAgICAgICAgICAgICAgICAgICAgIGAgJiYgJHtjb250ZXh0LmhlbHBlclN0cmluZyhJU19NRU1PX1NBTUUpfShfY2FjaGVkLCBfbWVtbykpIHJldHVybiBfY2FjaGVkYAogICAgICAgICAgICAgICAgICAgICAgXSksCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2Bjb25zdCBfaXRlbSA9IGAsIGNoaWxkQmxvY2tdKSwKICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYF9pdGVtLm1lbW8gPSBfbWVtb2ApLAogICAgICAgICAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgcmV0dXJuIF9pdGVtYCkKICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgIHJlbmRlckV4cC5hcmd1bWVudHMucHVzaChsb29wLCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfY2FjaGVgKSwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihTdHJpbmcoY29udGV4dC5jYWNoZWQrKykpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlckV4cC5hcmd1bWVudHMucHVzaChjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oY3JlYXRlRm9yTG9vcFBhcmFtcyhmb3JOb2RlLnBhcnNlUmVzdWx0KSwgY2hpbGRCbG9jaywgdHJ1ZSAvKiBmb3JjZSBuZXdsaW5lICovKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgfSk7CiAgfSk7CiAgLy8gdGFyZ2V0LWFnbm9zdGljIHRyYW5zZm9ybSB1c2VkIGZvciBib3RoIENsaWVudCBhbmQgU1NSCiAgZnVuY3Rpb24gcHJvY2Vzc0Zvcihub2RlLCBkaXIsIGNvbnRleHQsIHByb2Nlc3NDb2RlZ2VuKSB7CiAgICAgIGlmICghZGlyLmV4cCkgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzEgLyogWF9WX0ZPUl9OT19FWFBSRVNTSU9OICovLCBkaXIubG9jKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgcGFyc2VSZXN1bHQgPSBwYXJzZUZvckV4cHJlc3Npb24oCiAgICAgIC8vIGNhbiBvbmx5IGJlIHNpbXBsZSBleHByZXNzaW9uIGJlY2F1c2UgdkZvciB0cmFuc2Zvcm0gaXMgYXBwbGllZAogICAgICAvLyBiZWZvcmUgZXhwcmVzc2lvbiB0cmFuc2Zvcm0uCiAgICAgIGRpci5leHAsIGNvbnRleHQpOwogICAgICBpZiAoIXBhcnNlUmVzdWx0KSB7CiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcigzMiAvKiBYX1ZfRk9SX01BTEZPUk1FRF9FWFBSRVNTSU9OICovLCBkaXIubG9jKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgeyBhZGRJZGVudGlmaWVycywgcmVtb3ZlSWRlbnRpZmllcnMsIHNjb3BlcyB9ID0gY29udGV4dDsKICAgICAgY29uc3QgeyBzb3VyY2UsIHZhbHVlLCBrZXksIGluZGV4IH0gPSBwYXJzZVJlc3VsdDsKICAgICAgY29uc3QgZm9yTm9kZSA9IHsKICAgICAgICAgIHR5cGU6IDExIC8qIEZPUiAqLywKICAgICAgICAgIGxvYzogZGlyLmxvYywKICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgIHZhbHVlQWxpYXM6IHZhbHVlLAogICAgICAgICAga2V5QWxpYXM6IGtleSwKICAgICAgICAgIG9iamVjdEluZGV4QWxpYXM6IGluZGV4LAogICAgICAgICAgcGFyc2VSZXN1bHQsCiAgICAgICAgICBjaGlsZHJlbjogaXNUZW1wbGF0ZU5vZGUobm9kZSkgPyBub2RlLmNoaWxkcmVuIDogW25vZGVdCiAgICAgIH07CiAgICAgIGNvbnRleHQucmVwbGFjZU5vZGUoZm9yTm9kZSk7CiAgICAgIC8vIGJvb2trZWVwaW5nCiAgICAgIHNjb3Blcy52Rm9yKys7CiAgICAgIGNvbnN0IG9uRXhpdCA9IHByb2Nlc3NDb2RlZ2VuICYmIHByb2Nlc3NDb2RlZ2VuKGZvck5vZGUpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgc2NvcGVzLnZGb3ItLTsKICAgICAgICAgIGlmIChvbkV4aXQpCiAgICAgICAgICAgICAgb25FeGl0KCk7CiAgICAgIH07CiAgfQogIGNvbnN0IGZvckFsaWFzUkUgPSAvKFtcc1xTXSo/KVxzKyg/OmlufG9mKVxzKyhbXHNcU10qKS87CiAgLy8gVGhpcyByZWdleCBkb2Vzbid0IGNvdmVyIHRoZSBjYXNlIGlmIGtleSBvciBpbmRleCBhbGlhc2VzIGhhdmUgZGVzdHJ1Y3R1cmluZywKICAvLyBidXQgdGhvc2UgZG8gbm90IG1ha2Ugc2Vuc2UgaW4gdGhlIGZpcnN0IHBsYWNlLCBzbyB0aGlzIHdvcmtzIGluIHByYWN0aWNlLgogIGNvbnN0IGZvckl0ZXJhdG9yUkUgPSAvLChbXixcfVxdXSopKD86LChbXixcfVxdXSopKT8kLzsKICBjb25zdCBzdHJpcFBhcmVuc1JFID0gL15cKHxcKSQvZzsKICBmdW5jdGlvbiBwYXJzZUZvckV4cHJlc3Npb24oaW5wdXQsIGNvbnRleHQpIHsKICAgICAgY29uc3QgbG9jID0gaW5wdXQubG9jOwogICAgICBjb25zdCBleHAgPSBpbnB1dC5jb250ZW50OwogICAgICBjb25zdCBpbk1hdGNoID0gZXhwLm1hdGNoKGZvckFsaWFzUkUpOwogICAgICBpZiAoIWluTWF0Y2gpCiAgICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IFssIExIUywgUkhTXSA9IGluTWF0Y2g7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgICAgIHNvdXJjZTogY3JlYXRlQWxpYXNFeHByZXNzaW9uKGxvYywgUkhTLnRyaW0oKSwgZXhwLmluZGV4T2YoUkhTLCBMSFMubGVuZ3RoKSksCiAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLAogICAgICAgICAga2V5OiB1bmRlZmluZWQsCiAgICAgICAgICBpbmRleDogdW5kZWZpbmVkCiAgICAgIH07CiAgICAgIHsKICAgICAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24ocmVzdWx0LnNvdXJjZSwgY29udGV4dCk7CiAgICAgIH0KICAgICAgbGV0IHZhbHVlQ29udGVudCA9IExIUy50cmltKCkucmVwbGFjZShzdHJpcFBhcmVuc1JFLCAnJykudHJpbSgpOwogICAgICBjb25zdCB0cmltbWVkT2Zmc2V0ID0gTEhTLmluZGV4T2YodmFsdWVDb250ZW50KTsKICAgICAgY29uc3QgaXRlcmF0b3JNYXRjaCA9IHZhbHVlQ29udGVudC5tYXRjaChmb3JJdGVyYXRvclJFKTsKICAgICAgaWYgKGl0ZXJhdG9yTWF0Y2gpIHsKICAgICAgICAgIHZhbHVlQ29udGVudCA9IHZhbHVlQ29udGVudC5yZXBsYWNlKGZvckl0ZXJhdG9yUkUsICcnKS50cmltKCk7CiAgICAgICAgICBjb25zdCBrZXlDb250ZW50ID0gaXRlcmF0b3JNYXRjaFsxXS50cmltKCk7CiAgICAgICAgICBsZXQga2V5T2Zmc2V0OwogICAgICAgICAgaWYgKGtleUNvbnRlbnQpIHsKICAgICAgICAgICAgICBrZXlPZmZzZXQgPSBleHAuaW5kZXhPZihrZXlDb250ZW50LCB0cmltbWVkT2Zmc2V0ICsgdmFsdWVDb250ZW50Lmxlbmd0aCk7CiAgICAgICAgICAgICAgcmVzdWx0LmtleSA9IGNyZWF0ZUFsaWFzRXhwcmVzc2lvbihsb2MsIGtleUNvbnRlbnQsIGtleU9mZnNldCk7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKHJlc3VsdC5rZXksIGNvbnRleHQsIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpdGVyYXRvck1hdGNoWzJdKSB7CiAgICAgICAgICAgICAgY29uc3QgaW5kZXhDb250ZW50ID0gaXRlcmF0b3JNYXRjaFsyXS50cmltKCk7CiAgICAgICAgICAgICAgaWYgKGluZGV4Q29udGVudCkgewogICAgICAgICAgICAgICAgICByZXN1bHQuaW5kZXggPSBjcmVhdGVBbGlhc0V4cHJlc3Npb24obG9jLCBpbmRleENvbnRlbnQsIGV4cC5pbmRleE9mKGluZGV4Q29udGVudCwgcmVzdWx0LmtleQogICAgICAgICAgICAgICAgICAgICAgPyBrZXlPZmZzZXQgKyBrZXlDb250ZW50Lmxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgOiB0cmltbWVkT2Zmc2V0ICsgdmFsdWVDb250ZW50Lmxlbmd0aCkpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKHJlc3VsdC5pbmRleCwgY29udGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHZhbHVlQ29udGVudCkgewogICAgICAgICAgcmVzdWx0LnZhbHVlID0gY3JlYXRlQWxpYXNFeHByZXNzaW9uKGxvYywgdmFsdWVDb250ZW50LCB0cmltbWVkT2Zmc2V0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKHJlc3VsdC52YWx1ZSwgY29udGV4dCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQWxpYXNFeHByZXNzaW9uKHJhbmdlLCBjb250ZW50LCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oY29udGVudCwgZmFsc2UsIGdldElubmVyUmFuZ2UocmFuZ2UsIG9mZnNldCwgY29udGVudC5sZW5ndGgpKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlRm9yTG9vcFBhcmFtcyh7IHZhbHVlLCBrZXksIGluZGV4IH0sIG1lbW9BcmdzID0gW10pIHsKICAgICAgcmV0dXJuIGNyZWF0ZVBhcmFtc0xpc3QoW3ZhbHVlLCBrZXksIGluZGV4LCAuLi5tZW1vQXJnc10pOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQYXJhbXNMaXN0KGFyZ3MpIHsKICAgICAgbGV0IGkgPSBhcmdzLmxlbmd0aDsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgaWYgKGFyZ3NbaV0pCiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIGFyZ3MKICAgICAgICAgIC5zbGljZSgwLCBpICsgMSkKICAgICAgICAgIC5tYXAoKGFyZywgaSkgPT4gYXJnIHx8IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYF9gLnJlcGVhdChpICsgMSksIGZhbHNlKSk7CiAgfQoKICBjb25zdCBkZWZhdWx0RmFsbGJhY2sgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB1bmRlZmluZWRgLCBmYWxzZSk7CiAgLy8gQSBOb2RlVHJhbnNmb3JtIHRoYXQ6CiAgLy8gMS4gVHJhY2tzIHNjb3BlIGlkZW50aWZpZXJzIGZvciBzY29wZWQgc2xvdHMgc28gdGhhdCB0aGV5IGRvbid0IGdldCBwcmVmaXhlZAogIC8vICAgIGJ5IHRyYW5zZm9ybUV4cHJlc3Npb24uIFRoaXMgaXMgb25seSBhcHBsaWVkIGluIG5vbi1icm93c2VyIGJ1aWxkcyB3aXRoCiAgLy8gICAgeyBwcmVmaXhJZGVudGlmaWVyczogdHJ1ZSB9LgogIC8vIDIuIFRyYWNrIHYtc2xvdCBkZXB0aHMgc28gdGhhdCB3ZSBrbm93IGEgc2xvdCBpcyBpbnNpZGUgYW5vdGhlciBzbG90LgogIC8vICAgIE5vdGUgdGhlIGV4aXQgY2FsbGJhY2sgaXMgZXhlY3V0ZWQgYmVmb3JlIGJ1aWxkU2xvdHMoKSBvbiB0aGUgc2FtZSBub2RlLAogIC8vICAgIHNvIG9ubHkgbmVzdGVkIHNsb3RzIHNlZSBwb3NpdGl2ZSBudW1iZXJzLgogIGNvbnN0IHRyYWNrU2xvdFNjb3BlcyA9IChub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgKG5vZGUudGFnVHlwZSA9PT0gMSAvKiBDT01QT05FTlQgKi8gfHwKICAgICAgICAgICAgICBub2RlLnRhZ1R5cGUgPT09IDMgLyogVEVNUExBVEUgKi8pKSB7CiAgICAgICAgICAvLyBXZSBhcmUgb25seSBjaGVja2luZyBub24tZW1wdHkgdi1zbG90IGhlcmUKICAgICAgICAgIC8vIHNpbmNlIHdlIG9ubHkgY2FyZSBhYm91dCBzbG90cyB0aGF0IGludHJvZHVjZSBzY29wZSB2YXJpYWJsZXMuCiAgICAgICAgICBjb25zdCB2U2xvdCA9IGZpbmREaXIobm9kZSwgJ3Nsb3QnKTsKICAgICAgICAgIGlmICh2U2xvdCkgewogICAgICAgICAgICAgIHZTbG90LmV4cDsKICAgICAgICAgICAgICBjb250ZXh0LnNjb3Blcy52U2xvdCsrOwogICAgICAgICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuc2NvcGVzLnZTbG90LS07CiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgfQogIH07CiAgY29uc3QgYnVpbGRDbGllbnRTbG90Rm4gPSAocHJvcHMsIGNoaWxkcmVuLCBsb2MpID0+IGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbihwcm9wcywgY2hpbGRyZW4sIGZhbHNlIC8qIG5ld2xpbmUgKi8sIHRydWUgLyogaXNTbG90ICovLCBjaGlsZHJlbi5sZW5ndGggPyBjaGlsZHJlblswXS5sb2MgOiBsb2MpOwogIC8vIEluc3RlYWQgb2YgYmVpbmcgYSBEaXJlY3RpdmVUcmFuc2Zvcm0sIHYtc2xvdCBwcm9jZXNzaW5nIGlzIGNhbGxlZCBkdXJpbmcKICAvLyB0cmFuc2Zvcm1FbGVtZW50IHRvIGJ1aWxkIHRoZSBzbG90cyBvYmplY3QgZm9yIGEgY29tcG9uZW50LgogIGZ1bmN0aW9uIGJ1aWxkU2xvdHMobm9kZSwgY29udGV4dCwgYnVpbGRTbG90Rm4gPSBidWlsZENsaWVudFNsb3RGbikgewogICAgICBjb250ZXh0LmhlbHBlcihXSVRIX0NUWCk7CiAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIGxvYyB9ID0gbm9kZTsKICAgICAgY29uc3Qgc2xvdHNQcm9wZXJ0aWVzID0gW107CiAgICAgIGNvbnN0IGR5bmFtaWNTbG90cyA9IFtdOwogICAgICAvLyBJZiB0aGUgc2xvdCBpcyBpbnNpZGUgYSB2LWZvciBvciBhbm90aGVyIHYtc2xvdCwgZm9yY2UgaXQgdG8gYmUgZHluYW1pYwogICAgICAvLyBzaW5jZSBpdCBsaWtlbHkgdXNlcyBhIHNjb3BlIHZhcmlhYmxlLgogICAgICBsZXQgaGFzRHluYW1pY1Nsb3RzID0gY29udGV4dC5zY29wZXMudlNsb3QgPiAwIHx8IGNvbnRleHQuc2NvcGVzLnZGb3IgPiAwOwogICAgICAvLyAxLiBDaGVjayBmb3Igc2xvdCB3aXRoIHNsb3RQcm9wcyBvbiBjb21wb25lbnQgaXRzZWxmLgogICAgICAvLyAgICA8Q29tcCB2LXNsb3Q9InsgcHJvcCB9Ii8+CiAgICAgIGNvbnN0IG9uQ29tcG9uZW50U2xvdCA9IGZpbmREaXIobm9kZSwgJ3Nsb3QnLCB0cnVlKTsKICAgICAgaWYgKG9uQ29tcG9uZW50U2xvdCkgewogICAgICAgICAgY29uc3QgeyBhcmcsIGV4cCB9ID0gb25Db21wb25lbnRTbG90OwogICAgICAgICAgaWYgKGFyZyAmJiAhaXNTdGF0aWNFeHAoYXJnKSkgewogICAgICAgICAgICAgIGhhc0R5bmFtaWNTbG90cyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChjcmVhdGVPYmplY3RQcm9wZXJ0eShhcmcgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbignZGVmYXVsdCcsIHRydWUpLCBidWlsZFNsb3RGbihleHAsIGNoaWxkcmVuLCBsb2MpKSk7CiAgICAgIH0KICAgICAgLy8gMi4gSXRlcmF0ZSB0aHJvdWdoIGNoaWxkcmVuIGFuZCBjaGVjayBmb3IgdGVtcGxhdGUgc2xvdHMKICAgICAgLy8gICAgPHRlbXBsYXRlIHYtc2xvdDpmb289InsgcHJvcCB9Ij4KICAgICAgbGV0IGhhc1RlbXBsYXRlU2xvdHMgPSBmYWxzZTsKICAgICAgbGV0IGhhc05hbWVkRGVmYXVsdFNsb3QgPSBmYWxzZTsKICAgICAgY29uc3QgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4gPSBbXTsKICAgICAgY29uc3Qgc2VlblNsb3ROYW1lcyA9IG5ldyBTZXQoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qgc2xvdEVsZW1lbnQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgIGxldCBzbG90RGlyOwogICAgICAgICAgaWYgKCFpc1RlbXBsYXRlTm9kZShzbG90RWxlbWVudCkgfHwKICAgICAgICAgICAgICAhKHNsb3REaXIgPSBmaW5kRGlyKHNsb3RFbGVtZW50LCAnc2xvdCcsIHRydWUpKSkgewogICAgICAgICAgICAgIC8vIG5vdCBhIDx0ZW1wbGF0ZSB2LXNsb3Q+LCBza2lwLgogICAgICAgICAgICAgIGlmIChzbG90RWxlbWVudC50eXBlICE9PSAzIC8qIENPTU1FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4ucHVzaChzbG90RWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9uQ29tcG9uZW50U2xvdCkgewogICAgICAgICAgICAgIC8vIGFscmVhZHkgaGFzIG9uLWNvbXBvbmVudCBzbG90IC0gdGhpcyBpcyBpbmNvcnJlY3QgdXNhZ2UuCiAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzcgLyogWF9WX1NMT1RfTUlYRURfU0xPVF9VU0FHRSAqLywgc2xvdERpci5sb2MpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGhhc1RlbXBsYXRlU2xvdHMgPSB0cnVlOwogICAgICAgICAgY29uc3QgeyBjaGlsZHJlbjogc2xvdENoaWxkcmVuLCBsb2M6IHNsb3RMb2MgfSA9IHNsb3RFbGVtZW50OwogICAgICAgICAgY29uc3QgeyBhcmc6IHNsb3ROYW1lID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgZGVmYXVsdGAsIHRydWUpLCBleHA6IHNsb3RQcm9wcywgbG9jOiBkaXJMb2MgfSA9IHNsb3REaXI7CiAgICAgICAgICAvLyBjaGVjayBpZiBuYW1lIGlzIGR5bmFtaWMuCiAgICAgICAgICBsZXQgc3RhdGljU2xvdE5hbWU7CiAgICAgICAgICBpZiAoaXNTdGF0aWNFeHAoc2xvdE5hbWUpKSB7CiAgICAgICAgICAgICAgc3RhdGljU2xvdE5hbWUgPSBzbG90TmFtZSA/IHNsb3ROYW1lLmNvbnRlbnQgOiBgZGVmYXVsdGA7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBoYXNEeW5hbWljU2xvdHMgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc2xvdEZ1bmN0aW9uID0gYnVpbGRTbG90Rm4oc2xvdFByb3BzLCBzbG90Q2hpbGRyZW4sIHNsb3RMb2MpOwogICAgICAgICAgLy8gY2hlY2sgaWYgdGhpcyBzbG90IGlzIGNvbmRpdGlvbmFsICh2LWlmL3YtZm9yKQogICAgICAgICAgbGV0IHZJZjsKICAgICAgICAgIGxldCB2RWxzZTsKICAgICAgICAgIGxldCB2Rm9yOwogICAgICAgICAgaWYgKCh2SWYgPSBmaW5kRGlyKHNsb3RFbGVtZW50LCAnaWYnKSkpIHsKICAgICAgICAgICAgICBoYXNEeW5hbWljU2xvdHMgPSB0cnVlOwogICAgICAgICAgICAgIGR5bmFtaWNTbG90cy5wdXNoKGNyZWF0ZUNvbmRpdGlvbmFsRXhwcmVzc2lvbih2SWYuZXhwLCBidWlsZER5bmFtaWNTbG90KHNsb3ROYW1lLCBzbG90RnVuY3Rpb24pLCBkZWZhdWx0RmFsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKCh2RWxzZSA9IGZpbmREaXIoc2xvdEVsZW1lbnQsIC9eZWxzZSgtaWYpPyQvLCB0cnVlIC8qIGFsbG93RW1wdHkgKi8pKSkgewogICAgICAgICAgICAgIC8vIGZpbmQgYWRqYWNlbnQgdi1pZgogICAgICAgICAgICAgIGxldCBqID0gaTsKICAgICAgICAgICAgICBsZXQgcHJldjsKICAgICAgICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICAgICAgICAgIHByZXYgPSBjaGlsZHJlbltqXTsKICAgICAgICAgICAgICAgICAgaWYgKHByZXYudHlwZSAhPT0gMyAvKiBDT01NRU5UICovKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJldiAmJiBpc1RlbXBsYXRlTm9kZShwcmV2KSAmJiBmaW5kRGlyKHByZXYsICdpZicpKSB7CiAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBub2RlCiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAvLyBhdHRhY2ggdGhpcyBzbG90IHRvIHByZXZpb3VzIGNvbmRpdGlvbmFsCiAgICAgICAgICAgICAgICAgIGxldCBjb25kaXRpb25hbCA9IGR5bmFtaWNTbG90c1tkeW5hbWljU2xvdHMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgIHdoaWxlIChjb25kaXRpb25hbC5hbHRlcm5hdGUudHlwZSA9PT0gMTkgLyogSlNfQ09ORElUSU9OQUxfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uYWwgPSBjb25kaXRpb25hbC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uZGl0aW9uYWwuYWx0ZXJuYXRlID0gdkVsc2UuZXhwCiAgICAgICAgICAgICAgICAgICAgICA/IGNyZWF0ZUNvbmRpdGlvbmFsRXhwcmVzc2lvbih2RWxzZS5leHAsIGJ1aWxkRHluYW1pY1Nsb3Qoc2xvdE5hbWUsIHNsb3RGdW5jdGlvbiksIGRlZmF1bHRGYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICAgIDogYnVpbGREeW5hbWljU2xvdChzbG90TmFtZSwgc2xvdEZ1bmN0aW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDMwIC8qIFhfVl9FTFNFX05PX0FESkFDRU5UX0lGICovLCB2RWxzZS5sb2MpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICgodkZvciA9IGZpbmREaXIoc2xvdEVsZW1lbnQsICdmb3InKSkpIHsKICAgICAgICAgICAgICBoYXNEeW5hbWljU2xvdHMgPSB0cnVlOwogICAgICAgICAgICAgIGNvbnN0IHBhcnNlUmVzdWx0ID0gdkZvci5wYXJzZVJlc3VsdCB8fAogICAgICAgICAgICAgICAgICBwYXJzZUZvckV4cHJlc3Npb24odkZvci5leHAsIGNvbnRleHQpOwogICAgICAgICAgICAgIGlmIChwYXJzZVJlc3VsdCkgewogICAgICAgICAgICAgICAgICAvLyBSZW5kZXIgdGhlIGR5bmFtaWMgc2xvdHMgYXMgYW4gYXJyYXkgYW5kIGFkZCBpdCB0byB0aGUgY3JlYXRlU2xvdCgpCiAgICAgICAgICAgICAgICAgIC8vIGFyZ3MuIFRoZSBydW50aW1lIGtub3dzIGhvdyB0byBoYW5kbGUgaXQgYXBwcm9wcmlhdGVseS4KICAgICAgICAgICAgICAgICAgZHluYW1pY1Nsb3RzLnB1c2goY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoUkVOREVSX0xJU1QpLCBbCiAgICAgICAgICAgICAgICAgICAgICBwYXJzZVJlc3VsdC5zb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oY3JlYXRlRm9yTG9vcFBhcmFtcyhwYXJzZVJlc3VsdCksIGJ1aWxkRHluYW1pY1Nsb3Qoc2xvdE5hbWUsIHNsb3RGdW5jdGlvbiksIHRydWUgLyogZm9yY2UgbmV3bGluZSAqLykKICAgICAgICAgICAgICAgICAgXSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzIgLyogWF9WX0ZPUl9NQUxGT1JNRURfRVhQUkVTU0lPTiAqLywgdkZvci5sb2MpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAvLyBjaGVjayBkdXBsaWNhdGUgc3RhdGljIG5hbWVzCiAgICAgICAgICAgICAgaWYgKHN0YXRpY1Nsb3ROYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzZWVuU2xvdE5hbWVzLmhhcyhzdGF0aWNTbG90TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDM4IC8qIFhfVl9TTE9UX0RVUExJQ0FURV9TTE9UX05BTUVTICovLCBkaXJMb2MpKTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNlZW5TbG90TmFtZXMuYWRkKHN0YXRpY1Nsb3ROYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRpY1Nsb3ROYW1lID09PSAnZGVmYXVsdCcpIHsKICAgICAgICAgICAgICAgICAgICAgIGhhc05hbWVkRGVmYXVsdFNsb3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNsb3RzUHJvcGVydGllcy5wdXNoKGNyZWF0ZU9iamVjdFByb3BlcnR5KHNsb3ROYW1lLCBzbG90RnVuY3Rpb24pKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIW9uQ29tcG9uZW50U2xvdCkgewogICAgICAgICAgY29uc3QgYnVpbGREZWZhdWx0U2xvdFByb3BlcnR5ID0gKHByb3BzLCBjaGlsZHJlbikgPT4gewogICAgICAgICAgICAgIGNvbnN0IGZuID0gYnVpbGRTbG90Rm4ocHJvcHMsIGNoaWxkcmVuLCBsb2MpOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVPYmplY3RQcm9wZXJ0eShgZGVmYXVsdGAsIGZuKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoIWhhc1RlbXBsYXRlU2xvdHMpIHsKICAgICAgICAgICAgICAvLyBpbXBsaWNpdCBkZWZhdWx0IHNsb3QgKG9uIGNvbXBvbmVudCkKICAgICAgICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChidWlsZERlZmF1bHRTbG90UHJvcGVydHkodW5kZWZpbmVkLCBjaGlsZHJlbikpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4ubGVuZ3RoICYmCiAgICAgICAgICAgICAgLy8gIzM3NjYKICAgICAgICAgICAgICAvLyB3aXRoIHdoaXRlc3BhY2U6ICdwcmVzZXJ2ZScsIHdoaXRlc3BhY2VzIGJldHdlZW4gc2xvdHMgd2lsbCBlbmQgdXAgaW4KICAgICAgICAgICAgICAvLyBpbXBsaWNpdERlZmF1bHRDaGlsZHJlbi4gSWdub3JlIGlmIGFsbCBpbXBsaWNpdCBjaGlsZHJlbiBhcmUgd2hpdGVzcGFjZXMuCiAgICAgICAgICAgICAgaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4uc29tZShub2RlID0+IGlzTm9uV2hpdGVzcGFjZUNvbnRlbnQobm9kZSkpKSB7CiAgICAgICAgICAgICAgLy8gaW1wbGljaXQgZGVmYXVsdCBzbG90IChtaXhlZCB3aXRoIG5hbWVkIHNsb3RzKQogICAgICAgICAgICAgIGlmIChoYXNOYW1lZERlZmF1bHRTbG90KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDM5IC8qIFhfVl9TTE9UX0VYVFJBTkVPVVNfREVGQVVMVF9TTE9UX0NISUxEUkVOICovLCBpbXBsaWNpdERlZmF1bHRDaGlsZHJlblswXS5sb2MpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHNsb3RzUHJvcGVydGllcy5wdXNoKGJ1aWxkRGVmYXVsdFNsb3RQcm9wZXJ0eSh1bmRlZmluZWQsIGltcGxpY2l0RGVmYXVsdENoaWxkcmVuKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHNsb3RGbGFnID0gaGFzRHluYW1pY1Nsb3RzCiAgICAgICAgICA/IDIgLyogRFlOQU1JQyAqLwogICAgICAgICAgOiBoYXNGb3J3YXJkZWRTbG90cyhub2RlLmNoaWxkcmVuKQogICAgICAgICAgICAgID8gMyAvKiBGT1JXQVJERUQgKi8KICAgICAgICAgICAgICA6IDEgLyogU1RBQkxFICovOwogICAgICBsZXQgc2xvdHMgPSBjcmVhdGVPYmplY3RFeHByZXNzaW9uKHNsb3RzUHJvcGVydGllcy5jb25jYXQoY3JlYXRlT2JqZWN0UHJvcGVydHkoYF9gLCAKICAgICAgLy8gMiA9IGNvbXBpbGVkIGJ1dCBkeW5hbWljID0gY2FuIHNraXAgbm9ybWFsaXphdGlvbiwgYnV0IG11c3QgcnVuIGRpZmYKICAgICAgLy8gMSA9IGNvbXBpbGVkIGFuZCBzdGF0aWMgPSBjYW4gc2tpcCBub3JtYWxpemF0aW9uIEFORCBkaWZmIGFzIG9wdGltaXplZAogICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKHNsb3RGbGFnICsgKGAgLyogJHtzbG90RmxhZ3NUZXh0W3Nsb3RGbGFnXX0gKi9gICksIGZhbHNlKSkpLCBsb2MpOwogICAgICBpZiAoZHluYW1pY1Nsb3RzLmxlbmd0aCkgewogICAgICAgICAgc2xvdHMgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihDUkVBVEVfU0xPVFMpLCBbCiAgICAgICAgICAgICAgc2xvdHMsCiAgICAgICAgICAgICAgY3JlYXRlQXJyYXlFeHByZXNzaW9uKGR5bmFtaWNTbG90cykKICAgICAgICAgIF0pOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgICBzbG90cywKICAgICAgICAgIGhhc0R5bmFtaWNTbG90cwogICAgICB9OwogIH0KICBmdW5jdGlvbiBidWlsZER5bmFtaWNTbG90KG5hbWUsIGZuKSB7CiAgICAgIHJldHVybiBjcmVhdGVPYmplY3RFeHByZXNzaW9uKFsKICAgICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KGBuYW1lYCwgbmFtZSksCiAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShgZm5gLCBmbikKICAgICAgXSk7CiAgfQogIGZ1bmN0aW9uIGhhc0ZvcndhcmRlZFNsb3RzKGNoaWxkcmVuKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICBzd2l0Y2ggKGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIDEgLyogRUxFTUVOVCAqLzoKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZ1R5cGUgPT09IDIgLyogU0xPVCAqLyB8fAogICAgICAgICAgICAgICAgICAgICAgaGFzRm9yd2FyZGVkU2xvdHMoY2hpbGQuY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDkgLyogSUYgKi86CiAgICAgICAgICAgICAgICAgIGlmIChoYXNGb3J3YXJkZWRTbG90cyhjaGlsZC5icmFuY2hlcykpCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxMCAvKiBJRl9CUkFOQ0ggKi86CiAgICAgICAgICAgICAgY2FzZSAxMSAvKiBGT1IgKi86CiAgICAgICAgICAgICAgICAgIGlmIChoYXNGb3J3YXJkZWRTbG90cyhjaGlsZC5jaGlsZHJlbikpCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiBpc05vbldoaXRlc3BhY2VDb250ZW50KG5vZGUpIHsKICAgICAgaWYgKG5vZGUudHlwZSAhPT0gMiAvKiBURVhUICovICYmIG5vZGUudHlwZSAhPT0gMTIgLyogVEVYVF9DQUxMICovKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBub2RlLnR5cGUgPT09IDIgLyogVEVYVCAqLwogICAgICAgICAgPyAhIW5vZGUuY29udGVudC50cmltKCkKICAgICAgICAgIDogaXNOb25XaGl0ZXNwYWNlQ29udGVudChub2RlLmNvbnRlbnQpOwogIH0KCiAgLy8gc29tZSBkaXJlY3RpdmUgdHJhbnNmb3JtcyAoZS5nLiB2LW1vZGVsKSBtYXkgcmV0dXJuIGEgc3ltYm9sIGZvciBydW50aW1lCiAgLy8gaW1wb3J0LCB3aGljaCBzaG91bGQgYmUgdXNlZCBpbnN0ZWFkIG9mIGEgcmVzb2x2ZURpcmVjdGl2ZSBjYWxsLgogIGNvbnN0IGRpcmVjdGl2ZUltcG9ydE1hcCA9IG5ldyBXZWFrTWFwKCk7CiAgLy8gZ2VuZXJhdGUgYSBKYXZhU2NyaXB0IEFTVCBmb3IgdGhpcyBlbGVtZW50J3MgY29kZWdlbgogIGNvbnN0IHRyYW5zZm9ybUVsZW1lbnQgPSAobm9kZSwgY29udGV4dCkgPT4gewogICAgICAvLyBwZXJmb3JtIHRoZSB3b3JrIG9uIGV4aXQsIGFmdGVyIGFsbCBjaGlsZCBleHByZXNzaW9ucyBoYXZlIGJlZW4KICAgICAgLy8gcHJvY2Vzc2VkIGFuZCBtZXJnZWQuCiAgICAgIHJldHVybiBmdW5jdGlvbiBwb3N0VHJhbnNmb3JtRWxlbWVudCgpIHsKICAgICAgICAgIG5vZGUgPSBjb250ZXh0LmN1cnJlbnROb2RlOwogICAgICAgICAgaWYgKCEobm9kZS50eXBlID09PSAxIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgICAgICAobm9kZS50YWdUeXBlID09PSAwIC8qIEVMRU1FTlQgKi8gfHwKICAgICAgICAgICAgICAgICAgbm9kZS50YWdUeXBlID09PSAxIC8qIENPTVBPTkVOVCAqLykpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgeyB0YWcsIHByb3BzIH0gPSBub2RlOwogICAgICAgICAgY29uc3QgaXNDb21wb25lbnQgPSBub2RlLnRhZ1R5cGUgPT09IDEgLyogQ09NUE9ORU5UICovOwogICAgICAgICAgLy8gVGhlIGdvYWwgb2YgdGhlIHRyYW5zZm9ybSBpcyB0byBjcmVhdGUgYSBjb2RlZ2VuTm9kZSBpbXBsZW1lbnRpbmcgdGhlCiAgICAgICAgICAvLyBWTm9kZUNhbGwgaW50ZXJmYWNlLgogICAgICAgICAgbGV0IHZub2RlVGFnID0gaXNDb21wb25lbnQKICAgICAgICAgICAgICA/IHJlc29sdmVDb21wb25lbnRUeXBlKG5vZGUsIGNvbnRleHQpCiAgICAgICAgICAgICAgOiBgIiR7dGFnfSJgOwogICAgICAgICAgY29uc3QgaXNEeW5hbWljQ29tcG9uZW50ID0gaXNPYmplY3Qodm5vZGVUYWcpICYmIHZub2RlVGFnLmNhbGxlZSA9PT0gUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVDsKICAgICAgICAgIGxldCB2bm9kZVByb3BzOwogICAgICAgICAgbGV0IHZub2RlQ2hpbGRyZW47CiAgICAgICAgICBsZXQgdm5vZGVQYXRjaEZsYWc7CiAgICAgICAgICBsZXQgcGF0Y2hGbGFnID0gMDsKICAgICAgICAgIGxldCB2bm9kZUR5bmFtaWNQcm9wczsKICAgICAgICAgIGxldCBkeW5hbWljUHJvcE5hbWVzOwogICAgICAgICAgbGV0IHZub2RlRGlyZWN0aXZlczsKICAgICAgICAgIGxldCBzaG91bGRVc2VCbG9jayA9IAogICAgICAgICAgLy8gZHluYW1pYyBjb21wb25lbnQgbWF5IHJlc29sdmUgdG8gcGxhaW4gZWxlbWVudHMKICAgICAgICAgIGlzRHluYW1pY0NvbXBvbmVudCB8fAogICAgICAgICAgICAgIHZub2RlVGFnID09PSBURUxFUE9SVCB8fAogICAgICAgICAgICAgIHZub2RlVGFnID09PSBTVVNQRU5TRSB8fAogICAgICAgICAgICAgICghaXNDb21wb25lbnQgJiYKICAgICAgICAgICAgICAgICAgLy8gPHN2Zz4gYW5kIDxmb3JlaWduT2JqZWN0PiBtdXN0IGJlIGZvcmNlZCBpbnRvIGJsb2NrcyBzbyB0aGF0IGJsb2NrCiAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZXMgaW5zaWRlIGdldCBwcm9wZXIgaXNTVkcgZmxhZyBhdCBydW50aW1lLiAoIzYzOSwgIzY0MykKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0ZWNobmljYWxseSB3ZWItc3BlY2lmaWMsIGJ1dCBzcGxpdHRpbmcgdGhlIGxvZ2ljIG91dCBvZiBjb3JlCiAgICAgICAgICAgICAgICAgIC8vIGxlYWRzIHRvIHRvbyBtdWNoIHVubmVjZXNzYXJ5IGNvbXBsZXhpdHkuCiAgICAgICAgICAgICAgICAgICh0YWcgPT09ICdzdmcnIHx8IHRhZyA9PT0gJ2ZvcmVpZ25PYmplY3QnKSk7CiAgICAgICAgICAvLyBwcm9wcwogICAgICAgICAgaWYgKHByb3BzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBwcm9wc0J1aWxkUmVzdWx0ID0gYnVpbGRQcm9wcyhub2RlLCBjb250ZXh0LCB1bmRlZmluZWQsIGlzQ29tcG9uZW50LCBpc0R5bmFtaWNDb21wb25lbnQpOwogICAgICAgICAgICAgIHZub2RlUHJvcHMgPSBwcm9wc0J1aWxkUmVzdWx0LnByb3BzOwogICAgICAgICAgICAgIHBhdGNoRmxhZyA9IHByb3BzQnVpbGRSZXN1bHQucGF0Y2hGbGFnOwogICAgICAgICAgICAgIGR5bmFtaWNQcm9wTmFtZXMgPSBwcm9wc0J1aWxkUmVzdWx0LmR5bmFtaWNQcm9wTmFtZXM7CiAgICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlcyA9IHByb3BzQnVpbGRSZXN1bHQuZGlyZWN0aXZlczsKICAgICAgICAgICAgICB2bm9kZURpcmVjdGl2ZXMgPQogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzICYmIGRpcmVjdGl2ZXMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICA/IGNyZWF0ZUFycmF5RXhwcmVzc2lvbihkaXJlY3RpdmVzLm1hcChkaXIgPT4gYnVpbGREaXJlY3RpdmVBcmdzKGRpciwgY29udGV4dCkpKQogICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgaWYgKHByb3BzQnVpbGRSZXN1bHQuc2hvdWxkVXNlQmxvY2spIHsKICAgICAgICAgICAgICAgICAgc2hvdWxkVXNlQmxvY2sgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIGNoaWxkcmVuCiAgICAgICAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgaWYgKHZub2RlVGFnID09PSBLRUVQX0FMSVZFKSB7CiAgICAgICAgICAgICAgICAgIC8vIEFsdGhvdWdoIGEgYnVpbHQtaW4gY29tcG9uZW50LCB3ZSBjb21waWxlIEtlZXBBbGl2ZSB3aXRoIHJhdyBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAvLyBpbnN0ZWFkIG9mIHNsb3QgZnVuY3Rpb25zIHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgaW5zaWRlIFRyYW5zaXRpb24KICAgICAgICAgICAgICAgICAgLy8gb3Igb3RoZXIgVHJhbnNpdGlvbi13cmFwcGluZyBIT0NzLgogICAgICAgICAgICAgICAgICAvLyBUbyBlbnN1cmUgY29ycmVjdCB1cGRhdGVzIHdpdGggYmxvY2sgb3B0aW1pemF0aW9ucywgd2UgbmVlZCB0bzoKICAgICAgICAgICAgICAgICAgLy8gMS4gRm9yY2Uga2VlcC1hbGl2ZSBpbnRvIGEgYmxvY2suIFRoaXMgYXZvaWRzIGl0cyBjaGlsZHJlbiBiZWluZwogICAgICAgICAgICAgICAgICAvLyAgICBjb2xsZWN0ZWQgYnkgYSBwYXJlbnQgYmxvY2suCiAgICAgICAgICAgICAgICAgIHNob3VsZFVzZUJsb2NrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgLy8gMi4gRm9yY2Uga2VlcC1hbGl2ZSB0byBhbHdheXMgYmUgdXBkYXRlZCwgc2luY2UgaXQgdXNlcyByYXcgY2hpbGRyZW4uCiAgICAgICAgICAgICAgICAgIHBhdGNoRmxhZyB8PSAxMDI0IC8qIERZTkFNSUNfU0xPVFMgKi87CiAgICAgICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDQ1IC8qIFhfS0VFUF9BTElWRV9JTlZBTElEX0NISUxEUkVOICovLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuY2hpbGRyZW5bMF0ubG9jLnN0YXJ0LAogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogbm9kZS5jaGlsZHJlbltub2RlLmNoaWxkcmVuLmxlbmd0aCAtIDFdLmxvYy5lbmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiAnJwogICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IHNob3VsZEJ1aWxkQXNTbG90cyA9IGlzQ29tcG9uZW50ICYmCiAgICAgICAgICAgICAgICAgIC8vIFRlbGVwb3J0IGlzIG5vdCBhIHJlYWwgY29tcG9uZW50IGFuZCBoYXMgZGVkaWNhdGVkIHJ1bnRpbWUgaGFuZGxpbmcKICAgICAgICAgICAgICAgICAgdm5vZGVUYWcgIT09IFRFTEVQT1JUICYmCiAgICAgICAgICAgICAgICAgIC8vIGV4cGxhaW5lZCBhYm92ZS4KICAgICAgICAgICAgICAgICAgdm5vZGVUYWcgIT09IEtFRVBfQUxJVkU7CiAgICAgICAgICAgICAgaWYgKHNob3VsZEJ1aWxkQXNTbG90cykgewogICAgICAgICAgICAgICAgICBjb25zdCB7IHNsb3RzLCBoYXNEeW5hbWljU2xvdHMgfSA9IGJ1aWxkU2xvdHMobm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgIHZub2RlQ2hpbGRyZW4gPSBzbG90czsKICAgICAgICAgICAgICAgICAgaWYgKGhhc0R5bmFtaWNTbG90cykgewogICAgICAgICAgICAgICAgICAgICAgcGF0Y2hGbGFnIHw9IDEwMjQgLyogRFlOQU1JQ19TTE9UUyAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSAmJiB2bm9kZVRhZyAhPT0gVEVMRVBPUlQpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBub2RlLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gY2hpbGQudHlwZTsKICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGR5bmFtaWMgdGV4dCBjaGlsZHJlbgogICAgICAgICAgICAgICAgICBjb25zdCBoYXNEeW5hbWljVGV4dENoaWxkID0gdHlwZSA9PT0gNSAvKiBJTlRFUlBPTEFUSU9OICovIHx8CiAgICAgICAgICAgICAgICAgICAgICB0eXBlID09PSA4IC8qIENPTVBPVU5EX0VYUFJFU1NJT04gKi87CiAgICAgICAgICAgICAgICAgIGlmIChoYXNEeW5hbWljVGV4dENoaWxkICYmCiAgICAgICAgICAgICAgICAgICAgICBnZXRDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpID09PSAwIC8qIE5PVF9DT05TVEFOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgcGF0Y2hGbGFnIHw9IDEgLyogVEVYVCAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBwYXNzIGRpcmVjdGx5IGlmIHRoZSBvbmx5IGNoaWxkIGlzIGEgdGV4dCBub2RlCiAgICAgICAgICAgICAgICAgIC8vIChwbGFpbiAvIGludGVycG9sYXRpb24gLyBleHByZXNzaW9uKQogICAgICAgICAgICAgICAgICBpZiAoaGFzRHluYW1pY1RleHRDaGlsZCB8fCB0eXBlID09PSAyIC8qIFRFWFQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIHZub2RlQ2hpbGRyZW4gPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZub2RlQ2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB2bm9kZUNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBwYXRjaEZsYWcgJiBkeW5hbWljUHJvcE5hbWVzCiAgICAgICAgICBpZiAocGF0Y2hGbGFnICE9PSAwKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAocGF0Y2hGbGFnIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgLy8gc3BlY2lhbCBmbGFncyAobmVnYXRpdmUgYW5kIG11dHVhbGx5IGV4Y2x1c2l2ZSkKICAgICAgICAgICAgICAgICAgICAgIHZub2RlUGF0Y2hGbGFnID0gcGF0Y2hGbGFnICsgYCAvKiAke1BhdGNoRmxhZ05hbWVzW3BhdGNoRmxhZ119ICovYDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGJpdHdpc2UgZmxhZ3MKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZsYWdOYW1lcyA9IE9iamVjdC5rZXlzKFBhdGNoRmxhZ05hbWVzKQogICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoTnVtYmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIobiA9PiBuID4gMCAmJiBwYXRjaEZsYWcgJiBuKQogICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAobiA9PiBQYXRjaEZsYWdOYW1lc1tuXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAuam9pbihgLCBgKTsKICAgICAgICAgICAgICAgICAgICAgIHZub2RlUGF0Y2hGbGFnID0gcGF0Y2hGbGFnICsgYCAvKiAke2ZsYWdOYW1lc30gKi9gOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkeW5hbWljUHJvcE5hbWVzICYmIGR5bmFtaWNQcm9wTmFtZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHZub2RlRHluYW1pY1Byb3BzID0gc3RyaW5naWZ5RHluYW1pY1Byb3BOYW1lcyhkeW5hbWljUHJvcE5hbWVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLmNvZGVnZW5Ob2RlID0gY3JlYXRlVk5vZGVDYWxsKGNvbnRleHQsIHZub2RlVGFnLCB2bm9kZVByb3BzLCB2bm9kZUNoaWxkcmVuLCB2bm9kZVBhdGNoRmxhZywgdm5vZGVEeW5hbWljUHJvcHMsIHZub2RlRGlyZWN0aXZlcywgISFzaG91bGRVc2VCbG9jaywgZmFsc2UgLyogZGlzYWJsZVRyYWNraW5nICovLCBpc0NvbXBvbmVudCwgbm9kZS5sb2MpOwogICAgICB9OwogIH07CiAgZnVuY3Rpb24gcmVzb2x2ZUNvbXBvbmVudFR5cGUobm9kZSwgY29udGV4dCwgc3NyID0gZmFsc2UpIHsKICAgICAgbGV0IHsgdGFnIH0gPSBub2RlOwogICAgICAvLyAxLiBkeW5hbWljIGNvbXBvbmVudAogICAgICBjb25zdCBpc0V4cGxpY2l0RHluYW1pYyA9IGlzQ29tcG9uZW50VGFnKHRhZyk7CiAgICAgIGNvbnN0IGlzUHJvcCA9IGZpbmRQcm9wKG5vZGUsICdpcycpOwogICAgICBpZiAoaXNQcm9wKSB7CiAgICAgICAgICBpZiAoaXNFeHBsaWNpdER5bmFtaWMgfHwKICAgICAgICAgICAgICAoZmFsc2UgKSkgewogICAgICAgICAgICAgIGNvbnN0IGV4cCA9IGlzUHJvcC50eXBlID09PSA2IC8qIEFUVFJJQlVURSAqLwogICAgICAgICAgICAgICAgICA/IGlzUHJvcC52YWx1ZSAmJiBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGlzUHJvcC52YWx1ZS5jb250ZW50LCB0cnVlKQogICAgICAgICAgICAgICAgICA6IGlzUHJvcC5leHA7CiAgICAgICAgICAgICAgaWYgKGV4cCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVCksIFsKICAgICAgICAgICAgICAgICAgICAgIGV4cAogICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc1Byb3AudHlwZSA9PT0gNiAvKiBBVFRSSUJVVEUgKi8gJiYKICAgICAgICAgICAgICBpc1Byb3AudmFsdWUuY29udGVudC5zdGFydHNXaXRoKCd2dWU6JykpIHsKICAgICAgICAgICAgICAvLyA8YnV0dG9uIGlzPSJ2dWU6eHh4Ij4KICAgICAgICAgICAgICAvLyBpZiBub3QgPGNvbXBvbmVudD4sIG9ubHkgaXMgdmFsdWUgdGhhdCBzdGFydHMgd2l0aCAidnVlOiIgd2lsbCBiZQogICAgICAgICAgICAgIC8vIHRyZWF0ZWQgYXMgY29tcG9uZW50IGJ5IHRoZSBwYXJzZSBwaGFzZSBhbmQgcmVhY2ggaGVyZSwgdW5sZXNzIGl0J3MKICAgICAgICAgICAgICAvLyBjb21wYXQgbW9kZSB3aGVyZSBhbGwgaXMgdmFsdWVzIGFyZSBjb25zaWRlcmVkIGNvbXBvbmVudHMKICAgICAgICAgICAgICB0YWcgPSBpc1Byb3AudmFsdWUuY29udGVudC5zbGljZSg0KTsKICAgICAgICAgIH0KICAgICAgfQogICAgICAvLyAxLjUgdi1pcyAoVE9ETzogRGVwcmVjYXRlKQogICAgICBjb25zdCBpc0RpciA9ICFpc0V4cGxpY2l0RHluYW1pYyAmJiBmaW5kRGlyKG5vZGUsICdpcycpOwogICAgICBpZiAoaXNEaXIgJiYgaXNEaXIuZXhwKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVCksIFsKICAgICAgICAgICAgICBpc0Rpci5leHAKICAgICAgICAgIF0pOwogICAgICB9CiAgICAgIC8vIDIuIGJ1aWx0LWluIGNvbXBvbmVudHMgKFRlbGVwb3J0LCBUcmFuc2l0aW9uLCBLZWVwQWxpdmUsIFN1c3BlbnNlLi4uKQogICAgICBjb25zdCBidWlsdEluID0gaXNDb3JlQ29tcG9uZW50KHRhZykgfHwgY29udGV4dC5pc0J1aWx0SW5Db21wb25lbnQodGFnKTsKICAgICAgaWYgKGJ1aWx0SW4pIHsKICAgICAgICAgIC8vIGJ1aWx0LWlucyBhcmUgc2ltcGx5IGZhbGx0aHJvdWdocyAvIGhhdmUgc3BlY2lhbCBoYW5kbGluZyBkdXJpbmcgc3NyCiAgICAgICAgICAvLyBzbyB3ZSBkb24ndCBuZWVkIHRvIGltcG9ydCB0aGVpciBydW50aW1lIGVxdWl2YWxlbnRzCiAgICAgICAgICBpZiAoIXNzcikKICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcihidWlsdEluKTsKICAgICAgICAgIHJldHVybiBidWlsdEluOwogICAgICB9CiAgICAgIC8vIDUuIHVzZXIgY29tcG9uZW50IChyZXNvbHZlKQogICAgICBjb250ZXh0LmhlbHBlcihSRVNPTFZFX0NPTVBPTkVOVCk7CiAgICAgIGNvbnRleHQuY29tcG9uZW50cy5hZGQodGFnKTsKICAgICAgcmV0dXJuIHRvVmFsaWRBc3NldElkKHRhZywgYGNvbXBvbmVudGApOwogIH0KICBmdW5jdGlvbiBidWlsZFByb3BzKG5vZGUsIGNvbnRleHQsIHByb3BzID0gbm9kZS5wcm9wcywgaXNDb21wb25lbnQsIGlzRHluYW1pY0NvbXBvbmVudCwgc3NyID0gZmFsc2UpIHsKICAgICAgY29uc3QgeyB0YWcsIGxvYzogZWxlbWVudExvYywgY2hpbGRyZW4gfSA9IG5vZGU7CiAgICAgIGxldCBwcm9wZXJ0aWVzID0gW107CiAgICAgIGNvbnN0IG1lcmdlQXJncyA9IFtdOwogICAgICBjb25zdCBydW50aW1lRGlyZWN0aXZlcyA9IFtdOwogICAgICBjb25zdCBoYXNDaGlsZHJlbiA9IGNoaWxkcmVuLmxlbmd0aCA+IDA7CiAgICAgIGxldCBzaG91bGRVc2VCbG9jayA9IGZhbHNlOwogICAgICAvLyBwYXRjaEZsYWcgYW5hbHlzaXMKICAgICAgbGV0IHBhdGNoRmxhZyA9IDA7CiAgICAgIGxldCBoYXNSZWYgPSBmYWxzZTsKICAgICAgbGV0IGhhc0NsYXNzQmluZGluZyA9IGZhbHNlOwogICAgICBsZXQgaGFzU3R5bGVCaW5kaW5nID0gZmFsc2U7CiAgICAgIGxldCBoYXNIeWRyYXRpb25FdmVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgbGV0IGhhc0R5bmFtaWNLZXlzID0gZmFsc2U7CiAgICAgIGxldCBoYXNWbm9kZUhvb2sgPSBmYWxzZTsKICAgICAgY29uc3QgZHluYW1pY1Byb3BOYW1lcyA9IFtdOwogICAgICBjb25zdCBhbmFseXplUGF0Y2hGbGFnID0gKHsga2V5LCB2YWx1ZSB9KSA9PiB7CiAgICAgICAgICBpZiAoaXNTdGF0aWNFeHAoa2V5KSkgewogICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBrZXkuY29udGVudDsKICAgICAgICAgICAgICBjb25zdCBpc0V2ZW50SGFuZGxlciA9IGlzT24obmFtZSk7CiAgICAgICAgICAgICAgaWYgKGlzRXZlbnRIYW5kbGVyICYmCiAgICAgICAgICAgICAgICAgICghaXNDb21wb25lbnQgfHwgaXNEeW5hbWljQ29tcG9uZW50KSAmJgogICAgICAgICAgICAgICAgICAvLyBvbWl0IHRoZSBmbGFnIGZvciBjbGljayBoYW5kbGVycyBiZWNhdXNlIGh5ZHJhdGlvbiBnaXZlcyBjbGljawogICAgICAgICAgICAgICAgICAvLyBkZWRpY2F0ZWQgZmFzdCBwYXRoLgogICAgICAgICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdvbmNsaWNrJyAmJgogICAgICAgICAgICAgICAgICAvLyBvbWl0IHYtbW9kZWwgaGFuZGxlcnMKICAgICAgICAgICAgICAgICAgbmFtZSAhPT0gJ29uVXBkYXRlOm1vZGVsVmFsdWUnICYmCiAgICAgICAgICAgICAgICAgIC8vIG9taXQgb25Wbm9kZVhYWCBob29rcwogICAgICAgICAgICAgICAgICAhaXNSZXNlcnZlZFByb3AobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaGFzSHlkcmF0aW9uRXZlbnRCaW5kaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzRXZlbnRIYW5kbGVyICYmIGlzUmVzZXJ2ZWRQcm9wKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGhhc1Zub2RlSG9vayA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAyMCAvKiBKU19DQUNIRV9FWFBSRVNTSU9OICovIHx8CiAgICAgICAgICAgICAgICAgICgodmFsdWUudHlwZSA9PT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLyB8fAogICAgICAgICAgICAgICAgICAgICAgdmFsdWUudHlwZSA9PT0gOCAvKiBDT01QT1VORF9FWFBSRVNTSU9OICovKSAmJgogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29uc3RhbnRUeXBlKHZhbHVlLCBjb250ZXh0KSA+IDApKSB7CiAgICAgICAgICAgICAgICAgIC8vIHNraXAgaWYgdGhlIHByb3AgaXMgYSBjYWNoZWQgaGFuZGxlciBvciBoYXMgY29uc3RhbnQgdmFsdWUKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3JlZicpIHsKICAgICAgICAgICAgICAgICAgaGFzUmVmID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZiAobmFtZSA9PT0gJ2NsYXNzJykgewogICAgICAgICAgICAgICAgICBoYXNDbGFzc0JpbmRpbmcgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmIChuYW1lID09PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgIGhhc1N0eWxlQmluZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKG5hbWUgIT09ICdrZXknICYmICFkeW5hbWljUHJvcE5hbWVzLmluY2x1ZGVzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGR5bmFtaWNQcm9wTmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gdHJlYXQgdGhlIGR5bmFtaWMgY2xhc3MgYW5kIHN0eWxlIGJpbmRpbmcgb2YgdGhlIGNvbXBvbmVudCBhcyBkeW5hbWljIHByb3BzCiAgICAgICAgICAgICAgaWYgKGlzQ29tcG9uZW50ICYmCiAgICAgICAgICAgICAgICAgIChuYW1lID09PSAnY2xhc3MnIHx8IG5hbWUgPT09ICdzdHlsZScpICYmCiAgICAgICAgICAgICAgICAgICFkeW5hbWljUHJvcE5hbWVzLmluY2x1ZGVzKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGR5bmFtaWNQcm9wTmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBoYXNEeW5hbWljS2V5cyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIC8vIHN0YXRpYyBhdHRyaWJ1dGUKICAgICAgICAgIGNvbnN0IHByb3AgPSBwcm9wc1tpXTsKICAgICAgICAgIGlmIChwcm9wLnR5cGUgPT09IDYgLyogQVRUUklCVVRFICovKSB7CiAgICAgICAgICAgICAgY29uc3QgeyBsb2MsIG5hbWUsIHZhbHVlIH0gPSBwcm9wOwogICAgICAgICAgICAgIGxldCBpc1N0YXRpYyA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdyZWYnKSB7CiAgICAgICAgICAgICAgICAgIGhhc1JlZiA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnNjb3Blcy52Rm9yID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKGNyZWF0ZU9iamVjdFByb3BlcnR5KGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oJ3JlZl9mb3InLCB0cnVlKSwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigndHJ1ZScpKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gc2tpcCBpcyBvbiA8Y29tcG9uZW50Piwgb3IgaXM9InZ1ZTp4eHgiCiAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdpcycgJiYKICAgICAgICAgICAgICAgICAgKGlzQ29tcG9uZW50VGFnKHRhZykgfHwKICAgICAgICAgICAgICAgICAgICAgICh2YWx1ZSAmJiB2YWx1ZS5jb250ZW50LnN0YXJ0c1dpdGgoJ3Z1ZTonKSkgfHwKICAgICAgICAgICAgICAgICAgICAgIChmYWxzZSApKSkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKGNyZWF0ZU9iamVjdFByb3BlcnR5KGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24obmFtZSwgdHJ1ZSwgZ2V0SW5uZXJSYW5nZShsb2MsIDAsIG5hbWUubGVuZ3RoKSksIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24odmFsdWUgPyB2YWx1ZS5jb250ZW50IDogJycsIGlzU3RhdGljLCB2YWx1ZSA/IHZhbHVlLmxvYyA6IGxvYykpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICBjb25zdCB7IG5hbWUsIGFyZywgZXhwLCBsb2MgfSA9IHByb3A7CiAgICAgICAgICAgICAgY29uc3QgaXNWQmluZCA9IG5hbWUgPT09ICdiaW5kJzsKICAgICAgICAgICAgICBjb25zdCBpc1ZPbiA9IG5hbWUgPT09ICdvbic7CiAgICAgICAgICAgICAgLy8gc2tpcCB2LXNsb3QgLSBpdCBpcyBoYW5kbGVkIGJ5IGl0cyBkZWRpY2F0ZWQgdHJhbnNmb3JtLgogICAgICAgICAgICAgIGlmIChuYW1lID09PSAnc2xvdCcpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFpc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDAgLyogWF9WX1NMT1RfTUlTUExBQ0VEICovLCBsb2MpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gc2tpcCB2LW9uY2Uvdi1tZW1vIC0gdGhleSBhcmUgaGFuZGxlZCBieSBkZWRpY2F0ZWQgdHJhbnNmb3Jtcy4KICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ29uY2UnIHx8IG5hbWUgPT09ICdtZW1vJykgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gc2tpcCB2LWlzIGFuZCA6aXMgb24gPGNvbXBvbmVudD4KICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2lzJyB8fAogICAgICAgICAgICAgICAgICAoaXNWQmluZCAmJgogICAgICAgICAgICAgICAgICAgICAgaXNTdGF0aWNBcmdPZihhcmcsICdpcycpICYmCiAgICAgICAgICAgICAgICAgICAgICAoaXNDb21wb25lbnRUYWcodGFnKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgIChmYWxzZSApKSkpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHNraXAgdi1vbiBpbiBTU1IgY29tcGlsYXRpb24KICAgICAgICAgICAgICBpZiAoaXNWT24gJiYgc3NyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gIzkzODogZWxlbWVudHMgd2l0aCBkeW5hbWljIGtleXMgc2hvdWxkIGJlIGZvcmNlZCBpbnRvIGJsb2NrcwogICAgICAgICAgICAgIChpc1ZCaW5kICYmIGlzU3RhdGljQXJnT2YoYXJnLCAna2V5JykpIHx8CiAgICAgICAgICAgICAgICAgIC8vIGlubGluZSBiZWZvcmUtdXBkYXRlIGhvb2tzIG5lZWQgdG8gZm9yY2UgYmxvY2sgc28gdGhhdCBpdCBpcyBpbnZva2VkCiAgICAgICAgICAgICAgICAgIC8vIGJlZm9yZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAoaXNWT24gJiYgaGFzQ2hpbGRyZW4gJiYgaXNTdGF0aWNBcmdPZihhcmcsICd2dWU6YmVmb3JlLXVwZGF0ZScpKSkgewogICAgICAgICAgICAgICAgICBzaG91bGRVc2VCbG9jayA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc1ZCaW5kICYmIGlzU3RhdGljQXJnT2YoYXJnLCAncmVmJykgJiYgY29udGV4dC5zY29wZXMudkZvciA+IDApIHsKICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKGNyZWF0ZU9iamVjdFByb3BlcnR5KGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oJ3JlZl9mb3InLCB0cnVlKSwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigndHJ1ZScpKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3Igdi1iaW5kIGFuZCB2LW9uIHdpdGggbm8gYXJndW1lbnQKICAgICAgICAgICAgICBpZiAoIWFyZyAmJiAoaXNWQmluZCB8fCBpc1ZPbikpIHsKICAgICAgICAgICAgICAgICAgaGFzRHluYW1pY0tleXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICBpZiAoZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZUFyZ3MucHVzaChjcmVhdGVPYmplY3RFeHByZXNzaW9uKGRlZHVwZVByb3BlcnRpZXMocHJvcGVydGllcyksIGVsZW1lbnRMb2MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzID0gW107CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNWQmluZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlQXJncy5wdXNoKGV4cCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB2LW9uPSJvYmoiIC0+IHRvSGFuZGxlcnMob2JqKQogICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlQXJncy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogMTQgLyogSlNfQ0FMTF9FWFBSRVNTSU9OICovLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxlZTogY29udGV4dC5oZWxwZXIoVE9fSEFORExFUlMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudHM6IFtleHBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcihpc1ZCaW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyAzNCAvKiBYX1ZfQklORF9OT19FWFBSRVNTSU9OICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiAzNSAvKiBYX1ZfT05fTk9fRVhQUkVTU0lPTiAqLywgbG9jKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZVRyYW5zZm9ybSA9IGNvbnRleHQuZGlyZWN0aXZlVHJhbnNmb3Jtc1tuYW1lXTsKICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVHJhbnNmb3JtKSB7CiAgICAgICAgICAgICAgICAgIC8vIGhhcyBidWlsdC1pbiBkaXJlY3RpdmUgdHJhbnNmb3JtLgogICAgICAgICAgICAgICAgICBjb25zdCB7IHByb3BzLCBuZWVkUnVudGltZSB9ID0gZGlyZWN0aXZlVHJhbnNmb3JtKHByb3AsIG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAhc3NyICYmIHByb3BzLmZvckVhY2goYW5hbHl6ZVBhdGNoRmxhZyk7CiAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXMucHVzaCguLi5wcm9wcyk7CiAgICAgICAgICAgICAgICAgIGlmIChuZWVkUnVudGltZSkgewogICAgICAgICAgICAgICAgICAgICAgcnVudGltZURpcmVjdGl2ZXMucHVzaChwcm9wKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N5bWJvbChuZWVkUnVudGltZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVJbXBvcnRNYXAuc2V0KHByb3AsIG5lZWRSdW50aW1lKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICghaXNCdWlsdEluRGlyZWN0aXZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIC8vIG5vIGJ1aWx0LWluIHRyYW5zZm9ybSwgdGhpcyBpcyBhIHVzZXIgY3VzdG9tIGRpcmVjdGl2ZS4KICAgICAgICAgICAgICAgICAgcnVudGltZURpcmVjdGl2ZXMucHVzaChwcm9wKTsKICAgICAgICAgICAgICAgICAgLy8gY3VzdG9tIGRpcnMgbWF5IHVzZSBiZWZvcmVVcGRhdGUgc28gdGhleSBuZWVkIHRvIGZvcmNlIGJsb2NrcwogICAgICAgICAgICAgICAgICAvLyB0byBlbnN1cmUgYmVmb3JlLXVwZGF0ZSBnZXRzIGNhbGxlZCBiZWZvcmUgY2hpbGRyZW4gdXBkYXRlCiAgICAgICAgICAgICAgICAgIGlmIChoYXNDaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgICAgc2hvdWxkVXNlQmxvY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGxldCBwcm9wc0V4cHJlc3Npb24gPSB1bmRlZmluZWQ7CiAgICAgIC8vIGhhcyB2LWJpbmQ9Im9iamVjdCIgb3Igdi1vbj0ib2JqZWN0Iiwgd3JhcCB3aXRoIG1lcmdlUHJvcHMKICAgICAgaWYgKG1lcmdlQXJncy5sZW5ndGgpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmxlbmd0aCkgewogICAgICAgICAgICAgIG1lcmdlQXJncy5wdXNoKGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oZGVkdXBlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSwgZWxlbWVudExvYykpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1lcmdlQXJncy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgcHJvcHNFeHByZXNzaW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoTUVSR0VfUFJPUFMpLCBtZXJnZUFyZ3MsIGVsZW1lbnRMb2MpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gc2luZ2xlIHYtYmluZCB3aXRoIG5vdGhpbmcgZWxzZSAtIG5vIG5lZWQgZm9yIGEgbWVyZ2VQcm9wcyBjYWxsCiAgICAgICAgICAgICAgcHJvcHNFeHByZXNzaW9uID0gbWVyZ2VBcmdzWzBdOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgaWYgKHByb3BlcnRpZXMubGVuZ3RoKSB7CiAgICAgICAgICBwcm9wc0V4cHJlc3Npb24gPSBjcmVhdGVPYmplY3RFeHByZXNzaW9uKGRlZHVwZVByb3BlcnRpZXMocHJvcGVydGllcyksIGVsZW1lbnRMb2MpOwogICAgICB9CiAgICAgIC8vIHBhdGNoRmxhZyBhbmFseXNpcwogICAgICBpZiAoaGFzRHluYW1pY0tleXMpIHsKICAgICAgICAgIHBhdGNoRmxhZyB8PSAxNiAvKiBGVUxMX1BST1BTICovOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgaWYgKGhhc0NsYXNzQmluZGluZyAmJiAhaXNDb21wb25lbnQpIHsKICAgICAgICAgICAgICBwYXRjaEZsYWcgfD0gMiAvKiBDTEFTUyAqLzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNTdHlsZUJpbmRpbmcgJiYgIWlzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcGF0Y2hGbGFnIHw9IDQgLyogU1RZTEUgKi87CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZHluYW1pY1Byb3BOYW1lcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBwYXRjaEZsYWcgfD0gOCAvKiBQUk9QUyAqLzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNIeWRyYXRpb25FdmVudEJpbmRpbmcpIHsKICAgICAgICAgICAgICBwYXRjaEZsYWcgfD0gMzIgLyogSFlEUkFURV9FVkVOVFMgKi87CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFzaG91bGRVc2VCbG9jayAmJgogICAgICAgICAgKHBhdGNoRmxhZyA9PT0gMCB8fCBwYXRjaEZsYWcgPT09IDMyIC8qIEhZRFJBVEVfRVZFTlRTICovKSAmJgogICAgICAgICAgKGhhc1JlZiB8fCBoYXNWbm9kZUhvb2sgfHwgcnVudGltZURpcmVjdGl2ZXMubGVuZ3RoID4gMCkpIHsKICAgICAgICAgIHBhdGNoRmxhZyB8PSA1MTIgLyogTkVFRF9QQVRDSCAqLzsKICAgICAgfQogICAgICAvLyBwcmUtbm9ybWFsaXplIHByb3BzLCBTU1IgaXMgc2tpcHBlZCBmb3Igbm93CiAgICAgIGlmICghY29udGV4dC5pblNTUiAmJiBwcm9wc0V4cHJlc3Npb24pIHsKICAgICAgICAgIHN3aXRjaCAocHJvcHNFeHByZXNzaW9uLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIDE1IC8qIEpTX09CSkVDVF9FWFBSRVNTSU9OICovOgogICAgICAgICAgICAgICAgICAvLyBtZWFucyB0aGF0IHRoZXJlIGlzIG5vIHYtYmluZCwKICAgICAgICAgICAgICAgICAgLy8gYnV0IHN0aWxsIG5lZWQgdG8gZGVhbCB3aXRoIGR5bmFtaWMga2V5IGJpbmRpbmcKICAgICAgICAgICAgICAgICAgbGV0IGNsYXNzS2V5SW5kZXggPSAtMTsKICAgICAgICAgICAgICAgICAgbGV0IHN0eWxlS2V5SW5kZXggPSAtMTsKICAgICAgICAgICAgICAgICAgbGV0IGhhc0R5bmFtaWNLZXkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gcHJvcHNFeHByZXNzaW9uLnByb3BlcnRpZXNbaV0ua2V5OwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljRXhwKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5LmNvbnRlbnQgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NLZXlJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGtleS5jb250ZW50ID09PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlS2V5SW5kZXggPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFrZXkuaXNIYW5kbGVyS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzRHluYW1pY0tleSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3QgY2xhc3NQcm9wID0gcHJvcHNFeHByZXNzaW9uLnByb3BlcnRpZXNbY2xhc3NLZXlJbmRleF07CiAgICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlUHJvcCA9IHByb3BzRXhwcmVzc2lvbi5wcm9wZXJ0aWVzW3N0eWxlS2V5SW5kZXhdOwogICAgICAgICAgICAgICAgICAvLyBubyBkeW5hbWljIGtleQogICAgICAgICAgICAgICAgICBpZiAoIWhhc0R5bmFtaWNLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGFzc1Byb3AgJiYgIWlzU3RhdGljRXhwKGNsYXNzUHJvcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc1Byb3AudmFsdWUgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfQ0xBU1MpLCBbY2xhc3NQcm9wLnZhbHVlXSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3R5bGVQcm9wICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHN0YXRpYyBzdHlsZSBpcyBjb21waWxlZCBpbnRvIGFuIG9iamVjdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyB1c2UgYGhhc1N0eWxlQmluZGluZ2AgdG8gZW5zdXJlIHRoYXQgaXQgaXMgYSBkeW5hbWljIHN0eWxlIGJpbmRpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAoaGFzU3R5bGVCaW5kaW5nIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzdHlsZVByb3AudmFsdWUudHlwZSA9PT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVQcm9wLnZhbHVlLmNvbnRlbnQudHJpbSgpWzBdID09PSBgW2ApIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHYtYmluZDpzdHlsZSBhbmQgc3R5bGUgYm90aCBleGlzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdi1iaW5kOnN0eWxlIHdpdGggc3RhdGljIGxpdGVyYWwgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlUHJvcC52YWx1ZS50eXBlID09PSAxNyAvKiBKU19BUlJBWV9FWFBSRVNTSU9OICovKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlUHJvcC52YWx1ZSA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKE5PUk1BTElaRV9TVFlMRSksIFtzdHlsZVByb3AudmFsdWVdKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGR5bmFtaWMga2V5IGJpbmRpbmcsIHdyYXAgd2l0aCBgbm9ybWFsaXplUHJvcHNgCiAgICAgICAgICAgICAgICAgICAgICBwcm9wc0V4cHJlc3Npb24gPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfUFJPUFMpLCBbcHJvcHNFeHByZXNzaW9uXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxNCAvKiBKU19DQUxMX0VYUFJFU1NJT04gKi86CiAgICAgICAgICAgICAgICAgIC8vIG1lcmdlUHJvcHMgY2FsbCwgZG8gbm90aGluZwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAvLyBzaW5nbGUgdi1iaW5kCiAgICAgICAgICAgICAgICAgIHByb3BzRXhwcmVzc2lvbiA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKE5PUk1BTElaRV9QUk9QUyksIFsKICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKEdVQVJEX1JFQUNUSVZFX1BST1BTKSwgWwogICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzRXhwcmVzc2lvbgogICAgICAgICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgICBwcm9wczogcHJvcHNFeHByZXNzaW9uLAogICAgICAgICAgZGlyZWN0aXZlczogcnVudGltZURpcmVjdGl2ZXMsCiAgICAgICAgICBwYXRjaEZsYWcsCiAgICAgICAgICBkeW5hbWljUHJvcE5hbWVzLAogICAgICAgICAgc2hvdWxkVXNlQmxvY2sKICAgICAgfTsKICB9CiAgLy8gRGVkdXBlIHByb3BzIGluIGFuIG9iamVjdCBsaXRlcmFsLgogIC8vIExpdGVyYWwgZHVwbGljYXRlZCBhdHRyaWJ1dGVzIHdvdWxkIGhhdmUgYmVlbiB3YXJuZWQgZHVyaW5nIHRoZSBwYXJzZSBwaGFzZSwKICAvLyBob3dldmVyLCBpdCdzIHBvc3NpYmxlIHRvIGVuY291bnRlciBkdXBsaWNhdGVkIGBvblhYWGAgaGFuZGxlcnMgd2l0aCBkaWZmZXJlbnQKICAvLyBtb2RpZmllcnMuIFdlIGFsc28gbmVlZCB0byBtZXJnZSBzdGF0aWMgYW5kIGR5bmFtaWMgY2xhc3MgLyBzdHlsZSBhdHRyaWJ1dGVzLgogIC8vIC0gb25YWFggaGFuZGxlcnMgLyBzdHlsZTogbWVyZ2UgaW50byBhcnJheQogIC8vIC0gY2xhc3M6IG1lcmdlIGludG8gc2luZ2xlIGV4cHJlc3Npb24gd2l0aCBjb25jYXRlbmF0aW9uCiAgZnVuY3Rpb24gZGVkdXBlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSB7CiAgICAgIGNvbnN0IGtub3duUHJvcHMgPSBuZXcgTWFwKCk7CiAgICAgIGNvbnN0IGRlZHVwZWQgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwcm9wID0gcHJvcGVydGllc1tpXTsKICAgICAgICAgIC8vIGR5bmFtaWMga2V5cyBhcmUgYWx3YXlzIGFsbG93ZWQKICAgICAgICAgIGlmIChwcm9wLmtleS50eXBlID09PSA4IC8qIENPTVBPVU5EX0VYUFJFU1NJT04gKi8gfHwgIXByb3Aua2V5LmlzU3RhdGljKSB7CiAgICAgICAgICAgICAgZGVkdXBlZC5wdXNoKHByb3ApOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgbmFtZSA9IHByb3Aua2V5LmNvbnRlbnQ7CiAgICAgICAgICBjb25zdCBleGlzdGluZyA9IGtub3duUHJvcHMuZ2V0KG5hbWUpOwogICAgICAgICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdzdHlsZScgfHwgbmFtZSA9PT0gJ2NsYXNzJyB8fCBpc09uKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIG1lcmdlQXNBcnJheSQxKGV4aXN0aW5nLCBwcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gdW5leHBlY3RlZCBkdXBsaWNhdGUsIHNob3VsZCBoYXZlIGVtaXR0ZWQgZXJyb3IgZHVyaW5nIHBhcnNlCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBrbm93blByb3BzLnNldChuYW1lLCBwcm9wKTsKICAgICAgICAgICAgICBkZWR1cGVkLnB1c2gocHJvcCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRlZHVwZWQ7CiAgfQogIGZ1bmN0aW9uIG1lcmdlQXNBcnJheSQxKGV4aXN0aW5nLCBpbmNvbWluZykgewogICAgICBpZiAoZXhpc3RpbmcudmFsdWUudHlwZSA9PT0gMTcgLyogSlNfQVJSQVlfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgZXhpc3RpbmcudmFsdWUuZWxlbWVudHMucHVzaChpbmNvbWluZy52YWx1ZSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICBleGlzdGluZy52YWx1ZSA9IGNyZWF0ZUFycmF5RXhwcmVzc2lvbihbZXhpc3RpbmcudmFsdWUsIGluY29taW5nLnZhbHVlXSwgZXhpc3RpbmcubG9jKTsKICAgICAgfQogIH0KICBmdW5jdGlvbiBidWlsZERpcmVjdGl2ZUFyZ3MoZGlyLCBjb250ZXh0KSB7CiAgICAgIGNvbnN0IGRpckFyZ3MgPSBbXTsKICAgICAgY29uc3QgcnVudGltZSA9IGRpcmVjdGl2ZUltcG9ydE1hcC5nZXQoZGlyKTsKICAgICAgaWYgKHJ1bnRpbWUpIHsKICAgICAgICAgIC8vIGJ1aWx0LWluIGRpcmVjdGl2ZSB3aXRoIHJ1bnRpbWUKICAgICAgICAgIGRpckFyZ3MucHVzaChjb250ZXh0LmhlbHBlclN0cmluZyhydW50aW1lKSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gaW5qZWN0IHN0YXRlbWVudCBmb3IgcmVzb2x2aW5nIGRpcmVjdGl2ZQogICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKFJFU09MVkVfRElSRUNUSVZFKTsKICAgICAgICAgICAgICBjb250ZXh0LmRpcmVjdGl2ZXMuYWRkKGRpci5uYW1lKTsKICAgICAgICAgICAgICBkaXJBcmdzLnB1c2godG9WYWxpZEFzc2V0SWQoZGlyLm5hbWUsIGBkaXJlY3RpdmVgKSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgeyBsb2MgfSA9IGRpcjsKICAgICAgaWYgKGRpci5leHApCiAgICAgICAgICBkaXJBcmdzLnB1c2goZGlyLmV4cCk7CiAgICAgIGlmIChkaXIuYXJnKSB7CiAgICAgICAgICBpZiAoIWRpci5leHApIHsKICAgICAgICAgICAgICBkaXJBcmdzLnB1c2goYHZvaWQgMGApOwogICAgICAgICAgfQogICAgICAgICAgZGlyQXJncy5wdXNoKGRpci5hcmcpOwogICAgICB9CiAgICAgIGlmIChPYmplY3Qua2V5cyhkaXIubW9kaWZpZXJzKS5sZW5ndGgpIHsKICAgICAgICAgIGlmICghZGlyLmFyZykgewogICAgICAgICAgICAgIGlmICghZGlyLmV4cCkgewogICAgICAgICAgICAgICAgICBkaXJBcmdzLnB1c2goYHZvaWQgMGApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaXJBcmdzLnB1c2goYHZvaWQgMGApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdHJ1ZUV4cHJlc3Npb24gPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB0cnVlYCwgZmFsc2UsIGxvYyk7CiAgICAgICAgICBkaXJBcmdzLnB1c2goY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihkaXIubW9kaWZpZXJzLm1hcChtb2RpZmllciA9PiBjcmVhdGVPYmplY3RQcm9wZXJ0eShtb2RpZmllciwgdHJ1ZUV4cHJlc3Npb24pKSwgbG9jKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZUFycmF5RXhwcmVzc2lvbihkaXJBcmdzLCBkaXIubG9jKTsKICB9CiAgZnVuY3Rpb24gc3RyaW5naWZ5RHluYW1pY1Byb3BOYW1lcyhwcm9wcykgewogICAgICBsZXQgcHJvcHNOYW1lc1N0cmluZyA9IGBbYDsKICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBwcm9wcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHByb3BzTmFtZXNTdHJpbmcgKz0gSlNPTi5zdHJpbmdpZnkocHJvcHNbaV0pOwogICAgICAgICAgaWYgKGkgPCBsIC0gMSkKICAgICAgICAgICAgICBwcm9wc05hbWVzU3RyaW5nICs9ICcsICc7CiAgICAgIH0KICAgICAgcmV0dXJuIHByb3BzTmFtZXNTdHJpbmcgKyBgXWA7CiAgfQogIGZ1bmN0aW9uIGlzQ29tcG9uZW50VGFnKHRhZykgewogICAgICByZXR1cm4gdGFnID09PSAnY29tcG9uZW50JyB8fCB0YWcgPT09ICdDb21wb25lbnQnOwogIH0KCiAgY29uc3QgdHJhbnNmb3JtU2xvdE91dGxldCA9IChub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGlmIChpc1Nsb3RPdXRsZXQobm9kZSkpIHsKICAgICAgICAgIGNvbnN0IHsgY2hpbGRyZW4sIGxvYyB9ID0gbm9kZTsKICAgICAgICAgIGNvbnN0IHsgc2xvdE5hbWUsIHNsb3RQcm9wcyB9ID0gcHJvY2Vzc1Nsb3RPdXRsZXQobm9kZSwgY29udGV4dCk7CiAgICAgICAgICBjb25zdCBzbG90QXJncyA9IFsKICAgICAgICAgICAgICBjb250ZXh0LnByZWZpeElkZW50aWZpZXJzID8gYF9jdHguJHNsb3RzYCA6IGAkc2xvdHNgLAogICAgICAgICAgICAgIHNsb3ROYW1lLAogICAgICAgICAgICAgICd7fScsCiAgICAgICAgICAgICAgJ3VuZGVmaW5lZCcsCiAgICAgICAgICAgICAgJ3RydWUnCiAgICAgICAgICBdOwogICAgICAgICAgbGV0IGV4cGVjdGVkTGVuID0gMjsKICAgICAgICAgIGlmIChzbG90UHJvcHMpIHsKICAgICAgICAgICAgICBzbG90QXJnc1syXSA9IHNsb3RQcm9wczsKICAgICAgICAgICAgICBleHBlY3RlZExlbiA9IDM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgc2xvdEFyZ3NbM10gPSBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oW10sIGNoaWxkcmVuLCBmYWxzZSwgZmFsc2UsIGxvYyk7CiAgICAgICAgICAgICAgZXhwZWN0ZWRMZW4gPSA0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRleHQuc2NvcGVJZCAmJiAhY29udGV4dC5zbG90dGVkKSB7CiAgICAgICAgICAgICAgZXhwZWN0ZWRMZW4gPSA1OwogICAgICAgICAgfQogICAgICAgICAgc2xvdEFyZ3Muc3BsaWNlKGV4cGVjdGVkTGVuKTsgLy8gcmVtb3ZlIHVudXNlZCBhcmd1bWVudHMKICAgICAgICAgIG5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihSRU5ERVJfU0xPVCksIHNsb3RBcmdzLCBsb2MpOwogICAgICB9CiAgfTsKICBmdW5jdGlvbiBwcm9jZXNzU2xvdE91dGxldChub2RlLCBjb250ZXh0KSB7CiAgICAgIGxldCBzbG90TmFtZSA9IGAiZGVmYXVsdCJgOwogICAgICBsZXQgc2xvdFByb3BzID0gdW5kZWZpbmVkOwogICAgICBjb25zdCBub25OYW1lUHJvcHMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICAgIGlmIChwLnR5cGUgPT09IDYgLyogQVRUUklCVVRFICovKSB7CiAgICAgICAgICAgICAgaWYgKHAudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHAubmFtZSA9PT0gJ25hbWUnKSB7CiAgICAgICAgICAgICAgICAgICAgICBzbG90TmFtZSA9IEpTT04uc3RyaW5naWZ5KHAudmFsdWUuY29udGVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBwLm5hbWUgPSBjYW1lbGl6ZShwLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgbm9uTmFtZVByb3BzLnB1c2gocCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBpZiAocC5uYW1lID09PSAnYmluZCcgJiYgaXNTdGF0aWNBcmdPZihwLmFyZywgJ25hbWUnKSkgewogICAgICAgICAgICAgICAgICBpZiAocC5leHApCiAgICAgICAgICAgICAgICAgICAgICBzbG90TmFtZSA9IHAuZXhwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKHAubmFtZSA9PT0gJ2JpbmQnICYmIHAuYXJnICYmIGlzU3RhdGljRXhwKHAuYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgcC5hcmcuY29udGVudCA9IGNhbWVsaXplKHAuYXJnLmNvbnRlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vbk5hbWVQcm9wcy5wdXNoKHApOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9uTmFtZVByb3BzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHsgcHJvcHMsIGRpcmVjdGl2ZXMgfSA9IGJ1aWxkUHJvcHMobm9kZSwgY29udGV4dCwgbm9uTmFtZVByb3BzLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgc2xvdFByb3BzID0gcHJvcHM7CiAgICAgICAgICBpZiAoZGlyZWN0aXZlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcigzNiAvKiBYX1ZfU0xPVF9VTkVYUEVDVEVEX0RJUkVDVElWRV9PTl9TTE9UX09VVExFVCAqLywgZGlyZWN0aXZlc1swXS5sb2MpKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgc2xvdE5hbWUsCiAgICAgICAgICBzbG90UHJvcHMKICAgICAgfTsKICB9CgogIGNvbnN0IGZuRXhwUkUgPSAvXlxzKihbXHckX10rfChhc3luY1xzKik/XChbXildKj9cKSlccyo9PnxeXHMqKGFzeW5jXHMrKT9mdW5jdGlvbig/OlxzK1tcdyRdKyk/XHMqXCgvOwogIGNvbnN0IHRyYW5zZm9ybU9uID0gKGRpciwgbm9kZSwgY29udGV4dCwgYXVnbWVudG9yKSA9PiB7CiAgICAgIGNvbnN0IHsgbG9jLCBtb2RpZmllcnMsIGFyZyB9ID0gZGlyOwogICAgICBpZiAoIWRpci5leHAgJiYgIW1vZGlmaWVycy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDM1IC8qIFhfVl9PTl9OT19FWFBSRVNTSU9OICovLCBsb2MpKTsKICAgICAgfQogICAgICBsZXQgZXZlbnROYW1lOwogICAgICBpZiAoYXJnLnR5cGUgPT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8pIHsKICAgICAgICAgIGlmIChhcmcuaXNTdGF0aWMpIHsKICAgICAgICAgICAgICBsZXQgcmF3TmFtZSA9IGFyZy5jb250ZW50OwogICAgICAgICAgICAgIC8vIFRPRE8gZGVwcmVjYXRlIEB2bm9kZVhYWCB1c2FnZQogICAgICAgICAgICAgIGlmIChyYXdOYW1lLnN0YXJ0c1dpdGgoJ3Z1ZTonKSkgewogICAgICAgICAgICAgICAgICByYXdOYW1lID0gYHZub2RlLSR7cmF3TmFtZS5zbGljZSg0KX1gOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBmb3IgYWxsIGV2ZW50IGxpc3RlbmVycywgYXV0byBjb252ZXJ0IGl0IHRvIGNhbWVsQ2FzZS4gU2VlIGlzc3VlICMyMjQ5CiAgICAgICAgICAgICAgZXZlbnROYW1lID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbih0b0hhbmRsZXJLZXkoY2FtZWxpemUocmF3TmFtZSkpLCB0cnVlLCBhcmcubG9jKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIC8vICMyMzg4CiAgICAgICAgICAgICAgZXZlbnROYW1lID0gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsKICAgICAgICAgICAgICAgICAgYCR7Y29udGV4dC5oZWxwZXJTdHJpbmcoVE9fSEFORExFUl9LRVkpfShgLAogICAgICAgICAgICAgICAgICBhcmcsCiAgICAgICAgICAgICAgICAgIGApYAogICAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgLy8gYWxyZWFkeSBhIGNvbXBvdW5kIGV4cHJlc3Npb24uCiAgICAgICAgICBldmVudE5hbWUgPSBhcmc7CiAgICAgICAgICBldmVudE5hbWUuY2hpbGRyZW4udW5zaGlmdChgJHtjb250ZXh0LmhlbHBlclN0cmluZyhUT19IQU5ETEVSX0tFWSl9KGApOwogICAgICAgICAgZXZlbnROYW1lLmNoaWxkcmVuLnB1c2goYClgKTsKICAgICAgfQogICAgICAvLyBoYW5kbGVyIHByb2Nlc3NpbmcKICAgICAgbGV0IGV4cCA9IGRpci5leHA7CiAgICAgIGlmIChleHAgJiYgIWV4cC5jb250ZW50LnRyaW0oKSkgewogICAgICAgICAgZXhwID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGxldCBzaG91bGRDYWNoZSA9IGNvbnRleHQuY2FjaGVIYW5kbGVycyAmJiAhZXhwICYmICFjb250ZXh0LmluVk9uY2U7CiAgICAgIGlmIChleHApIHsKICAgICAgICAgIGNvbnN0IGlzTWVtYmVyRXhwID0gaXNNZW1iZXJFeHByZXNzaW9uKGV4cC5jb250ZW50KTsKICAgICAgICAgIGNvbnN0IGlzSW5saW5lU3RhdGVtZW50ID0gIShpc01lbWJlckV4cCB8fCBmbkV4cFJFLnRlc3QoZXhwLmNvbnRlbnQpKTsKICAgICAgICAgIGNvbnN0IGhhc011bHRpcGxlU3RhdGVtZW50cyA9IGV4cC5jb250ZW50LmluY2x1ZGVzKGA7YCk7CiAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbihleHAsIGNvbnRleHQsIGZhbHNlLCBoYXNNdWx0aXBsZVN0YXRlbWVudHMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzSW5saW5lU3RhdGVtZW50IHx8IChzaG91bGRDYWNoZSAmJiBpc01lbWJlckV4cCkpIHsKICAgICAgICAgICAgICAvLyB3cmFwIGlubGluZSBzdGF0ZW1lbnQgaW4gYSBmdW5jdGlvbiBleHByZXNzaW9uCiAgICAgICAgICAgICAgZXhwID0gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsKICAgICAgICAgICAgICAgICAgYCR7aXNJbmxpbmVTdGF0ZW1lbnQKICAgICAgICAgICAgICAgICAgICA/IGAkZXZlbnRgCiAgICAgICAgICAgICAgICAgICAgOiBgJHtgYH0oLi4uYXJncylgfSA9PiAke2hhc011bHRpcGxlU3RhdGVtZW50cyA/IGB7YCA6IGAoYH1gLAogICAgICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgICAgIGhhc011bHRpcGxlU3RhdGVtZW50cyA/IGB9YCA6IGApYAogICAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGxldCByZXQgPSB7CiAgICAgICAgICBwcm9wczogWwogICAgICAgICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KGV2ZW50TmFtZSwgZXhwIHx8IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYCgpID0+IHt9YCwgZmFsc2UsIGxvYykpCiAgICAgICAgICBdCiAgICAgIH07CiAgICAgIC8vIGFwcGx5IGV4dGVuZGVkIGNvbXBpbGVyIGF1Z21lbnRvcgogICAgICBpZiAoYXVnbWVudG9yKSB7CiAgICAgICAgICByZXQgPSBhdWdtZW50b3IocmV0KTsKICAgICAgfQogICAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgICAgIC8vIGNhY2hlIGhhbmRsZXJzIHNvIHRoYXQgaXQncyBhbHdheXMgdGhlIHNhbWUgaGFuZGxlciBiZWluZyBwYXNzZWQgZG93bi4KICAgICAgICAgIC8vIHRoaXMgYXZvaWRzIHVubmVjZXNzYXJ5IHJlLXJlbmRlcnMgd2hlbiB1c2VycyB1c2UgaW5saW5lIGhhbmRsZXJzIG9uCiAgICAgICAgICAvLyBjb21wb25lbnRzLgogICAgICAgICAgcmV0LnByb3BzWzBdLnZhbHVlID0gY29udGV4dC5jYWNoZShyZXQucHJvcHNbMF0udmFsdWUpOwogICAgICB9CiAgICAgIC8vIG1hcmsgdGhlIGtleSBhcyBoYW5kbGVyIGZvciBwcm9wcyBub3JtYWxpemF0aW9uIGNoZWNrCiAgICAgIHJldC5wcm9wcy5mb3JFYWNoKHAgPT4gKHAua2V5LmlzSGFuZGxlcktleSA9IHRydWUpKTsKICAgICAgcmV0dXJuIHJldDsKICB9OwoKICAvLyB2LWJpbmQgd2l0aG91dCBhcmcgaXMgaGFuZGxlZCBkaXJlY3RseSBpbiAuL3RyYW5zZm9ybUVsZW1lbnRzLnRzIGR1ZSB0byBpdCBhZmZlY3RpbmcKICAvLyBjb2RlZ2VuIGZvciB0aGUgZW50aXJlIHByb3BzIG9iamVjdC4gVGhpcyB0cmFuc2Zvcm0gaGVyZSBpcyBvbmx5IGZvciB2LWJpbmQKICAvLyAqd2l0aCogYXJncy4KICBjb25zdCB0cmFuc2Zvcm1CaW5kID0gKGRpciwgX25vZGUsIGNvbnRleHQpID0+IHsKICAgICAgY29uc3QgeyBleHAsIG1vZGlmaWVycywgbG9jIH0gPSBkaXI7CiAgICAgIGNvbnN0IGFyZyA9IGRpci5hcmc7CiAgICAgIGlmIChhcmcudHlwZSAhPT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYChgKTsKICAgICAgICAgIGFyZy5jaGlsZHJlbi5wdXNoKGApIHx8ICIiYCk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoIWFyZy5pc1N0YXRpYykgewogICAgICAgICAgYXJnLmNvbnRlbnQgPSBgJHthcmcuY29udGVudH0gfHwgIiJgOwogICAgICB9CiAgICAgIC8vIC5zeW5jIGlzIHJlcGxhY2VkIGJ5IHYtbW9kZWw6YXJnCiAgICAgIGlmIChtb2RpZmllcnMuaW5jbHVkZXMoJ2NhbWVsJykpIHsKICAgICAgICAgIGlmIChhcmcudHlwZSA9PT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgIGlmIChhcmcuaXNTdGF0aWMpIHsKICAgICAgICAgICAgICAgICAgYXJnLmNvbnRlbnQgPSBjYW1lbGl6ZShhcmcuY29udGVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBhcmcuY29udGVudCA9IGAke2NvbnRleHQuaGVscGVyU3RyaW5nKENBTUVMSVpFKX0oJHthcmcuY29udGVudH0pYDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBhcmcuY2hpbGRyZW4udW5zaGlmdChgJHtjb250ZXh0LmhlbHBlclN0cmluZyhDQU1FTElaRSl9KGApOwogICAgICAgICAgICAgIGFyZy5jaGlsZHJlbi5wdXNoKGApYCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFjb250ZXh0LmluU1NSKSB7CiAgICAgICAgICBpZiAobW9kaWZpZXJzLmluY2x1ZGVzKCdwcm9wJykpIHsKICAgICAgICAgICAgICBpbmplY3RQcmVmaXgoYXJnLCAnLicpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1vZGlmaWVycy5pbmNsdWRlcygnYXR0cicpKSB7CiAgICAgICAgICAgICAgaW5qZWN0UHJlZml4KGFyZywgJ14nKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWV4cCB8fAogICAgICAgICAgKGV4cC50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmICFleHAuY29udGVudC50cmltKCkpKSB7CiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcigzNCAvKiBYX1ZfQklORF9OT19FWFBSRVNTSU9OICovLCBsb2MpKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcHJvcHM6IFtjcmVhdGVPYmplY3RQcm9wZXJ0eShhcmcsIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oJycsIHRydWUsIGxvYykpXQogICAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgcHJvcHM6IFtjcmVhdGVPYmplY3RQcm9wZXJ0eShhcmcsIGV4cCldCiAgICAgIH07CiAgfTsKICBjb25zdCBpbmplY3RQcmVmaXggPSAoYXJnLCBwcmVmaXgpID0+IHsKICAgICAgaWYgKGFyZy50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovKSB7CiAgICAgICAgICBpZiAoYXJnLmlzU3RhdGljKSB7CiAgICAgICAgICAgICAgYXJnLmNvbnRlbnQgPSBwcmVmaXggKyBhcmcuY29udGVudDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGFyZy5jb250ZW50ID0gYFxgJHtwcmVmaXh9XCR7JHthcmcuY29udGVudH19XGBgOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYCcke3ByZWZpeH0nICsgKGApOwogICAgICAgICAgYXJnLmNoaWxkcmVuLnB1c2goYClgKTsKICAgICAgfQogIH07CgogIC8vIE1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMgYW5kIGV4cHJlc3Npb25zIGludG8gYSBzaW5nbGUgZXhwcmVzc2lvbgogIC8vIGUuZy4gPGRpdj5hYmMge3sgZCB9fSB7eyBlIH19PC9kaXY+IHNob3VsZCBoYXZlIGEgc2luZ2xlIGV4cHJlc3Npb24gbm9kZSBhcyBjaGlsZC4KICBjb25zdCB0cmFuc2Zvcm1UZXh0ID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgaWYgKG5vZGUudHlwZSA9PT0gMCAvKiBST09UICovIHx8CiAgICAgICAgICBub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyB8fAogICAgICAgICAgbm9kZS50eXBlID09PSAxMSAvKiBGT1IgKi8gfHwKICAgICAgICAgIG5vZGUudHlwZSA9PT0gMTAgLyogSUZfQlJBTkNIICovKSB7CiAgICAgICAgICAvLyBwZXJmb3JtIHRoZSB0cmFuc2Zvcm0gb24gbm9kZSBleGl0IHNvIHRoYXQgYWxsIGV4cHJlc3Npb25zIGhhdmUgYWxyZWFkeQogICAgICAgICAgLy8gYmVlbiBwcm9jZXNzZWQuCiAgICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbjsKICAgICAgICAgICAgICBsZXQgY3VycmVudENvbnRhaW5lciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBsZXQgaGFzVGV4dCA9IGZhbHNlOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgaWYgKGlzVGV4dChjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGhhc1RleHQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwgY2hpbGRyZW4ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXh0ID0gY2hpbGRyZW5bal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVGV4dChuZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb250YWluZXIgPSBjaGlsZHJlbltpXSA9IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbY2hpbGRdLCBjaGlsZC5sb2MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZSBpbnRvIGN1cnJlbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENvbnRhaW5lci5jaGlsZHJlbi5wdXNoKGAgKyBgLCBuZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4uc3BsaWNlKGosIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q29udGFpbmVyID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFoYXNUZXh0IHx8CiAgICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYSBwbGFpbiBlbGVtZW50IHdpdGggYSBzaW5nbGUgdGV4dCBjaGlsZCwgbGVhdmUgaXQKICAgICAgICAgICAgICAgICAgLy8gYXMtaXMgc2luY2UgdGhlIHJ1bnRpbWUgaGFzIGRlZGljYXRlZCBmYXN0IHBhdGggZm9yIHRoaXMgYnkgZGlyZWN0bHkKICAgICAgICAgICAgICAgICAgLy8gc2V0dGluZyB0ZXh0Q29udGVudCBvZiB0aGUgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgLy8gZm9yIGNvbXBvbmVudCByb290IGl0J3MgYWx3YXlzIG5vcm1hbGl6ZWQgYW55d2F5LgogICAgICAgICAgICAgICAgICAoY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmCiAgICAgICAgICAgICAgICAgICAgICAobm9kZS50eXBlID09PSAwIC8qIFJPT1QgKi8gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAobm9kZS50eXBlID09PSAxIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS50YWdUeXBlID09PSAwIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIzM3NTYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VzdG9tIGRpcmVjdGl2ZXMgY2FuIHBvdGVudGlhbGx5IGFkZCBET00gZWxlbWVudHMgYXJiaXRyYXJpbHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gYXZvaWQgc2V0dGluZyB0ZXh0Q29udGVudCBvZiB0aGUgZWxlbWVudCBhdCBydW50aW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIGF2b2lkIGFjY2lkZW50YWxseSBvdmVyd3JpdGluZyB0aGUgRE9NIGVsZW1lbnRzIGFkZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ5IHRoZSB1c2VyIHRocm91Z2ggY3VzdG9tIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICFub2RlLnByb3BzLmZpbmQocCA9PiBwLnR5cGUgPT09IDcgLyogRElSRUNUSVZFICovICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhY29udGV4dC5kaXJlY3RpdmVUcmFuc2Zvcm1zW3AubmFtZV0pICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIGNvbXBhdCBtb2RlLCA8dGVtcGxhdGU+IHRhZ3Mgd2l0aCBubyBzcGVjaWFsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2lsbCBiZSByZW5kZXJlZCBhcyBhIGZyYWdtZW50IHNvIGl0cyBjaGlsZHJlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnZlcnRlZCBpbnRvIHZub2Rlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIShmYWxzZSApKSkpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gcHJlLWNvbnZlcnQgdGV4dCBub2RlcyBpbnRvIGNyZWF0ZVRleHRWTm9kZSh0ZXh0KSBjYWxscyB0byBhdm9pZAogICAgICAgICAgICAgIC8vIHJ1bnRpbWUgbm9ybWFsaXphdGlvbi4KICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgIGlmIChpc1RleHQoY2hpbGQpIHx8IGNoaWxkLnR5cGUgPT09IDggLyogQ09NUE9VTkRfRVhQUkVTU0lPTiAqLykgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbEFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZVRleHRWTm9kZSBkZWZhdWx0cyB0byBzaW5nbGUgd2hpdGVzcGFjZSwgc28gaWYgaXQgaXMgYQogICAgICAgICAgICAgICAgICAgICAgLy8gc2luZ2xlIHNwYWNlIHRoZSBjb2RlIGNvdWxkIGJlIGFuIGVtcHR5IGNhbGwgdG8gc2F2ZSBieXRlcy4KICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50eXBlICE9PSAyIC8qIFRFWFQgKi8gfHwgY2hpbGQuY29udGVudCAhPT0gJyAnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbEFyZ3MucHVzaChjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAvLyBtYXJrIGR5bmFtaWMgdGV4dCB3aXRoIGZsYWcgc28gaXQgZ2V0cyBwYXRjaGVkIGluc2lkZSBhIGJsb2NrCiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbnRleHQuc3NyICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KSA9PT0gMCAvKiBOT1RfQ09OU1RBTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsQXJncy5wdXNoKDEgLyogVEVYVCAqLyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChgIC8qICR7UGF0Y2hGbGFnTmFtZXNbMSAvKiBURVhUICovXX0gKi9gICkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5baV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogMTIgLyogVEVYVF9DQUxMICovLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGNoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxvYzogY2hpbGQubG9jLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGVnZW5Ob2RlOiBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihDUkVBVEVfVEVYVCksIGNhbGxBcmdzKQogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgIH0KICB9OwoKICBjb25zdCBzZWVuID0gbmV3IFdlYWtTZXQoKTsKICBjb25zdCB0cmFuc2Zvcm1PbmNlID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgaWYgKG5vZGUudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmIGZpbmREaXIobm9kZSwgJ29uY2UnLCB0cnVlKSkgewogICAgICAgICAgaWYgKHNlZW4uaGFzKG5vZGUpIHx8IGNvbnRleHQuaW5WT25jZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHNlZW4uYWRkKG5vZGUpOwogICAgICAgICAgY29udGV4dC5pblZPbmNlID0gdHJ1ZTsKICAgICAgICAgIGNvbnRleHQuaGVscGVyKFNFVF9CTE9DS19UUkFDS0lORyk7CiAgICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICAgIGNvbnRleHQuaW5WT25jZSA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnN0IGN1ciA9IGNvbnRleHQuY3VycmVudE5vZGU7CiAgICAgICAgICAgICAgaWYgKGN1ci5jb2RlZ2VuTm9kZSkgewogICAgICAgICAgICAgICAgICBjdXIuY29kZWdlbk5vZGUgPSBjb250ZXh0LmNhY2hlKGN1ci5jb2RlZ2VuTm9kZSwgdHJ1ZSAvKiBpc1ZOb2RlICovKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICB9CiAgfTsKCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGNvbnN0IHsgZXhwLCBhcmcgfSA9IGRpcjsKICAgICAgaWYgKCFleHApIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDQxIC8qIFhfVl9NT0RFTF9OT19FWFBSRVNTSU9OICovLCBkaXIubG9jKSk7CiAgICAgICAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMoKTsKICAgICAgfQogICAgICBjb25zdCByYXdFeHAgPSBleHAubG9jLnNvdXJjZTsKICAgICAgY29uc3QgZXhwU3RyaW5nID0gZXhwLnR5cGUgPT09IDQgLyogU0lNUExFX0VYUFJFU1NJT04gKi8gPyBleHAuY29udGVudCA6IHJhd0V4cDsKICAgICAgLy8gaW0gU0ZDIDxzY3JpcHQgc2V0dXA+IGlubGluZSBtb2RlLCB0aGUgZXhwIG1heSBoYXZlIGJlZW4gdHJhbnNmb3JtZWQgaW50bwogICAgICAvLyBfdW5yZWYoZXhwKQogICAgICBjb250ZXh0LmJpbmRpbmdNZXRhZGF0YVtyYXdFeHBdOwogICAgICBjb25zdCBtYXliZVJlZiA9ICF0cnVlICAgIC8qIFNFVFVQX0NPTlNUICovOwogICAgICBpZiAoIWV4cFN0cmluZy50cmltKCkgfHwKICAgICAgICAgICghaXNNZW1iZXJFeHByZXNzaW9uKGV4cFN0cmluZykgJiYgIW1heWJlUmVmKSkgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDIgLyogWF9WX01PREVMX01BTEZPUk1FRF9FWFBSRVNTSU9OICovLCBleHAubG9jKSk7CiAgICAgICAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMoKTsKICAgICAgfQogICAgICBjb25zdCBwcm9wTmFtZSA9IGFyZyA/IGFyZyA6IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oJ21vZGVsVmFsdWUnLCB0cnVlKTsKICAgICAgY29uc3QgZXZlbnROYW1lID0gYXJnCiAgICAgICAgICA/IGlzU3RhdGljRXhwKGFyZykKICAgICAgICAgICAgICA/IGBvblVwZGF0ZToke2FyZy5jb250ZW50fWAKICAgICAgICAgICAgICA6IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbJyJvblVwZGF0ZToiICsgJywgYXJnXSkKICAgICAgICAgIDogYG9uVXBkYXRlOm1vZGVsVmFsdWVgOwogICAgICBsZXQgYXNzaWdubWVudEV4cDsKICAgICAgY29uc3QgZXZlbnRBcmcgPSBjb250ZXh0LmlzVFMgPyBgKCRldmVudDogYW55KWAgOiBgJGV2ZW50YDsKICAgICAgewogICAgICAgICAgYXNzaWdubWVudEV4cCA9IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbCiAgICAgICAgICAgICAgYCR7ZXZlbnRBcmd9ID0+ICgoYCwKICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgYCkgPSAkZXZlbnQpYAogICAgICAgICAgXSk7CiAgICAgIH0KICAgICAgY29uc3QgcHJvcHMgPSBbCiAgICAgICAgICAvLyBtb2RlbFZhbHVlOiBmb28KICAgICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KHByb3BOYW1lLCBkaXIuZXhwKSwKICAgICAgICAgIC8vICJvblVwZGF0ZTptb2RlbFZhbHVlIjogJGV2ZW50ID0+IChmb28gPSAkZXZlbnQpCiAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShldmVudE5hbWUsIGFzc2lnbm1lbnRFeHApCiAgICAgIF07CiAgICAgIC8vIG1vZGVsTW9kaWZpZXJzOiB7IGZvbzogdHJ1ZSwgImJhci1iYXoiOiB0cnVlIH0KICAgICAgaWYgKGRpci5tb2RpZmllcnMubGVuZ3RoICYmIG5vZGUudGFnVHlwZSA9PT0gMSAvKiBDT01QT05FTlQgKi8pIHsKICAgICAgICAgIGNvbnN0IG1vZGlmaWVycyA9IGRpci5tb2RpZmllcnMKICAgICAgICAgICAgICAubWFwKG0gPT4gKGlzU2ltcGxlSWRlbnRpZmllcihtKSA/IG0gOiBKU09OLnN0cmluZ2lmeShtKSkgKyBgOiB0cnVlYCkKICAgICAgICAgICAgICAuam9pbihgLCBgKTsKICAgICAgICAgIGNvbnN0IG1vZGlmaWVyc0tleSA9IGFyZwogICAgICAgICAgICAgID8gaXNTdGF0aWNFeHAoYXJnKQogICAgICAgICAgICAgICAgICA/IGAke2FyZy5jb250ZW50fU1vZGlmaWVyc2AKICAgICAgICAgICAgICAgICAgOiBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2FyZywgJyArICJNb2RpZmllcnMiJ10pCiAgICAgICAgICAgICAgOiBgbW9kZWxNb2RpZmllcnNgOwogICAgICAgICAgcHJvcHMucHVzaChjcmVhdGVPYmplY3RQcm9wZXJ0eShtb2RpZmllcnNLZXksIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHsgJHttb2RpZmllcnN9IH1gLCBmYWxzZSwgZGlyLmxvYywgMiAvKiBDQU5fSE9JU1QgKi8pKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZVRyYW5zZm9ybVByb3BzKHByb3BzKTsKICB9OwogIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zZm9ybVByb3BzKHByb3BzID0gW10pIHsKICAgICAgcmV0dXJuIHsgcHJvcHMgfTsKICB9CgogIGNvbnN0IHNlZW4kMSA9IG5ldyBXZWFrU2V0KCk7CiAgY29uc3QgdHJhbnNmb3JtTWVtbyA9IChub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgY29uc3QgZGlyID0gZmluZERpcihub2RlLCAnbWVtbycpOwogICAgICAgICAgaWYgKCFkaXIgfHwgc2VlbiQxLmhhcyhub2RlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHNlZW4kMS5hZGQobm9kZSk7CiAgICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGNvZGVnZW5Ob2RlID0gbm9kZS5jb2RlZ2VuTm9kZSB8fAogICAgICAgICAgICAgICAgICBjb250ZXh0LmN1cnJlbnROb2RlLmNvZGVnZW5Ob2RlOwogICAgICAgICAgICAgIGlmIChjb2RlZ2VuTm9kZSAmJiBjb2RlZ2VuTm9kZS50eXBlID09PSAxMyAvKiBWTk9ERV9DQUxMICovKSB7CiAgICAgICAgICAgICAgICAgIC8vIG5vbi1jb21wb25lbnQgc3ViIHRyZWUgc2hvdWxkIGJlIHR1cm5lZCBpbnRvIGEgYmxvY2sKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUudGFnVHlwZSAhPT0gMSAvKiBDT01QT05FTlQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgIG1ha2VCbG9jayhjb2RlZ2VuTm9kZSwgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZSA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFdJVEhfTUVNTyksIFsKICAgICAgICAgICAgICAgICAgICAgIGRpci5leHAsCiAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24odW5kZWZpbmVkLCBjb2RlZ2VuTm9kZSksCiAgICAgICAgICAgICAgICAgICAgICBgX2NhY2hlYCwKICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyhjb250ZXh0LmNhY2hlZCsrKQogICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0QmFzZVRyYW5zZm9ybVByZXNldChwcmVmaXhJZGVudGlmaWVycykgewogICAgICByZXR1cm4gWwogICAgICAgICAgWwogICAgICAgICAgICAgIHRyYW5zZm9ybU9uY2UsCiAgICAgICAgICAgICAgdHJhbnNmb3JtSWYsCiAgICAgICAgICAgICAgdHJhbnNmb3JtTWVtbywKICAgICAgICAgICAgICB0cmFuc2Zvcm1Gb3IsCiAgICAgICAgICAgICAgLi4uKFtdKSwKICAgICAgICAgICAgICAuLi4oW3RyYW5zZm9ybUV4cHJlc3Npb25dCiAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIHRyYW5zZm9ybVNsb3RPdXRsZXQsCiAgICAgICAgICAgICAgdHJhbnNmb3JtRWxlbWVudCwKICAgICAgICAgICAgICB0cmFja1Nsb3RTY29wZXMsCiAgICAgICAgICAgICAgdHJhbnNmb3JtVGV4dAogICAgICAgICAgXSwKICAgICAgICAgIHsKICAgICAgICAgICAgICBvbjogdHJhbnNmb3JtT24sCiAgICAgICAgICAgICAgYmluZDogdHJhbnNmb3JtQmluZCwKICAgICAgICAgICAgICBtb2RlbDogdHJhbnNmb3JtTW9kZWwKICAgICAgICAgIH0KICAgICAgXTsKICB9CiAgLy8gd2UgbmFtZSBpdCBgYmFzZUNvbXBpbGVgIHNvIHRoYXQgaGlnaGVyIG9yZGVyIGNvbXBpbGVycyBsaWtlCiAgLy8gQHZ1ZS9jb21waWxlci1kb20gY2FuIGV4cG9ydCBgY29tcGlsZWAgd2hpbGUgcmUtZXhwb3J0aW5nIGV2ZXJ5dGhpbmcgZWxzZS4KICBmdW5jdGlvbiBiYXNlQ29tcGlsZSh0ZW1wbGF0ZSwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IG9uRXJyb3IgPSBvcHRpb25zLm9uRXJyb3IgfHwgZGVmYXVsdE9uRXJyb3I7CiAgICAgIGNvbnN0IGlzTW9kdWxlTW9kZSA9IG9wdGlvbnMubW9kZSA9PT0gJ21vZHVsZSc7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICB7CiAgICAgICAgICBpZiAob3B0aW9ucy5wcmVmaXhJZGVudGlmaWVycyA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIG9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcig0NiAvKiBYX1BSRUZJWF9JRF9OT1RfU1VQUE9SVEVEICovKSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChpc01vZHVsZU1vZGUpIHsKICAgICAgICAgICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDcgLyogWF9NT0RVTEVfTU9ERV9OT1RfU1VQUE9SVEVEICovKSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgcHJlZml4SWRlbnRpZmllcnMgPSAhdHJ1ZSA7CiAgICAgIGlmIChvcHRpb25zLmNhY2hlSGFuZGxlcnMpIHsKICAgICAgICAgIG9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcig0OCAvKiBYX0NBQ0hFX0hBTkRMRVJfTk9UX1NVUFBPUlRFRCAqLykpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnNjb3BlSWQgJiYgIWlzTW9kdWxlTW9kZSkgewogICAgICAgICAgb25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDQ5IC8qIFhfU0NPUEVfSURfTk9UX1NVUFBPUlRFRCAqLykpOwogICAgICB9CiAgICAgIGNvbnN0IGFzdCA9IGlzU3RyaW5nKHRlbXBsYXRlKSA/IGJhc2VQYXJzZSh0ZW1wbGF0ZSwgb3B0aW9ucykgOiB0ZW1wbGF0ZTsKICAgICAgY29uc3QgW25vZGVUcmFuc2Zvcm1zLCBkaXJlY3RpdmVUcmFuc2Zvcm1zXSA9IGdldEJhc2VUcmFuc2Zvcm1QcmVzZXQoKTsKICAgICAgdHJhbnNmb3JtKGFzdCwgZXh0ZW5kKHt9LCBvcHRpb25zLCB7CiAgICAgICAgICBwcmVmaXhJZGVudGlmaWVycywKICAgICAgICAgIG5vZGVUcmFuc2Zvcm1zOiBbCiAgICAgICAgICAgICAgLi4ubm9kZVRyYW5zZm9ybXMsCiAgICAgICAgICAgICAgLi4uKG9wdGlvbnMubm9kZVRyYW5zZm9ybXMgfHwgW10pIC8vIHVzZXIgdHJhbnNmb3JtcwogICAgICAgICAgXSwKICAgICAgICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXM6IGV4dGVuZCh7fSwgZGlyZWN0aXZlVHJhbnNmb3Jtcywgb3B0aW9ucy5kaXJlY3RpdmVUcmFuc2Zvcm1zIHx8IHt9IC8vIHVzZXIgdHJhbnNmb3JtcwogICAgICAgICAgKQogICAgICB9KSk7CiAgICAgIHJldHVybiBnZW5lcmF0ZShhc3QsIGV4dGVuZCh7fSwgb3B0aW9ucywgewogICAgICAgICAgcHJlZml4SWRlbnRpZmllcnMKICAgICAgfSkpOwogIH0KCiAgY29uc3Qgbm9vcERpcmVjdGl2ZVRyYW5zZm9ybSA9ICgpID0+ICh7IHByb3BzOiBbXSB9KTsKCiAgY29uc3QgVl9NT0RFTF9SQURJTyA9IFN5bWJvbChgdk1vZGVsUmFkaW9gICk7CiAgY29uc3QgVl9NT0RFTF9DSEVDS0JPWCA9IFN5bWJvbChgdk1vZGVsQ2hlY2tib3hgICk7CiAgY29uc3QgVl9NT0RFTF9URVhUID0gU3ltYm9sKGB2TW9kZWxUZXh0YCApOwogIGNvbnN0IFZfTU9ERUxfU0VMRUNUID0gU3ltYm9sKGB2TW9kZWxTZWxlY3RgICk7CiAgY29uc3QgVl9NT0RFTF9EWU5BTUlDID0gU3ltYm9sKGB2TW9kZWxEeW5hbWljYCApOwogIGNvbnN0IFZfT05fV0lUSF9NT0RJRklFUlMgPSBTeW1ib2woYHZPbk1vZGlmaWVyc0d1YXJkYCApOwogIGNvbnN0IFZfT05fV0lUSF9LRVlTID0gU3ltYm9sKGB2T25LZXlzR3VhcmRgICk7CiAgY29uc3QgVl9TSE9XID0gU3ltYm9sKGB2U2hvd2AgKTsKICBjb25zdCBUUkFOU0lUSU9OJDEgPSBTeW1ib2woYFRyYW5zaXRpb25gICk7CiAgY29uc3QgVFJBTlNJVElPTl9HUk9VUCA9IFN5bWJvbChgVHJhbnNpdGlvbkdyb3VwYCApOwogIHJlZ2lzdGVyUnVudGltZUhlbHBlcnMoewogICAgICBbVl9NT0RFTF9SQURJT106IGB2TW9kZWxSYWRpb2AsCiAgICAgIFtWX01PREVMX0NIRUNLQk9YXTogYHZNb2RlbENoZWNrYm94YCwKICAgICAgW1ZfTU9ERUxfVEVYVF06IGB2TW9kZWxUZXh0YCwKICAgICAgW1ZfTU9ERUxfU0VMRUNUXTogYHZNb2RlbFNlbGVjdGAsCiAgICAgIFtWX01PREVMX0RZTkFNSUNdOiBgdk1vZGVsRHluYW1pY2AsCiAgICAgIFtWX09OX1dJVEhfTU9ESUZJRVJTXTogYHdpdGhNb2RpZmllcnNgLAogICAgICBbVl9PTl9XSVRIX0tFWVNdOiBgd2l0aEtleXNgLAogICAgICBbVl9TSE9XXTogYHZTaG93YCwKICAgICAgW1RSQU5TSVRJT04kMV06IGBUcmFuc2l0aW9uYCwKICAgICAgW1RSQU5TSVRJT05fR1JPVVBdOiBgVHJhbnNpdGlvbkdyb3VwYAogIH0pOwoKICAvKiBlc2xpbnQtZGlzYWJsZSBuby1yZXN0cmljdGVkLWdsb2JhbHMgKi8KICBsZXQgZGVjb2RlcjsKICBmdW5jdGlvbiBkZWNvZGVIdG1sQnJvd3NlcihyYXcsIGFzQXR0ciA9IGZhbHNlKSB7CiAgICAgIGlmICghZGVjb2RlcikgewogICAgICAgICAgZGVjb2RlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICB9CiAgICAgIGlmIChhc0F0dHIpIHsKICAgICAgICAgIGRlY29kZXIuaW5uZXJIVE1MID0gYDxkaXYgZm9vPSIke3Jhdy5yZXBsYWNlKC8iL2csICcmcXVvdDsnKX0iPmA7CiAgICAgICAgICByZXR1cm4gZGVjb2Rlci5jaGlsZHJlblswXS5nZXRBdHRyaWJ1dGUoJ2ZvbycpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgZGVjb2Rlci5pbm5lckhUTUwgPSByYXc7CiAgICAgICAgICByZXR1cm4gZGVjb2Rlci50ZXh0Q29udGVudDsKICAgICAgfQogIH0KCiAgY29uc3QgaXNSYXdUZXh0Q29udGFpbmVyID0gLyojX19QVVJFX18qLyBtYWtlTWFwKCdzdHlsZSxpZnJhbWUsc2NyaXB0LG5vc2NyaXB0JywgdHJ1ZSk7CiAgY29uc3QgcGFyc2VyT3B0aW9ucyA9IHsKICAgICAgaXNWb2lkVGFnLAogICAgICBpc05hdGl2ZVRhZzogdGFnID0+IGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHVGFnKHRhZyksCiAgICAgIGlzUHJlVGFnOiB0YWcgPT4gdGFnID09PSAncHJlJywKICAgICAgZGVjb2RlRW50aXRpZXM6IGRlY29kZUh0bWxCcm93c2VyICwKICAgICAgaXNCdWlsdEluQ29tcG9uZW50OiAodGFnKSA9PiB7CiAgICAgICAgICBpZiAoaXNCdWlsdEluVHlwZSh0YWcsIGBUcmFuc2l0aW9uYCkpIHsKICAgICAgICAgICAgICByZXR1cm4gVFJBTlNJVElPTiQxOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoaXNCdWlsdEluVHlwZSh0YWcsIGBUcmFuc2l0aW9uR3JvdXBgKSkgewogICAgICAgICAgICAgIHJldHVybiBUUkFOU0lUSU9OX0dST1VQOwogICAgICAgICAgfQogICAgICB9LAogICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9wYXJzaW5nLmh0bWwjdHJlZS1jb25zdHJ1Y3Rpb24tZGlzcGF0Y2hlcgogICAgICBnZXROYW1lc3BhY2UodGFnLCBwYXJlbnQpIHsKICAgICAgICAgIGxldCBucyA9IHBhcmVudCA/IHBhcmVudC5ucyA6IDAgLyogSFRNTCAqLzsKICAgICAgICAgIGlmIChwYXJlbnQgJiYgbnMgPT09IDIgLyogTUFUSF9NTCAqLykgewogICAgICAgICAgICAgIGlmIChwYXJlbnQudGFnID09PSAnYW5ub3RhdGlvbi14bWwnKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0YWcgPT09ICdzdmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMSAvKiBTVkcgKi87CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5wcm9wcy5zb21lKGEgPT4gYS50eXBlID09PSA2IC8qIEFUVFJJQlVURSAqLyAmJgogICAgICAgICAgICAgICAgICAgICAgYS5uYW1lID09PSAnZW5jb2RpbmcnICYmCiAgICAgICAgICAgICAgICAgICAgICBhLnZhbHVlICE9IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICAgIChhLnZhbHVlLmNvbnRlbnQgPT09ICd0ZXh0L2h0bWwnIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgYS52YWx1ZS5jb250ZW50ID09PSAnYXBwbGljYXRpb24veGh0bWwreG1sJykpKSB7CiAgICAgICAgICAgICAgICAgICAgICBucyA9IDAgLyogSFRNTCAqLzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICgvXm0oPzpbaW9uc118dGV4dCkkLy50ZXN0KHBhcmVudC50YWcpICYmCiAgICAgICAgICAgICAgICAgIHRhZyAhPT0gJ21nbHlwaCcgJiYKICAgICAgICAgICAgICAgICAgdGFnICE9PSAnbWFsaWdubWFyaycpIHsKICAgICAgICAgICAgICAgICAgbnMgPSAwIC8qIEhUTUwgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAocGFyZW50ICYmIG5zID09PSAxIC8qIFNWRyAqLykgewogICAgICAgICAgICAgIGlmIChwYXJlbnQudGFnID09PSAnZm9yZWlnbk9iamVjdCcgfHwKICAgICAgICAgICAgICAgICAgcGFyZW50LnRhZyA9PT0gJ2Rlc2MnIHx8CiAgICAgICAgICAgICAgICAgIHBhcmVudC50YWcgPT09ICd0aXRsZScpIHsKICAgICAgICAgICAgICAgICAgbnMgPSAwIC8qIEhUTUwgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5zID09PSAwIC8qIEhUTUwgKi8pIHsKICAgICAgICAgICAgICBpZiAodGFnID09PSAnc3ZnJykgewogICAgICAgICAgICAgICAgICByZXR1cm4gMSAvKiBTVkcgKi87CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0YWcgPT09ICdtYXRoJykgewogICAgICAgICAgICAgICAgICByZXR1cm4gMiAvKiBNQVRIX01MICovOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuczsKICAgICAgfSwKICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvcGFyc2luZy5odG1sI3BhcnNpbmctaHRtbC1mcmFnbWVudHMKICAgICAgZ2V0VGV4dE1vZGUoeyB0YWcsIG5zIH0pIHsKICAgICAgICAgIGlmIChucyA9PT0gMCAvKiBIVE1MICovKSB7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gJ3RleHRhcmVhJyB8fCB0YWcgPT09ICd0aXRsZScpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgLyogUkNEQVRBICovOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNSYXdUZXh0Q29udGFpbmVyKHRhZykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIDIgLyogUkFXVEVYVCAqLzsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMCAvKiBEQVRBICovOwogICAgICB9CiAgfTsKCiAgLy8gUGFyc2UgaW5saW5lIENTUyBzdHJpbmdzIGZvciBzdGF0aWMgc3R5bGUgYXR0cmlidXRlcyBpbnRvIGFuIG9iamVjdC4KICAvLyBUaGlzIGlzIGEgTm9kZVRyYW5zZm9ybSBzaW5jZSBpdCB3b3JrcyBvbiB0aGUgc3RhdGljIGBzdHlsZWAgYXR0cmlidXRlIGFuZAogIC8vIGNvbnZlcnRzIGl0IGludG8gYSBkeW5hbWljIGVxdWl2YWxlbnQ6CiAgLy8gc3R5bGU9ImNvbG9yOiByZWQiIC0+IDpzdHlsZT0neyAiY29sb3IiOiAicmVkIiB9JwogIC8vIEl0IGlzIHRoZW4gcHJvY2Vzc2VkIGJ5IGB0cmFuc2Zvcm1FbGVtZW50YCBhbmQgaW5jbHVkZWQgaW4gdGhlIGdlbmVyYXRlZAogIC8vIHByb3BzLgogIGNvbnN0IHRyYW5zZm9ybVN0eWxlID0gbm9kZSA9PiB7CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgbm9kZS5wcm9wcy5mb3JFYWNoKChwLCBpKSA9PiB7CiAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PT0gNiAvKiBBVFRSSUJVVEUgKi8gJiYgcC5uYW1lID09PSAnc3R5bGUnICYmIHAudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgLy8gcmVwbGFjZSBwIHdpdGggYW4gZXhwcmVzc2lvbiBub2RlCiAgICAgICAgICAgICAgICAgIG5vZGUucHJvcHNbaV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiA3IC8qIERJUkVDVElWRSAqLywKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGBiaW5kYCwKICAgICAgICAgICAgICAgICAgICAgIGFyZzogY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgc3R5bGVgLCB0cnVlLCBwLmxvYyksCiAgICAgICAgICAgICAgICAgICAgICBleHA6IHBhcnNlSW5saW5lQ1NTKHAudmFsdWUuY29udGVudCwgcC5sb2MpLAogICAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgIGxvYzogcC5sb2MKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfQogIH07CiAgY29uc3QgcGFyc2VJbmxpbmVDU1MgPSAoY3NzVGV4dCwgbG9jKSA9PiB7CiAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBwYXJzZVN0cmluZ1N0eWxlKGNzc1RleHQpOwogICAgICByZXR1cm4gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihKU09OLnN0cmluZ2lmeShub3JtYWxpemVkKSwgZmFsc2UsIGxvYywgMyAvKiBDQU5fU1RSSU5HSUZZICovKTsKICB9OwoKICBmdW5jdGlvbiBjcmVhdGVET01Db21waWxlckVycm9yKGNvZGUsIGxvYykgewogICAgICByZXR1cm4gY3JlYXRlQ29tcGlsZXJFcnJvcihjb2RlLCBsb2MsIERPTUVycm9yTWVzc2FnZXMgKTsKICB9CiAgY29uc3QgRE9NRXJyb3JNZXNzYWdlcyA9IHsKICAgICAgWzUwIC8qIFhfVl9IVE1MX05PX0VYUFJFU1NJT04gKi9dOiBgdi1odG1sIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgICBbNTEgLyogWF9WX0hUTUxfV0lUSF9DSElMRFJFTiAqL106IGB2LWh0bWwgd2lsbCBvdmVycmlkZSBlbGVtZW50IGNoaWxkcmVuLmAsCiAgICAgIFs1MiAvKiBYX1ZfVEVYVF9OT19FWFBSRVNTSU9OICovXTogYHYtdGV4dCBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgICAgWzUzIC8qIFhfVl9URVhUX1dJVEhfQ0hJTERSRU4gKi9dOiBgdi10ZXh0IHdpbGwgb3ZlcnJpZGUgZWxlbWVudCBjaGlsZHJlbi5gLAogICAgICBbNTQgLyogWF9WX01PREVMX09OX0lOVkFMSURfRUxFTUVOVCAqL106IGB2LW1vZGVsIGNhbiBvbmx5IGJlIHVzZWQgb24gPGlucHV0PiwgPHRleHRhcmVhPiBhbmQgPHNlbGVjdD4gZWxlbWVudHMuYCwKICAgICAgWzU1IC8qIFhfVl9NT0RFTF9BUkdfT05fRUxFTUVOVCAqL106IGB2LW1vZGVsIGFyZ3VtZW50IGlzIG5vdCBzdXBwb3J0ZWQgb24gcGxhaW4gZWxlbWVudHMuYCwKICAgICAgWzU2IC8qIFhfVl9NT0RFTF9PTl9GSUxFX0lOUFVUX0VMRU1FTlQgKi9dOiBgdi1tb2RlbCBjYW5ub3QgYmUgdXNlZCBvbiBmaWxlIGlucHV0cyBzaW5jZSB0aGV5IGFyZSByZWFkLW9ubHkuIFVzZSBhIHYtb246Y2hhbmdlIGxpc3RlbmVyIGluc3RlYWQuYCwKICAgICAgWzU3IC8qIFhfVl9NT0RFTF9VTk5FQ0VTU0FSWV9WQUxVRSAqL106IGBVbm5lY2Vzc2FyeSB2YWx1ZSBiaW5kaW5nIHVzZWQgYWxvbmdzaWRlIHYtbW9kZWwuIEl0IHdpbGwgaW50ZXJmZXJlIHdpdGggdi1tb2RlbCdzIGJlaGF2aW9yLmAsCiAgICAgIFs1OCAvKiBYX1ZfU0hPV19OT19FWFBSRVNTSU9OICovXTogYHYtc2hvdyBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgICAgWzU5IC8qIFhfVFJBTlNJVElPTl9JTlZBTElEX0NISUxEUkVOICovXTogYDxUcmFuc2l0aW9uPiBleHBlY3RzIGV4YWN0bHkgb25lIGNoaWxkIGVsZW1lbnQgb3IgY29tcG9uZW50LmAsCiAgICAgIFs2MCAvKiBYX0lHTk9SRURfU0lERV9FRkZFQ1RfVEFHICovXTogYFRhZ3Mgd2l0aCBzaWRlIGVmZmVjdCAoPHNjcmlwdD4gYW5kIDxzdHlsZT4pIGFyZSBpZ25vcmVkIGluIGNsaWVudCBjb21wb25lbnQgdGVtcGxhdGVzLmAKICB9OwoKICBjb25zdCB0cmFuc2Zvcm1WSHRtbCA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgY29uc3QgeyBleHAsIGxvYyB9ID0gZGlyOwogICAgICBpZiAoIWV4cCkgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTAgLyogWF9WX0hUTUxfTk9fRVhQUkVTU0lPTiAqLywgbG9jKSk7CiAgICAgIH0KICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlRE9NQ29tcGlsZXJFcnJvcig1MSAvKiBYX1ZfSFRNTF9XSVRIX0NISUxEUkVOICovLCBsb2MpKTsKICAgICAgICAgIG5vZGUuY2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAgcHJvcHM6IFsKICAgICAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBpbm5lckhUTUxgLCB0cnVlLCBsb2MpLCBleHAgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbignJywgdHJ1ZSkpCiAgICAgICAgICBdCiAgICAgIH07CiAgfTsKCiAgY29uc3QgdHJhbnNmb3JtVlRleHQgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGNvbnN0IHsgZXhwLCBsb2MgfSA9IGRpcjsKICAgICAgaWYgKCFleHApIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDUyIC8qIFhfVl9URVhUX05PX0VYUFJFU1NJT04gKi8sIGxvYykpOwogICAgICB9CiAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTMgLyogWF9WX1RFWFRfV0lUSF9DSElMRFJFTiAqLywgbG9jKSk7CiAgICAgICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByb3BzOiBbCiAgICAgICAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgdGV4dENvbnRlbnRgLCB0cnVlKSwgZXhwCiAgICAgICAgICAgICAgICAgID8gZ2V0Q29uc3RhbnRUeXBlKGV4cCwgY29udGV4dCkgPiAwCiAgICAgICAgICAgICAgICAgICAgICA/IGV4cAogICAgICAgICAgICAgICAgICAgICAgOiBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlclN0cmluZyhUT19ESVNQTEFZX1NUUklORyksIFtleHBdLCBsb2MpCiAgICAgICAgICAgICAgICAgIDogY3JlYXRlU2ltcGxlRXhwcmVzc2lvbignJywgdHJ1ZSkpCiAgICAgICAgICBdCiAgICAgIH07CiAgfTsKCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwkMSA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgY29uc3QgYmFzZVJlc3VsdCA9IHRyYW5zZm9ybU1vZGVsKGRpciwgbm9kZSwgY29udGV4dCk7CiAgICAgIC8vIGJhc2UgdHJhbnNmb3JtIGhhcyBlcnJvcnMgT1IgY29tcG9uZW50IHYtbW9kZWwgKG9ubHkgbmVlZCBwcm9wcykKICAgICAgaWYgKCFiYXNlUmVzdWx0LnByb3BzLmxlbmd0aCB8fCBub2RlLnRhZ1R5cGUgPT09IDEgLyogQ09NUE9ORU5UICovKSB7CiAgICAgICAgICByZXR1cm4gYmFzZVJlc3VsdDsKICAgICAgfQogICAgICBpZiAoZGlyLmFyZykgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTUgLyogWF9WX01PREVMX0FSR19PTl9FTEVNRU5UICovLCBkaXIuYXJnLmxvYykpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrRHVwbGljYXRlZFZhbHVlKCkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSBmaW5kUHJvcChub2RlLCAndmFsdWUnKTsKICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDU3IC8qIFhfVl9NT0RFTF9VTk5FQ0VTU0FSWV9WQUxVRSAqLywgdmFsdWUubG9jKSk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgeyB0YWcgfSA9IG5vZGU7CiAgICAgIGNvbnN0IGlzQ3VzdG9tRWxlbWVudCA9IGNvbnRleHQuaXNDdXN0b21FbGVtZW50KHRhZyk7CiAgICAgIGlmICh0YWcgPT09ICdpbnB1dCcgfHwKICAgICAgICAgIHRhZyA9PT0gJ3RleHRhcmVhJyB8fAogICAgICAgICAgdGFnID09PSAnc2VsZWN0JyB8fAogICAgICAgICAgaXNDdXN0b21FbGVtZW50KSB7CiAgICAgICAgICBsZXQgZGlyZWN0aXZlVG9Vc2UgPSBWX01PREVMX1RFWFQ7CiAgICAgICAgICBsZXQgaXNJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICAgICAgaWYgKHRhZyA9PT0gJ2lucHV0JyB8fCBpc0N1c3RvbUVsZW1lbnQpIHsKICAgICAgICAgICAgICBjb25zdCB0eXBlID0gZmluZFByb3Aobm9kZSwgYHR5cGVgKTsKICAgICAgICAgICAgICBpZiAodHlwZSkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZS50eXBlID09PSA3IC8qIERJUkVDVElWRSAqLykgewogICAgICAgICAgICAgICAgICAgICAgLy8gOnR5cGU9ImZvbyIKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9EWU5BTUlDOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZS52YWx1ZS5jb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVUb1VzZSA9IFZfTU9ERUxfUkFESU87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlVG9Vc2UgPSBWX01PREVMX0NIRUNLQk9YOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmaWxlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNJbnZhbGlkVHlwZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDU2IC8qIFhfVl9NT0RFTF9PTl9GSUxFX0lOUFVUX0VMRU1FTlQgKi8sIGRpci5sb2MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGV4dCB0eXBlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlZFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKGhhc0R5bmFtaWNLZXlWQmluZChub2RlKSkgewogICAgICAgICAgICAgICAgICAvLyBlbGVtZW50IGhhcyBiaW5kaW5ncyB3aXRoIGR5bmFtaWMga2V5cywgd2hpY2ggY2FuIHBvc3NpYmx5IGNvbnRhaW4KICAgICAgICAgICAgICAgICAgLy8gInR5cGUiLgogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVUb1VzZSA9IFZfTU9ERUxfRFlOQU1JQzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIHRleHQgdHlwZQogICAgICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZWRWYWx1ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgICAgICAgICBkaXJlY3RpdmVUb1VzZSA9IFZfTU9ERUxfU0VMRUNUOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gdGV4dGFyZWEKICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZWRWYWx1ZSgpOwogICAgICAgICAgfQogICAgICAgICAgLy8gaW5qZWN0IHJ1bnRpbWUgZGlyZWN0aXZlCiAgICAgICAgICAvLyBieSByZXR1cm5pbmcgdGhlIGhlbHBlciBzeW1ib2wgdmlhIG5lZWRSdW50aW1lCiAgICAgICAgICAvLyB0aGUgaW1wb3J0IHdpbGwgcmVwbGFjZWQgYSByZXNvbHZlRGlyZWN0aXZlIGNhbGwuCiAgICAgICAgICBpZiAoIWlzSW52YWxpZFR5cGUpIHsKICAgICAgICAgICAgICBiYXNlUmVzdWx0Lm5lZWRSdW50aW1lID0gY29udGV4dC5oZWxwZXIoZGlyZWN0aXZlVG9Vc2UpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTQgLyogWF9WX01PREVMX09OX0lOVkFMSURfRUxFTUVOVCAqLywgZGlyLmxvYykpOwogICAgICB9CiAgICAgIC8vIG5hdGl2ZSB2bW9kZWwgZG9lc24ndCBuZWVkIHRoZSBgbW9kZWxWYWx1ZWAgcHJvcHMgc2luY2UgdGhleSBhcmUgYWxzbwogICAgICAvLyBwYXNzZWQgdG8gdGhlIHJ1bnRpbWUgYXMgYGJpbmRpbmcudmFsdWVgLiByZW1vdmluZyBpdCByZWR1Y2VzIGNvZGUgc2l6ZS4KICAgICAgYmFzZVJlc3VsdC5wcm9wcyA9IGJhc2VSZXN1bHQucHJvcHMuZmlsdGVyKHAgPT4gIShwLmtleS50eXBlID09PSA0IC8qIFNJTVBMRV9FWFBSRVNTSU9OICovICYmCiAgICAgICAgICBwLmtleS5jb250ZW50ID09PSAnbW9kZWxWYWx1ZScpKTsKICAgICAgcmV0dXJuIGJhc2VSZXN1bHQ7CiAgfTsKCiAgY29uc3QgaXNFdmVudE9wdGlvbk1vZGlmaWVyID0gLyojX19QVVJFX18qLyBtYWtlTWFwKGBwYXNzaXZlLG9uY2UsY2FwdHVyZWApOwogIGNvbnN0IGlzTm9uS2V5TW9kaWZpZXIgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoCiAgLy8gZXZlbnQgcHJvcGFnYXRpb24gbWFuYWdlbWVudApgc3RvcCxwcmV2ZW50LHNlbGYsYCAgICsKICAgICAgLy8gc3lzdGVtIG1vZGlmaWVycyArIGV4YWN0CiAgICAgIGBjdHJsLHNoaWZ0LGFsdCxtZXRhLGV4YWN0LGAgKwogICAgICAvLyBtb3VzZQogICAgICBgbWlkZGxlYCk7CiAgLy8gbGVmdCAmIHJpZ2h0IGNvdWxkIGJlIG1vdXNlIG9yIGtleSBtb2RpZmllcnMgYmFzZWQgb24gZXZlbnQgdHlwZQogIGNvbnN0IG1heWJlS2V5TW9kaWZpZXIgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoJ2xlZnQscmlnaHQnKTsKICBjb25zdCBpc0tleWJvYXJkRXZlbnQgPSAvKiNfX1BVUkVfXyovIG1ha2VNYXAoYG9ua2V5dXAsb25rZXlkb3duLG9ua2V5cHJlc3NgLCB0cnVlKTsKICBjb25zdCByZXNvbHZlTW9kaWZpZXJzID0gKGtleSwgbW9kaWZpZXJzLCBjb250ZXh0LCBsb2MpID0+IHsKICAgICAgY29uc3Qga2V5TW9kaWZpZXJzID0gW107CiAgICAgIGNvbnN0IG5vbktleU1vZGlmaWVycyA9IFtdOwogICAgICBjb25zdCBldmVudE9wdGlvbk1vZGlmaWVycyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZGlmaWVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgbW9kaWZpZXIgPSBtb2RpZmllcnNbaV07CiAgICAgICAgICBpZiAoaXNFdmVudE9wdGlvbk1vZGlmaWVyKG1vZGlmaWVyKSkgewogICAgICAgICAgICAgIC8vIGV2ZW50T3B0aW9uTW9kaWZpZXJzOiBtb2RpZmllcnMgZm9yIGFkZEV2ZW50TGlzdGVuZXIoKSBvcHRpb25zLAogICAgICAgICAgICAgIC8vIGUuZy4gLnBhc3NpdmUgJiAuY2FwdHVyZQogICAgICAgICAgICAgIGV2ZW50T3B0aW9uTW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gcnVudGltZU1vZGlmaWVyczogbW9kaWZpZXJzIHRoYXQgbmVlZHMgcnVudGltZSBndWFyZHMKICAgICAgICAgICAgICBpZiAobWF5YmVLZXlNb2RpZmllcihtb2RpZmllcikpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljRXhwKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0tleWJvYXJkRXZlbnQoa2V5LmNvbnRlbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9uS2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgbm9uS2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoaXNOb25LZXlNb2RpZmllcihtb2RpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vbktleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGtleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICAga2V5TW9kaWZpZXJzLAogICAgICAgICAgbm9uS2V5TW9kaWZpZXJzLAogICAgICAgICAgZXZlbnRPcHRpb25Nb2RpZmllcnMKICAgICAgfTsKICB9OwogIGNvbnN0IHRyYW5zZm9ybUNsaWNrID0gKGtleSwgZXZlbnQpID0+IHsKICAgICAgY29uc3QgaXNTdGF0aWNDbGljayA9IGlzU3RhdGljRXhwKGtleSkgJiYga2V5LmNvbnRlbnQudG9Mb3dlckNhc2UoKSA9PT0gJ29uY2xpY2snOwogICAgICByZXR1cm4gaXNTdGF0aWNDbGljawogICAgICAgICAgPyBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGV2ZW50LCB0cnVlKQogICAgICAgICAgOiBrZXkudHlwZSAhPT0gNCAvKiBTSU1QTEVfRVhQUkVTU0lPTiAqLwogICAgICAgICAgICAgID8gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsKICAgICAgICAgICAgICAgICAgYChgLAogICAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICAgIGApID09PSAib25DbGljayIgPyAiJHtldmVudH0iIDogKGAsCiAgICAgICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICAgICAgYClgCiAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICA6IGtleTsKICB9OwogIGNvbnN0IHRyYW5zZm9ybU9uJDEgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIHJldHVybiB0cmFuc2Zvcm1PbihkaXIsIG5vZGUsIGNvbnRleHQsIGJhc2VSZXN1bHQgPT4gewogICAgICAgICAgY29uc3QgeyBtb2RpZmllcnMgfSA9IGRpcjsKICAgICAgICAgIGlmICghbW9kaWZpZXJzLmxlbmd0aCkKICAgICAgICAgICAgICByZXR1cm4gYmFzZVJlc3VsdDsKICAgICAgICAgIGxldCB7IGtleSwgdmFsdWU6IGhhbmRsZXJFeHAgfSA9IGJhc2VSZXN1bHQucHJvcHNbMF07CiAgICAgICAgICBjb25zdCB7IGtleU1vZGlmaWVycywgbm9uS2V5TW9kaWZpZXJzLCBldmVudE9wdGlvbk1vZGlmaWVycyB9ID0gcmVzb2x2ZU1vZGlmaWVycyhrZXksIG1vZGlmaWVycywgY29udGV4dCwgZGlyLmxvYyk7CiAgICAgICAgICAvLyBub3JtYWxpemUgY2xpY2sucmlnaHQgYW5kIGNsaWNrLm1pZGRsZSBzaW5jZSB0aGV5IGRvbid0IGFjdHVhbGx5IGZpcmUKICAgICAgICAgIGlmIChub25LZXlNb2RpZmllcnMuaW5jbHVkZXMoJ3JpZ2h0JykpIHsKICAgICAgICAgICAgICBrZXkgPSB0cmFuc2Zvcm1DbGljayhrZXksIGBvbkNvbnRleHRtZW51YCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9uS2V5TW9kaWZpZXJzLmluY2x1ZGVzKCdtaWRkbGUnKSkgewogICAgICAgICAgICAgIGtleSA9IHRyYW5zZm9ybUNsaWNrKGtleSwgYG9uTW91c2V1cGApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vbktleU1vZGlmaWVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICBoYW5kbGVyRXhwID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoVl9PTl9XSVRIX01PRElGSUVSUyksIFsKICAgICAgICAgICAgICAgICAgaGFuZGxlckV4cCwKICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkobm9uS2V5TW9kaWZpZXJzKQogICAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGtleU1vZGlmaWVycy5sZW5ndGggJiYKICAgICAgICAgICAgICAvLyBpZiBldmVudCBuYW1lIGlzIGR5bmFtaWMsIGFsd2F5cyB3cmFwIHdpdGgga2V5cyBndWFyZAogICAgICAgICAgICAgICghaXNTdGF0aWNFeHAoa2V5KSB8fCBpc0tleWJvYXJkRXZlbnQoa2V5LmNvbnRlbnQpKSkgewogICAgICAgICAgICAgIGhhbmRsZXJFeHAgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihWX09OX1dJVEhfS0VZUyksIFsKICAgICAgICAgICAgICAgICAgaGFuZGxlckV4cCwKICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoa2V5TW9kaWZpZXJzKQogICAgICAgICAgICAgIF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV2ZW50T3B0aW9uTW9kaWZpZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnN0IG1vZGlmaWVyUG9zdGZpeCA9IGV2ZW50T3B0aW9uTW9kaWZpZXJzLm1hcChjYXBpdGFsaXplKS5qb2luKCcnKTsKICAgICAgICAgICAgICBrZXkgPSBpc1N0YXRpY0V4cChrZXkpCiAgICAgICAgICAgICAgICAgID8gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgJHtrZXkuY29udGVudH0ke21vZGlmaWVyUG9zdGZpeH1gLCB0cnVlKQogICAgICAgICAgICAgICAgICA6IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbYChgLCBrZXksIGApICsgIiR7bW9kaWZpZXJQb3N0Zml4fSJgXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHByb3BzOiBbY3JlYXRlT2JqZWN0UHJvcGVydHkoa2V5LCBoYW5kbGVyRXhwKV0KICAgICAgICAgIH07CiAgICAgIH0pOwogIH07CgogIGNvbnN0IHRyYW5zZm9ybVNob3cgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICAgIGNvbnN0IHsgZXhwLCBsb2MgfSA9IGRpcjsKICAgICAgaWYgKCFleHApIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDU4IC8qIFhfVl9TSE9XX05PX0VYUFJFU1NJT04gKi8sIGxvYykpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgICBwcm9wczogW10sCiAgICAgICAgICBuZWVkUnVudGltZTogY29udGV4dC5oZWxwZXIoVl9TSE9XKQogICAgICB9OwogIH07CgogIGNvbnN0IHRyYW5zZm9ybVRyYW5zaXRpb24gPSAobm9kZSwgY29udGV4dCkgPT4gewogICAgICBpZiAobm9kZS50eXBlID09PSAxIC8qIEVMRU1FTlQgKi8gJiYKICAgICAgICAgIG5vZGUudGFnVHlwZSA9PT0gMSAvKiBDT01QT05FTlQgKi8pIHsKICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGNvbnRleHQuaXNCdWlsdEluQ29tcG9uZW50KG5vZGUudGFnKTsKICAgICAgICAgIGlmIChjb21wb25lbnQgPT09IFRSQU5TSVRJT04kMSkgewogICAgICAgICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICghbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyB3YXJuIG11bHRpcGxlIHRyYW5zaXRpb24gY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgaWYgKGhhc011bHRpcGxlQ2hpbGRyZW4obm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDU5IC8qIFhfVFJBTlNJVElPTl9JTlZBTElEX0NISUxEUkVOICovLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuY2hpbGRyZW5bMF0ubG9jLnN0YXJ0LAogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogbm9kZS5jaGlsZHJlbltub2RlLmNoaWxkcmVuLmxlbmd0aCAtIDFdLmxvYy5lbmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiAnJwogICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGl0J3MgcyBzaW5nbGUgY2hpbGQgdy8gdi1zaG93CiAgICAgICAgICAgICAgICAgIC8vIGlmIHllcywgaW5qZWN0ICJwZXJzaXN0ZWQ6IHRydWUiIHRvIHRoZSB0cmFuc2l0aW9uIHByb3BzCiAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IDEgLyogRUxFTUVOVCAqLykgewogICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIGNoaWxkLnByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PT0gNyAvKiBESVJFQ1RJVkUgKi8gJiYgcC5uYW1lID09PSAnc2hvdycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wcm9wcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IDYgLyogQVRUUklCVVRFICovLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3BlcnNpc3RlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jOiBub2RlLmxvYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICB9CiAgfTsKICBmdW5jdGlvbiBoYXNNdWx0aXBsZUNoaWxkcmVuKG5vZGUpIHsKICAgICAgLy8gIzEzNTIgZmlsdGVyIG91dCBwb3RlbnRpYWwgY29tbWVudCBub2Rlcy4KICAgICAgY29uc3QgY2hpbGRyZW4gPSAobm9kZS5jaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW4uZmlsdGVyKGMgPT4gYy50eXBlICE9PSAzIC8qIENPTU1FTlQgKi8gJiYKICAgICAgICAgICEoYy50eXBlID09PSAyIC8qIFRFWFQgKi8gJiYgIWMuY29udGVudC50cmltKCkpKSk7CiAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5bMF07CiAgICAgIHJldHVybiAoY2hpbGRyZW4ubGVuZ3RoICE9PSAxIHx8CiAgICAgICAgICBjaGlsZC50eXBlID09PSAxMSAvKiBGT1IgKi8gfHwKICAgICAgICAgIChjaGlsZC50eXBlID09PSA5IC8qIElGICovICYmIGNoaWxkLmJyYW5jaGVzLnNvbWUoaGFzTXVsdGlwbGVDaGlsZHJlbikpKTsKICB9CgogIGNvbnN0IGlnbm9yZVNpZGVFZmZlY3RUYWdzID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgICAgaWYgKG5vZGUudHlwZSA9PT0gMSAvKiBFTEVNRU5UICovICYmCiAgICAgICAgICBub2RlLnRhZ1R5cGUgPT09IDAgLyogRUxFTUVOVCAqLyAmJgogICAgICAgICAgKG5vZGUudGFnID09PSAnc2NyaXB0JyB8fCBub2RlLnRhZyA9PT0gJ3N0eWxlJykpIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVET01Db21waWxlckVycm9yKDYwIC8qIFhfSUdOT1JFRF9TSURFX0VGRkVDVF9UQUcgKi8sIG5vZGUubG9jKSk7CiAgICAgICAgICBjb250ZXh0LnJlbW92ZU5vZGUoKTsKICAgICAgfQogIH07CgogIGNvbnN0IERPTU5vZGVUcmFuc2Zvcm1zID0gWwogICAgICB0cmFuc2Zvcm1TdHlsZSwKICAgICAgLi4uKFt0cmFuc2Zvcm1UcmFuc2l0aW9uXSApCiAgXTsKICBjb25zdCBET01EaXJlY3RpdmVUcmFuc2Zvcm1zID0gewogICAgICBjbG9hazogbm9vcERpcmVjdGl2ZVRyYW5zZm9ybSwKICAgICAgaHRtbDogdHJhbnNmb3JtVkh0bWwsCiAgICAgIHRleHQ6IHRyYW5zZm9ybVZUZXh0LAogICAgICBtb2RlbDogdHJhbnNmb3JtTW9kZWwkMSwKICAgICAgb246IHRyYW5zZm9ybU9uJDEsCiAgICAgIHNob3c6IHRyYW5zZm9ybVNob3cKICB9OwogIGZ1bmN0aW9uIGNvbXBpbGUkMSh0ZW1wbGF0ZSwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIHJldHVybiBiYXNlQ29tcGlsZSh0ZW1wbGF0ZSwgZXh0ZW5kKHt9LCBwYXJzZXJPcHRpb25zLCBvcHRpb25zLCB7CiAgICAgICAgICBub2RlVHJhbnNmb3JtczogWwogICAgICAgICAgICAgIC8vIGlnbm9yZSA8c2NyaXB0PiBhbmQgPHRhZz4KICAgICAgICAgICAgICAvLyB0aGlzIGlzIG5vdCBwdXQgaW5zaWRlIERPTU5vZGVUcmFuc2Zvcm1zIGJlY2F1c2UgdGhhdCBsaXN0IGlzIHVzZWQKICAgICAgICAgICAgICAvLyBieSBjb21waWxlci1zc3IgdG8gZ2VuZXJhdGUgdm5vZGUgZmFsbGJhY2sgYnJhbmNoZXMKICAgICAgICAgICAgICBpZ25vcmVTaWRlRWZmZWN0VGFncywKICAgICAgICAgICAgICAuLi5ET01Ob2RlVHJhbnNmb3JtcywKICAgICAgICAgICAgICAuLi4ob3B0aW9ucy5ub2RlVHJhbnNmb3JtcyB8fCBbXSkKICAgICAgICAgIF0sCiAgICAgICAgICBkaXJlY3RpdmVUcmFuc2Zvcm1zOiBleHRlbmQoe30sIERPTURpcmVjdGl2ZVRyYW5zZm9ybXMsIG9wdGlvbnMuZGlyZWN0aXZlVHJhbnNmb3JtcyB8fCB7fSksCiAgICAgICAgICB0cmFuc2Zvcm1Ib2lzdDogbnVsbCAKICAgICAgfSkpOwogIH0KCiAgLy8gVGhpcyBlbnRyeSBpcyB0aGUgImZ1bGwtYnVpbGQiIHRoYXQgaW5jbHVkZXMgYm90aCB0aGUgcnVudGltZQogIHsKICAgICAgaW5pdERldigpOwogIH0KICBjb25zdCBjb21waWxlQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIGZ1bmN0aW9uIGNvbXBpbGVUb0Z1bmN0aW9uKHRlbXBsYXRlLCBvcHRpb25zKSB7CiAgICAgIGlmICghaXNTdHJpbmcodGVtcGxhdGUpKSB7CiAgICAgICAgICBpZiAodGVtcGxhdGUubm9kZVR5cGUpIHsKICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlLmlubmVySFRNTDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm4kMShgaW52YWxpZCB0ZW1wbGF0ZSBvcHRpb246IGAsIHRlbXBsYXRlKTsKICAgICAgICAgICAgICByZXR1cm4gTk9PUDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBrZXkgPSB0ZW1wbGF0ZTsKICAgICAgY29uc3QgY2FjaGVkID0gY29tcGlsZUNhY2hlW2tleV07CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgIH0KICAgICAgaWYgKHRlbXBsYXRlWzBdID09PSAnIycpIHsKICAgICAgICAgIGNvbnN0IGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0ZW1wbGF0ZSk7CiAgICAgICAgICBpZiAoIWVsKSB7CiAgICAgICAgICAgICAgd2FybiQxKGBUZW1wbGF0ZSBlbGVtZW50IG5vdCBmb3VuZCBvciBpcyBlbXB0eTogJHt0ZW1wbGF0ZX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIF9fVU5TQUZFX18KICAgICAgICAgIC8vIFJlYXNvbjogcG90ZW50aWFsIGV4ZWN1dGlvbiBvZiBKUyBleHByZXNzaW9ucyBpbiBpbi1ET00gdGVtcGxhdGUuCiAgICAgICAgICAvLyBUaGUgdXNlciBtdXN0IG1ha2Ugc3VyZSB0aGUgaW4tRE9NIHRlbXBsYXRlIGlzIHRydXN0ZWQuIElmIGl0J3MgcmVuZGVyZWQKICAgICAgICAgIC8vIGJ5IHRoZSBzZXJ2ZXIsIHRoZSB0ZW1wbGF0ZSBzaG91bGQgbm90IGNvbnRhaW4gYW55IHVzZXIgZGF0YS4KICAgICAgICAgIHRlbXBsYXRlID0gZWwgPyBlbC5pbm5lckhUTUwgOiBgYDsKICAgICAgfQogICAgICBjb25zdCB7IGNvZGUgfSA9IGNvbXBpbGUkMSh0ZW1wbGF0ZSwgZXh0ZW5kKHsKICAgICAgICAgIGhvaXN0U3RhdGljOiB0cnVlLAogICAgICAgICAgb25FcnJvcjogb25FcnJvciAsCiAgICAgICAgICBvbldhcm46IGUgPT4gb25FcnJvcihlLCB0cnVlKSAKICAgICAgfSwgb3B0aW9ucykpOwogICAgICBmdW5jdGlvbiBvbkVycm9yKGVyciwgYXNXYXJuaW5nID0gZmFsc2UpIHsKICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBhc1dhcm5pbmcKICAgICAgICAgICAgICA/IGVyci5tZXNzYWdlCiAgICAgICAgICAgICAgOiBgVGVtcGxhdGUgY29tcGlsYXRpb24gZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YDsKICAgICAgICAgIGNvbnN0IGNvZGVGcmFtZSA9IGVyci5sb2MgJiYKICAgICAgICAgICAgICBnZW5lcmF0ZUNvZGVGcmFtZSh0ZW1wbGF0ZSwgZXJyLmxvYy5zdGFydC5vZmZzZXQsIGVyci5sb2MuZW5kLm9mZnNldCk7CiAgICAgICAgICB3YXJuJDEoY29kZUZyYW1lID8gYCR7bWVzc2FnZX1cbiR7Y29kZUZyYW1lfWAgOiBtZXNzYWdlKTsKICAgICAgfQogICAgICAvLyBUaGUgd2lsZGNhcmQgaW1wb3J0IHJlc3VsdHMgaW4gYSBodWdlIG9iamVjdCB3aXRoIGV2ZXJ5IGV4cG9ydAogICAgICAvLyB3aXRoIGtleXMgdGhhdCBjYW5ub3QgYmUgbWFuZ2xlZCwgYW5kIGNhbiBiZSBxdWl0ZSBoZWF2eSBzaXplLXdpc2UuCiAgICAgIC8vIEluIHRoZSBnbG9iYWwgYnVpbGQgd2Uga25vdyBgVnVlYCBpcyBhdmFpbGFibGUgZ2xvYmFsbHkgc28gd2UgY2FuIGF2b2lkCiAgICAgIC8vIHRoZSB3aWxkY2FyZCBvYmplY3QuCiAgICAgIGNvbnN0IHJlbmRlciA9IChuZXcgRnVuY3Rpb24oY29kZSkoKSApOwogICAgICByZW5kZXIuX3JjID0gdHJ1ZTsKICAgICAgcmV0dXJuIChjb21waWxlQ2FjaGVba2V5XSA9IHJlbmRlcik7CiAgfQogIHJlZ2lzdGVyUnVudGltZUNvbXBpbGVyKGNvbXBpbGVUb0Z1bmN0aW9uKTsKCiAgZXhwb3J0cy5CYXNlVHJhbnNpdGlvbiA9IEJhc2VUcmFuc2l0aW9uOwogIGV4cG9ydHMuQ29tbWVudCA9IENvbW1lbnQ7CiAgZXhwb3J0cy5FZmZlY3RTY29wZSA9IEVmZmVjdFNjb3BlOwogIGV4cG9ydHMuRnJhZ21lbnQgPSBGcmFnbWVudDsKICBleHBvcnRzLktlZXBBbGl2ZSA9IEtlZXBBbGl2ZTsKICBleHBvcnRzLlJlYWN0aXZlRWZmZWN0ID0gUmVhY3RpdmVFZmZlY3Q7CiAgZXhwb3J0cy5TdGF0aWMgPSBTdGF0aWM7CiAgZXhwb3J0cy5TdXNwZW5zZSA9IFN1c3BlbnNlOwogIGV4cG9ydHMuVGVsZXBvcnQgPSBUZWxlcG9ydDsKICBleHBvcnRzLlRleHQgPSBUZXh0OwogIGV4cG9ydHMuVHJhbnNpdGlvbiA9IFRyYW5zaXRpb247CiAgZXhwb3J0cy5UcmFuc2l0aW9uR3JvdXAgPSBUcmFuc2l0aW9uR3JvdXA7CiAgZXhwb3J0cy5WdWVFbGVtZW50ID0gVnVlRWxlbWVudDsKICBleHBvcnRzLmNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nID0gY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmc7CiAgZXhwb3J0cy5jYWxsV2l0aEVycm9ySGFuZGxpbmcgPSBjYWxsV2l0aEVycm9ySGFuZGxpbmc7CiAgZXhwb3J0cy5jYW1lbGl6ZSA9IGNhbWVsaXplOwogIGV4cG9ydHMuY2FwaXRhbGl6ZSA9IGNhcGl0YWxpemU7CiAgZXhwb3J0cy5jbG9uZVZOb2RlID0gY2xvbmVWTm9kZTsKICBleHBvcnRzLmNvbXBhdFV0aWxzID0gY29tcGF0VXRpbHM7CiAgZXhwb3J0cy5jb21waWxlID0gY29tcGlsZVRvRnVuY3Rpb247CiAgZXhwb3J0cy5jb21wdXRlZCA9IGNvbXB1dGVkJDE7CiAgZXhwb3J0cy5jcmVhdGVBcHAgPSBjcmVhdGVBcHA7CiAgZXhwb3J0cy5jcmVhdGVCbG9jayA9IGNyZWF0ZUJsb2NrOwogIGV4cG9ydHMuY3JlYXRlQ29tbWVudFZOb2RlID0gY3JlYXRlQ29tbWVudFZOb2RlOwogIGV4cG9ydHMuY3JlYXRlRWxlbWVudEJsb2NrID0gY3JlYXRlRWxlbWVudEJsb2NrOwogIGV4cG9ydHMuY3JlYXRlRWxlbWVudFZOb2RlID0gY3JlYXRlQmFzZVZOb2RlOwogIGV4cG9ydHMuY3JlYXRlSHlkcmF0aW9uUmVuZGVyZXIgPSBjcmVhdGVIeWRyYXRpb25SZW5kZXJlcjsKICBleHBvcnRzLmNyZWF0ZVByb3BzUmVzdFByb3h5ID0gY3JlYXRlUHJvcHNSZXN0UHJveHk7CiAgZXhwb3J0cy5jcmVhdGVSZW5kZXJlciA9IGNyZWF0ZVJlbmRlcmVyOwogIGV4cG9ydHMuY3JlYXRlU1NSQXBwID0gY3JlYXRlU1NSQXBwOwogIGV4cG9ydHMuY3JlYXRlU2xvdHMgPSBjcmVhdGVTbG90czsKICBleHBvcnRzLmNyZWF0ZVN0YXRpY1ZOb2RlID0gY3JlYXRlU3RhdGljVk5vZGU7CiAgZXhwb3J0cy5jcmVhdGVUZXh0Vk5vZGUgPSBjcmVhdGVUZXh0Vk5vZGU7CiAgZXhwb3J0cy5jcmVhdGVWTm9kZSA9IGNyZWF0ZVZOb2RlOwogIGV4cG9ydHMuY3VzdG9tUmVmID0gY3VzdG9tUmVmOwogIGV4cG9ydHMuZGVmaW5lQXN5bmNDb21wb25lbnQgPSBkZWZpbmVBc3luY0NvbXBvbmVudDsKICBleHBvcnRzLmRlZmluZUNvbXBvbmVudCA9IGRlZmluZUNvbXBvbmVudDsKICBleHBvcnRzLmRlZmluZUN1c3RvbUVsZW1lbnQgPSBkZWZpbmVDdXN0b21FbGVtZW50OwogIGV4cG9ydHMuZGVmaW5lRW1pdHMgPSBkZWZpbmVFbWl0czsKICBleHBvcnRzLmRlZmluZUV4cG9zZSA9IGRlZmluZUV4cG9zZTsKICBleHBvcnRzLmRlZmluZVByb3BzID0gZGVmaW5lUHJvcHM7CiAgZXhwb3J0cy5kZWZpbmVTU1JDdXN0b21FbGVtZW50ID0gZGVmaW5lU1NSQ3VzdG9tRWxlbWVudDsKICBleHBvcnRzLmVmZmVjdCA9IGVmZmVjdDsKICBleHBvcnRzLmVmZmVjdFNjb3BlID0gZWZmZWN0U2NvcGU7CiAgZXhwb3J0cy5nZXRDdXJyZW50SW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2U7CiAgZXhwb3J0cy5nZXRDdXJyZW50U2NvcGUgPSBnZXRDdXJyZW50U2NvcGU7CiAgZXhwb3J0cy5nZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4gPSBnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW47CiAgZXhwb3J0cy5ndWFyZFJlYWN0aXZlUHJvcHMgPSBndWFyZFJlYWN0aXZlUHJvcHM7CiAgZXhwb3J0cy5oID0gaDsKICBleHBvcnRzLmhhbmRsZUVycm9yID0gaGFuZGxlRXJyb3I7CiAgZXhwb3J0cy5oeWRyYXRlID0gaHlkcmF0ZTsKICBleHBvcnRzLmluaXRDdXN0b21Gb3JtYXR0ZXIgPSBpbml0Q3VzdG9tRm9ybWF0dGVyOwogIGV4cG9ydHMuaW5pdERpcmVjdGl2ZXNGb3JTU1IgPSBpbml0RGlyZWN0aXZlc0ZvclNTUjsKICBleHBvcnRzLmluamVjdCA9IGluamVjdDsKICBleHBvcnRzLmlzTWVtb1NhbWUgPSBpc01lbW9TYW1lOwogIGV4cG9ydHMuaXNQcm94eSA9IGlzUHJveHk7CiAgZXhwb3J0cy5pc1JlYWN0aXZlID0gaXNSZWFjdGl2ZTsKICBleHBvcnRzLmlzUmVhZG9ubHkgPSBpc1JlYWRvbmx5OwogIGV4cG9ydHMuaXNSZWYgPSBpc1JlZjsKICBleHBvcnRzLmlzUnVudGltZU9ubHkgPSBpc1J1bnRpbWVPbmx5OwogIGV4cG9ydHMuaXNTaGFsbG93ID0gaXNTaGFsbG93OwogIGV4cG9ydHMuaXNWTm9kZSA9IGlzVk5vZGU7CiAgZXhwb3J0cy5tYXJrUmF3ID0gbWFya1JhdzsKICBleHBvcnRzLm1lcmdlRGVmYXVsdHMgPSBtZXJnZURlZmF1bHRzOwogIGV4cG9ydHMubWVyZ2VQcm9wcyA9IG1lcmdlUHJvcHM7CiAgZXhwb3J0cy5uZXh0VGljayA9IG5leHRUaWNrOwogIGV4cG9ydHMubm9ybWFsaXplQ2xhc3MgPSBub3JtYWxpemVDbGFzczsKICBleHBvcnRzLm5vcm1hbGl6ZVByb3BzID0gbm9ybWFsaXplUHJvcHM7CiAgZXhwb3J0cy5ub3JtYWxpemVTdHlsZSA9IG5vcm1hbGl6ZVN0eWxlOwogIGV4cG9ydHMub25BY3RpdmF0ZWQgPSBvbkFjdGl2YXRlZDsKICBleHBvcnRzLm9uQmVmb3JlTW91bnQgPSBvbkJlZm9yZU1vdW50OwogIGV4cG9ydHMub25CZWZvcmVVbm1vdW50ID0gb25CZWZvcmVVbm1vdW50OwogIGV4cG9ydHMub25CZWZvcmVVcGRhdGUgPSBvbkJlZm9yZVVwZGF0ZTsKICBleHBvcnRzLm9uRGVhY3RpdmF0ZWQgPSBvbkRlYWN0aXZhdGVkOwogIGV4cG9ydHMub25FcnJvckNhcHR1cmVkID0gb25FcnJvckNhcHR1cmVkOwogIGV4cG9ydHMub25Nb3VudGVkID0gb25Nb3VudGVkOwogIGV4cG9ydHMub25SZW5kZXJUcmFja2VkID0gb25SZW5kZXJUcmFja2VkOwogIGV4cG9ydHMub25SZW5kZXJUcmlnZ2VyZWQgPSBvblJlbmRlclRyaWdnZXJlZDsKICBleHBvcnRzLm9uU2NvcGVEaXNwb3NlID0gb25TY29wZURpc3Bvc2U7CiAgZXhwb3J0cy5vblNlcnZlclByZWZldGNoID0gb25TZXJ2ZXJQcmVmZXRjaDsKICBleHBvcnRzLm9uVW5tb3VudGVkID0gb25Vbm1vdW50ZWQ7CiAgZXhwb3J0cy5vblVwZGF0ZWQgPSBvblVwZGF0ZWQ7CiAgZXhwb3J0cy5vcGVuQmxvY2sgPSBvcGVuQmxvY2s7CiAgZXhwb3J0cy5wb3BTY29wZUlkID0gcG9wU2NvcGVJZDsKICBleHBvcnRzLnByb3ZpZGUgPSBwcm92aWRlOwogIGV4cG9ydHMucHJveHlSZWZzID0gcHJveHlSZWZzOwogIGV4cG9ydHMucHVzaFNjb3BlSWQgPSBwdXNoU2NvcGVJZDsKICBleHBvcnRzLnF1ZXVlUG9zdEZsdXNoQ2IgPSBxdWV1ZVBvc3RGbHVzaENiOwogIGV4cG9ydHMucmVhY3RpdmUgPSByZWFjdGl2ZTsKICBleHBvcnRzLnJlYWRvbmx5ID0gcmVhZG9ubHk7CiAgZXhwb3J0cy5yZWYgPSByZWY7CiAgZXhwb3J0cy5yZWdpc3RlclJ1bnRpbWVDb21waWxlciA9IHJlZ2lzdGVyUnVudGltZUNvbXBpbGVyOwogIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogIGV4cG9ydHMucmVuZGVyTGlzdCA9IHJlbmRlckxpc3Q7CiAgZXhwb3J0cy5yZW5kZXJTbG90ID0gcmVuZGVyU2xvdDsKICBleHBvcnRzLnJlc29sdmVDb21wb25lbnQgPSByZXNvbHZlQ29tcG9uZW50OwogIGV4cG9ydHMucmVzb2x2ZURpcmVjdGl2ZSA9IHJlc29sdmVEaXJlY3RpdmU7CiAgZXhwb3J0cy5yZXNvbHZlRHluYW1pY0NvbXBvbmVudCA9IHJlc29sdmVEeW5hbWljQ29tcG9uZW50OwogIGV4cG9ydHMucmVzb2x2ZUZpbHRlciA9IHJlc29sdmVGaWx0ZXI7CiAgZXhwb3J0cy5yZXNvbHZlVHJhbnNpdGlvbkhvb2tzID0gcmVzb2x2ZVRyYW5zaXRpb25Ib29rczsKICBleHBvcnRzLnNldEJsb2NrVHJhY2tpbmcgPSBzZXRCbG9ja1RyYWNraW5nOwogIGV4cG9ydHMuc2V0RGV2dG9vbHNIb29rID0gc2V0RGV2dG9vbHNIb29rOwogIGV4cG9ydHMuc2V0VHJhbnNpdGlvbkhvb2tzID0gc2V0VHJhbnNpdGlvbkhvb2tzOwogIGV4cG9ydHMuc2hhbGxvd1JlYWN0aXZlID0gc2hhbGxvd1JlYWN0aXZlOwogIGV4cG9ydHMuc2hhbGxvd1JlYWRvbmx5ID0gc2hhbGxvd1JlYWRvbmx5OwogIGV4cG9ydHMuc2hhbGxvd1JlZiA9IHNoYWxsb3dSZWY7CiAgZXhwb3J0cy5zc3JDb250ZXh0S2V5ID0gc3NyQ29udGV4dEtleTsKICBleHBvcnRzLnNzclV0aWxzID0gc3NyVXRpbHM7CiAgZXhwb3J0cy5zdG9wID0gc3RvcDsKICBleHBvcnRzLnRvRGlzcGxheVN0cmluZyA9IHRvRGlzcGxheVN0cmluZzsKICBleHBvcnRzLnRvSGFuZGxlcktleSA9IHRvSGFuZGxlcktleTsKICBleHBvcnRzLnRvSGFuZGxlcnMgPSB0b0hhbmRsZXJzOwogIGV4cG9ydHMudG9SYXcgPSB0b1JhdzsKICBleHBvcnRzLnRvUmVmID0gdG9SZWY7CiAgZXhwb3J0cy50b1JlZnMgPSB0b1JlZnM7CiAgZXhwb3J0cy50cmFuc2Zvcm1WTm9kZUFyZ3MgPSB0cmFuc2Zvcm1WTm9kZUFyZ3M7CiAgZXhwb3J0cy50cmlnZ2VyUmVmID0gdHJpZ2dlclJlZjsKICBleHBvcnRzLnVucmVmID0gdW5yZWY7CiAgZXhwb3J0cy51c2VBdHRycyA9IHVzZUF0dHJzOwogIGV4cG9ydHMudXNlQ3NzTW9kdWxlID0gdXNlQ3NzTW9kdWxlOwogIGV4cG9ydHMudXNlQ3NzVmFycyA9IHVzZUNzc1ZhcnM7CiAgZXhwb3J0cy51c2VTU1JDb250ZXh0ID0gdXNlU1NSQ29udGV4dDsKICBleHBvcnRzLnVzZVNsb3RzID0gdXNlU2xvdHM7CiAgZXhwb3J0cy51c2VUcmFuc2l0aW9uU3RhdGUgPSB1c2VUcmFuc2l0aW9uU3RhdGU7CiAgZXhwb3J0cy52TW9kZWxDaGVja2JveCA9IHZNb2RlbENoZWNrYm94OwogIGV4cG9ydHMudk1vZGVsRHluYW1pYyA9IHZNb2RlbER5bmFtaWM7CiAgZXhwb3J0cy52TW9kZWxSYWRpbyA9IHZNb2RlbFJhZGlvOwogIGV4cG9ydHMudk1vZGVsU2VsZWN0ID0gdk1vZGVsU2VsZWN0OwogIGV4cG9ydHMudk1vZGVsVGV4dCA9IHZNb2RlbFRleHQ7CiAgZXhwb3J0cy52U2hvdyA9IHZTaG93OwogIGV4cG9ydHMudmVyc2lvbiA9IHZlcnNpb247CiAgZXhwb3J0cy53YXJuID0gd2FybiQxOwogIGV4cG9ydHMud2F0Y2ggPSB3YXRjaDsKICBleHBvcnRzLndhdGNoRWZmZWN0ID0gd2F0Y2hFZmZlY3Q7CiAgZXhwb3J0cy53YXRjaFBvc3RFZmZlY3QgPSB3YXRjaFBvc3RFZmZlY3Q7CiAgZXhwb3J0cy53YXRjaFN5bmNFZmZlY3QgPSB3YXRjaFN5bmNFZmZlY3Q7CiAgZXhwb3J0cy53aXRoQXN5bmNDb250ZXh0ID0gd2l0aEFzeW5jQ29udGV4dDsKICBleHBvcnRzLndpdGhDdHggPSB3aXRoQ3R4OwogIGV4cG9ydHMud2l0aERlZmF1bHRzID0gd2l0aERlZmF1bHRzOwogIGV4cG9ydHMud2l0aERpcmVjdGl2ZXMgPSB3aXRoRGlyZWN0aXZlczsKICBleHBvcnRzLndpdGhLZXlzID0gd2l0aEtleXM7CiAgZXhwb3J0cy53aXRoTWVtbyA9IHdpdGhNZW1vOwogIGV4cG9ydHMud2l0aE1vZGlmaWVycyA9IHdpdGhNb2RpZmllcnM7CiAgZXhwb3J0cy53aXRoU2NvcGVJZCA9IHdpdGhTY29wZUlkOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKICByZXR1cm4gZXhwb3J0czsKCn0oe30pKTsK"></script>
    <title>kvNote</title>
  </head>
  <body>
    <p>kvNote</p>
    <!--
    <input type="button" value="" onclick="kvNoteTest.run()">
    -->
    <div id="app_view">
      <div v-if="enable_top_menu">
        <input type="file" @change="read" accept=".kvs" name="read_file_button">
        <span></span>
        <input type="button" value="" v-on:click="start_create()">
      </div>

      <!--  -->
      <div v-if="enable_create">
        <!-- table  -->
        <table>
          <tbody><tr><td>
            <textarea class="kv" id="UI_textarea" onfocus="this.select()" placeholder="" v-on:input="init_Fields" autofocus=""></textarea>
          </td>
          <td><span>create field</span></td>
        </tr></tbody></table>
      </div>

      <div v-show="exist_fields()">
        <form id="UI_FIELDS_FORMS" @submit.prevent="submit_entry" action="file:///C:/" method="POST">
          <table>
            <tbody><tr v-for="sField in ssFields">
              <td class="right">{{sField}}</td>
              <td>
                <input type="text" name="" id="" required="">
              </td>
            </tr>
          </tbody></table>

          <p>
            <input id="write_json" type="submit" value="json">
            <span></span>
            <input id="write_csv" type="submit" value="csv_">
          </p>
        </form>
      </div>

      <div id="edit_entry" v-show="isNotNull()">
        <hr>

        <div v-for="entry in KV_Store.list()">
          <form v-bind:id="entry.uuid()" @submit.prevent="submit_replace(entry.uuid())" action="file:///C:/" method="POST">
            <table>
              <tbody><tr v-for="key in [...ssFields]">
                <td class="right">{{key}}</td>
                <td>:</td>
                <td v-show="entry.editable() === false">
                  <span class="copy_target" @click="copy(entry.noteEntry().get(key))">{{entry.noteEntry().get(key)}}</span>
                  <input type="button" value="" v-on:click="bSwitch(entry)">
                </td>
                <td v-show="entry.editable() === true">
                  <input type="text" v-bind:value="entry.noteEntry().get(key)">
                  <input type="submit" value="">
                </td>
              </tr>
            </tbody></table>
          </form>
        </div>
      </div>
    </div>

    <script src="data:application/javascript;base64,Y2xhc3MgVXRpbCB7CiAgc3RhdGljIGVtcHR5ID0gIiI7CgogIC8v56m644Gu6KaB57Sg44KS5o6S6Zmk44GX44Gf6YWN5YiX44KS6L+U44GZCiAgc3RhdGljIHRvX2xpbmVzKF9zdHJpbmcsIF90YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLnNlcGFyYXRlZChfc3RyaW5nLCBfdGFyZ2V0KTsKICAgIC8vcmV0dXJuIHRoaXMucmVtb3ZlX2VtcHR5KGFycmF5KTsKICB9CgogIC8qKgogICAqIHRoaXMudG9fbGluZXMoKeOBqOWFqOOBj+WQjOOBmOOBoOOBjOOAgQogICAqIFsgU3RyaW5nLCBTdHJpbmcgXSA9PiAgWyBbY2VsbCxjZWxsLGNlbGxdLCBbY2VsbCxjZWxsLGNlbGxdLi4uLl0KICAgKiDjgajjgYTjgYblh6bnkIbjgpLooYzjgYbjgIJleGNlbGwg44GuIGNlbGzjga7opoHntKDjgavopovnq4vjgabjgabjgYTjgovjgIIKICAgKiBjZWxs44GM56m644Gn44KC44Gd44Gu44G+44G+6L+U44GZ44CCCiAgICovCiAgc3RhdGljIHRvX2NlbGxzKF9zdHJpbmcsIF90YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLnNlcGFyYXRlZChfc3RyaW5nLCBfdGFyZ2V0KTsKICB9CgogIHN0YXRpYyBzZXBhcmF0ZWQoX3N0cmluZywgX3RhcmdldCkgewogICAgcmV0dXJuIF9zdHJpbmcuc3BsaXQoX3RhcmdldCk7CiAgfQoKICBzdGF0aWMgcmVtb3ZlX2VtcHR5KF9hcnJheSkgewogICAgcmV0dXJuIF9hcnJheS5maWx0ZXIoKGUpID0+IGUgIT0gdGhpcy5lbXB0eSk7CiAgfQoKICBzdGF0aWMgTl9hcnJheShOLCBjYWxsYmFjaykgewogICAgLy9BcnJheS5maWxsKCnjga/jg5/jg6Xjg7zjgr/jg5bjg6vjgarjga7jgafkvb/jgYjjgarjgYTjgIIKICAgIHJldHVybiBbLi4uQXJyYXkoTildLm1hcChjYWxsYmFjayk7CiAgfQoKICAvLzLjgaTjga5BcnJheeOCkuWPl+WPluOCik1hcOOCquODluOCuOOCp+OCr+ODiOOCkui/lOOBmeOAggogIHN0YXRpYyB6aXBfdG9fTWFwKF9oZWFkZXIsIF92YWx1ZXMpIHsKICAgIGlmIChfaGVhZGVyLmxlbmd0aCAhPSBfdmFsdWVzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgIuW8leaVsFswXSBfaGVhZGVyIOOBqCDlvJXmlbBbMV0gX3ZhbHVlcyAy44Gk44Gu6YWN5YiX44Gu6ZW344GV44GM55Ww44Gq44KL44Gu44Gn5Yem55CG44KS5Lit5q2i44GX44G+44GX44GfIgogICAgICApOwogICAgfQogICAgbGV0IG1hcCA9IG5ldyBNYXAoKTsKICAgIF9oZWFkZXIuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4gbWFwLnNldChrZXksIF92YWx1ZXNbaW5kZXhdKSk7CiAgICByZXR1cm4gbWFwOwogIH0KCiAgc3RhdGljIHRvX0NsaXBib2FyZChfdGV4dCkgewogICAgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQoX3RleHQpLnRoZW4oCiAgICAgICgpID0+IHsKICAgICAgICAvKiBjbGlwYm9hcmQgc3VjY2Vzc2Z1bGx5IHNldCAqLwogICAgICAgIHJldHVybjsKICAgICAgfSwKICAgICAgKCkgPT4gewogICAgICAgIC8qIGNsaXBib2FyZCB3cml0ZSBmYWlsZWQgKi8KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICk7CiAgfQoKICAvL+WNiuinkuaVsOWtl+aWh+Wtl+WIl+OCkuWFqOinkuaVsOWtl+aWh+Wtl+WIl+OBq+WkieaPmwogIC8vIHJlcGxhY2XplqLmlbDjga/mlrDjgZ/jgarmloflrZfliJfjgpLov5TjgZnjgIIKICAvL2h0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2phL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL1N0cmluZy9yZXBsYWNlCiAgc3RhdGljIHRvX3plbmtha3UoX3N0cikgewogICAgLy9TdHJpbmcucmVwbGFjZSgpIOOBrwogICAgcmV0dXJuIF9zdHIucmVwbGFjZSgvWzAtOV0vZywgKHMpID0+CiAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUocy5jaGFyQ29kZUF0KDApICsgMHhmZWUwKQogICAgKTsKICB9CgogIHN0YXRpYyB0b2dnbGUoX2Jvb2xlYW4pIHsKICAgIHJldHVybiAhX2Jvb2xlYW47CiAgfQoKICBzdGF0aWMgdW5pcXVlQXJyYXkoX2FycmF5KSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KFsuLi5fYXJyYXldKSk7CiAgfQoKICBzdGF0aWMgZ2VuZXJhdGVVVUlEKCkgewogICAgbGV0IGNoYXJzID0gInh4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCIuc3BsaXQodGhpcy5lbXB0eSk7CgogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGNoYXJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHN3aXRjaCAoY2hhcnNbaV0pIHsKICAgICAgICBjYXNlICJ4IjoKICAgICAgICAgIGNoYXJzW2ldID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTYpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInkiOgogICAgICAgICAgY2hhcnNbaV0gPSAoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNCkgKyA4KS50b1N0cmluZygxNik7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoYXJzLmpvaW4odGhpcy5lbXB0eSk7CiAgfQp9Cg=="></script>
    <script src="data:application/javascript;base64,77u/InVzZSBzdHJpY3QiOw0KDQpjbGFzcyBVbmlxdWVkTGlzdCB7DQogIHN0YXRpYyBkZWxpbWl0ZXIgPSAvWy9cbnwvXHRdLzsNCg0KICBzdGF0aWMgZnJvbVN0cmluZyA9IChfc1RleHQsIF9yZWdleHAgPSB0aGlzLmRlbGltaXRlcikgPT4NCiAgICBuZXcgU2V0KF9zVGV4dC5zcGxpdChfcmVnZXhwKSk7DQp9DQo="></script>
    <script src="data:application/javascript;base64,77u/InVzZSBzdHJpY3QiOw0KDQpjb25zdCBrdk5vdGUgPSBWdWUuY3JlYXRlQXBwKHsNCiAgZGF0YSgpIHsNCiAgICByZXR1cm4gew0KICAgICAgc3NGaWVsZHM6IG5ldyBTZXQoKSwNCiAgICAgIEtWX1N0b3JlOiBuZXcgS1ZzKCksDQogICAgICBlbmFibGVfdG9wX21lbnU6IHRydWUsDQogICAgICBlbmFibGVfY3JlYXRlOiBmYWxzZSwNCiAgICAgIGV4aXN0X2ZpZWxkczogKCkgPT4gdGhpcy5zc0ZpZWxkcy5zaXplID4gMCwNCiAgICAgIGlzRW50cmllc0VtcHR5OiAoKSA9PiB0aGlzLktWX1N0b3JlLmxpc3QoKSwNCiAgICAgIGlzTm90TnVsbDogKCkgPT4gdGhpcy5LVl9TdG9yZS5sZW5ndGgoKSA+IDAsDQogICAgfTsNCiAgfSwNCiAgbWV0aG9kczogew0KICAgIC8vIFVJDQogICAgc3RhcnRfY3JlYXRlKCkgew0KICAgICAgdGhpcy5lbmFibGVfdG9wX21lbnUgPSBmYWxzZTsNCiAgICAgIHRoaXMuZW5hYmxlX2NyZWF0ZSA9IHRydWU7DQogICAgfSwNCiAgICAvLyBVSQ0KICAgIGJTd2l0Y2goX21FbnRyeSkgew0KICAgICAgX21FbnRyeS5zd2l0Y2hfZWRpdGFibGUoX21FbnRyeS5lZGl0YWJsZSgpKTsNCiAgICB9LA0KICAgIC8vIFVJDQogICAgYkVkaXRhYmxlKF9tRW50cnkpIHsNCiAgICAgIHJldHVybiBfbUVudHJ5LmVkaXRhYmxlKCk7DQogICAgfSwNCiAgICAvLyBVSQ0KICAgIGNvcHkoX3RleHQpIHsNCiAgICAgIFV0aWwudG9fQ2xpcGJvYXJkKF90ZXh0KTsNCiAgICAgIGNvbnNvbGUubG9nKCJjb3BpZWQ6ICIgKyBfdGV4dCk7DQogICAgfSwNCiAgICAvLyBVSSDjgaggc3NGaWVsZHMg44GoIEtWX1N0b3JlIOOBruWIneacn+WMluOBr+WIpemWouaVsOOBq+WIhumbouOBmeOBueOBjeOBoOOBquOAgiANCiAgICBpbml0X0ZpZWxkcyhfZXZlbnQpIHsNCiAgICAgIGNvbnN0IHN0ciA9IF9ldmVudC50YXJnZXQudmFsdWU7DQogICAgICB0aGlzLnNzRmllbGRzID0gVW5pcXVlZExpc3QuZnJvbVN0cmluZyhzdHIpOw0KICAgICAgLy/jgqTjg7Pjgrnjgr/jg7PjgrnkvZzjgorjgZnjgY7jgovjgIINCiAgICAgIHRoaXMuS1ZfU3RvcmUgPSBuZXcgS1ZzKHRoaXMuc3NGaWVsZHMpOw0KICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLktWX1N0b3JlKQ0KICAgIH0sDQogICAgc3VibWl0X2VudHJ5KF9ldmVudCkgew0KICAgICAgaWYgKHRoaXMuZW5hYmxlX2NyZWF0ZSA9PT0gdHJ1ZSkgew0KICAgICAgICB0aGlzLmVuYWJsZV9jcmVhdGUgPSBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IHNhVmFsdWVzID0gdGhpcy5leHRyYWN0Rm9ybShfZXZlbnQudGFyZ2V0LmVsZW1lbnRzKTsNCiAgICAgIF9ldmVudC50YXJnZXQucmVzZXQoKTsNCg0KICAgICAgdGhpcy5LVl9TdG9yZS5hZGQoc2FWYWx1ZXMpOw0KICAgICAgdGhpcy53cml0ZSh0aGlzLktWX1N0b3JlLmVudHJpZXMoKSk7DQogICAgICBjb25zb2xlLndhcm4oIuOBvuOBoOWun+ijhemAlOS4rSIpOw0KICAgIH0sDQogICAgc3VibWl0X3JlcGxhY2UoX3NVVUlEKSB7DQogICAgICAvL1VVSUQg44KS5YaN5Yip55So44GX44Gq44GE44Go44GG44G+44GP5YuV5L2c44GX44Gq44GE44CCDQogICAgICB0aGlzLmJTd2l0Y2godGhpcy5zZWFyY2hFbnRyeShfc1VVSUQpKTsNCiAgICAgIGNvbnN0IG9Gb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoX3NVVUlEKTsNCiAgICAgIGNvbnN0IHNhTmV3VmFsdWVzID0gdGhpcy5leHRyYWN0Rm9ybShvRm9ybS5lbGVtZW50cyk7DQogICAgICAvL+WJr+S9nOeUqOOAgg0KICAgICAgdGhpcy5LVl9TdG9yZS5yZXBsYWNlKF9zVVVJRCwgc2FOZXdWYWx1ZXMpOw0KICAgICAgdGhpcy53cml0ZSh0aGlzLktWX1N0b3JlLmVudHJpZXMoKSk7DQogICAgICBjb25zb2xlLmRpcih0aGlzLktWX1N0b3JlKTsNCiAgICB9LA0KICAgIGV4dHJhY3RGb3JtKF9vRWxlbWVudHMpIHsNCiAgICAgIHJldHVybiBBcnJheS5mcm9tKF9vRWxlbWVudHMpDQogICAgICAgIC5maWx0ZXIoKGUpID0+IGUudHlwZSA9PT0gInRleHQiKQ0KICAgICAgICAubWFwKChlKSA9PiBlLnZhbHVlKTsNCiAgICB9LA0KICAgIHNlYXJjaEVudHJ5KF9zVXVpZCkgew0KICAgICAgcmV0dXJuIHRoaXMuS1ZfU3RvcmUubGlzdCgpDQogICAgICAgIC5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeS51dWlkKCkgPT09IF9zVXVpZCkNCiAgICAgICAgLmF0KDApOw0KICAgIH0sDQogICAgd3JpdGUoX2t2cykgew0KICAgICAgY29uc3QgRVhURU5TSU9OID0gIi5rdnMiOw0KICAgICAgY29uc3QgSU5ERU5UID0gMjsNCiAgICAgIHRoaXMuZG93bmxvYWQoSlNPTi5zdHJpbmdpZnkoX2t2cywgbnVsbCwgSU5ERU5UKSwgRVhURU5TSU9OKTsNCiAgICB9LA0KICAgIGRvd25sb2FkKF9zdHJKU09OLCBfZXh0ZW5zaW9uKSB7DQogICAgICBjb25zdCBmaWxlX25hbWUgPSAibm90ZV8iOw0KICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtfc3RySlNPTl0sIHsgdHlwZTogInRleHQvcGxhaW4iIH0pOw0KICAgICAgbGV0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7DQogICAgICBsaW5rLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOw0KICAgICAgbGluay5kb3dubG9hZCA9IGZpbGVfbmFtZSArIF9leHRlbnNpb247DQogICAgICBsaW5rLmNsaWNrKCk7DQogICAgICBsaW5rID0gbnVsbDsNCiAgICB9LA0KICAgIHJlYWQoX2V2ZW50KSB7DQogICAgICBsZXQgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsNCiAgICAgIHJlYWRlci5yZWFkQXNUZXh0KF9ldmVudC50YXJnZXQuZmlsZXNbMF0pOw0KICAgICAgcmVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCAoKSA9PiB7DQogICAgICAgIC8v5Zu65pyJ44Gu5a6f6KOFIOWIpeOBrumWouaVsOOBquOBqeOBq+WIhumbouOBmeOBueOBlw0KICAgICAgICBjb25zdCBvYmogPSBKU09OLnBhcnNlKHJlYWRlci5yZXN1bHQpOw0KICAgICAgICB0aGlzLmFsbG9jYXRpb24ob2JqKTsNCiAgICAgIH0pOw0KICAgIH0sDQogICAgYWxsb2NhdGlvbihfc291cmNlKSB7DQogICAgICAvL+S4gOaEj+OBqmtleeOCkuWPluW+lw0KICAgICAgY29uc3Qgb0xpc3QgPSBbLi4uX3NvdXJjZV07DQoNCiAgICAgIG9MaXN0LmZvckVhY2goKGVudHJ5KSA9Pg0KICAgICAgICBPYmplY3Qua2V5cyhlbnRyeSkuZm9yRWFjaCgoa2V5KSA9PiB0aGlzLnNzRmllbGRzLmFkZChrZXkpKQ0KICAgICAgKTsNCiAgICAgIHRoaXMuS1ZfU3RvcmUgPSBuZXcgS1ZzKHRoaXMuc3NGaWVsZHMpOw0KDQogICAgICBvTGlzdC5mb3JFYWNoKChlbnRyeSkgPT4gdGhpcy5LVl9TdG9yZS5hZGQoT2JqZWN0LnZhbHVlcyhlbnRyeSkpKTsNCiAgICB9LA0KICB9LA0KfSk7DQo="></script>

    <script src="data:application/javascript;base64,77u/Y2xhc3MgS1ZFbnRyeSB7DQogIHN0YXRpYyAjc1VVSUQgPSAidXVpZCI7DQogIHN0YXRpYyAjc0VESVRBQkxFID0gImVkaXRhYmxlIjsNCiAgc3RhdGljICNzTk9URSA9ICJub3RlIjsNCg0KICBjb25zdHJ1Y3Rvcihfa2V5cywgX3ZhbHVlcykgew0KICAgIHRoaXMubUVudHJ5ID0gbmV3IE1hcCgpOw0KICAgIHRoaXMubUVudHJ5LnNldChLVkVudHJ5LiNzVVVJRCwgVXRpbC5nZW5lcmF0ZVVVSUQoKSk7DQogICAgdGhpcy5tRW50cnkuc2V0KEtWRW50cnkuI3NFRElUQUJMRSwgZmFsc2UpOw0KICAgIHRoaXMubUVudHJ5LnNldCgNCiAgICAgIEtWRW50cnkuI3NOT1RFLA0KICAgICAgdGhpcy4jY3JlYXRlRW50cnkoWy4uLl9rZXlzXSwgWy4uLl92YWx1ZXNdKQ0KICAgICk7DQogIH0NCg0KICAjY3JlYXRlRW50cnkoX2tleXMsIF92YWx1ZXMpIHsNCiAgICBjb25zdCBtRW50cnkgPSBuZXcgTWFwKCk7DQogICAgX2tleXMuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4gew0KICAgICAgbUVudHJ5LnNldChrZXksIF92YWx1ZXMuYXQoaW5kZXgpKTsNCiAgICB9KTsNCiAgICByZXR1cm4gbUVudHJ5Ow0KICB9DQoNCiAgcmVwbGFjZShfdXVpZCwgX3ZhbHVlcykgew0KICAgIGlmIChfdXVpZCA9PT0gdGhpcy5tRW50cnkuZ2V0KEtWRW50cnkuI3NVVUlEKSkgew0KICAgICAgcmV0dXJuIG5ldyBLVkVudHJ5KHRoaXMua2V5cywgX3ZhbHVlcyk7DQogICAgfQ0KICB9DQoNCiAgZW50cmllcygpIHsNCiAgICByZXR1cm4gdGhpcy5tRW50cnk7DQogIH0NCg0KICBub3RlRW50cnkoKSB7DQogICAgcmV0dXJuIHRoaXMubUVudHJ5LmdldChLVkVudHJ5LiNzTk9URSk7DQogIH0NCg0KICB1dWlkKCkgew0KICAgIHJldHVybiB0aGlzLm1FbnRyeS5nZXQoS1ZFbnRyeS4jc1VVSUQpOw0KICB9DQoNCiAgZWRpdGFibGUoKSB7DQogICAgcmV0dXJuIHRoaXMubUVudHJ5LmdldChLVkVudHJ5LiNzRURJVEFCTEUpOw0KICB9DQoNCiAgc3dpdGNoX2VkaXRhYmxlKF9ib29sKSB7DQogICAgdGhpcy5tRW50cnkuc2V0KEtWRW50cnkuI3NFRElUQUJMRSwgIV9ib29sKTsNCiAgfQ0KfQ0K"></script>
    <script src="data:application/javascript;base64,77u/InVzZSBzdHJpY3QiOw0KDQpjbGFzcyBLVnMgew0KICBjb25zdHJ1Y3Rvcihfa2V5cykgew0KICAgIHRoaXMua2V5cyA9IG5ldyBTZXQoX2tleXMpOw0KICAgIHRoaXMua3ZMaXN0ID0gW107DQogIH0NCg0KICBhZGQoX3ZhbHVlcykgew0KICAgIC8vdm9pZA0KICAgIGNvbnN0IG5ld0VudHJ5ID0gbmV3IEtWRW50cnkoWy4uLnRoaXMua2V5c10sIFsuLi5fdmFsdWVzXSk7DQogICAgaWYodGhpcy5rdkxpc3QubGVuZ3RoID4gMCkgew0KICAgICAgdGhpcy5rdkxpc3QgPSBbbmV3RW50cnksIC4uLnRoaXMua3ZMaXN0XTsNCiAgICB9DQogICAgaWYgKHRoaXMua3ZMaXN0Lmxlbmd0aCA9PT0gMCkgew0KICAgICAgdGhpcy5rdkxpc3QgPSBbbmV3RW50cnldOw0KICAgIH0NCiAgICAvL2NvbnNvbGUubG9nKHRoaXMua3ZMaXN0KTsNCiAgfQ0KDQogIGRlbGV0ZShfdXVpZCkgew0KICAgIC8v6Kmy5b2T44GX44Gq44GE5pmC44Gu5Yem55CG44GM5b+F6KaB44Gg44GqDQogICAgcmV0dXJuIHRoaXMua3ZMaXN0LmZpbHRlcigoZW50cnkpID0+IGVudHJ5LnV1aWQoKSAhPT0gX3V1aWQpOw0KICB9DQoNCiAgcmVwbGFjZShfdXVpZCwgX3ZhbHVlcykgew0KICAgIC8va3Zfc3RvcmUg44GL44KJX2VudHJ5LmdldCgndXVpZCcpIFVVSUTjgavln7rjgaXjgY0gZW50cnnjgpLlkIzlrprjgZfjgIENCiAgICAvL+W8leaVsF9lbnRyeeOBq+e9ruOBjeaPm+OBiOOCiw0KICAgIHRoaXMua3ZMaXN0ID0gdGhpcy5kZWxldGUoX3V1aWQpOw0KICAgIHRoaXMuYWRkKF92YWx1ZXMpOw0KICB9DQoNCiAgc2VsZWN0Tm90ZShfaW5kZXgpIHsNCiAgICByZXR1cm4gdGhpcy5zZWxlY3RFbnRyeShfaW5kZXgpLm5vdGVFbnRyeSgpOw0KICB9DQoNCiAgc2VsZWN0RW50cnkoX2luZGV4KSB7DQogICAgLy/oqbLlvZPjgZfjgarjgYTmmYLjga7lh6bnkIbjgYzlv4XopoHjgaDjgaoNCiAgICByZXR1cm4gdGhpcy5rdkxpc3QuYXQoX2luZGV4KTsNCiAgfQ0KDQogIHNlYXJjaE5vdGUoX3V1aWQpIHsNCiAgICByZXR1cm4gdGhpcy5zZWFyY2hFbnRyeShfdXVpZCkubm90ZUVudHJ5KCk7DQogIH0NCg0KICBzZWFyY2hFbnRyeShfdXVpZCkgew0KICAgIC8v6Kmy5b2T44GX44Gq44GE5pmC44Gu5Yem55CG44GM5b+F6KaB44Gg44Gq44CCDQogICAgcmV0dXJuIHRoaXMua3ZMaXN0LmZpbHRlcigoZW50cnkpID0+IGVudHJ5LnV1aWQoKSA9PT0gX3V1aWQpWzBdOw0KICB9DQoNCiAgbGVuZ3RoKCkgew0KICAgIHJldHVybiB0aGlzLmxpc3QoKS5sZW5ndGg7DQogIH0NCg0KICBsaXN0KCkgew0KICAgIHJldHVybiB0aGlzLmt2TGlzdDsNCiAgfQ0KDQogIC8qKg0KICAgKiBNYXDjgqrjg5bjgrjjgqfjgq/jg4jjgpJPYmplY3TjgavlpInmj5vjgZnjgovjgZPjgajjgacNCiAgICogSlNPTuW9ouW8j+OBq+WkieaPm+OBl+OChOOBmeOBj+OBp+OBjeOCi+OAgg0KICAgKi8gDQogIGVudHJpZXMoKXsNCiAgICByZXR1cm4gdGhpcy5rdkxpc3QubWFwKGt2X2VudHJ5ID0+IE9iamVjdC5mcm9tRW50cmllcyhrdl9lbnRyeS5ub3RlRW50cnkoKSkpDQogIH0NCn0NCg=="></script>

    

    <!--
    
    FUCKING_TOSHIBA_TESTES.run()
    <script src="src/tests/kvNote_easy_test.js"></script>
    -->

    <script type="text/javascript">
      "use strict";
      //KV_EDITOR.mount("#app_view");

      kvNote.mount("#app_view");
    </script>
  

</body></html>
